<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>North American Hockey League - GM Simulator</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-C8YX6ERT5J"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-C8YX6ERT5J');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 50%, #1e293b 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 3rem 1.5rem;
        }
        h1 {
            font-size: 3rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(to right, #60a5fa, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            font-size: 1.25rem;
            text-align: center;
            color: #93c5fd;
            margin-bottom: 3rem;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            max-width: 72rem;
            margin: 0 auto;
        }
        .team-button {
            padding: 1rem;
            background: rgba(30, 58, 138, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.5rem;
            color: white;
            font-size: 1.125rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .team-button:hover {
            background: rgba(30, 64, 175, 0.5);
            transform: scale(1.02);
        }
        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            padding: 1rem 1.5rem;
        }
        .header h1 {
            font-size: 1.875rem;
            margin-bottom: 0.25rem;
            text-align: left;
            background: none;
            -webkit-text-fill-color: white;
        }
        .header-info {
            color: #93c5fd;
            font-size: 0.875rem;
        }
        .nav {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            position: relative;
            z-index: 100;
        }
        .nav-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            align-items: center;
            position: relative;
        }
        .nav-group {
            position: relative;
            display: inline-block;
            z-index: 101;
        }
        .nav-button {
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            font-size: 0.875rem;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: #93c5fd;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            z-index: 102;
        }
        .nav-button:hover {
            background: rgba(30, 58, 138, 0.3);
        }
        .nav-button.active {
            background: #2563eb;
            color: white;
        }
        .nav-button.has-dropdown::after {
            content: '‚ñº';
            font-size: 0.7rem;
            opacity: 0.7;
        }
        .nav-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #0f172a;
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-radius: 0 0 0.5rem 0.5rem;
            min-width: 200px;
            z-index: 9999;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.8);
            margin-top: 0;
        }
        .nav-group:hover .nav-dropdown {
            display: block;
        }
        .nav-dropdown-item {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #93c5fd;
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            position: relative;
            z-index: 10000;
        }
        .nav-dropdown-item:hover:not(.disabled) {
            background: rgba(30, 58, 138, 1);
            color: white;
        }
        .nav-dropdown-item.active {
            background: rgba(37, 99, 235, 0.8);
            color: #22d3ee;
            border-left: 3px solid #22d3ee;
        }
        .nav-dropdown-item.disabled {
            color: #64748b;
            cursor: not-allowed;
            opacity: 0.5;
        }
        .nav-dropdown-item.disabled::after {
            content: 'üîí';
            margin-left: 0.5rem;
            font-size: 0.8rem;
        }
        .action-button {
            padding: 0.75rem 1.5rem;
            background: #16a34a;
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 0.5rem;
        }
        .action-button:hover {
            background: #15803d;
        }
        .action-button.secondary {
            background: #2563eb;
            margin-left: 0.5rem;
        }
        .action-button.secondary:hover {
            background: #1d4ed8;
        }
        .content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            position: relative;
            z-index: 1;
        }
        .card {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 1rem;
        }
        .card h3 {
            font-size: 1.2rem;
            color: #22d3ee;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .standings-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .standings-nav button {
            padding: 0.5rem 1rem;
            background: rgba(30, 58, 138, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.375rem;
            color: #93c5fd;
            font-weight: bold;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .standings-nav button:hover {
            background: rgba(30, 64, 175, 0.5);
        }
        .standings-nav button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .standings-table, .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }
        .standings-table thead, .stats-table thead {
            background: rgba(30, 58, 138, 0.4);
        }
        .standings-table th, .stats-table th {
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-weight: bold;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #93c5fd;
            border-bottom: 2px solid rgba(59, 130, 246, 0.5);
        }
        .standings-table th.text-right,
        .standings-table td.text-right,
        .stats-table th.text-right,
        .stats-table td.text-right {
            text-align: right;
        }
        .standings-table th.text-center,
        .standings-table td.text-center,
        .stats-table th.text-center,
        .stats-table td.text-center {
            text-align: center;
        }
        .standings-table tbody tr, .stats-table tbody tr {
            background: rgba(30, 58, 138, 0.2);
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            transition: background 0.2s;
        }
        .standings-table tbody tr:hover, .stats-table tbody tr:hover {
            background: rgba(30, 64, 175, 0.3);
        }
        .standings-table tbody tr.highlight, .stats-table tbody tr.highlight {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        .standings-table tbody tr.playoff {
            border-left: 3px solid #16a34a;
        }
        .standings-table tbody tr.wildcard {
            border-left: 3px solid #ca8a04;
        }
        .standings-table td, .stats-table td {
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
        }
        .standings-table .rank, .stats-table .rank {
            width: 40px;
            font-weight: bold;
            color: #22d3ee;
        }
        .standings-table .team-name, .stats-table .player-name {
            font-weight: bold;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(30, 58, 138, 0.2);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        .list-item.highlight {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        .list-item span {
            font-weight: bold;
        }
        .player-pos {
            color: #93c5fd;
            margin-left: 0.5rem;
            font-size: 0.85em;
        }
        .clickable-player {
            cursor: pointer;
            transition: all 0.2s;
        }
        .clickable-player:hover {
            color: #60a5fa;
            text-decoration: underline;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        .badge-green {
            background: #16a34a;
        }
        .badge-yellow {
            background: #ca8a04;
        }
        .select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(30, 58, 138, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.375rem;
            color: white;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .select option {
            background: #1e293b;
            color: white;
        }
        .button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .button-primary {
            background: #16a34a;
            color: white;
        }
        .button-primary:hover {
            background: #15803d;
        }
        
        /* Pulse animation for Play Game button */
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
            }
            50% {
                box-shadow: 0 0 30px rgba(34, 197, 94, 0.5);
            }
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .standings-table, .stats-table {
                font-size: 0.75rem;
            }
            .standings-table th,
            .standings-table td,
            .stats-table th,
            .stats-table td {
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
</head>
<body>
<!-- Loading Screen -->
<div id="loading-screen" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 50%, #1e293b 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
">
    <div style="text-align: center;">
        <h1 style="
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(to right, #60a5fa, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease;
        ">
            üèí HockeyGM
        </h1>
        
        <!-- Animated Spinner -->
        <div style="
            width: 60px;
            height: 60px;
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        "></div>
        
        <p style="
            color: #93c5fd;
            font-size: 1.2rem;
            font-weight: 500;
            animation: fadeIn 0.8s ease;
        " id="loading-text">
            Loading league data...
        </p>
        
        <p style="
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 1rem;
            animation: fadeIn 1s ease;
        " id="loading-subtext">
            Generating teams, players, and schedules
        </p>
    </div>
</div>

<style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

    <div id="root"></div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
const { useState, useMemo, useCallback, useRef } = React;

// ==========================================
// GAME CONFIGURATION CONSTANTS
// ==========================================
const GAME_CONFIG = {
    // League Structure
    TEAMS_COUNT: 32,
    DIVISIONS: ['Atlantic', 'Metropolitan', 'Central', 'Pacific'],
    CONFERENCES: ['East', 'West'],
    
    // Season Structure
    REGULAR_SEASON_GAMES: 82,
    PLAYOFF_TEAMS_PER_CONFERENCE: 8,
    PLAYOFF_SERIES_LENGTH: 7,
    PLAYOFF_ROUNDS: 4,
    
    // Draft
    DRAFT_ROUNDS: 7,
    DRAFT_PICKS_PER_ROUND: 32,
    LOTTERY_PICKS: 16,
    
    // Salary Cap
    SALARY_CAP: 83500000, // $83.5M
    SALARY_FLOOR: 61700000, // $61.7M
    MIN_SALARY: 900000, // $900K
    MAX_CONTRACT_LENGTH: 8,
    
    // Free Agency
    MIN_FREE_AGENTS: 50,
    MAX_FREE_AGENTS: 80,
    
    // Roster Limits
    NHL_ROSTER_SIZE: 23,
    MIN_FORWARDS: 12,
    MIN_DEFENSE: 6,
    MIN_GOALIES: 2,
    
    // Player Age
    MIN_AGE: 18,
    MAX_AGE: 42,
    RETIREMENT_AGE_START: 35,
    PRIME_AGE_START: 26,
    PRIME_AGE_END: 30,
    
    // Ratings
    MIN_OVERALL: 40,
    MAX_OVERALL: 99,
    STAR_THRESHOLD: 90,
    ELITE_THRESHOLD: 85,
    STARTER_THRESHOLD: 75,
    
    // Trade
    MAX_TRADE_IMBALANCE_PERCENT: 25,
    FAIR_TRADE_THRESHOLD: 5,
    
    // Contract Re-signing
    RFA_AGE_THRESHOLD: 25,
    RFA_MAX_RAISE_PERCENT: 1.25, // 125% of current salary
    RFA_CONTRACT_MIN_YEARS: 2,
    RFA_CONTRACT_MAX_YEARS: 3,
    
    // Simulation
    SIM_SPEED_DEFAULT: 100, // ms
    SIM_POPUP_DISPLAY_TIME: 100, // ms per game
    
    // UI
    HINT_AUTO_HIDE_DELAY: 10000, // 10 seconds
    SAVE_BANNER_INTERVAL: 600000, // 10 minutes
    SESSION_MILESTONE_1: 300000, // 5 minutes
    SESSION_MILESTONE_2: 900000, // 15 minutes
    SESSION_MILESTONE_3: 1800000 // 30 minutes
};

const TEAMS = [
    { id: 1, city: 'Anaheim', name: 'Waves', abbreviation: 'ANA', conference: 'West', division: 'Pacific', logo: 'üåä', color: '#00A6D6' },
    { id: 2, city: 'Arizona', name: 'Scorpions', abbreviation: 'ARI', conference: 'West', division: 'Pacific', logo: 'ü¶Ç', color: '#8B2635' },
    { id: 3, city: 'Boston', name: 'Blades', abbreviation: 'BOS', conference: 'East', division: 'Atlantic', logo: '‚öîÔ∏è', color: '#FFB81C' },
    { id: 4, city: 'Buffalo', name: 'Storm', abbreviation: 'BUF', conference: 'East', division: 'Atlantic', logo: '‚ö°', color: '#003087' },
    { id: 5, city: 'Calgary', name: 'Inferno', abbreviation: 'CGY', conference: 'West', division: 'Pacific', logo: 'üî•', color: '#D2001C' },
    { id: 6, city: 'Carolina', name: 'Tempest', abbreviation: 'CAR', conference: 'East', division: 'Metropolitan', logo: 'üå™Ô∏è', color: '#C8102E' },
    { id: 7, city: 'Chicago', name: 'Cyclones', abbreviation: 'CHI', conference: 'West', division: 'Central', logo: 'üåÄ', color: '#CF0A2C' },
    { id: 8, city: 'Colorado', name: 'Summit', abbreviation: 'COL', conference: 'West', division: 'Central', logo: '‚õ∞Ô∏è', color: '#6F263D' },
    { id: 9, city: 'Columbus', name: 'Commanders', abbreviation: 'CBJ', conference: 'East', division: 'Metropolitan', logo: '‚≠ê', color: '#002654' },
    { id: 10, city: 'Dallas', name: 'Outlaws', abbreviation: 'DAL', conference: 'West', division: 'Central', logo: 'ü§†', color: '#006847' },
    { id: 11, city: 'Detroit', name: 'Motors', abbreviation: 'DET', conference: 'East', division: 'Atlantic', logo: 'üèéÔ∏è', color: '#CE1126' },
    { id: 12, city: 'Edmonton', name: 'Express', abbreviation: 'EDM', conference: 'West', division: 'Pacific', logo: 'üöÇ', color: '#FF4C00' },
    { id: 13, city: 'Florida', name: 'Surge', abbreviation: 'FLA', conference: 'East', division: 'Atlantic', logo: 'üêÜ', color: '#C8102E' },
    { id: 14, city: 'Los Angeles', name: 'Knights', abbreviation: 'LAK', conference: 'West', division: 'Pacific', logo: 'üëë', color: '#111111' },
    { id: 15, city: 'Minnesota', name: 'North Starz', abbreviation: 'MIN', conference: 'West', division: 'Central', logo: '‚≠ê', color: '#154734' },
    { id: 16, city: 'Montreal', name: 'Metros', abbreviation: 'MTL', conference: 'East', division: 'Atlantic', logo: 'üöá', color: '#AF1E2D' },
    { id: 17, city: 'Nashville', name: 'Strikers', abbreviation: 'NSH', conference: 'West', division: 'Central', logo: 'üé∏', color: '#FFB81C' },
    { id: 18, city: 'New Jersey', name: 'Vipers', abbreviation: 'NJD', conference: 'East', division: 'Metropolitan', logo: 'üêç', color: '#CE1126' },
    { id: 19, city: 'New York', name: 'Mariners', abbreviation: 'NYI', conference: 'East', division: 'Metropolitan', logo: '‚öì', color: '#00539B' },
    { id: 20, city: 'New York', name: 'Rockets', abbreviation: 'NYR', conference: 'East', division: 'Metropolitan', logo: 'üöÄ', color: '#0038A8' },
    { id: 21, city: 'Ottawa', name: 'Capitals', abbreviation: 'OTT', conference: 'East', division: 'Atlantic', logo: 'üèõÔ∏è', color: '#C52032' },
    { id: 22, city: 'Philadelphia', name: 'Phoenix', abbreviation: 'PHI', conference: 'East', division: 'Metropolitan', logo: 'üî•', color: '#F74902' },
    { id: 23, city: 'Pittsburgh', name: 'Steel', abbreviation: 'PIT', conference: 'East', division: 'Metropolitan', logo: '‚öôÔ∏è', color: '#FCB514' },
    { id: 24, city: 'San Jose', name: 'Barracudas', abbreviation: 'SJS', conference: 'West', division: 'Pacific', logo: 'üêü', color: '#006D75' },
    { id: 25, city: 'Seattle', name: 'Storm', abbreviation: 'SEA', conference: 'West', division: 'Pacific', logo: 'üåßÔ∏è', color: '#99D9D9' },
    { id: 26, city: 'St. Louis', name: 'Archers', abbreviation: 'STL', conference: 'West', division: 'Central', logo: 'üèπ', color: '#002F87' },
    { id: 27, city: 'Tampa Bay', name: 'Thunder', abbreviation: 'TBL', conference: 'East', division: 'Atlantic', logo: '‚ö°', color: '#002868' },
    { id: 28, city: 'Toronto', name: 'Titans', abbreviation: 'TOR', conference: 'East', division: 'Atlantic', logo: 'üí™', color: '#003E7E' },
    { id: 29, city: 'Vancouver', name: 'Orcas', abbreviation: 'VAN', conference: 'West', division: 'Pacific', logo: 'üêã', color: '#00205B' },
    { id: 30, city: 'Vegas', name: 'Vipers', abbreviation: 'VGK', conference: 'West', division: 'Pacific', logo: 'üé∞', color: '#B4975A' },
    { id: 31, city: 'Washington', name: 'Sentinels', abbreviation: 'WSH', conference: 'East', division: 'Metropolitan', logo: 'üõ°Ô∏è', color: '#041E42' },
    { id: 32, city: 'Winnipeg', name: 'Blizzard', abbreviation: 'WPG', conference: 'West', division: 'Central', logo: '‚ùÑÔ∏è', color: '#041E42' },
];

// IMPORTANT: Number of NAHL teams - update this if adding expansion teams!
const NUM_TEAMS = TEAMS.length; // Currently 32

// ==================== SALARY CAP CONSTANTS ====================
const SALARY_CAP = {
    ceiling: 88000000,  // $88M upper limit (2024-25 season)
    floor: 65000000,    // $65M lower limit
    midpoint: 76500000, // $76.5M midpoint
    minimum: 775000     // $775K minimum salary
};

// ==================== ROSTER SIZE LIMITS ====================
const ROSTER_LIMITS = {
    NHL: 23,           // Maximum NHL roster (18 skaters + 2 goalies + 3 reserves)
    FARM: 50,          // Maximum farm team roster
    TOTAL: 73          // Combined maximum (23 NHL + 50 Farm)
};

// Entry-level contract salaries by draft round
const ELC_SALARIES = {
    1: 925000,  // Round 1: Near max ELC
    2: 875000,  // Round 2: High ELC
    3: 825000,  // Round 3: Mid ELC  
    4: 800000,  // Round 4: Low ELC
    5: 787500,  // Round 5: Near minimum
    6: 781250,  // Round 6: Near minimum
    7: 775000   // Round 7: League minimum
};


// ==================== LEAGUE NAMES ====================
const LEAGUE_NAME = "North American Hockey League";
const LEAGUE_ABBR = "NAHL";
const MINOR_LEAGUE_NAME = "North American Minor Hockey League";
const MINOR_LEAGUE_ABBR = "NAMHL";

// ==================== LEAGUE CONFIGURATION CONSTANTS ====================
// Update these values to customize league rules and season structure

// SEASON STRUCTURE
const GAMES_PER_SEASON = 82;           // Regular season games per team (82 days)

// ROSTER SIZES
const NHL_ROSTER_SIZE = 23;            // Active NAHL roster
const FORWARDS_COUNT = 13;             // Forwards per team
const DEFENSE_COUNT = 7;               // Defensemen per team
const GOALIES_COUNT = 3;               // Goalies per team
const FORWARD_LINES = 4;               // Number of forward lines (1-4)
const DEFENSE_PAIRS = 3;               // Number of defense pairs (1-3)

// PLAYOFFS
const PLAYOFF_TEAMS = 16;              // Teams that make playoffs
const PLAYOFF_TEAMS_PER_CONFERENCE = 8; // Per conference

// PLAYER LIMITS
const MAX_PLAYER_AGE = 42;             // Maximum age before retirement
const YOUNG_PLAYER_AGE = 25;           // Age threshold for development tracking

// GAME SIMULATION
const AVG_GOALS_PER_GAME = 6;          // League average total goals per game
const INJURY_RATE_PER_TEAM = 12.5;     // Injuries per team per season (~400/32)

// STREAKS & BONUSES
const STREAK_BONUS_TIER_1 = 5;         // Games for +2 OVR bonus
const STREAK_BONUS_TIER_2 = 10;        // Games for +3 OVR bonus
const STREAK_BONUS_TIER_3 = 15;        // Games for +4 OVR bonus (cap)
const SCORELESS_PENALTY_GAMES = 10;    // Games scoreless for -2 OVR penalty
const TEAM_STREAK_TIER_1 = 5;          // Wins for +3% team bonus
const TEAM_STREAK_TIER_2 = 10;         // Wins for +5% team bonus (cap)

// MID-SEASON
const MID_SEASON_GAME = 41;            // Game for mid-season report (All-Star Break)
const PLAYOFF_RACE_START_GAME = 62;    // When playoff race tags start (last 20 games)

// ========================================================================

// Farm teams (NAMHL) - affiliated with NAHL teams
const FARM_TEAMS = [
    { id: 101, nhlAffiliation: 1, city: 'San Diego', name: 'Gulls', abbreviation: 'SDG' },
    { id: 102, nhlAffiliation: 2, city: 'Tucson', name: 'Roadrunners', abbreviation: 'TUC' },
    { id: 103, nhlAffiliation: 3, city: 'Providence', name: 'Bruins', abbreviation: 'PRO' },
    { id: 104, nhlAffiliation: 4, city: 'Rochester', name: 'Americans', abbreviation: 'ROC' },
    { id: 105, nhlAffiliation: 5, city: 'Abbotsford', name: 'Heat', abbreviation: 'ABB' },
    { id: 106, nhlAffiliation: 6, city: 'Springfield', name: 'Thunderbirds', abbreviation: 'SPR' },
    { id: 107, nhlAffiliation: 7, city: 'Rockford', name: 'IceHogs', abbreviation: 'RFD' },
    { id: 108, nhlAffiliation: 8, city: 'Loveland', name: 'Eagles', abbreviation: 'LOV' },
    { id: 109, nhlAffiliation: 9, city: 'Cleveland', name: 'Monsters', abbreviation: 'CLE' },
    { id: 110, nhlAffiliation: 10, city: 'Cedar Park', name: 'Stars', abbreviation: 'TEX' },
    { id: 111, nhlAffiliation: 11, city: 'Grand Rapids', name: 'Griffins', abbreviation: 'GRG' },
    { id: 112, nhlAffiliation: 12, city: 'Bakersfield', name: 'Condors', abbreviation: 'BAK' },
    { id: 113, nhlAffiliation: 13, city: 'Charlotte', name: 'Checkers', abbreviation: 'CHR' },
    { id: 114, nhlAffiliation: 14, city: 'Ontario', name: 'Reign', abbreviation: 'ONT' },
    { id: 115, nhlAffiliation: 15, city: 'Iowa', name: 'Wild', abbreviation: 'IOW' },
    { id: 116, nhlAffiliation: 16, city: 'Laval', name: 'Rocket', abbreviation: 'LAV' },
    { id: 117, nhlAffiliation: 17, city: 'Milwaukee', name: 'Admirals', abbreviation: 'MIL' },
    { id: 118, nhlAffiliation: 18, city: 'Utica', name: 'Comets', abbreviation: 'UTI' },
    { id: 119, nhlAffiliation: 19, city: 'Bridgeport', name: 'Islanders', abbreviation: 'BRI' },
    { id: 120, nhlAffiliation: 20, city: 'Hartford', name: 'Wolf Pack', abbreviation: 'HAR' },
    { id: 121, nhlAffiliation: 21, city: 'Belleville', name: 'Senators', abbreviation: 'BEL' },
    { id: 122, nhlAffiliation: 22, city: 'Lehigh Valley', name: 'Phantoms', abbreviation: 'LHV' },
    { id: 123, nhlAffiliation: 23, city: 'Wilkes-Barre', name: 'Penguins', abbreviation: 'WBS' },
    { id: 124, nhlAffiliation: 24, city: 'San Jose', name: 'Barracuda', abbreviation: 'SJB' },
    { id: 125, nhlAffiliation: 25, city: 'Coachella Valley', name: 'Firebirds', abbreviation: 'CV' },
    { id: 126, nhlAffiliation: 26, city: 'Springfield', name: 'Thunderbirds', abbreviation: 'SPT' },
    { id: 127, nhlAffiliation: 27, city: 'Syracuse', name: 'Crunch', abbreviation: 'SYR' },
    { id: 128, nhlAffiliation: 28, city: 'Toronto', name: 'Marlies', abbreviation: 'TML' },
    { id: 129, nhlAffiliation: 29, city: 'Abbotsford', name: 'Canucks', abbreviation: 'ABB' },
    { id: 130, nhlAffiliation: 30, city: 'Henderson', name: 'Silver Knights', abbreviation: 'HEN' },
    { id: 131, nhlAffiliation: 31, city: 'Hershey', name: 'Bears', abbreviation: 'HER' },
    { id: 132, nhlAffiliation: 32, city: 'Manitoba', name: 'Moose', abbreviation: 'MAN' },
];

const FIRST_NAMES = ['Connor', 'Nathan', 'Alex', 'Ryan', 'Tyler', 'Jake', 'Marcus', 'Dylan', 
    'Ethan', 'Jack', 'Owen', 'Liam', 'Noah', 'Mason', 'Logan', 'Lucas', 'Elijah', 'Oliver',
    'James', 'William', 'Benjamin', 'Henry', 'Samuel', 'David', 'Joseph', 'Carter', 'Wyatt',
    'John', 'Sebastian', 'Matthew'];
const LAST_NAMES = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Miller', 'Davis', 'Wilson',
    'Anderson', 'Taylor', 'Thomas', 'Moore', 'Jackson', 'Martin', 'Lee', 'Thompson', 'White',
    'Harris', 'Clark', 'Lewis', 'Robinson', 'Walker', 'Young', 'Hall', 'Allen', 'King', 'Wright',
    'Lopez', 'Hill', 'Scott'];

// ==================== CONTRACT & SALARY FUNCTIONS ====================

/**
 * Update head-to-head record between two teams
 */
const updateHeadToHead = (headToHeadObj, homeTeamId, awayTeamId, winner) => {
    const h2hKey = homeTeamId < awayTeamId ? 
        `${homeTeamId}vs${awayTeamId}` : 
        `${awayTeamId}vs${homeTeamId}`;
    
    if (!headToHeadObj[h2hKey]) {
        headToHeadObj[h2hKey] = {
            team1: homeTeamId < awayTeamId ? homeTeamId : awayTeamId,
            team2: homeTeamId < awayTeamId ? awayTeamId : homeTeamId,
            team1Wins: 0,
            team2Wins: 0
        };
    }
    
    // Increment win count for winner
    if (winner === 'home') {
        if (homeTeamId === headToHeadObj[h2hKey].team1) {
            headToHeadObj[h2hKey].team1Wins++;
        } else {
            headToHeadObj[h2hKey].team2Wins++;
        }
    } else {
        if (awayTeamId === headToHeadObj[h2hKey].team1) {
            headToHeadObj[h2hKey].team1Wins++;
        } else {
            headToHeadObj[h2hKey].team2Wins++;
        }
    }
};

/**
 * Calculate realistic salary based on player overall, position, and age
 */
const calculateSalaryByOVR = (ovr, position, age) => {
    // Position multipliers (based on NHL averages)
    const posMultiplier = {
        'F': 1.0,
        'D': 1.035,  // Defensemen paid ~3.5% more on average
        'G': 0.90    // Goalies paid ~10% less on average
    };
    
    // Age factors (prime years 24-30 command premium)
    const ageFactor = age >= 24 && age <= 30 ? 1.1 : 
                     age < 24 ? 0.85 : 
                     age > 35 ? 0.7 : 0.95;
    
    let baseSalary;
    
    // Salary tiers based on overall rating
    if (ovr >= 90) baseSalary = 10000000 + ((ovr - 90) * 700000);      // $10M-$16.7M Elite
    else if (ovr >= 85) baseSalary = 6000000 + ((ovr - 85) * 800000);   // $6M-$10M Stars
    else if (ovr >= 80) baseSalary = 4000000 + ((ovr - 80) * 400000);   // $4M-$6M Above Avg
    else if (ovr >= 75) baseSalary = 2000000 + ((ovr - 75) * 400000);   // $2M-$4M Solid
    else if (ovr >= 70) baseSalary = 1500000 + ((ovr - 70) * 100000);   // $1.5M-$2M Average
    else if (ovr >= 65) baseSalary = 900000 + ((ovr - 65) * 120000);    // $900K-$1.5M Depth
    else baseSalary = SALARY_CAP.minimum + ((ovr - 50) * 8333);         // $775K-$900K Bottom
    
    return Math.round(baseSalary * posMultiplier[position] * ageFactor);
};

/**
 * Determine contract length based on age and overall
 */
const determineContractLength = (age, ovr) => {
    // Elite young players get longer deals
    if (ovr >= 85 && age < 28) return Math.floor(Math.random() * 3) + 5; // 5-7 years
    
    // Prime age players
    if (age >= 24 && age <= 30) return Math.floor(Math.random() * 3) + 4; // 4-6 years
    
    // Older players get shorter deals
    if (age > 32) return Math.floor(Math.random() * 2) + 1; // 1-2 years
    
    // Young players building career
    return Math.floor(Math.random() * 3) + 2; // 2-4 years
};

/**
 * Generate contract for a player
 */
const generateContract = (player) => {
    const { ratings, position, age } = player;
    const ovr = ratings.overall;
    
    // Entry-level contract for young players
    if (age < 25 && ovr < 80) { // Most rookies are under 80 OVR
        const elcSalary = Math.max(
            SALARY_CAP.minimum,
            SALARY_CAP.minimum + (ovr * 2500) // $775K to ~$975K
        );
        
        return {
            salary: Math.round(elcSalary),
            capHit: Math.round(elcSalary),
            yearsRemaining: age <= 21 ? 3 : age <= 23 ? 2 : 1,
            totalYears: age <= 21 ? 3 : age <= 23 ? 2 : 1,
            type: 'elc',
            ufa: false,
            rfa: true
        };
    }
    
    // Standard contracts for established players
    const baseSalary = calculateSalaryByOVR(ovr, position, age);
    const contractLength = determineContractLength(age, ovr);
    
    return {
        salary: baseSalary,
        capHit: baseSalary,
        yearsRemaining: contractLength,
        totalYears: contractLength,
        type: 'standard',
        ufa: age >= 27,
        rfa: age < 27 && age >= 25
    };
};

/**
 * Calculate team's total cap hit
 */
const calculateTeamCapHit = (teamId, players) => {
    const nhlPlayers = players.filter(p => 
        p.teamId === teamId && p.roster === 'nhl'
    );
    
    const totalCapHit = nhlPlayers.reduce((sum, p) => {
        return sum + (p.contract?.capHit || 0);
    }, 0);
    
    return {
        totalCapHit: totalCapHit,
        capSpace: SALARY_CAP.ceiling - totalCapHit,
        playerCount: nhlPlayers.length,
        averageSalary: nhlPlayers.length > 0 ? totalCapHit / nhlPlayers.length : 0,
        overCap: totalCapHit > SALARY_CAP.ceiling,
        underFloor: totalCapHit < SALARY_CAP.floor
    };
};

/**
 * Format currency for display
 */
const formatSalary = (amount) => {
    if (amount >= 1000000) {
        return `$${(amount / 1000000).toFixed(2)}M`;
    }
    return `$${(amount / 1000).toFixed(0)}K`;
};

// ==================== TEAM PROFILE SYSTEM ====================

/**
 * Calculate playoff probability based on current standings
 */
const calculatePlayoffProbability = (teamId, standings, schedule) => {
    const standing = standings.find(s => s.teamId === teamId);
    if (!standing) return 0;
    
    const gamesPlayed = standing.wins + standing?.losses + standing?.otLosses;
    const gamesRemaining = 82 - gamesPlayed;
    
    if (gamesRemaining === 0) {
        // Season over - check if they made playoffs (top 8 in conference)
        const team = TEAMS.find(t => t.id === teamId);
        const conferenceTeams = standings.filter(s => {
            const t = TEAMS.find(tm => tm.id === s.teamId);
            return t && team && t.conference === team.conference;
        }).sort((a, b) => b.points - a.points);
        
        const rank = conferenceTeams.findIndex(s => s.teamId === teamId) + 1;
        return rank <= 8 ? 100 : 0;
    }
    
    // Current points
    const currentPoints = standing.points;
    
    // Points pace (projected to 82 games)
    const pointsPace = gamesPlayed > 0 ? (currentPoints / gamesPlayed) * 82 : 0;
    
    // Historical playoff cutoff: ~95 points typically needed
    const playoffCutoff = 95;
    
    // Calculate probability based on pace and position
    let probability = 0;
    
    if (pointsPace >= playoffCutoff + 10) {
        probability = 95; // Near lock
    } else if (pointsPace >= playoffCutoff) {
        probability = 75; // Very likely
    } else if (pointsPace >= playoffCutoff - 5) {
        probability = 60; // Good chance
    } else if (pointsPace >= playoffCutoff - 10) {
        probability = 40; // Bubble team
    } else if (pointsPace >= playoffCutoff - 15) {
        probability = 20; // Long shot
    } else {
        probability = 5; // Very unlikely
    }
    
    // Adjust based on current conference position
    const team = TEAMS.find(t => t.id === teamId);
    const conferenceTeams = standings.filter(s => {
        const t = TEAMS.find(tm => tm.id === s.teamId);
        return t && team && t.conference === team.conference;
    }).sort((a, b) => b.points - a.points);
    
    const rank = conferenceTeams.findIndex(s => s.teamId === teamId) + 1;
    
    if (rank <= 3) probability = Math.min(95, probability + 15);
    else if (rank <= 8) probability = Math.min(90, probability + 10);
    else if (rank <= 10) probability = Math.max(5, probability - 5);
    else probability = Math.max(5, probability - 15);
    
    return Math.max(0, Math.min(100, probability));
};

/**
 * Calculate comprehensive player value
 */
const calculatePlayerValue = (player) => {
    if (!player) return 0;
    
    const ovr = player.ratings.overall;
    const pot = player.ratings.potential;
    const age = player.age;
    
    // Base value: weighted toward current ability
    let value = (ovr * 0.65) + (pot * 0.35);
    
    // Age factor
    let ageFactor = 1.0;
    if (age < 23) ageFactor = 0.85; // Young, unproven
    else if (age >= 23 && age <= 26) ageFactor = 1.1; // Prime entry
    else if (age >= 27 && age <= 30) ageFactor = 1.15; // Peak prime
    else if (age >= 31 && age <= 33) ageFactor = 0.95; // Declining
    else if (age > 33) ageFactor = 0.7; // Old
    
    value *= ageFactor;
    
    // Contract value (salary efficiency)
    if (player.contract) {
        const expectedSalary = calculateSalaryByOVR(ovr, player.position, age);
        const actualSalary = player.contract.capHit;
        
        // Good contract = higher value
        if (actualSalary < expectedSalary * 0.8) {
            value *= 1.1; // Bargain contract
        } else if (actualSalary > expectedSalary * 1.2) {
            value *= 0.9; // Overpaid
        }
    }
    
    // Stats multiplier (if they've played games)
    if (player.stats.gamesPlayed >= 10) {
        const ppg = player.stats.points / player.stats.gamesPlayed;
        if (player.position !== 'G') {
            if (ppg > 1.0) value *= 1.15; // Elite producer
            else if (ppg > 0.7) value *= 1.1; // Great producer
            else if (ppg < 0.3) value *= 0.95; // Struggling
        } else {
            // Goalies - use save percentage
            if (player.stats.savePercentage > 0.92) value *= 1.15;
            else if (player.stats.savePercentage > 0.90) value *= 1.1;
            else if (player.stats.savePercentage < 0.88) value *= 0.9;
        }
    }
    
    // Position scarcity
    if (player.position === 'G' && ovr >= 85) value *= 1.1; // Elite goalies rare
    if (player.position === 'D' && ovr >= 88) value *= 1.05; // Top D-men valuable
    
    return Math.round(value);
};

/**
 * Determine team status based on playoff probability and overall
 */
const determineTeamStatus = (teamId, standings, schedule, teamOverall) => {
    const playoffProb = calculatePlayoffProbability(teamId, standings, schedule);
    const standing = standings.find(s => s.teamId === teamId);
    const gamesPlayed = standing ? (standing.wins + standing?.losses + standing?.otLosses) : 0;
    
    // Early season (< 20 games): base on team overall
    if (gamesPlayed < 20) {
        if (teamOverall >= 82) return 'Contend';
        if (teamOverall >= 75) return 'Compete';
        return 'Rebuild';
    }
    
    // Mid/Late season: base on playoff probability with patience
    if (playoffProb >= 70) return 'Contend';
    if (playoffProb >= 35) return 'Compete';
    if (playoffProb < 15) return 'Rebuild';
    
    // Otherwise maintain current status (gives teams patience)
    return 'Compete';
};

/**
 * Generate initial team profile
 */
const generateTeamProfile = (teamId, teamOverall) => {
    // Budget sensitivity: Most teams medium, some extremes
    const budgetRoll = Math.random();
    let budgetSensitivity;
    if (budgetRoll < 0.15) budgetSensitivity = 'Low'; // Big spenders
    else if (budgetRoll > 0.85) budgetSensitivity = 'High'; // Budget conscious
    else budgetSensitivity = 'Medium';
    
    // Prospect bias: Medium for now
    const prospectBias = 'Medium';
    
    // Initial status based on team overall
    let status;
    if (teamOverall >= 82) status = 'Contend';
    else if (teamOverall >= 75) status = 'Compete';
    else status = 'Rebuild';
    
    return {
        teamId,
        status, // Rebuild / Compete / Contend
        budgetSensitivity, // Low / Medium / High
        prospectBias, // Low / Medium / High
        playoffProbability: 50, // Will be calculated
        tradeDeadlineApproach: 'Neutral', // Buyer / Seller / Neutral
        lastStatusCheck: 0 // Game number when last checked
    };
};

/**
 * Update team profiles based on current season state
 */
const updateTeamProfiles = (profiles, standings, schedule, players, currentDay) => {
    const updatedProfiles = [...profiles];
    
    // Only update every 10 games to give teams patience
    const firstStanding = standings[0];
    const gamesPlayed = firstStanding ? (firstStanding.wins + firstStanding?.losses + firstStanding?.otLosses) : 0;
    const shouldUpdate = gamesPlayed > 0 && gamesPlayed % 10 === 0;
    
    updatedProfiles.forEach(profile => {
        if (shouldUpdate && profile.lastStatusCheck !== gamesPlayed) {
            // Calculate playoff probability
            profile.playoffProbability = calculatePlayoffProbability(
                profile.teamId, 
                standings, 
                schedule
            );
            
            // Get team overall
            const teamPlayers = players.filter(p => p.teamId === profile.teamId && p.roster === 'nhl');
            const teamOVR = teamPlayers.reduce((sum, p) => sum + p.ratings.overall, 0) / teamPlayers.length;
            
            // Update status
            profile.status = determineTeamStatus(
                profile.teamId, 
                standings, 
                schedule, 
                Math.round(teamOVR)
            );
            
            profile.lastStatusCheck = gamesPlayed;
        }
        
        // Update trade deadline approach
        const daysUntilDeadline = 56 - currentDay; // Trade deadline at day 56
        
        if (currentDay >= 56) {
            profile.tradeDeadlineApproach = 'Neutral'; // After deadline
        } else if (daysUntilDeadline <= 10) {
            // Aggressive near deadline
            if (profile.playoffProbability >= 60) {
                profile.tradeDeadlineApproach = 'Aggressive Buyer';
            } else if (profile.playoffProbability <= 30) {
                profile.tradeDeadlineApproach = 'Aggressive Seller';
            } else {
                profile.tradeDeadlineApproach = 'Neutral';
            }
        } else if (daysUntilDeadline <= 20) {
            // Moderate before deadline
            if (profile.playoffProbability >= 65) {
                profile.tradeDeadlineApproach = 'Buyer';
            } else if (profile.playoffProbability <= 25) {
                profile.tradeDeadlineApproach = 'Seller';
            } else {
                profile.tradeDeadlineApproach = 'Neutral';
            }
        } else {
            profile.tradeDeadlineApproach = 'Neutral';
        }
    });
    
    return updatedProfiles;
};

// ==================== PLAYER AGING SYSTEM ====================

/**
 * Seeded random number generator for consistent team previews
 * Same seed = same random sequence
 */
const seededRandom = (seed) => {
    let state = seed;
    return () => {
        state = (state * 9301 + 49297) % 233280;
        return state / 233280;
    };
};

/**
 * Calculate age-appropriate potential based on player age
 * Young players have room to grow, older players' potential drops
 */
const calculateAgePotential = (age, currentOVR, originalPotential) => {
    let potentialCeiling = originalPotential;
    
    // Age 18-23: Full potential (can still grow significantly)
    if (age <= 23) {
        return potentialCeiling;
    }
    // Age 24-27: Potential slowly decreases (closing development window)
    else if (age <= 27) {
        const yearsOverPrime = age - 23;
        const declineRate = 1.5; // Lose 1.5 POT per year
        potentialCeiling -= (yearsOverPrime * declineRate);
    }
    // Age 28-30: Potential drops faster (development essentially complete)
    else if (age <= 30) {
        const baseDecline = 4 * 1.5; // Already lost from 24-27
        const additionalYears = age - 27;
        const fasterDeclineRate = 3; // Lose 3 POT per year
        potentialCeiling -= (baseDecline + additionalYears * fasterDeclineRate);
    }
    // Age 31+: Potential essentially 0 (99% of players)
    else {
        // 1% of players (elite genetics) keep small potential
        const isEliteGenes = Math.random() < 0.01;
        potentialCeiling = isEliteGenes ? currentOVR + 1 : currentOVR;
    }
    
    // Potential can never be lower than current OVR
    return Math.max(currentOVR, Math.round(potentialCeiling));
};

// ==========================================
// UTILITY HELPER FUNCTIONS
// ==========================================

/**
 * Get all players for a specific team
 */
const getTeamPlayers = (players, teamId, options = {}) => {
    const { roster = null, position = null, active = false } = options;
    
    let filtered = players.filter(p => p.teamId === teamId);
    
    if (roster) filtered = filtered.filter(p => p.roster === roster);
    if (position) filtered = filtered.filter(p => p.position === position);
    if (active) filtered = filtered.filter(p => !p.injury.injured && (p.position === 'G' ? p.dressed : p.lineNumber > 0));
    
    return filtered;
};

/**
 * Calculate team's current salary cap usage
 */
const getTeamCapSpace = (players, teamId) => {
    const teamPlayers = getTeamPlayers(players, teamId);
    const currentCap = teamPlayers.reduce((sum, p) => sum + (p.contract?.salary || 0), 0);
    return GAME_CONFIG.SALARY_CAP - currentCap;
};

/**
 * Check if player meets star/elite threshold
 */
const getPlayerTier = (overall) => {
    if (overall >= GAME_CONFIG.STAR_THRESHOLD) return 'star';
    if (overall >= GAME_CONFIG.ELITE_THRESHOLD) return 'elite';
    if (overall >= GAME_CONFIG.STARTER_THRESHOLD) return 'starter';
    return 'depth';
};

/**
 * Check if team has minimum roster requirements
 */
const hasValidRoster = (players, teamId) => {
    const roster = getTeamPlayers(players, teamId, { roster: 'nhl' });
    const forwards = roster.filter(p => ['C', 'LW', 'RW'].includes(p.position)).length;
    const defense = roster.filter(p => p.position === 'D').length;
    const goalies = roster.filter(p => p.position === 'G').length;
    
    return forwards >= GAME_CONFIG.MIN_FORWARDS && 
           defense >= GAME_CONFIG.MIN_DEFENSE && 
           goalies >= GAME_CONFIG.MIN_GOALIES;
};

/**
 * Determine player's aging archetype for skill decline
 * Returns decline rate multiplier (0.5 = ages well, 2.0 = ages poorly)
 */
const determineAgingArchetype = (player) => {
    // Base decline rate
    let declineMultiplier = 1.0;
    
    // Position-based aging (some positions age better)
    if (player.position === 'G') {
        declineMultiplier *= 0.7; // Goalies age best
    } else if (player.position === 'D') {
        declineMultiplier *= 0.85; // Defensemen age well
    } else {
        declineMultiplier *= 1.0; // Forwards age normally
    }
    
    // Random genetic factor (some players just built different)
    // 70% normal (0.8-1.2x), 20% age well (0.5-0.8x), 10% age poorly (1.2-1.5x)
    const geneticRoll = Math.random();
    if (geneticRoll < 0.20) {
        // Ages well (20% of players)
        declineMultiplier *= (0.5 + Math.random() * 0.3); // 0.5-0.8x
    } else if (geneticRoll > 0.90) {
        // Ages poorly (10% of players)
        declineMultiplier *= (1.2 + Math.random() * 0.3); // 1.2-1.5x
    } else {
        // Normal aging (70% of players)
        declineMultiplier *= (0.8 + Math.random() * 0.4); // 0.8-1.2x
    }
    
    // Injury history impact (more injuries = faster decline)
    // Count career injuries from milestone tracking
    const injuryCount = player.milestones?.filter(m => m.type === 'injury').length || 0;
    
    if (injuryCount >= 5) {
        declineMultiplier *= 1.3; // Many injuries = 30% faster decline
    } else if (injuryCount >= 3) {
        declineMultiplier *= 1.15; // Some injuries = 15% faster decline
    } else if (injuryCount >= 1) {
        declineMultiplier *= 1.05; // Few injuries = 5% faster decline
    }
    // 0 injuries = no additional decline
    
    return declineMultiplier;
};

/**
 * Apply annual aging to a player (called once per season)
 * Handles both potential decline and skill loss
 */
const applyAnnualAging = (player) => {
    const age = player.age;
    const currentOVR = player.ratings.overall;
    const currentPOT = player.ratings.potential;
    
    // Store original potential if not already stored
    if (!player.originalPotential) {
        player.originalPotential = currentPOT;
    }
    
    // Update potential based on age
    player.ratings.potential = calculateAgePotential(age, currentOVR, player.originalPotential);
    
    // Skill decline starts at age 31
    if (age >= 31) {
        // Determine how much this player declines
        if (!player.agingMultiplier) {
            player.agingMultiplier = determineAgingArchetype(player);
        }
        
        // Position-specific peak ages
        let declineAge = 31; // Default for forwards
        if (player.position === 'D') declineAge = 32;
        if (player.position === 'G') declineAge = 34;
        
        // Only decline if past peak for position
        if (age >= declineAge) {
            // Base decline increases with age
            let baseDecline = 0;
            
            if (age === declineAge) {
                baseDecline = 0.5; // Minimal first year
            } else if (age <= declineAge + 2) {
                baseDecline = 1.0; // -1 OVR per year
            } else if (age <= declineAge + 4) {
                baseDecline = 1.5; // -1.5 OVR per year
            } else {
                baseDecline = 2.0; // -2 OVR per year (rapid decline)
            }
            
            // Apply player's aging multiplier
            const actualDecline = baseDecline * player.agingMultiplier;
            
            // Apply decline (minimum OVR of 50)
            const newOVR = Math.max(50, Math.round(currentOVR - actualDecline));
            player.ratings.overall = newOVR;
            
            // Potential can never be higher than current OVR for aging players
            player.ratings.potential = Math.max(newOVR, Math.min(newOVR, player.ratings.potential));
        }
    }
    
    // Age the player
    player.age += 1;
    
    return player;
};

/**
 * Process end-of-season aging for all players
 */
const processEndOfSeasonAging = (players) => {
    return players.map(player => {
        applyAnnualAging(player);
        return player;
    });
};

// ==================== DRAFT PICK SYSTEM ====================

/**
 * Generate initial draft picks for all teams (current year + next year)
 */
const generateInitialDraftPicks = (currentYear) => {
    const draftPicks = [];
    
    // Generate picks for current year and next year
    for (let yearOffset = 0; yearOffset <= 1; yearOffset++) {
        const draftYear = currentYear + yearOffset;
        
        // GAME_CONFIG.DRAFT_ROUNDS rounds, GAME_CONFIG.DRAFT_PICKS_PER_ROUND picks each
        for (let round = 1; round <= GAME_CONFIG.DRAFT_ROUNDS; round++) {
            for (let pickInRound = 1; pickInRound <= GAME_CONFIG.DRAFT_PICKS_PER_ROUND; pickInRound++) {
                const overallPick = (round - 1) * GAME_CONFIG.DRAFT_PICKS_PER_ROUND + pickInRound;
                
                draftPicks.push({
                    id: `${draftYear}-R${round}-${pickInRound}`,
                    year: draftYear,
                    round: round,
                    pickInRound: pickInRound,
                    overallPick: overallPick,
                    originalTeam: pickInRound, // Team ID (1-32)
                    currentOwner: pickInRound, // Team ID (1-32), can be traded
                    isLotteryPick: round === 1 && pickInRound <= 5 // First 5 picks of round 1
                });
            }
        }
    }
    
    return draftPicks;
};

/**
 * Calculate draft pick value for trading
 * Returns OVR equivalent value for trade evaluation
 */
const calculateDraftPickValue = (pick, standings, teamProfiles, draftProspects, currentYear) => {
    let baseValue = 0;
    
    // Base value by round and pick position (OVR equivalent)
    if (pick.round === 1) {
        // Round 1: Top picks = elite prospects (85-75 OVR equivalent)
        baseValue = 85 - (pick.pickInRound * 0.3);
    } else if (pick.round === 2) {
        // Round 2: Good prospects (72-65 OVR equivalent)
        baseValue = 72 - (pick.pickInRound * 0.22);
    } else if (pick.round === 3) {
        // Round 3: Depth prospects (65-58 OVR equivalent)
        baseValue = 65 - (pick.pickInRound * 0.22);
    } else if (pick.round === 4) {
        // Round 4: Low-end prospects (50-45 OVR equivalent)
        baseValue = 50 - (pick.pickInRound * 0.15);
    } else if (pick.round === 5) {
        // Round 5: Long shots (35-30 OVR equivalent)
        baseValue = 35 - (pick.pickInRound * 0.15);
    } else if (pick.round === 6) {
        // Round 6: Very long shots (20-15 OVR equivalent)
        baseValue = 20 - (pick.pickInRound * 0.15);
    } else {
        // Round 7: Lottery tickets (10-5 OVR equivalent)
        baseValue = 10 - (pick.pickInRound * 0.15);
    }
    
    // Bonus for lottery picks
    if (pick.isLotteryPick) {
        baseValue += 5; // Top 5 picks get bonus
    }
    
    // Adjust based on draft class quality (if prospects available)
    if (draftProspects && draftProspects.length > 0) {
        // Calculate average potential of top 32 prospects
        const top32 = draftProspects.slice(0, 32);
        const avgPotential = top32.reduce((sum, p) => sum + p.ratings.potential, 0) / top32.length;
        
        // Strong draft class (avg 82+): +5% value
        // Weak draft class (avg <78): -5% value
        if (avgPotential >= 82) {
            baseValue *= 1.05;
        } else if (avgPotential < 78) {
            baseValue *= 0.95;
        }
    }
    
    // Adjust based on team profile (if pick belongs to bad team = more valuable)
    const ownerProfile = teamProfiles?.find(p => p.teamId === pick.originalTeam);
    if (ownerProfile) {
        // Rebuilding team's picks more valuable (likely high picks)
        if (ownerProfile.status === 'Rebuild') {
            baseValue *= 1.2;
        } else if (ownerProfile.status === 'Contend') {
            baseValue *= 0.8; // Contender's picks less valuable (late picks)
        }
        
        // Playoff probability affects value
        if (ownerProfile.playoffProbability < 20) {
            baseValue *= 1.15; // Unlikely to make playoffs = high pick
        } else if (ownerProfile.playoffProbability > 80) {
            baseValue *= 0.85; // Likely to make playoffs = low pick
        }
    }
    
    // Future picks slightly less valuable
    if (pick.year > currentYear) {
        baseValue *= 0.9; // 10% discount for future picks
    }
    
    return Math.round(baseValue);
};

/**
 * Get projected draft position for a pick based on current standings
 */
const getProjectedDraftPosition = (teamId, round, standings) => {
    // Sort teams by points (worst to best)
    const sortedStandings = [...standings].sort((a, b) => a.points - b.points);
    
    // Find team's position (1 = worst, 32 = best)
    const position = sortedStandings.findIndex(s => s.teamId === teamId) + 1;
    
    // For round 1, picks 1-5 are lottery (TBD)
    if (round === 1 && position <= 5) {
        return 'Lottery (1-5)';
    }
    
    // Calculate pick number in round
    const pickInRound = 33 - position; // Reverse order (worst = 32nd pick, best = 1st pick)
    const overallPick = (round - 1) * 32 + pickInRound;
    
    return `Pick #${overallPick} (${pickInRound} in Rd ${round})`;
};

/**
 * Run draft lottery for bottom 5 teams (Round 1, picks 1-5 only)
 */
const runDraftLottery = (standings) => {
    // Get bottom 5 teams by points
    const sortedStandings = [...standings].sort((a, b) => a.points - b.points);
    const bottom5 = sortedStandings.slice(0, 5);
    
    // Lottery odds (worst team has best odds)
    const odds = [
        { teamId: bottom5[0].teamId, chance: 0.40, team: TEAMS.find(t => t.id === bottom5[0].teamId) }, // Worst: 40%
        { teamId: bottom5[1].teamId, chance: 0.30, team: TEAMS.find(t => t.id === bottom5[1].teamId) }, // 2nd worst: 30%
        { teamId: bottom5[2].teamId, chance: 0.20, team: TEAMS.find(t => t.id === bottom5[2].teamId) }, // 3rd worst: 20%
        { teamId: bottom5[3].teamId, chance: 0.07, team: TEAMS.find(t => t.id === bottom5[3].teamId) }, // 4th worst: 7%
        { teamId: bottom5[4].teamId, chance: 0.03, team: TEAMS.find(t => t.id === bottom5[4].teamId) }  // 5th worst: 3%
    ];
    
    const results = [];
    const remainingTeams = [...odds];
    
    // Draw picks 1-5
    for (let pick = 1; pick <= 5; pick++) {
        // Normalize odds for remaining teams
        const totalChance = remainingTeams.reduce((sum, t) => sum + t.chance, 0);
        const normalizedOdds = remainingTeams.map(t => ({
            ...t,
            normalizedChance: t.chance / totalChance
        }));
        
        // Random draw
        let rand = Math.random();
        let winner = null;
        
        for (const team of normalizedOdds) {
            rand -= team.normalizedChance;
            if (rand <= 0) {
                winner = team;
                break;
            }
        }
        
        if (!winner) winner = normalizedOdds[0]; // Fallback
        
        results.push({
            pick: pick,
            teamId: winner.teamId,
            team: winner.team,
            originalOdds: odds.find(o => o.teamId === winner.teamId).chance
        });
        
        // Remove winner from remaining teams
        const winnerIndex = remainingTeams.findIndex(t => t.teamId === winner.teamId);
        remainingTeams.splice(winnerIndex, 1);
    }
    
    return results;
};

const generatePlayer = (position, teamId, lineNumber = 1, isFarm = false) => {
    // Generate age first
    const age = 20 + Math.floor(Math.random() * 15); // 20-34 years old
    
    // Farm players have lower base ratings
    const baseRating = isFarm ? 
        (45 + Math.random() * 25) : // Farm: 45-70 OVR
        (60 + Math.random() * 30);  // NAHL: 60-90 OVR
    
    // Initial potential calculation based on age (younger = more upside)
    let rawPotential;
    if (age <= 22) {
        rawPotential = baseRating + Math.random() * 25; // Can grow 0-25 OVR
    } else if (age <= 25) {
        rawPotential = baseRating + Math.random() * 15; // Can grow 0-15 OVR
    } else if (age <= 28) {
        rawPotential = baseRating + Math.random() * 8; // Can grow 0-8 OVR
    } else if (age <= 30) {
        rawPotential = baseRating + Math.random() * 3; // Minimal growth
    } else {
        rawPotential = baseRating; // No growth potential for 31+
    }
    
    const potential = Math.round(rawPotential);
    
    const baseStats = {
        gamesPlayed: 0, 
        goals: 0, 
        assists: 0, 
        points: 0,
        plusMinus: 0,
        pim: 0,
        shots: 0,
        timeOnIce: 0,
        // Power Play stats
        ppGoals: 0,
        ppAssists: 0,
        ppPoints: 0,
        // Shorthanded stats
        shGoals: 0,
        shAssists: 0,
        shPoints: 0,
        // ADVANCED STATS
        // Possession metrics
        corsiFor: 0,        // Shot attempts for while player is on ice
        corsiAgainst: 0,    // Shot attempts against while player is on ice
        corsiPercent: 0,    // CF / (CF + CA) * 100
        fenwickFor: 0,      // Unblocked shot attempts for
        fenwickAgainst: 0,  // Unblocked shot attempts against
        fenwickPercent: 0,  // FF / (FF + FA) * 100
        // Physical play
        hits: 0,
        blockedShots: 0,
        // Puck skills
        takeaways: 0,
        giveaways: 0,
        // Faceoffs (for centers)
        faceoffWins: 0,
        faceoffLosses: 0,
        faceoffPercent: 0
    };
    
    // Add goalie-specific stats
    if (position === 'G') {
        baseStats.wins = 0;
        baseStats.losses = 0;
        baseStats.shutouts = 0;
        baseStats.shotsAgainst = 0;
        baseStats.saves = 0;
        baseStats.goalsAgainst = 0;
        baseStats.savePercentage = 0;
        baseStats.gaa = 0;
    }
    
    // Create separate playoff stats (starts at 0 when playoffs begin)
    const playoffStats = JSON.parse(JSON.stringify(baseStats)); // Deep copy
    
    // Determine preferred position
    let preferredPosition = position;
    if (position === 'F') {
        const positions = ['C', 'LW', 'RW'];
        preferredPosition = positions[Math.floor(Math.random() * positions.length)];
    } else if (position === 'D') {
        preferredPosition = Math.random() > 0.5 ? 'LD' : 'RD';
    }
    
    const player = {
        id: `${teamId}-${position}-${Math.random()}`,
        firstName: FIRST_NAMES[Math.floor(Math.random() * FIRST_NAMES.length)],
        lastName: LAST_NAMES[Math.floor(Math.random() * LAST_NAMES.length)],
        position,
        preferredPosition, // C, LW, RW for forwards; LD, RD for defense
        age: age, // Use pre-calculated age for potential formula
        teamId,
        nhlAffiliation: teamId <= NUM_TEAMS ? teamId : FARM_TEAMS.find(t => t.id === teamId)?.nhlAffiliation, // NAHL team they belong to
        roster: teamId <= NUM_TEAMS ? 'nhl' : 'farm', // 'nhl' = NAHL or 'farm' = NAMHL
        lineNumber,
        linePosition: null, // Specific slot: 'C', 'LW', 'RW', 'LD', 'RD'
        ppUnit: 0, // 0 = none, 1 = PP1, 2 = PP2
        pkUnit: 0, // 0 = none, 1 = PK1, 2 = PK2
        ppPosition: null, // Position on PP unit
        pkPosition: null, // Position on PK unit
        dressed: position === 'G' ? (lineNumber <= 2) : true, // Goalies: only 2 dress
        // Track original position before injury call-up
        originalLineNumber: null,
        originalLinePosition: null,
        originalDressed: null,
        isInjuryReplacement: false, // True if called up to replace injured player
        ratings: { 
            overall: Math.round(baseRating),
            potential: Math.round(potential)
        },
        stats: { ...baseStats },
        playoffStats: { ...playoffStats }, // Separate playoff stats
        milestones: [], // Track career achievements
        achievements: [], // Track awards, all-stars, league leaders
        // NEW: Streak tracking
        currentStreak: {
            type: null, // 'point' or 'scoreless'
            games: 0,
            bonus: 0 // OVR bonus from streak
        },
        injury: {
            injured: false,
            type: null,
            severity: null,
            gamesOut: 0,
            daysUntilReturn: 0,
            isCareerEnding: false
        },
        careerStats: [],
        currentSeasonStats: {
            season: 1,
            ...baseStats
        },
        contract: null // Will be generated after player is created
    };
    
    // Generate contract for NHL players only (farm players don't count against cap)
    if (!isFarm) {
        player.contract = generateContract(player);
    }
    
    return player;
};

const generateRoster = (teamId) => {
    const roster = [];
    
    // Forwards: 13 total (12 active + 1 scratch)
    // Generate 13 forwards, we'll auto-assign best 12 to lines
    const forwardPositions = ['C', 'LW', 'RW'];
    for (let i = 0; i < 13; i++) {
        const player = generatePlayer('F', teamId, 0); // Start all at line 0 (unassigned)
        roster.push(player);
    }
    
    // Defense: 7 total (6 active + 1 scratch)
    // Generate 7 defensemen, we'll auto-assign best 6 to pairs
    for (let i = 0; i < 7; i++) {
        const player = generatePlayer('D', teamId, 0); // Start all at line 0 (unassigned)
        roster.push(player);
    }
    
    // Goalies: 3 total (2 dress + 1 scratch)
    const goaliesList = [];
    for (let i = 0; i < 3; i++) {
        const goalie = generatePlayer('G', teamId, 0); // Start with lineNumber 0
        goaliesList.push(goalie);
    }
    // Sort goalies by overall and assign lineNumbers
    goaliesList.sort((a, b) => b.ratings.overall - a.ratings.overall);
    goaliesList.forEach((g, idx) => {
        g.lineNumber = idx + 1; // 1 = Starter, 2 = Backup, 3 = Third
        g.dressed = idx < 2; // Only top 2 dress
        roster.push(g);
    });
    
    // Sort by overall rating within position (best first)
    roster.sort((a, b) => {
        if (a.position !== b.position) {
            const order = { 'F': 1, 'D': 2, 'G': 3 };
            return order[a.position] - order[b.position];
        }
        return b.ratings.overall - a.ratings.overall;
    });
    
    // Auto-assign best lineup
    autoSetLineup(roster);
    
    return roster;
};

// Auto-assign best players to lines based on OVR and position preference
const autoSetLineup = (roster) => {
    // Forwards: Assign best 12 to lines
    const forwards = roster.filter(p => p.position === 'F' && !p.injury.injured).sort((a, b) => b.ratings.overall - a.ratings.overall);
    const forwardPositions = ['C', 'LW', 'RW'];
    
    // Try to match preferred positions first, then fill gaps
    const assigned = new Set();
    const lineAssignments = Array(4).fill(null).map(() => ({ C: null, LW: null, RW: null }));
    
    // First pass: Assign players to their preferred positions (best players first)
    for (let line = 0; line < FORWARD_LINES; line++) {
        for (let pos of forwardPositions) {
            const candidate = forwards.find(p => 
                !assigned.has(p.id) && 
                p.preferredPosition === pos
            );
            if (candidate) {
                lineAssignments[line][pos] = candidate;
                candidate.lineNumber = line + 1;
                candidate.linePosition = pos;
                assigned.add(candidate.id);
            }
        }
    }
    
    // Second pass: Fill remaining slots with best available players
    for (let line = 0; line < FORWARD_LINES; line++) {
        for (let pos of forwardPositions) {
            if (!lineAssignments[line][pos]) {
                const candidate = forwards.find(p => !assigned.has(p.id));
                if (candidate) {
                    lineAssignments[line][pos] = candidate;
                    candidate.lineNumber = line + 1;
                    candidate.linePosition = pos;
                    assigned.add(candidate.id);
                }
            }
        }
    }
    
    // 13th forward becomes healthy scratch (lineNumber = 0)
    forwards.forEach(f => {
        if (!assigned.has(f.id)) {
            f.lineNumber = 0;
            f.linePosition = null;
        }
    });
    
    // Defense: Assign best 6 to pairs
    const defensemen = roster.filter(p => p.position === 'D' && !p.injury.injured).sort((a, b) => b.ratings.overall - a.ratings.overall);
    const defensePositions = ['LD', 'RD'];
    const dAssigned = new Set();
    const pairAssignments = Array(3).fill(null).map(() => ({ LD: null, RD: null }));
    
    // First pass: Assign to preferred sides
    for (let pair = 0; pair < 3; pair++) {
        for (let pos of defensePositions) {
            const candidate = defensemen.find(p => 
                !dAssigned.has(p.id) && 
                p.preferredPosition === pos
            );
            if (candidate) {
                pairAssignments[pair][pos] = candidate;
                candidate.lineNumber = pair + 1;
                candidate.linePosition = pos;
                dAssigned.add(candidate.id);
            }
        }
    }
    
    // Second pass: Fill remaining slots
    for (let pair = 0; pair < 3; pair++) {
        for (let pos of defensePositions) {
            if (!pairAssignments[pair][pos]) {
                const candidate = defensemen.find(p => !dAssigned.has(p.id));
                if (candidate) {
                    pairAssignments[pair][pos] = candidate;
                    candidate.lineNumber = pair + 1;
                    candidate.linePosition = pos;
                    dAssigned.add(candidate.id);
                }
            }
        }
    }
    
    // 7th defenseman becomes healthy scratch
    defensemen.forEach(d => {
        if (!dAssigned.has(d.id)) {
            d.lineNumber = 0;
            d.linePosition = null;
        }
    });
    
    // Goalies: Dress best 2 goalies
    const goalies = roster.filter(p => p.position === 'G' && !p.injury.injured).sort((a, b) => b.ratings.overall - a.ratings.overall);
    goalies.forEach((g, idx) => {
        g.dressed = idx < 2; // Top 2 goalies dressed, rest undressed
        g.lineNumber = idx + 1; // 1 = Starter, 2 = Backup, 3 = Third
    });
    
    // Power Play Units: Assign top skaters (PP1 = top 5, PP2 = next 5)
    const activeSkaters = [...forwards.filter((p, idx) => idx < 12), ...defensemen.filter((p, idx) => idx < 6)]
        .sort((a, b) => b.ratings.overall - a.ratings.overall);
    
    activeSkaters.forEach((p, idx) => {
        if (idx < 5) {
            p.ppUnit = 1;
            if (idx < 4) {
                p.ppPosition = `PP1-F${idx + 1}`;
            } else {
                p.ppPosition = 'PP1-D1';
            }
        } else if (idx < 10) {
            p.ppUnit = 2;
            if (idx < 9) {
                p.ppPosition = `PP2-F${idx - 4}`;
            } else {
                p.ppPosition = 'PP2-D1';
            }
        } else {
            p.ppUnit = null;
            p.ppPosition = null;
        }
    });
    
    // Penalty Kill Units: Prioritize defensemen and defensive forwards (PK1 = top 4, PK2 = next 4)
    // ONLY assign PK to players who are dressed (lineNumber > 0)
    const pkCandidates = [...forwards.filter(f => f.lineNumber > 0), ...defensemen.filter(d => d.lineNumber > 0)]
        .sort((a, b) => {
            // Defensemen get priority for PK
            if (a.position === 'D' && b.position === 'F') return -1;
            if (a.position === 'F' && b.position === 'D') return 1;
            return b.ratings.overall - a.ratings.overall;
        });
    
    pkCandidates.forEach((p, idx) => {
        if (idx < 4) {
            p.pkUnit = 1;
            if (idx < 2) {
                p.pkPosition = `PK1-F${idx + 1}`;
            } else {
                p.pkPosition = `PK1-D${idx - 1}`;
            }
        } else if (idx < 8) {
            p.pkUnit = 2;
            if (idx < 6) {
                p.pkPosition = `PK2-F${idx - 3}`;
            } else {
                p.pkPosition = `PK2-D${idx - 5}`;
            }
        } else {
            p.pkUnit = null;
            p.pkPosition = null;
        }
    });
};

const generateSchedule = () => {
    // Generate 82 days where ALL 32 teams play each day (16 matchups per day)
    // Each team plays exactly 82 games (41 home, 41 away)
    
    const schedule = [];
    const teamGamesPlayed = {}; // Track how many games each team has played
    const teamHomeGames = {}; // Track home game count
    const teamAwayGames = {}; // Track away game count
    const matchupCount = {}; // Track how many times teams have played each other
    
    // Initialize tracking
    TEAMS.forEach(t => {
        teamGamesPlayed[t.id] = 0;
        teamHomeGames[t.id] = 0;
        teamAwayGames[t.id] = 0;
        matchupCount[t.id] = {};
        TEAMS.forEach(opp => {
            if (opp.id !== t.id) matchupCount[t.id][opp.id] = 0;
        });
    });
    
    // Build day-by-day schedule - ensure ALL 32 teams play each day
    for (let day = 1; day <= 82; day++) {
        const dayMatchups = [];
        const usedTeams = new Set();
        const availableTeams = TEAMS.filter(t => !usedTeams.has(t.id));
        
        // Pair up all 32 teams (16 matchups per day)
        while (availableTeams.length >= 2) {
            const team1 = availableTeams[0];
            
            // Find best opponent for team1
            let bestOpponent = null;
            let bestScore = -999999;
            
            for (let i = 1; i < availableTeams.length; i++) {
                const team2 = availableTeams[i];
                if (usedTeams.has(team2.id)) return;
                
                // Score this matchup
                let score = 0;
                
                // Prefer teams in same division (more realistic)
                if (team1.division === team2.division) score += 50;
                else if (team1.conference === team2.conference) score += 20;
                
                // Prefer teams that haven't played each other much
                const timesPlayed = matchupCount[team1.id][team2.id];
                score -= timesPlayed * 30;
                
                // Randomness for variety
                score += Math.random() * 10;
                
                if (score > bestScore) {
                    bestScore = score;
                    bestOpponent = team2;
                }
            }
            
            if (!bestOpponent) break;
            
            // Determine home/away
            let homeTeam, awayTeam;
            if (teamHomeGames[team1.id] < teamAwayGames[team1.id]) {
                // team1 needs more home games
                homeTeam = team1.id;
                awayTeam = bestOpponent.id;
            } else if (teamAwayGames[team1.id] < teamHomeGames[team1.id]) {
                // team1 needs more away games
                homeTeam = bestOpponent.id;
                awayTeam = team1.id;
            } else {
                // Equal, check opponent's needs
                if (teamHomeGames[bestOpponent.id] < teamAwayGames[bestOpponent.id]) {
                    homeTeam = bestOpponent.id;
                    awayTeam = team1.id;
                } else {
                    homeTeam = team1.id;
                    awayTeam = bestOpponent.id;
                }
            }
            
            dayMatchups.push({
                homeTeam,
                awayTeam,
                played: false,
                homeScore: 0,
                awayScore: 0,
                homeStats: null,
                awayStats: null,
                periodScoring: null
            });
            
            // Update tracking
            usedTeams.add(team1.id);
            usedTeams.add(bestOpponent.id);
            teamGamesPlayed[team1.id]++;
            teamGamesPlayed[bestOpponent.id]++;
            matchupCount[team1.id][bestOpponent.id]++;
            matchupCount[bestOpponent.id][team1.id]++;
            
            if (homeTeam === team1.id) {
                teamHomeGames[team1.id]++;
                teamAwayGames[bestOpponent.id]++;
            } else {
                teamHomeGames[bestOpponent.id]++;
                teamAwayGames[team1.id]++;
            }
            
            // Remove used teams from available list
            availableTeams.splice(availableTeams.indexOf(team1), 1);
            availableTeams.splice(availableTeams.indexOf(bestOpponent), 1);
        }
        
        schedule.push({
            day,
            matchups: dayMatchups
        });
        
        // Debug: Check if all teams played
        if (dayMatchups.length !== 16) {
            console.warn(`‚ö†Ô∏è Day ${day}: Only ${dayMatchups.length} matchups (should be 16)`);
        }
        
        // Debug: Log first day's schedule
        if (day === 1) {
            console.log(`Day 1 Schedule (${dayMatchups.length} matchups):`);
            dayMatchups.forEach(m => {
                const home = TEAMS.find(t => t.id === m.homeTeam);
                const away = TEAMS.find(t => t.id === m.awayTeam);
                if (home && away) {
                    console.log(`  ${home.city} vs ${away.city}`);
                }
            });
        }
    }
    
    console.log('=== 82-Day Schedule Generated ===');
    console.log(`Total days: ${schedule.length}`);
    console.log(`Average matchups per day: ${schedule.reduce((sum, d) => sum + d.matchups.length, 0) / schedule.length}`);
    TEAMS.forEach(t => {
        const total = teamGamesPlayed[t.id];
        const homeGames = teamHomeGames[t.id];
        const awayGames = teamAwayGames[t.id];
        if (total !== 82) {
            console.warn(`‚ùå ${t.city}: ${total} games (${homeGames}H / ${awayGames}A) - SHOULD BE 82!`);
        } else {
            console.log(`‚úì ${t.city}: ${total} games (${homeGames}H / ${awayGames}A)`);
        }
    });
    
    return schedule;
};

const getIceTime = (player) => {
    if (player.position === 'G') return 60;
    
    if (player.position === 'D') {
        if (player.lineNumber === 1) return 24 + Math.random() * 2; // 24-26 min
        if (player.lineNumber === 2) return 20 + Math.random() * 2; // 20-22 min
        return 16 + Math.random() * 2; // 16-18 min
    }
    
    // Forwards
    if (player.lineNumber === 1) return 19 + Math.random() * 3; // 19-22 min
    if (player.lineNumber === 2) return 16 + Math.random() * 2; // 16-18 min
    if (player.lineNumber === 3) return 13 + Math.random() * 2; // 13-15 min
    return 10 + Math.random() * 2; // 10-12 min
};

// NHL Penalty System
// Based on NHL data: ~6-8 penalties per game total, ~12-16 PIM per team per game
const PENALTY_TYPES = {
    // Minor penalties (2 minutes) - 85% of all penalties
    'Tripping': { minutes: 2, weight: 20, description: 'Tripping' },
    'Hooking': { minutes: 2, weight: 18, description: 'Hooking' },
    'Slashing': { minutes: 2, weight: 15, description: 'Slashing' },
    'Interference': { minutes: 2, weight: 12, description: 'Interference' },
    'High-Sticking': { minutes: 2, weight: 10, description: 'High-Sticking' },
    'Holding': { minutes: 2, weight: 8, description: 'Holding' },
    'Roughing': { minutes: 2, weight: 7, description: 'Roughing' },
    'Delay of Game': { minutes: 2, weight: 5, description: 'Delay of Game' },
    
    // Double minors (4 minutes) - 8% of penalties
    'High-Stick (Blood)': { minutes: 4, weight: 5, description: 'High-Sticking (double minor)' },
    'Roughing (Double)': { minutes: 4, weight: 3, description: 'Roughing (double minor)' },
    
    // Major penalties (5 minutes) - 5% of penalties
    'Fighting': { minutes: 5, weight: 3, description: 'Fighting' },
    'Boarding': { minutes: 5, weight: 1, description: 'Boarding (major)' },
    'Charging': { minutes: 5, weight: 0.5, description: 'Charging (major)' },
    
    // Misconduct (10 minutes, doesn't create PP) - 1.5% of penalties
    'Misconduct': { minutes: 10, weight: 1, description: 'Misconduct', noAdvantage: true },
    
    // Game Misconduct (ejection + 10 min) - 0.5% of penalties
    'Game Misconduct': { minutes: 10, weight: 0.3, description: 'Game Misconduct', ejection: true, noAdvantage: true }
};

const assignPenalties = (players) => {
    // NHL average: 3-4 penalties per team per game
    const numPenalties = Math.random() < 0.3 ? 2 : Math.random() < 0.7 ? 3 : 4;
    
    const penalties = [];
    
    for (let i = 0; i < numPenalties; i++) {
        // Select penalty type by weight
        const totalWeight = Object.values(PENALTY_TYPES).reduce((sum, p) => sum + p.weight, 0);
        let rand = Math.random() * totalWeight;
        let selectedPenalty = null;
        
        for (const [name, data] of Object.entries(PENALTY_TYPES)) {
            rand -= data.weight;
            if (rand <= 0) {
                selectedPenalty = { name, ...data };
                break;
            }
        }
        
        if (!selectedPenalty) selectedPenalty = { name: 'Tripping', ...PENALTY_TYPES['Tripping'] };
        
        // Assign to a random player (weighted by position and rating)
        // Forwards get more penalties, lower rated players slightly more
        const eligiblePlayers = players.filter(p => p.position !== 'G');
        const weights = eligiblePlayers.map(p => {
            const positionFactor = p.position === 'F' ? 1.2 : 1.0; // Forwards 20% more likely
            const ratingFactor = 1.1 - (p.ratings.overall / 100) * 0.3; // Lower OVR = slightly more penalties
            const toiFactor = getIceTime(p) / 15; // More TOI = more penalty chances
            return positionFactor * ratingFactor * toiFactor;
        });
        
        const totalPlayerWeight = weights.reduce((sum, w) => sum + w, 0);
        rand = Math.random() * totalPlayerWeight;
        let culprit = eligiblePlayers[0];
        let cumulative = 0;
        
        for (let j = 0; j < eligiblePlayers.length; j++) {
            cumulative += weights[j];
            if (rand <= cumulative) {
                culprit = eligiblePlayers[j];
                break;
            }
        }
        
        penalties.push({
            player: culprit,
            penalty: selectedPenalty
        });
    }
    
    return penalties;
};
// Based on NHL data: ~400 injuries per season across 32 teams = ~12.5 per team per season
// ~0.15 injuries per game (1 injury every ~7 games)
const INJURY_TYPES = {
    'Lower Body': { weight: 35, avgDays: 12 }, // Leg, knee, ankle, groin (reduced from 14)
    'Upper Body': { weight: 30, avgDays: 8 }, // Shoulder, arm, hand, wrist (reduced from 10)
    'Concussion': { weight: 15, avgDays: 18 }, // Head injuries (reduced from 21)
    'Core': { weight: 10, avgDays: 10 }, // Back, abdomen (reduced from 12)
    'Illness': { weight: 8, avgDays: 3 }, // Flu, COVID, etc. (unchanged)
    'Facial': { weight: 2, avgDays: 5 } // Broken nose, jaw, dental (reduced from 7)
};

const checkForInjury = (player, toi) => {
    // Base injury chance: ~0.6% per game (realistic NHL rates)
    // Expected: ~12-18 injuries per team per 82-game season
    // NHL average: 350-450 man-games lost per team = 4-5 players missing significant time
    const baseChance = 0.006; // 0.6% per game base (reduced from 0.8%)
    
    // Position multiplier
    const positionMultiplier = player.position === 'G' ? 0.5 : player.position === 'F' ? 1.3 : 1.0;
    
    // TOI multiplier - scales with ice time (more ice time = more injury risk)
    const toiMultiplier = toi / 15;
    
    // Age factor - older players more injury-prone
    const ageFactor = player.age < 24 ? 0.7 : player.age > 32 ? 1.6 : 1.0;
    
    const injuryChance = baseChance * positionMultiplier * toiMultiplier * ageFactor;
    
    const roll = Math.random();
    if (roll < injuryChance) {
        // Injury occurred
        return generateInjury();
    }
    
    return null;
};

const generateInjury = () => {
    // Select injury type weighted by frequency
    const totalWeight = Object.values(INJURY_TYPES).reduce((sum, t) => sum + t.weight, 0);
    let rand = Math.random() * totalWeight;
    let injuryType = 'Lower Body';
    
    for (const [type, data] of Object.entries(INJURY_TYPES)) {
        rand -= data.weight;
        if (rand <= 0) {
            injuryType = type;
            break;
        }
    }
    
    const baseAvgDays = INJURY_TYPES[injuryType].avgDays;
    
    // Severity distribution: 80% DTD/Week, 18% Month, 1.8% Season, 0.2% career-ending
    // More minor injuries, significantly fewer devastating ones
    const severityRoll = Math.random();
    
    let severity, daysOut;
    
    if (severityRoll < 0.80) {
        // 80% chance: Day-to-Day or Week-to-Week (1-14 days / 1-6 games)
        severity = Math.random() < 0.6 ? 'Day-to-Day' : 'Week-to-Week';
        daysOut = Math.floor(1 + Math.random() * 14);
    } else if (severityRoll < 0.98) {
        // 18% chance: Month-to-Month (15-45 days / 7-20 games)
        severity = 'Month-to-Month';
        daysOut = Math.floor(15 + Math.random() * 31); // Reduced max from 46 to 31
    } else if (severityRoll < 0.998) {
        // 1.8% chance: Season-Ending (reduced from 4.5%)
        severity = 'Season-Ending';
        daysOut = 999;
    } else {
        // 0.2% chance: Career-Ending (very rare, reduced from 0.5%)
        severity = 'Career-Ending';
        daysOut = 9999;
    }
    
    return {
        injured: true,
        type: injuryType,
        severity: severity,
        gamesOut: 0,
        daysUntilReturn: daysOut,
        gamesRemaining: Math.ceil(daysOut / 2.2), // Convert days to approximate games (82 games in ~180 days)
        isCareerEnding: severity === 'Career-Ending'
    };
};

const updateInjuries = (players) => {
    players.forEach(player => {
        if (player.injury.injured && !player.injury.isCareerEnding) {
            player.injury.daysUntilReturn--;
            // Also update gamesRemaining (recalculate based on days remaining)
            player.injury.gamesRemaining = Math.max(0, Math.ceil(player.injury.daysUntilReturn / 2.2));
            
            if (player.injury.daysUntilReturn <= 0) {
                // Player has healed - clear injury
                player.injury = {
                    injured: false,
                    type: null,
                    severity: null,
                    gamesOut: 0,
                    daysUntilReturn: 0,
                    gamesRemaining: 0,
                    isCareerEnding: false
                };
                
                // Return player to their original position
                if (player.originalLineNumber !== null) {
                    // Find who's currently in their spot
                    const currentOccupant = players.find(p =>
                        p.nhlAffiliation === player.nhlAffiliation &&
                        p.roster === 'nhl' &&
                        p.position === player.position &&
                        p.lineNumber === player.originalLineNumber &&
                        p.linePosition === player.originalLinePosition &&
                        p.id !== player.id
                    );
                    
                    // Return healed player to original spot
                    if (player.position === 'G') {
                        player.dressed = player.originalDressed;
                    } else {
                        player.lineNumber = player.originalLineNumber;
                        player.linePosition = player.originalLinePosition;
                    }
                    
                    // If occupant was injury replacement from farm, send them back
                    if (currentOccupant && currentOccupant.isInjuryReplacement && currentOccupant.originalRoster === 'farm') {
                        const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === currentOccupant.nhlAffiliation);
                        if (farmTeam) {
                            currentOccupant.roster = 'farm';
                            currentOccupant.teamId = farmTeam.id;
                            currentOccupant.lineNumber = 0;
                            currentOccupant.linePosition = null;
                            currentOccupant.dressed = false;
                            currentOccupant.isInjuryReplacement = false;
                            currentOccupant.originalRoster = null;
                        }
                    } else if (currentOccupant) {
                        // If NHL player, just scratch them
                        if (currentOccupant.position === 'G') {
                            currentOccupant.dressed = false;
                        } else {
                            currentOccupant.lineNumber = 0;
                            currentOccupant.linePosition = null;
                        }
                    }
                    
                    // Clear original position tracking
                    player.originalLineNumber = null;
                    player.originalLinePosition = null;
                    player.originalDressed = null;
                }
            }
        }
    });
};

const getPlayerStatus = (player) => {
    if (!player.injury.injured) return 'Active';
    if (player.injury.isCareerEnding) return 'Retired';
    if (player.injury.severity === 'Season-Ending') return 'Out';
    if (player.injury.severity === 'Month-to-Month') return 'IR';
    if (player.injury.severity === 'Week-to-Week') return 'Out';
    return 'DTD';
};

// Call up player from farm to NHL
const callUpPlayer = (playerId) => {
    if (!gameState) return;
    
    const newPlayers = [...gameState.players];
    const player = newPlayers.find(p => p.id === playerId);
    
    if (player && player.roster === 'farm') {
        const nhlTeam = player.nhlAffiliation;
        player.roster = 'nhl';
        player.teamId = nhlTeam;
        player.lineNumber = 0; // Scratched until assigned
        player.linePosition = null;
        if (player.position === 'G') player.dressed = false;
        setGameState({ ...gameState, players: newPlayers });
    }
};

// Send down player from NHL to farm
const sendDownPlayer = (playerId) => {
    if (!gameState) return;
    
    const newPlayers = [...gameState.players];
    const player = newPlayers.find(p => p.id === playerId);
    
    if (player && player.roster === 'nhl' && !player.injury.injured) {
        const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === player.nhlAffiliation);
        if (farmTeam) {
            player.roster = 'farm';
            player.teamId = farmTeam.id;
            player.lineNumber = 0;
            player.linePosition = null;
            if (player.position === 'G') player.dressed = false;
            setGameState({ ...gameState, players: newPlayers });
        }
    }
};

// Auto-call-up replacement when player gets injured
const autoCallUpReplacement = (allPlayers, injuredPlayer) => {
    const nhlTeamId = injuredPlayer.nhlAffiliation || injuredPlayer.teamId;
    const position = injuredPlayer.position;
    
    // Store injured player's original position
    if (!injuredPlayer.originalLineNumber) {
        injuredPlayer.originalLineNumber = injuredPlayer.lineNumber;
        injuredPlayer.originalLinePosition = injuredPlayer.linePosition;
        injuredPlayer.originalDressed = injuredPlayer.dressed;
    }
    
    // First: Try to find scratched NHL player
    let replacement = allPlayers
        .filter(p => 
            p.nhlAffiliation === nhlTeamId &&
            p.roster === 'nhl' &&
            p.position === position && 
            !p.injury.injured &&
            (position === 'G' ? !p.dressed : p.lineNumber === 0)
        )
        .sort((a, b) => b.ratings.overall - a.ratings.overall)[0];
    
    // Second: If no NHL scratches, call up from farm
    if (!replacement) {
        replacement = allPlayers
            .filter(p => 
                p.nhlAffiliation === nhlTeamId &&
                p.roster === 'farm' &&
                p.position === position &&
                !p.injury.injured
            )
            .sort((a, b) => b.ratings.overall - a.ratings.overall)[0];
        
        // If calling from farm, move them to NHL roster
        if (replacement) {
            replacement.roster = 'nhl';
            replacement.teamId = nhlTeamId;
            replacement.isInjuryReplacement = true;
            // Store their original farm status
            replacement.originalLineNumber = 0; // Will return to farm
            replacement.originalRoster = 'farm';
        }
    }
    
    if (replacement) {
        // Take injured player's spot in lineup
        if (position === 'G') {
            replacement.dressed = true;
        } else {
            replacement.lineNumber = injuredPlayer.lineNumber;
            replacement.linePosition = injuredPlayer.linePosition;
        }
        
        // DON'T scratch injured player - leave them in roster but marked injured
        // They keep their line assignment so we know where to put them back
    }
};

const simulateGameResult = (homePlayers, awayPlayers, homeTeamData = null, awayTeamData = null, standings = null) => {
    // SAFETY: Validate inputs
    if (!homePlayers || !awayPlayers || homePlayers.length === 0 || awayPlayers.length === 0) {
        console.error('[ERROR] Invalid players provided to simulateGameResult');
        return {
            homeGoals: 0,
            awayGoals: 0,
            winner: 'home',
            homePlayerStats: [],
            awayPlayerStats: [],
            periodScoring: [{ home: 0, away: 0 }, { home: 0, away: 0 }, { home: 0, away: 0 }],
            scoringSummary: [],
            teamStats: { homeShots: 0, awayShots: 0, homePPOpportunities: 0, awayPPOpportunities: 0, homePPGoals: 0, awayPPGoals: 0, homeSHGoals: 0, awaySHGoals: 0 },
            penaltyLog: []
        };
    }
    
    // Filter out injured players - they can't play
    const homeInjured = homePlayers.filter(p => p.injury.injured);
    const awayInjured = awayPlayers.filter(p => p.injury.injured);
    
    let homeAvailable = homePlayers.filter(p => !p.injury.injured);
    let awayAvailable = awayPlayers.filter(p => !p.injury.injured);
    
    // Load Management / Healthy Scratches
    const homeScratched = [];
    const awayScratched = [];
    
    homeAvailable = homeAvailable.filter(p => {
        if (p.position === 'G') return true; // Goalies use different system
        
        let scratchChance = 0.01;
        if (p.age > 35) scratchChance += 0.05;
        else if (p.age > 32) scratchChance += 0.02;
        if (p.ratings.overall >= 85) scratchChance *= 0.3;
        
        const scratched = Math.random() <= scratchChance;
        if (scratched) homeScratched.push(p);
        return !scratched;
    });
    
    awayAvailable = awayAvailable.filter(p => {
        if (p.position === 'G') return true;
        let scratchChance = 0.01;
        if (p.age > 35) scratchChance += 0.05;
        else if (p.age > 32) scratchChance += 0.02;
        if (p.ratings.overall >= 85) scratchChance *= 0.3;
        
        const scratched = Math.random() <= scratchChance;
        if (scratched) awayScratched.push(p);
        return !scratched;
    });
    
    const homeForwards = homeAvailable.filter(p => p.position === 'F').sort((a, b) => b.ratings.overall - a.ratings.overall);
    const homeDefense = homeAvailable.filter(p => p.position === 'D').sort((a, b) => b.ratings.overall - a.ratings.overall);
    const homeGoalies = homeAvailable.filter(p => p.position === 'G').sort((a, b) => b.ratings.overall - a.ratings.overall);
    const awayForwards = awayAvailable.filter(p => p.position === 'F').sort((a, b) => b.ratings.overall - a.ratings.overall);
    const awayDefense = awayAvailable.filter(p => p.position === 'D').sort((a, b) => b.ratings.overall - a.ratings.overall);
    const awayGoalies = awayAvailable.filter(p => p.position === 'G').sort((a, b) => b.ratings.overall - a.ratings.overall);
    
    // NEW: Get team streaks for bonuses (if standings data provided)
    let homeTeamStreakBonus = 1.0;
    let awayTeamStreakBonus = 1.0;
    
    if (standings && homeTeamData && awayTeamData) {
        const homeStanding = standings.find(s => s.teamId === homeTeamData.id);
        const awayStanding = standings.find(s => s.teamId === awayTeamData.id);
        
        // Team streak bonuses: 5+ = +3%, 10+ = +5% (caps at 5%)
        const getTeamStreakBonus = (standing) => {
            if (!standing?.currentStreak) return 1.0;
            if (standing.currentStreak.type === 'W') {
                if (standing.currentStreak.count >= 10) return 1.05;
                if (standing.currentStreak.count >= 5) return 1.03;
            }
            if (standing.currentStreak.type === 'L') {
                if (standing.currentStreak.count >= 10) return 0.95;
                if (standing.currentStreak.count >= 5) return 0.97;
            }
            return 1.0;
        };
        
        homeTeamStreakBonus = getTeamStreakBonus(homeStanding);
        awayTeamStreakBonus = getTeamStreakBonus(awayStanding);
    }
    
    // Players who dressed for this game - use ALL available players (already filtered by lineup)
    const homeDressed = [...homeForwards, ...homeDefense, ...homeGoalies];
    const awayDressed = [...awayForwards, ...awayDefense, ...awayGoalies];
    
    // NEW: Calculate team ratings with player streak bonuses applied
    const calcEffectiveRating = (players) => {
        return players.reduce((sum, p) => {
            const baseOVR = p.ratings.overall;
            const streakBonus = p.currentStreak?.bonus || 0;
            return sum + (baseOVR + streakBonus);
        }, 0) / (players.length || 1);
    };
    
    // Calculate base team ratings with player streak bonuses
    const homeRating = calcEffectiveRating([...homeForwards, ...homeDefense]) * homeTeamStreakBonus;
    const awayRating = calcEffectiveRating([...awayForwards, ...awayDefense]) * awayTeamStreakBonus;
    
    const homeAdvantage = 3;
    const adjustedHomeRating = homeRating + homeAdvantage;
    
    // Determine total goals
    const scoringRoll = Math.random();
    let totalGoals;
    
    if (scoringRoll < 0.15) {
        totalGoals = Math.floor(Math.random() * 5);
    } else if (scoringRoll < 0.70) {
        totalGoals = 5 + Math.floor(Math.random() * 4);
    } else {
        totalGoals = 9 + Math.floor(Math.random() * 5);
    }
    
    totalGoals += Math.random() < 0.3 ? 1 : 0;
    
    // Distribute goals
    const homeChance = adjustedHomeRating / (adjustedHomeRating + awayRating);
    
    let homeGoals = 0;
    let awayGoals = 0;
    
    for (let i = 0; i < totalGoals; i++) {
        if (Math.random() < homeChance) {
            homeGoals++;
        } else {
            awayGoals++;
        }
    }
    
    // Track if game went to overtime (before we add the OT goal)
    const isOvertimeGame = (homeGoals === awayGoals);
    
    if (homeGoals === awayGoals) {
        // Game goes to overtime
        const overtimeWinner = Math.random() < homeChance ? 'home' : 'away';
        if (overtimeWinner === 'home') {
            homeGoals++;
        } else {
            awayGoals++;
        }
    }
    
    const winner = homeGoals > awayGoals ? 'home' : 'away';
    
    // Initialize per-game stats for all dressed players
    const homePlayerStats = {};
    const awayPlayerStats = {};
    
    homeDressed.forEach(p => {
        const toi = getIceTime(p);
        const toiFactor = toi / 18; // Normalize to 18 minutes
        
        homePlayerStats[p.id] = {
            player: p,
            goals: 0,
            assists: 0,
            points: 0,
            plusMinus: 0,
            pim: 0,
            shots: 0,
            toi: toi,
            // PP/PK stats
            ppGoals: 0,
            ppAssists: 0,
            shGoals: 0,
            shAssists: 0,
            // Goalie specific
            saves: 0,
            goalsAgainst: 0,
            shotsAgainst: 0,
            // ADVANCED STATS
            corsiFor: Math.floor(toiFactor * (8 + Math.random() * 4)), // ~8-12 per game
            corsiAgainst: Math.floor(toiFactor * (8 + Math.random() * 4)),
            fenwickFor: Math.floor(toiFactor * (6 + Math.random() * 3)), // ~6-9 per game
            fenwickAgainst: Math.floor(toiFactor * (6 + Math.random() * 3)),
            hits: p.position === 'D' ? Math.floor(toiFactor * (2 + Math.random() * 3)) : Math.floor(toiFactor * (1 + Math.random() * 2)),
            blockedShots: p.position === 'D' ? Math.floor(toiFactor * (1 + Math.random() * 2)) : Math.floor(toiFactor * Math.random() * 1.5),
            takeaways: Math.floor(toiFactor * (0.5 + Math.random() * 1.5)),
            giveaways: Math.floor(toiFactor * (0.5 + Math.random() * 1.5)),
            faceoffWins: p.preferredPosition === 'C' ? Math.floor(toiFactor * (5 + Math.random() * 10)) : 0,
            faceoffLosses: p.preferredPosition === 'C' ? Math.floor(toiFactor * (5 + Math.random() * 10)) : 0
        };
    });
    
    awayDressed.forEach(p => {
        const toi = getIceTime(p);
        const toiFactor = toi / 18;
        
        awayPlayerStats[p.id] = {
            player: p,
            goals: 0,
            assists: 0,
            points: 0,
            plusMinus: 0,
            pim: 0,
            shots: 0,
            toi: toi,
            // PP/PK stats
            ppGoals: 0,
            ppAssists: 0,
            shGoals: 0,
            shAssists: 0,
            saves: 0,
            goalsAgainst: 0,
            shotsAgainst: 0,
            // ADVANCED STATS
            corsiFor: Math.floor(toiFactor * (8 + Math.random() * 4)),
            corsiAgainst: Math.floor(toiFactor * (8 + Math.random() * 4)),
            fenwickFor: Math.floor(toiFactor * (6 + Math.random() * 3)),
            fenwickAgainst: Math.floor(toiFactor * (6 + Math.random() * 3)),
            hits: p.position === 'D' ? Math.floor(toiFactor * (2 + Math.random() * 3)) : Math.floor(toiFactor * (1 + Math.random() * 2)),
            blockedShots: p.position === 'D' ? Math.floor(toiFactor * (1 + Math.random() * 2)) : Math.floor(toiFactor * Math.random() * 1.5),
            takeaways: Math.floor(toiFactor * (0.5 + Math.random() * 1.5)),
            giveaways: Math.floor(toiFactor * (0.5 + Math.random() * 1.5)),
            faceoffWins: p.preferredPosition === 'C' ? Math.floor(toiFactor * (5 + Math.random() * 10)) : 0,
            faceoffLosses: p.preferredPosition === 'C' ? Math.floor(toiFactor * (5 + Math.random() * 10)) : 0
        };
    });
    
    // Assign goals and assists to HOME team and build scoring summary
    const homeSkaters = homeDressed.filter(p => p.position !== 'G');
    const homeGoalEvents = []; // Track each goal for period summary
    
    for (let i = 0; i < homeGoals; i++) {
        const goalWeights = homeSkaters.map(p => ({
            player: p,
            weight: Math.pow(p.ratings.overall / 100, 2.5) * 
                   (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                   (p.ratings.overall >= GAME_CONFIG.STAR_THRESHOLD ? 1.2 : 1.0) *
                   (p.position === 'D' ? 0.2 : 1.0)
        }));
        
        const totalWeight = goalWeights.reduce((sum, w) => sum + w.weight, 0);
        let rand = Math.random() * totalWeight;
        let scorer = goalWeights[0].player;
        
        for (const w of goalWeights) {
            rand -= w.weight;
            if (rand <= 0) {
                scorer = w.player;
                break;
            }
        }
        
        homePlayerStats[scorer.id].goals++;
        homePlayerStats[scorer.id].shots += 1 + Math.floor(Math.random() * 2);
        
        // Assign assists
        const numAssists = Math.random() < 0.03 ? 0 : Math.random() < 0.15 ? 1 : 2;
        const eligibleAssisters = homeSkaters.filter(p => p.id !== scorer.id);
        const assisters = [];
        
        for (let a = 0; a < numAssists && assisters.length < 2; a++) {
            const assistWeights = eligibleAssisters.filter(p => !assisters.includes(p)).map(p => ({
                player: p,
                weight: Math.pow(p.ratings.overall / 100, 2.5) *
                       (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                       (p.position === 'D' ? 1.1 : 1.0)
            }));
            
            if (assistWeights.length > 0) {
                const totalAssistWeight = assistWeights.reduce((sum, w) => sum + w.weight, 0);
                let assistRand = Math.random() * totalAssistWeight;
                
                for (const w of assistWeights) {
                    assistRand -= w.weight;
                    if (assistRand <= 0) {
                        assisters.push(w.player);
                        homePlayerStats[w.player.id].assists++;
                        break;
                    }
                }
            }
        }
        
        // Store goal event for period summary
        homeGoalEvents.push({
            scorer: scorer,
            assisters: assisters,
            goalNumber: i + 1
        });
    }
    
    // Assign goals and assists to AWAY team and build scoring summary
    const awaySkaters = awayDressed.filter(p => p.position !== 'G');
    const awayGoalEvents = []; // Track each goal for period summary
    
    for (let i = 0; i < awayGoals; i++) {
        const goalWeights = awaySkaters.map(p => ({
            player: p,
            weight: Math.pow(p.ratings.overall / 100, 2.5) * 
                   (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                   (p.ratings.overall >= GAME_CONFIG.STAR_THRESHOLD ? 1.2 : 1.0) *
                   (p.position === 'D' ? 0.2 : 1.0)
        }));
        
        const totalWeight = goalWeights.reduce((sum, w) => sum + w.weight, 0);
        let rand = Math.random() * totalWeight;
        let scorer = goalWeights[0].player;
        
        for (const w of goalWeights) {
            rand -= w.weight;
            if (rand <= 0) {
                scorer = w.player;
                break;
            }
        }
        
        awayPlayerStats[scorer.id].goals++;
        awayPlayerStats[scorer.id].shots += 1 + Math.floor(Math.random() * 2);
        
        const numAssists = Math.random() < 0.03 ? 0 : Math.random() < 0.15 ? 1 : 2;
        const eligibleAssisters = awaySkaters.filter(p => p.id !== scorer.id);
        const assisters = [];
        
        for (let a = 0; a < numAssists && assisters.length < 2; a++) {
            const assistWeights = eligibleAssisters.filter(p => !assisters.includes(p)).map(p => ({
                player: p,
                weight: Math.pow(p.ratings.overall / 100, 2.5) *
                       (p.lineNumber === 1 ? 1.3 : p.lineNumber === 2 ? 0.95 : 0.7) *
                       (p.position === 'D' ? 1.1 : 1.0)
            }));
            
            if (assistWeights.length > 0) {
                const totalAssistWeight = assistWeights.reduce((sum, w) => sum + w.weight, 0);
                let assistRand = Math.random() * totalAssistWeight;
                
                for (const w of assistWeights) {
                    assistRand -= w.weight;
                    if (assistRand <= 0) {
                        assisters.push(w.player);
                        awayPlayerStats[w.player.id].assists++;
                        break;
                    }
                }
            }
        }
        
        // Store goal event for period summary
        awayGoalEvents.push({
            scorer: scorer,
            assisters: assisters,
            goalNumber: i + 1
        });
    }
    
    // Calculate points and add random shots for skaters
    Object.values(homePlayerStats).forEach(stats => {
        if (stats.player.position !== 'G') {
            stats.points = stats.goals + stats.assists;
            stats.shots += Math.floor(Math.random() * 3);
            stats.plusMinus = winner === 'home' ? (Math.random() < 0.3 ? 1 : 0) : (Math.random() < 0.3 ? -1 : 0);
        }
    });
    
    Object.values(awayPlayerStats).forEach(stats => {
        if (stats.player.position !== 'G') {
            stats.points = stats.goals + stats.assists;
            stats.shots += Math.floor(Math.random() * 3);
            stats.plusMinus = winner === 'away' ? (Math.random() < 0.3 ? 1 : 0) : (Math.random() < 0.3 ? -1 : 0);
        }
    });
    
    // Goalie stats
    if (homeGoalies.length > 0) {
        const homeGoalie = homeGoalies[0];
        homePlayerStats[homeGoalie.id].goalsAgainst = awayGoals;
        homePlayerStats[homeGoalie.id].shotsAgainst = Math.floor(25 + Math.random() * 10);
        homePlayerStats[homeGoalie.id].saves = homePlayerStats[homeGoalie.id].shotsAgainst - awayGoals;
    }
    
    if (awayGoalies.length > 0) {
        const awayGoalie = awayGoalies[0];
        awayPlayerStats[awayGoalie.id].goalsAgainst = homeGoals;
        awayPlayerStats[awayGoalie.id].shotsAgainst = Math.floor(25 + Math.random() * 10);
        awayPlayerStats[awayGoalie.id].saves = awayPlayerStats[awayGoalie.id].shotsAgainst - homeGoals;
    }
    
    // Generate period-by-period scoring summary
    // Distribute goals across 3 periods realistically
    const allGoals = [];
    homeGoalEvents.forEach(g => allGoals.push({ ...g, team: 'home' }));
    awayGoalEvents.forEach(g => allGoals.push({ ...g, team: 'away' }));
    
    // Shuffle goals to randomize order
    for (let i = allGoals.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allGoals[i], allGoals[j]] = [allGoals[j], allGoals[i]];
    }
    
    // Assign to periods (weighted: 33% per period, slight variance)
    const totalGoalsInGame = homeGoals + awayGoals;
    const periods = [
        { period: 1, goals: [] },
        { period: 2, goals: [] },
        { period: 3, goals: [] }
    ];
    
    allGoals.forEach((goal, idx) => {
        const periodRoll = Math.random();
        let period;
        if (periodRoll < 0.33) period = 0;
        else if (periodRoll < 0.66) period = 1;
        else period = 2;
        
        // Ensure last period has at least one goal if game has goals
        if (idx === allGoals.length - 1 && periods[2].goals.length === 0 && totalGoalsInGame > 1) {
            period = 2;
        }
        
        periods[period].goals.push(goal);
    });
    
    // Generate scoring summary with running season totals
    // Note: We need to pass in pre-game stats to calculate running totals
    const scoringSummary = periods.map(p => ({
        period: p.period,
        goals: p.goals.map(g => ({
            team: g.team,
            scorer: {
                id: g.scorer.id,
                name: `${g.scorer.firstName} ${g.scorer.lastName}`,
                // Season totals will be calculated when displaying
            },
            assists: g.assisters.map((a, idx) => ({
                id: a.id,
                name: `${a.firstName} ${a.lastName}`,
                isPrimary: idx === 0
            }))
        }))
    }));
    
    // Calculate team stats for this game
    const homeShots = Object.values(homePlayerStats).reduce((sum, p) => sum + (p.shots || 0), 0);
    const awayShots = Object.values(awayPlayerStats).reduce((sum, p) => sum + (p.shots || 0), 0);
    
    // ==================== PENALTY & POWER PLAY SIMULATION ====================
    
    // Generate realistic penalties throughout the game
    const generatePenalties = () => {
        const penalties = [];
        
        // Average 3.2 penalties per team per game (NHL 2023-24)
        const homePenaltyCount = 2 + Math.floor(Math.random() * 3); // 2-4
        const awayPenaltyCount = 2 + Math.floor(Math.random() * 3); // 2-4
        
        // Penalty type distribution
        const getPenaltyDuration = () => {
            const roll = Math.random();
            if (roll < 0.85) return 2;  // Minor (85%)
            if (roll < 0.93) return 4;  // Double Minor (8%)
            if (roll < 0.98) return 5;  // Major (5%)
            return 10; // Misconduct (2%)
        };
        
        // Period distribution: 1st=30%, 2nd=35%, 3rd=35%
        const getPeriod = () => {
            const roll = Math.random();
            if (roll < 0.30) return 1;
            if (roll < 0.65) return 2;
            return 3;
        };
        
        // Generate home penalties
        for (let i = 0; i < homePenaltyCount; i++) {
            const period = getPeriod();
            const duration = getPenaltyDuration();
            penalties.push({
                team: 'home',
                period: period,
                time: Math.floor(Math.random() * 20), // Random time in period (0-19)
                duration: duration,
                player: null, // Will be assigned later
                ended: false
            });
        }
        
        // Generate away penalties
        for (let i = 0; i < awayPenaltyCount; i++) {
            const period = getPeriod();
            const duration = getPenaltyDuration();
            penalties.push({
                team: 'away',
                period: period,
                time: Math.floor(Math.random() * 20),
                duration: duration,
                player: null,
                ended: false
            });
        }
        
        // Sort penalties by game time
        penalties.sort((a, b) => {
            const timeA = (a.period - 1) * 20 + a.time;
            const timeB = (b.period - 1) * 20 + b.time;
            return timeA - timeB;
        });
        
        return penalties;
    };
    
    // Assign penalty takers (weighted by PIM tendency)
    const assignPenaltyTakers = (penalties, homeSkaters, awaySkaters) => {
        penalties.forEach(pen => {
            const skaters = pen.team === 'home' ? homeSkaters : awaySkaters;
            
            // Weight by position and aggression (simulate PIM tendency)
            const weights = skaters.map(p => {
                let weight = 1.0;
                if (p.position === 'D') weight *= 1.2; // D-men take more penalties
                if (p.ratings.overall < 75) weight *= 1.3; // Lower rated = more penalties
                return { player: p, weight };
            });
            
            const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);
            let rand = Math.random() * totalWeight;
            
            for (const w of weights) {
                rand -= w.weight;
                if (rand <= 0) {
                    pen.player = w.player;
                    break;
                }
            }
        });
    };
    
    // Get PP/PK unit players
    const getPPUnit = (players, unitNumber) => {
        return players.filter(p => p.ppUnit === unitNumber);
    };
    
    const getPKUnit = (players, unitNumber, penaltyBoxPlayers = []) => {
        // Get PK unit, excluding players in penalty box
        const pkPlayers = players.filter(p => 
            p.pkUnit === unitNumber && 
            !penaltyBoxPlayers.includes(p.id)
        );
        
        // If a PK player is in the box, replace with best available
        if (pkPlayers.length < 4) {
            const replacements = players
                .filter(p => !p.pkUnit && !penaltyBoxPlayers.includes(p.id))
                .sort((a, b) => b.ratings.overall - a.ratings.overall);
            
            while (pkPlayers.length < 4 && replacements.length > 0) {
                pkPlayers.push(replacements.shift());
            }
        }
        
        return pkPlayers;
    };
    
    // Calculate unit rating
    const getUnitRating = (players) => {
        if (players.length === 0) return 75;
        return players.reduce((sum, p) => sum + p.ratings.overall, 0) / players.length;
    };
    
    // Simulate power plays
    const penalties = generatePenalties();
    assignPenaltyTakers(penalties, [...homeForwards, ...homeDefense], [...awayForwards, ...awayDefense]);
    
    let homePPOpportunities = 0;
    let awayPPOpportunities = 0;
    let homePPGoals = 0;
    let awayPPGoals = 0;
    let homeSHGoals = 0; // Shorthanded goals
    let awaySHGoals = 0;
    
    const penaltyLog = []; // Track for game detail display
    
    penalties.forEach((pen, idx) => {
        // Check for concurrent penalties (5v3 situation)
        const checkForFiveOnThree = () => {
            // Look for overlapping penalty within 2 minutes
            const penaltyTime = (pen.period - 1) * 20 + pen.time;
            return penalties.some((other, otherIdx) => {
                if (otherIdx === idx || other.team !== pen.team || other.ended) return false;
                const otherTime = (other.period - 1) * 20 + other.time;
                const timeDiff = Math.abs(penaltyTime - otherTime);
                return timeDiff < 2 && timeDiff > 0;
            });
        };
        
        const isFiveOnThree = checkForFiveOnThree();
        
        // Determine which team gets PP
        if (pen.team === 'home') {
            // Away gets power play
            awayPPOpportunities++;
            
            // Get PP and PK units
            const ppUnit = Math.random() < 0.7 ? 1 : 2; // PP1 70%, PP2 30%
            const pkUnit = Math.random() < 0.7 ? 1 : 2;
            
            const awayPPPlayers = getPPUnit([...awayForwards, ...awayDefense], ppUnit);
            const homePKPlayers = getPKUnit([...homeForwards, ...homeDefense], pkUnit, [pen.player?.id]);
            
            // Calculate success rate
            const ppRating = getUnitRating(awayPPPlayers);
            const pkRating = getUnitRating(homePKPlayers);
            
            // Base success rates: 5v4 = 20%, 5v3 = 40%
            const baseSuccess = isFiveOnThree ? 0.40 : 0.20;
            const successRate = baseSuccess * (ppRating / pkRating) * (ppRating / 80); // Normalize around 80 OVR
            
            // Simulate PP
            if (Math.random() < successRate) {
                awayPPGoals++;
                
                // Attribute goal to PP player (weighted by rating)
                if (awayPPPlayers.length > 0) {
                    const weights = awayPPPlayers.map(p => ({
                        player: p,
                        weight: Math.pow(p.ratings.overall / 100, 2)
                    }));
                    const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);
                    let rand = Math.random() * totalWeight;
                    
                    for (const w of weights) {
                        rand -= w.weight;
                        if (rand <= 0 && homePlayerStats[w.player.id]) {
                            homePlayerStats[w.player.id].ppGoals = (homePlayerStats[w.player.id].ppGoals || 0) + 1;
                            break;
                        }
                    }
                }
                
                // Minor penalties end on goal (unless 5v3)
                if (pen.duration === 2 && !isFiveOnThree) {
                    pen.ended = true;
                }
            }
            
            // Small chance of shorthanded goal (~3%)
            if (Math.random() < 0.03) {
                homeSHGoals++;
                
                // Attribute to PK player
                if (homePKPlayers.length > 0) {
                    const shScorer = homePKPlayers[Math.floor(Math.random() * homePKPlayers.length)];
                    if (homePlayerStats[shScorer.id]) {
                        homePlayerStats[shScorer.id].shGoals = (homePlayerStats[shScorer.id].shGoals || 0) + 1;
                    }
                }
            }
            
        } else {
            // Home gets power play (mirror logic)
            homePPOpportunities++;
            
            const ppUnit = Math.random() < 0.7 ? 1 : 2;
            const pkUnit = Math.random() < 0.7 ? 1 : 2;
            
            const homePPPlayers = getPPUnit([...homeForwards, ...homeDefense], ppUnit);
            const awayPKPlayers = getPKUnit([...awayForwards, ...awayDefense], pkUnit, [pen.player?.id]);
            
            const ppRating = getUnitRating(homePPPlayers);
            const pkRating = getUnitRating(awayPKPlayers);
            
            const baseSuccess = isFiveOnThree ? 0.40 : 0.20;
            const successRate = baseSuccess * (ppRating / pkRating) * (ppRating / 80);
            
            if (Math.random() < successRate) {
                homePPGoals++;
                
                if (homePPPlayers.length > 0) {
                    const weights = homePPPlayers.map(p => ({
                        player: p,
                        weight: Math.pow(p.ratings.overall / 100, 2)
                    }));
                    const totalWeight = weights.reduce((sum, w) => sum + w.weight, 0);
                    let rand = Math.random() * totalWeight;
                    
                    for (const w of weights) {
                        rand -= w.weight;
                        if (rand <= 0 && homePlayerStats[w.player.id]) {
                            homePlayerStats[w.player.id].ppGoals = (homePlayerStats[w.player.id].ppGoals || 0) + 1;
                            break;
                        }
                    }
                }
                
                if (pen.duration === 2 && !isFiveOnThree) {
                    pen.ended = true;
                }
            }
            
            if (Math.random() < 0.03) {
                awaySHGoals++;
                
                if (awayPKPlayers.length > 0) {
                    const shScorer = awayPKPlayers[Math.floor(Math.random() * awayPKPlayers.length)];
                    if (awayPlayerStats[shScorer.id]) {
                        awayPlayerStats[shScorer.id].shGoals = (awayPlayerStats[shScorer.id].shGoals || 0) + 1;
                    }
                }
            }
        }
        
        // Add to penalty log for game detail
        penaltyLog.push({
            period: pen.period,
            time: pen.time,
            team: pen.team,
            player: pen.player ? `${pen.player.firstName} ${pen.player.lastName}` : 'Unknown',
            duration: pen.duration,
            type: pen.duration === 2 ? 'Minor' : 
                  pen.duration === 4 ? 'Double Minor' :
                  pen.duration === 5 ? 'Major' : 'Misconduct'
        });
    });
    
    // ==================== END PENALTY SIMULATION ====================
    
    return { 
        winner, 
        homeGoals, 
        awayGoals,
        isOvertimeGame, // NEW: Track if game went to OT
        homePlayers: homeForwards.slice(0, 15),
        awayPlayers: awayForwards.slice(0, 15),
        homeDefense: homeDefense.slice(0, 6),
        awayDefense: awayDefense.slice(0, 6),
        // NEW: Per-game stats
        homePlayerStats: Object.values(homePlayerStats),
        awayPlayerStats: Object.values(awayPlayerStats),
        homeInjured,
        awayInjured,
        homeScratched,
        awayScratched,
        // NEW: Period-by-period scoring summary
        scoringSummary: scoringSummary,
        // NEW: Team stats for this game
        teamStats: {
            homeShots,
            awayShots,
            homePPOpportunities,
            awayPPOpportunities,
            homePPGoals,
            awayPPGoals,
            homeSHGoals,
            awaySHGoals
        },
        // NEW: Penalty log
        penaltyLog: penaltyLog
    };
};

const updatePlayerStats = (player, isWinner, goals) => {
    const toi = getIceTime(player);
    player.stats.timeOnIce += toi;
    player.stats.gamesPlayed++;
    
    if (player.position === 'G') return;
    
    // Target scoring rates for 82 game season:
    // Elite (90+ OVR, 1st line): ~1.4 pts/game = 115 pts/season (50G, 65A)
    // Star (85+ OVR, 1st line): ~1.0 pts/game = 82 pts/season (35G, 47A)
    // Good (80-84 OVR, 1st/2nd line): ~0.85 pts/game = 70 pts/season (28G, 42A)
    // Average (70-79 OVR, 2nd/3rd line): ~0.5 pts/game = 41 pts/season (15G, 26A)
    // Below avg (60-69 OVR, 3rd/4th line): ~0.25 pts/game = 20 pts/season (7G, 13A)
    
    const ratingFactor = Math.pow(player.ratings.overall / 100, 2.5);
    const toiFactor = toi / 18;
    const lineMultiplier = player.lineNumber === 1 ? 1.3 : player.lineNumber === 2 ? 0.95 : player.lineNumber === 3 ? 0.7 : 0.5;
    
    // Elite bonus for 90+ rated players
    const eliteBonus = player.ratings.overall >= 90 ? 1.2 : 1.0;
    
    // Defense have much lower scoring rates
    const positionMultiplier = player.position === 'D' ? 0.25 : 1.0;
    
    // MUCH higher goal and assist chances to match NHL scoring
    const baseGoalChance = ratingFactor * toiFactor * lineMultiplier * positionMultiplier * eliteBonus * 0.55;
    const baseAssistChance = ratingFactor * toiFactor * lineMultiplier * eliteBonus * 0.85;
    
    // Goals
    if (Math.random() < baseGoalChance) {
        player.stats.goals++;
    }
    
    // Assists (can get assist even if scored)
    if (Math.random() < baseAssistChance) {
        player.stats.assists++;
    }
    
    // Multi-point games for good players
    if (player.ratings.overall >= 85) {
        // Top players get multi-point games ~20% of the time
        if (Math.random() < 0.20) {
            if (Math.random() < 0.4 && player.position === 'F') {
                player.stats.goals++;
            } else {
                player.stats.assists++;
            }
        }
    } else if (player.ratings.overall >= 75) {
        // Good players get multi-point games ~10% of the time
        if (Math.random() < 0.10) {
            if (Math.random() < 0.4 && player.position === 'F') {
                player.stats.goals++;
            } else {
                player.stats.assists++;
            }
        }
    }
    
    // Points = Goals + Assists
    player.stats.points = player.stats.goals + player.stats.assists;
    
    // Shots on goal - 2-4 per game
    const shotChance = toiFactor * 0.25;
    const shotsThisGame = Math.floor(Math.random() * 3) + (Math.random() < shotChance ? 2 : 1);
    player.stats.shots += player.position === 'D' ? Math.floor(shotsThisGame * 0.7) : shotsThisGame;
    
    // Plus/minus
    const pmBase = isWinner ? 1 : -1;
    if (Math.random() < 0.3) {
        player.stats.plusMinus += pmBase;
    }
    
    // Penalty minutes
    if (Math.random() < 0.08) {
        player.stats.pim += 2;
    }
};

// Bracket View Component
function BracketView({ playoffState, TEAMS }) {
    // Build history object that shows ALL rounds including current round's LIVE scores
    const history = {
        eastRound1: playoffState.history?.eastRound1 || (playoffState.round === 1 ? playoffState.eastMatchups : []),
        westRound1: playoffState.history?.westRound1 || (playoffState.round === 1 ? playoffState.westMatchups : []),
        eastRound2: playoffState.history?.eastRound2 || (playoffState.round === 2 ? playoffState.eastMatchups : []),
        westRound2: playoffState.history?.westRound2 || (playoffState.round === 2 ? playoffState.westMatchups : []),
        eastRound3: playoffState.history?.eastRound3 || (playoffState.round === 3 ? playoffState.eastMatchups : []),
        westRound3: playoffState.history?.westRound3 || (playoffState.round === 3 ? playoffState.westMatchups : []),
        final: playoffState.history?.final || (playoffState.round === 4 ? playoffState.finalMatchup : null)
    };
    
    // Override history with CURRENT round's live data to show real-time updates
    if (playoffState.round === 1) {
        history.eastRound1 = playoffState.eastMatchups;
        history.westRound1 = playoffState.westMatchups;
    } else if (playoffState.round === 2) {
        history.eastRound2 = playoffState.eastMatchups;
        history.westRound2 = playoffState.westMatchups;
    } else if (playoffState.round === 3) {
        history.eastRound3 = playoffState.eastMatchups;
        history.westRound3 = playoffState.westMatchups;
    } else if (playoffState.round === 4) {
        history.final = playoffState.finalMatchup;
    }
    
    const getWinner = (matchup) => {
        if (!matchup) return null;
        if (matchup.homeWins >= 4) return matchup.home;
        if (matchup.awayWins >= 4) return matchup.away;
        return null;
    };
    
    const renderMatchup = (matchup, isGrayedOut = false) => {
        if (!matchup) {
            if (isGrayedOut) {
                return (
                    <div style={{ 
                        padding: '0.75rem', 
                        background: 'rgba(30, 58, 138, 0.1)', 
                        borderRadius: '0.375rem',
                        border: '1px dashed rgba(100, 116, 139, 0.3)',
                        marginBottom: '0.5rem'
                    }}>
                        <div style={{ color: '#64748b', fontSize: '0.875rem', textAlign: 'center' }}>TBD</div>
                    </div>
                );
            }
            return null;
        }
        
        const homeTeam = TEAMS.find(t => t.id === matchup.home);
        const awayTeam = TEAMS.find(t => t.id === matchup.away);
        const winner = getWinner(matchup);
        const isComplete = winner !== null;
        
        return (
            <div style={{ 
                padding: '0.75rem', 
                background: isComplete ? 'rgba(34, 211, 238, 0.1)' : 'rgba(30, 58, 138, 0.2)', 
                borderRadius: '0.375rem',
                border: isComplete ? '2px solid #22c55e' : '1px solid rgba(59, 130, 246, 0.3)',
                marginBottom: '0.5rem'
            }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.25rem' }}>
                    <span style={{ 
                        fontSize: '0.875rem',
                        fontWeight: winner === matchup.home ? 'bold' : 'normal',
                        color: winner === matchup.home ? '#22c55e' : '#fff'
                    }}>
                        {homeTeam.city}
                    </span>
                    <span style={{ fontSize: '1rem', fontWeight: 'bold' }}>{matchup.homeWins}</span>
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ 
                        fontSize: '0.875rem',
                        fontWeight: winner === matchup.away ? 'bold' : 'normal',
                        color: winner === matchup.away ? '#22c55e' : '#fff'
                    }}>
                        {awayTeam.city}
                    </span>
                    <span style={{ fontSize: '1rem', fontWeight: 'bold' }}>{matchup.awayWins}</span>
                </div>
            </div>
        );
    };
    
    return (
        <div style={{ overflowX: 'auto' }}>
            <div style={{ minWidth: '1200px', padding: '1rem' }}>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '1rem' }}>
                    {/* EASTERN CONFERENCE - Round 1 */}
                    <div>
                        <h4 style={{ color: '#3b82f6', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                            EAST R1
                        </h4>
                        {history.eastRound1.length > 0 ? history.eastRound1.map((m, i) => (
                            <div key={i}>{renderMatchup(m)}</div>
                        )) : (
                            <>
                                {renderMatchup(null, true)}
                                {renderMatchup(null, true)}
                                {renderMatchup(null, true)}
                                {renderMatchup(null, true)}
                            </>
                        )}
                    </div>
                    
                    {/* EASTERN CONFERENCE - Round 2 */}
                    <div>
                        <h4 style={{ color: '#3b82f6', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                            EAST R2
                        </h4>
                        <div style={{ marginTop: '3rem' }}>
                            {history.eastRound2.length > 0 ? history.eastRound2.map((m, i) => (
                                <div key={i}>{renderMatchup(m)}</div>
                            )) : (
                                <>
                                    {renderMatchup(null, true)}
                                    {renderMatchup(null, true)}
                                </>
                            )}
                        </div>
                    </div>
                    
                    {/* EASTERN CONFERENCE - Conference Finals */}
                    <div>
                        <h4 style={{ color: '#3b82f6', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                            EAST FINAL
                        </h4>
                        <div style={{ marginTop: '6rem' }}>
                            {history.eastRound3.length > 0 ? renderMatchup(history.eastRound3[0]) : renderMatchup(null, true)}
                        </div>
                    </div>
                    
                    {/* STANLEY CUP FINALS */}
                    <div>
                        <h4 style={{ color: '#fbbf24', textAlign: 'center', marginBottom: '0.75rem', fontSize: '1rem', fontWeight: 'bold' }}>
                            üèÜ CUP üèÜ
                        </h4>
                        <div style={{ marginTop: '9rem' }}>
                            {history.final ? (
                                <div style={{
                                    padding: '1rem',
                                    background: 'rgba(251, 191, 36, 0.15)',
                                    borderRadius: '0.5rem',
                                    border: '3px solid #fbbf24'
                                }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                        <span style={{ 
                                            fontWeight: history.final.homeWins >= 4 ? 'bold' : 'normal',
                                            color: history.final.homeWins >= 4 ? '#fbbf24' : '#fff'
                                        }}>
                                            {TEAMS.find(t => t.id === history.final.home)?.city}
                                        </span>
                                        <span style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>{history.final.homeWins}</span>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                        <span style={{ 
                                            fontWeight: history.final.awayWins >= 4 ? 'bold' : 'normal',
                                            color: history.final.awayWins >= 4 ? '#fbbf24' : '#fff'
                                        }}>
                                            {TEAMS.find(t => t.id === history.final.away)?.city}
                                        </span>
                                        <span style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>{history.final.awayWins}</span>
                                    </div>
                                    {(history.final.homeWins >= 4 || history.final.awayWins >= 4) && (
                                        <div style={{ 
                                            marginTop: '0.75rem', 
                                            padding: '0.5rem',
                                            background: '#fbbf24',
                                            borderRadius: '0.25rem',
                                            textAlign: 'center',
                                            color: '#0f172a',
                                            fontWeight: 'bold'
                                        }}>
                                            CHAMPION!
                                        </div>
                                    )}
                                </div>
                            ) : (
                                renderMatchup(null, true)
                            )}
                        </div>
                    </div>
                    
                    {/* WESTERN CONFERENCE - Conference Finals */}
                    <div>
                        <h4 style={{ color: '#ef4444', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                            WEST FINAL
                        </h4>
                        <div style={{ marginTop: '6rem' }}>
                            {history.westRound3.length > 0 ? renderMatchup(history.westRound3[0]) : renderMatchup(null, true)}
                        </div>
                    </div>
                    
                    {/* WESTERN CONFERENCE - Round 2 */}
                    <div>
                        <h4 style={{ color: '#ef4444', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                            WEST R2
                        </h4>
                        <div style={{ marginTop: '3rem' }}>
                            {history.westRound2.length > 0 ? history.westRound2.map((m, i) => (
                                <div key={i}>{renderMatchup(m)}</div>
                            )) : (
                                <>
                                    {renderMatchup(null, true)}
                                    {renderMatchup(null, true)}
                                </>
                            )}
                        </div>
                    </div>
                    
                    {/* WESTERN CONFERENCE - Round 1 */}
                    <div>
                        <h4 style={{ color: '#ef4444', textAlign: 'center', marginBottom: '0.75rem', fontSize: '0.9rem' }}>
                            WEST R1
                        </h4>
                        {history.westRound1.length > 0 ? history.westRound1.map((m, i) => (
                            <div key={i}>{renderMatchup(m)}</div>
                        )) : (
                            <>
                                {renderMatchup(null, true)}
                                {renderMatchup(null, true)}
                                {renderMatchup(null, true)}
                                {renderMatchup(null, true)}
                            </>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}

function HockeyGM() {
    // Analytics tracking helper
    const trackEvent = (eventName, eventParams = {}) => {
        if (typeof gtag !== 'undefined') {
            gtag('event', eventName, eventParams);
        }
    };
    
    // ==================== CONTRACT NEGOTIATION HELPERS ====================
    
    // Calculate market value salary based on player OVR
    function calculateMarketValue(player) {
        console.log('calculateMarketValue called with:', player);
        
        if (!player || !player.ratings) {
            console.log('Player or ratings missing, returning minimum');
            return SALARY_CAP.minimum;
        }
        
        const ovr = player.ratings.overall;
        console.log('Player OVR:', ovr);
        console.log('Player ID:', player.id, 'Type:', typeof player.id);
        
        // Base salary ranges by OVR tier
        let baseSalary;
        if (ovr >= 95) baseSalary = 12000000; // Superstar
        else if (ovr >= 90) baseSalary = 9500000; // Elite
        else if (ovr >= 85) baseSalary = 7000000; // Star
        else if (ovr >= 80) baseSalary = 5000000; // Top tier
        else if (ovr >= 75) baseSalary = 3500000; // Solid player
        else if (ovr >= 70) baseSalary = 2000000; // Role player
        else if (ovr >= 65) baseSalary = 1200000; // Depth
        else baseSalary = 850000; // Entry level
        
        console.log('Base salary:', baseSalary);
        
        // Add deterministic variance based on player ID (+/- 10%)
        // Convert player.id to number - it might be a string like "player_123"
        const playerId = parseInt(player.id) || 0;
        const seed = playerId % 100;
        const variance = (seed / 100 - 0.5) * 0.2;
        const salary = Math.round(baseSalary * (1 + variance) / 50000) * 50000;
        
        console.log('Player ID:', playerId, 'Seed:', seed, 'Variance:', variance, 'Final salary:', salary);
        
        const result = Math.max(SALARY_CAP.minimum, Math.min(SALARY_CAP.ceiling * 0.15, salary));
        console.log('Returning:', result);
        return result;
    }
    
    // Calculate preferred contract length based on age
    function calculatePreferredLength(player) {
        console.log('calculatePreferredLength called with:', player);
        
        if (!player) {
            console.log('No player, returning 3');
            return 3;
        }
        
        const age = player.age;
        // Convert player.id to number
        const playerId = parseInt(player.id) || 0;
        const seed = (playerId * 7) % 100;
        
        console.log('Age:', age, 'Player ID:', playerId, 'Seed:', seed);
        
        let result;
        if (age <= 23) result = 3 + Math.floor(seed / 34);
        else if (age <= 27) result = 5 + Math.floor(seed / 26);
        else if (age <= 30) result = 4 + Math.floor(seed / 34);
        else if (age <= 33) result = 2 + Math.floor(seed / 34);
        else result = 1 + Math.floor(seed / 50);
        
        console.log('Returning years:', result);
        return result;
    }
    
    // Evaluate if player will accept contract offer
    function evaluateContractOffer(player, offerSalary, offerYears) {
        const marketValue = calculateMarketValue(player);
        const preferredLength = calculatePreferredLength(player);
        
        const salaryDiff = (offerSalary - marketValue) / marketValue;
        const salarySatisfied = salaryDiff >= -0.15;
        
        const termDiff = Math.abs(offerYears - preferredLength);
        const termSatisfied = termDiff <= 2;
        
        const willAccept = salarySatisfied && termSatisfied;
        
        let likelihood;
        if (salaryDiff >= 0.05 && termDiff <= 1) likelihood = 'Very High';
        else if (salaryDiff >= -0.05 && termDiff <= 1) likelihood = 'High';
        else if (salaryDiff >= -0.10 && termDiff <= 2) likelihood = 'Medium';
        else if (salaryDiff >= -0.15 && termDiff <= 2) likelihood = 'Low';
        else likelihood = 'Very Low';
        
        return {
            willAccept,
            likelihood,
            marketValue,
            preferredLength,
            salaryDiff: salaryDiff * 100,
            termDiff
        };
    }
    
    // Calculate future cap projections
    const calculateFutureCapProjections = (players, currentYear, newContract = null) => {
        const projections = [];
        
        for (let year = 0; year < 3; year++) {
            const targetYear = currentYear + year + 1;
            let totalCommitted = 0;
            const contracts = [];
            
            players.forEach(player => {
                if (player.contract) {
                    const yearsUntilTargetYear = year + 1;
                    const yearsRemainingInTargetYear = player.contract.yearsRemaining - yearsUntilTargetYear;
                    
                    if (yearsRemainingInTargetYear >= 0) {
                        totalCommitted += player.contract.salary;
                        contracts.push({
                            playerName: `${player.firstName} ${player.lastName}`,
                            salary: player.contract.salary,
                            yearsRemaining: yearsRemainingInTargetYear
                        });
                    }
                }
            });
            
            if (newContract && year < newContract.years) {
                totalCommitted += newContract.salary;
                contracts.push({
                    playerName: newContract.playerName,
                    salary: newContract.salary,
                    yearsRemaining: newContract.years - year - 1,
                    isNew: true
                });
            }
            
            projections.push({
                year: targetYear,
                totalCommitted,
                capSpace: SALARY_CAP.ceiling - totalCommitted,
                contracts: contracts.sort((a, b) => b.salary - a.salary)
            });
        }
        
        return projections;
    };
    
    const [gameState, setGameState] = useState(null);
    const [loadingProgress, setLoadingProgress] = useState(0); // NEW: Track loading progress
    
    // Performance optimization: Create lookup maps to avoid repeated finds
    const teamLookup = useMemo(() => {
        const lookup = {};
        TEAMS.forEach(team => {
            lookup[team.id] = team;
        });
        return lookup;
    }, []);
    
    const playerLookup = useMemo(() => {
        if (!gameState?.players) return {};
        const lookup = {};
        gameState.players.forEach(player => {
            lookup[player.id] = player;
        });
        return lookup;
    }, [gameState?.players]);
    
    const [playoffState, setPlayoffState] = useState(null);
    const [seasonAwards, setSeasonAwards] = useState(null);
    const [playoffMVP, setPlayoffMVP] = useState(null);
    const [seasonSummary, setSeasonSummary] = useState(null);
    const [userTeamId, setUserTeamId] = useState(null);
    const [savedLineups, setSavedLineups] = useState([]); // Store saved line combinations
    
    // Memoized user team players (must be after userTeamId)
    const userTeamPlayers = useMemo(() => {
        if (!gameState?.players || !userTeamId) return [];
        return gameState.players.filter(p => p.teamId === userTeamId);
    }, [gameState?.players, userTeamId]);
    const [currentView, setCurrentView] = useState('teamLanding');
    const [selectedPlayoffGame, setSelectedPlayoffGame] = useState(null);
    const [seasonMode, setSeasonMode] = useState('regular'); // 'regular' or 'playoffs'
    const [playerStatMode, setPlayerStatMode] = useState('regular'); // For individual player profile
    const [playerAdvancedStats, setPlayerAdvancedStats] = useState(false); // Toggle for advanced stats
    const [standingsView, setStandingsView] = useState('division');
    const [selectedPlayer, setSelectedPlayer] = useState(null);
    const [selectedTeam, setSelectedTeam] = useState(null);
    const [viewStack, setViewStack] = useState([]);
    const [isAutoSimulatingPlayoffs, setIsAutoSimulatingPlayoffs] = useState(false);
    const [selectedPlayerProfile, setSelectedPlayerProfile] = useState(null);
    const [showContractNegotiation, setShowContractNegotiation] = useState(false);
    const [contractOffer, setContractOffer] = useState({ salary: 0, years: 1 });
    const [selectedTeamProfile, setSelectedTeamProfile] = useState(null);
    const [selectedGame, setSelectedGame] = useState(null);
    const [selectedDate, setSelectedDate] = useState(null);
    const [gameDetailTeamTab, setGameDetailTeamTab] = useState('away'); // 'away' or 'home'
    const [teamProfileSort, setTeamProfileSort] = useState({ key: 'stats.points', direction: 'desc' });
    const [sortConfig, setSortConfig] = useState({ key: 'stats.points', direction: 'desc' });
    const [standingsSortConfig, setStandingsSortConfig] = useState({ key: 'points', direction: 'desc' });
    const [leadersSortConfig, setLeadersSortConfig] = useState({ key: 'stats.points', direction: 'desc' });
    const [injuriesSortConfig, setInjuriesSortConfig] = useState({ key: 'injury.severity', direction: 'desc' });
    const [previewTeamId, setPreviewTeamId] = useState(null); // For team selection preview
    const [isGenerating, setIsGenerating] = useState(false); // NEW: Show loading screen during generation
    const [expandedSections, setExpandedSections] = useState({ // For Team Hub page
        profile: true,
        standings: false,
        stats: false,
        roster: false
    });
    const [playerSearchQuery, setPlayerSearchQuery] = useState(''); // For quick player search
    const [scheduleFilterTeam, setScheduleFilterTeam] = useState(null); // null = user team, 'all' = all teams, teamId = specific team
    const [scheduleFilterDay, setScheduleFilterDay] = useState('all'); // 'all' or specific day number (1-82)
    const [showSettingsDropdown, setShowSettingsDropdown] = useState(false); // Settings menu dropdown
    const [dismissedNotifications, setDismissedNotifications] = useState([]); // Track dismissed header notifications
    
    // Draft lottery state
    const [lotteryRevealStep, setLotteryRevealStep] = useState(0); // 0-5 (0 = not started, 5 = all revealed)
    const [draftLotteryResults, setDraftLotteryResults] = useState(null);
    const [lotteryAnimation, setLotteryAnimation] = useState(false);
    
    // Draft state
    const [draftProspects, setDraftProspects] = useState(null);
    const [draftResults, setDraftResults] = useState([]);
    const [currentDraftPick, setCurrentDraftPick] = useState(1);
    const [draftRound, setDraftRound] = useState(1);
    const [autoPickMode, setAutoPickMode] = useState(false);
    const [showDraftReportCard, setShowDraftReportCard] = useState(false);
    const [showSeasonPreview, setShowSeasonPreview] = useState(false);
    const [seasonTransitioning, setSeasonTransitioning] = useState(false);
    const [seasonPreviewData, setSeasonPreviewData] = useState(null);
    const [draftPicksSigned, setDraftPicksSigned] = useState(false);
    
    // Free agency state
    const [freeAgents, setFreeAgents] = useState(null);
    const [selectedFreeAgent, setSelectedFreeAgent] = useState(null);
    const [offerYears, setOfferYears] = useState(1);
    const [offerSalary, setOfferSalary] = useState(1000000);
    const [signedPlayers, setSignedPlayers] = useState([]);
    const [showReportCard, setShowReportCard] = useState(false);
    
    // Contract re-signing state
    const [expiringContracts, setExpiringContracts] = useState(null);
    const [selectedResignPlayer, setSelectedResignPlayer] = useState(null);
    const [resignedPlayers, setResignedPlayers] = useState([]);
    const [skippedPlayers, setSkippedPlayers] = useState([]);
    
    // Onboarding state
    const [showWelcome, setShowWelcome] = useState(false);
    const [showTutorial, setShowTutorial] = useState(false);
    const [tutorialStep, setTutorialStep] = useState(0);
    const [contextHint, setContextHint] = useState(null);
    const [hintVisible, setHintVisible] = useState(false);
    const [dismissedHints, setDismissedHints] = useState([]);
    const [achievements, setAchievements] = useState([]);
    const [showAchievement, setShowAchievement] = useState(null);
    const [sessionStartTime, setSessionStartTime] = useState(null);
    const [showSaveBanner, setShowSaveBanner] = useState(false);
    const [isFirstTime, setIsFirstTime] = useState(true);
    
    // Simulation popup state
    const [simPopupVisible, setSimPopupVisible] = useState(false);
    const [simPopupGames, setSimPopupGames] = useState([]);
    const [simPopupDay, setSimPopupDay] = useState(1);
    const [simPopupTotalDays, setSimPopupTotalDays] = useState(1);
    const [simPopupGameDay, setSimPopupGameDay] = useState(1); // Actual game day number (1-82)
    const stopSimulationRef = useRef(false);
    
    // Season notifications state
    const [seasonNotifications, setSeasonNotifications] = useState([]); // Array of notifications
    const [showTradeDeadlinePrompt, setShowTradeDeadlinePrompt] = useState(false);
    const tradeDeadlinePromptShownRef = useRef(false);
    const [tradeDeadlineWarningShown, setTradeDeadlineWarningShown] = useState(false);

    // Trade view state
    const [mySelectedPlayers, setMySelectedPlayers] = useState([]);
    const [theirSelectedPlayers, setTheirSelectedPlayers] = useState([]);
    const [mySelectedPicks, setMySelectedPicks] = useState([]);
    const [theirSelectedPicks, setTheirSelectedPicks] = useState([]);
    const [tradePartnerTeamId, setTradePartnerTeamId] = useState(null);
    const [tradeSortConfig, setTradeSortConfig] = useState({ key: 'ratings.overall', direction: 'desc' });
    const [tradeMessage, setTradeMessage] = useState(null);
    const [tradeViewTab, setTradeViewTab] = useState('your'); // 'your', 'their', 'summary'
    const [tradePositionFilter, setTradePositionFilter] = useState('all'); // 'all', 'F', 'D', 'G', 'picks'
    const [tradeShowStarsOnly, setTradeShowStarsOnly] = useState(false);
    const [tradeShowYouthOnly, setTradeShowYouthOnly] = useState(false);
    const [showAddPlayerModal, setShowAddPlayerModal] = useState(null); // 'my' or 'their' or null
    const [showAddPickModal, setShowAddPickModal] = useState(null); // 'my' or 'their' or null
    const [modalPositionFilter, setModalPositionFilter] = useState('all');
    const [modalTempSelections, setModalTempSelections] = useState([]);

    // PERFORMANCE OPTIMIZATION: Create lookup maps for O(1) access
    const teamsMap = useMemo(() => {
        const map = new Map();
        TEAMS.forEach(team => map.set(team.id, team));
        return map;
    }, []); // TEAMS array never changes

    const farmTeamsMap = useMemo(() => {
        const map = new Map();
        FARM_TEAMS.forEach(team => map.set(team.id, team));
        return map;
    }, []); // FARM_TEAMS array never changes

    // PERFORMANCE OPTIMIZATION: Memoize filtered player lists
    const nhlPlayers = useMemo(() => {
        if (!gameState?.players) return [];
        return gameState.players.filter(p => p.roster === 'nhl');
    }, [gameState?.players]);

    const farmPlayers = useMemo(() => {
        if (!gameState?.players) return [];
        return gameState.players.filter(p => p.roster === 'farm');
    }, [gameState?.players]);

    const userRoster = useMemo(() => {
        if (!gameState?.players || !userTeamId) return [];
        return gameState.players.filter(p => p.teamId === userTeamId && p.roster === 'nhl');
    }, [gameState?.players, userTeamId]);

    const injuredPlayers = useMemo(() => {
        if (!gameState?.players) return [];
        return gameState.players.filter(p => p.injury.injured && p.roster === 'nhl');
    }, [gameState?.players]);

    // Helper function for fast team lookup
    const getTeam = useCallback((teamId) => {
        return teamsMap.get(teamId);
    }, [teamsMap]);

    const getFarmTeam = useCallback((teamId) => {
        return farmTeamsMap.get(teamId);
    }, [farmTeamsMap]);

    const handleSort = (key) => {
        const direction = sortConfig.key === key && sortConfig.direction === 'desc' ? 'asc' : 'desc';
        setSortConfig({ key, direction });
    };

    const sortData = (data, key, direction) => {
        return [...data].sort((a, b) => {
            let aVal = a;
            let bVal = b;
            
            // Handle nested properties like stats.points
            const keys = key.split('.');
            for (const k of keys) {
                aVal = aVal?.[k];
                bVal = bVal?.[k];
            }
            
            if (typeof aVal === 'number' && typeof bVal === 'number') {
                return direction === 'desc' ? bVal - aVal : aVal - bVal;
            }
            
            if (typeof aVal === 'string' && typeof bVal === 'string') {
                return direction === 'desc' ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
            }
            
            return 0;
        });
    };

    // Helper to create sortable header
    const SortableHeader = ({ label, sortKey, currentSort, onSort, className = "text-center" }) => {
        const isActive = currentSort.key === sortKey;
        return (
            <th 
                className={className}
                style={{ cursor: 'pointer', userSelect: 'none' }}
                onClick={() => {
                    const dir = isActive && currentSort.direction === 'desc' ? 'asc' : 'desc';
                    onSort({ key: sortKey, direction: dir });
                }}
            >
                {label} {isActive && (currentSort.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
            </th>
        );
    };

    const navigateTo = (view, data = null) => {
        setViewStack([...viewStack, { view: currentView, data: { selectedPlayerProfile, selectedTeamProfile, selectedGame, selectedPlayoffGame } }]);
        setCurrentView(view);
        if (view === 'playerProfile') setSelectedPlayerProfile(enrichPlayerWithCareerStats(data));
        if (view === 'teamProfile') setSelectedTeamProfile(data);
        if (view === 'gameDetail') setSelectedGame(data);
        if (view === 'playoffGameStats') setSelectedPlayoffGame(data);
    };
    
    const clearAndNavigate = (view) => {
        setViewStack([]); // Clear navigation history
        setCurrentView(view);
        // Clear any selected items
        setSelectedPlayerProfile(null);
        setSelectedTeamProfile(null);
        setSelectedGame(null);
        setSelectedPlayoffGame(null);
    };

    const goBack = () => {
        if (viewStack.length === 0) return;
        const previous = viewStack[viewStack.length - 1];
        setViewStack(viewStack.slice(0, -1));
        setCurrentView(previous.view);
        setSelectedPlayerProfile(previous.data.selectedPlayerProfile);
        setSelectedTeamProfile(previous.data.selectedTeamProfile);
        setSelectedGame(previous.data.selectedGame);
        setSelectedPlayoffGame(previous.data.selectedPlayoffGame);
    };

    // Lazy-load farm team rosters on first access
    const ensureFarmTeamExists = (farmTeamId) => {
        if (!gameState) return;
        
        // Check if this farm team already has players
        const existingPlayers = gameState.players.filter(p => p.teamId === farmTeamId);
        if (existingPlayers.length > 0) return; // Already generated
        
        // Generate farm roster
        const seed = farmTeamId * 54321;
        const rng = seededRandom(seed);
        const originalRandom = Math.random;
        Math.random = rng;
        
        try {
            const farmRoster = [];
            // 13 Forwards
            for (let i = 0; i < 13; i++) {
                farmRoster.push(generatePlayer('F', farmTeamId, 0, true));
            }
            // 7 Defense
            for (let i = 0; i < 7; i++) {
                farmRoster.push(generatePlayer('D', farmTeamId, 0, true));
            }
            // 3 Goalies
            for (let i = 0; i < 3; i++) {
                const goalie = generatePlayer('G', farmTeamId, i + 1, true);
                goalie.dressed = false;
                farmRoster.push(goalie);
            }
            
            // Add to game state
            setGameState(prevState => ({
                ...prevState,
                players: [...prevState.players, ...farmRoster]
            }));
        } finally {
            Math.random = originalRandom;
        }
    };

    const initGame = async (teamId) => {
        setLoadingProgress(10); // Starting
        await new Promise(resolve => setTimeout(resolve, 10)); // Minimal delay
        
        const allPlayers = [];
        
        // Generate NHL rosters with seeded random for consistency
        let teamCount = 0;
        for (const team of TEAMS) {
            const seed = team.id * 12345;
            const rng = seededRandom(seed);
            const originalRandom = Math.random;
            Math.random = rng;
            
            try {
                allPlayers.push(...generateRoster(team.id));
            } finally {
                Math.random = originalRandom;
            }
            
            teamCount++;
            if (teamCount % 8 === 0) {
                setLoadingProgress(10 + (teamCount / TEAMS.length) * 50); // 10-60%
                await new Promise(resolve => setTimeout(resolve, 0)); // Just yield control
            }
        }
        
        setLoadingProgress(60); // NHL teams done
        
        // Skip farm team generation at startup - generate on-demand instead
        // This cuts initial load time in half!
        
        const schedule = generateSchedule();
        
        setLoadingProgress(75); // Schedule done
        await new Promise(resolve => setTimeout(resolve, 0));
        
        // 82-day season system - each season is a calendar year
        const currentYear = new Date().getFullYear();

        const newGameState = {
            players: allPlayers,
            standings: TEAMS.map(t => ({ 
                teamId: t.id, 
                wins: 0, 
                losses: 0, 
                otLosses: 0,
                points: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                home: { wins: 0, losses: 0 },
                away: { wins: 0, losses: 0 },
                // NEW: Streak tracking
                currentStreak: { type: null, count: 0 }, // 'W', 'L', 'OTL'
                // Team stats for analytics
                teamStats: {
                    gamesPlayed: 0,
                    shots: 0,
                    shotsAgainst: 0,
                    ppOpportunities: 0,
                    ppGoals: 0,
                    pkOpportunities: 0, 
                    pkGoalsAgainst: 0
                }
            })),
            // Head-to-head records: { "1vs2": { team1Wins: 0, team2Wins: 0, ties: 0 }, ... }
            headToHead: {},
            schedule: schedule,
            currentDay: 1, // Current day (1-82)
            season: 1,
            year: currentYear, // Season 1 = 2025, Season 2 = 2026, etc.
            lastGameDay: null,
            lastGameTeams: [],
            // NEW: Season goals
            seasonGoal: null, // Will be set by user
            // NEW: Power rankings history
            powerRankings: null, // Updated weekly (every 7 days)
            lastRankingUpdate: null,
            // NEW: Player development tracking
            playerDevelopment: {}, // { playerId: { startOVR, currentOVR, games, lastUpdate } }
            // NEW: Mid-season report generated
            midSeasonReport: null,
            // NEW: Team history tracking
            teamHistory: {
                seasons: [], // Array of completed season records
                achievements: {
                    championships: [], // Years won Stanley Cup
                    conferenceTitles: [], // Years won conference
                    divisionTitles: [], // Years won division
                    playoffAppearances: [], // Years made playoffs
                    bestRecord: null, // { season, year, wins, losses, otLosses, points }
                    bestGoalsFor: null, // { season, year, goalsFor }
                    bestGoalDiff: null // { season, year, diff }
                }
            },
            // NEW: Season history for archiving all stats
            seasonHistory: {
                // Array of objects: { season, year, playerStats, teamStandings, playoffResults }
                archivedSeasons: [],
                // Retired players with full career history
                retiredPlayers: []
            }
        };
        
        // Generate team profiles based on initial team strength
        const teamProfiles = TEAMS.map(team => {
            const teamPlayers = allPlayers.filter(p => p.teamId === team.id && p.roster === 'nhl');
            const teamOVR = Math.round(teamPlayers.reduce((sum, p) => sum + p.ratings.overall, 0) / teamPlayers.length);
            return generateTeamProfile(team.id, teamOVR);
        });
        
        newGameState.teamProfiles = teamProfiles;
        
        // Initialize draft picks (current year + next year)
        newGameState.draftPicks = generateInitialDraftPicks(currentYear);
        newGameState.lotteryResults = null; // Will be set after playoffs
        
        // NEW: Initialize player development tracking for young players (age <= 25)
        newGameState.playerDevelopment = {};
        allPlayers.forEach(p => {
            if (p.age <= 25) {
                newGameState.playerDevelopment[p.id] = {
                    startOVR: p.ratings.overall,
                    currentOVR: p.ratings.overall,
                    startPotential: p.ratings.potential,
                    growth: 0,
                    games: 0,
                    seasonStart: 1,
                    lastChecked: 1 // Day 1 of season
                };
            }
        });
        
        setLoadingProgress(90); // Team profiles done
        
        // Backfill milestones for all players at game start
        backfillMilestones(newGameState);
        
        setLoadingProgress(100); // Complete!
        
        // Track new game started
        const selectedTeam = TEAMS.find(t => t.id === teamId);
        trackEvent('game_started', {
            team: selectedTeam?.name,
            team_id: teamId,
            season: newGameState.season
        });
        
        setGameState(newGameState);
        setUserTeamId(teamId);
        setPlayoffState(null);
        setSeasonMode('regular');
        setCurrentView('teamLanding'); // Start on Team Hub
        
        // Auto-save to localStorage
        saveGameToLocalStorage(newGameState, teamId, null, 'regular');
    };
    
    // ==========================================
    // INDEXEDDB STORAGE (replaces localStorage)
    // ==========================================
    
    const DB_NAME = 'HockeyGMDatabase';
    const DB_VERSION = 1;
    const STORE_NAME = 'saves';
    
    // Initialize IndexedDB
    const initDB = () => {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                }
            };
        });
    };
    
    // Save game to IndexedDB
    const saveGameToLocalStorage = async (gameStateToSave, userTeam, playoffStateToSave, mode) => {
        try {
            const db = await initDB();
            
            const saveData = {
                id: 'currentSave', // Single save slot for now
                gameState: gameStateToSave,
                userTeamId: userTeam,
                playoffState: playoffStateToSave,
                seasonMode: mode,
                currentView: currentView, // Save current view
                // Save draft state
                draftState: {
                    prospects: draftProspects,
                    results: draftResults,
                    currentPick: currentDraftPick,
                    round: draftRound,
                    autoPickMode: autoPickMode
                },
                // Save other UI state
                draftLotteryResults: draftLotteryResults,
                lotteryRevealStep: lotteryRevealStep,
                seasonAwards: seasonAwards,
                seasonSummary: seasonSummary,
                playoffMVP: playoffMVP,
                savedAt: new Date().toISOString()
            };
            
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            store.put(saveData);
            
            await new Promise((resolve, reject) => {
                transaction.oncomplete = () => {
                    console.log('Game saved to IndexedDB');
                    resolve();
                };
                transaction.onerror = () => reject(transaction.error);
            });
        } catch (error) {
            console.error('Failed to save game:', error);
            alert('Save failed: ' + error.message);
        }
    };
    
    // Load game from IndexedDB
    const loadGameFromLocalStorage = async () => {
        try {
            const db = await initDB();
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('currentSave');
            
            const saveData = await new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
            
            if (!saveData) return false;
            
            // Restore game state
            const restoredGameState = {
                ...saveData.gameState,
                currentDay: saveData.gameState.currentDay || 1
            };
            
            // Restore missing player fields if needed
            restoredGameState.players.forEach(p => {
                if (!p.achievements) p.achievements = [];
                if (!p.milestones) p.milestones = [];
                if (!p.currentStreak) p.currentStreak = { games: 0, bonus: 0 };
            });
            
            // MIGRATION: Fix goalie lineNumbers and dressed status for all teams
            const teams = [...new Set(restoredGameState.players.filter(p => p.position === 'G' && p.roster === 'nhl').map(p => p.teamId))];
            teams.forEach(teamId => {
                const teamGoalies = restoredGameState.players.filter(p => p.position === 'G' && p.teamId === teamId && p.roster === 'nhl');
                teamGoalies.sort((a, b) => b.ratings.overall - a.ratings.overall);
                teamGoalies.forEach((g, idx) => {
                    g.lineNumber = idx + 1;
                    g.dressed = idx < 2;
                });
            });
            
            // MIGRATION: Add teamHistory if it doesn't exist
            if (!restoredGameState.teamHistory) {
                restoredGameState.teamHistory = {
                    seasons: [],
                    achievements: {
                        championships: [],
                        conferenceTitles: [],
                        divisionTitles: [],
                        playoffAppearances: [],
                        bestRecord: null,
                        bestGoalsFor: null,
                        bestGoalDiff: null
                    }
                };
            }
            
            // MIGRATION: Initialize special teams if missing
            restoredGameState.players.forEach(player => {
                if (!player.specialTeams) {
                    player.specialTeams = {
                        powerPlay: player.position !== 'G' && player.lineNumber <= 2,
                        penaltyKill: player.position !== 'G' && player.lineNumber <= 2
                    };
                }
            });
            
            // Backfill milestones for existing players
            backfillMilestones(restoredGameState);
            
            setGameState(restoredGameState);
            setUserTeamId(saveData.userTeamId);
            setPlayoffState(saveData.playoffState);
            setSeasonMode(saveData.seasonMode);
            
            // Restore UI state
            if (saveData.currentView) {
                setCurrentView(saveData.currentView);
            } else {
                setCurrentView('teamLanding'); // Default to Team Hub for old saves
            }
            
            // Restore draft state
            if (saveData.draftState) {
                setDraftProspects(saveData.draftState.prospects);
                setDraftResults(saveData.draftState.results);
                setCurrentDraftPick(saveData.draftState.currentPick);
                setDraftRound(saveData.draftState.round);
                setAutoPickMode(saveData.draftState.autoPickMode || false);
            }
            
            // Restore other state
            if (saveData.draftLotteryResults) {
                setDraftLotteryResults(saveData.draftLotteryResults);
            }
            if (saveData.lotteryRevealStep !== undefined) {
                setLotteryRevealStep(saveData.lotteryRevealStep);
            }
            if (saveData.seasonAwards) {
                setSeasonAwards(saveData.seasonAwards);
            }
            if (saveData.seasonSummary) {
                setSeasonSummary(saveData.seasonSummary);
            }
            if (saveData.playoffMVP) {
                setPlayoffMVP(saveData.playoffMVP);
            }
            
            // Save the updated game state with backfilled milestones
            await saveGameToLocalStorage(restoredGameState, saveData.userTeamId, saveData.playoffState, saveData.seasonMode);
            
            console.log('Game loaded from IndexedDB');
            return true;
        } catch (error) {
            console.error('Failed to load game:', error);
            return false;
        }
    };
    
    // Delete save from IndexedDB
    const deleteSave = async () => {
        if (confirm('Are you sure you want to delete your saved game? This cannot be undone.')) {
            try {
                const db = await initDB();
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.delete('currentSave');
                
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = () => reject(transaction.error);
                });
                
                setGameState(null);
                setUserTeamId(null);
                setPlayoffState(null);
                setSeasonMode('regular');
                setSeasonAwards(null); // Reset awards when starting new game
                alert('Save deleted. Start a new game to continue.');
            } catch (error) {
                console.error('Failed to delete save:', error);
                alert('Failed to delete save: ' + error.message);
            }
        }
    };
    
    // Auto-load on component mount
    React.useEffect(() => {
        const loaded = loadGameFromLocalStorage();
        if (loaded) {
            console.log('Previous game loaded automatically');
            setIsFirstTime(false);
        } else {
            // No save found - check if first time ever
            const hasSeenWelcome = localStorage.getItem('hockeyGM_hasSeenWelcome');
            if (!hasSeenWelcome) {
                setShowWelcome(true);
                setIsFirstTime(true);
            }
        }
        
        // Start session timer
        setSessionStartTime(Date.now());
        
        // Load dismissed hints from localStorage
        const dismissed = localStorage.getItem('hockeyGM_dismissedHints');
        if (dismissed) {
            setDismissedHints(JSON.parse(dismissed));
        }
        
        // Load achievements
        const saved = localStorage.getItem('hockeyGM_achievements');
        if (saved) {
            setAchievements(JSON.parse(saved));
        }
    }, []);
    
    // Auto-save whenever game state changes
    React.useEffect(() => {
        if (gameState && userTeamId) {
            saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
        }
    }, [gameState, playoffState, seasonMode]);

    // Auto-simulate playoff rounds when flag is set
    React.useEffect(() => {
        if (isAutoSimulatingPlayoffs && playoffState && !playoffState.completed) {
            // Simulate one round
            simulatePlayoffSeries();
        } else if (isAutoSimulatingPlayoffs && (!playoffState || playoffState.completed)) {
            // Playoffs are done, turn off auto-simulation
            setIsAutoSimulatingPlayoffs(false);
        }
    }, [isAutoSimulatingPlayoffs, playoffState?.round, playoffState?.completed]);

    // Calculate team overall rating (weighted by ice time and role)
    const calculateTeamOverall = useCallback((teamId, players) => {
        if (!players) return 0;
        
        const teamPlayers = players.filter(p => 
            p.teamId === teamId && 
            p.roster === 'nhl' && 
            !p.injury.injured
        );
        
        if (teamPlayers.length === 0) return 0;
        
        let totalWeight = 0;
        let weightedSum = 0;
        
        // Process forwards (weight by line)
        const forwards = teamPlayers.filter(p => p.position === 'F' && p.lineNumber > 0);
        forwards.forEach(p => {
            let weight = 0;
            if (p.lineNumber === 1) weight = 1.5;      // Top line: 1.5x
            else if (p.lineNumber === 2) weight = 1.0; // 2nd line: 1.0x
            else if (p.lineNumber === 3) weight = 0.7; // 3rd line: 0.7x
            else if (p.lineNumber === FORWARD_LINES) weight = 0.4; // 4th line: 0.4x
            
            // Bonus for PP/PK specialists
            if (p.ppUnit) weight += 0.15;  // PP adds 0.15x
            if (p.pkUnit) weight += 0.10;  // PK adds 0.10x
            
            totalWeight += weight;
            weightedSum += p.ratings.overall * weight;
        });
        
        // Process defensemen (weight by pair)
        const defense = teamPlayers.filter(p => p.position === 'D' && p.lineNumber > 0);
        defense.forEach(p => {
            let weight = 0;
            if (p.lineNumber === 1) weight = 1.4;      // Top pair: 1.4x
            else if (p.lineNumber === 2) weight = 0.9; // 2nd pair: 0.9x
            else if (p.lineNumber === 3) weight = 0.5; // 3rd pair: 0.5x
            
            // Bonus for PP/PK specialists
            if (p.ppUnit) weight += 0.15;
            if (p.pkUnit) weight += 0.10;
            
            totalWeight += weight;
            weightedSum += p.ratings.overall * weight;
        });
        
        // Process goalies (dressed goalies only)
        const goalies = teamPlayers.filter(p => p.position === 'G' && p.dressed);
        goalies.forEach((p, idx) => {
            const weight = idx === 0 ? 1.2 : 0.8; // Starter: 1.2x, Backup: 0.8x
            totalWeight += weight;
            weightedSum += p.ratings.overall * weight;
        });
        
        return totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0;
    }, []);

    // Calculate all team overalls and rankings (memoized for performance)
    const teamOveralls = useMemo(() => {
        if (!gameState?.players) return [];
        
        const overalls = TEAMS.map(team => ({
            teamId: team.id,
            overall: calculateTeamOverall(team.id, gameState.players)
        }));
        
        // Sort by overall (highest first) to determine rank
        const sorted = [...overalls].sort((a, b) => b.overall - a.overall);
        
        // Add rank to each team
        return overalls.map(team => {
            const rank = sorted.findIndex(t => t.teamId === team.teamId) + 1;
            return { ...team, rank };
        });
    }, [gameState?.players, calculateTeamOverall]);

    // Helper to get team overall and rank
    const getTeamOverall = useCallback((teamId) => {
        return teamOveralls.find(t => t.teamId === teamId);
    }, [teamOveralls]);

    // Save completed season to team history
    const saveSeasonToHistory = (gameState, playoffState, userTeamId) => {
        if (!gameState || !gameState.teamHistory || !playoffState || !playoffState.completed) return;
        
        const userTeam = TEAMS.find(t => t.id === userTeamId);
        if (!userTeam) return;
        
        const userStanding = gameState.standings.find(s => s.teamId === userTeamId);
        if (!userStanding) return;
        
        // Determine division finish
        const divisionStandings = gameState.standings
            .filter(s => TEAMS.find(t => t.id === s.teamId)?.division === userTeam.division)
            .sort((a, b) => b.points - a.points);
        const divisionFinish = divisionStandings.findIndex(s => s.teamId === userTeamId) + 1;
        const wonDivision = divisionFinish === 1;
        
        // Determine conference finish
        const conferenceStandings = gameState.standings
            .filter(s => TEAMS.find(t => t.id === s.teamId)?.conference === userTeam.conference)
            .sort((a, b) => b.points - a.points);
        const conferenceFinish = conferenceStandings.findIndex(s => s.teamId === userTeamId) + 1;
        
        // Determine playoff results
        let playoffResult = null;
        let wonConference = false;
        let wonChampionship = false;
        
        if (playoffState.champion === userTeamId) {
            playoffResult = 'Won Stanley Cup';
            wonChampionship = true;
            wonConference = true;
        } else {
            // Check rounds
            if (playoffState.history?.final && (playoffState.history.final.home === userTeamId || playoffState.history.final.away === userTeamId)) {
                playoffResult = 'Lost in Stanley Cup Finals';
                wonConference = true;
            } else {
                // Simplified: check if team was in playoffs
                playoffResult = 'Made Playoffs';
            }
        }
        
        // Create season record
        const seasonRecord = {
            season: gameState.season,
            year: gameState.year,
            wins: userStanding?.wins,
            losses: userStanding?.losses,
            otLosses: userStanding?.otLosses,
            points: userStanding.points,
            goalsFor: userStanding.goalsFor,
            goalsAgainst: userStanding.goalsAgainst,
            goalDifferential: userStanding.goalsFor - userStanding.goalsAgainst,
            divisionFinish: divisionFinish,
            conferenceFinish: conferenceFinish,
            playoffResult: playoffResult,
            wonDivision: wonDivision,
            wonConference: wonConference,
            wonChampionship: wonChampionship
        };
        
        // Add to seasons array
        gameState.teamHistory.seasons.push(seasonRecord);
        
        // Update achievements
        if (wonChampionship) {
            gameState.teamHistory.achievements.championships.push(gameState.year);
        }
        if (wonConference) {
            gameState.teamHistory.achievements.conferenceTitles.push(gameState.year);
        }
        if (wonDivision) {
            gameState.teamHistory.achievements.divisionTitles.push(gameState.year);
        }
        gameState.teamHistory.achievements.playoffAppearances.push(gameState.year);
        
        // Update best records
        if (!gameState.teamHistory.achievements.bestRecord || 
            userStanding.points > gameState.teamHistory.achievements.bestRecord.points) {
            gameState.teamHistory.achievements.bestRecord = {
                season: gameState.season,
                year: gameState.year,
                wins: userStanding?.wins,
                losses: userStanding?.losses,
                otLosses: userStanding?.otLosses,
                points: userStanding.points
            };
        }
        
        if (!gameState.teamHistory.achievements.bestGoalsFor || 
            userStanding.goalsFor > gameState.teamHistory.achievements.bestGoalsFor.goalsFor) {
            gameState.teamHistory.achievements.bestGoalsFor = {
                season: gameState.season,
                year: gameState.year,
                goalsFor: userStanding.goalsFor
            };
        }
        
        const goalDiff = userStanding.goalsFor - userStanding.goalsAgainst;
        if (!gameState.teamHistory.achievements.bestGoalDiff || 
            goalDiff > gameState.teamHistory.achievements.bestGoalDiff.diff) {
            gameState.teamHistory.achievements.bestGoalDiff = {
                season: gameState.season,
                year: gameState.year,
                diff: goalDiff
            };
        }
    };

    // Auto-assign all lines for a team
    const autoSetAllLines = (players, teamId) => {
        const teamPlayers = players.filter(p => p.teamId === teamId && p.roster === 'nhl' && !p.injury.injured);
        
        // Sort by overall
        const forwards = teamPlayers.filter(p => p.position === 'F').sort((a, b) => b.ratings.overall - a.ratings.overall);
        const defense = teamPlayers.filter(p => p.position === 'D').sort((a, b) => b.ratings.overall - a.ratings.overall);
        const goalies = teamPlayers.filter(p => p.position === 'G').sort((a, b) => b.ratings.overall - a.ratings.overall);
        
        // Assign forwards to lines (top 12)
        forwards.forEach((p, idx) => {
            if (idx < 12) {
                p.lineNumber = Math.floor(idx / 3) + 1; // Lines 1-4
            } else {
                p.lineNumber = 0; // Scratch
            }
            p.linePosition = null; // Reset specific position
        });
        
        // Assign defense to pairs (top 6)
        defense.forEach((p, idx) => {
            if (idx < 6) {
                p.lineNumber = Math.floor(idx / 2) + 1; // Pairs 1-3
            } else {
                p.lineNumber = 0; // Scratch
            }
            p.linePosition = null;
        });
        
        // Assign goalies (top 2 dressed)
        goalies.forEach((p, idx) => {
            p.dressed = idx < 2;
            p.lineNumber = idx + 1; // 1 = Starter, 2 = Backup, 3 = Third
        });
        
        // Assign Power Play Units (PP1: top 5, PP2: next 5)
        const activeSkaters = [...forwards.filter((p, idx) => idx < 12), ...defense.filter((p, idx) => idx < 6)]
            .sort((a, b) => b.ratings.overall - a.ratings.overall);
        
        activeSkaters.forEach((p, idx) => {
            if (idx < 5) {
                p.ppUnit = 1;
                p.ppPosition = `PP1-${idx + 1}`;
            } else if (idx < 10) {
                p.ppUnit = 2;
                p.ppPosition = `PP2-${idx - 4}`;
            } else {
                p.ppUnit = null;
                p.ppPosition = null;
            }
        });
        
        // Assign Penalty Kill Units (PK1: top 4, PK2: next 4)
        // Prioritize defensive forwards and all defensemen for PK
        const pkCandidates = [...forwards.filter((p, idx) => idx < 12), ...defense.filter((p, idx) => idx < 6)]
            .sort((a, b) => {
                // Defensemen get priority for PK
                if (a.position === 'D' && b.position === 'F') return -1;
                if (a.position === 'F' && b.position === 'D') return 1;
                return b.ratings.overall - a.ratings.overall;
            });
        
        pkCandidates.forEach((p, idx) => {
            if (idx < 4) {
                p.pkUnit = 1;
                p.pkPosition = `PK1-${idx + 1}`;
            } else if (idx < 8) {
                p.pkUnit = 2;
                p.pkPosition = `PK2-${idx - 3}`;
            } else {
                p.pkUnit = null;
                p.pkPosition = null;
            }
        });
    };

    // Call up player from farm
    const callUpPlayer = (playerId) => {
        if (!gameState) return;
        
        const newPlayers = [...gameState.players];
        const player = newPlayers.find(p => p.id === playerId);
        
        if (player && player.roster === 'farm') {
            // Find player's NHL team
            const farmTeam = FARM_TEAMS.find(t => t.id === player.teamId);
            if (farmTeam) {
                player.teamId = farmTeam.nhlAffiliation;
                player.roster = 'nhl';
                player.lineNumber = 0; // Start as scratch
                player.linePosition = null;
                player.ppUnit = null;
                player.pkUnit = null;
                if (player.position === 'G') player.dressed = false;
                
                setGameState({ ...gameState, players: newPlayers });
                saveGameToLocalStorage({ ...gameState, players: newPlayers }, userTeamId, playoffState, seasonMode);
            }
        }
    };

    // Send down player to farm
    const sendDownPlayer = (playerId) => {
        if (!gameState) return;
        
        const newPlayers = [...gameState.players];
        const player = newPlayers.find(p => p.id === playerId);
        
        if (player && player.roster === 'nhl' && !player.injury.injured) {
            // Find team's farm affiliate
            const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === player.teamId);
            if (farmTeam) {
                player.teamId = farmTeam.id;
                player.roster = 'farm';
                player.lineNumber = 0;
                player.linePosition = null;
                player.ppUnit = null;
                player.pkUnit = null;
                if (player.position === 'G') player.dressed = false;
                
                setGameState({ ...gameState, players: newPlayers });
                saveGameToLocalStorage({ ...gameState, players: newPlayers }, userTeamId, playoffState, seasonMode);
            }
        }
    };

    // Enrich player with career stats from archived seasons
    const enrichPlayerWithCareerStats = (player) => {
        if (!gameState || !gameState.seasonHistory) {
            return { ...player, careerStats: [] };
        }
        
        const careerStats = [];
        
        // Add stats from all archived seasons
        gameState.seasonHistory.archivedSeasons.forEach(season => {
            const playerSeasonStats = season.playerStats.find(ps => ps.playerId === player.id);
            
            if (playerSeasonStats && playerSeasonStats.regularSeason) {
                // Get team name for this season
                const team = TEAMS.find(t => t.id === playerSeasonStats.teamId);
                
                // Add regular season stats
                if (playerSeasonStats.regularSeason.gamesPlayed > 0) {
                    careerStats.push({
                        year: season.year,
                        season: season.season,
                        type: 'Regular',
                        teamName: team ? `${team.city} ${team.name}` : 'Unknown',
                        ...playerSeasonStats.regularSeason,
                        // Calculate goalie-specific stats if goalie
                        savePercentage: playerSeasonStats.regularSeason.shotsAgainst > 0 
                            ? playerSeasonStats.regularSeason.saves / playerSeasonStats.regularSeason.shotsAgainst 
                            : 0,
                        gaa: playerSeasonStats.regularSeason.gamesPlayed > 0
                            ? (playerSeasonStats.regularSeason.goalsAgainst / playerSeasonStats.regularSeason.gamesPlayed)
                            : 0
                    });
                }
                
                // Add playoff stats if they exist and player played
                if (playerSeasonStats.playoffs && playerSeasonStats.playoffs.gamesPlayed > 0) {
                    careerStats.push({
                        year: season.year,
                        season: season.season,
                        type: 'Playoffs',
                        teamName: team ? `${team.city} ${team.name}` : 'Unknown',
                        ...playerSeasonStats.playoffs,
                        // Calculate goalie-specific stats if goalie
                        savePercentage: playerSeasonStats.playoffs.shotsAgainst > 0 
                            ? playerSeasonStats.playoffs.saves / playerSeasonStats.playoffs.shotsAgainst 
                            : 0,
                        gaa: playerSeasonStats.playoffs.gamesPlayed > 0
                            ? (playerSeasonStats.playoffs.goalsAgainst / playerSeasonStats.playoffs.gamesPlayed)
                            : 0
                    });
                }
            }
        });
        
        // Add current season stats if they have played any games
        const currentTeam = TEAMS.find(t => t.id === player.teamId);
        if (player.stats && player.stats.gamesPlayed > 0) {
            careerStats.push({
                year: gameState.year,
                season: gameState.season,
                type: 'Regular',
                teamName: currentTeam ? `${currentTeam.city} ${currentTeam.name}` : 'Unknown',
                ...player.stats,
                savePercentage: player.goalieStats?.shotsAgainst > 0 
                    ? player.goalieStats.saves / player.goalieStats.shotsAgainst 
                    : 0,
                gaa: player.goalieStats?.gamesPlayed > 0
                    ? (player.goalieStats.goalsAgainst / player.goalieStats.gamesPlayed)
                    : 0,
                wins: player.goalieStats?.wins || 0,
                losses: player.goalieStats?.losses || 0,
                saves: player.goalieStats?.saves || 0,
                shotsAgainst: player.goalieStats?.shotsAgainst || 0,
                goalsAgainst: player.goalieStats?.goalsAgainst || 0,
                shutouts: player.goalieStats?.shutouts || 0
            });
        }
        
        // Add current playoff stats if they exist
        if (player.playoffStats && player.playoffStats.gamesPlayed > 0) {
            careerStats.push({
                year: gameState.year,
                season: gameState.season,
                type: 'Playoffs',
                teamName: currentTeam ? `${currentTeam.city} ${currentTeam.name}` : 'Unknown',
                ...player.playoffStats,
                savePercentage: player.playoffStats.shotsAgainst > 0 
                    ? player.playoffStats.saves / player.playoffStats.shotsAgainst 
                    : 0,
                gaa: player.playoffStats.gamesPlayed > 0
                    ? (player.playoffStats.goalsAgainst / player.playoffStats.gamesPlayed)
                    : 0
            });
        }
        
        return {
            ...player,
            careerStats: careerStats
        };
    };

    // Calculate end-of-season awards
    const calculateAwards = (players, standings) => {
        const awards = {
            league: {},
            divisions: {
                Atlantic: {},
                Metropolitan: {},
                Central: {},
                Pacific: {}
            },
            allStars: {
                firstTeam: {},
                secondTeam: {},
                thirdTeam: {},
                divisions: {
                    Atlantic: {},
                    Metropolitan: {},
                    Central: {},
                    Pacific: {}
                }
            }
        };

        // Filter skaters and goalies
        const skaters = players.filter(p => p.position !== 'G' && p.stats.gamesPlayed >= 20);
        const goalies = players.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 15);
        const forwards = players.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20);
        const defensemen = players.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20);

        // LEAGUE AWARDS
        
        // League MVP (Best overall player - points, +/-, performance)
        const mvpCandidates = skaters.map(p => ({
            player: p,
            score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5) + (p.stats.gamesPlayed * 0.1)
        })).sort((a, b) => b.score - a.score);
        awards.league.mvp = mvpCandidates[0]?.player;

        // Best Goaltender (Save %, GAA, Wins)
        const goalieCandidates = goalies.map(p => ({
            player: p,
            score: (p.stats.savePercentage * 100) + ((3.0 - p.stats.gaa) * 10) + (p.stats?.wins * 0.5)
        })).sort((a, b) => b.score - a.score);
        awards.league.bestGoalie = goalieCandidates[0]?.player;

        // Best Defenseman (Points, +/-, TOI for defensemen)
        const defensemanCandidates = defensemen.map(p => ({
            player: p,
            score: (p.stats.points * 2) + (p.stats.plusMinus * 1) + ((p.stats.timeOnIce / p.stats.gamesPlayed) * 0.01)
        })).sort((a, b) => b.score - a.score);
        awards.league.bestDefenseman = defensemanCandidates[0]?.player;

        // Rookie of the Year (Best first-year player - age <= 22, high points)
        const rookies = skaters.filter(p => p.age <= 22);
        const rookieCandidates = rookies.map(p => ({
            player: p,
            score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5)
        })).sort((a, b) => b.score - a.score);
        awards.league.rookieOfYear = rookieCandidates[0]?.player;

        // Top Goal Scorer (Most goals)
        const topScorer = skaters.sort((a, b) => b.stats.goals - a.stats.goals)[0];
        awards.league.topGoalScorer = topScorer;

        // Top Point Scorer (Most points)
        const topPoints = skaters.sort((a, b) => b.stats.points - a.stats.points)[0];
        awards.league.topPointScorer = topPoints;

        // Best Defensive Forward (Best +/-, low PIM for forwards)
        const defensiveForwardCandidates = forwards.map(p => ({
            player: p,
            score: (p.stats.plusMinus * 2) - (p.stats.pim * 0.1) + (p.stats.gamesPlayed * 0.1)
        })).sort((a, b) => b.score - a.score);
        awards.league.bestDefensiveForward = defensiveForwardCandidates[0]?.player;

        // Sportsmanship Award (High points, low PIM)
        const sportsmanshipCandidates = skaters.map(p => ({
            player: p,
            score: (p.stats.points * 1.5) - (p.stats.pim * 0.5)
        })).sort((a, b) => b.score - a.score);
        awards.league.sportsmanship = sportsmanshipCandidates[0]?.player;

        // DIVISION AWARDS
        ['Atlantic', 'Metropolitan', 'Central', 'Pacific'].forEach(division => {
            const divPlayers = players.filter(p => {
                const team = TEAMS.find(t => t.id === p.teamId);
                return team?.division === division;
            });
            
            const divSkaters = divPlayers.filter(p => p.position !== 'G' && p.stats.gamesPlayed >= 20);
            const divGoalies = divPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 15);
            const divDefensemen = divPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20);
            const divRookies = divSkaters.filter(p => p.age <= 22);

            // Division MVP
            const divMvp = divSkaters.map(p => ({
                player: p,
                score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5)
            })).sort((a, b) => b.score - a.score)[0];
            awards.divisions[division].mvp = divMvp?.player;

            // Division Best Goalie
            const divGoalie = divGoalies.map(p => ({
                player: p,
                score: (p.stats.savePercentage * 100) + ((3.0 - p.stats.gaa) * 10)
            })).sort((a, b) => b.score - a.score)[0];
            awards.divisions[division].bestGoalie = divGoalie?.player;

            // Division Best Defenseman
            const divDef = divDefensemen.map(p => ({
                player: p,
                score: (p.stats.points * 2) + (p.stats.plusMinus * 1)
            })).sort((a, b) => b.score - a.score)[0];
            awards.divisions[division].bestDefenseman = divDef?.player;

            // Division Rookie
            const divRookie = divRookies.map(p => ({
                player: p,
                score: (p.stats.points * 2) + (p.stats.plusMinus * 0.5)
            })).sort((a, b) => b.score - a.score)[0];
            awards.divisions[division].rookieOfYear = divRookie?.player;

            // Division Top Scorer
            const divTopScorer = divSkaters.sort((a, b) => b.stats.points - a.stats.points)[0];
            awards.divisions[division].topScorer = divTopScorer;
        });

        // ALL-STAR TEAMS (League)
        
        // Goalies (top 3)
        const topGoalies = goalies.sort((a, b) => {
            const scoreA = (a.stats.savePercentage * 100) + ((3.0 - a.stats.gaa) * 10);
            const scoreB = (b.stats.savePercentage * 100) + ((3.0 - b.stats.gaa) * 10);
            return scoreB - scoreA;
        });
        awards.allStars.firstTeam.goalie = topGoalies[0];
        awards.allStars.secondTeam.goalie = topGoalies[1];
        awards.allStars.thirdTeam.goalie = topGoalies[2];

        // Defensemen (top 6 - 2 per team)
        const topDefensemen = defensemen.sort((a, b) => {
            const scoreA = (a.stats.points * 2) + (a.stats.plusMinus * 1);
            const scoreB = (b.stats.points * 2) + (b.stats.plusMinus * 1);
            return scoreB - scoreA;
        });
        awards.allStars.firstTeam.leftDefense = topDefensemen[0];
        awards.allStars.firstTeam.rightDefense = topDefensemen[1];
        awards.allStars.secondTeam.leftDefense = topDefensemen[2];
        awards.allStars.secondTeam.rightDefense = topDefensemen[3];
        awards.allStars.thirdTeam.leftDefense = topDefensemen[4];
        awards.allStars.thirdTeam.rightDefense = topDefensemen[5];

        // Forwards (top 9 - C, LW, RW per team)
        const topForwards = forwards.sort((a, b) => b.stats.points - a.stats.points);
        awards.allStars.firstTeam.center = topForwards[0];
        awards.allStars.firstTeam.leftWing = topForwards[1];
        awards.allStars.firstTeam.rightWing = topForwards[2];
        awards.allStars.secondTeam.center = topForwards[3];
        awards.allStars.secondTeam.leftWing = topForwards[4];
        awards.allStars.secondTeam.rightWing = topForwards[5];
        awards.allStars.thirdTeam.center = topForwards[6];
        awards.allStars.thirdTeam.leftWing = topForwards[7];
        awards.allStars.thirdTeam.rightWing = topForwards[8];

        // DIVISION ALL-STARS (top 6 per division)
        ['Atlantic', 'Metropolitan', 'Central', 'Pacific'].forEach(division => {
            const divPlayers = players.filter(p => {
                const team = TEAMS.find(t => t.id === p.teamId);
                return team?.division === division;
            });
            
            const divSkaters = divPlayers.filter(p => p.position !== 'G' && p.stats.gamesPlayed >= 20);
            const divGoalies = divPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 15);
            const divDefensemen = divPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20);
            const divForwards = divPlayers.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20);

            // Top goalie
            const divTopGoalie = divGoalies.sort((a, b) => {
                const scoreA = (a.stats.savePercentage * 100) + ((3.0 - a.stats.gaa) * 10);
                const scoreB = (b.stats.savePercentage * 100) + ((3.0 - b.stats.gaa) * 10);
                return scoreB - scoreA;
            })[0];
            awards.allStars.divisions[division].goalie = divTopGoalie;

            // Top 2 defensemen
            const divTopDef = divDefensemen.sort((a, b) => {
                const scoreA = (a.stats.points * 2) + (a.stats.plusMinus * 1);
                const scoreB = (b.stats.points * 2) + (b.stats.plusMinus * 1);
                return scoreB - scoreA;
            });
            awards.allStars.divisions[division].leftDefense = divTopDef[0];
            awards.allStars.divisions[division].rightDefense = divTopDef[1];

            // Top 3 forwards
            const divTopForwards = divForwards.sort((a, b) => b.stats.points - a.stats.points);
            awards.allStars.divisions[division].center = divTopForwards[0];
            awards.allStars.divisions[division].leftWing = divTopForwards[1];
            awards.allStars.divisions[division].rightWing = divTopForwards[2];
        });

        // AWARD ACHIEVEMENTS TO PLAYERS
        const currentYear = gameState.year; // Use year from gameState
        
        // Award trophies
        if (awards.league.mvp && awards.league.mvp.achievements) {
            awards.league.mvp.achievements.push({
                type: 'award',
                award: 'Hart Trophy',
                year: currentYear,
                icon: 'üèÜ'
            });
        }
        if (awards.league.bestGoalie && awards.league.bestGoalie.achievements) {
            awards.league.bestGoalie.achievements.push({
                type: 'award',
                award: 'Vezina Trophy',
                year: currentYear,
                icon: 'üèÜ'
            });
        }
        if (awards.league.bestDefenseman && awards.league.bestDefenseman.achievements) {
            awards.league.bestDefenseman.achievements.push({
                type: 'award',
                award: 'Norris Trophy',
                year: currentYear,
                icon: 'üèÜ'
            });
        }
        if (awards.league.rookieOfTheYear && awards.league.rookieOfTheYear.achievements) {
            awards.league.rookieOfTheYear.achievements.push({
                type: 'award',
                award: 'Calder Trophy',
                year: currentYear,
                icon: 'üèÜ'
            });
        }
        if (awards.league.topScorer && awards.league.topScorer.achievements) {
            awards.league.topScorer.achievements.push({
                type: 'award',
                award: 'Art Ross Trophy',
                year: currentYear,
                icon: 'üèÜ'
            });
        }
        if (awards.league.topGoalScorer && awards.league.topGoalScorer.achievements) {
            awards.league.topGoalScorer.achievements.push({
                type: 'award',
                award: 'Maurice Richard Trophy',
                year: currentYear,
                icon: 'üèÜ'
            });
        }
        if (awards.league.bestDefensiveForward && awards.league.bestDefensiveForward.achievements) {
            awards.league.bestDefensiveForward.achievements.push({
                type: 'award',
                award: 'Selke Trophy',
                year: currentYear,
                icon: 'üèÖ'
            });
        }
        if (awards.league.sportsmanship && awards.league.sportsmanship.achievements) {
            awards.league.sportsmanship.achievements.push({
                type: 'award',
                award: 'Lady Byng Trophy',
                year: currentYear,
                icon: 'ü§ù'
            });
        }
        if (awards.league.topPointScorer && awards.league.topPointScorer.achievements) {
            awards.league.topPointScorer.achievements.push({
                type: 'award',
                award: 'Art Ross Trophy',
                year: currentYear,
                icon: 'üìä'
            });
        }
        
        // Award All-Star Team selections (1st, 2nd, 3rd teams)
        ['firstTeam', 'secondTeam', 'thirdTeam'].forEach((team, teamIdx) => {
            const teamName = teamIdx === 0 ? '1st' : teamIdx === 1 ? '2nd' : '3rd';
            const allStarTeam = awards.allStars[team];
            
            [allStarTeam.center, allStarTeam.leftWing, allStarTeam.rightWing,
             allStarTeam.leftDefense, allStarTeam.rightDefense, allStarTeam.goalie].forEach(player => {
                if (player && player.achievements) {
                    player.achievements.push({
                        type: 'allstar_team',
                        team: `${teamName} All-Star Team`,
                        year: currentYear,
                        icon: teamIdx === 0 ? 'ü•á' : teamIdx === 1 ? 'ü•à' : 'ü•â'
                    });
                }
            });
        });
        
        // Award Division MVPs and Best Goalies
        ['Atlantic', 'Metropolitan', 'Central', 'Pacific'].forEach(division => {
            const divAwards = awards.divisions[division];
            
            if (divAwards.mvp && divAwards.mvp.achievements) {
                divAwards.mvp.achievements.push({
                    type: 'division_award',
                    award: `${division} Division MVP`,
                    year: currentYear,
                    icon: 'üèÜ'
                });
            }
            
            if (divAwards.bestGoalie && divAwards.bestGoalie.achievements) {
                divAwards.bestGoalie.achievements.push({
                    type: 'division_award',
                    award: `${division} Division Best Goalie`,
                    year: currentYear,
                    icon: 'ü•Ö'
                });
            }
            
            // Award Division All-Star Team selections
            const divAllStars = awards.allStars.divisions[division];
            [divAllStars.center, divAllStars.leftWing, divAllStars.rightWing,
             divAllStars.leftDefense, divAllStars.rightDefense, divAllStars.goalie].forEach(player => {
                if (player && player.achievements) {
                    player.achievements.push({
                        type: 'division_allstar',
                        team: `${division} Division All-Star Team`,
                        year: currentYear,
                        icon: '‚≠ê'
                    });
                }
            });
        });
        
        // Award All-Star selections (NHL-style: 12F, 6D, 2G per conference)
        // Eastern Conference All-Stars
        const eastPlayers = players.filter(p => {
            const team = TEAMS.find(t => t.id === p.teamId);
            return team && team.conference === 'East' && p.roster === 'nhl';
        });
        const eastForwards = eastPlayers.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20)
            .sort((a, b) => b.stats.points - a.stats.points).slice(0, 12);
        const eastDefense = eastPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20)
            .sort((a, b) => b.stats.points - a.stats.points).slice(0, 6);
        const eastGoalies = eastPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 20)
            .sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0)).slice(0, 2);
        
        [...eastForwards, ...eastDefense, ...eastGoalies].forEach(p => {
            if (p.achievements) {
                p.achievements.push({
                    type: 'allstar',
                    conference: 'Eastern',
                    year: currentYear,
                    icon: '‚≠ê'
                });
            }
        });
        
        // Western Conference All-Stars
        const westPlayers = players.filter(p => {
            const team = TEAMS.find(t => t.id === p.teamId);
            return team && team.conference === 'West' && p.roster === 'nhl';
        });
        const westForwards = westPlayers.filter(p => p.position === 'F' && p.stats.gamesPlayed >= 20)
            .sort((a, b) => b.stats.points - a.stats.points).slice(0, 12);
        const westDefense = westPlayers.filter(p => p.position === 'D' && p.stats.gamesPlayed >= 20)
            .sort((a, b) => b.stats.points - a.stats.points).slice(0, 6);
        const westGoalies = westPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 20)
            .sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0)).slice(0, 2);
        
        [...westForwards, ...westDefense, ...westGoalies].forEach(p => {
            if (p.achievements) {
                p.achievements.push({
                    type: 'allstar',
                    conference: 'Western',
                    year: currentYear,
                    icon: '‚≠ê'
                });
            }
        });
        
        // Award League Leaders
        const nhlPlayers = players.filter(p => p.roster === 'nhl' && p.stats.gamesPlayed > 0);
        const nhlSkaters = nhlPlayers.filter(p => p.position !== 'G');
        const nhlGoalies = nhlPlayers.filter(p => p.position === 'G' && p.stats.gamesPlayed >= 27);
        
        // Points leader
        const pointsLeader = [...nhlSkaters].sort((a, b) => b.stats.points - a.stats.points)[0];
        if (pointsLeader && pointsLeader.achievements) {
            pointsLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Points',
                value: pointsLeader.stats.points,
                year: currentYear,
                icon: 'üéØ'
            });
        }
        
        // Goals leader
        const goalsLeader = [...nhlSkaters].sort((a, b) => b.stats.goals - a.stats.goals)[0];
        if (goalsLeader && goalsLeader.achievements) {
            goalsLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Goals',
                value: goalsLeader.stats.goals,
                year: currentYear,
                icon: 'üéØ'
            });
        }
        
        // Assists leader
        const assistsLeader = [...nhlSkaters].sort((a, b) => b.stats.assists - a.stats.assists)[0];
        if (assistsLeader && assistsLeader.achievements) {
            assistsLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Assists',
                value: assistsLeader.stats.assists,
                year: currentYear,
                icon: 'üéØ'
            });
        }
        
        // Plus/Minus leader
        const plusMinusLeader = [...nhlSkaters].sort((a, b) => b.stats.plusMinus - a.stats.plusMinus)[0];
        if (plusMinusLeader && plusMinusLeader.achievements && plusMinusLeader.stats.plusMinus > 0) {
            plusMinusLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Plus/Minus',
                value: plusMinusLeader.stats.plusMinus,
                year: currentYear,
                icon: 'üéØ'
            });
        }
        
        // PIM leader
        const pimLeader = [...nhlSkaters].sort((a, b) => b.stats.pim - a.stats.pim)[0];
        if (pimLeader && pimLeader.achievements && pimLeader.stats.pim > 0) {
            pimLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Penalty Minutes',
                value: pimLeader.stats.pim,
                year: currentYear,
                icon: 'üéØ'
            });
        }
        
        // Goalie: Wins leader
        const winsLeader = [...nhlGoalies].sort((a, b) => (b.stats?.wins || 0) - (a.stats?.wins || 0))[0];
        if (winsLeader && winsLeader.achievements) {
            winsLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Wins',
                value: winsLeader.stats?.wins,
                year: currentYear,
                icon: 'üéØ'
            });
        }
        
        // Goalie: Save % leader
        const savePercentageLeader = [...nhlGoalies].sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0))[0];
        if (savePercentageLeader && savePercentageLeader.achievements) {
            savePercentageLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Save Percentage',
                value: savePercentageLeader.stats.savePercentage.toFixed(3),
                year: currentYear,
                icon: 'üéØ'
            });
        }
        
        // Goalie: GAA leader (lowest)
        const gaaLeader = [...nhlGoalies].sort((a, b) => (a.stats.gaa || 99) - (b.stats.gaa || 99))[0];
        if (gaaLeader && gaaLeader.achievements) {
            gaaLeader.achievements.push({
                type: 'leagueLeader',
                stat: 'Goals Against Average',
                value: gaaLeader.stats.gaa.toFixed(2),
                year: currentYear,
                icon: 'üéØ'
            });
        }

        return awards;
    };

    // Calculate playoff MVP (Conn Smythe equivalent)
    const calculatePlayoffMVP = (players) => {
        if (!players || players.length === 0) return null;
        
        const playoffSkaters = players.filter(p => p.position !== 'G' && p.playoffStats.gamesPlayed >= 4);
        const playoffGoalies = players.filter(p => p.position === 'G' && p.playoffStats.gamesPlayed >= 4);
        
        const allCandidates = [];
        
        // Score skaters
        playoffSkaters.forEach(p => {
            const score = (p.playoffStats.points * 3) + 
                         (p.playoffStats.plusMinus * 1) + 
                         (p.playoffStats.gamesPlayed * 0.5);
            allCandidates.push({ player: p, score });
        });
        
        // Score goalies
        playoffGoalies.forEach(p => {
            const score = (p.playoffStats.savePercentage * 150) + 
                         ((3.0 - p.playoffStats.gaa) * 15) + 
                         (p.playoffStats?.wins * 2);
            allCandidates.push({ player: p, score });
        });
        
        allCandidates.sort((a, b) => b.score - a.score);
        return allCandidates[0]?.player;
    };

    // Line Management Functions
    // Validate lineup - checks if lineup meets NHL requirements
    const validateLineup = () => {
        if (!gameState || !userTeamId) {
            return { valid: false, errors: ['No game state available'] };
        }
        
        const roster = gameState.players.filter(p => p.teamId === userTeamId && !p.injury.injured);
        const forwards = roster.filter(p => p.position === 'F' && p.lineNumber > 0);
        const defense = roster.filter(p => p.position === 'D' && p.lineNumber > 0);
        const goalies = roster.filter(p => p.position === 'G' && p.dressed);
        
        const errors = [];
        
        // Check forward lines (need exactly 12 forwards in lines 1-4)
        if (forwards.length !== 12) {
            errors.push(`Need exactly 12 forwards in lines (currently ${forwards.length})`);
        }
        
        // Check each forward line has C, LW, RW
        for (let line = 1; line <= FORWARD_LINES; line++) {
            const lineForwards = forwards.filter(f => f.lineNumber === line);
            const hasC = lineForwards.some(f => f.linePosition === 'C');
            const hasLW = lineForwards.some(f => f.linePosition === 'LW');
            const hasRW = lineForwards.some(f => f.linePosition === 'RW');
            
            if (!hasC) errors.push(`Line ${line} missing Center (C)`);
            if (!hasLW) errors.push(`Line ${line} missing Left Wing (LW)`);
            if (!hasRW) errors.push(`Line ${line} missing Right Wing (RW)`);
        }
        
        // Check defense pairs (need exactly 6 defensemen)
        if (defense.length !== 6) {
            errors.push(`Need exactly 6 defensemen in pairs (currently ${defense.length})`);
        }
        
        // Check each defense pair has LD and RD
        for (let pair = 1; pair <= 3; pair++) {
            const pairDefense = defense.filter(d => d.lineNumber === pair);
            const hasLD = pairDefense.some(d => d.linePosition === 'LD');
            const hasRD = pairDefense.some(d => d.linePosition === 'RD');
            
            if (!hasLD) errors.push(`Defense pair ${pair} missing Left Defense (LD)`);
            if (!hasRD) errors.push(`Defense pair ${pair} missing Right Defense (RD)`);
        }
        
        // Check goalies (need at least 1, max 2 dressed)
        if (goalies.length < 1) {
            errors.push('Need at least 1 goalie dressed');
        } else if (goalies.length > 2) {
            errors.push('Cannot dress more than 2 goalies');
        }
        
        // Check PP units (need 5 players per unit)
        const pp1 = roster.filter(p => p.ppUnit === 1 && p.lineNumber > 0);
        const pp2 = roster.filter(p => p.ppUnit === 2 && p.lineNumber > 0);
        
        if (pp1.length !== 5) {
            errors.push(`PP1 needs exactly 5 players (currently ${pp1.length})`);
        }
        if (pp2.length !== 5) {
            errors.push(`PP2 needs exactly 5 players (currently ${pp2.length})`);
        }
        
        // Check PK units (need 4 players per unit - 5th is in penalty box)
        const pk1 = roster.filter(p => p.pkUnit === 1 && p.lineNumber > 0);
        const pk2 = roster.filter(p => p.pkUnit === 2 && p.lineNumber > 0);
        
        if (pk1.length !== 4) {
            errors.push(`PK1 needs exactly 4 players (currently ${pk1.length})`);
        }
        if (pk2.length !== 4) {
            errors.push(`PK2 needs exactly 4 players (currently ${pk2.length})`);
        }
        
        return {
            valid: errors.length === 0,
            errors: errors
        };
    };
    
    const saveCurrentLineup = () => {
        if (!gameState || !userTeamId) return;
        
        // Validate lineup before saving
        const validation = validateLineup();
        if (!validation.valid) {
            const injuredCount = gameState.players.filter(p => p.teamId === userTeamId && p.injury?.injured).length;
            let errorMsg = '‚ùå Cannot save lineup. Please fix the following issues:\n\n' + validation.errors.join('\n');
            
            if (injuredCount > 0) {
                errorMsg += `\n\n‚ö†Ô∏è You have ${injuredCount} injured player${injuredCount > 1 ? 's' : ''}. Call up players from your farm team!\n\nGo to: MY TEAM ‚Üí Call-Ups & Send-Downs`;
            } else {
                errorMsg += '\n\nTip: Use "Auto-Set Best Lineup" to quickly fix these issues.';
            }
            
            alert(errorMsg);
            return;
        }
        
        // Save the current lineup as the default (overwrite previous)
        const roster = gameState.players.filter(p => p.teamId === userTeamId);
        const lineupData = roster.map(p => ({
            playerId: p.id,
            lineNumber: p.lineNumber,
            linePosition: p.linePosition,
            dressed: p.dressed,
            ppUnit: p.ppUnit,
            pkUnit: p.pkUnit,
            position: p.position
        }));
        
        // Store as single default lineup
        setSavedLineups([{
            id: 'default',
            name: 'Default Lineup',
            date: new Date(),
            data: lineupData
        }]);
        
        alert('‚úÖ Lineup saved successfully! This lineup is now set as your default.');
    };
    
    const loadLineup = (lineup) => {
        if (!gameState || !userTeamId) return;
        
        const newPlayers = [...gameState.players];
        
        lineup.data.forEach(savedPlayer => {
            const player = newPlayers.find(p => p.id === savedPlayer.playerId);
            if (player) {
                player.lineNumber = savedPlayer.lineNumber;
                player.linePosition = savedPlayer.linePosition;
                player.dressed = savedPlayer.dressed;
                player.ppUnit = savedPlayer.ppUnit;
                player.pkUnit = savedPlayer.pkUnit;
            }
        });
        
        setGameState({ ...gameState, players: newPlayers });
        alert(`Lineup "${lineup.name}" loaded successfully!`);
    };
    
    const deleteLineup = (lineupId) => {
        if (confirm('Are you sure you want to delete this saved lineup?')) {
            setSavedLineups(savedLineups.filter(l => l.id !== lineupId));
        }
    };
    
    const changePlayerLine = (playerId, newLine) => {
        if (!gameState) return;
        
        const newPlayers = [...gameState.players];
        const player = newPlayers.find(p => p.id === playerId);
        if (player) {
            player.lineNumber = newLine;
            setGameState({ ...gameState, players: newPlayers });
        }
    };
    
    const toggleHealthyScratch = (playerId) => {
        if (!gameState) return;
        
        const newPlayers = [...gameState.players];
        const player = newPlayers.find(p => p.id === playerId);
        if (player) {
            // Toggle between line 0 (scratched) and line 4 (playing)
            player.lineNumber = player.lineNumber === 0 ? 4 : 0;
            setGameState({ ...gameState, players: newPlayers });
        }
    };
    
    // Assign player to specific line and position
    const assignPlayerToLine = (playerId, lineNum, position) => {
        if (!gameState) return;
        
        const newPlayers = [...gameState.players];
        const player = newPlayers.find(p => p.id === playerId);
        if (player) {
            player.lineNumber = lineNum;
            player.linePosition = position;
            setGameState({ ...gameState, players: newPlayers });
        }
    };
    
    // Assign player to special teams
    const assignToSpecialTeams = (playerId, unit, unitNumber, position) => {
        if (!gameState) return;
        
        const newPlayers = [...gameState.players];
        const player = newPlayers.find(p => p.id === playerId);
        if (player) {
            if (unit === 'pp') {
                // Clear any existing PP assignment for this player
                player.ppUnit = unitNumber;
                player.ppPosition = position;
            } else if (unit === 'pk') {
                // Clear any existing PK assignment for this player
                player.pkUnit = unitNumber;
                player.pkPosition = position;
            }
            setGameState({ ...gameState, players: newPlayers });
            saveGameToLocalStorage({ ...gameState, players: newPlayers }, userTeamId, playoffState, seasonMode);
        }
    };
    
    // Toggle goalie dressed status
    const toggleGoalieDressed = (playerId) => {
        if (!gameState) return;
        
        const newPlayers = [...gameState.players];
        const player = newPlayers.find(p => p.id === playerId);
        if (player && player.position === 'G') {
            player.dressed = !player.dressed;
            setGameState({ ...gameState, players: newPlayers });
        }
    };

    // Calculate effective overall rating (reduced if out of position)
    const getEffectiveOverall = (player) => {
        if (!player.linePosition || !player.preferredPosition) return player.ratings.overall;
        
        // Goalies always play their position
        if (player.position === 'G') return player.ratings.overall;
        
        // In preferred position = full rating
        if (player.linePosition === player.preferredPosition) return player.ratings.overall;
        
        // Out of position penalty
        if (player.position === 'F') {
            // Forwards: -3 OVR when out of position
            return Math.max(50, player.ratings.overall - 3);
        } else if (player.position === 'D') {
            // Defense: -5 OVR when playing wrong side
            return Math.max(50, player.ratings.overall - 5);
        }
        
        return player.ratings.overall;
    };

    // Check and award milestones
    const checkMilestones = (player, gameState) => {
        if (!player.milestones) player.milestones = [];
        
        const milestones = [];
        const stats = player.stats;
        const existingMilestones = player.milestones.map(m => m.type);
        
        // Calculate current season game number for the player's team
        const teamStanding = gameState.standings.find(s => s.teamId === player.teamId);
        const seasonGame = teamStanding ? (teamStanding?.wins + teamStanding?.losses + teamStanding?.otLosses) : 0;
        
        // Career game is stored in stats
        const careerGame = stats.gamesPlayed || 0;
        
        // ========== EARLY CAREER MILESTONES ==========
        if (stats.goals >= 1 && !existingMilestones.includes('first_goal')) {
            milestones.push({ 
                type: 'first_goal', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: 'First Career Goal' 
            });
        }
        if (stats.points >= 1 && !existingMilestones.includes('first_point')) {
            milestones.push({ 
                type: 'first_point', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: 'First Career Point' 
            });
        }
        
        // ========== REALISTIC SINGLE-SEASON GOAL MILESTONES ==========
        if (stats.goals >= 10 && !existingMilestones.includes('10_goals')) {
            milestones.push({ 
                type: '10_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '10 Career Goals' 
            });
        }
        if (stats.goals >= 20 && !existingMilestones.includes('20_goals')) {
            milestones.push({ 
                type: '20_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '20 Career Goals' 
            });
        }
        if (stats.goals >= 30 && !existingMilestones.includes('30_goals')) {
            milestones.push({ 
                type: '30_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '30 Career Goals' 
            });
        }
        if (stats.goals >= 40 && !existingMilestones.includes('40_goals')) {
            milestones.push({ 
                type: '40_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '40 Career Goals' 
            });
        }
        if (stats.goals >= 50 && !existingMilestones.includes('50_goals')) {
            milestones.push({ 
                type: '50_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '50 Career Goals (Elite!)' 
            });
        }
        if (stats.goals >= 100 && !existingMilestones.includes('100_goals')) {
            milestones.push({ 
                type: '100_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '100 Career Goals' 
            });
        }
        if (stats.goals >= 200 && !existingMilestones.includes('200_goals')) {
            milestones.push({ 
                type: '200_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '200 Career Goals' 
            });
        }
        if (stats.goals >= 300 && !existingMilestones.includes('300_goals')) {
            milestones.push({ 
                type: '300_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '300 Career Goals' 
            });
        }
        if (stats.goals >= 400 && !existingMilestones.includes('400_goals')) {
            milestones.push({ 
                type: '400_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '400 Career Goals' 
            });
        }
        if (stats.goals >= 500 && !existingMilestones.includes('500_goals')) {
            milestones.push({ 
                type: '500_goals', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '500 Career Goals (Legendary!)' 
            });
        }
        
        // ========== POINTS MILESTONES ==========
        if (stats.points >= 10 && !existingMilestones.includes('10_points')) {
            milestones.push({ 
                type: '10_points', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '10 Career Points' 
            });
        }
        if (stats.points >= 25 && !existingMilestones.includes('25_points')) {
            milestones.push({ 
                type: '25_points', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '25 Career Points' 
            });
        }
        if (stats.points >= 50 && !existingMilestones.includes('50_points')) {
            milestones.push({ 
                type: '50_points', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '50 Career Points' 
            });
        }
        if (stats.points >= 100 && !existingMilestones.includes('100_points')) {
            milestones.push({ 
                type: '100_points', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '100 Career Points' 
            });
        }
        if (stats.points >= 200 && !existingMilestones.includes('200_points')) {
            milestones.push({ 
                type: '200_points', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '200 Career Points' 
            });
        }
        if (stats.points >= 500 && !existingMilestones.includes('500_points')) {
            milestones.push({ 
                type: '500_points', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '500 Career Points' 
            });
        }
        if (stats.points >= 1000 && !existingMilestones.includes('1000_points')) {
            milestones.push({ 
                type: '1000_points', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '1000 Career Points (Hall of Fame!)' 
            });
        }
        
        // ========== GAMES PLAYED MILESTONES ==========
        if (stats.gamesPlayed >= 10 && !existingMilestones.includes('10_games')) {
            milestones.push({ 
                type: '10_games', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '10 Games Played' 
            });
        }
        if (stats.gamesPlayed >= 50 && !existingMilestones.includes('50_games')) {
            milestones.push({ 
                type: '50_games', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '50 Games Played' 
            });
        }
        if (stats.gamesPlayed >= 100 && !existingMilestones.includes('100_games')) {
            milestones.push({ 
                type: '100_games', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '100 Games Played' 
            });
        }
        if (stats.gamesPlayed >= 200 && !existingMilestones.includes('200_games')) {
            milestones.push({ 
                type: '200_games', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '200 Games Played' 
            });
        }
        if (stats.gamesPlayed >= 500 && !existingMilestones.includes('500_games')) {
            milestones.push({ 
                type: '500_games', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '500 Games Played' 
            });
        }
        if (stats.gamesPlayed >= 1000 && !existingMilestones.includes('1000_games')) {
            milestones.push({ 
                type: '1000_games', 
                day: gameState.currentDay, 
                season: gameState.season, 
                year: gameState.year, 
                seasonGame: seasonGame,
                careerGame: careerGame,
                description: '1000 Games Played (Iron Man!)' 
            });
        }
        
        // ========== GOALIE-SPECIFIC MILESTONES ==========
        if (player.position === 'G') {
            if (stats?.wins >= 1 && !existingMilestones.includes('first_win')) {
                milestones.push({ 
                    type: 'first_win', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: 'First Career Win' 
                });
            }
            if (stats.shutouts >= 1 && !existingMilestones.includes('first_shutout')) {
                milestones.push({ 
                    type: 'first_shutout', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: 'First Career Shutout' 
                });
            }
            if (stats?.wins >= 10 && !existingMilestones.includes('10_wins')) {
                milestones.push({ 
                    type: '10_wins', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '10 Career Wins' 
                });
            }
            if (stats?.wins >= 20 && !existingMilestones.includes('20_wins')) {
                milestones.push({ 
                    type: '20_wins', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '20 Career Wins' 
                });
            }
            if (stats?.wins >= 30 && !existingMilestones.includes('30_wins')) {
                milestones.push({ 
                    type: '30_wins', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '30 Career Wins' 
                });
            }
            if (stats?.wins >= 50 && !existingMilestones.includes('50_wins')) {
                milestones.push({ 
                    type: '50_wins', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '50 Career Wins' 
                });
            }
            if (stats?.wins >= 100 && !existingMilestones.includes('100_wins')) {
                milestones.push({ 
                    type: '100_wins', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '100 Career Wins' 
                });
            }
            if (stats?.wins >= 200 && !existingMilestones.includes('200_wins')) {
                milestones.push({ 
                    type: '200_wins', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '200 Career Wins' 
                });
            }
            if (stats?.wins >= 300 && !existingMilestones.includes('300_wins')) {
                milestones.push({ 
                    type: '300_wins', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '300 Career Wins' 
                });
            }
            if (stats.shutouts >= 5 && !existingMilestones.includes('5_shutouts')) {
                milestones.push({ 
                    type: '5_shutouts', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '5 Career Shutouts' 
                });
            }
            if (stats.shutouts >= 10 && !existingMilestones.includes('10_shutouts')) {
                milestones.push({ 
                    type: '10_shutouts', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '10 Career Shutouts' 
                });
            }
            if (stats.shutouts >= 25 && !existingMilestones.includes('25_shutouts')) {
                milestones.push({ 
                    type: '25_shutouts', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '25 Career Shutouts' 
                });
            }
            if (stats.shutouts >= 50 && !existingMilestones.includes('50_shutouts')) {
                milestones.push({ 
                    type: '50_shutouts', 
                    day: gameState.currentDay, 
                    season: gameState.season, 
                    year: gameState.year, 
                    seasonGame: seasonGame,
                    careerGame: careerGame,
                    description: '50 Career Shutouts (Elite!)' 
                });
            }
        }
        
        // Add all new milestones
        player.milestones.push(...milestones);
        
        return milestones;
    };

    // Backfill milestones for existing players (run once when loading save)
    const backfillMilestones = (gameState) => {
        if (!gameState || !gameState.players) return gameState;
        
        let milestonesAdded = 0;
        let playersProcessed = 0;
        
        gameState.players.forEach(player => {
            if (!player.milestones) player.milestones = [];
            
            const statsBefore = player.milestones.length;
            
            // Run checkMilestones to award any missing milestones
            const newMilestones = checkMilestones(player, gameState);
            
            const statsAfter = player.milestones.length;
            const added = statsAfter - statsBefore;
            
            if (added > 0) {
                playersProcessed++;
                milestonesAdded += added;
                console.log(`[MILESTONES] ${player.firstName} ${player.lastName}: Added ${added} milestones (${player.stats.goals}G, ${player.stats.points}P, ${player.stats.gamesPlayed}GP)`);
            }
        });
        
        if (milestonesAdded > 0) {
            console.log(`[MILESTONES] ‚úÖ Backfilled ${milestonesAdded} total milestones for ${playersProcessed} players`);
        } else {
            console.log(`[MILESTONES] No new milestones to backfill`);
        }
        
        return gameState;
    };

    // ============================================================
    // COMPREHENSIVE AI-TO-AI TRADE SYSTEM
    // ============================================================
    
    const processAITrades = (currentGameState, gameNumber, userTeamId) => {
        // Initialize trade tracking
        if (!currentGameState.tradeHistory) {
            currentGameState.tradeHistory = [];
        }
        if (!currentGameState.aiTradeLog) {
            currentGameState.aiTradeLog = [];
        }
        if (!currentGameState.teamTradeCount) {
            currentGameState.teamTradeCount = {};
            TEAMS.forEach(t => currentGameState.teamTradeCount[t.id] = 0);
        }
        
        // Target: 30-40 trades per season (increased from 25-35)
        // Distributed across ~55 days before deadline
        const targetTradesPerSeason = 35; // Increased from 30
        const daysBeforeDeadline = 55;
        
        const isTradeDeadline = gameNumber >= 50 && gameNumber <= 56; // 7-day deadline period
        const isPostDeadline = gameNumber > 56;
        
        // Calculate how many trades should happen per day
        let tradesAttempted = 0;
        let maxAttemptsPerDay;
        
        if (isPostDeadline) {
            return currentGameState; // No trades after deadline
        } else if (isTradeDeadline) {
            // 50% of season trades happen at deadline (~17 trades over 7 days)
            maxAttemptsPerDay = 12; // Increased from 10
        } else if (gameNumber < 20) {
            // Early season: more active (teams assess rosters)
            maxAttemptsPerDay = 4; // Increased from 3
        } else {
            // Mid-season: steady
            maxAttemptsPerDay = 3; // Increased from 2
        }
        
        // Process multiple trade attempts this day
        for (let attempt = 0; attempt < maxAttemptsPerDay; attempt++) {
            const trade = attemptAITrade(currentGameState, gameNumber, isTradeDeadline, userTeamId);
            
            if (trade) {
                // Execute the trade
                executeAITrade(currentGameState, trade);
                tradesAttempted++;
            }
        }
        
        return currentGameState;
    };
    
    // Analyze team needs based on roster composition and standings
    const analyzeTeamNeeds = (teamId, players, standings) => {
        const roster = players.filter(p => p.teamId === teamId && p.roster === 'nhl');
        const standing = standings.find(s => s.teamId === teamId);
        
        if (!standing) {
            // No standings data - return neutral needs
            return {
                needsScoring: false,
                needsDefense: false,
                needsGoalie: false,
                isContender: false,
                isRebuilding: true
            };
        }
        
        const gamesPlayed = standing?.wins + standing?.losses + standing?.otLosses;
        const winPct = gamesPlayed > 0 ? standing?.wins / gamesPlayed : 0.5;
        
        // Team status
        const isContender = winPct > 0.58;  // Top playoff teams
        const isPlayoffBubble = winPct >= 0.48 && winPct <= 0.58;
        const isRebuilding = winPct < 0.40;
        
        // Position counts and quality
        const forwards = roster.filter(p => p.position === 'F');
        const defense = roster.filter(p => p.position === 'D');
        const goalies = roster.filter(p => p.position === 'G');
        
        // Calculate position strength (average OVR)
        const forwardStrength = forwards.reduce((sum, p) => sum + p.ratings.overall, 0) / forwards.length;
        const defenseStrength = defense.reduce((sum, p) => sum + p.ratings.overall, 0) / defense.length;
        const goalieStrength = goalies.reduce((sum, p) => sum + p.ratings.overall, 0) / goalies.length;
        
        // Top players
        const topForward = forwards.sort((a, b) => b.ratings.overall - a.ratings.overall)[0];
        const topDefense = defense.sort((a, b) => b.ratings.overall - a.ratings.overall)[0];
        
        // Identify needs
        const needs = [];
        const surpluses = [];
        
        // Position-based needs
        if (goalies.length < 2 || goalieStrength < 78) needs.push('G');
        if (defense.length < 7 || defenseStrength < 79) needs.push('D');
        if (forwards.length < 13 || forwardStrength < 79) needs.push('F');
        
        // Star power needs
        const hasEliteForward = forwards.some(p => p.ratings.overall >= 88);
        const hasEliteDefense = defense.some(p => p.ratings.overall >= 86);
        
        if (!hasEliteForward && isContender) needs.push('ELITE_F');
        if (!hasEliteDefense && isContender) needs.push('ELITE_D');
        
        // Identify surpluses (players to move)
        if (forwards.length > 15) surpluses.push('F');
        if (defense.length > 9) surpluses.push('D');
        if (goalies.length > 3) surpluses.push('G');
        
        return {
            status: isContender ? 'CONTENDER' : isRebuilding ? 'REBUILDING' : isPlayoffBubble ? 'BUBBLE' : 'MIDDLE',
            winPct,
            needs,
            surpluses,
            forwardStrength,
            defenseStrength,
            goalieStrength,
            weakestPosition: forwardStrength < defenseStrength ? (forwardStrength < goalieStrength ? 'F' : 'G') : (defenseStrength < goalieStrength ? 'D' : 'G')
        };
    };
    
    // Find optimal trade partners based on complementary needs
    const findTradePartners = (teams, standings, players, gameNumber, isDeadline) => {
        const teamAnalyses = teams.map(t => ({
            team: t,
            analysis: analyzeTeamNeeds(t.id, players, standings),
            tradeCount: 0 // Will be updated
        }));
        
        // Find complementary pairs
        const pairs = [];
        
        for (let i = 0; i < teamAnalyses.length; i++) {
            for (let j = i + 1; j < teamAnalyses.length; j++) {
                const t1 = teamAnalyses[i];
                const t2 = teamAnalyses[j];
                
                // Skip same division trades less often (was 70% block, now 50%)
                if (t1.team.division === t2.team.division && !isDeadline && Math.random() > 0.5) {
                    continue;
                }
                
                // Calculate trade compatibility score
                let score = 0;
                
                // Contender + Rebuilder = ideal match
                if (t1.analysis.status === 'CONTENDER' && t2.analysis.status === 'REBUILDING') score += 50;
                if (t1.analysis.status === 'REBUILDING' && t2.analysis.status === 'CONTENDER') score += 50;
                
                // Bubble teams trade with anyone
                if (t1.analysis.status === 'BUBBLE' || t2.analysis.status === 'BUBBLE') score += 20;
                
                // Position needs matching
                const sharedNeeds = t1.analysis.needs.filter(n => t2.analysis.surpluses.includes(n)).length;
                const reverseNeeds = t2.analysis.needs.filter(n => t1.analysis.surpluses.includes(n)).length;
                score += (sharedNeeds + reverseNeeds) * 15;
                
                // Deadline urgency
                if (isDeadline) {
                    if (t1.analysis.status === 'CONTENDER') score += 30;
                    if (t2.analysis.status === 'CONTENDER') score += 30;
                }
                
                if (score > 30) {
                    pairs.push({ t1, t2, score });
                }
            }
        }
        
        // Sort by compatibility score
        pairs.sort((a, b) => b.score - a.score);
        
        return pairs;
    };
    
    // Attempt a single AI trade
    const attemptAITrade = (gameState, gameNumber, isDeadline, userTeamId) => {
        // Safety check
        if (!gameState || !gameState.teamTradeCount) {
            console.warn('attemptAITrade: gameState.teamTradeCount not initialized');
            return null;
        }
        
        // Exclude user's team from AI trades - they must approve all trades manually
        const eligibleTeams = TEAMS.filter(t => 
            t.id !== userTeamId && // CRITICAL: Never include user team in AI trades
            (gameState.teamTradeCount[t.id] || 0) < (isDeadline ? 5 : 3) // Higher limit at deadline
        );
        
        if (eligibleTeams.length < 2) return null;
        
        // Find best trade partners
        const pairs = findTradePartners(eligibleTeams, gameState.standings, gameState.players, gameNumber, isDeadline);
        
        if (!pairs || pairs.length === 0) return null;
        
        // Try top pairs until a trade succeeds
        for (const pair of pairs.slice(0, 5)) { // Try top 5 matches
            const trade = constructTrade(pair.t1, pair.t2, gameState, gameNumber, isDeadline);
            
            if (trade && evaluateAITrade(trade, pair.t1, pair.t2)) {
                return trade;
            }
        }
        
        return null;
    };
    
    // Construct a trade between two teams
    const constructTrade = (team1Data, team2Data, gameState, gameNumber, isDeadline) => {
        const team1 = team1Data.team;
        const team2 = team2Data.team;
        const t1Analysis = team1Data.analysis;
        const t2Analysis = team2Data.analysis;
        
        // Get eligible players
        const getEligiblePlayers = (teamId) => {
            return gameState.players.filter(p => {
                if (p.teamId !== teamId || p.roster !== 'nhl') return false;
                if (p.injury.injured) return false;
                
                // Protect franchise players from being traded easily
                if (p.ratings.overall >= 92 && Math.random() > 0.2) return false;
                
                return true;
            });
        };
        
        const t1Players = getEligiblePlayers(team1.id);
        const t2Players = getEligiblePlayers(team2.id);
        
        if (t1Players.length < 3 || t2Players.length < 3) return null;
        
        // Determine trade type and size based on team needs
        let t1GivesCount = 1;
        let t2GivesCount = 1;
        
        // Bigger trades at deadline
        if (isDeadline && Math.random() > 0.6) {
            t1GivesCount = Math.random() > 0.5 ? 2 : 1;
            t2GivesCount = Math.random() > 0.5 ? 2 : 1;
        }
        
        // Select players based on strategy
        const selectPlayersToTrade = (players, count, analysis, receivingTeamAnalysis) => {
            const selected = [];
            const available = [...players];
            
            for (let i = 0; i < count && available.length > 0; i++) {
                // Weight players based on what makes sense to trade
                const weights = available.map(p => {
                    let weight = 1;
                    
                    // CONTENDER giving up players
                    if (analysis.status === 'CONTENDER') {
                        // Trade away: aging players, prospects, depth
                        if (p.age > 32) weight *= 4;
                        if (p.age < 24 && p.ratings.overall < 80) weight *= 3; // Prospects
                        if (p.ratings.overall < 78) weight *= 2; // Depth pieces
                    }
                    
                    // REBUILDER giving up players
                    else if (analysis.status === 'REBUILDING') {
                        // Trade away: veterans, expensive players
                        if (p.age > 27) weight *= 5;
                        if (p.ratings.overall > 82 && p.age > 26) weight *= 3; // Valuable vets
                    }
                    
                    // BUBBLE team
                    else if (analysis.status === 'BUBBLE') {
                        // Trade away: underperformers, aging depth
                        if (p.age > 30 && p.ratings.overall < 82) weight *= 3;
                    }
                    
                    // Target positions that receiving team needs
                    if (receivingTeamAnalysis.needs.includes(p.position)) {
                        weight *= 2.5;
                    }
                    
                    // Match elite needs
                    if (receivingTeamAnalysis.needs.includes('ELITE_F') && p.position === 'F' && p.ratings.overall >= 88) {
                        weight *= 4;
                    }
                    if (receivingTeamAnalysis.needs.includes('ELITE_D') && p.position === 'D' && p.ratings.overall >= 86) {
                        weight *= 4;
                    }
                    
                    return weight;
                });
                
                // Weighted selection
                const totalWeight = weights.reduce((sum, w) => sum + w, 0);
                if (totalWeight === 0) break;
                
                let rand = Math.random() * totalWeight;
                let selectedIdx = 0;
                
                for (let j = 0; j < weights.length; j++) {
                    rand -= weights[j];
                    if (rand <= 0) {
                        selectedIdx = j;
                        break;
                    }
                }
                
                selected.push(available[selectedIdx]);
                available.splice(selectedIdx, 1);
            }
            
            return selected;
        };
        
        const t1Gives = selectPlayersToTrade(t1Players, t1GivesCount, t1Analysis, t2Analysis);
        const t2Gives = selectPlayersToTrade(t2Players, t2GivesCount, t2Analysis, t1Analysis);
        
        if (t1Gives.length === 0 || t2Gives.length === 0) return null;
        
        return {
            team1: team1.id,
            team2: team2.id,
            team1Gives: t1Gives,
            team2Gives: t2Gives,
            gameNumber: gameNumber,
            isDeadline: isDeadline
        };
    };
    
    // Evaluate if AI trade should go through (using similar logic to player trades)
    const evaluateAITrade = (trade, team1Data, team2Data) => {
        const t1Analysis = team1Data.analysis;
        const t2Analysis = team2Data.analysis;
        
        // Calculate trade values
        const calculateValue = (players) => {
            return {
                totalOVR: players.reduce((sum, p) => sum + p.ratings.overall, 0),
                avgOVR: players.reduce((sum, p) => sum + p.ratings.overall, 0) / players.length,
                avgAge: players.reduce((sum, p) => sum + p.age, 0) / players.length,
                totalPOT: players.reduce((sum, p) => sum + p.ratings.potential, 0),
                hasGoalie: players.some(p => p.position === 'G'),
                starCount: players.filter(p => p.ratings.overall >= GAME_CONFIG.STAR_THRESHOLD).length
            };
        };
        
        const t1Value = calculateValue(trade.team1Gives);
        const t2Value = calculateValue(trade.team2Gives);
        
        // OVR difference check - more lenient (20% instead of 15%)
        const ovrDiff = Math.abs(t1Value.totalOVR - t2Value.totalOVR);
        const ovrDiffPercent = (ovrDiff / Math.max(t1Value.totalOVR, t2Value.totalOVR)) * 100;
        
        if (ovrDiffPercent > 20) return false; // Increased from 15%
        
        // Check if trade makes sense for both teams
        let t1Score = 0;
        let t2Score = 0;
        
        // Team 1 perspective (receiving t2Gives)
        if (t1Analysis.status === 'CONTENDER') {
            if (t2Value.avgAge > t1Value.avgAge && t2Value.avgOVR > t1Value.avgOVR) t1Score += 40; // Getting better vets
            if (t2Value.starCount > t1Value.starCount) t1Score += 30;
            if (t2Value.avgOVR >= t1Value.avgOVR) t1Score += 15; // Any upgrade
        } else if (t1Analysis.status === 'REBUILDING') {
            if (t2Value.avgAge < t1Value.avgAge) t1Score += 50; // Getting younger
            if (t2Value.totalPOT > t1Value.totalPOT) t1Score += 30;
            if (t2Value.avgAge < 26) t1Score += 20; // Youth bonus
        } else { // BUBBLE or MIDDLE teams
            // Lateral moves for roster fit
            if (Math.abs(t2Value.avgOVR - t1Value.avgOVR) <= 3) t1Score += 30; // Similar quality (increased tolerance)
            if (t2Value.avgAge < t1Value.avgAge) t1Score += 15; // Slight youth preference
            if (t2Value.avgOVR > t1Value.avgOVR) t1Score += 20; // Any upgrade
        }
        
        // Team 2 perspective (receiving t1Gives)
        if (t2Analysis.status === 'CONTENDER') {
            if (t1Value.avgAge > t2Value.avgAge && t1Value.avgOVR > t2Value.avgOVR) t2Score += 40;
            if (t1Value.starCount > t2Value.starCount) t2Score += 30;
            if (t1Value.avgOVR >= t2Value.avgOVR) t2Score += 15; // Any upgrade
        } else if (t2Analysis.status === 'REBUILDING') {
            if (t1Value.avgAge < t2Value.avgAge) t2Score += 50;
            if (t1Value.totalPOT > t2Value.totalPOT) t2Score += 30;
            if (t1Value.avgAge < 26) t2Score += 20; // Youth bonus
        } else { // BUBBLE or MIDDLE teams
            if (Math.abs(t1Value.avgOVR - t2Value.avgOVR) <= 3) t2Score += 30; // Increased tolerance
            if (t1Value.avgAge < t2Value.avgAge) t2Score += 15;
            if (t1Value.avgOVR > t2Value.avgOVR) t2Score += 20;
        }
        
        // Lowered threshold from 20 to 15 - accept more trades
        // Also add 30% chance to accept "borderline" trades (score 10-15)
        const minScore = 15;
        const borderlineMin = 10;
        
        if (t1Score >= minScore && t2Score >= minScore) return true;
        if (t1Score >= borderlineMin && t2Score >= borderlineMin && Math.random() < 0.3) return true;
        
        return false;
    };
    
    // Execute the AI trade
    const executeAITrade = (gameState, trade) => {
        const team1 = TEAMS.find(t => t.id === trade.team1);
        const team2 = TEAMS.find(t => t.id === trade.team2);
        
        // Swap players
        trade.team1Gives.forEach(p => {
            const player = gameState.players.find(gp => gp.id === p.id);
            player.teamId = trade.team2;
            player.lineNumber = 0;
            player.linePosition = null;
            player.ppUnit = null;
            player.pkUnit = null;
            if (player.position === 'G') player.dressed = false;
            
            if (!player.tradeHistory) player.tradeHistory = [];
            player.tradeHistory.push({
                day: gameState.currentDay,
                season: gameState.season,
                year: gameState.year,
                from: trade.team1,
                to: trade.team2,
                tradedWith: trade.team1Gives.filter(tp => tp.id !== p.id).map(tp => ({
                    id: tp.id,
                    name: `${tp.firstName} ${tp.lastName}`,
                    position: tp.position
                })),
                tradedFor: trade.team2Gives.map(tp => ({
                    id: tp.id,
                    name: `${tp.firstName} ${tp.lastName}`,
                    position: tp.position
                }))
            });
        });
        
        trade.team2Gives.forEach(p => {
            const player = gameState.players.find(gp => gp.id === p.id);
            player.teamId = trade.team1;
            player.lineNumber = 0;
            player.linePosition = null;
            player.ppUnit = null;
            player.pkUnit = null;
            if (player.position === 'G') player.dressed = false;
            
            if (!player.tradeHistory) player.tradeHistory = [];
            player.tradeHistory.push({
                day: gameState.currentDay,
                season: gameState.season,
                year: gameState.year,
                from: trade.team2,
                to: trade.team1,
                tradedWith: trade.team2Gives.filter(tp => tp.id !== p.id).map(tp => ({
                    id: tp.id,
                    name: `${tp.firstName} ${tp.lastName}`,
                    position: tp.position
                })),
                tradedFor: trade.team1Gives.map(tp => ({
                    id: tp.id,
                    name: `${tp.firstName} ${tp.lastName}`,
                    position: tp.position
                }))
            });
        });
        
        // Update team trade counts
        gameState.teamTradeCount[trade.team1] = (gameState.teamTradeCount[trade.team1] || 0) + 1;
        gameState.teamTradeCount[trade.team2] = (gameState.teamTradeCount[trade.team2] || 0) + 1;
        
        // Add to AI trade log
        gameState.aiTradeLog.push({
            day: gameState.currentDay,
            gameNumber: trade.gameNumber,
            isDeadline: trade.isDeadline,
            team1: { id: trade.team1, name: `${team1.city} ${team1.name}` },
            team2: { id: trade.team2, name: `${team2.city} ${team2.name}` },
            team1Gives: trade.team1Gives.map(p => ({
                id: p.id,
                name: `${p.firstName} ${p.lastName}`,
                position: p.position,
                age: p.age,
                ovr: p.ratings.overall,
                pot: p.ratings.potential
            })),
            team2Gives: trade.team2Gives.map(p => ({
                id: p.id,
                name: `${p.firstName} ${p.lastName}`,
                position: p.position,
                age: p.age,
                ovr: p.ratings.overall,
                pot: p.ratings.potential
            }))
        });
        
        // Auto-assign lines for both teams
        autoSetAllLines(gameState.players, trade.team1);
        autoSetAllLines(gameState.players, trade.team2);
    };
    
    // Generate Season-Ending Summary
    const generateSeasonSummary = (gameState, playoffState, teamId) => {
        const userTeam = TEAMS.find(t => t.id === teamId);
        const userStanding = gameState.standings.find(s => s.teamId === teamId);
        const userPlayers = gameState.players.filter(p => p.teamId === teamId);
        
        // Check if userStanding exists
        if (!userStanding) {
            console.error('User standing not found for team:', teamId);
            return null;
        }
        
        // 1. Season Overview
        const wins = userStanding?.wins;
        const losses = userStanding?.losses;
        const otLosses = userStanding?.otLosses;
        const points = userStanding.points;
        
        // Division and conference rank
        const divisionTeams = gameState.standings.filter(s => 
            TEAMS.find(t => t.id === s.teamId)?.division === userTeam.division
        ).sort((a, b) => b.points - a.points);
        const divisionRank = divisionTeams.findIndex(s => s.teamId === teamId) + 1;
        
        const conferenceTeams = gameState.standings.filter(s => 
            TEAMS.find(t => t.id === s.teamId)?.conference === userTeam.conference
        ).sort((a, b) => b.points - a.points);
        const conferenceRank = conferenceTeams.findIndex(s => s.teamId === teamId) + 1;
        
        // Playoff result
        let playoffResult = 'Did not qualify';
        if (conferenceRank <= 8) {
            if (playoffState.champion === teamId) {
                playoffResult = 'üèÜ Stanley Cup Champions!';
            } else if (playoffState.finalMatchup && 
                      (playoffState.finalMatchup.home === teamId || playoffState.finalMatchup.away === teamId)) {
                playoffResult = 'Lost in Stanley Cup Finals';
            } else if (playoffState.confFinals && 
                      ((playoffState.confFinals.east && (playoffState.confFinals.east.home === teamId || playoffState.confFinals.east.away === teamId)) ||
                       (playoffState.confFinals.west && (playoffState.confFinals.west.home === teamId || playoffState.confFinals.west.away === teamId)))) {
                playoffResult = 'Lost in Conference Finals';
            } else if (playoffState.round2) {
                const inRound2 = playoffState.round2.some(matchup => 
                    matchup.home === teamId || matchup.away === teamId
                );
                if (inRound2) playoffResult = 'Lost in Second Round';
                else playoffResult = 'Lost in First Round';
            } else {
                playoffResult = 'Lost in First Round';
            }
        } else {
            const pointsAway = conferenceTeams[7].points - points;
            playoffResult = `Missed playoffs by ${pointsAway} point${pointsAway !== 1 ? 's' : ''}`;
        }
        
        // 2. Team Story (narrative)
        const avgAge = userPlayers.reduce((sum, p) => sum + p.age, 0) / userPlayers.length;
        const teamStory = generateTeamStory(wins, losses, otLosses, avgAge, playoffResult, divisionRank);
        
        // 3. Top Players
        const skaters = userPlayers.filter(p => p.position !== 'G' && p.roster === 'nhl');
        const goalies = userPlayers.filter(p => p.position === 'G' && p.roster === 'nhl');
        
        // MVP (highest points for skaters, or best goalie)
        const mvpSkater = skaters.sort((a, b) => b.stats.points - a.stats.points)[0];
        const mvpGoalie = goalies.sort((a, b) => {
            if (b.stats?.wins !== a.stats?.wins) return b.stats?.wins - a.stats?.wins;
            return (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0);
        })[0];
        
        const teamMVP = mvpSkater && (!mvpGoalie || mvpSkater.stats.points > 80) ? mvpSkater : mvpGoalie;
        
        // Breakout player (biggest OVR gain if has lastYearOVR)
        const breakoutPlayer = userPlayers
            .filter(p => p.lastYearOVR)
            .map(p => ({ ...p, ovrGain: p.ratings.overall - p.lastYearOVR }))
            .sort((a, b) => b.ovrGain - a.ovrGain)[0];
        
        // Declining player (biggest OVR loss if has lastYearOVR)
        const decliningPlayer = userPlayers
            .filter(p => p.lastYearOVR && (p.lastYearOVR - p.ratings.overall) > 2)
            .map(p => ({ ...p, ovrLoss: p.lastYearOVR - p.ratings.overall }))
            .sort((a, b) => b.ovrLoss - a.ovrLoss)[0];
        
        // 4. Biggest Decisions
        const userTrades = (gameState.tradeHistory || []).filter(trade => 
            trade.userTeamId === teamId
        );
        
        let bestTrade = null;
        let worstTrade = null;
        if (userTrades.length > 0) {
            // Simple heuristic: best trade got highest OVR, worst trade gave up highest OVR
            bestTrade = userTrades.sort((a, b) => {
                const aGot = (a.receivedPlayers || []).reduce((sum, p) => sum + (p.ovr || 0), 0);
                const bGot = (b.receivedPlayers || []).reduce((sum, p) => sum + (p.ovr || 0), 0);
                return bGot - aGot;
            })[0];
            
            worstTrade = userTrades.sort((a, b) => {
                const aGave = (a.tradedAwayPlayers || []).reduce((sum, p) => sum + (p.ovr || 0), 0);
                const bGave = (b.tradedAwayPlayers || []).reduce((sum, p) => sum + (p.ovr || 0), 0);
                return bGave - aGave;
            })[0];
        }
        
        // 5. Team Strengths & Weaknesses
        const offenseRank = calculateLeagueRank(gameState.standings, s => s.goalsFor, true, teamId);
        const defenseRank = calculateLeagueRank(gameState.standings, s => s.goalsAgainst, false, teamId);
        const avgGoalieOVR = goalies.reduce((sum, p) => sum + p.ratings.overall, 0) / (goalies.length || 1);
        
        // 6. League Snapshot
        const champion = TEAMS.find(t => t.id === playoffState.champion);
        const leagueMVP = gameState.players
            .filter(p => p.position !== 'G')
            .sort((a, b) => b.stats.points - a.stats.points)[0];
        const topScorer = leagueMVP; // Same as MVP in this case
        
        // 7. Season Headlines
        const headlines = generateSeasonHeadlines(
            wins, losses, userTrades.length, avgAge, playoffResult, teamMVP, breakoutPlayer, decliningPlayer
        );
        
        return {
            overview: {
                year: gameState.year,
                record: `${wins}-${losses}-${otLosses}`,
                points,
                divisionRank,
                conferenceRank,
                playoffResult
            },
            teamStory,
            topPlayers: {
                mvp: teamMVP,
                breakout: breakoutPlayer,
                declining: decliningPlayer
            },
            decisions: {
                bestTrade,
                worstTrade,
                totalTrades: userTrades.length
            },
            teamStrengths: {
                offense: offenseRank,
                defense: defenseRank,
                goaltending: Math.round(avgGoalieOVR)
            },
            leagueSnapshot: {
                champion: champion ? `${champion.city} ${champion.name}` : 'N/A',
                mvp: leagueMVP,
                topScorer: topScorer
            },
            headlines
        };
    };
    
    const generateTeamStory = (wins, losses, otl, avgAge, playoffResult, divRank) => {
        const totalGames = wins + losses + otl;
        const winPct = wins / totalGames;
        
        if (playoffResult.includes('Champions')) {
            return "A championship season for the ages.";
        } else if (playoffResult.includes('Finals')) {
            return "So close to glory, but the dream fell short.";
        } else if (playoffResult.includes('Conference Finals')) {
            return "A strong playoff run shows this team is ready to contend.";
        } else if (winPct > 0.60) {
            return "A successful regular season that didn't translate to playoff success.";
        } else if (winPct > 0.50) {
            return "A competitive season with room to grow.";
        } else if (avgAge < 26) {
            return "Rebuild shows signs of life ‚Äî the future looks bright.";
        } else if (avgAge > 30) {
            return "The veteran core is aging ‚Äî tough decisions loom.";
        } else if (divRank > 5) {
            return "A disappointing season calls for major changes.";
        } else {
            return "A middling season leaves more questions than answers.";
        }
    };
    
    const generateSeasonHeadlines = (wins, losses, tradeCount, avgAge, playoffResult, mvp, breakout, declining) => {
        const headlines = [];
        
        if (playoffResult.includes('Champions')) {
            headlines.push("üèÜ Championship Banner Raised!");
        } else if (playoffResult.includes('Missed')) {
            headlines.push("üìâ Playoff Drought Continues");
        }
        
        if (tradeCount > 5) {
            headlines.push("üîÑ Aggressive Trade Deadline Reshapes Roster");
        } else if (tradeCount === 0) {
            headlines.push("üö´ Management Stays Pat at Trade Deadline");
        }
        
        if (breakout && breakout.ovrGain >= 5) {
            headlines.push(`‚≠ê ${breakout.firstName} ${breakout.lastName} Emerges as Star`);
        } else if (declining && declining.ovrLoss >= 5) {
            headlines.push(`üìâ ${declining.firstName} ${declining.lastName} Shows Decline`);
        }
        
        if (avgAge < 25) {
            headlines.push("üë∂ Young Core Gains Valuable Experience");
        } else if (avgAge > 31) {
            headlines.push("‚è∞ Age Catches Up With Veteran Squad");
        }
        
        if (mvp && mvp.stats.points > 100) {
            headlines.push(`üåü ${mvp.firstName} ${mvp.lastName} Dominates With ${mvp.stats.points} Points`);
        }
        
        return headlines.slice(0, 3); // Max 3 headlines
    };
    
    const calculateLeagueRank = (standings, statGetter, higherIsBetter, userTeamId) => {
        const sorted = [...standings].sort((a, b) => {
            const aVal = statGetter(a);
            const bVal = statGetter(b);
            return higherIsBetter ? bVal - aVal : aVal - bVal;
        });
        return sorted.findIndex(s => s.teamId === userTeamId) + 1;
    };

    // NEW: Generate mid-season report card at All-Star Break (Game 41)
    const generateMidSeasonReport = () => {
        if (!gameState || !userTeamId) return null;
        
        const standing = gameState.standings.find(s => s.teamId === userTeamId);
        if (!standing) return null;
        
        const gamesPlayed = standing?.wins + standing?.losses + standing?.otLosses;
        
        // Only generate at exactly game 41
        if (gamesPlayed !== 41) return null;
        
        const teamOvr = getTeamOverall(userTeamId)?.overall || 80;
        
        // Calculate expected performance based on OVR
        // 90+ OVR = expect ~30-11 (73% win rate)
        // 85-89 = expect ~28-13 (68%)
        // 80-84 = expect ~25-16 (61%)
        // 75-79 = expect ~22-19 (54%)
        // 70-74 = expect ~19-22 (46%)
        // <70 = expect ~16-25 (39%)
        let expectedWins;
        if (teamOvr >= 90) expectedWins = 30;
        else if (teamOvr >= 85) expectedWins = 28;
        else if (teamOvr >= 80) expectedWins = 25;
        else if (teamOvr >= 75) expectedWins = 22;
        else if (teamOvr >= 70) expectedWins = 19;
        else expectedWins = 16;
        
        const actualWins = standing?.wins;
        const winDiff = actualWins - expectedWins;
        const performance = winDiff > 3 ? 'exceeding' : winDiff < -3 ? 'underperforming' : 'meeting';
        
        // Calculate stats
        const gpf = (standing.goalsFor / gamesPlayed).toFixed(2);
        const gaa = (standing.goalsAgainst / gamesPlayed).toFixed(2);
        const homeWinPct = standing.home?.wins / (standing.home?.wins + standing.home?.losses);
        const awayWinPct = standing.away?.wins / (standing.away?.wins + standing.away?.losses);
        
        // Identify strengths
        const strengths = [];
        if (parseFloat(gpf) > 3.2) strengths.push({ stat: 'Offense', value: `${gpf} goals/game`, rank: 'Top 10' });
        if (parseFloat(gaa) < 2.8) strengths.push({ stat: 'Defense', value: `${gaa} goals against/game`, rank: 'Top 10' });
        if (homeWinPct > 0.65) strengths.push({ stat: 'Home Record', value: `${standing.home?.wins}-${standing.home?.losses}`, rank: 'Elite' });
        if ((standing.goalsFor - standing.goalsAgainst) > 25) strengths.push({ stat: 'Goal Differential', value: `+${standing.goalsFor - standing.goalsAgainst}`, rank: 'Excellent' });
        
        // Identify concerns
        const concerns = [];
        if (parseFloat(gpf) < 2.5) concerns.push({ stat: 'Offense Struggling', value: `Only ${gpf} goals/game`, suggestion: 'Consider trading for scoring help' });
        if (parseFloat(gaa) > 3.5) concerns.push({ stat: 'Defensive Issues', value: `Allowing ${gaa} goals/game`, suggestion: 'Shore up defense at trade deadline' });
        if (awayWinPct < 0.40) concerns.push({ stat: 'Poor Road Record', value: `${standing.away?.wins}-${standing.away?.losses}`, suggestion: 'Work on road consistency' });
        if ((standing.goalsFor - standing.goalsAgainst) < -10) concerns.push({ stat: 'Negative Goal Differential', value: `${standing.goalsFor - standing.goalsAgainst}`, suggestion: 'Team needs improvement on both ends' });
        
        // Calculate playoff odds (simplified)
        const sorted = [...gameState.standings].sort((a,b) => b.points - a.points);
        const currentRank = sorted.findIndex(s => s.teamId === userTeamId) + 1;
        
        let playoffOdds;
        if (currentRank <= 8) playoffOdds = 95; // Very likely
        else if (currentRank <= 12) playoffOdds = 75; // Likely
        else if (currentRank <= 16) playoffOdds = 50; // Bubble
        else if (currentRank <= 20) playoffOdds = 25; // Unlikely
        else playoffOdds = 5; // Very unlikely
        
        // Project final standing
        const pointsPerGame = standing.points / gamesPlayed;
        const projectedPoints = Math.round(pointsPerGame * 82);
        
        return {
            gamesPlayed,
            record: `${standing?.wins}-${standing?.losses}-${standing?.otLosses}`,
            points: standing.points,
            expected: `${expectedWins}-${41-expectedWins}-0`,
            performance,
            performanceText: winDiff > 3 ? `+${winDiff} wins above expectations!` : winDiff < -3 ? `${Math.abs(winDiff)} wins below expectations` : 'On pace with expectations',
            strengths,
            concerns,
            playoffOdds,
            currentRank,
            projectedPoints,
            goalsFor: standing.goalsFor,
            goalsAgainst: standing.goalsAgainst,
            goalDiff: standing.goalsFor - standing.goalsAgainst
        };
    };

    // ========================================
    // NEW 82-DAY SIMULATION SYSTEM
    // ========================================
    
    const startPlayoffs = () => {
        if (!gameState) return;
        
        // Track playoffs started
        const userTeam = TEAMS.find(t => t.id === userTeamId);
        const userStanding = gameState.standings.find(s => s.teamId === userTeamId);
        trackEvent('playoffs_started', {
            season: gameState.season,
            team: userTeam?.name,
            record: `${userStanding?.wins}-${userStanding?.losses}-${userStanding?.otLosses}`,
            points: userStanding?.points
        });
        
        // Sort standings by points
        const sorted = [...gameState.standings].sort((a, b) => b.points - a.points);
        
        // Get top 16 teams for playoffs (top 8 per conference)
        const eastTeams = sorted.filter(s => {
            const team = TEAMS.find(t => t.id === s.teamId);
            return team && team.conference === 'East';
        }).slice(0, 8);
        
        const westTeams = sorted.filter(s => {
            const team = TEAMS.find(t => t.id === s.teamId);
            return team && team.conference === 'West';
        }).slice(0, 8);
        
        // Create first round matchups (1v8, 2v7, 3v6, 4v5)
        const createMatchups = (teams) => {
            return [
                { home: teams[0].teamId, away: teams[7].teamId, homeWins: 0, awayWins: 0, games: [] },
                { home: teams[1].teamId, away: teams[6].teamId, homeWins: 0, awayWins: 0, games: [] },
                { home: teams[2].teamId, away: teams[5].teamId, homeWins: 0, awayWins: 0, games: [] },
                { home: teams[3].teamId, away: teams[4].teamId, homeWins: 0, awayWins: 0, games: [] }
            ];
        };
        
        setPlayoffState({
            round: 1, // 1=First Round, 2=Conference Semis, 3=Conference Finals, 4=Stanley Cup
            eastMatchups: createMatchups(eastTeams),
            westMatchups: createMatchups(westTeams),
            completed: false,
            lastDaySummary: {
                title: 'üèÜ Stanley Cup Playoffs Begin! üèÜ',
                message: 'Round 1 (First Round) matchups are set. Click "Sim Playoff Day" to begin!',
                conference: 'Playoffs Start'
            },
            history: {
                eastRound1: createMatchups(eastTeams),
                westRound1: createMatchups(westTeams),
                eastRound2: [],
                westRound2: [],
                eastRound3: [],
                westRound3: [],
                final: null
            }
        });
        
        setSeasonMode('playoffs'); // Set season mode to playoffs
        setCurrentView('bracket');
    };
    
    const calculateThreeStars = (homeTeam, awayTeam, homePlayers, awayPlayers, homeGoals, awayGoals) => {
        // Calculate star points: G=3pts, A=2pts, W(goalie)=5pts
        const allPlayers = [];
        
        // Get stats for all players in this game
        homePlayers.concat(awayPlayers).forEach(player => {
            let points = 0;
            const team = homePlayers.includes(player) ? homeTeam : awayTeam;
            const goals = player.playoffStats.goals || 0;
            const assists = player.playoffStats.assists || 0;
            
            if (player.position === 'G') {
                // Goalie: points for win and shutout
                const isWinner = (team.id === homeTeam.id && homeGoals > awayGoals) || 
                                (team.id === awayTeam.id && awayGoals > homeGoals);
                const isShutout = (team.id === homeTeam.id && awayGoals === 0) || 
                                 (team.id === awayTeam.id && homeGoals === 0);
                if (isWinner) points += 5;
                if (isShutout) points += 3;
            } else {
                // Skaters: goals and assists
                points = (goals * 3) + (assists * 2);
            }
            
            if (points > 0) {
                allPlayers.push({ player, team, points, goals, assists });
            }
        });
        
        // Sort by points and return top 3
        return allPlayers.sort((a, b) => b.points - a.points).slice(0, 3);
    };

    const simulatePlayoffGame = (matchup, isHomeGame) => {
        // Only include active (non-scratched) and non-injured NHL players
        const homePlayers = gameState.players.filter(p => 
            p.teamId === (isHomeGame ? matchup.home : matchup.away) &&
            p.roster === 'nhl' &&
            !p.injury.injured &&
            (p.position === 'G' ? p.dressed : p.lineNumber > 0)
        );
        const awayPlayers = gameState.players.filter(p => 
            p.teamId === (isHomeGame ? matchup.away : matchup.home) &&
            p.roster === 'nhl' &&
            !p.injury.injured &&
            (p.position === 'G' ? p.dressed : p.lineNumber > 0)
        );
        
        const result = simulateGameResult(homePlayers, awayPlayers);
        
        // Store comprehensive game details including per-player stats
        const gameDetails = {
            homeGoals: result.homeGoals,
            awayGoals: result.awayGoals,
            winner: result.winner,
            homeTeam: isHomeGame ? matchup.home : matchup.away,
            awayTeam: isHomeGame ? matchup.away : matchup.home,
            homePlayerStats: result.homePlayerStats,
            awayPlayerStats: result.awayPlayerStats,
            homeScratched: result.homeScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
            awayScratched: result.awayScratched.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, reason: 'Healthy Scratch' })),
            homeNewInjuries: [],
            awayNewInjuries: [],
            scoringSummary: result.scoringSummary,
            teamStats: result.teamStats || {},
            penaltyLog: result.penaltyLog || [],
            periodScoring: result.periodScoring || []
        };
        
        // Update PLAYOFF stats from per-game stats
        result.homePlayerStats.forEach(playerGameStats => {
            const player = gameState.players.find(p => p.id === playerGameStats.player.id);
            if (player) {
                if (player.position === 'G') {
                    if (playerGameStats.shotsAgainst > 0) {
                        player.playoffStats.gamesPlayed++;
                        player.playoffStats.timeOnIce += playerGameStats.toi;
                        player.playoffStats.saves = (player.playoffStats.saves || 0) + playerGameStats.saves;
                        player.playoffStats.goalsAgainst = (player.playoffStats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                        player.playoffStats.shotsAgainst = (player.playoffStats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                        
                        if (result.winner === 'home') {
                            player.playoffStats.wins = (player.playoffStats?.wins || 0) + 1;
                        } else {
                            player.playoffStats.losses = (player.playoffStats?.losses || 0) + 1;
                        }
                        
                        if (playerGameStats.goalsAgainst === 0) {
                            player.playoffStats.shutouts = (player.playoffStats.shutouts || 0) + 1;
                        }
                        
                        player.playoffStats.savePercentage = player.playoffStats.saves / (player.playoffStats.shotsAgainst || 1);
                        player.playoffStats.gaa = (player.playoffStats.goalsAgainst / (player.playoffStats.gamesPlayed || 1)) * 1.0;
                    }
                } else {
                    player.playoffStats.gamesPlayed++;
                    player.playoffStats.goals += playerGameStats.goals;
                    player.playoffStats.assists += playerGameStats.assists;
                    player.playoffStats.points += playerGameStats.points;
                    player.playoffStats.plusMinus += playerGameStats.plusMinus;
                    player.playoffStats.pim += playerGameStats.pim;
                    player.playoffStats.shots += playerGameStats.shots;
                    player.playoffStats.timeOnIce += playerGameStats.toi;
                }
                
                // NEW: Update player streaks (playoffs count toward streaks too!)
                if (player.position !== 'G') {
                    if (!player.currentStreak) player.currentStreak = { type: null, games: 0, bonus: 0 };
                    
                    const hadPoints = playerGameStats.goals + playerGameStats.assists > 0;
                    
                    if (hadPoints) {
                        if (player.currentStreak.type === 'point') {
                            player.currentStreak.games++;
                        } else {
                            player.currentStreak = { type: 'point', games: 1, bonus: 0 };
                        }
                        
                        if (player.currentStreak.games >= 15) {
                            player.currentStreak.bonus = 4;
                        } else if (player.currentStreak.games >= 10) {
                            player.currentStreak.bonus = 3;
                        } else if (player.currentStreak.games >= 5) {
                            player.currentStreak.bonus = 2;
                        } else {
                            player.currentStreak.bonus = 0;
                        }
                    } else {
                        if (player.currentStreak.type === 'scoreless') {
                            player.currentStreak.games++;
                        } else {
                            player.currentStreak = { type: 'scoreless', games: 1, bonus: 0 };
                        }
                        
                        if (player.currentStreak.games >= 10) {
                            player.currentStreak.bonus = -2;
                        } else {
                            player.currentStreak.bonus = 0;
                        }
                    }
                }
                
                // NEW: Update player development (playoffs count!)
                if (gameState.playerDevelopment && gameState.playerDevelopment[player.id]) {
                    const dev = gameState.playerDevelopment[player.id];
                    dev.currentOVR = player.ratings.overall;
                    dev.growth = dev.currentOVR - dev.startOVR;
                    dev.games++;
                    dev.lastChecked = gameState.currentDay;
                }
            }
        });
        
        result.awayPlayerStats.forEach(playerGameStats => {
            const player = gameState.players.find(p => p.id === playerGameStats.player.id);
            if (player) {
                if (player.position === 'G') {
                    if (playerGameStats.shotsAgainst > 0) {
                        player.playoffStats.gamesPlayed++;
                        player.playoffStats.timeOnIce += playerGameStats.toi;
                        player.playoffStats.saves = (player.playoffStats.saves || 0) + playerGameStats.saves;
                        player.playoffStats.goalsAgainst = (player.playoffStats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                        player.playoffStats.shotsAgainst = (player.playoffStats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                        
                        if (result.winner === 'away') {
                            player.playoffStats.wins = (player.playoffStats?.wins || 0) + 1;
                        } else {
                            player.playoffStats.losses = (player.playoffStats?.losses || 0) + 1;
                        }
                        
                        if (playerGameStats.goalsAgainst === 0) {
                            player.playoffStats.shutouts = (player.playoffStats.shutouts || 0) + 1;
                        }
                        
                        player.playoffStats.savePercentage = player.playoffStats.saves / (player.playoffStats.shotsAgainst || 1);
                        player.playoffStats.gaa = (player.playoffStats.goalsAgainst / (player.playoffStats.gamesPlayed || 1)) * 1.0;
                    }
                } else {
                    player.playoffStats.gamesPlayed++;
                    player.playoffStats.goals += playerGameStats.goals;
                    player.playoffStats.assists += playerGameStats.assists;
                    player.playoffStats.points += playerGameStats.points;
                    player.playoffStats.plusMinus += playerGameStats.plusMinus;
                    player.playoffStats.pim += playerGameStats.pim;
                    player.playoffStats.shots += playerGameStats.shots;
                    player.playoffStats.timeOnIce += playerGameStats.toi;
                }
                
                // NEW: Update player streaks (playoffs count toward streaks too!)
                if (player.position !== 'G') {
                    if (!player.currentStreak) player.currentStreak = { type: null, games: 0, bonus: 0 };
                    
                    const hadPoints = playerGameStats.goals + playerGameStats.assists > 0;
                    
                    if (hadPoints) {
                        if (player.currentStreak.type === 'point') {
                            player.currentStreak.games++;
                        } else {
                            player.currentStreak = { type: 'point', games: 1, bonus: 0 };
                        }
                        
                        if (player.currentStreak.games >= 15) {
                            player.currentStreak.bonus = 4;
                        } else if (player.currentStreak.games >= 10) {
                            player.currentStreak.bonus = 3;
                        } else if (player.currentStreak.games >= 5) {
                            player.currentStreak.bonus = 2;
                        } else {
                            player.currentStreak.bonus = 0;
                        }
                    } else {
                        if (player.currentStreak.type === 'scoreless') {
                            player.currentStreak.games++;
                        } else {
                            player.currentStreak = { type: 'scoreless', games: 1, bonus: 0 };
                        }
                        
                        if (player.currentStreak.games >= 10) {
                            player.currentStreak.bonus = -2;
                        } else {
                            player.currentStreak.bonus = 0;
                        }
                    }
                }
                
                // NEW: Update player development (playoffs count!)
                if (gameState.playerDevelopment && gameState.playerDevelopment[player.id]) {
                    const dev = gameState.playerDevelopment[player.id];
                    dev.currentOVR = player.ratings.overall;
                    dev.growth = dev.currentOVR - dev.startOVR;
                    dev.games++;
                    dev.lastChecked = gameState.currentDay;
                }
            }
        });
        
        return {
            homeTeam: isHomeGame ? matchup.home : matchup.away,
            awayTeam: isHomeGame ? matchup.away : matchup.home,
            homeScore: result.homeGoals,
            awayScore: result.awayGoals,
            winner: result.winner === 'home' ? (isHomeGame ? matchup.home : matchup.away) : (isHomeGame ? matchup.away : matchup.home),
            details: gameDetails
        };
    };
    
    const simulatePlayoffSeries = () => {
        simulatePlayoffSeriesWithPopup();
    };
    
    const simulatePlayoffSeriesWithPopup = async () => {
        if (!playoffState || playoffState.completed) return;
        
        setSimPopupVisible(true);
        stopSimulationRef.current = false;
        
        // Deep copy playoff state to avoid mutation
        let newState = {
            ...playoffState,
            eastMatchups: playoffState.eastMatchups.map(m => ({ ...m, games: [...(m.games || [])] })),
            westMatchups: playoffState.westMatchups.map(m => ({ ...m, games: [...(m.games || [])] })),
            finalMatchup: playoffState.finalMatchup ? { ...playoffState.finalMatchup, games: [...(playoffState.finalMatchup.games || [])] } : null,
            history: playoffState.history ? { ...playoffState.history } : {}
        };
        let gameCount = 0;
        
        // Count total games to simulate
        const countGames = (matchups) => {
            return matchups.reduce((total, m) => {
                const remaining = 7 - (m.homeWins + m.awayWins);
                const needed = Math.max(0, 4 - Math.max(m.homeWins, m.awayWins));
                return total + Math.min(remaining, needed + 3); // Max possible games
            }, 0);
        };
        
        // Handle Stanley Cup Finals (Round 4) separately
        if (newState.round === 4 && newState.finalMatchup) {
            const finalGamesToSim = 7 - (newState.finalMatchup.homeWins + newState.finalMatchup.awayWins);
            setSimPopupTotalDays(finalGamesToSim);
            
            if (newState.finalMatchup.homeWins < 4 && newState.finalMatchup.awayWins < 4) {
                const homeGamePattern = [true, true, false, false, true, false, true];
                
                while (newState.finalMatchup.homeWins < 4 && newState.finalMatchup.awayWins < 4) {
                    if (stopSimulationRef.current) break;
                    
                    const gameNum = newState.finalMatchup.homeWins + newState.finalMatchup.awayWins;
                    const isHomeGame = homeGamePattern[gameNum];
                    
                    gameCount++;
                    setSimPopupDay(gameCount);
                    setSimPopupGameDay(gameNum + 1);
                    
                    // Show teams before game
                    const homeTeam = TEAMS.find(t => t.id === newState.finalMatchup.home);
                    const awayTeam = TEAMS.find(t => t.id === newState.finalMatchup.away);
                    
                    if (!homeTeam || !awayTeam) {
                        console.error('Could not find teams for Stanley Cup Finals');
                        continue;
                    }
                    
                    setSimPopupGames([{
                        homeTeam: `${homeTeam.city} ${homeTeam.name}`,
                        awayTeam: `${awayTeam.city} ${awayTeam.name}`,
                        homeTeamId: newState.finalMatchup.home,
                        awayTeamId: newState.finalMatchup.away,
                        homeScore: '--',
                        awayScore: '--',
                        isUserTeam: newState.finalMatchup.home === userTeamId || newState.finalMatchup.away === userTeamId,
                        series: `Stanley Cup Finals - Game ${gameNum + 1}`,
                        seriesScore: `${newState.finalMatchup.homeWins}-${newState.finalMatchup.awayWins}`
                    }]);
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const game = simulatePlayoffGame(newState.finalMatchup, isHomeGame);
                    newState.finalMatchup.games.push(game);
                    
                    if (game.winner === newState.finalMatchup.home) {
                        newState.finalMatchup.homeWins++;
                    } else {
                        newState.finalMatchup.awayWins++;
                    }
                    
                    // Show result
                    setSimPopupGames([{
                        homeTeam: `${homeTeam.city} ${homeTeam.name}`,
                        awayTeam: `${awayTeam.city} ${awayTeam.name}`,
                        homeTeamId: newState.finalMatchup.home,
                        awayTeamId: newState.finalMatchup.away,
                        homeScore: game.homeScore,
                        awayScore: game.awayScore,
                        isUserTeam: newState.finalMatchup.home === userTeamId || newState.finalMatchup.away === userTeamId,
                        series: `Stanley Cup Finals - Game ${gameNum + 1}`,
                        seriesScore: `${newState.finalMatchup.homeWins}-${newState.finalMatchup.awayWins}`
                    }]);
                    
                    await new Promise(resolve => setTimeout(resolve, 700));
                }
                
                // Save to history
                if (!newState.history) newState.history = {};
                newState.history.final = { ...newState.finalMatchup };
                
                // Finals complete - calculate Playoff MVP
                const mvp = calculatePlayoffMVP(gameState.players);
                setPlayoffMVP(mvp);
                
                // Determine champion
                const champion = newState.finalMatchup.homeWins >= 4 ? newState.finalMatchup.home : newState.finalMatchup.away;
                newState.completed = true;
                newState.champion = champion;
                
                // Generate season summary
                const summary = generateSeasonSummary(gameState, newState, userTeamId);
                setSeasonSummary(summary);
                
                // Save season to history
                saveSeasonToHistory(gameState, newState, userTeamId);
                
                setPlayoffState(newState);
                setGameState({ ...gameState });
                
                setSimPopupDay(gameCount + 1);
                await new Promise(resolve => setTimeout(resolve, 500));
                setSimPopupVisible(false);
                
                // Navigate to playoff MVP view
                setCurrentView('playoffMVP');
            }
            
            return;
        }
        
        // Simulate conference rounds (Rounds 1-3)
        const totalGames = countGames([...newState.eastMatchups, ...newState.westMatchups]);
        setSimPopupTotalDays(totalGames);
        
        const simulateSeriesAsync = async (matchups, conference) => {
            const newMatchups = [];
            
            for (let i = 0; i < matchups.length; i++) {
                const matchup = matchups[i];
                
                if (matchup.homeWins >= 4 || matchup.awayWins >= 4) {
                    // Even for completed matchups, create a new object to ensure React detects the change
                    newMatchups.push({ ...matchup, games: [...matchup.games] });
                    continue;
                }
                
                const newMatchup = { ...matchup, games: [...matchup.games] };
                const homeGamePattern = [true, true, false, false, true, false, true];
                
                while (newMatchup.homeWins < 4 && newMatchup.awayWins < 4) {
                    if (stopSimulationRef.current) break;
                    
                    const gameNum = newMatchup.homeWins + newMatchup.awayWins;
                    const isHomeGame = homeGamePattern[gameNum];
                    
                    gameCount++;
                    setSimPopupDay(gameCount);
                    setSimPopupGameDay(gameNum + 1);
                    
                    // Show teams before game
                    const homeTeam = TEAMS.find(t => t.id === newMatchup.home);
                    if (!homeTeam) continue;
                    const awayTeam = TEAMS.find(t => t.id === newMatchup.away);
                    if (!awayTeam) continue;
                    const roundName = ['First Round', 'Second Round', 'Conference Finals'][newState.round - 1];
                    
                    setSimPopupGames([{
                        homeTeam: `${homeTeam.city} ${homeTeam.name}`,
                        awayTeam: `${awayTeam.city} ${awayTeam.name}`,
                        homeTeamId: newMatchup.home,
                        awayTeamId: newMatchup.away,
                        homeScore: '--',
                        awayScore: '--',
                        isUserTeam: newMatchup.home === userTeamId || newMatchup.away === userTeamId,
                        series: `${conference} ${roundName} - Game ${gameNum + 1}`,
                        seriesScore: `${newMatchup.homeWins}-${newMatchup.awayWins}`
                    }]);
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const game = simulatePlayoffGame(newMatchup, isHomeGame);
                    newMatchup.games.push(game);
                    
                    if (game.winner === newMatchup.home) {
                        newMatchup.homeWins++;
                    } else {
                        newMatchup.awayWins++;
                    }
                    
                    // Show result
                    setSimPopupGames([{
                        homeTeam: `${homeTeam.city} ${homeTeam.name}`,
                        awayTeam: `${awayTeam.city} ${awayTeam.name}`,
                        homeTeamId: newMatchup.home,
                        awayTeamId: newMatchup.away,
                        homeScore: game.homeScore,
                        awayScore: game.awayScore,
                        isUserTeam: newMatchup.home === userTeamId || newMatchup.away === userTeamId,
                        series: `${conference} ${roundName} - Game ${gameNum + 1}`,
                        seriesScore: `${newMatchup.homeWins}-${newMatchup.awayWins}`
                    }]);
                    
                    await new Promise(resolve => setTimeout(resolve, 700));
                }
                
                newMatchups.push(newMatchup);
            }
            
            return newMatchups;
        };
        
        newState.eastMatchups = await simulateSeriesAsync(newState.eastMatchups, 'Eastern');
        if (!stopSimulationRef.current) {
            newState.westMatchups = await simulateSeriesAsync(newState.westMatchups, 'Western');
        }
        
        // Check if round is complete
        const allComplete = [...newState.eastMatchups, ...newState.westMatchups].every(m => 
            m.homeWins >= 4 || m.awayWins >= 4
        );
        
        if (allComplete && !stopSimulationRef.current) {
            if (newState.round < 4) {
                // Advance to next round
                const getWinners = (matchups) => matchups.map(m => m.homeWins >= 4 ? m.home : m.away);
                const eastWinners = getWinners(newState.eastMatchups);
                const westWinners = getWinners(newState.westMatchups);
                
                // Save completed round to history
                if (!newState.history) newState.history = {};
                if (newState.round === 1) {
                    newState.history.eastRound1 = [...newState.eastMatchups];
                    newState.history.westRound1 = [...newState.westMatchups];
                } else if (newState.round === 2) {
                    newState.history.eastRound2 = [...newState.eastMatchups];
                    newState.history.westRound2 = [...newState.westMatchups];
                } else if (newState.round === 3) {
                    newState.history.eastRound3 = [...newState.eastMatchups];
                    newState.history.westRound3 = [...newState.westMatchups];
                }
                
                if (newState.round === 3) {
                    // Stanley Cup Final
                    newState.round = 4;
                    newState.finalMatchup = {
                        home: eastWinners[0],
                        away: westWinners[0],
                        homeWins: 0,
                        awayWins: 0,
                        games: []
                    };
                    newState.eastMatchups = [];
                    newState.westMatchups = [];
                } else {
                    // Next conference round
                    newState.round++;
                    const createNextRound = (winners) => {
                        if (winners.length === 4) {
                            return [
                                { home: winners[0], away: winners[3], homeWins: 0, awayWins: 0, games: [] },
                                { home: winners[1], away: winners[2], homeWins: 0, awayWins: 0, games: [] }
                            ];
                        } else {
                            return [
                                { home: winners[0], away: winners[1], homeWins: 0, awayWins: 0, games: [] }
                            ];
                        }
                    };
                    newState.eastMatchups = createNextRound(eastWinners);
                    newState.westMatchups = createNextRound(westWinners);
                }
                
                // Round advancement - no popup needed, bracket shows it
            }
        }
        
        setPlayoffState(newState);
        setGameState({ ...gameState });
        
        setSimPopupDay(gameCount + 1);
        setSimPopupVisible(false);
    };

    // NEW: Simulate all remaining playoff rounds
    const simulateAllPlayoffs = () => {
        if (!playoffState || playoffState.completed) return;
        
        // Turn on auto-simulation flag
        // The useEffect will handle the actual simulation round-by-round
        setIsAutoSimulatingPlayoffs(true);
    };

    const simulateOnePlayoffDay = () => {
        if (!playoffState || playoffState.completed) return;
        
        let newState = { ...playoffState };
        const homeGamePattern = [true, true, false, false, true, false, true];
        
        // Initialize playoff day tracker
        if (!newState.currentDay) newState.currentDay = 1;
        newState.lastDaySummary = null;
        
        // STANLEY CUP FINALS (Round 4) - one game per day
        if (newState.round === 4 && newState.finalMatchup) {
            if (newState.finalMatchup.homeWins < 4 && newState.finalMatchup.awayWins < 4) {
                const gameNum = newState.finalMatchup.homeWins + newState.finalMatchup.awayWins;
                const isHomeGame = homeGamePattern[gameNum];
                const game = simulatePlayoffGame(newState.finalMatchup, isHomeGame);
                newState.finalMatchup.games.push(game);
                
                if (game.winner === newState.finalMatchup.home) {
                    newState.finalMatchup.homeWins++;
                } else {
                    newState.finalMatchup.awayWins++;
                }
                
                const homeTeam = TEAMS.find(t => t.id === newState.finalMatchup.home);
                const awayTeam = TEAMS.find(t => t.id === newState.finalMatchup.away);
                
                if (!homeTeam || !awayTeam) {
                    console.error('Could not find teams for Stanley Cup Finals');
                    setPlayoffState(newState);
                    return;
                }
                
                const winner = game.winner === newState.finalMatchup.home ? homeTeam : awayTeam;
                const loser = game.winner === newState.finalMatchup.home ? awayTeam : homeTeam;
                
                // Check if finals complete
                if (newState.finalMatchup.homeWins >= 4 || newState.finalMatchup.awayWins >= 4) {
                    if (!newState.history) newState.history = {};
                    newState.history.final = { ...newState.finalMatchup };
                    const champion = newState.finalMatchup.homeWins >= 4 ? homeTeam : awayTeam;
                    newState.completed = true;
                    
                    newState.lastDaySummary = {
                        title: `üèÜ Stanley Cup Finals - Game ${gameNum + 1} üèÜ`,
                        conference: 'Finals',
                        results: [{
                            homeTeam, awayTeam,
                            homeScore: game.homeScore,
                            awayScore: game.awayScore,
                            winner, loser,
                            homeWins: newState.finalMatchup.homeWins,
                            awayWins: newState.finalMatchup.awayWins,
                            seriesComplete: true,
                            champion: champion.city + ' ' + champion.name
                        }]
                    };
                } else {
                    newState.lastDaySummary = {
                        title: `üèÜ Stanley Cup Finals - Game ${gameNum + 1} üèÜ`,
                        conference: 'Finals',
                        results: [{
                            homeTeam, awayTeam,
                            homeScore: game.homeScore,
                            awayScore: game.awayScore,
                            winner, loser,
                            homeWins: newState.finalMatchup.homeWins,
                            awayWins: newState.finalMatchup.awayWins,
                            seriesComplete: false
                        }]
                    };
                }
                
                newState.currentDay++;
            }
            
            setPlayoffState(newState);
            setGameState({ ...gameState });
            return;
        }
        
        // CONFERENCE ROUNDS - alternate East/West by day
        const isEastDay = newState.currentDay % 2 === 1;
        const conference = isEastDay ? 'East' : 'West';
        const matchups = isEastDay ? newState.eastMatchups : newState.westMatchups;
        const incompleteSeries = matchups.filter(m => m.homeWins < 4 && m.awayWins < 4);
        
        if (incompleteSeries.length === 0) {
            // This conference has no games
            const otherMatchups = isEastDay ? newState.westMatchups : newState.eastMatchups;
            const otherIncompleteSeries = otherMatchups.filter(m => m.homeWins < 4 && m.awayWins < 4);
            
            if (otherIncompleteSeries.length === 0) {
                // BOTH conferences done - advance round
                const getWinners = (matchups) => matchups.map(m => m.homeWins >= 4 ? m.home : m.away);
                const eastWinners = getWinners(newState.eastMatchups);
                const westWinners = getWinners(newState.westMatchups);
                
                // Save to history
                if (!newState.history) newState.history = {};
                if (newState.round === 1) {
                    newState.history.eastRound1 = [...newState.eastMatchups];
                    newState.history.westRound1 = [...newState.westMatchups];
                } else if (newState.round === 2) {
                    newState.history.eastRound2 = [...newState.eastMatchups];
                    newState.history.westRound2 = [...newState.westMatchups];
                } else if (newState.round === 3) {
                    newState.history.eastRound3 = [...newState.eastMatchups];
                    newState.history.westRound3 = [...newState.westMatchups];
                }
                
                if (newState.round === 3) {
                    // Create Stanley Cup Finals
                    newState.round = 4;
                    newState.finalMatchup = {
                        home: eastWinners[0],
                        away: westWinners[0],
                        homeWins: 0,
                        awayWins: 0,
                        games: []
                    };
                    newState.eastMatchups = [];
                    newState.westMatchups = [];
                    newState.currentDay = 1;
                    
                    const homeTeam = TEAMS.find(t => t.id === newState.finalMatchup.home);
                    if (!homeTeam) return;
                    const awayTeam = TEAMS.find(t => t.id === newState.finalMatchup.away);
                    if (!awayTeam) return;
                    newState.lastDaySummary = {
                        title: 'üèÜ Conference Finals Complete! üèÜ',
                        conference: 'Finals Setup',
                        message: `Stanley Cup Finals: ${awayTeam.city} @ ${homeTeam.city}`,
                        restDays: 2
                    };
                } else {
                    // Advance to next round
                    newState.round++;
                    const createNextRound = (winners) => {
                        if (winners.length === 4) {
                            return [
                                { home: winners[0], away: winners[3], homeWins: 0, awayWins: 0, games: [] },
                                { home: winners[1], away: winners[2], homeWins: 0, awayWins: 0, games: [] }
                            ];
                        } else {
                            return [{ home: winners[0], away: winners[1], homeWins: 0, awayWins: 0, games: [] }];
                        }
                    };
                    newState.eastMatchups = createNextRound(eastWinners);
                    newState.westMatchups = createNextRound(westWinners);
                    newState.currentDay = 1;
                    
                    newState.lastDaySummary = {
                        title: `Round ${newState.round - 1} Complete!`,
                        conference: 'Round Transition',
                        message: `Round ${newState.round} (${newState.round === 2 ? 'Conference Semifinals' : 'Conference Finals'}) begins in 2 days`,
                        restDays: 2
                    };
                }
            } else {
                // This conference done, waiting for other
                newState.currentDay++;
                newState.lastDaySummary = {
                    title: `${conference}ern Conference - Day ${newState.currentDay - 1}`,
                    conference,
                    message: `No games today (all series completed). Waiting for ${isEastDay ? 'Western' : 'Eastern'} Conference.`
                };
            }
            
            setPlayoffState(newState);
            setGameState({ ...gameState });
            return;
        }
        
        // SIMULATE ONE GAME for each incomplete series
        const results = [];
        
        incompleteSeries.forEach(matchup => {
            const gameNum = matchup.homeWins + matchup.awayWins;
            const isHomeGame = homeGamePattern[gameNum];
            const game = simulatePlayoffGame(matchup, isHomeGame);
            matchup.games.push(game);
            
            if (game.winner === matchup.home) {
                matchup.homeWins++;
            } else {
                matchup.awayWins++;
            }
            
            const homeTeam = TEAMS.find(t => t.id === matchup.home);
            const awayTeam = TEAMS.find(t => t.id === matchup.away);
            const winner = game.winner === matchup.home ? homeTeam : awayTeam;
            const loser = game.winner === matchup.home ? awayTeam : homeTeam;
            const seriesComplete = matchup.homeWins >= 4 || matchup.awayWins >= 4;
            
            results.push({
                homeTeam, awayTeam,
                homeScore: game.homeScore,
                awayScore: game.awayScore,
                winner, loser,
                homeWins: matchup.homeWins,
                awayWins: matchup.awayWins,
                seriesComplete
            });
        });
        
        // Store summary
        newState.lastDaySummary = {
            title: `${conference}ern Conference - Day ${newState.currentDay}`,
            subtitle: `Round ${newState.round} ${newState.round === 1 ? '(First Round)' : newState.round === 2 ? '(Conference Semifinals)' : '(Conference Finals)'}`,
            conference,
            results
        };
        
        newState.currentDay++;
        setPlayoffState(newState);
        setGameState({ ...gameState });
    };


    // HELPER: Update player stats after a game (used by all simulation functions)
    const updatePlayerStatsAfterGame = (player, pgs, matchup, result, gameState) => {
        if (!player) return;
        
        if (player.position === 'G') {
            if (pgs.shotsAgainst > 0) {
                player.stats.gamesPlayed++;
                player.stats.timeOnIce += pgs.toi;
                player.stats.saves = (player.stats.saves || 0) + pgs.saves;
                player.stats.goalsAgainst = (player.stats.goalsAgainst || 0) + pgs.goalsAgainst;
                player.stats.shotsAgainst = (player.stats.shotsAgainst || 0) + pgs.shotsAgainst;
                
                const isWin = (player.teamId === matchup.homeTeam && result.winner === 'home') ||
                             (player.teamId === matchup.awayTeam && result.winner === 'away');
                
                if (isWin) {
                    player.stats.wins = (player.stats?.wins || 0) + 1;
                } else {
                    player.stats.losses = (player.stats?.losses || 0) + 1;
                }
                
                if (pgs.goalsAgainst === 0) {
                    player.stats.shutouts = (player.stats.shutouts || 0) + 1;
                }
                
                player.stats.savePercentage = player.stats.saves / (player.stats.shotsAgainst || 1);
                player.stats.gaa = (player.stats.goalsAgainst / (player.stats.gamesPlayed || 1)) * 1.0;
            }
        } else {
            player.stats.gamesPlayed++;
            player.stats.goals += pgs.goals;
            player.stats.assists += pgs.assists;
            player.stats.points += pgs.points;
            player.stats.plusMinus += pgs.plusMinus;
            player.stats.pim += pgs.pim;
            player.stats.shots += pgs.shots;
            player.stats.timeOnIce += pgs.toi;
            
            // Update advanced stats
            if (pgs.corsiFor !== undefined) {
                player.stats.corsiFor = (player.stats.corsiFor || 0) + pgs.corsiFor;
                player.stats.corsiAgainst = (player.stats.corsiAgainst || 0) + pgs.corsiAgainst;
                const totalCorsi = player.stats.corsiFor + player.stats.corsiAgainst;
                player.stats.corsiPercent = totalCorsi > 0 ? (player.stats.corsiFor / totalCorsi * 100) : 50;
                
                player.stats.fenwickFor = (player.stats.fenwickFor || 0) + pgs.fenwickFor;
                player.stats.fenwickAgainst = (player.stats.fenwickAgainst || 0) + pgs.fenwickAgainst;
                const totalFenwick = player.stats.fenwickFor + player.stats.fenwickAgainst;
                player.stats.fenwickPercent = totalFenwick > 0 ? (player.stats.fenwickFor / totalFenwick * 100) : 50;
                
                player.stats.hits = (player.stats.hits || 0) + pgs.hits;
                player.stats.blockedShots = (player.stats.blockedShots || 0) + pgs.blockedShots;
                player.stats.takeaways = (player.stats.takeaways || 0) + pgs.takeaways;
                player.stats.giveaways = (player.stats.giveaways || 0) + pgs.giveaways;
                
                if (pgs.faceoffWins !== undefined) {
                    player.stats.faceoffWins = (player.stats.faceoffWins || 0) + pgs.faceoffWins;
                    player.stats.faceoffLosses = (player.stats.faceoffLosses || 0) + pgs.faceoffLosses;
                    const totalFaceoffs = player.stats.faceoffWins + player.stats.faceoffLosses;
                    player.stats.faceoffPercent = totalFaceoffs > 0 ? (player.stats.faceoffWins / totalFaceoffs * 100) : 0;
                }
            }
        }
        
        // Check for injury
        const injury = checkForInjury(player, pgs.toi);
        if (injury) {
            player.injury = injury;
            
            // Track injury in milestones for aging calculation
            if (!player.milestones) player.milestones = [];
            player.milestones.push({
                type: 'injury',
                injuryType: injury.type,
                severity: injury.severity,
                season: gameState.season,
                day: gameState.currentDay
            });
            
            autoCallUpReplacement(gameState.players, player);
        }
        
        // Check milestones
        checkMilestones(player, gameState);
    };

    const simulateDay82 = (stateToUse = null) => {
        const currentState = stateToUse || gameState;
        if (!currentState || !currentState.schedule) return;
        
        // Track simulation start
        trackEvent('simulation_started', {
            current_day: currentState.currentDay,
            season: currentState.season
        });
        
        // Check if season complete
        if (currentState.currentDay > 82) {
            trackEvent('season_completed', {
                season: currentState.season,
                team: TEAMS.find(t => t.id === userTeamId)?.name
            });
            const awards = calculateAwards(currentState.players, currentState.standings);
            setSeasonAwards(awards);
            setCurrentView('awards');
            return;
        }
        
        let newPlayers = [...currentState.players];
        const newStandings = [...currentState.standings];
        const newSchedule = currentState.schedule.map(day => ({
            ...day,
            matchups: day.matchups.map(m => ({ ...m })) // Deep copy matchups
        }));
        const newHeadToHead = { ...currentState.headToHead };
        
        // Get current day's matchups from the NEW schedule
        // Special case: if currentDay is 0 (pre-season), we want to simulate day 1
        const dayToSimulate = currentState.currentDay === 0 ? 1 : currentState.currentDay;
        const currentDaySchedule = newSchedule.find(d => d.day === dayToSimulate);
        if (!currentDaySchedule || !currentDaySchedule.matchups) {
            alert('No games scheduled for this day');
            return;
        }
        
        const dayMatchups = currentDaySchedule.matchups;
        const dayResults = [];
        
        dayMatchups.forEach(matchup => {
            if (matchup.played) return;
            
            // Get players for both teams
            const homePlayers = newPlayers.filter(p => 
                p.teamId === matchup.homeTeam &&
                p.roster === 'nhl' &&
                !p.injury.injured &&
                (p.position === 'G' ? p.dressed : p.lineNumber > 0)
            );
            
            const awayPlayers = newPlayers.filter(p => 
                p.teamId === matchup.awayTeam &&
                p.roster === 'nhl' &&
                !p.injury.injured &&
                (p.position === 'G' ? p.dressed : p.lineNumber > 0)
            );
            
            // Simulate game
            const result = simulateGameResult(homePlayers, awayPlayers);
            
            // Update matchup with complete game details
            matchup.played = true;
            matchup.homeScore = result.homeGoals;
            matchup.awayScore = result.awayGoals;
            matchup.homeStats = result.homePlayerStats;
            matchup.awayStats = result.awayPlayerStats;
            matchup.periodScoring = result.periodScoring;
            matchup.details = {
                scoringSummary: result.scoringSummary,
                penaltyLog: result.penaltyLog,
                teamStats: result.teamStats,
                homePlayerStats: result.homePlayerStats,
                awayPlayerStats: result.awayPlayerStats
            };
            
            // Update standings
            const homeStanding = newStandings.find(s => s.teamId === matchup.homeTeam);
            const awayStanding = newStandings.find(s => s.teamId === matchup.awayTeam);
            
            if (!homeStanding || !awayStanding) {
                console.error('Could not find standings for teams in newStandings:', matchup.homeTeam, matchup.awayTeam);
                return;
            }
            
            homeStanding.goalsFor += result.homeGoals;
            homeStanding.goalsAgainst += result.awayGoals;
            awayStanding.goalsFor += result.awayGoals;
            awayStanding.goalsAgainst += result.homeGoals;
            
            homeStanding.teamStats.gamesPlayed++;
            awayStanding.teamStats.gamesPlayed++;
            
            if (result.winner === 'home') {
                homeStanding.wins++;
                homeStanding.home.wins++;
                homeStanding.points += 2;
                
                // Check if away team gets OT loss point
                if (result.isOvertimeGame) {
                    awayStanding.otLosses++;
                    awayStanding.away.losses++; // Still counts as away loss in home/away record
                    awayStanding.points += 1; // OT loss gets 1 point
                } else {
                    awayStanding.losses++;
                    awayStanding.away.losses++;
                }
            } else {
                awayStanding.wins++;
                awayStanding.away.wins++;
                awayStanding.points += 2;
                
                // Check if home team gets OT loss point
                if (result.isOvertimeGame) {
                    homeStanding.otLosses++;
                    homeStanding.home.losses++; // Still counts as home loss in home/away record
                    homeStanding.points += 1; // OT loss gets 1 point
                } else {
                    homeStanding.losses++;
                    homeStanding.home.losses++;
                }
            }
            
            // Update head-to-head record
            const h2hKey = matchup.homeTeam < matchup.awayTeam ? 
                `${matchup.homeTeam}vs${matchup.awayTeam}` : 
                `${matchup.awayTeam}vs${matchup.homeTeam}`;
            
            if (!newHeadToHead[h2hKey]) {
                newHeadToHead[h2hKey] = {
                    team1: matchup.homeTeam < matchup.awayTeam ? matchup.homeTeam : matchup.awayTeam,
                    team2: matchup.homeTeam < matchup.awayTeam ? matchup.awayTeam : matchup.homeTeam,
                    team1Wins: 0,
                    team2Wins: 0
                };
            }
            
            // Increment win count for winner
            if (result.winner === 'home') {
                if (matchup.homeTeam === newHeadToHead[h2hKey].team1) {
                    newHeadToHead[h2hKey].team1Wins++;
                } else {
                    newHeadToHead[h2hKey].team2Wins++;
                }
            } else {
                if (matchup.awayTeam === newHeadToHead[h2hKey].team1) {
                    newHeadToHead[h2hKey].team1Wins++;
                } else {
                    newHeadToHead[h2hKey].team2Wins++;
                }
            }
            
            // Update player stats
            [...result.homePlayerStats, ...result.awayPlayerStats].forEach(playerGameStats => {
                const player = newPlayers.find(p => p.id === playerGameStats.player.id);
                if (!player) return;
                
                if (player.position === 'G') {
                    if (playerGameStats.shotsAgainst > 0) {
                        player.stats.gamesPlayed++;
                        player.stats.timeOnIce += playerGameStats.toi;
                        player.stats.saves = (player.stats.saves || 0) + playerGameStats.saves;
                        player.stats.goalsAgainst = (player.stats.goalsAgainst || 0) + playerGameStats.goalsAgainst;
                        player.stats.shotsAgainst = (player.stats.shotsAgainst || 0) + playerGameStats.shotsAgainst;
                        
                        const isWin = (player.teamId === matchup.homeTeam && result.winner === 'home') ||
                                     (player.teamId === matchup.awayTeam && result.winner === 'away');
                        
                        if (isWin) {
                            player.stats.wins = (player.stats?.wins || 0) + 1;
                        } else {
                            player.stats.losses = (player.stats?.losses || 0) + 1;
                        }
                        
                        if (playerGameStats.goalsAgainst === 0) {
                            player.stats.shutouts = (player.stats.shutouts || 0) + 1;
                        }
                        
                        player.stats.savePercentage = player.stats.saves / (player.stats.shotsAgainst || 1);
                        player.stats.gaa = (player.stats.goalsAgainst / (player.stats.gamesPlayed || 1)) * 1.0;
                    }
                } else {
                    player.stats.gamesPlayed++;
                    player.stats.goals += playerGameStats.goals;
                    player.stats.assists += playerGameStats.assists;
                    player.stats.points += playerGameStats.points;
                    player.stats.plusMinus += playerGameStats.plusMinus;
                    player.stats.pim += playerGameStats.pim;
                    player.stats.shots += playerGameStats.shots;
                    player.stats.timeOnIce += playerGameStats.toi;
                    
                    // Track last game goals for milestone detection
                    player.lastGameGoals = playerGameStats.goals;
                    
                    // Update advanced stats
                    if (playerGameStats.corsiFor !== undefined) {
                        player.stats.corsiFor = (player.stats.corsiFor || 0) + playerGameStats.corsiFor;
                        player.stats.corsiAgainst = (player.stats.corsiAgainst || 0) + playerGameStats.corsiAgainst;
                        const totalCorsi = player.stats.corsiFor + player.stats.corsiAgainst;
                        player.stats.corsiPercent = totalCorsi > 0 ? (player.stats.corsiFor / totalCorsi * 100) : 50;
                        
                        player.stats.fenwickFor = (player.stats.fenwickFor || 0) + playerGameStats.fenwickFor;
                        player.stats.fenwickAgainst = (player.stats.fenwickAgainst || 0) + playerGameStats.fenwickAgainst;
                        const totalFenwick = player.stats.fenwickFor + player.stats.fenwickAgainst;
                        player.stats.fenwickPercent = totalFenwick > 0 ? (player.stats.fenwickFor / totalFenwick * 100) : 50;
                        
                        player.stats.hits = (player.stats.hits || 0) + playerGameStats.hits;
                        player.stats.blockedShots = (player.stats.blockedShots || 0) + playerGameStats.blockedShots;
                        player.stats.takeaways = (player.stats.takeaways || 0) + playerGameStats.takeaways;
                        player.stats.giveaways = (player.stats.giveaways || 0) + playerGameStats.giveaways;
                        
                        if (playerGameStats.faceoffWins !== undefined) {
                            player.stats.faceoffWins = (player.stats.faceoffWins || 0) + playerGameStats.faceoffWins;
                            player.stats.faceoffLosses = (player.stats.faceoffLosses || 0) + playerGameStats.faceoffLosses;
                            const totalFaceoffs = player.stats.faceoffWins + player.stats.faceoffLosses;
                            player.stats.faceoffPercent = totalFaceoffs > 0 ? (player.stats.faceoffWins / totalFaceoffs * 100) : 0;
                        }
                    }
                }
                
                // Check for injury
                const injury = checkForInjury(player, playerGameStats.toi);
                if (injury) {
                    player.injury = injury;
                    
                    // Track injury in milestones for aging calculation
                    if (!player.milestones) player.milestones = [];
                    player.milestones.push({
                        type: 'injury',
                        injuryType: injury.type,
                        severity: injury.severity,
                        season: currentState.season,
                        day: currentState.currentDay
                    });
                    
                    autoCallUpReplacement(newPlayers, player);
                }
                
                checkMilestones(player, currentState);
            });
            
            dayResults.push({
                homeTeam: TEAMS.find(t => t.id === matchup.homeTeam),
                awayTeam: TEAMS.find(t => t.id === matchup.awayTeam),
                homeScore: result.homeGoals,
                awayScore: result.awayGoals,
                winner: result.winner,
                isOvertimeGame: result.isOvertimeGame
            });
            
            // Add game highlight notification for user's team
            if (matchup.homeTeam === userTeamId || matchup.awayTeam === userTeamId) {
                const userIsHome = matchup.homeTeam === userTeamId;
                const userScore = userIsHome ? result.homeGoals : result.awayGoals;
                const oppScore = userIsHome ? result.awayGoals : result.homeGoals;
                const opponent = TEAMS.find(t => t.id === (userIsHome ? matchup.awayTeam : matchup.homeTeam));
                const won = userScore > oppScore;
                
                addUniqueNotification({
                    type: 'gameResult',
                    icon: won ? '‚úÖ' : '‚ùå',
                    title: won ? `Victory! ${userScore}-${oppScore}` : `Loss ${userScore}-${oppScore}`,
                    message: `${userIsHome ? 'vs' : '@'} ${opponent.city} ${opponent.name}${result.isOvertimeGame ? ' (OT)' : ''}`,
                    color: won ? '#22c55e' : '#ef4444',
                    day: dayToSimulate,
                    timestamp: Date.now()
                });
            }
        });
        
        // Process AI trades (chance each day before trade deadline)
        const tradeDeadlineDay = 56;
        let tradeHistory = currentState.tradeHistory;
        let aiTradeLog = currentState.aiTradeLog;
        let teamTradeCount = currentState.teamTradeCount;
        
        if (currentState.currentDay <= tradeDeadlineDay) {
            // Calculate current game number
            const teamGamesPlayed = {};
            TEAMS.forEach(t => teamGamesPlayed[t.id] = 0);
            
            // Iterate through schedule structure correctly
            newSchedule.forEach(daySchedule => {
                daySchedule.matchups.forEach(matchup => {
                    if (matchup.played) {
                        teamGamesPlayed[matchup.homeTeam]++;
                        teamGamesPlayed[matchup.awayTeam]++;
                    }
                });
            });
            
            const avgGamesPlayed = Object.values(teamGamesPlayed).reduce((a, b) => a + b, 0) / TEAMS.length;
            const gameNumber = Math.floor(avgGamesPlayed);
            
            // Process AI trades and update the state
            const tradeState = {
                ...currentState,
                players: newPlayers,
                standings: newStandings,
                schedule: newSchedule
            };
            processAITrades(tradeState, gameNumber, userTeamId);
            
            // Update players AND trade data with any trades that occurred
            newPlayers = tradeState.players;
            tradeHistory = tradeState.tradeHistory;
            aiTradeLog = tradeState.aiTradeLog;
            teamTradeCount = tradeState.teamTradeCount;
        }
        
        // Update injuries - decrease recovery time by 1 day
        updateInjuries(newPlayers);
        
        // Advance to next day
        // Special case: if we're at day 0, advance to day 1 (not day 1 to day 2)
        const nextDay = currentState.currentDay === 0 ? 1 : currentState.currentDay + 1;
        const updatedState = {
            ...currentState,
            players: newPlayers,
            standings: newStandings,
            schedule: newSchedule,
            headToHead: newHeadToHead,
            currentDay: nextDay,
            lastGameDay: dayToSimulate,
            // Preserve trade data from processAITrades
            tradeHistory: tradeHistory,
            aiTradeLog: aiTradeLog,
            teamTradeCount: teamTradeCount
        };
        
        // Update team profiles
        if (updatedState.teamProfiles) {
            updatedState.teamProfiles = updateTeamProfiles(
                updatedState.teamProfiles,
                newStandings,
                newSchedule,
                newPlayers,
                updatedState.currentDay
            );
        }
        
        setGameState(updatedState);
        
        // Track trade count before checks
        const previousTradeCount = gameState.tradeHistory?.length || 0;
        const currentTradeCount = updatedState.tradeHistory?.length || 0;
        
        // Check for season events after state is set
        setTimeout(() => {
            checkPlayerMilestones();
            checkTradeDeadline();
            checkInjuries();
            checkAITrades(previousTradeCount, currentTradeCount);
            checkPlayoffStatus();
        }, 100);
        
        return updatedState; // Return for popup to use
    };
    
    const simulate7Games = () => {
        if (!gameState) return;
        
        let currentState = { ...gameState };
        let gamesPlayed = 0;
        const targetGames = 7;
        
        // Keep simulating days until user team has played 7 games
        while (gamesPlayed < targetGames && currentState.currentDay <= 82) {
            const currentDaySchedule = currentState.schedule.find(d => d.day === currentState.currentDay);
            if (!currentDaySchedule) break;
            
            // Process AI trades BEFORE simulating games for the day
            const tradeDeadlineDay = 56;
            if (currentState.currentDay <= tradeDeadlineDay) {
                // Calculate current game number
                const teamGamesPlayed = {};
                TEAMS.forEach(t => teamGamesPlayed[t.id] = 0);
                
                currentState.schedule.forEach(daySchedule => {
                    daySchedule.matchups.forEach(matchup => {
                        if (matchup.played) {
                            teamGamesPlayed[matchup.homeTeam]++;
                            teamGamesPlayed[matchup.awayTeam]++;
                        }
                    });
                });
                
                const avgGamesPlayed = Object.values(teamGamesPlayed).reduce((a, b) => a + b, 0) / TEAMS.length;
                const gameNumber = Math.floor(avgGamesPlayed);
                
                processAITrades(currentState, gameNumber, userTeamId);
            }
            
            // Check if user team plays today
            const userTeamMatchup = currentDaySchedule.matchups.find(m => 
                (m.homeTeam === userTeamId || m.awayTeam === userTeamId) && !m.played
            );
            
            // Simulate all matchups for this day
            currentDaySchedule.matchups.forEach(matchup => {
                if (matchup.played) return;
                
                const homePlayers = currentState.players.filter(p => 
                    p.teamId === matchup.homeTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const awayPlayers = currentState.players.filter(p => 
                    p.teamId === matchup.awayTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const result = simulateGameResult(homePlayers, awayPlayers);
                
                matchup.played = true;
                matchup.homeScore = result.homeGoals;
                matchup.awayScore = result.awayGoals;
                matchup.homeStats = result.homePlayerStats;
                matchup.awayStats = result.awayPlayerStats;
                matchup.periodScoring = result.periodScoring;
                matchup.details = {
                    scoringSummary: result.scoringSummary,
                    penaltyLog: result.penaltyLog,
                    teamStats: result.teamStats,
                    homePlayerStats: result.homePlayerStats,
                    awayPlayerStats: result.awayPlayerStats
                };
                
                const homeStanding = currentState.standings.find(s => s.teamId === matchup.homeTeam);
                const awayStanding = currentState.standings.find(s => s.teamId === matchup.awayTeam);
                
                if (!homeStanding || !awayStanding) {
                    console.error('Could not find standings for sim matchup:', matchup.homeTeam, matchup.awayTeam);
                    return;
                }
                
                homeStanding.goalsFor += result.homeGoals;
                homeStanding.goalsAgainst += result.awayGoals;
                awayStanding.goalsFor += result.awayGoals;
                awayStanding.goalsAgainst += result.homeGoals;
                homeStanding.teamStats.gamesPlayed++;
                awayStanding.teamStats.gamesPlayed++;
                
                if (result.winner === 'home') {
                    homeStanding.wins++;
                    homeStanding.home.wins++;
                    homeStanding.points += 2;
                    awayStanding.losses++;
                    awayStanding.away.losses++;
                } else {
                    awayStanding.wins++;
                    awayStanding.away.wins++;
                    awayStanding.points += 2;
                    homeStanding.losses++;
                    homeStanding.home.losses++;
                }
                
                // Update head-to-head record
                updateHeadToHead(currentState.headToHead, matchup.homeTeam, matchup.awayTeam, result.winner);
                
                [...result.homePlayerStats, ...result.awayPlayerStats].forEach(pgs => {
                    const player = currentState.players.find(p => p.id === pgs.player.id);
                    updatePlayerStatsAfterGame(player, pgs, matchup, result, currentState);
                });
            });
            
            // If user team played, increment counter
            if (userTeamMatchup) {
                gamesPlayed++;
            }
            
            // Update injuries - decrease recovery time by 1 day
            updateInjuries(currentState.players);
            
            // Increment day, but cap at 83 (one past the end to indicate season complete)
            currentState.currentDay++;
            if (currentState.currentDay > 83) {
                currentState.currentDay = 83;
            }
        }
        
        // Update team profiles
        if (currentState.teamProfiles) {
            currentState.teamProfiles = updateTeamProfiles(
                currentState.teamProfiles,
                currentState.standings,
                currentState.schedule,
                currentState.players,
                currentState.currentDay
            );
        }
        
        setGameState(currentState);
    };
    
    const simulate30Games = () => {
        if (!gameState) return;
        
        let currentState = { ...gameState };
        let gamesPlayed = 0;
        const targetGames = 30;
        
        while (gamesPlayed < targetGames && currentState.currentDay <= 82) {
            const currentDaySchedule = currentState.schedule.find(d => d.day === currentState.currentDay);
            if (!currentDaySchedule) break;
            
            const userTeamMatchup = currentDaySchedule.matchups.find(m => 
                (m.homeTeam === userTeamId || m.awayTeam === userTeamId) && !m.played
            );
            
            currentDaySchedule.matchups.forEach(matchup => {
                if (matchup.played) return;
                
                const homePlayers = currentState.players.filter(p => 
                    p.teamId === matchup.homeTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const awayPlayers = currentState.players.filter(p => 
                    p.teamId === matchup.awayTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const result = simulateGameResult(homePlayers, awayPlayers);
                
                matchup.played = true;
                matchup.homeScore = result.homeGoals;
                matchup.awayScore = result.awayGoals;
                matchup.homeStats = result.homePlayerStats;
                matchup.awayStats = result.awayPlayerStats;
                matchup.periodScoring = result.periodScoring;
                matchup.details = {
                    scoringSummary: result.scoringSummary,
                    penaltyLog: result.penaltyLog,
                    teamStats: result.teamStats,
                    homePlayerStats: result.homePlayerStats,
                    awayPlayerStats: result.awayPlayerStats
                };
                
                const homeStanding = currentState.standings.find(s => s.teamId === matchup.homeTeam);
                const awayStanding = currentState.standings.find(s => s.teamId === matchup.awayTeam);
                
                if (!homeStanding || !awayStanding) {
                    console.error('Could not find standings for auto-sim:', matchup.homeTeam, matchup.awayTeam);
                    return;
                }
                
                homeStanding.goalsFor += result.homeGoals;
                homeStanding.goalsAgainst += result.awayGoals;
                awayStanding.goalsFor += result.awayGoals;
                awayStanding.goalsAgainst += result.homeGoals;
                homeStanding.teamStats.gamesPlayed++;
                awayStanding.teamStats.gamesPlayed++;
                
                if (result.winner === 'home') {
                    homeStanding.wins++; homeStanding.home.wins++; homeStanding.points += 2;
                    awayStanding.losses++; awayStanding.away.losses++;
                } else {
                    awayStanding.wins++; awayStanding.away.wins++; awayStanding.points += 2;
                    homeStanding.losses++; homeStanding.home.losses++;
                }
                
                // Update head-to-head record
                updateHeadToHead(currentState.headToHead, matchup.homeTeam, matchup.awayTeam, result.winner);
                
                [...result.homePlayerStats, ...result.awayPlayerStats].forEach(pgs => {
                    const player = currentState.players.find(p => p.id === pgs.player.id);
                    updatePlayerStatsAfterGame(player, pgs, matchup, result, currentState);
                });
            });
            
            if (userTeamMatchup) {
                gamesPlayed++;
            }
            
            currentState.currentDay++;
            if (currentState.currentDay > 83) {
                currentState.currentDay = 83;
            }
        }
        
        // Update team profiles
        if (currentState.teamProfiles) {
            currentState.teamProfiles = updateTeamProfiles(
                currentState.teamProfiles,
                currentState.standings,
                currentState.schedule,
                currentState.players,
                currentState.currentDay
            );
        }
        
        setGameState(currentState);
    };
    
    // Keep old function for backward compatibility
    const simulate7Days82 = () => {
        if (!gameState) return;
        
        let currentState = { ...gameState };
        
        for (let i = 0; i < 7; i++) {
            if (currentState.currentDay > 82) break;
            
            // Get current day's matchups
            const currentDaySchedule = currentState.schedule.find(d => d.day === currentState.currentDay);
            if (!currentDaySchedule) break;
            
            // Simulate the day (inline to avoid state issues)
            const dayMatchups = currentDaySchedule.matchups;
            
            dayMatchups.forEach(matchup => {
                if (matchup.played) return;
                
                const homePlayers = currentState.players.filter(p => 
                    p.teamId === matchup.homeTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const awayPlayers = currentState.players.filter(p => 
                    p.teamId === matchup.awayTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const result = simulateGameResult(homePlayers, awayPlayers);
                
                matchup.played = true;
                matchup.homeScore = result.homeGoals;
                matchup.awayScore = result.awayGoals;
                
                // Update standings (simplified)
                const homeStanding = currentState.standings.find(s => s.teamId === matchup.homeTeam);
                const awayStanding = currentState.standings.find(s => s.teamId === matchup.awayTeam);
                
                if (!homeStanding || !awayStanding) {
                    console.error('Could not find standings for season sim:', matchup.homeTeam, matchup.awayTeam);
                    return;
                }
                
                homeStanding.goalsFor += result.homeGoals;
                homeStanding.goalsAgainst += result.awayGoals;
                awayStanding.goalsFor += result.awayGoals;
                awayStanding.goalsAgainst += result.homeGoals;
                homeStanding.teamStats.gamesPlayed++;
                awayStanding.teamStats.gamesPlayed++;
                
                if (result.winner === 'home') {
                    homeStanding.wins++;
                    homeStanding.home.wins++;
                    homeStanding.points += 2;
                    awayStanding.losses++;
                    awayStanding.away.losses++;
                } else {
                    awayStanding.wins++;
                    awayStanding.away.wins++;
                    awayStanding.points += 2;
                    homeStanding.losses++;
                    homeStanding.home.losses++;
                }
                
                // Update player stats (simplified)
                [...result.homePlayerStats, ...result.awayPlayerStats].forEach(pgs => {
                    const player = currentState.players.find(p => p.id === pgs.player.id);
                    updatePlayerStatsAfterGame(player, pgs, matchup, result, currentState);
                });
            });
            
            // Update injuries - decrease recovery time by 1 day
            updateInjuries(currentState.players);
            
            currentState.currentDay++;
        }
        
        setGameState(currentState);
    };
    
    const simulateSeason82 = () => {
        if (!gameState) return;
        
        let currentState = { ...gameState };
        
        while (currentState.currentDay <= 82) {
            const currentDaySchedule = currentState.schedule.find(d => d.day === currentState.currentDay);
            if (!currentDaySchedule) break;
            
            // Process AI trades BEFORE simulating games for the day
            const tradeDeadlineDay = 56;
            if (currentState.currentDay <= tradeDeadlineDay) {
                // Calculate current game number
                const teamGamesPlayed = {};
                TEAMS.forEach(t => teamGamesPlayed[t.id] = 0);
                
                currentState.schedule.forEach(daySchedule => {
                    daySchedule.matchups.forEach(matchup => {
                        if (matchup.played) {
                            teamGamesPlayed[matchup.homeTeam]++;
                            teamGamesPlayed[matchup.awayTeam]++;
                        }
                    });
                });
                
                const avgGamesPlayed = Object.values(teamGamesPlayed).reduce((a, b) => a + b, 0) / TEAMS.length;
                const gameNumber = Math.floor(avgGamesPlayed);
                
                processAITrades(currentState, gameNumber, userTeamId);
            }
            
            currentDaySchedule.matchups.forEach(matchup => {
                if (matchup.played) return;
                
                const homePlayers = currentState.players.filter(p => 
                    p.teamId === matchup.homeTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const awayPlayers = currentState.players.filter(p => 
                    p.teamId === matchup.awayTeam && p.roster === 'nhl' && !p.injury.injured &&
                    (p.position === 'G' ? p.dressed : p.lineNumber > 0)
                );
                
                const result = simulateGameResult(homePlayers, awayPlayers);
                
                matchup.played = true;
                matchup.homeScore = result.homeGoals;
                matchup.awayScore = result.awayGoals;
                matchup.homeStats = result.homePlayerStats;
                matchup.awayStats = result.awayPlayerStats;
                matchup.periodScoring = result.periodScoring;
                matchup.details = {
                    scoringSummary: result.scoringSummary,
                    penaltyLog: result.penaltyLog,
                    teamStats: result.teamStats,
                    homePlayerStats: result.homePlayerStats,
                    awayPlayerStats: result.awayPlayerStats
                };
                
                const homeStanding = currentState.standings.find(s => s.teamId === matchup.homeTeam);
                const awayStanding = currentState.standings.find(s => s.teamId === matchup.awayTeam);
                
                if (!homeStanding || !awayStanding) {
                    console.error('Could not find standings for full season sim:', matchup.homeTeam, matchup.awayTeam);
                    return;
                }
                
                homeStanding.goalsFor += result.homeGoals;
                homeStanding.goalsAgainst += result.awayGoals;
                awayStanding.goalsFor += result.awayGoals;
                awayStanding.goalsAgainst += result.homeGoals;
                homeStanding.teamStats.gamesPlayed++;
                awayStanding.teamStats.gamesPlayed++;
                
                if (result.winner === 'home') {
                    homeStanding.wins++; homeStanding.home.wins++; homeStanding.points += 2;
                    awayStanding.losses++; awayStanding.away.losses++;
                } else {
                    awayStanding.wins++; awayStanding.away.wins++; awayStanding.points += 2;
                    homeStanding.losses++; homeStanding.home.losses++;
                }
                
                // Update head-to-head record
                updateHeadToHead(currentState.headToHead, matchup.homeTeam, matchup.awayTeam, result.winner);
                
                [...result.homePlayerStats, ...result.awayPlayerStats].forEach(pgs => {
                    const player = currentState.players.find(p => p.id === pgs.player.id);
                    updatePlayerStatsAfterGame(player, pgs, matchup, result, currentState);
                });
            });
            
            // Update injuries - decrease recovery time by 1 day
            updateInjuries(currentState.players);
            
            currentState.currentDay++;
        }
        
        // Season complete - apply aging to all players
        currentState.players = processEndOfSeasonAging(currentState.players);
        
        // Show awards
        const awards = calculateAwards(currentState.players, currentState.standings);
        setSeasonAwards(awards);
        
        // Update team profiles one final time
        if (currentState.teamProfiles) {
            currentState.teamProfiles = updateTeamProfiles(
                currentState.teamProfiles,
                currentState.standings,
                currentState.schedule,
                currentState.players,
                currentState.currentDay
            );
        }
        
        setGameState(currentState);
        setCurrentView('awards');
    };


    const proposeTrade = (yourPlayer, theirPlayer) => {
        if (!gameState) return;
        
        // Check if trade deadline has passed (Day 55)
        const tradeDeadlineDay = 55;
        
        if (gameState.currentDay > tradeDeadlineDay) {
            alert(`‚ùå TRADE DEADLINE HAS PASSED\n\nThe trade deadline was Day ${tradeDeadlineDay}.\nTrades are no longer allowed this season.`);
            setSelectedPlayer(null);
            setSelectedTeam(null);
            return;
        }
        
        const ratingDiff = Math.abs(yourPlayer.ratings.overall - theirPlayer.ratings.overall);
        const accepted = ratingDiff < 10 && Math.random() > 0.3;
        
        if (accepted) {
            const newPlayers = gameState.players.map(p => {
                if (p.id === yourPlayer.id) return { ...p, teamId: theirPlayer.teamId };
                if (p.id === theirPlayer.id) return { ...p, teamId: yourPlayer.teamId };
                return p;
            });
            
            setGameState({ ...gameState, players: newPlayers });
            alert('Trade accepted!');
        } else {
            alert('Trade rejected.');
        }
        
        setSelectedPlayer(null);
        setSelectedTeam(null);
    };

    const formatTOI = (minutes) => {
        const mins = Math.floor(minutes);
        const secs = Math.round((minutes - mins) * 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };
    
    const getOrdinalSuffix = (num) => {
        const j = num % 10;
        const k = num % 100;
        if (j === 1 && k !== 11) return 'st';
        if (j === 2 && k !== 12) return 'nd';
        if (j === 3 && k !== 13) return 'rd';
        return 'th';
    };
    
    // Generate Draft Lottery Results
    const generateDraftLottery = (standings) => {
        // Get non-playoff teams (bottom 16 teams by points)
        const sortedStandings = [...standings].sort((a, b) => a.points - b.points);
        const nonPlayoffTeams = sortedStandings.slice(0, 16);
        
        // Calculate lottery odds based on inverse of points
        // Worst team has best odds, scales down
        const totalPoints = nonPlayoffTeams.reduce((sum, s) => sum + s.points, 0);
        const lotteryTeams = nonPlayoffTeams.map((standing, index) => {
            const team = TEAMS.find(t => t.id === standing.teamId);
            if (!team) return;
            // Inverse odds: worst team (index 0) gets highest weight
            const oddsWeight = nonPlayoffTeams.length - index;
            return {
                teamId: standing.teamId,
                teamName: `${team.city} ${team.name}`,
                record: `${standing?.wins}-${standing?.losses}-${standing?.otLosses}`,
                points: standing.points,
                finishPosition: sortedStandings.findIndex(s => s.teamId === standing.teamId) + 1,
                oddsWeight: oddsWeight
            };
        });
        
        // Run lottery for top 5 picks
        const lotteryResults = [];
        const remainingTeams = [...lotteryTeams];
        
        for (let pick = 1; pick <= 5; pick++) {
            // Calculate total weight
            const totalWeight = remainingTeams.reduce((sum, t) => sum + t.oddsWeight, 0);
            
            // Random selection weighted by odds
            let random = Math.random() * totalWeight;
            let winner = null;
            
            for (const team of remainingTeams) {
                random -= team.oddsWeight;
                if (random <= 0) {
                    winner = team;
                    break;
                }
            }
            
            if (!winner) winner = remainingTeams[0]; // Fallback
            
            lotteryResults.push({
                pick: pick,
                ...winner,
                moved: winner.finishPosition !== (16 - pick + 1) // Did they move up/down from expected?
            });
            
            // Remove winner from remaining teams
            const winnerIndex = remainingTeams.findIndex(t => t.teamId === winner.teamId);
            remainingTeams.splice(winnerIndex, 1);
        }
        
        // Assign remaining picks 6-16 in order of finish
        remainingTeams.sort((a, b) => a.points - b.points);
        remainingTeams.forEach((team, index) => {
            lotteryResults.push({
                pick: 6 + index,
                ...team,
                moved: false
            });
        });
        
        // Add playoff teams (picks 17-32) in reverse order of playoff finish
        // Get playoff teams (top 16 by points)
        const playoffTeams = sortedStandings.slice(16, 32).map((standing, index) => {
            const team = TEAMS.find(t => t.id === standing.teamId);
            if (!team) return null;
            return {
                teamId: standing.teamId,
                teamName: `${team.city} ${team.name}`,
                record: `${standing?.wins}-${standing?.losses}-${standing?.otLosses}`,
                points: standing.points,
                finishPosition: sortedStandings.findIndex(s => s.teamId === standing.teamId) + 1,
                moved: false
            };
        });
        
        // Reverse so best playoff team picks last (32nd)
        playoffTeams.reverse();
        playoffTeams.forEach((team, index) => {
            lotteryResults.push({
                pick: 17 + index,
                ...team
            });
        });
        
        return lotteryResults;
    };
    
    // Draft Team Needs Analysis
    const analyzeDraftNeeds = () => {
        if (!gameState) return null;
        
        const roster = gameState.players.filter(p => p.teamId === userTeamId);
        const allPlayers = [...roster]; // Include farm team
        
        // Count by position
        const forwards = allPlayers.filter(p => p.position === 'F');
        const defense = allPlayers.filter(p => p.position === 'D');
        const goalies = allPlayers.filter(p => p.position === 'G');
        
        // Find young prospects (under 23)
        const youngForwards = forwards.filter(p => p.age < 23);
        const youngDefense = defense.filter(p => p.age < 23);
        const youngGoalies = goalies.filter(p => p.age < 23);
        
        // Find high-potential players
        const eliteProspects = allPlayers.filter(p => p.ratings.potential >= 85);
        
        const needs = [];
        const recommendations = [];
        
        // Prospect pool analysis
        if (youngForwards.length < 5) {
            needs.push({ position: 'F', priority: 'HIGH', reason: `Only ${youngForwards.length} forward prospects` });
            recommendations.push('Draft 2-3 forwards to build offensive depth');
        } else if (youngForwards.length < 8) {
            needs.push({ position: 'F', priority: 'MEDIUM', reason: 'Limited forward prospect pool' });
        }
        
        if (youngDefense.length < 3) {
            needs.push({ position: 'D', priority: 'HIGH', reason: `Only ${youngDefense.length} defense prospects` });
            recommendations.push('Target defensemen early to build blue line');
        } else if (youngDefense.length < 5) {
            needs.push({ position: 'D', priority: 'MEDIUM', reason: 'Thin on defense prospects' });
        }
        
        if (youngGoalies.length === 0) {
            needs.push({ position: 'G', priority: 'CRITICAL', reason: 'No goalie prospects in system' });
            recommendations.push('MUST DRAFT: Take a goalie with upside');
        } else if (youngGoalies.length === 1) {
            needs.push({ position: 'G', priority: 'MEDIUM', reason: 'Only 1 goalie prospect' });
            recommendations.push('Consider adding goalie depth');
        }
        
        // Elite talent analysis
        if (eliteProspects.length < 3) {
            needs.push({ position: 'ANY', priority: 'HIGH', reason: `Only ${eliteProspects.length} elite prospects (85+ potential)` });
            recommendations.push('Focus on Best Player Available (BPA) strategy');
        }
        
        // Draft strategy recommendations
        if (needs.filter(n => n.priority === 'CRITICAL' || n.priority === 'HIGH').length >= 2) {
            recommendations.push('Address multiple needs - balance position and talent');
        } else {
            recommendations.push('Take best available prospect regardless of position');
        }
        
        return {
            needs,
            recommendations,
            prospectCounts: {
                forwards: youngForwards.length,
                defense: youngDefense.length,
                goalies: youngGoalies.length,
                elite: eliteProspects.length
            }
        };
    };
    
    // Generate Draft Prospects (224 players for 7 rounds)
    const generateDraftProspects = () => {
        const prospects = [];
        const positions = ['C', 'LW', 'RW', 'D', 'G'];
        const positionWeights = [0.2, 0.15, 0.15, 0.35, 0.15]; // More defensemen
        
        // Historical NHL player names - mix and match first and last
        const firstNames = [
            // Legends
            'Wayne', 'Mario', 'Bobby', 'Gordie', 'Maurice', 'Jean', 'Guy', 'Mark', 'Steve', 'Ray',
            // Modern Stars
            'Connor', 'Sidney', 'Alex', 'Evgeni', 'Patrick', 'Jonathan', 'Anze', 'Claude', 'Joe', 'Jaromir',
            // Defensemen
            'Nicklas', 'Erik', 'Victor', 'Duncan', 'Drew', 'Shea', 'P.K.', 'Brent', 'Chris', 'Scott',
            // Goalies
            'Martin', 'Dominik', 'Patrick', 'Henrik', 'Carey', 'Sergei', 'Marc-Andre', 'Tuukka', 'Pekka', 'Roberto',
            // Classic Names
            'Brett', 'Pavel', 'Peter', 'Teemu', 'Mats', 'Daniel', 'Henrik', 'Markus', 'Saku', 'Paul',
            // More Modern
            'Nathan', 'Auston', 'Jack', 'Elias', 'Mitch', 'Leon', 'David', 'Artemi', 'Nikita', 'Aleksander',
            'Tyler', 'Jamie', 'Taylor', 'Logan', 'Ryan', 'Brandon', 'Jordan', 'Kyle', 'Brayden', 'Patrice',
            // European Stars
            'Filip', 'Rasmus', 'Sebastian', 'Oliver', 'William', 'Mika', 'Mikko', 'Roope', 'Andrei', 'Kirill',
            'Roman', 'Nikolai', 'Ilya', 'Valeri', 'Sergei', 'Evander', 'Patrik', 'Mikael', 'Tomas', 'Jakub',
            // More Variety
            'Brad', 'Eric', 'Mike', 'Scott', 'Adam', 'Matt', 'Dan', 'Brian', 'Chris', 'Jeff'
        ];
        
        const lastNames = [
            // Legends
            'Gretzky', 'Lemieux', 'Orr', 'Howe', 'Richard', 'Beliveau', 'Lafleur', 'Messier', 'Yzerman', 'Bourque',
            // Modern Stars
            'Crosby', 'McDavid', 'Ovechkin', 'Malkin', 'Kane', 'Toews', 'Kopitar', 'Giroux', 'Thornton', 'Jagr',
            // Defensemen Legends
            'Lidstrom', 'Karlsson', 'Hedman', 'Keith', 'Doughty', 'Weber', 'Subban', 'Burns', 'Pronger', 'Niedermayer',
            // Goalies
            'Brodeur', 'Hasek', 'Roy', 'Lundqvist', 'Price', 'Bobrovsky', 'Fleury', 'Rask', 'Rinne', 'Luongo',
            // Classic Stars
            'Hull', 'Forsberg', 'Sakic', 'Selanne', 'Sundin', 'Sedin', 'Alfredsson', 'Naslund', 'Koivu', 'Kariya',
            // More Modern
            'MacKinnon', 'Matthews', 'Eichel', 'Pettersson', 'Marner', 'Draisaitl', 'Pastrnak', 'Panarin', 'Kucherov', 'Barkov',
            'Seguin', 'Benn', 'Hall', 'Couture', 'O\'Reilly', 'Stamkos', 'Point', 'Scheifele', 'Bergeron', 'Marchand',
            // European Stars
            'Zibanejad', 'Dahlin', 'Aho', 'Ekman-Larsson', 'Nylander', 'Josi', 'Rantanen', 'Hintz', 'Svechnikov', 'Kaprizov',
            'Panarin', 'Kuznetsov', 'Tarasenko', 'Nichushkin', 'Zegras', 'Hughes', 'Makar', 'Fox', 'Heiskanen', 'Stutzle',
            // More Variety
            'Tkachuk', 'Gaudreau', 'Stone', 'Pacioretty', 'Tavares', 'Girard', 'Dobson', 'Suzuki', 'Caufield', 'Raymond',
            'Guentzel', 'Rust', 'Jarry', 'Shesterkin', 'Sorokin', 'Vasilevskiy', 'Hellebuyck', 'Saros', 'Ullmark', 'Swayman'
        ];
        
        // Generate 224 prospects (7 rounds x 32 teams)
        for (let i = 0; i < 224; i++) {
            // Weighted position selection
            let random = Math.random();
            let cumulative = 0;
            let position = 'C';
            for (let j = 0; j < positions.length; j++) {
                cumulative += positionWeights[j];
                if (random <= cumulative) {
                    position = positions[j];
                    break;
                }
            }
            
            // Potential rating (65-85, with bell curve favoring middle)
            const potentialBase = 65 + Math.floor(Math.random() * 21);
            const potentialBonus = Math.random() < 0.3 ? Math.floor(Math.random() * 5) : 0;
            const potential = Math.min(85, potentialBase + potentialBonus);
            
            // Current OVR (always lower than potential, 50-65 range)
            // Top picks have higher current OVR
            const pickBonus = Math.max(0, 15 - Math.floor(i / 15));
            const currentOVR = Math.min(65, 50 + Math.floor(Math.random() * 10) + pickBonus);
            
            // Physical attributes
            const height = position === 'G' 
                ? 73 + Math.floor(Math.random() * 5) // Goalies: 6'1" - 6'5"
                : position === 'D'
                ? 71 + Math.floor(Math.random() * 8) // Defense: 5'11" - 6'6"
                : 69 + Math.floor(Math.random() * 9); // Forwards: 5'9" - 6'5"
            
            const weight = position === 'G'
                ? 185 + Math.floor(Math.random() * 30)
                : height * 2.7 + Math.floor(Math.random() * 15);
            
            // Scouting report traits
            const traits = generateProspectTraits(position, potential);
            
            prospects.push({
                id: `prospect_${i}`,
                firstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                lastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                age: 18,
                position: position,
                overall: currentOVR,
                potential: potential,
                height: height,
                weight: Math.round(weight),
                country: Math.random() < 0.5 ? 'USA' : Math.random() < 0.7 ? 'CAN' : Math.random() < 0.85 ? 'SWE' : 'RUS',
                draftRank: i + 1, // Initial ranking
                traits: traits,
                scoutingGrade: calculateScoutingGrade(potential, currentOVR, traits)
            });
        }
        
        return prospects;
    };
    
    const generateProspectTraits = (position, potential) => {
        const traits = [];
        
        if (potential >= 80) {
            traits.push('Elite Potential');
            traits.push(position === 'G' ? 'Lightning Reflexes' : position === 'D' ? 'Two-Way Dynamo' : 'Elite Playmaker');
        } else if (potential >= 75) {
            traits.push('High Upside');
            traits.push(position === 'G' ? 'Good Positioning' : position === 'D' ? 'Strong Defender' : 'Skilled Forward');
        } else if (potential >= 70) {
            traits.push('Solid Prospect');
            traits.push(position === 'G' ? 'Reliable' : 'Good IQ');
        } else {
            traits.push('Project Player');
            traits.push('Needs Development');
        }
        
        // Add 1-2 random traits
        const allTraits = position === 'G' 
            ? ['Quick Glove', 'Strong Blocker', 'Excellent Rebound Control', 'Calm Under Pressure', 'Good Puckhandler']
            : position === 'D'
            ? ['Physical', 'Good Skater', 'Shot Blocker', 'Smart Positioning', 'Power Play QB', 'Shutdown Defender']
            : ['Speed Demon', 'Sniper', 'Playmaker', 'Two-Way', 'Power Forward', 'Grinder', 'High IQ'];
        
        const randomTraits = [...allTraits].sort(() => Math.random() - 0.5).slice(0, Math.random() < 0.5 ? 1 : 2);
        traits.push(...randomTraits);
        
        return traits;
    };
    
    const calculateScoutingGrade = (potential, currentOVR, traits) => {
        const gap = potential - currentOVR;
        
        if (potential >= 80 && gap >= 20) return 'A+';
        if (potential >= 78 && gap >= 18) return 'A';
        if (potential >= 75 && gap >= 15) return 'A-';
        if (potential >= 72 && gap >= 12) return 'B+';
        if (potential >= 70 && gap >= 10) return 'B';
        if (potential >= 68) return 'B-';
        if (potential >= 65) return 'C+';
        return 'C';
    };
    
    const generateDraftReportCard = () => {
        if (!draftResults || draftResults.length === 0) {
            return {
                grade: 'F',
                summary: 'Did not make any draft picks',
                details: ['No selections made during the draft'],
                color: '#ef4444'
            };
        }
        
        const userPicks = draftResults.filter(pick => pick.teamId === userTeamId);
        
        if (userPicks.length === 0) {
            return {
                grade: 'F',
                summary: 'No draft picks made',
                details: ['Did not participate in the draft'],
                color: '#ef4444'
            };
        }
        
        const draftNeeds = analyzeDraftNeeds();
        let score = 0;
        const details = [];
        
        // Analyze draft picks
        const avgPotential = userPicks.reduce((sum, p) => sum + p.prospect.potential, 0) / userPicks.length;
        const avgCurrentOVR = userPicks.reduce((sum, p) => sum + p.prospect.overall, 0) / userPicks.length;
        
        // Position breakdown
        const forwardsPicked = userPicks.filter(p => ['C', 'LW', 'RW'].includes(p.prospect.position)).length;
        const defensePicked = userPicks.filter(p => p.prospect.position === 'D').length;
        const goaliesPicked = userPicks.filter(p => p.prospect.position === 'G').length;
        
        // Grade picks
        const aGradePicks = userPicks.filter(p => ['A+', 'A', 'A-'].includes(p.prospect.scoutingGrade)).length;
        const bGradePicks = userPicks.filter(p => ['B+', 'B', 'B-'].includes(p.prospect.scoutingGrade)).length;
        
        // Scoring criteria
        
        // 1. Number of picks (0-15 points)
        if (userPicks.length >= 7) {
            score += 15;
            details.push(`‚úÖ Full draft participation (${userPicks.length} picks)`);
        } else if (userPicks.length >= 5) {
            score += 12;
            details.push(`Good participation (${userPicks.length} picks)`);
        } else if (userPicks.length >= 3) {
            score += 8;
            details.push(`Moderate activity (${userPicks.length} picks)`);
        } else {
            score += userPicks.length * 3;
            details.push(`Limited picks (${userPicks.length} total)`);
        }
        
        // 2. Prospect quality (0-35 points)
        if (avgPotential >= 82) {
            score += 35;
            details.push(`‚≠ê Elite draft class (avg ${avgPotential.toFixed(0)} potential)`);
        } else if (avgPotential >= 78) {
            score += 30;
            details.push(`Outstanding prospects (avg ${avgPotential.toFixed(0)} potential)`);
        } else if (avgPotential >= 74) {
            score += 25;
            details.push(`Strong draft class (avg ${avgPotential.toFixed(0)} potential)`);
        } else if (avgPotential >= 70) {
            score += 15;
            details.push(`Solid prospects (avg ${avgPotential.toFixed(0)} potential)`);
        } else {
            score += 5;
            details.push(`Developmental picks (avg ${avgPotential.toFixed(0)} potential)`);
        }
        
        // 3. Scouting grades (0-25 points)
        if (aGradePicks >= 3) {
            score += 25;
            details.push(`üî• Multiple A-grade prospects (${aGradePicks} picks)`);
        } else if (aGradePicks >= 2) {
            score += 20;
            details.push(`Two A-grade prospects selected`);
        } else if (aGradePicks >= 1) {
            score += 15;
            details.push(`One A-grade prospect acquired`);
        } else if (bGradePicks >= 4) {
            score += 15;
            details.push(`Multiple B-grade prospects (${bGradePicks} picks)`);
        } else if (bGradePicks >= 2) {
            score += 10;
            details.push(`Some B-grade prospects`);
        } else {
            score += 5;
            details.push(`‚ö†Ô∏è Limited high-grade prospects`);
        }
        
        // 4. Addressed needs (0-25 points)
        let needsScore = 0;
        
        if (draftNeeds && draftNeeds.needs) {
            const criticalGoalieNeed = draftNeeds.needs.some(n => n.position === 'G' && n.priority === 'CRITICAL');
            const highForwardNeed = draftNeeds.needs.some(n => n.position === 'F' && n.priority === 'HIGH');
            const highDefenseNeed = draftNeeds.needs.some(n => n.position === 'D' && n.priority === 'HIGH');
            
            if (criticalGoalieNeed && goaliesPicked >= 1) {
                needsScore += 15;
                details.push(`Filled critical goalie need!`);
            }
            
            if (highForwardNeed && forwardsPicked >= 2) {
                needsScore += 10;
                details.push(`Addressed forward depth (${forwardsPicked} picked)`);
            }
            
            if (highDefenseNeed && defensePicked >= 1) {
                needsScore += 10;
                details.push(`Added defensive prospects (${defensePicked} picked)`);
            }
            
            // Bonus for balanced draft
            if (forwardsPicked >= 2 && defensePicked >= 1) {
                needsScore += 5;
                details.push(`Balanced position selection`);
            }
        }
        
        score += Math.min(needsScore, 25);
        
        // 5. Draft value (0-15 points) - based on whether you got good value
        const earlyPicks = userPicks.filter(p => p.overall <= 32); // First round
        const lateValue = userPicks.filter(p => p.overall > 64 && p.prospect.scoutingGrade.startsWith('A')); // Late-round steals
        
        if (lateValue.length >= 2) {
            score += 15;
            details.push(`üíé Found ${lateValue.length} late-round gems!`);
        } else if (lateValue.length >= 1) {
            score += 10;
            details.push(`Good late-round value pick`);
        } else if (earlyPicks.length >= 1 && earlyPicks.every(p => p.prospect.potential >= 75)) {
            score += 10;
            details.push(`Maximized early picks`);
        } else {
            score += 5;
        }
        
        // Determine grade
        let grade, summary, color;
        if (score >= 90) {
            grade = 'A+';
            summary = 'Franchise-altering draft!';
            color = '#22c55e';
        } else if (score >= 85) {
            grade = 'A';
            summary = 'Outstanding draft!';
            color = '#22c55e';
        } else if (score >= 80) {
            grade = 'A-';
            summary = 'Excellent draft class';
            color = '#3b82f6';
        } else if (score >= 75) {
            grade = 'B+';
            summary = 'Very good draft';
            color = '#3b82f6';
        } else if (score >= 70) {
            grade = 'B';
            summary = 'Solid draft';
            color = '#3b82f6';
        } else if (score >= 65) {
            grade = 'B-';
            summary = 'Decent draft class';
            color = '#60a5fa';
        } else if (score >= 60) {
            grade = 'C+';
            summary = 'Average draft';
            color = '#fbbf24';
        } else if (score >= 55) {
            grade = 'C';
            summary = 'Below average draft';
            color = '#fbbf24';
        } else if (score >= 50) {
            grade = 'C-';
            summary = 'Concerning draft';
            color = '#f59e0b';
        } else if (score >= 40) {
            grade = 'D';
            summary = 'Poor draft';
            color = '#ef4444';
        } else {
            grade = 'F';
            summary = 'Failed draft';
            color = '#ef4444';
        }
        
        return {
            grade,
            score,
            summary,
            details,
            color,
            stats: {
                totalPicks: userPicks.length,
                avgPotential,
                avgCurrentOVR,
                forwardsPicked,
                defensePicked,
                goaliesPicked,
                aGradePicks,
                bGradePicks
            }
        };
    };

    // Contract Re-signing Functions
    const detectExpiringContracts = () => {
        if (!gameState) return null;
        
        const expiring = {
            userTeam: [],
            aiTeams: {}
        };
        
        // Find all players with contracts expiring after this season
        gameState.players.forEach(player => {
            if (!player.contract || player.contract.yearsRemaining !== 1) return;
            
            // Determine if RFA or UFA
            // RFA: Age 25 or younger, has played for team for multiple years
            const isRFA = player.age <= 25;
            const playerType = isRFA ? 'RFA' : 'UFA';
            
            const expiringPlayer = {
                ...player,
                playerType,
                currentSalary: player.contract.salary,
                currentYears: player.contract.yearsRemaining
            };
            
            if (player.teamId === userTeamId) {
                expiring.userTeam.push(expiringPlayer);
            } else {
                if (!expiring.aiTeams[player.teamId]) {
                    expiring.aiTeams[player.teamId] = [];
                }
                expiring.aiTeams[player.teamId].push(expiringPlayer);
            }
        });
        
        // Sort user team by importance (OVR desc)
        expiring.userTeam.sort((a, b) => b.ratings.overall - a.ratings.overall);
        
        return expiring;
    };
    
    const calculateResignOffer = (player) => {
        const ovr = player.ratings.overall;
        const age = player.age;
        const isRFA = player.playerType === 'RFA';
        
        // Base salary from OVR (same as FA logic)
        let baseSalary;
        if (ovr >= 90) baseSalary = 10000000;
        else if (ovr >= 85) baseSalary = 7000000;
        else if (ovr >= 80) baseSalary = 5000000;
        else if (ovr >= 75) baseSalary = 3000000;
        else if (ovr >= 70) baseSalary = 1500000;
        else baseSalary = GAME_CONFIG.MIN_SALARY;
        
        // Age adjustments
        if (age <= 23) baseSalary *= 0.8; // Young players get less
        else if (age >= 32) baseSalary *= 0.9; // Older players get slight discount
        
        // RFA cap: Can't ask for more than 125% of current salary
        if (isRFA) {
            const rfaMax = player.currentSalary * 1.25;
            baseSalary = Math.min(baseSalary, rfaMax);
        }
        
        // Add some variance
        const variance = 0.9 + Math.random() * 0.2; // 90-110%
        const finalSalary = Math.round(baseSalary * variance / 100000) * 100000;
        
        // Contract length based on age and type
        let years;
        if (isRFA) {
            // RFAs get 2-3 year deals
            years = age <= 22 ? 2 : (Math.random() < 0.6 ? 2 : 3);
        } else {
            // UFAs can get longer deals
            if (age <= 27) years = Math.floor(Math.random() * 4) + 3; // 3-6 years
            else if (age <= 30) years = Math.floor(Math.random() * 3) + 3; // 3-5 years
            else if (age <= 33) years = Math.floor(Math.random() * 3) + 2; // 2-4 years
            else years = Math.floor(Math.random() * 2) + 1; // 1-2 years
        }
        
        return { salary: finalSalary, years };
    };
    
    const aiResignPlayers = (expiringContracts) => {
        if (!expiringContracts) return [];
        
        const resigned = [];
        
        // Each AI team tries to re-sign their own players
        Object.entries(expiringContracts.aiTeams).forEach(([teamId, players]) => {
            const team = TEAMS.find(t => t.id === parseInt(teamId));
            if (!team) return;
            
            // Get team's current cap situation
            const teamPlayers = gameState.players.filter(p => p.teamId === parseInt(teamId));
            const currentCap = teamPlayers.reduce((sum, p) => 
                sum + (p.contract?.salary || 0), 0
            );
            const capSpace = GAME_CONFIG.SALARY_CAP - currentCap;
            
            players.forEach(player => {
                const offer = calculateResignOffer(player);
                
                // AI acceptance logic
                let acceptChance = 0.70; // Base 70% chance for own team
                
                // RFAs almost always re-sign (team has control)
                if (player.playerType === 'RFA') {
                    acceptChance = 0.95;
                }
                
                // Higher OVR players more likely to test market
                if (player.ratings.overall >= 85) acceptChance -= 0.15;
                
                // Check cap space
                if (offer.salary > capSpace) {
                    acceptChance *= 0.3; // Much less likely if no cap room
                }
                
                if (Math.random() < acceptChance) {
                    resigned.push({
                        player,
                        teamId: parseInt(teamId),
                        salary: offer.salary,
                        years: offer.years
                    });
                }
            });
        });
        
        return resigned;
    };

    // Free Agency Functions
    const initializePlayerContracts = () => {
        // Give all existing players contracts if they don't have one
        if (!gameState) return;
        
        const updatedPlayers = gameState.players.map(player => {
            // Skip if player already has a contract
            if (player.contract && player.contract.salary) {
                return player;
            }
            
            // Generate contract based on OVR
            const ovr = player.ratings.overall;
            let salary;
            
            if (ovr >= 90) salary = 12000000 + Math.random() * 3000000; // $12-15M
            else if (ovr >= 85) salary = 8000000 + Math.random() * 4000000; // $8-12M
            else if (ovr >= 80) salary = 5000000 + Math.random() * 3000000; // $5-8M
            else if (ovr >= 75) salary = 3000000 + Math.random() * 2000000; // $3-5M
            else if (ovr >= 70) salary = 1500000 + Math.random() * 1500000; // $1.5-3M
            else salary = 700000 + Math.random() * 800000; // $0.7-1.5M
            
            // Round to nearest 100k
            salary = Math.floor(salary / 100000) * 100000;
            
            // Generate years based on age
            let years;
            if (player.age < 25) years = 2 + Math.floor(Math.random() * 4); // 2-5 years
            else if (player.age < 30) years = 3 + Math.floor(Math.random() * 3); // 3-5 years
            else if (player.age < 35) years = 1 + Math.floor(Math.random() * 3); // 1-3 years
            else years = 1; // 1 year for veterans
            
            return {
                ...player,
                contract: {
                    years,
                    salary,
                    yearsRemaining: years,
                    signedDate: 0 // Before current season
                }
            };
        });
        
        setGameState({
            ...gameState,
            players: updatedPlayers
        });
    };
    
    const analyzeRosterNeeds = () => {
        if (!gameState || !userTeamPlayers) return null;
        
        const nhlRoster = userTeamPlayers.filter(p => p.roster === 'nhl');
        
        // Count positions in single pass
        const forwards = [];
        const defense = [];
        const goalies = [];
        let forwardOVRSum = 0;
        let defenseOVRSum = 0;
        let goalieOVRSum = 0;
        
        for (const p of nhlRoster) {
            if (p.position === 'F') {
                forwards.push(p);
                forwardOVRSum += p.ratings.overall;
            } else if (p.position === 'D') {
                defense.push(p);
                defenseOVRSum += p.ratings.overall;
            } else if (p.position === 'G') {
                goalies.push(p);
                goalieOVRSum += p.ratings.overall;
            }
        }
        
        // Calculate average OVR by position
        const avgForwardOVR = forwards.length > 0 ? forwardOVRSum / forwards.length : 0;
        const avgDefenseOVR = defense.length > 0 ? defenseOVRSum / defense.length : 0;
        const avgGoalieOVR = goalies.length > 0 ? goalieOVRSum / goalies.length : 0;
        
        // Identify needs
        const needs = [];
        const recommendations = [];
        
        // Forward needs
        if (forwards.length < 13) {
            needs.push({ position: 'F', priority: 'HIGH', reason: `Only ${forwards.length} forwards (need 13+)` });
            recommendations.push('Sign 2-3 forwards to fill out lines');
        } else if (avgForwardOVR < 78) {
            needs.push({ position: 'F', priority: 'MEDIUM', reason: `Forward depth average: ${avgForwardOVR.toFixed(0)} OVR` });
            recommendations.push('Upgrade forward depth with higher-rated players');
        }
        
        const topForward = forwards.length > 0 ? forwards.reduce((max, p) => p.ratings.overall > max.ratings.overall ? p : max, forwards[0]) : null;
        if (!topForward || topForward.ratings.overall < 85) {
            needs.push({ position: 'F', priority: 'HIGH', reason: 'No elite forward (85+ OVR)' });
            recommendations.push('Target a star forward (85+ OVR) to lead offense');
        }
        
        // Defense needs
        if (defense.length < 6) {
            needs.push({ position: 'D', priority: 'HIGH', reason: `Only ${defense.length} defensemen (need 6+)` });
            recommendations.push('Sign 1-2 defensemen for top-4 or depth');
        } else if (avgDefenseOVR < 77) {
            needs.push({ position: 'D', priority: 'MEDIUM', reason: `Defense average: ${avgDefenseOVR.toFixed(0)} OVR` });
            recommendations.push('Add shutdown defenseman to strengthen blue line');
        }
        
        const topDefenseman = defense.length > 0 ? defense.reduce((max, p) => p.ratings.overall > max.ratings.overall ? p : max, defense[0]) : null;
        if (!topDefenseman || topDefenseman.ratings.overall < 83) {
            needs.push({ position: 'D', priority: 'MEDIUM', reason: 'No elite defenseman (83+ OVR)' });
            recommendations.push('Consider signing a #1 defenseman');
        }
        
        // Goalie needs
        if (goalies.length < 2) {
            needs.push({ position: 'G', priority: 'CRITICAL', reason: `Only ${goalies.length} goalie${goalies.length === 1 ? '' : 's'} (need 2)` });
            recommendations.push('URGENT: Sign starting goalie immediately');
        } else if (goalies.length < 3) {
            needs.push({ position: 'G', priority: 'LOW', reason: 'Consider adding backup goalie' });
        }
        
        const topGoalie = goalies.length > 0 ? goalies.reduce((max, p) => p.ratings.overall > max.ratings.overall ? p : max, goalies[0]) : null;
        if (goalies.length >= 2 && (!topGoalie || topGoalie.ratings.overall < 80)) {
            needs.push({ position: 'G', priority: 'MEDIUM', reason: 'Weak goaltending (best goalie under 80 OVR)' });
            recommendations.push('Upgrade starting goalie for better save percentage');
        }
        
        return {
            needs,
            recommendations,
            rosterCounts: {
                forwards: forwards.length,
                defense: defense.length,
                goalies: goalies.length
            },
            averages: {
                forward: avgForwardOVR,
                defense: avgDefenseOVR,
                goalie: avgGoalieOVR
            }
        };
    };
    
    const generateFreeAgents = () => {
        // Generate 50-80 free agents from league players
        const numberOfFreeAgents = 50 + Math.floor(Math.random() * 30);
        const agents = [];
        
        // Historical NHL first/last names for free agents
        const firstNames = ['Connor', 'Alex', 'Sidney', 'Nathan', 'Auston', 'Leon', 'Artemi', 'Nikita', 'David', 'John', 'Brad', 'Tyler', 'Jake', 'Ryan', 'Kyle', 'Steven', 'Matt', 'Jordan', 'Brandon', 'Patrick', 'Mark', 'Jonathan', 'Sean', 'Chris', 'Mike', 'Jeff', 'Nick', 'Derek', 'Sam', 'Drew'];
        const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Miller', 'Davis', 'Wilson', 'Anderson', 'Taylor', 'Thomas', 'Moore', 'Martin', 'Lee', 'Thompson', 'White', 'Harris', 'Clark', 'Lewis', 'Walker', 'Hall', 'Allen', 'Young', 'King', 'Wright', 'Scott', 'Green', 'Baker', 'Adams', 'Nelson'];
        
        for (let i = 0; i < numberOfFreeAgents; i++) {
            const position = ['F', 'F', 'F', 'F', 'F', 'D', 'D', 'D', 'G'][Math.floor(Math.random() * 9)];
            const age = 22 + Math.floor(Math.random() * 14); // 22-35 years old
            const overall = 65 + Math.floor(Math.random() * 20); // 65-84 OVR
            
            // Calculate market value based on age, position, and overall
            let baseValue = overall * 100000; // $100k per OVR point
            if (position === 'G') baseValue *= 0.9; // Goalies slightly cheaper
            if (age > 32) baseValue *= 0.7; // Older players cheaper
            if (age < 25) baseValue *= 1.2; // Young players premium
            
            const marketValue = Math.floor(baseValue / 100000) * 100000; // Round to 100k
            
            agents.push({
                id: `fa_${i}_${Date.now()}`,
                firstName: firstNames[Math.floor(Math.random() * firstNames.length)],
                lastName: lastNames[Math.floor(Math.random() * lastNames.length)],
                position,
                age,
                ratings: { overall },
                marketValue,
                preferredYears: age > 30 ? 1 + Math.floor(Math.random() * 2) : 2 + Math.floor(Math.random() * 4), // 1-2 years for old, 2-5 for young
                status: 'available'
            });
        }
        
        // Sort by overall rating (best first)
        return agents.sort((a, b) => b.ratings.overall - a.ratings.overall);
    };
    
    const evaluateFreeAgentOffer = (freeAgent, yearsOffered, salaryOffered) => {
        // Player evaluates offer based on:
        // 1. Money vs market value
        // 2. Years vs preference
        // 3. Random factor for realism
        
        const salaryRatio = salaryOffered / freeAgent.marketValue;
        const yearsDiff = Math.abs(yearsOffered - freeAgent.preferredYears);
        
        let acceptanceChance = 0;
        
        // Salary component (70% weight)
        if (salaryRatio >= 1.2) acceptanceChance += 0.7; // 20% overpay = almost guaranteed
        else if (salaryRatio >= 1.1) acceptanceChance += 0.6; // 10% overpay = very likely
        else if (salaryRatio >= 1.0) acceptanceChance += 0.5; // Market value = 50/50
        else if (salaryRatio >= 0.9) acceptanceChance += 0.3; // 10% underpay = unlikely
        else acceptanceChance += 0.1; // Lowball = very unlikely
        
        // Years component (30% weight)
        if (yearsDiff === 0) acceptanceChance += 0.3; // Perfect match
        else if (yearsDiff === 1) acceptanceChance += 0.2; // Close enough
        else if (yearsDiff === 2) acceptanceChance += 0.1; // Getting worse
        // 3+ years off = no bonus
        
        // Random factor (-10% to +10%)
        acceptanceChance += (Math.random() - 0.5) * 0.2;
        
        // Clamp between 0 and 1
        acceptanceChance = Math.max(0, Math.min(1, acceptanceChance));
        
        return {
            accepted: Math.random() < acceptanceChance,
            acceptanceChance: Math.round(acceptanceChance * 100)
        };
    };
    
    const calculateTeamSalaryCap = (players) => {
        // Calculate total salary for all players with contracts
        // Only count players with valid contract objects and salary values
        return players
            .filter(p => p.contract && typeof p.contract.salary === 'number')
            .reduce((sum, p) => sum + p.contract.salary, 0);
    };
    
    const signFreeAgent = (freeAgent, years, salary) => {
        if (!gameState) return;
        
        // Check salary cap - only count user team players
        const userTeamPlayers = gameState.players.filter(p => p.teamId === userTeamId);
        const currentCap = calculateTeamSalaryCap(userTeamPlayers);
        const capSpace = GAME_CONFIG.SALARY_CAP - currentCap; // $83.5M cap
        
        if (salary > capSpace) {
            alert(`Not enough cap space! You have $${(capSpace / 1000000).toFixed(1)}M available.`);
            return false;
        }
        
        // Evaluate offer
        const result = evaluateFreeAgentOffer(freeAgent, years, salary);
        
        if (!result.accepted) {
            alert(`${freeAgent.firstName} ${freeAgent.lastName} rejected your offer!\n\nYour offer: ${years} years, $${(salary / 1000000).toFixed(1)}M\nMarket value: $${(freeAgent.marketValue / 1000000).toFixed(1)}M\nAcceptance chance was: ${result.acceptanceChance}%\n\nTry offering more money or adjusting the contract length.`);
            return false;
        }
        
        // Create player object
        const newPlayer = {
            id: freeAgent.id,
            firstName: freeAgent.firstName,
            lastName: freeAgent.lastName,
            age: freeAgent.age,
            position: freeAgent.position,
            teamId: userTeamId,
            roster: 'nhl',
            lineNumber: 0,
            dressed: false,
            ratings: {
                overall: freeAgent.ratings.overall,
                potential: freeAgent.ratings.overall + Math.floor(Math.random() * 5)
            },
            stats: {
                gamesPlayed: 0,
                goals: 0,
                assists: 0,
                points: 0,
                plusMinus: 0,
                pim: 0,
                shots: 0,
                timeOnIce: 0
            },
            contract: {
                years,
                salary,
                yearsRemaining: years,
                signedDate: gameState.currentDay
            },
            injury: {
                injured: false,
                type: null,
                gamesRemaining: 0
            }
        };
        
        // Add to team
        const updatedPlayers = [...gameState.players, newPlayer];
        setGameState({
            ...gameState,
            players: updatedPlayers
        });
        
        // Mark as signed
        const updatedFreeAgents = freeAgents.map(fa => 
            fa.id === freeAgent.id ? { ...fa, status: 'signed', signedTeam: userTeamId } : fa
        );
        setFreeAgents(updatedFreeAgents);
        
        // Track signed player
        setSignedPlayers(prev => [...prev, {
            player: newPlayer,
            years,
            salary
        }]);
        
        alert(`‚úÖ Signed ${freeAgent.firstName} ${freeAgent.lastName}!\n\n${years} years √ó $${(salary / 1000000).toFixed(1)}M per year\nTotal: $${(years * salary / 1000000).toFixed(1)}M\n\nPlayer added to your roster!`);
        
        // Close offer modal
        setSelectedFreeAgent(null);
        
        return true;
    };
    
    const generateFreeAgencyReportCard = () => {
        if (!signedPlayers || signedPlayers.length === 0) {
            return {
                grade: 'F',
                summary: 'Did not sign any players',
                details: ['No signings made during free agency', 'Roster remains unchanged'],
                color: '#ef4444'
            };
        }
        
        const teamNeeds = analyzeRosterNeeds();
        let score = 0;
        const details = [];
        
        // Analyze signings
        const totalSpent = signedPlayers.reduce((sum, s) => sum + s.salary, 0);
        const avgOVR = signedPlayers.reduce((sum, s) => sum + s.player.ratings.overall, 0) / signedPlayers.length;
        const avgAge = signedPlayers.reduce((sum, s) => sum + s.player.age, 0) / signedPlayers.length;
        
        // Position breakdown
        const forwardsSigned = signedPlayers.filter(s => s.player.position === 'F').length;
        const defenseSigned = signedPlayers.filter(s => s.player.position === 'D').length;
        const goaliesSigned = signedPlayers.filter(s => s.player.position === 'G').length;
        
        // Scoring criteria
        
        // 1. Number of signings (0-20 points)
        if (signedPlayers.length >= 5) {
            score += 20;
            details.push(`‚úÖ Active offseason (${signedPlayers.length} signings)`);
        } else if (signedPlayers.length >= 3) {
            score += 15;
            details.push(`Good activity (${signedPlayers.length} signings)`);
        } else {
            score += signedPlayers.length * 5;
            details.push(`Limited activity (${signedPlayers.length} signings)`);
        }
        
        // 2. Average quality (0-30 points)
        if (avgOVR >= 80) {
            score += 30;
            details.push(`‚≠ê Elite signings (avg ${avgOVR.toFixed(0)} OVR)`);
        } else if (avgOVR >= 75) {
            score += 25;
            details.push(`Strong additions (avg ${avgOVR.toFixed(0)} OVR)`);
        } else if (avgOVR >= 70) {
            score += 15;
            details.push(`Solid depth pieces (avg ${avgOVR.toFixed(0)} OVR)`);
        } else {
            score += 5;
            details.push(`Depth signings (avg ${avgOVR.toFixed(0)} OVR)`);
        }
        
        // 3. Addressed team needs (0-30 points)
        let needsAddressed = 0;
        if (teamNeeds.needs.some(n => n.position === 'F' && n.priority === 'HIGH') && forwardsSigned >= 2) {
            needsAddressed += 15;
            details.push(`Addressed forward needs (${forwardsSigned} signed)`);
        } else if (teamNeeds.needs.some(n => n.position === 'F') && forwardsSigned >= 1) {
            needsAddressed += 10;
        }
        
        if (teamNeeds.needs.some(n => n.position === 'D' && n.priority === 'HIGH') && defenseSigned >= 1) {
            needsAddressed += 15;
            details.push(`Addressed defense needs (${defenseSigned} signed)`);
        } else if (teamNeeds.needs.some(n => n.position === 'D') && defenseSigned >= 1) {
            needsAddressed += 10;
        }
        
        if (teamNeeds.needs.some(n => n.position === 'G' && n.priority === 'CRITICAL') && goaliesSigned >= 1) {
            needsAddressed += 30;
            details.push(`üî• Filled critical goalie need!`);
        } else if (teamNeeds.needs.some(n => n.position === 'G') && goaliesSigned >= 1) {
            needsAddressed += 15;
        }
        
        score += needsAddressed;
        
        // 4. Contract value (0-20 points)
        const avgDealValue = signedPlayers.reduce((sum, s) => {
            const marketValue = s.player.ratings.overall * 100000;
            return sum + (s.salary / marketValue);
        }, 0) / signedPlayers.length;
        
        if (avgDealValue <= 1.05) {
            score += 20;
            details.push(`üí∞ Excellent value (avg ${(avgDealValue * 100).toFixed(0)}% of market)`);
        } else if (avgDealValue <= 1.15) {
            score += 15;
            details.push(`Good value signings`);
        } else if (avgDealValue <= 1.25) {
            score += 10;
            details.push(`Fair market signings`);
        } else {
            score += 5;
            details.push(`‚ö†Ô∏è Some overpays (avg ${(avgDealValue * 100).toFixed(0)}% of market)`);
        }
        
        // 5. Age considerations (0-10 points bonus)
        if (avgAge <= 27) {
            score += 10;
            details.push(`Youth movement (avg age ${avgAge.toFixed(1)})`);
        } else if (avgAge >= 32) {
            details.push(`‚ö†Ô∏è Signed older players (avg age ${avgAge.toFixed(1)})`);
        }
        
        // Determine grade
        let grade, summary, color;
        if (score >= 90) {
            grade = 'A+';
            summary = 'Outstanding offseason!';
            color = '#22c55e';
        } else if (score >= 85) {
            grade = 'A';
            summary = 'Excellent offseason!';
            color = '#22c55e';
        } else if (score >= 80) {
            grade = 'A-';
            summary = 'Very strong offseason';
            color = '#3b82f6';
        } else if (score >= 75) {
            grade = 'B+';
            summary = 'Good offseason';
            color = '#3b82f6';
        } else if (score >= 70) {
            grade = 'B';
            summary = 'Solid offseason';
            color = '#3b82f6';
        } else if (score >= 65) {
            grade = 'B-';
            summary = 'Decent offseason';
            color = '#60a5fa';
        } else if (score >= 60) {
            grade = 'C+';
            summary = 'Average offseason';
            color = '#fbbf24';
        } else if (score >= 55) {
            grade = 'C';
            summary = 'Below average offseason';
            color = '#fbbf24';
        } else if (score >= 50) {
            grade = 'C-';
            summary = 'Concerning offseason';
            color = '#f59e0b';
        } else if (score >= 40) {
            grade = 'D';
            summary = 'Poor offseason';
            color = '#ef4444';
        } else {
            grade = 'F';
            summary = 'Failed to improve team';
            color = '#ef4444';
        }
        
        return {
            grade,
            score,
            summary,
            details,
            color,
            stats: {
                totalSignings: signedPlayers.length,
                totalSpent,
                avgOVR,
                avgAge,
                forwardsSigned,
                defenseSigned,
                goaliesSigned
            }
        };
    };
    
    const calculatePlayerDevelopment = (player) => {
        // Calculate how a player's OVR will change based on age and potential
        const age = player.age + 1; // Next season age
        const currentOVR = player.ratings.overall;
        const potential = player.ratings.potential || currentOVR + 5;
        
        let change = 0;
        let reason = '';
        
        // Development stages
        if (age <= 21) {
            // Young prospects - rapid development
            const gap = potential - currentOVR;
            if (gap >= 15) {
                change = 3 + Math.floor(Math.random() * 3); // +3 to +5
                reason = 'Rapid development (young star)';
            } else if (gap >= 8) {
                change = 2 + Math.floor(Math.random() * 2); // +2 to +3
                reason = 'Strong development';
            } else {
                change = 1 + Math.floor(Math.random() * 2); // +1 to +2
                reason = 'Steady growth';
            }
        } else if (age <= 24) {
            // Development years
            const gap = potential - currentOVR;
            if (gap >= 10) {
                change = 2 + Math.floor(Math.random() * 2); // +2 to +3
                reason = 'Continued development';
            } else if (gap >= 5) {
                change = 1 + Math.floor(Math.random() * 2); // +1 to +2
                reason = 'Gradual improvement';
            } else {
                change = Math.floor(Math.random() * 2); // +0 to +1
                reason = 'Minor improvement';
            }
        } else if (age <= 27) {
            // Prime years - maintain or slight improvement
            const gap = potential - currentOVR;
            if (gap >= 3) {
                change = Math.floor(Math.random() * 2); // +0 to +1
                reason = 'Entering prime';
            } else {
                change = 0;
                reason = 'Peak performance';
            }
        } else if (age <= 30) {
            // Peak years - maintain
            change = 0;
            reason = 'Prime years';
        } else if (age <= 32) {
            // Early decline possible
            const roll = Math.random();
            if (roll < 0.3) {
                change = -1;
                reason = 'Early aging signs';
            } else {
                change = 0;
                reason = 'Veteran experience';
            }
        } else if (age <= 35) {
            // Decline years
            const roll = Math.random();
            if (roll < 0.6) {
                change = -1 - Math.floor(Math.random() * 2); // -1 to -2
                reason = 'Age-related decline';
            } else {
                change = -1;
                reason = 'Aging veteran';
            }
        } else {
            // Significant decline
            change = -2 - Math.floor(Math.random() * 2); // -2 to -3
            reason = 'Rapid decline';
        }
        
        // Don't exceed potential
        const newOVR = Math.min(potential, Math.max(60, currentOVR + change));
        const actualChange = newOVR - currentOVR;
        
        return {
            oldOVR: currentOVR,
            newOVR,
            change: actualChange,
            reason,
            age,
            potential
        };
    };
    
    const generateSeasonPreview = () => {
        if (!gameState) return null;
        
        const userTeamPlayers = gameState.players.filter(p => p.teamId === userTeamId);
        
        // Calculate development for all players
        const playerDevelopment = userTeamPlayers.map(player => ({
            player,
            development: calculatePlayerDevelopment(player)
        }));
        
        // Find significant changes
        const improvements = playerDevelopment.filter(pd => pd.development.change >= 2);
        const declines = playerDevelopment.filter(pd => pd.development.change <= -2);
        const youngStars = playerDevelopment.filter(pd => 
            pd.development.age <= 23 && pd.development.change > 0
        );
        
        // Calculate team strength
        const avgOVR = userTeamPlayers.reduce((sum, p) => sum + p.ratings.overall, 0) / userTeamPlayers.length;
        const newAvgOVR = playerDevelopment.reduce((sum, pd) => sum + pd.development.newOVR, 0) / playerDevelopment.length;
        
        // Find best players
        const topPlayers = playerDevelopment
            .sort((a, b) => b.development.newOVR - a.development.newOVR)
            .slice(0, 5);
        
        // Season expectations based on team strength
        let expectation, color;
        if (newAvgOVR >= 82) {
            expectation = 'Championship Contender';
            color = '#22c55e';
        } else if (newAvgOVR >= 78) {
            expectation = 'Playoff Team';
            color = '#3b82f6';
        } else if (newAvgOVR >= 75) {
            expectation = 'Bubble Team';
            color = '#fbbf24';
        } else if (newAvgOVR >= 72) {
            expectation = 'Rebuilding';
            color = '#f59e0b';
        } else {
            expectation = 'Lottery Team';
            color = '#ef4444';
        }
        
        // Position breakdown
        const forwards = playerDevelopment.filter(pd => pd.player.position === 'F');
        const defense = playerDevelopment.filter(pd => pd.player.position === 'D');
        const goalies = playerDevelopment.filter(pd => pd.player.position === 'G');
        
        const avgForwardOVR = forwards.reduce((sum, pd) => sum + pd.development.newOVR, 0) / forwards.length;
        const avgDefenseOVR = defense.reduce((sum, pd) => sum + pd.development.newOVR, 0) / defense.length;
        const avgGoalieOVR = goalies.reduce((sum, pd) => sum + pd.development.newOVR, 0) / goalies.length;
        
        return {
            year: gameState.year + 1,
            playerDevelopment,
            improvements,
            declines,
            youngStars,
            oldAvgOVR: avgOVR,
            newAvgOVR,
            topPlayers,
            expectation,
            expectationColor: color,
            positionAverages: {
                forward: avgForwardOVR,
                defense: avgDefenseOVR,
                goalie: avgGoalieOVR
            }
        };
    };
    
    // Helper function to check if a player should retire
    const shouldRetire = (player) => {
        // Players retire based on age and overall rating
        if (player.age < 35) return false;
        
        // Age-based retirement probability
        const retirementChance = {
            35: player.ratings.overall < 70 ? 0.05 : 0.01,
            36: player.ratings.overall < 72 ? 0.10 : 0.02,
            37: player.ratings.overall < 75 ? 0.20 : 0.05,
            38: player.ratings.overall < 77 ? 0.35 : 0.10,
            39: player.ratings.overall < 80 ? 0.50 : 0.20,
            40: player.ratings.overall < 82 ? 0.70 : 0.35,
            41: player.ratings.overall < 85 ? 0.85 : 0.50,
            42: 0.95
        };
        
        const chance = retirementChance[Math.min(player.age, 42)] || 0.99;
        return Math.random() < chance;
    };
    
    const startNewSeason = () => {
        if (!gameState) return;
        
        // Set loading state to prevent rendering errors
        setSeasonTransitioning(true);
        
        // Use setTimeout to ensure loading state is set before we start changing data
        setTimeout(() => {
            // ==================== ARCHIVE SEASON STATS ====================
            
            // Archive the completed season's stats
            const seasonArchive = {
                season: gameState.season,
                year: gameState.year,
                playerStats: gameState.players.map(player => ({
                    playerId: player.id,
                    firstName: player.firstName,
                    lastName: player.lastName,
                    position: player.position,
                    age: player.age,
                    teamId: player.teamId,
                    regularSeason: { ...player.stats },
                    playoffs: player.playoffStats ? { ...player.playoffStats } : null,
                    overall: player.ratings.overall
                })),
                teamStandings: gameState.standings.map(s => ({ ...s })),
                playoffResults: playoffState ? {
                    champion: playoffState.champion,
                    runnerUp: playoffState.runnerUp,
                    rounds: playoffState.rounds ? [...playoffState.rounds] : []
                } : null
            };
            
            // Initialize seasonHistory if it doesn't exist (for old saves)
            const currentSeasonHistory = gameState.seasonHistory || {
                archivedSeasons: [],
                retiredPlayers: []
            };
            
            // Add this season to the archive
            const updatedArchivedSeasons = [...currentSeasonHistory.archivedSeasons, seasonArchive];
            
            // ==================== END ARCHIVE ====================
            
            // Advance to next year
            const newYear = gameState.year + 1;
            const newSeason = gameState.season + 1;
            
            // Age all players by 1 year and apply development + UPDATE CAREER TOTALS
            const agedPlayers = gameState.players.map(player => {
                const development = calculatePlayerDevelopment(player);
                
                // Calculate career totals from archived seasons + current season
                const playerArchivedStats = updatedArchivedSeasons
                    .map(s => s.playerStats.find(ps => ps.playerId === player.id))
                    .filter(ps => ps !== undefined);
                
                // Sum up regular season career totals
                const careerRegularSeason = playerArchivedStats.reduce((totals, archived) => {
                    if (!archived || !archived.regularSeason) return totals;
                    return {
                        gamesPlayed: totals.gamesPlayed + (archived.regularSeason.gamesPlayed || 0),
                        goals: totals.goals + (archived.regularSeason.goals || 0),
                        assists: totals.assists + (archived.regularSeason.assists || 0),
                        points: totals.points + (archived.regularSeason.points || 0),
                        plusMinus: totals.plusMinus + (archived.regularSeason.plusMinus || 0),
                        pim: totals.pim + (archived.regularSeason.pim || 0),
                        shots: totals.shots + (archived.regularSeason.shots || 0),
                        ppGoals: totals.ppGoals + (archived.regularSeason.ppGoals || 0),
                        shGoals: totals.shGoals + (archived.regularSeason.shGoals || 0),
                        gwGoals: totals.gwGoals + (archived.regularSeason.gwGoals || 0),
                        hits: totals.hits + (archived.regularSeason.hits || 0),
                        blocks: totals.blocks + (archived.regularSeason.blocks || 0)
                    };
                }, {
                    gamesPlayed: 0, goals: 0, assists: 0, points: 0, plusMinus: 0,
                    pim: 0, shots: 0, ppGoals: 0, shGoals: 0, gwGoals: 0,
                    hits: 0, blocks: 0
                });
                
                // Sum up playoff career totals
                const careerPlayoffs = playerArchivedStats.reduce((totals, archived) => {
                    if (!archived || !archived.playoffs) return totals;
                    return {
                        gamesPlayed: totals.gamesPlayed + (archived.playoffs.gamesPlayed || 0),
                        goals: totals.goals + (archived.playoffs.goals || 0),
                        assists: totals.assists + (archived.playoffs.assists || 0),
                        points: totals.points + (archived.playoffs.points || 0),
                        plusMinus: totals.plusMinus + (archived.playoffs.plusMinus || 0),
                        pim: totals.pim + (archived.playoffs.pim || 0)
                    };
                }, {
                    gamesPlayed: 0, goals: 0, assists: 0, points: 0, plusMinus: 0, pim: 0
                });
                
                // Goalie career totals
                let careerGoalieStats = null;
                if (player.position === 'G') {
                    careerGoalieStats = playerArchivedStats.reduce((totals, archived) => {
                        if (!archived || !archived.regularSeason) return totals;
                        const gs = archived.regularSeason;
                        return {
                            gamesPlayed: totals.gamesPlayed + (gs.gamesPlayed || 0),
                            wins: totals?.wins + (gs?.wins || 0),
                            losses: totals?.losses + (gs?.losses || 0),
                            saves: totals.saves + (gs.saves || 0),
                            shotsAgainst: totals.shotsAgainst + (gs.shotsAgainst || 0),
                            goalsAgainst: totals.goalsAgainst + (gs.goalsAgainst || 0),
                            shutouts: totals.shutouts + (gs.shutouts || 0)
                        };
                    }, {
                        gamesPlayed: 0, wins: 0, losses: 0, saves: 0,
                        shotsAgainst: 0, goalsAgainst: 0, shutouts: 0
                    });
                }
                
                return {
                    ...player,
                    age: player.age + 1,
                    ratings: {
                        ...player.ratings,
                        overall: development.newOVR
                    },
                    // Decrease contract years remaining and handle expiry
                    contract: player.contract ? {
                        ...player.contract,
                        yearsRemaining: Math.max(0, player.contract.yearsRemaining - 1),
                        // Mark as UFA if contract expires (0 years remaining after decrement)
                        status: (player.contract.yearsRemaining - 1) <= 0 ? 'UFA' : player.contract.status || 'signed'
                    } : undefined,
                    // Store career totals for quick access
                    careerTotals: {
                        regularSeason: careerRegularSeason,
                        playoffs: careerPlayoffs,
                        goalieStats: careerGoalieStats
                    }
                };
            });
            
            // ==================== PROCESS RETIREMENTS ====================
            
            // Check for retirements
            const retiringPlayers = [];
            const activePlayers = [];
            
            agedPlayers.forEach(player => {
                if (shouldRetire(player)) {
                    // Archive the retiring player with full career stats
                    retiringPlayers.push({
                        ...player,
                        retirementYear: newYear,
                        retirementSeason: newSeason,
                        // Include their career totals
                        finalCareerTotals: player.careerTotals
                    });
                } else {
                    activePlayers.push(player);
                }
            });
            
            // Update retired players list
            const updatedRetiredPlayers = [
                ...(currentSeasonHistory.retiredPlayers || []),
                ...retiringPlayers
            ];
            
            // ==================== END RETIREMENTS ====================
            
            // Reset all player stats for new season (only for active players)
            const resetPlayers = activePlayers.map(player => ({
                ...player,
                stats: {
                    gamesPlayed: 0,
                    goals: 0,
                    assists: 0,
                    points: 0,
                    plusMinus: 0,
                    pim: 0,
                    shots: 0,
                    timeOnIce: 0
                },
                goalieStats: player.position === 'G' ? {
                    gamesPlayed: 0,
                    wins: 0,
                    losses: 0,
                    saves: 0,
                    shotsAgainst: 0,
                    goalsAgainst: 0,
                    shutouts: 0
                } : undefined,
                playoffStats: player.position === 'G' ? {
                    gamesPlayed: 0,
                    wins: 0,
                    losses: 0,
                    saves: 0,
                    shotsAgainst: 0,
                    goalsAgainst: 0,
                    shutouts: 0
                } : {
                    gamesPlayed: 0,
                    goals: 0,
                    assists: 0,
                    points: 0,
                    plusMinus: 0,
                    pim: 0
                },
                lastGameGoals: 0,
                injury: {
                    injured: false,
                    type: null,
                    gamesRemaining: 0
                }
            }));
            
            // Reset standings - make sure ALL teams have standings
            const resetStandings = TEAMS.map(team => ({
                teamId: team.id,
                wins: 0,
                losses: 0,
                otLosses: 0,
                points: 0,
                goalsFor: 0,
                goalsAgainst: 0,
                home: { wins: 0, losses: 0 },
                away: { wins: 0, losses: 0 },
                currentStreak: { type: null, count: 0 },
                teamStats: {
                    gamesPlayed: 0,
                    shots: 0,
                    shotsAgainst: 0,
                    ppOpportunities: 0,
                    ppGoals: 0,
                    pkOpportunities: 0,
                    pkGoalsAgainst: 0,
                    hits: 0,
                    blockedShots: 0,
                    faceoffWins: 0,
                    faceoffLosses: 0,
                    pim: 0
                }
            }));
            
            // ==================== GENERATE ROOKIES TO REPLACE RETIREES ====================
            
            // Generate new rookies to replace retired players
            const rookiesNeeded = retiringPlayers.length;
            const newRookies = [];
            
            if (rookiesNeeded > 0) {
                // Distribute rookies across teams proportionally to their retirements
                const teamRetirementCounts = {};
                retiringPlayers.forEach(p => {
                    if (!teamRetirementCounts[p.teamId]) teamRetirementCounts[p.teamId] = { F: 0, D: 0, G: 0 };
                    teamRetirementCounts[p.teamId][p.position]++;
                });
                
                // Generate rookies for each team based on what they lost
                Object.entries(teamRetirementCounts).forEach(([teamId, counts]) => {
                    const tid = parseInt(teamId);
                    
                    // Generate forwards
                    for (let i = 0; i < counts.F; i++) {
                        newRookies.push(generatePlayer('F', tid, 0, false));
                    }
                    
                    // Generate defensemen
                    for (let i = 0; i < counts.D; i++) {
                        newRookies.push(generatePlayer('D', tid, 0, false));
                    }
                    
                    // Generate goalies
                    for (let i = 0; i < counts.G; i++) {
                        newRookies.push(generatePlayer('G', tid, 0, false));
                    }
                });
            }
            
            // Combine active players with new rookies
            const allPlayersForNewSeason = [...resetPlayers, ...newRookies];
            
            // ==================== END ROOKIE GENERATION ====================
            
            // Generate new schedule
            const newSchedule = generateSchedule();
            
            // Batch ALL state updates together
            const newGameState = {
                ...gameState,
                season: newSeason,
                year: newYear,
                currentDay: 0,
                players: allPlayersForNewSeason,
                standings: resetStandings,
                schedule: newSchedule,
                seasonComplete: false,
                games: [],
                aiTradeLog: [], // Reset AI trades for new season
                tradeHistory: [], // Reset player trades for new season
                seasonHistory: {
                    archivedSeasons: updatedArchivedSeasons,
                    retiredPlayers: updatedRetiredPlayers
                }
            };
            
            // Reset all related state in one batch
            setGameState(newGameState);
            setPlayoffState(null);
            setSeasonMode('regular');
            setSeasonAwards(null); // Reset awards for new season
            setDraftProspects(null);
            setDraftResults([]);
            setCurrentDraftPick(1);
            setDraftRound(1);
            setFreeAgents(null);
            setSignedPlayers([]);
            setShowReportCard(false);
            setShowSeasonPreview(false);
            setSeasonNotifications([]);
            
            // Save and navigate AFTER a delay to ensure state is updated
            setTimeout(() => {
                saveGameToLocalStorage(newGameState, userTeamId, null, 'regular');
                setCurrentView('teamLanding'); // Start new season at Team Hub
                // Clear loading state
                setSeasonTransitioning(false);
            }, 200);
        }, 50);
    };

    // Simulation wrappers with popup
    const simulateWithPopup = async (days) => {
        if (!gameState) return;
        
        // VALIDATE LINEUP BEFORE SIMULATION
        const validation = validateLineup();
        if (!validation.valid) {
            const injuredCount = gameState.players.filter(p => p.teamId === userTeamId && p.injury?.injured).length;
            let errorMsg = '‚ùå Cannot simulate games. Your lineup is invalid!\n\nPlease fix these issues:\n\n' + validation.errors.join('\n');
            
            if (injuredCount > 0) {
                errorMsg += `\n\n‚ö†Ô∏è You have ${injuredCount} injured player${injuredCount > 1 ? 's' : ''}. Consider calling up players from your farm team!\n\nGo to: MY TEAM ‚Üí Call-Ups & Send-Downs`;
            } else {
                errorMsg += '\n\nGo to: MY TEAM ‚Üí Lines & Depth Chart\nTip: Use "Auto-Set Best Lineup" button to quickly fix these issues.';
            }
            
            alert(errorMsg);
            return;
        }
        
        setSimPopupVisible(true);
        setSimPopupTotalDays(days);
        stopSimulationRef.current = false; // Reset stop flag
        tradeDeadlinePromptShownRef.current = false; // Reset trade deadline prompt
        
        let currentTrackingDay = gameState.currentDay;
        let workingState = gameState; // Track the state as it updates
        
        for (let d = 0; d < days; d++) {
            // Check if season is complete
            if (currentTrackingDay > 82) {
                break;
            }
            
            // Check if approaching trade deadline (Day 56) and pause to ask user
            if (currentTrackingDay === 56 && !tradeDeadlinePromptShownRef.current) {
                tradeDeadlinePromptShownRef.current = true;
                setShowTradeDeadlinePrompt(true);
                
                // Wait for user decision
                const shouldContinue = await new Promise(resolve => {
                    window.tradeDeadlineDecision = resolve;
                });
                
                setShowTradeDeadlinePrompt(false);
                
                if (!shouldContinue) {
                    // User wants to make trades - stop simulation
                    setSimPopupVisible(false);
                    clearAndNavigate('trade');
                    return;
                }
                // Otherwise continue simulating
            }
            
            setSimPopupDay(d + 1);
            setSimPopupGameDay(currentTrackingDay);
            
            // Show "Simulating..." with placeholder
            const currentDaySchedule = workingState.schedule?.find(day => day.day === currentTrackingDay);
            const dayGames = [];
            
            if (currentDaySchedule?.matchups) {
                currentDaySchedule.matchups.forEach(matchup => {
                    // Only show user team games in regular season
                    if (matchup.homeTeam === userTeamId || matchup.awayTeam === userTeamId) {
                        const homeTeam = teamLookup[matchup.homeTeam];
                        const awayTeam = teamLookup[matchup.awayTeam];
                        dayGames.push({
                            homeTeam: `${homeTeam.city} ${homeTeam.name}`,
                            awayTeam: `${awayTeam.city} ${awayTeam.name}`,
                            homeTeamId: matchup.homeTeam,
                            awayTeamId: matchup.awayTeam,
                            homeScore: '--',
                            awayScore: '--',
                            isUserTeam: true, // Always true since we filtered
                            gameDay: currentTrackingDay
                        });
                    }
                });
            }
            
            setSimPopupGames(dayGames);
            
            // If user team has no game this day, show that
            if (dayGames.length === 0) {
                setSimPopupGames([{
                    homeTeam: 'No Game Today',
                    awayTeam: '',
                    homeTeamId: null,
                    awayTeamId: null,
                    homeScore: '--',
                    awayScore: '--',
                    isUserTeam: false,
                    gameDay: currentTrackingDay,
                    noGame: true
                }]);
            }
            
            // Brief pause to show "Simulating..." (reduced to 100ms / 0.1 seconds)
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Simulate the day and get the updated state - PASS IN workingState!
            const updatedState = simulateDay82(workingState);
            if (!updatedState) break; // Safety check
            workingState = updatedState; // Update our working copy
            
            // Update gameState live so popup can show current record
            setGameState(updatedState);
            
            // Wait a moment for React render (reduced from 150ms to 50ms)
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Now get the scores from the updated state
            const simulatedDaySchedule = updatedState.schedule?.find(day => day.day === currentTrackingDay);
            if (simulatedDaySchedule?.matchups) {
                const resultsGames = [];
                simulatedDaySchedule.matchups.forEach(matchup => {
                    // Only show user team games in regular season
                    if (matchup.homeTeam === userTeamId || matchup.awayTeam === userTeamId) {
                        const homeTeam = teamLookup[matchup.homeTeam];
                        const awayTeam = teamLookup[matchup.awayTeam];
                        resultsGames.push({
                            homeTeam: `${homeTeam.city} ${homeTeam.name}`,
                            awayTeam: `${awayTeam.city} ${awayTeam.name}`,
                            homeTeamId: matchup.homeTeam,
                            awayTeamId: matchup.awayTeam,
                            homeScore: matchup.homeScore,
                            awayScore: matchup.awayScore,
                            isUserTeam: true, // Always true since we filtered
                            gameDay: currentTrackingDay
                        });
                    }
                });
                setSimPopupGames(resultsGames);
            }
            
            // Increment tracking day for next iteration
            currentTrackingDay++;
            
            // Show results for 0.5s before moving to next day (reduced from 0.8s)
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Check if user wants to stop AFTER completing current day
            if (stopSimulationRef.current) {
                setSimPopupVisible(false);
                // Stay on current page - don't auto-navigate
                return;
            }
        }
        
        setSimPopupDay(days + 1); // Mark as complete
        
        // Check if season is complete after simulation loop
        if (workingState && workingState.currentDay > 82) {
            // Season complete - calculate awards and navigate
            const awards = calculateAwards(workingState.players, workingState.standings);
            setSeasonAwards(awards);
            
            // Small delay to let popup show "Complete" before navigating
            setTimeout(() => {
                setSimPopupVisible(false);
                setCurrentView('awards');
            }, 1000);
        }
    };
    
    const simulateDay82WithPopup = () => simulateWithPopup(1);
    const simulate7GamesWithPopup = () => simulateWithPopup(7);
    const simulate30GamesWithPopup = () => simulateWithPopup(30);
    const simulateSeasonWithPopup = () => {
        // Calculate remaining days until day 82
        const remainingDays = 82 - gameState.currentDay + 1;
        simulateWithPopup(remainingDays);
    };
    
    // Helper function to add notification without duplicates
    const addUniqueNotification = (notification) => {
        setSeasonNotifications(prev => {
            // Check if notification with same title and message already exists
            const isDuplicate = prev.some(existingNotif => 
                existingNotif.title === notification.title && 
                existingNotif.message === notification.message
            );
            
            if (isDuplicate) {
                return prev; // Don't add duplicate
            }
            
            return [notification, ...prev].slice(0, 10);
        });
    };
    
    // Check for player milestones and create notifications
    const checkPlayerMilestones = () => {
        if (!gameState) return;
        
        const newNotifications = [];
        
        gameState.players.forEach(player => {
            if (player.teamId === userTeamId) {
                const stats = player.stats;
                
                // 50 goal milestone
                if (stats.goals === 50) {
                    newNotifications.push({
                        type: 'milestone',
                        icon: 'üéØ',
                        title: '50 Goal Milestone!',
                        message: `${player.firstName} ${player.lastName} just scored their 50th goal of the season!`,
                        color: '#fbbf24',
                        day: gameState.currentDay,
                        timestamp: Date.now()
                    });
                }
                
                // 100 point milestone
                if (stats.points === 100) {
                    newNotifications.push({
                        type: 'milestone',
                        icon: 'üíØ',
                        title: '100 Point Milestone!',
                        message: `${player.firstName} ${player.lastName} has reached 100 points this season!`,
                        color: '#22c55e',
                        day: gameState.currentDay,
                        timestamp: Date.now()
                    });
                }
                
                // Hat trick
                if (player.lastGameGoals === 3) {
                    newNotifications.push({
                        type: 'milestone',
                        icon: 'üé©',
                        title: 'Hat Trick!',
                        message: `${player.firstName} ${player.lastName} scored 3 goals in the last game!`,
                        color: '#3b82f6',
                        day: gameState.currentDay,
                        timestamp: Date.now()
                    });
                }
                
                // Point streak (10+ games)
                if (player.currentStreak?.type === 'point' && player.currentStreak.games === 10) {
                    newNotifications.push({
                        type: 'milestone',
                        icon: 'üî•',
                        title: '10-Game Point Streak!',
                        message: `${player.firstName} ${player.lastName} has points in 10 straight games!`,
                        color: '#ef4444',
                        day: gameState.currentDay,
                        timestamp: Date.now()
                    });
                }
                
                // NEW: Injury notifications
                if (player.injury.injured && player.injury.gamesRemaining > 0 && !player.injury.notified) {
                    newNotifications.push({
                        type: 'injury',
                        icon: 'üè•',
                        title: 'Injury Report',
                        message: `${player.firstName} ${player.lastName} injured - Out ${player.injury.gamesRemaining} games`,
                        color: '#ef4444',
                        day: gameState.currentDay,
                        timestamp: Date.now()
                    });
                    player.injury.notified = true; // Mark as notified
                }
            }
        });
        
        // NEW: Check for standings changes and playoff picture updates
        const userStanding = gameState.standings.find(s => s.teamId === userTeamId);
        if (userStanding) {
            const conferenceTeams = gameState.standings.filter(s => {
                const team = TEAMS.find(t => t.id === s.teamId);
                const userTeam = TEAMS.find(t => t.id === userTeamId);
                return team && userTeam && team.conference === userTeam.conference;
            }).sort((a, b) => b.points - a.points);
            
            const userRank = conferenceTeams.findIndex(s => s.teamId === userTeamId) + 1;
            
            // Check if entered playoff picture (moved into top 8)
            if (userRank === 8 && !userStanding.playoffNotified) {
                newNotifications.push({
                    type: 'standings',
                    icon: 'üèÜ',
                    title: 'Playoff Picture!',
                    message: `Your team has moved into 8th place - currently in a playoff spot!`,
                    color: '#22c55e',
                    day: gameState.currentDay,
                    timestamp: Date.now()
                });
                userStanding.playoffNotified = true;
            }
            
            // Check if dropped out of playoffs (fell below 8th)
            if (userRank === 9 && !userStanding.playoffLossNotified) {
                newNotifications.push({
                    type: 'standings',
                    icon: '‚ö†Ô∏è',
                    title: 'Playoff Picture Alert',
                    message: `Your team has dropped to 9th place - outside playoff picture`,
                    color: '#f59e0b',
                    day: gameState.currentDay,
                    timestamp: Date.now()
                });
                userStanding.playoffLossNotified = true;
            }
        }
        
        // Add new notifications to the array (newest first, keep max 10)
        if (newNotifications.length > 0) {
            setSeasonNotifications(prev => {
                // Filter out duplicates - check if notification with same title and message already exists
                const uniqueNewNotifications = newNotifications.filter(newNotif => {
                    return !prev.some(existingNotif => 
                        existingNotif.title === newNotif.title && 
                        existingNotif.message === newNotif.message
                    );
                });
                
                if (uniqueNewNotifications.length === 0) {
                    return prev; // No new unique notifications
                }
                
                const updated = [...uniqueNewNotifications, ...prev];
                return updated.slice(0, 10); // Keep only most recent 10
            });
        }
    };
    
    // Check for trade deadline approaching
    const checkTradeDeadline = () => {
        if (!gameState) return;
        
        const tradeDeadlineDay = 56;
        const daysUntilDeadline = tradeDeadlineDay - gameState.currentDay;
        
        // Show warning 7 days before deadline
        if (daysUntilDeadline === 7 && !tradeDeadlineWarningShown) {
            addUniqueNotification({
                type: 'deadline',
                icon: '‚è∞',
                title: 'Trade Deadline Approaching!',
                message: `Only 7 days left to make trades! Deadline is Day ${tradeDeadlineDay}.`,
                color: '#f59e0b',
                day: gameState.currentDay,
                timestamp: Date.now()
            });
            setTradeDeadlineWarningShown(true);
        }
        
        // Show final warning on deadline day
        if (daysUntilDeadline === 0) {
            addUniqueNotification({
                type: 'deadline',
                icon: 'üö®',
                title: 'Trade Deadline TODAY!',
                message: 'Last chance to make trades! Trading closes after today.',
                color: '#ef4444',
                day: gameState.currentDay,
                timestamp: Date.now()
            });
        }
        
        // Show "deadline passed" notification
        if (daysUntilDeadline === -1) {
            addUniqueNotification({
                type: 'deadline',
                icon: 'üîí',
                title: 'Trade Deadline Has Passed',
                message: 'No more trades allowed until the offseason.',
                color: '#64748b',
                day: gameState.currentDay,
                timestamp: Date.now()
            });
        }
    };
    
    // Track injuries to star players (85+ OVR)
    const checkInjuries = () => {
        if (!gameState) return;
        
        gameState.players.forEach(player => {
            if (player.teamId === userTeamId && player.ratings.overall >= 85) {
                // Check if player just got injured this day
                if (player.injury.injured && !player.injury.notified) {
                    addUniqueNotification({
                        type: 'injury',
                        icon: 'üè•',
                        title: 'Star Player Injured!',
                        message: `${player.firstName} ${player.lastName} (${player.ratings.overall} OVR) is out for ${player.injury.gamesRemaining} games.`,
                        color: '#ef4444',
                        day: gameState.currentDay,
                        timestamp: Date.now()
                    });
                    player.injury.notified = true; // Mark as notified
                }
            }
        });
    };
    
    // Track major AI trades
    const checkAITrades = (previousTradeCount, currentTradeCount) => {
        if (currentTradeCount > previousTradeCount) {
            const newTrades = currentTradeCount - previousTradeCount;
            if (newTrades > 0) {
                addUniqueNotification({
                    type: 'trade',
                    icon: 'üîÑ',
                    title: newTrades === 1 ? 'Trade Completed' : 'Trades Completed',
                    message: `${newTrades} trade${newTrades > 1 ? 's' : ''} around the league today.`,
                    color: '#3b82f6',
                    day: gameState.currentDay,
                    timestamp: Date.now()
                });
            }
        }
    };
    
    // Track playoff clinching/elimination
    const checkPlayoffStatus = () => {
        if (!gameState || !gameState.standings || gameState.currentDay < 60) return;
        
        const playoffInfo = getPlayoffRaceInfo();
        if (!playoffInfo) return;
        
        // Check if user team just clinched
        const userConference = TEAMS.find(t => t.id === userTeamId)?.conference;
        const userTeamStatus = playoffInfo[userConference]?.clinched?.find(t => t.teamId === userTeamId);
        
        if (userTeamStatus && !userTeamStatus.notifiedClinch) {
            addUniqueNotification({
                type: 'playoff',
                icon: 'üéâ',
                title: 'Playoffs Clinched!',
                message: `Your team has clinched a playoff spot!`,
                color: '#22c55e',
                day: gameState.currentDay,
                timestamp: Date.now()
            });
            userTeamStatus.notifiedClinch = true;
        }
        
        // Check if user team just eliminated
        const userTeamEliminated = playoffInfo[userConference]?.eliminated?.some(t => t.teamId === userTeamId);
        const userStanding = gameState.standings.find(s => s.teamId === userTeamId);
        
        if (userStanding && userTeamEliminated && !userStanding.notifiedEliminated) {
            addUniqueNotification({
                type: 'playoff',
                icon: '‚ùå',
                title: 'Eliminated from Playoffs',
                message: `Your team has been eliminated from playoff contention.`,
                color: '#64748b',
                day: gameState.currentDay,
                timestamp: Date.now()
            });
            userStanding.notifiedEliminated = true;
        }
    };
    
    
    // Calculate playoff race information
    const getPlayoffRaceInfo = () => {
        if (!gameState || !gameState.standings || gameState.currentDay < 60) return null; // Only show in final 22 games
        
        const standings = [...gameState.standings].sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            if (b?.wins !== a?.wins) return b?.wins - a?.wins;
            return b.goalsFor - a.goalsFor;
        });
        
        // Separate by conference
        const eastTeams = standings.filter(t => {
            const team = TEAMS.find(tm => tm.id === t.teamId);
            return team && team.conference === 'Eastern';
        });
        
        const westTeams = standings.filter(t => {
            const team = TEAMS.find(tm => tm.id === t.teamId);
            return team && team.conference === 'Western';
        });
        
        const getConferenceRaceInfo = (confTeams, confName) => {
            const top8 = confTeams.slice(0, 8);
            const bubble = confTeams.slice(8, 11); // Teams 9-11
            
            const info = {
                clinched: [],
                inRace: [],
                eliminated: []
            };
            
            confTeams.forEach((team, idx) => {
                const gamesLeft = 82 - team.gamesPlayed;
                const maxPoints = team.points + (gamesLeft * 2);
                const eighthPlacePoints = top8[7]?.points || 0;
                
                const teamObj = TEAMS.find(t => t.id === team.teamId);
                if (!teamObj) return; // Skip if team not found
                const teamName = `${teamObj.city} ${teamObj.name}`;
                
                if (idx < 8) {
                    // Check if clinched
                    const ninthPlaceMaxPoints = confTeams[8]?.points + ((82 - confTeams[8]?.gamesPlayed) * 2) || 0;
                    if (team.points > ninthPlaceMaxPoints) {
                        info.clinched.push({ name: teamName, seed: idx + 1 });
                    } else {
                        info.inRace.push({ name: teamName, seed: idx + 1, status: 'holding spot' });
                    }
                } else if (maxPoints >= eighthPlacePoints) {
                    info.inRace.push({ name: teamName, pointsBack: eighthPlacePoints - team.points });
                } else {
                    info.eliminated.push({ name: teamName });
                }
            });
            
            return info;
        };
        
        return {
            east: getConferenceRaceInfo(eastTeams, 'Eastern'),
            west: getConferenceRaceInfo(westTeams, 'Western')
        };
    };

    const renderStandings = () => {
        if (!gameState || !gameState.standings) return null;

        // Helper function to get last 10 games record and current streak
        const getTeamLast10AndStreak = (teamId) => {
            // Get all games for this team (played only) - need to flatten the day/matchups structure
            const teamGames = [];
            
            gameState.schedule.forEach(daySchedule => {
                if (daySchedule.matchups) {
                    daySchedule.matchups.forEach(matchup => {
                        if (matchup.played && (matchup.homeTeam === teamId || matchup.awayTeam === teamId)) {
                            teamGames.push({
                                ...matchup,
                                day: daySchedule.day
                            });
                        }
                    });
                }
            });
            
            // Sort by day to ensure chronological order
            teamGames.sort((a, b) => a.day - b.day);
            
            // Get last 10 games
            const last10Games = teamGames.slice(-10);
            
            let wins = 0, losses = 0, otLosses = 0;
            const results = []; // Will store 'W', 'L', 'OTL'
            
            last10Games.forEach(game => {
                const isHome = game.homeTeam === teamId;
                const teamScore = isHome ? game.homeScore : game.awayScore;
                const oppScore = isHome ? game.awayScore : game.homeScore;
                
                if (teamScore > oppScore) {
                    wins++;
                    results.push('W');
                } else if (game.overtime) {
                    otLosses++;
                    results.push('OTL');
                } else {
                    losses++;
                    results.push('L');
                }
            });
            
            const last10Record = `${wins}-${losses}-${otLosses}`;
            
            // Calculate streak (current)
            let streak = '';
            let streakCount = 0;
            if (results.length > 0) {
                const lastResult = results[results.length - 1];
                streakCount = 1;
                
                // Count backwards from end
                for (let i = results.length - 2; i >= 0; i--) {
                    if (results[i] === lastResult) {
                        streakCount++;
                    } else {
                        break;
                    }
                }
                
                streak = lastResult + streakCount;
            }
            
            return { last10Record, streak, streakType: results.length > 0 ? results[results.length - 1] : '' };
        };

        const sortedStandings = [...gameState.standings].sort((a, b) => b.points - a.points);

        if (standingsView === 'division') {
            return ['Atlantic', 'Metropolitan', 'Central', 'Pacific'].map(division => {
                const divTeams = TEAMS.filter(t => t.division === division);
                const divStandings = sortedStandings.filter(s => divTeams.some(t => t.id === s.teamId));
                
                return (
                    <div key={division} className="card">
                        <h2>{division} Division</h2>
                        <table className="standings-table">
                            <thead>
                                <tr>
                                    <th className="rank" title="Division Rank">#</th>
                                    <th>Team</th>
                                    <th className="text-center" title="Games Played">GP</th>
                                    <th className="text-center" title="Wins">W</th>
                                    <th className="text-center" title="Losses">L</th>
                                    <th className="text-center" title="Overtime Losses">OTL</th>
                                    <th className="text-center" title="Points - 2 points for a win">PTS</th>
                                    <th className="text-center" title="Goals For - Total goals scored">GF</th>
                                    <th className="text-center" title="Goals Against - Total goals allowed">GA</th>
                                    <th className="text-center" title="Goal Differential - GF minus GA">DIFF</th>
                                    <th className="text-center" title="Home Record - W-L at home">HOME</th>
                                    <th className="text-center" title="Away Record - W-L on the road">AWAY</th>
                                    <th className="text-center" title="Last 10 Games - Record in last 10 games">L10</th>
                                    <th className="text-center" title="Current Streak - W for win streak, L for loss streak, number shows length">STRK</th>
                                </tr>
                            </thead>
                            <tbody>
                                {divStandings.map((standing, idx) => {
                                    const team = TEAMS.find(t => t.id === standing.teamId);
                                    const isUserTeam = team.id === userTeamId;
                                    const isPlayoff = idx < 3;
                                    const gp = standing?.wins + standing?.losses + standing?.otLosses;
                                    const diff = standing.goalsFor - standing.goalsAgainst;
                                    const { last10Record, streak, streakType } = getTeamLast10AndStreak(team.id);
                                    
                                    // Determine streak color
                                    const streakColor = streakType === 'W' ? '#22c55e' : streakType === 'L' ? '#ef4444' : '#fbbf24';
                                    
                                    return (
                                        <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} ${isPlayoff ? 'playoff' : ''}`}>
                                            <td className="rank">{idx + 1}</td>
                                            <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>
                                                {team.city} {team.name}
                                            </td>
                                            <td className="text-center">{gp}</td>
                                            <td className="text-center">{standing?.wins}</td>
                                            <td className="text-center">{standing?.losses}</td>
                                            <td className="text-center">{standing?.otLosses}</td>
                                            <td className="text-center">{standing.points}</td>
                                            <td className="text-center">{standing.goalsFor}</td>
                                            <td className="text-center">{standing.goalsAgainst}</td>
                                            <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                            <td className="text-center">{standing.home?.wins}-{standing.home?.losses}</td>
                                            <td className="text-center">{standing.away?.wins}-{standing.away?.losses}</td>
                                            <td className="text-center">{last10Record}</td>
                                            <td className="text-center" style={{ color: streakColor, fontWeight: 'bold' }}>
                                                {streak}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            });
        }

        if (standingsView === 'conference') {
            return ['East', 'West'].map(conference => {
                const confTeams = TEAMS.filter(t => t.conference === conference);
                const confStandings = sortedStandings.filter(s => confTeams.some(t => t.id === s.teamId));
                
                return (
                    <div key={conference} className="card">
                        <h2>{conference}ern Conference</h2>
                        <table className="standings-table">
                            <thead>
                                <tr>
                                    <th className="rank" title="Conference Rank">#</th>
                                    <th>Team</th>
                                    <th className="text-center" title="Games Played">GP</th>
                                    <th className="text-center" title="Wins">W</th>
                                    <th className="text-center" title="Losses">L</th>
                                    <th className="text-center" title="Overtime Losses">OTL</th>
                                    <th className="text-center" title="Points - 2 points for a win">PTS</th>
                                    <th className="text-center" title="Goals For - Total goals scored">GF</th>
                                    <th className="text-center" title="Goals Against - Total goals allowed">GA</th>
                                    <th className="text-center" title="Goal Differential - GF minus GA">DIFF</th>
                                    <th className="text-center" title="Home Record - W-L at home">HOME</th>
                                    <th className="text-center" title="Away Record - W-L on the road">AWAY</th>
                                    <th className="text-center" title="Last 10 Games - Record in last 10 games">L10</th>
                                    <th className="text-center" title="Current Streak - W for win streak, L for loss streak">STRK</th>
                                </tr>
                            </thead>
                            <tbody>
                                {confStandings.map((standing, idx) => {
                                    const team = TEAMS.find(t => t.id === standing.teamId);
                                    const isUserTeam = team.id === userTeamId;
                                    const isPlayoff = idx < 8;
                                    const gp = standing?.wins + standing?.losses + standing?.otLosses;
                                    const diff = standing.goalsFor - standing.goalsAgainst;
                                    const { last10Record, streak, streakType } = getTeamLast10AndStreak(team.id);
                                    const streakColor = streakType === 'W' ? '#22c55e' : streakType === 'L' ? '#ef4444' : '#fbbf24';
                                    
                                    return (
                                        <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} ${isPlayoff ? 'playoff' : ''}`}>
                                            <td className="rank">{idx + 1}</td>
                                            <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name} ({team.division})</td>
                                            <td className="text-center">{gp}</td>
                                            <td className="text-center">{standing?.wins}</td>
                                            <td className="text-center">{standing?.losses}</td>
                                            <td className="text-center">{standing?.otLosses}</td>
                                            <td className="text-center">{standing.points}</td>
                                            <td className="text-center">{standing.goalsFor}</td>
                                            <td className="text-center">{standing.goalsAgainst}</td>
                                            <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                            <td className="text-center">{standing.home?.wins}-{standing.home?.losses}</td>
                                            <td className="text-center">{standing.away?.wins}-{standing.away?.losses}</td>
                                            <td className="text-center">{last10Record}</td>
                                            <td className="text-center" style={{ color: streakColor, fontWeight: 'bold' }}>
                                                {streak}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            });
        }

        if (standingsView === 'wildcard') {
            return ['East', 'West'].map(conference => {
                const confTeams = TEAMS.filter(t => t.conference === conference);
                const confStandings = sortedStandings.filter(s => confTeams.some(t => t.id === s.teamId));
                
                const divisions = conference === 'East' ? ['Atlantic', 'Metropolitan'] : ['Central', 'Pacific'];
                const divisionLeaders = [];
                
                divisions.forEach(division => {
                    const divTeams = TEAMS.filter(t => t.division === division);
                    const divStandings = confStandings.filter(s => divTeams.some(t => t.id === s.teamId));
                    divisionLeaders.push(...divStandings.slice(0, 3));
                });
                
                const wildcardTeams = confStandings.filter(s => !divisionLeaders.some(dl => dl.teamId === s.teamId)).slice(0, 2);
                
                return (
                    <div key={conference} className="card">
                        <h2>{conference}ern Conference</h2>
                        {divisions.map(division => {
                            const divTeams = TEAMS.filter(t => t.division === division);
                            const divStandings = confStandings.filter(s => divTeams.some(t => t.id === s.teamId)).slice(0, 3);
                            
                            return (
                                <div key={division}>
                                    <h3>{division} Division</h3>
                                    <table className="standings-table">
                                        <thead>
                                            <tr>
                                                <th className="rank">#</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">W</th>
                                                <th className="text-center">L</th>
                                                <th className="text-center">OTL</th>
                                                <th className="text-center">PTS</th>
                                                <th className="text-center">DIFF</th>
                                                <th className="text-center">L10</th>
                                                <th className="text-center">STRK</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {divStandings.map((standing, idx) => {
                                                const team = TEAMS.find(t => t.id === standing.teamId);
                                                if (!team) return;
                                                const isUserTeam = team.id === userTeamId;
                                                const gp = standing?.wins + standing?.losses + standing?.otLosses;
                                                const diff = standing.goalsFor - standing.goalsAgainst;
                                                const { last10Record, streak, streakType } = getTeamLast10AndStreak(team.id);
                                                const streakColor = streakType === 'W' ? '#22c55e' : streakType === 'L' ? '#ef4444' : '#fbbf24';
                                                
                                                return (
                                                    <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} playoff`}>
                                                        <td className="rank">{idx + 1}</td>
                                                        <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name}</td>
                                                        <td className="text-center">{gp}</td>
                                                        <td className="text-center">{standing?.wins}</td>
                                                        <td className="text-center">{standing?.losses}</td>
                                                        <td className="text-center">{standing?.otLosses}</td>
                                                        <td className="text-center">{standing.points}</td>
                                                        <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                                        <td className="text-center">{last10Record}</td>
                                                        <td className="text-center" style={{ color: streakColor, fontWeight: 'bold' }}>
                                                            {streak}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            );
                        })}
                        <h3>Wild Card</h3>
                        <table className="standings-table">
                            <thead>
                                <tr>
                                    <th className="rank">#</th>
                                    <th>Team</th>
                                    <th className="text-center">GP</th>
                                    <th className="text-center">W</th>
                                    <th className="text-center">L</th>
                                    <th className="text-center">OTL</th>
                                    <th className="text-center">PTS</th>
                                    <th className="text-center">DIFF</th>
                                    <th className="text-center">L10</th>
                                    <th className="text-center">STRK</th>
                                </tr>
                            </thead>
                            <tbody>
                                {wildcardTeams.map((standing, idx) => {
                                    const team = TEAMS.find(t => t.id === standing.teamId);
                                    if (!team) return;
                                    const isUserTeam = team.id === userTeamId;
                                    const gp = standing?.wins + standing?.losses + standing?.otLosses;
                                    const diff = standing.goalsFor - standing.goalsAgainst;
                                    const { last10Record, streak, streakType } = getTeamLast10AndStreak(team.id);
                                    const streakColor = streakType === 'W' ? '#22c55e' : streakType === 'L' ? '#ef4444' : '#fbbf24';
                                    
                                    return (
                                        <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''} wildcard`}>
                                            <td className="rank">WC{idx + 1}</td>
                                            <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name} ({team.division})</td>
                                            <td className="text-center">{gp}</td>
                                            <td className="text-center">{standing?.wins}</td>
                                            <td className="text-center">{standing?.losses}</td>
                                            <td className="text-center">{standing?.otLosses}</td>
                                            <td className="text-center">{standing.points}</td>
                                            <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                            <td className="text-center">{last10Record}</td>
                                            <td className="text-center" style={{ color: streakColor, fontWeight: 'bold' }}>
                                                {streak}
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            });
        }

        if (standingsView === 'league') {
            const sortedLeagueStandings = sortData(sortedStandings, standingsSortConfig.key, standingsSortConfig.direction);
            
            return (
                <div className="card">
                    <h2>League Standings</h2>
                    <table className="standings-table">
                        <thead>
                            <tr>
                                <th className="rank" title="League Rank">#</th>
                                <th style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'teamName' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'teamName', direction: dir });
                                }}>
                                    Team {standingsSortConfig.key === 'teamName' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'gamesPlayed' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'gamesPlayed', direction: dir });
                                }} title="Games Played">
                                    GP {standingsSortConfig.key === 'gamesPlayed' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'wins' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'wins', direction: dir });
                                }} title="Wins">
                                    W {standingsSortConfig.key === 'wins' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'losses' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'losses', direction: dir });
                                }} title="Losses">
                                    L {standingsSortConfig.key === 'losses' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'otLosses' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'otLosses', direction: dir });
                                }} title="Overtime Losses">
                                    OTL {standingsSortConfig.key === 'otLosses' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'points' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'points', direction: dir });
                                }} title="Points - 2 points for a win, 0 for a loss">
                                    PTS {standingsSortConfig.key === 'points' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'goalsFor' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'goalsFor', direction: dir });
                                }} title="Goals For - Total goals scored by this team">
                                    GF {standingsSortConfig.key === 'goalsFor' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'goalsAgainst' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'goalsAgainst', direction: dir });
                                }} title="Goals Against - Total goals allowed by this team">
                                    GA {standingsSortConfig.key === 'goalsAgainst' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => { 
                                    const dir = standingsSortConfig.key === 'diff' && standingsSortConfig.direction === 'desc' ? 'asc' : 'desc';
                                    setStandingsSortConfig({ key: 'diff', direction: dir });
                                }} title="Goal Differential - Goals For minus Goals Against. Higher is better.">
                                    DIFF {standingsSortConfig.key === 'diff' && (standingsSortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                </th>
                                <th className="text-center" title="Home Record - Wins-Losses at home">HOME</th>
                                <th className="text-center" title="Away Record - Wins-Losses on the road">AWAY</th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedLeagueStandings.map((standing, idx) => {
                                const team = TEAMS.find(t => t.id === standing.teamId);
                                if (!team) return;
                                const isUserTeam = team.id === userTeamId;
                                const gp = standing?.wins + standing?.losses + standing?.otLosses;
                                const diff = standing.goalsFor - standing.goalsAgainst;
                                
                                // Add sortable fields to standing object
                                const standingWithSort = { ...standing, teamName: `${team.city} ${team.name}`, gamesPlayed: gp, diff };
                                
                                return (
                                    <tr key={team.id} className={`${isUserTeam ? 'highlight' : ''}`}>
                                        <td className="rank">{idx + 1}</td>
                                        <td className="team-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('teamProfile', team.id)}>{team.city} {team.name} ({team.conference} - {team.division})</td>
                                        <td className="text-center">{gp}</td>
                                        <td className="text-center">{standing?.wins}</td>
                                        <td className="text-center">{standing?.losses}</td>
                                        <td className="text-center">{standing?.otLosses}</td>
                                        <td className="text-center">{standing.points}</td>
                                        <td className="text-center">{standing.goalsFor}</td>
                                        <td className="text-center">{standing.goalsAgainst}</td>
                                        <td className="text-center">{diff > 0 ? '+' : ''}{diff}</td>
                                        <td className="text-center">{standing.home?.wins}-{standing.home?.losses}</td>
                                        <td className="text-center">{standing.away?.wins}-{standing.away?.losses}</td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            );
        }
    };

    // IMMEDIATE VALIDATION - before ANY other code
    if (gameState && (!gameState.standings || !Array.isArray(gameState.standings) || gameState.standings.length === 0 || !userTeamId)) {
        return <div style={{padding: '2rem', textAlign: 'center', color: '#ef4444'}}>
            <h2>Loading game data...</h2>
            <p>Please wait while the game is initialized.</p>
            <button onClick={() => {
                localStorage.removeItem('hockeyGMSaveData');
                localStorage.removeItem('hockeyGmSave');
                window.location.reload();
            }} style={{
                padding: '0.75rem 1.5rem',
                background: '#ef4444',
                color: '#fff',
                border: 'none',
                borderRadius: '0.5rem',
                cursor: 'pointer',
                marginTop: '1rem'
            }}>
                Clear Save & Restart
            </button>
        </div>;
    }

    if (!gameState) {
        // Check if save exists
        const hasSave = localStorage.getItem('hockeyGmSave') !== null;
        
        // Emergency clear function
        const emergencyClear = () => {
            if (confirm('This will delete ALL saved data and reload the page. Continue?')) {
                localStorage.removeItem('hockeyGMSaveData');
                localStorage.removeItem('hockeyGmSave');
                localStorage.removeItem('hockeyGM_achievements');
                localStorage.removeItem('hockeyGM_dismissedHints');
                localStorage.removeItem('hockeyGM_hasSeenWelcome');
                window.location.reload();
            }
        };
        
        // Generate team flavor text based on stats
        const getTeamFlavorText = (teamId) => {
            // Generate temporary players to analyze team
            const tempPlayers = [];
            for (let i = 0; i < 23; i++) {
                const position = i < 13 ? 'F' : (i < 19 ? 'D' : 'G');
                tempPlayers.push(generatePlayer(position, teamId, 0, false));
            }
            
            const avgOvr = Math.round(tempPlayers.reduce((sum, p) => sum + p.ratings.overall, 0) / tempPlayers.length);
            const avgAge = Math.round(tempPlayers.reduce((sum, p) => sum + p.age, 0) / tempPlayers.length * 10) / 10;
            
            if (avgOvr >= 85) {
                if (avgAge < 26) return "Young superteam. Championship expectations.";
                else if (avgAge > 29) return "Veteran powerhouse. Win-now mode.";
                else return "Elite contender. Cup favorites.";
            } else if (avgOvr >= 80) {
                if (avgAge < 26) return "Promising young core. Building toward contention.";
                else if (avgAge > 29) return "Experienced playoff team. Final championship window.";
                else return "Solid playoff contender. Dark horse candidate.";
            } else if (avgOvr >= 75) {
                if (avgAge < 26) return "Rebuilding with youth. Patience required.";
                else if (avgAge > 29) return "Aging roster. Difficult rebuild ahead.";
                else return "Bubble team. Compete or rebuild?";
            } else {
                if (avgAge < 26) return "Full rebuild. Focus on development and draft picks.";
                else return "Bottom-feeder. Complete overhaul needed.";
            }
        };
        
        // Calculate team preview stats
        const getTeamPreviewStats = (teamId) => {
            // Use seeded random so same team always shows same players
            const seed = teamId * 12345; // Unique seed per team
            const rng = seededRandom(seed);
            
            // Temporarily replace Math.random with our seeded version
            const originalRandom = Math.random;
            Math.random = rng;
            
            try {
                // Generate the ACTUAL roster that will be created when game starts
                const roster = generateRoster(teamId);
                
                // Filter to NHL roster only
                const nhlRoster = roster.filter(p => p.roster === 'nhl');
                
                const avgOvr = Math.round(nhlRoster.reduce((sum, p) => sum + p.ratings.overall, 0) / nhlRoster.length);
                const avgAge = Math.round(nhlRoster.reduce((sum, p) => sum + p.age, 0) / nhlRoster.length * 10) / 10;
                const topPlayers = [...nhlRoster].sort((a, b) => b.ratings.overall - a.ratings.overall).slice(0, 5);
                
                return { avgOvr, avgAge, topPlayers, allPlayers: nhlRoster };
            } finally {
                // Restore original Math.random
                Math.random = originalRandom;
            }
        };
        
        return (
            <div className="container">
                {/* WELCOME SCREEN - First Time Only */}
                {showWelcome && (
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0, 0, 0, 0.95)',
                        zIndex: 10000,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '2rem'
                    }}>
                        <div style={{
                            background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                            border: '4px solid #3b82f6',
                            borderRadius: '1.5rem',
                            padding: '3rem',
                            maxWidth: '700px',
                            width: '100%',
                            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.8)',
                            animation: 'fadeIn 0.4s ease-out'
                        }}>
                            <style>{`
                                @keyframes fadeIn {
                                    from { opacity: 0; transform: scale(0.95); }
                                    to { opacity: 1; transform: scale(1); }
                                }
                            `}</style>
                            
                            <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                                <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üèí</div>
                                <h1 style={{ fontSize: '2.5rem', color: '#60a5fa', marginBottom: '1rem' }}>
                                    Welcome to Hockey GM!
                                </h1>
                                <p style={{ fontSize: '1.2rem', color: '#e2e8f0', lineHeight: '1.6' }}>
                                    You're about to take control of a professional hockey team.
                                    Your goal: Build a championship dynasty.
                                </p>
                            </div>
                            
                            <div style={{
                                padding: '1.5rem',
                                background: 'rgba(59, 130, 246, 0.1)',
                                borderRadius: '1rem',
                                marginBottom: '2rem'
                            }}>
                                <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>What You'll Do:</h3>
                                <ul style={{ color: '#93c5fd', lineHeight: '2', paddingLeft: '1.5rem' }}>
                                    <li>üéÆ Simulate games and manage your season</li>
                                    <li>üîÑ Make trades to improve your roster</li>
                                    <li>üìã Set lineups and tactics</li>
                                    <li>üéØ Draft prospects and sign free agents</li>
                                    <li>üèÜ Compete for the Stanley Cup</li>
                                </ul>
                            </div>
                            
                            <div style={{ display: 'flex', gap: '1rem', flexDirection: 'column' }}>
                                <button
                                    onClick={() => {
                                        setShowWelcome(false);
                                        setShowTutorial(true);
                                        setTutorialStep(0);
                                        localStorage.setItem('hockeyGM_hasSeenWelcome', 'true');
                                    }}
                                    style={{
                                        padding: '1.25rem 2rem',
                                        background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.75rem',
                                        fontSize: '1.2rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        boxShadow: '0 8px 16px rgba(59, 130, 246, 0.4)'
                                    }}
                                >
                                    üìö Quick Tutorial (2 min)
                                </button>
                                <button
                                    onClick={() => {
                                        setShowWelcome(false);
                                        localStorage.setItem('hockeyGM_hasSeenWelcome', 'true');
                                    }}
                                    style={{
                                        padding: '1.25rem 2rem',
                                        background: 'transparent',
                                        color: '#93c5fd',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '0.75rem',
                                        fontSize: '1.2rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    ‚ö° Jump Right In
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* TUTORIAL SYSTEM - 5 Steps */}
                {showTutorial && (
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0, 0, 0, 0.95)',
                        zIndex: 10000,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '2rem'
                    }}>
                        <div style={{
                            background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                            border: '4px solid #3b82f6',
                            borderRadius: '1.5rem',
                            padding: '3rem',
                            maxWidth: '800px',
                            width: '100%',
                            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.8)',
                            position: 'relative'
                        }}>
                            {/* Progress Indicator */}
                            <div style={{
                                display: 'flex',
                                gap: '0.5rem',
                                justifyContent: 'center',
                                marginBottom: '2rem'
                            }}>
                                {[0, 1, 2, 3, 4].map(i => (
                                    <div key={i} style={{
                                        width: '40px',
                                        height: '4px',
                                        background: i <= tutorialStep ? '#3b82f6' : '#334155',
                                        borderRadius: '2px',
                                        transition: 'all 0.3s'
                                    }} />
                                ))}
                            </div>
                            
                            {/* Tutorial Content */}
                            {tutorialStep === 0 && (
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üéÆ</div>
                                    <h2 style={{ color: '#60a5fa', fontSize: '2rem', marginBottom: '1rem' }}>
                                        Step 1: Pick Your Team
                                    </h2>
                                    <p style={{ color: '#e2e8f0', fontSize: '1.2rem', lineHeight: '1.8', marginBottom: '1.5rem' }}>
                                        You'll start by choosing one of 32 professional hockey teams to manage.
                                        Each team has different strengths and challenges.
                                    </p>
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        borderRadius: '1rem',
                                        marginBottom: '1.5rem'
                                    }}>
                                        <p style={{ color: '#93c5fd', fontSize: '1rem', lineHeight: '1.6' }}>
                                            üí° <strong>Tip:</strong> Check each team's Overall Rating and Division Standing
                                            before choosing. Rebuilding teams offer a challenge, while contenders
                                            aim for immediate success!
                                        </p>
                                    </div>
                                </div>
                            )}
                            
                            {tutorialStep === 1 && (
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>‚ö°</div>
                                    <h2 style={{ color: '#60a5fa', fontSize: '2rem', marginBottom: '1rem' }}>
                                        Step 2: Simulate Your Season
                                    </h2>
                                    <p style={{ color: '#e2e8f0', fontSize: '1.2rem', lineHeight: '1.8', marginBottom: '1.5rem' }}>
                                        Run your 82-game season day by day, week by week, or all at once.
                                        Watch your team compete and see results in real-time.
                                    </p>
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(2, 1fr)',
                                        gap: '1rem',
                                        marginBottom: '1.5rem'
                                    }}>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(34, 197, 94, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '2px solid #22c55e'
                                        }}>
                                            <div style={{ color: '#22c55e', fontSize: '1.5rem', marginBottom: '0.5rem' }}>1 Day</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>One game at a time</div>
                                        </div>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(245, 158, 11, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '2px solid #f59e0b'
                                        }}>
                                            <div style={{ color: '#f59e0b', fontSize: '1.5rem', marginBottom: '0.5rem' }}>Full Season</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>All 82 games</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tutorialStep === 2 && (
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üìä</div>
                                    <h2 style={{ color: '#60a5fa', fontSize: '2rem', marginBottom: '1rem' }}>
                                        Step 3: Key Screens
                                    </h2>
                                    <p style={{ color: '#e2e8f0', fontSize: '1.2rem', lineHeight: '1.8', marginBottom: '1.5rem' }}>
                                        Navigate between important views using the top menu.
                                    </p>
                                    <div style={{
                                        display: 'grid',
                                        gap: '1rem',
                                        marginBottom: '1.5rem',
                                        textAlign: 'left'
                                    }}>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '1px solid #3b82f6'
                                        }}>
                                            <div style={{ color: '#60a5fa', fontWeight: 'bold', marginBottom: '0.5rem' }}>üìã Roster</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Manage your players, set lines, view stats</div>
                                        </div>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '1px solid #3b82f6'
                                        }}>
                                            <div style={{ color: '#60a5fa', fontWeight: 'bold', marginBottom: '0.5rem' }}>üìà Standings</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Check your division, conference, league rank</div>
                                        </div>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '1px solid #3b82f6'
                                        }}>
                                            <div style={{ color: '#60a5fa', fontWeight: 'bold', marginBottom: '0.5rem' }}>üîÑ Trade</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Improve your roster by trading with AI teams</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tutorialStep === 3 && (
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üèÜ</div>
                                    <h2 style={{ color: '#60a5fa', fontSize: '2rem', marginBottom: '1rem' }}>
                                        Step 4: Playoffs & Championship
                                    </h2>
                                    <p style={{ color: '#e2e8f0', fontSize: '1.2rem', lineHeight: '1.8', marginBottom: '1.5rem' }}>
                                        Top 8 teams per conference make the playoffs. Win 4 rounds to claim the Stanley Cup!
                                    </p>
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(245, 158, 11, 0.1)',
                                        borderRadius: '1rem',
                                        border: '2px solid #f59e0b',
                                        marginBottom: '1.5rem'
                                    }}>
                                        <div style={{ color: '#fbbf24', fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '0.75rem' }}>
                                            Playoff Format
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.95rem', lineHeight: '1.6' }}>
                                            ‚Ä¢ All series are best-of-7<br />
                                            ‚Ä¢ Round 1 ‚Üí Round 2 ‚Üí Conference Finals ‚Üí Stanley Cup Finals<br />
                                            ‚Ä¢ Home ice advantage matters
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {tutorialStep === 4 && (
                                <div style={{ textAlign: 'center' }}>
                                    <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üéØ</div>
                                    <h2 style={{ color: '#60a5fa', fontSize: '2rem', marginBottom: '1rem' }}>
                                        Step 5: Build Your Dynasty
                                    </h2>
                                    <p style={{ color: '#e2e8f0', fontSize: '1.2rem', lineHeight: '1.8', marginBottom: '1.5rem' }}>
                                        After each season, build for the future through the draft and free agency.
                                    </p>
                                    <div style={{
                                        display: 'grid',
                                        gap: '1rem',
                                        marginBottom: '1.5rem',
                                        textAlign: 'left'
                                    }}>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(139, 92, 246, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '1px solid #8b5cf6'
                                        }}>
                                            <div style={{ color: '#a78bfa', fontWeight: 'bold', marginBottom: '0.5rem' }}>üìù Re-sign Players</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Keep your stars before free agency</div>
                                        </div>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(139, 92, 246, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '1px solid #8b5cf6'
                                        }}>
                                            <div style={{ color: '#a78bfa', fontWeight: 'bold', marginBottom: '0.5rem' }}>üé≤ Entry Draft</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>7 rounds, 224 picks - find future stars</div>
                                        </div>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(139, 92, 246, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '1px solid #8b5cf6'
                                        }}>
                                            <div style={{ color: '#a78bfa', fontWeight: 'bold', marginBottom: '0.5rem' }}>üíº Free Agency</div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Sign available players to fill gaps</div>
                                        </div>
                                    </div>
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(34, 197, 94, 0.1)',
                                        borderRadius: '1rem',
                                        border: '2px solid #22c55e'
                                    }}>
                                        <p style={{ color: '#22c55e', fontSize: '1.1rem', fontWeight: 'bold' }}>
                                            ‚ú® You're ready to be a GM!
                                        </p>
                                    </div>
                                </div>
                            )}
                            
                            {/* Navigation Buttons */}
                            <div style={{
                                display: 'flex',
                                gap: '1rem',
                                marginTop: '2rem',
                                justifyContent: 'space-between'
                            }}>
                                {tutorialStep > 0 && (
                                    <button
                                        onClick={() => setTutorialStep(tutorialStep - 1)}
                                        style={{
                                            padding: '0.75rem 1.5rem',
                                            background: 'transparent',
                                            color: '#93c5fd',
                                            border: '2px solid #3b82f6',
                                            borderRadius: '0.5rem',
                                            fontSize: '1rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        ‚Üê Back
                                    </button>
                                )}
                                {tutorialStep < 4 ? (
                                    <button
                                        onClick={() => setTutorialStep(tutorialStep + 1)}
                                        style={{
                                            padding: '0.75rem 2rem',
                                            background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            fontSize: '1rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            marginLeft: 'auto'
                                        }}
                                    >
                                        Next ‚Üí
                                    </button>
                                ) : (
                                    <button
                                        onClick={() => {
                                            setShowTutorial(false);
                                            setTutorialStep(0);
                                        }}
                                        style={{
                                            padding: '0.75rem 2rem',
                                            background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            fontSize: '1rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            marginLeft: 'auto'
                                        }}
                                    >
                                        Get Started! üöÄ
                                    </button>
                                )}
                            </div>
                            
                            {/* Skip Tutorial */}
                            <div style={{ textAlign: 'center', marginTop: '1.5rem' }}>
                                <button
                                    onClick={() => {
                                        setShowTutorial(false);
                                        setTutorialStep(0);
                                    }}
                                    style={{
                                        background: 'transparent',
                                        color: '#64748b',
                                        border: 'none',
                                        fontSize: '0.9rem',
                                        cursor: 'pointer',
                                        textDecoration: 'underline'
                                    }}
                                >
                                    Skip tutorial
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Hero Section */}
                <div style={{
                    textAlign: 'center',
                    marginBottom: '3rem',
                    padding: '2rem',
                    background: 'rgba(30, 58, 138, 0.3)',
                    borderRadius: '1rem',
                    border: '2px solid rgba(59, 130, 246, 0.3)'
                }}>
                    <h1 style={{ marginBottom: '1rem' }}>HOCKEY GM SIMULATOR</h1>
                    
                    {/* Description */}
                    <p style={{
                        fontSize: '1.1rem',
                        color: '#e0e7ff',
                        maxWidth: '700px',
                        margin: '0 auto 1.5rem',
                        lineHeight: '1.6'
                    }}>
                        Manage a professional hockey team through complete seasons. Make trades, 
                        set lineups, and compete for the championship. Full league 
                        simulation with realistic stats and AI opponents.
                    </p>
                    
                    <p style={{
                        fontSize: '0.95rem',
                        color: '#93c5fd',
                        fontStyle: 'italic'
                    }}>
                        Free to play. No account needed. Start managing today.
                    </p>
                    
                    {/* Emergency Clear Button - if app crashes */}
                    {hasSave && (
                        <div style={{marginTop: '2rem'}}>
                            <button onClick={emergencyClear} style={{
                                padding: '0.75rem 1.5rem',
                                background: '#ef4444',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                fontSize: '0.9rem'
                            }}>
                                ‚ö†Ô∏è Clear Save Data (If Experiencing Errors)
                            </button>
                        </div>
                    )}
                </div>
                
                {/* Stats Dashboard */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '1.5rem',
                    marginBottom: '3rem',
                    maxWidth: '900px',
                    margin: '0 auto 3rem'
                }}>
                    <div style={{
                        textAlign: 'center',
                        padding: '1.5rem',
                        background: 'rgba(0, 0, 0, 0.3)',
                        borderRadius: '0.75rem',
                        border: '1px solid rgba(59, 130, 246, 0.2)'
                    }}>
                        <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: '#60a5fa', marginBottom: '0.5rem' }}>
                            32
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                            Teams
                        </div>
                    </div>
                    
                    <div style={{
                        textAlign: 'center',
                        padding: '1.5rem',
                        background: 'rgba(0, 0, 0, 0.3)',
                        borderRadius: '0.75rem',
                        border: '1px solid rgba(59, 130, 246, 0.2)'
                    }}>
                        <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: '#22c55e', marginBottom: '0.5rem' }}>
                            1000+
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                            Players
                        </div>
                    </div>
                    
                    <div style={{
                        textAlign: 'center',
                        padding: '1.5rem',
                        background: 'rgba(0, 0, 0, 0.3)',
                        borderRadius: '0.75rem',
                        border: '1px solid rgba(59, 130, 246, 0.2)'
                    }}>
                        <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: '#fbbf24', marginBottom: '0.5rem' }}>
                            82
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                            Games/Season
                        </div>
                    </div>
                    
                    <div style={{
                        textAlign: 'center',
                        padding: '1.5rem',
                        background: 'rgba(0, 0, 0, 0.3)',
                        borderRadius: '0.75rem',
                        border: '1px solid rgba(59, 130, 246, 0.2)'
                    }}>
                        <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: '#a78bfa', marginBottom: '0.5rem' }}>
                            ‚àû
                        </div>
                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                            Seasons
                        </div>
                    </div>
                </div>
                
                {/* Continue Save Button */}
                {hasSave && (
                    <div style={{ textAlign: 'center', marginBottom: '3rem' }}>
                        <button 
                            onClick={() => {
                                if (loadGameFromLocalStorage()) {
                                    console.log('Save loaded successfully');
                                } else {
                                    alert('Failed to load save');
                                }
                            }}
                            style={{
                                padding: '1.25rem 3rem',
                                fontSize: '1.2rem',
                                fontWeight: 'bold',
                                background: '#22c55e',
                                color: '#fff',
                                border: '2px solid #22c55e',
                                borderRadius: '0.5rem',
                                cursor: 'pointer',
                                marginBottom: '1rem',
                                transition: 'all 0.2s',
                                boxShadow: '0 4px 6px rgba(0, 0, 0, 0.3)'
                            }}
                            onMouseOver={(e) => {
                                e.target.style.background = '#16a34a';
                                e.target.style.transform = 'translateY(-2px)';
                                e.target.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.4)';
                            }}
                            onMouseOut={(e) => {
                                e.target.style.background = '#22c55e';
                                e.target.style.transform = 'translateY(0)';
                                e.target.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
                            }}
                        >
                            ‚ñ∂Ô∏è Continue Saved Game
                        </button>
                        <p style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                            or start a new game below
                        </p>
                    </div>
                )}
                
                {/* Select Team Header */}
                <div style={{
                    textAlign: 'center',
                    marginBottom: '2rem'
                }}>
                    <h2 style={{
                        fontSize: '1.75rem',
                        color: '#60a5fa',
                        marginBottom: '0.5rem'
                    }}>
                        Select Your Team
                    </h2>
                    <p style={{
                        color: '#93c5fd',
                        fontSize: '1rem'
                    }}>
                        Choose a franchise and begin your journey to the championship
                    </p>
                </div>
                
                {/* Team Grid */}
                <div className="grid" style={{
                    opacity: previewTeamId ? 0.3 : 1,
                    transition: 'opacity 0.3s ease',
                    pointerEvents: previewTeamId ? 'none' : 'auto'
                }}>
                    {TEAMS.map(team => (
                        <button 
                            key={team.id} 
                            onClick={() => setPreviewTeamId(team.id)} 
                            className="team-button"
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem',
                                justifyContent: 'center'
                            }}
                        >
                            <span style={{ fontSize: '1.5rem' }}>{team.logo}</span>
                            <span>{team.city} {team.name}</span>
                        </button>
                    ))}
                </div>
                
                {/* Team Preview Slide-In Panel */}
                {previewTeamId && (() => {
                    const team = TEAMS.find(t => t.id === previewTeamId);
                    const stats = getTeamPreviewStats(previewTeamId);
                    const flavorText = getTeamFlavorText(previewTeamId);
                    const currentIndex = TEAMS.findIndex(t => t.id === previewTeamId);
                    
                    return (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            right: 0,
                            width: '100%',
                            maxWidth: '600px',
                            height: '100vh',
                            background: 'linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%)',
                            boxShadow: '-4px 0 20px rgba(0, 0, 0, 0.5)',
                            zIndex: 1000,
                            animation: 'slideInRight 0.3s ease-out',
                            display: 'flex',
                            flexDirection: 'column',
                            overflow: 'auto'
                        }}>
                            <style>
                                {`
                                    @keyframes slideInRight {
                                        from {
                                            transform: translateX(100%);
                                        }
                                        to {
                                            transform: translateX(0);
                                        }
                                    }
                                    @keyframes slideIn {
                                        from {
                                            transform: translateY(-20px);
                                            opacity: 0;
                                        }
                                        to {
                                            transform: translateY(0);
                                            opacity: 1;
                                        }
                                    }
                                    @keyframes slide {
                                        0% {
                                            transform: translateX(-100%);
                                        }
                                        100% {
                                            transform: translateX(100%);
                                        }
                                    }
                                    @media (max-width: 768px) {
                                        .team-preview-panel {
                                            max-width: 100% !important;
                                        }
                                    }
                                `}
                            </style>
                            
                            {/* Close Button */}
                            <button
                                onClick={() => setPreviewTeamId(null)}
                                style={{
                                    position: 'absolute',
                                    top: '1rem',
                                    right: '1rem',
                                    background: 'rgba(239, 68, 68, 0.2)',
                                    border: '2px solid #ef4444',
                                    color: '#ef4444',
                                    width: '40px',
                                    height: '40px',
                                    borderRadius: '50%',
                                    fontSize: '1.5rem',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    transition: 'all 0.2s',
                                    zIndex: 10
                                }}
                                onMouseOver={(e) => {
                                    e.target.style.background = '#ef4444';
                                    e.target.style.color = '#fff';
                                }}
                                onMouseOut={(e) => {
                                    e.target.style.background = 'rgba(239, 68, 68, 0.2)';
                                    e.target.style.color = '#ef4444';
                                }}
                            >
                                ‚úï
                            </button>
                            
                            {/* Content */}
                            <div style={{ padding: '2rem', flex: 1 }}>
                                {/* Team Header with Logo */}
                                <div style={{ marginBottom: '2rem', paddingTop: '2rem', textAlign: 'center' }}>
                                    <div style={{ 
                                        fontSize: '5rem', 
                                        marginBottom: '1rem',
                                        filter: 'drop-shadow(0 4px 8px rgba(0,0,0,0.3))'
                                    }}>
                                        {team.logo}
                                    </div>
                                    <h2 style={{
                                        fontSize: '2.5rem',
                                        background: 'linear-gradient(to right, #60a5fa, #22d3ee)',
                                        WebkitBackgroundClip: 'text',
                                        WebkitTextFillColor: 'transparent',
                                        backgroundClip: 'text',
                                        marginBottom: '0.5rem'
                                    }}>
                                        {team.city} {team.name}
                                    </h2>
                                    <div style={{ color: '#93c5fd', fontSize: '1rem' }}>
                                        {team.abbreviation} ‚Ä¢ {team.conference} Conference ‚Ä¢ {team.division} Division
                                    </div>
                                </div>
                                
                                {/* Stats Cards */}
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(2, 1fr)',
                                    gap: '1rem',
                                    marginBottom: '2rem'
                                }}>
                                    <div style={{
                                        background: 'rgba(59, 130, 246, 0.2)',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '0.75rem',
                                        padding: '1.5rem',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                            TEAM OVERALL
                                        </div>
                                        <div style={{ fontSize: '3rem', fontWeight: 'bold', color: '#60a5fa' }}>
                                            {stats.avgOvr}
                                        </div>
                                    </div>
                                    
                                    <div style={{
                                        background: 'rgba(34, 197, 94, 0.2)',
                                        border: '2px solid #22c55e',
                                        borderRadius: '0.75rem',
                                        padding: '1.5rem',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#86efac', marginBottom: '0.5rem' }}>
                                            AVERAGE AGE
                                        </div>
                                        <div style={{ fontSize: '3rem', fontWeight: 'bold', color: '#22c55e' }}>
                                            {stats.avgAge}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Flavor Text */}
                                <div style={{
                                    background: 'rgba(251, 191, 36, 0.1)',
                                    border: '2px solid rgba(251, 191, 36, 0.3)',
                                    borderRadius: '0.75rem',
                                    padding: '1.5rem',
                                    marginBottom: '2rem',
                                    textAlign: 'center'
                                }}>
                                    <div style={{ fontSize: '0.875rem', color: '#fbbf24', marginBottom: '0.5rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                                        TEAM OUTLOOK
                                    </div>
                                    <div style={{ fontSize: '1.1rem', color: '#fde68a', fontStyle: 'italic' }}>
                                        "{flavorText}"
                                    </div>
                                </div>
                                
                                {/* Top Players */}
                                <div style={{ marginBottom: '2rem' }}>
                                    <h3 style={{
                                        fontSize: '1.5rem',
                                        color: '#60a5fa',
                                        marginBottom: '1rem',
                                        textAlign: 'center'
                                    }}>
                                        Top 5 Players
                                    </h3>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                        {stats.topPlayers.map((player, idx) => (
                                            <div key={idx} style={{
                                                background: 'rgba(0, 0, 0, 0.3)',
                                                border: '1px solid rgba(59, 130, 246, 0.3)',
                                                borderRadius: '0.5rem',
                                                padding: '1rem',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center'
                                            }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                                    <div style={{
                                                        width: '32px',
                                                        height: '32px',
                                                        borderRadius: '50%',
                                                        background: 'linear-gradient(135deg, #3b82f6, #22d3ee)',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        fontWeight: 'bold',
                                                        fontSize: '1.1rem'
                                                    }}>
                                                        {idx + 1}
                                                    </div>
                                                    <div>
                                                        <div style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                            {player.firstName} {player.lastName}
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>
                                                            {player.preferredPosition || player.position} ‚Ä¢ Age {player.age}
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style={{
                                                    fontSize: '1.5rem',
                                                    fontWeight: 'bold',
                                                    color: player.ratings.overall >= 85 ? '#22c55e' : 
                                                           player.ratings.overall >= 80 ? '#60a5fa' : 
                                                           player.ratings.overall >= 75 ? '#fbbf24' : '#94a3b8'
                                                }}>
                                                    {player.ratings.overall}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Bottom Actions */}
                            <div style={{
                                padding: '2rem',
                                background: 'rgba(0, 0, 0, 0.3)',
                                borderTop: '2px solid rgba(59, 130, 246, 0.3)'
                            }}>
                                {/* Navigation Arrows */}
                                <div style={{
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    marginBottom: '1.5rem'
                                }}>
                                    <button
                                        onClick={() => {
                                            const prevIndex = currentIndex > 0 ? currentIndex - 1 : TEAMS.length - 1;
                                            setPreviewTeamId(TEAMS[prevIndex].id);
                                        }}
                                        style={{
                                            padding: '0.75rem 1.5rem',
                                            background: 'rgba(59, 130, 246, 0.2)',
                                            border: '2px solid #3b82f6',
                                            color: '#60a5fa',
                                            borderRadius: '0.5rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold',
                                            fontSize: '1rem',
                                            transition: 'all 0.2s'
                                        }}
                                        onMouseOver={(e) => {
                                            e.target.style.background = '#3b82f6';
                                            e.target.style.color = '#fff';
                                        }}
                                        onMouseOut={(e) => {
                                            e.target.style.background = 'rgba(59, 130, 246, 0.2)';
                                            e.target.style.color = '#60a5fa';
                                        }}
                                    >
                                        ‚óÑ Previous Team
                                    </button>
                                    
                                    <button
                                        onClick={() => {
                                            const nextIndex = currentIndex < TEAMS.length - 1 ? currentIndex + 1 : 0;
                                            setPreviewTeamId(TEAMS[nextIndex].id);
                                        }}
                                        style={{
                                            padding: '0.75rem 1.5rem',
                                            background: 'rgba(59, 130, 246, 0.2)',
                                            border: '2px solid #3b82f6',
                                            color: '#60a5fa',
                                            borderRadius: '0.5rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold',
                                            fontSize: '1rem',
                                            transition: 'all 0.2s'
                                        }}
                                        onMouseOver={(e) => {
                                            e.target.style.background = '#3b82f6';
                                            e.target.style.color = '#fff';
                                        }}
                                        onMouseOut={(e) => {
                                            e.target.style.background = 'rgba(59, 130, 246, 0.2)';
                                            e.target.style.color = '#60a5fa';
                                        }}
                                    >
                                        Next Team ‚ñ∫
                                    </button>
                                </div>
                                
                                {/* Confirm Button */}
                                <button
                                    onClick={async () => {
                                        setPreviewTeamId(null);
                                        setIsGenerating(true);
                                        setLoadingProgress(0);
                                        await initGame(team.id);
                                        setIsGenerating(false);
                                    }}
                                    style={{
                                        width: '100%',
                                        padding: '1.5rem',
                                        fontSize: '1.3rem',
                                        fontWeight: 'bold',
                                        background: '#22c55e',
                                        color: '#fff',
                                        border: '3px solid #22c55e',
                                        borderRadius: '0.75rem',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s',
                                        boxShadow: '0 4px 12px rgba(34, 197, 94, 0.3)'
                                    }}
                                    onMouseOver={(e) => {
                                        e.target.style.background = '#16a34a';
                                        e.target.style.transform = 'translateY(-2px)';
                                        e.target.style.boxShadow = '0 8px 20px rgba(34, 197, 94, 0.4)';
                                    }}
                                    onMouseOut={(e) => {
                                        e.target.style.background = '#22c55e';
                                        e.target.style.transform = 'translateY(0)';
                                        e.target.style.boxShadow = '0 4px 12px rgba(34, 197, 94, 0.3)';
                                    }}
                                >
                                    üèí START WITH {team.city.toUpperCase()} {team.name.toUpperCase()}
                                </button>
                            </div>
                        </div>
                    );
                })()}
            </div>
        );
    }

    // Show loading screen during season transition
    if (seasonTransitioning) {
        return <div style={{
            padding: '4rem 2rem',
            textAlign: 'center',
            minHeight: '100vh',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center'
        }}>
            <div style={{ fontSize: '4rem', marginBottom: '2rem' }}>üèí</div>
            <h2 style={{ color: '#22c55e', fontSize: '2rem', marginBottom: '1rem' }}>
                Starting New Season...
            </h2>
            <p style={{ color: '#93c5fd', fontSize: '1.2rem' }}>
                Aging players, resetting stats, and generating new schedule
            </p>
            <div style={{
                marginTop: '2rem',
                width: '200px',
                height: '4px',
                background: 'rgba(59, 130, 246, 0.3)',
                borderRadius: '2px',
                overflow: 'hidden'
            }}>
                <div style={{
                    width: '100%',
                    height: '100%',
                    background: 'linear-gradient(90deg, #3b82f6, #22c55e)',
                    animation: 'slide 1.5s infinite'
                }}></div>
            </div>
        </div>;
    }

    // Show generating screen when creating new game
    if (isGenerating) {
        return <div style={{
            padding: '4rem 2rem',
            textAlign: 'center',
            minHeight: '100vh',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'linear-gradient(135deg, #0f172a, #1e293b)'
        }}>
            <div style={{ fontSize: '4rem', marginBottom: '2rem' }}>üèí</div>
            <h2 style={{ color: '#22c55e', fontSize: '2rem', marginBottom: '1rem' }}>
                Generating Hockey Universe...
            </h2>
            <p style={{ color: '#93c5fd', fontSize: '1.1rem', marginBottom: '2rem' }}>
                Creating 32 teams, 1000+ players, and an 82-game schedule
            </p>
            
            {/* Progress Bar */}
            <div style={{
                width: '400px',
                maxWidth: '90%',
                height: '8px',
                background: 'rgba(59, 130, 246, 0.2)',
                borderRadius: '4px',
                overflow: 'hidden',
                marginBottom: '1rem'
            }}>
                <div style={{
                    width: `${loadingProgress}%`,
                    height: '100%',
                    background: 'linear-gradient(90deg, #3b82f6, #22c55e)',
                    transition: 'width 0.3s ease',
                    borderRadius: '4px'
                }}></div>
            </div>
            
            {/* Progress Text */}
            <p style={{ color: '#60a5fa', fontSize: '0.9rem' }}>
                {loadingProgress < 40 ? 'üèí Generating NHL rosters...' :
                 loadingProgress < 60 ? '‚ö° Creating farm teams...' :
                 loadingProgress < 70 ? 'üìÖ Building 82-game schedule...' :
                 loadingProgress < 85 ? 'üìä Analyzing team strengths...' :
                 loadingProgress < 95 ? 'üéØ Setting up milestones...' :
                 '‚úÖ Almost ready!'}
            </p>
        </div>;
    }

    // Comprehensive validation before rendering
    if (!gameState || !gameState.standings || !Array.isArray(gameState.standings) || gameState.standings.length === 0 || !userTeamId) {
        return <div style={{padding: '2rem', textAlign: 'center', color: '#ef4444'}}>
            <h2>Loading game data...</h2>
            <p>Please wait while the game is initialized.</p>
        </div>;
    }

    let userTeam, userStanding;
    try {
        userTeam = getTeam(userTeamId);
        userStanding = gameState.standings.find(s => s.teamId === userTeamId);
    } catch (err) {
        console.error('Error finding user team/standing:', err, {userTeamId, hasGameState: !!gameState, hasStandings: !!gameState?.standings});
        return <div style={{padding: '2rem', textAlign: 'center', color: '#ef4444'}}>
            <h2>Error loading team data</h2>
            <p>Could not load your team. Please refresh the page.</p>
        </div>;
    }
    
    // Additional safety check - if standing doesn't exist or is missing data, return error
    if (!userStanding) {
        return <div style={{padding: '2rem', textAlign: 'center', color: '#ef4444'}}>
            <h2>Error: Your team not found in standings</h2>
            <p>Could not find standings data for your team. This may indicate a save file issue.</p>
            <button onClick={() => {
                if (confirm('This will delete your save and start fresh. Continue?')) {
                    localStorage.removeItem('hockeyGMSaveData');
                    window.location.reload();
                }
            }} style={{
                padding: '0.75rem 1.5rem',
                background: '#ef4444',
                color: '#fff',
                border: 'none',
                borderRadius: '0.5rem',
                cursor: 'pointer',
                marginTop: '1rem'
            }}>
                Clear Save & Restart
            </button>
        </div>;
    }
    
    if (typeof userStanding?.wins === 'undefined' || typeof userStanding?.losses === 'undefined' || typeof userStanding?.otLosses === 'undefined') {
        return <div style={{padding: '2rem', textAlign: 'center', color: '#ef4444'}}>
            <h2>Error: Invalid standings data</h2>
            <p>Your team's standings data is incomplete. This may be a save file corruption.</p>
            <button onClick={() => {
                if (confirm('This will delete your save and start fresh. Continue?')) {
                    localStorage.removeItem('hockeyGMSaveData');
                    window.location.reload();
                }
            }} style={{
                padding: '0.75rem 1.5rem',
                background: '#ef4444',
                color: '#fff',
                border: 'none',
                borderRadius: '0.5rem',
                cursor: 'pointer',
                marginTop: '1rem'
            }}>
                Clear Save & Restart
            </button>
        </div>;
    }
    
    // userRoster already declared with useMemo above
    const gamesPlayed = userStanding ? (userStanding?.wins + userStanding?.losses + userStanding?.otLosses) : 0;
    
    // Calculate league-wide games played
    // Check if season is complete (all 82 days simulated)
    const seasonComplete = gameState.currentDay > 82;
    
    // Calculate games played per team
    const teamGameCounts = {};
    TEAMS.forEach(t => teamGameCounts[t.id] = 0);
    gameState.schedule.forEach(day => {
        if (day.matchups) {
            day.matchups.forEach(m => {
                if (m.played) {
                    teamGameCounts[m.homeTeam]++;
                    teamGameCounts[m.awayTeam]++;
                }
            });
        }
    });
    const allGameCounts = Object.values(teamGameCounts);
    const minGamesPlayed = Math.min(...allGameCounts);
    const maxGamesPlayed = Math.max(...allGameCounts);
    const avgGamesPlayed = Math.round(allGameCounts.reduce((a, b) => a + b, 0) / allGameCounts.length);
    
    // Trade deadline is Day 55 (2/3 through 82-day season)
    const tradeDeadlineDay = 55;
    const isTradeDeadlinePassed = gameState.currentDay > tradeDeadlineDay;
    
    // All-Star break is Day 41 (mid-season)
    const allStarBreakDay = 41;

    return (
        <div>
            {/* Beta Disclaimer Banner */}
            <div style={{
                background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                padding: '0.5rem 1rem',
                textAlign: 'center',
                borderBottom: '2px solid #f59e0b',
                fontSize: '0.875rem',
                fontWeight: 'bold',
                color: '#fff',
                boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)'
            }}>
                ‚ö†Ô∏è Public Beta - Features in development. Report bugs via feedback!
            </div>
            
            {/* NEW DASHBOARD-STYLE HEADER */}
            <div className="header">
                {/* Top Bar - Team Name and Settings */}
                <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '0.75rem'
                }}>
                    <h1 
                        onClick={() => setCurrentView('teamLanding')}
                        style={{ 
                            cursor: 'pointer',
                            transition: 'color 0.2s',
                            fontSize: '1.5rem',
                            margin: 0
                        }}
                        onMouseEnter={(e) => e.target.style.color = '#60a5fa'}
                        onMouseLeave={(e) => e.target.style.color = ''}
                    >
                        üèí {userTeam.city} {userTeam.name}
                    </h1>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                        <span className="header-info" style={{ fontSize: '0.9rem' }}>
                            Season {gameState.season} ({gameState.year}-{(gameState.year + 1).toString().slice(-2)})
                        </span>
                        
                        {/* Settings Dropdown */}
                        <div style={{ position: 'relative' }}>
                            <button
                                onClick={() => setShowSettingsDropdown(!showSettingsDropdown)}
                                style={{
                                    background: showSettingsDropdown ? 'rgba(59, 130, 246, 0.3)' : 'transparent',
                                    border: '1px solid rgba(59, 130, 246, 0.5)',
                                    borderRadius: '0.375rem',
                                    padding: '0.5rem 0.75rem',
                                    color: '#93c5fd',
                                    cursor: 'pointer',
                                    fontSize: '1rem',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.25rem',
                                    transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(59, 130, 246, 0.2)'}
                                onMouseLeave={(e) => e.currentTarget.style.background = showSettingsDropdown ? 'rgba(59, 130, 246, 0.3)' : 'transparent'}
                            >
                                ‚öôÔ∏è <span style={{ fontSize: '0.7rem' }}>‚ñº</span>
                            </button>
                            
                            {showSettingsDropdown && (
                                <div style={{
                                    position: 'absolute',
                                    top: '100%',
                                    right: 0,
                                    marginTop: '0.25rem',
                                    background: '#0f172a',
                                    border: '2px solid rgba(59, 130, 246, 0.5)',
                                    borderRadius: '0.5rem',
                                    minWidth: '200px',
                                    boxShadow: '0 8px 24px rgba(0, 0, 0, 0.8)',
                                    zIndex: 1000
                                }}>
                                    <button
                                        onClick={() => {
                                            if (gameState && userTeamId) {
                                                saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                                alert('‚úÖ Game saved!');
                                                setShowSettingsDropdown(false);
                                            }
                                        }}
                                        style={{
                                            display: 'block',
                                            width: '100%',
                                            padding: '0.75rem 1rem',
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#93c5fd',
                                            textAlign: 'left',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem',
                                            transition: 'background 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.background = 'rgba(30, 58, 138, 1)'}
                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                        üíæ Save Game
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (loadGameFromLocalStorage()) {
                                                alert('‚úÖ Game loaded!');
                                                setShowSettingsDropdown(false);
                                            } else {
                                                alert('‚ùå No save found');
                                            }
                                        }}
                                        style={{
                                            display: 'block',
                                            width: '100%',
                                            padding: '0.75rem 1rem',
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#93c5fd',
                                            textAlign: 'left',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem',
                                            transition: 'background 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.background = 'rgba(30, 58, 138, 1)'}
                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                        üìÅ Load Game
                                    </button>
                                    <button
                                        onClick={() => {
                                            setCurrentView('teamSelect');
                                            setGameState(null);
                                            setShowSettingsDropdown(false);
                                        }}
                                        style={{
                                            display: 'block',
                                            width: '100%',
                                            padding: '0.75rem 1rem',
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#93c5fd',
                                            textAlign: 'left',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem',
                                            transition: 'background 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.background = 'rgba(30, 58, 138, 1)'}
                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                        üîÑ New Game
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (confirm('‚ö†Ô∏è Delete saved game? This cannot be undone!')) {
                                                deleteSave();
                                                setShowSettingsDropdown(false);
                                            }
                                        }}
                                        style={{
                                            display: 'block',
                                            width: '100%',
                                            padding: '0.75rem 1rem',
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#93c5fd',
                                            textAlign: 'left',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem',
                                            transition: 'background 0.2s',
                                            borderTop: '1px solid rgba(59, 130, 246, 0.3)'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.target.style.background = 'rgba(30, 58, 138, 1)';
                                            e.target.style.color = '#ef4444';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.target.style.background = 'transparent';
                                            e.target.style.color = '#93c5fd';
                                        }}
                                    >
                                        üóëÔ∏è Delete Save
                                    </button>
                                    <button
                                        onClick={() => {
                                            setCurrentView('roadmap');
                                            setShowSettingsDropdown(false);
                                        }}
                                        style={{
                                            display: 'block',
                                            width: '100%',
                                            padding: '0.75rem 1rem',
                                            background: 'transparent',
                                            border: 'none',
                                            color: '#93c5fd',
                                            textAlign: 'left',
                                            cursor: 'pointer',
                                            fontSize: '0.875rem',
                                            transition: 'background 0.2s',
                                            borderTop: '1px solid rgba(59, 130, 246, 0.3)'
                                        }}
                                        onMouseEnter={(e) => e.target.style.background = 'rgba(30, 58, 138, 1)'}
                                        onMouseLeave={(e) => e.target.style.background = 'transparent'}
                                    >
                                        üöÄ View Roadmap
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                
                {/* Stats Cards */}
                <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(4, 1fr)',
                    gap: '0.75rem',
                    marginBottom: '0.5rem'
                }}>
                    {/* Record Card */}
                    <div style={{
                        background: 'rgba(30, 58, 138, 0.3)',
                        border: '1px solid rgba(59, 130, 246, 0.3)',
                        borderRadius: '0.5rem',
                        padding: '0.75rem',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>üìä Record</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: 'white' }}>
                            {userStanding?.wins}-{userStanding?.losses}-{userStanding?.otLosses}
                        </div>
                        <div style={{ fontSize: '0.75rem', color: '#60a5fa' }}>{userStanding?.points} pts</div>
                    </div>
                    
                    {/* Standings Card */}
                    <div style={{
                        background: 'rgba(30, 58, 138, 0.3)',
                        border: '1px solid rgba(59, 130, 246, 0.3)',
                        borderRadius: '0.5rem',
                        padding: '0.75rem',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>üèÜ Standings</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: 'white' }}>
                            {(() => {
                                const divisionStandings = gameState.standings
                                    .filter(s => {
                                        const team = TEAMS.find(t => t.id === s.teamId);
                                        return team && team.division === userTeam.division;
                                    })
                                    .sort((a, b) => b.points - a.points);
                                const rank = divisionStandings.findIndex(s => s.teamId === userTeamId) + 1;
                                return `${rank}${rank === 1 ? 'st' : rank === 2 ? 'nd' : rank === 3 ? 'rd' : 'th'}`;
                            })()}
                        </div>
                        <div style={{ fontSize: '0.75rem', color: '#60a5fa' }}>{userTeam.division}</div>
                    </div>
                    
                    {/* Cap Space Card */}
                    <div style={{
                        background: 'rgba(30, 58, 138, 0.3)',
                        border: '1px solid rgba(59, 130, 246, 0.3)',
                        borderRadius: '0.5rem',
                        padding: '0.75rem',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>üí∞ Cap Space</div>
                        <div style={{ 
                            fontSize: '1.25rem', 
                            fontWeight: 'bold',
                            color: (() => {
                                const capStatus = calculateTeamCapHit(userTeamId, gameState.players);
                                return capStatus.overCap ? '#ef4444' : 
                                       capStatus.capSpace < 1000000 ? '#f59e0b' : '#22c55e';
                            })()
                        }}>
                            {formatSalary(calculateTeamCapHit(userTeamId, gameState.players).capSpace)}
                        </div>
                        <div style={{ fontSize: '0.75rem', color: '#60a5fa' }}>
                            {calculateTeamCapHit(userTeamId, gameState.players).overCap ? '‚ö†Ô∏è Over Cap' : 'Available'}
                        </div>
                    </div>
                    
                    {/* Season Progress Card */}
                    <div style={{
                        background: 'rgba(30, 58, 138, 0.3)',
                        border: '1px solid rgba(59, 130, 246, 0.3)',
                        borderRadius: '0.5rem',
                        padding: '0.75rem',
                        textAlign: 'center'
                    }}>
                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>üóìÔ∏è Season</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: 'white' }}>
                            Day {gameState.currentDay}
                        </div>
                        <div style={{ fontSize: '0.75rem', color: '#60a5fa' }}>of 82</div>
                    </div>
                </div>
                
                {/* Smart Notification Banner */}
                {(() => {
                    // Calculate priority notifications
                    const notifications = [];
                    
                    // Priority 1: Over cap (urgent)
                    const capStatus = calculateTeamCapHit(userTeamId, gameState.players);
                    if (capStatus.overCap && !dismissedNotifications.includes('overcap')) {
                        notifications.push({
                            id: 'overcap',
                            priority: 1,
                            color: '#ef4444',
                            icon: '‚ö†Ô∏è',
                            text: `OVER SALARY CAP by ${formatSalary(Math.abs(capStatus.capSpace))}! You must get under the cap.`,
                            action: () => setCurrentView('roster'),
                            actionText: 'View Roster ‚Üí'
                        });
                    }
                    
                    // Priority 2: Trade deadline very close
                    const daysToDeadline = 56 - gameState.currentDay;
                    if (daysToDeadline > 0 && daysToDeadline <= 3 && !dismissedNotifications.includes('deadline-urgent')) {
                        notifications.push({
                            id: 'deadline-urgent',
                            priority: 2,
                            color: '#f59e0b',
                            icon: '‚è∞',
                            text: `URGENT: Trade deadline in ${daysToDeadline} day${daysToDeadline > 1 ? 's' : ''}!`,
                            action: () => setCurrentView('trade'),
                            actionText: 'Make Trades ‚Üí'
                        });
                    }
                    
                    // Priority 3: Next game ready
                    if (gameState.currentDay < 82 && !dismissedNotifications.includes(`nextgame-${gameState.currentDay}`)) {
                        const nextDaySchedule = gameState.schedule.find(d => d.day === gameState.currentDay + 1);
                        if (nextDaySchedule?.matchups) {
                            const nextGame = nextDaySchedule.matchups.find(m => 
                                m.homeTeam === userTeamId || m.awayTeam === userTeamId
                            );
                            if (nextGame) {
                                const opponent = TEAMS.find(t => t.id === (nextGame.homeTeam === userTeamId ? nextGame.awayTeam : nextGame.homeTeam));
                                const isHome = nextGame.homeTeam === userTeamId;
                                notifications.push({
                                    id: `nextgame-${gameState.currentDay}`,
                                    priority: 3,
                                    color: '#22c55e',
                                    icon: '‚ö°',
                                    text: `Next Game: ${isHome ? 'vs' : '@'} ${opponent?.city} ${opponent?.name} (Day ${gameState.currentDay + 1})`,
                                    action: simulateDay82WithPopup,
                                    actionText: 'Play Game ‚Üí'
                                });
                            }
                        }
                    }
                    
                    // Priority 4: Contract warnings
                    const expiringPlayers = gameState.players.filter(p => 
                        p.teamId === userTeamId && 
                        p.contract &&
                        p.contract.yearsRemaining === 1 &&
                        p.ratings.overall >= 70
                    );
                    if (expiringPlayers.length >= 3 && !dismissedNotifications.includes('contracts')) {
                        notifications.push({
                            id: 'contracts',
                            priority: 4,
                            color: '#f59e0b',
                            icon: '‚úçÔ∏è',
                            text: `${expiringPlayers.length} key players need new contracts`,
                            action: () => setCurrentView('resignPlayers'),
                            actionText: 'Re-Sign Players ‚Üí'
                        });
                    }
                    
                    // Show highest priority notification
                    notifications.sort((a, b) => a.priority - b.priority);
                    const topNotification = notifications[0];
                    
                    if (!topNotification) return null;
                    
                    return (
                        <div style={{
                            background: `linear-gradient(90deg, ${topNotification.color}15, ${topNotification.color}05)`,
                            border: `2px solid ${topNotification.color}`,
                            borderRadius: '0.5rem',
                            padding: '0.75rem 1rem',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            marginTop: '0.75rem'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', flex: 1 }}>
                                <span style={{ fontSize: '1.5rem' }}>{topNotification.icon}</span>
                                <span style={{ color: 'white', fontWeight: 'bold', fontSize: '0.95rem' }}>
                                    {topNotification.text}
                                </span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                <button
                                    onClick={topNotification.action}
                                    style={{
                                        background: topNotification.color,
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        padding: '0.5rem 1rem',
                                        color: topNotification.priority === 1 ? 'white' : '#1e293b',
                                        fontWeight: 'bold',
                                        fontSize: '0.875rem',
                                        cursor: 'pointer',
                                        whiteSpace: 'nowrap'
                                    }}
                                >
                                    {topNotification.actionText}
                                </button>
                                <button
                                    onClick={() => setDismissedNotifications([...dismissedNotifications, topNotification.id])}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        color: '#93c5fd',
                                        fontSize: '1.25rem',
                                        cursor: 'pointer',
                                        padding: '0.25rem 0.5rem',
                                        lineHeight: 1
                                    }}
                                    title="Dismiss notification"
                                >
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    );
                })()}
            </div>

            <div className="nav">
                <div className="nav-content">
                    {/* 1. PLAY - Simulation options */}
                    <div className="nav-group">
                        <button 
                            className="nav-button has-dropdown"
                            style={{
                                background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                fontWeight: 'bold',
                                fontSize: '1.05rem',
                                boxShadow: '0 0 20px rgba(34, 197, 94, 0.3)',
                                animation: 'pulse 2s infinite'
                            }}
                            title={playoffState ? "Simulate playoff games" : "Simulate games and progress through the season"}
                        >
                            üéÆ PLAY
                        </button>
                        <div className="nav-dropdown">
                            {/* REGULAR SEASON OPTIONS */}
                            {!seasonComplete && !playoffState && (
                                <>
                                    <button
                                        onClick={simulateDay82WithPopup}
                                        className="nav-dropdown-item"
                                        style={{
                                            borderLeft: '4px solid #22c55e'
                                        }}
                                        title="Simulate the next game on your schedule"
                                    >
                                        ‚ö° Play Next Game {gameState && `(Day ${gameState.currentDay + 1})`}
                                    </button>
                                    <button
                                        onClick={simulate7GamesWithPopup}
                                        className="nav-dropdown-item"
                                        title="Simulate one week of games (approximately 7 games)"
                                    >
                                        üìÖ Sim 1 Week
                                    </button>
                                    <button
                                        onClick={simulate30GamesWithPopup}
                                        className="nav-dropdown-item"
                                        title="Simulate one month of games (approximately 30 games)"
                                    >
                                        üìÜ Sim 1 Month
                                    </button>
                                    <button
                                        onClick={() => {
                                            if (!gameState) return;
                                            const remainingDays = 82 - gameState.currentDay;
                                            if (remainingDays > 0) {
                                                simulateWithPopup(remainingDays);
                                            } else {
                                                alert('Season already complete!');
                                            }
                                        }}
                                        className="nav-dropdown-item"
                                        title="Simulate all remaining regular season games"
                                    >
                                        üèÅ Sim to Playoffs
                                    </button>
                                </>
                            )}
                            
                            {/* SEASON COMPLETE - START PLAYOFFS OPTION */}
                            {seasonComplete && !playoffState && (
                                <button
                                    onClick={startPlayoffs}
                                    className="nav-dropdown-item"
                                    style={{
                                        borderLeft: '4px solid #f59e0b',
                                        background: 'rgba(245, 158, 11, 0.1)',
                                        fontWeight: 'bold'
                                    }}
                                    title="Initialize playoff matchups and begin the Stanley Cup Playoffs"
                                >
                                    üèÜ Start Playoffs
                                </button>
                            )}
                            
                            {/* PLAYOFFS IN PROGRESS - PLAYOFF SIMULATION OPTIONS */}
                            {playoffState && !playoffState.completed && (
                                <>
                                    <button
                                        onClick={simulateOnePlayoffDay}
                                        className="nav-dropdown-item"
                                        style={{
                                            borderLeft: '4px solid #f59e0b'
                                        }}
                                        title="Simulate one day of playoff games"
                                    >
                                        üèí 1 Day
                                    </button>
                                    <button
                                        onClick={simulatePlayoffSeries}
                                        className="nav-dropdown-item"
                                        title="Simulate the current playoff round to completion"
                                    >
                                        üìä 1 Round
                                    </button>
                                    <button
                                        onClick={simulateAllPlayoffs}
                                        className="nav-dropdown-item"
                                        title="Simulate all remaining playoff rounds until Stanley Cup winner"
                                    >
                                        üèÜ All Rounds
                                    </button>
                                </>
                            )}
                            
                            {/* PLAYOFFS COMPLETE - ADVANCE TO OFFSEASON */}
                            {playoffState && playoffState.completed && (
                                <button
                                    onClick={() => {
                                        const expiring = detectExpiringContracts();
                                        setExpiringContracts(expiring);
                                        setResignedPlayers([]);
                                        setSkippedPlayers([]);
                                        setCurrentView('resign');
                                    }}
                                    className="nav-dropdown-item"
                                    style={{
                                        borderLeft: '4px solid #8b5cf6',
                                        background: 'rgba(139, 92, 246, 0.1)',
                                        fontWeight: 'bold'
                                    }}
                                    title="Begin offseason by re-signing expiring contracts"
                                >
                                    ‚úçÔ∏è Continue to Offseason
                                </button>
                            )}
                        </div>
                    </div>

                    {/* 2. MY TEAM - Everything about your team */}
                    <div className="nav-group">
                        <button 
                            className={`nav-button has-dropdown ${['teamLanding', 'roster', 'lines', 'injuries', 'callups', 'farmRoster'].includes(currentView) ? 'active' : ''}`}
                            title="Manage your team, roster, and players"
                        >
                            üèí MY TEAM
                        </button>
                        <div className="nav-dropdown">
                            <button
                                onClick={() => setCurrentView('teamLanding')}
                                className={`nav-dropdown-item ${currentView === 'teamLanding' ? 'active' : ''}`}
                                title="View your team dashboard with key stats and upcoming games"
                            >
                                üè† Team Overview
                            </button>
                            <button
                                onClick={() => setCurrentView('roster')}
                                className={`nav-dropdown-item ${currentView === 'roster' ? 'active' : ''}`}
                                title="View your active roster and player contracts"
                            >
                                üìã Roster & Contracts
                            </button>
                            <button
                                onClick={() => setCurrentView('lines')}
                                className={`nav-dropdown-item ${currentView === 'lines' ? 'active' : ''}`}
                                title="Set your forward lines, defensive pairs, and scratches"
                            >
                                üßä Lines & Depth Chart
                            </button>
                            <button
                                onClick={() => setCurrentView('injuries')}
                                className={`nav-dropdown-item ${currentView === 'injuries' ? 'active' : ''}`}
                                title="View injured players and recovery timelines"
                            >
                                üè• Injuries & Health
                                {(() => {
                                    const injuryCount = gameState?.players.filter(p => 
                                        p.teamId === userTeamId && 
                                        p.injury?.injured
                                    ).length || 0;
                                    if (injuryCount > 0) {
                                        return (
                                            <span style={{
                                                marginLeft: '0.5rem',
                                                padding: '0.15rem 0.5rem',
                                                background: '#ef4444',
                                                borderRadius: '999px',
                                                fontSize: '0.75rem',
                                                fontWeight: 'bold',
                                                color: 'white'
                                            }}>
                                                {injuryCount}
                                            </span>
                                        );
                                    }
                                })()}
                            </button>
                            <button
                                onClick={() => setCurrentView('callups')}
                                className={`nav-dropdown-item ${currentView === 'callups' ? 'active' : ''}`}
                                title="Call up players from farm team or send down to farm"
                            >
                                üîÑ Call-Ups & Send-Downs
                            </button>
                            <button
                                onClick={() => setCurrentView('farmRoster')}
                                className={`nav-dropdown-item ${currentView === 'farmRoster' ? 'active' : ''}`}
                                title="Manage your farm team roster and call-ups"
                            >
                                üè´ Farm Team
                            </button>
                        </div>
                    </div>

                    {/* 3. MANAGEMENT - Trades, contracts, roster moves */}
                    <div className="nav-group">
                        <button 
                            className={`nav-button has-dropdown ${['trade', 'resignPlayers', 'draftpicks', 'freeagents'].includes(currentView) ? 'active' : ''}`}
                            title="Make trades, sign players, and manage contracts"
                        >
                            üíº MANAGEMENT
                        </button>
                        <div className="nav-dropdown">
                            <button
                                onClick={() => setCurrentView('trade')}
                                className={`nav-dropdown-item ${currentView === 'trade' ? 'active' : ''}`}
                                title="Propose trades with other teams (deadline: Day 56)"
                            >
                                üîÑ Make Trades
                                {(() => {
                                    const daysToDeadline = 56 - (gameState?.currentDay || 0);
                                    if (daysToDeadline > 0 && daysToDeadline <= 7) {
                                        return (
                                            <span style={{
                                                marginLeft: '0.5rem',
                                                padding: '0.15rem 0.5rem',
                                                background: '#f59e0b',
                                                borderRadius: '999px',
                                                fontSize: '0.75rem',
                                                fontWeight: 'bold',
                                                color: '#1e293b'
                                            }}>
                                                ‚è∞ {daysToDeadline}d
                                            </span>
                                        );
                                    }
                                })()}
                            </button>
                            <button
                                onClick={() => setCurrentView('resignPlayers')}
                                className={`nav-dropdown-item ${currentView === 'resignPlayers' ? 'active' : ''}`}
                                title="Negotiate contract extensions with your players"
                            >
                                ‚úçÔ∏è Re-Sign Players
                                {(() => {
                                    const expiringCount = gameState?.players.filter(p => 
                                        p.teamId === userTeamId && 
                                        p.contract &&
                                        p.contract.yearsRemaining === 1 &&
                                        p.ratings.overall >= 70
                                    ).length || 0;
                                    if (expiringCount > 0) {
                                        return (
                                            <span style={{
                                                marginLeft: '0.5rem',
                                                padding: '0.15rem 0.5rem',
                                                background: '#f59e0b',
                                                borderRadius: '999px',
                                                fontSize: '0.75rem',
                                                fontWeight: 'bold',
                                                color: '#1e293b'
                                            }}>
                                                {expiringCount}
                                            </span>
                                        );
                                    }
                                })()}
                            </button>
                            <button
                                onClick={() => setCurrentView('draftpicks')}
                                className={`nav-dropdown-item ${currentView === 'draftpicks' ? 'active' : ''}`}
                                title="View your draft picks for upcoming drafts"
                            >
                                üé≤ Draft Picks
                            </button>
                            <button
                                className="nav-dropdown-item disabled"
                                title="Sign unrestricted free agents (Coming Soon)"
                            >
                                üÜì Free Agency (Coming Soon)
                            </button>
                        </div>
                    </div>

                    {/* 4. LEAGUE - Stats, standings, league-wide info */}
                    <div className="nav-group">
                        <button 
                            className={`nav-button has-dropdown ${['standings', 'schedule', 'stats', 'leaders', 'teamStats', 'transactions', 'playerProfile'].includes(currentView) ? 'active' : ''}`}
                            title="View league standings, stats, and schedules"
                        >
                            üìä LEAGUE
                        </button>
                        <div className="nav-dropdown">
                            <button
                                onClick={() => setCurrentView('standings')}
                                className={`nav-dropdown-item ${currentView === 'standings' ? 'active' : ''}`}
                                title="View division and conference standings with playoff picture"
                            >
                                üèÜ Standings & Playoffs
                            </button>
                            <button
                                onClick={() => setCurrentView('schedule')}
                                className={`nav-dropdown-item ${currentView === 'schedule' ? 'active' : ''}`}
                                title="View league schedule and recent scores"
                            >
                                üìÖ Schedule & Scores
                            </button>
                            <button
                                onClick={() => setCurrentView('stats')}
                                className={`nav-dropdown-item ${currentView === 'stats' ? 'active' : ''}`}
                                title="View player stats and league leaders"
                            >
                                üìà Player Stats & Leaders
                            </button>
                            <button
                                onClick={() => setCurrentView('transactions')}
                                className={`nav-dropdown-item ${currentView === 'transactions' ? 'active' : ''}`}
                                title="View all trades completed this season"
                            >
                                üìã All Transactions
                            </button>
                        </div>
                    </div>

                    {/* 5. SEASON - Awards, draft, special events */}
                    <div className="nav-group">
                        <button 
                            className={`nav-button has-dropdown ${['awards', 'draftlottery', 'draft', 'teamHistory', 'keyDates'].includes(currentView) ? 'active' : ''}`}
                            title="View awards, draft events, and season history"
                        >
                            üèÜ SEASON
                        </button>
                        <div className="nav-dropdown">
                            <button
                                onClick={() => setCurrentView('awards')}
                                className={`nav-dropdown-item ${currentView === 'awards' ? 'active' : ''} ${!seasonAwards ? 'disabled' : ''}`}
                                disabled={!seasonAwards}
                                title="View end-of-season awards and honors"
                            >
                                üèÜ Awards & Honors {!seasonAwards && '(End of Season)'}
                            </button>
                            {gameState && playoffState?.completed && (
                                <button
                                    onClick={() => {
                                        setCurrentView('draftlottery');
                                        setLotteryRevealStep(0);
                                    }}
                                    className={`nav-dropdown-item ${currentView === 'draftlottery' ? 'active' : ''}`}
                                    style={{ color: '#fbbf24', fontWeight: 'bold' }}
                                    title="Watch the draft lottery determine draft order"
                                >
                                    üé≤ Draft Lottery
                                </button>
                            )}
                            {playoffState && playoffState.completed && (
                                <button
                                    onClick={() => {
                                        setCurrentView('draft');
                                        if (!draftProspects) {
                                            setDraftProspects(generateDraftProspects());
                                        }
                                    }}
                                    className={`nav-dropdown-item ${currentView === 'draft' ? 'active' : ''}`}
                                    style={{ color: '#22c55e', fontWeight: 'bold' }}
                                    title="Select players in the entry draft"
                                >
                                    üéØ Entry Draft
                                </button>
                            )}
                            <button
                                onClick={() => setCurrentView('teamHistory')}
                                className={`nav-dropdown-item ${currentView === 'teamHistory' ? 'active' : ''}`}
                                title="View past season results and team history"
                            >
                                üìú Season History
                            </button>
                        </div>
                    </div>

                    {/* Playoffs Dropdown */}
                    {(seasonComplete || playoffState) && (
                        <div className="nav-group">
                            <button className={`nav-button has-dropdown ${['bracket', 'playoffGames'].includes(currentView) ? 'active' : ''}`}>
                                üèÜ Playoffs
                            </button>
                            <div className="nav-dropdown">
                                <button
                                    onClick={() => setCurrentView('bracket')}
                                    className={`nav-dropdown-item ${currentView === 'bracket' ? 'active' : ''}`}
                                >
                                    Bracket
                                </button>
                                <button
                                    onClick={() => setCurrentView('playoffGames')}
                                    className={`nav-dropdown-item ${currentView === 'playoffGames' ? 'active' : ''}`}
                                >
                                    Games
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Help & Documentation Dropdown */}
                    <div className="nav-group">
                        <button className={`nav-button has-dropdown ${['help', 'roadmap', 'support'].includes(currentView) ? 'active' : ''}`}>
                            ‚ùì Help
                        </button>
                        <div className="nav-dropdown">
                            <button
                                onClick={() => setCurrentView('help')}
                                className={`nav-dropdown-item ${currentView === 'help' ? 'active' : ''}`}
                            >
                                üìñ User Manual
                            </button>
                            <button
                                onClick={() => setCurrentView('roadmap')}
                                className={`nav-dropdown-item ${currentView === 'roadmap' ? 'active' : ''}`}
                            >
                                üó∫Ô∏è Roadmap
                            </button>
                            <button
                                onClick={() => window.open('https://discord.gg/zxhezDxfFm', '_blank')}
                                className="nav-dropdown-item"
                            >
                                üí¨ Discord / Report Bugs
                            </button>
                            <button
                                onClick={() => {
                                    saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                    alert('‚úÖ Game saved!');
                                }}
                                className="nav-dropdown-item"
                            >
                                üíæ Save Game
                            </button>
                            <button
                                onClick={() => setCurrentView('support')}
                                className={`nav-dropdown-item ${currentView === 'support' ? 'active' : ''}`}
                                style={{ 
                                    color: '#FF5E5B',
                                    fontWeight: 'bold'
                                }}
                            >
                                ‚òï Support Development
                            </button>
                            <button
                                onClick={deleteSave}
                                className="nav-dropdown-item"
                                style={{ color: '#ef4444' }}
                            >
                                üóëÔ∏è Delete Save
                            </button>
                        </div>
                    </div>

                    {/* Action Buttons */}
                    <div style={{ marginLeft: 'auto', display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                        {/* Playoff simulation now integrated into PLAY dropdown */}
                        
                        {/* PLAYOFFS COMPLETE - Continue to Re-sign Players */}
                        {playoffState && playoffState.completed && currentView !== 'resign' && currentView !== 'draftlottery' && currentView !== 'draft' && currentView !== 'freeagency' && (
                            <button 
                                onClick={() => {
                                    const expiring = detectExpiringContracts();
                                    setExpiringContracts(expiring);
                                    setResignedPlayers([]);
                                    setSkippedPlayers([]);
                                    setCurrentView('resign');
                                }}
                                className="action-button"
                                style={{ 
                                    background: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', 
                                    fontWeight: 'bold',
                                    boxShadow: '0 4px 12px rgba(139, 92, 246, 0.3)'
                                }}
                            >
                                üìù Re-sign Players
                            </button>
                        )}
                        
                        {/* RESIGN VIEW - Continue to Draft Lottery */}
                        {currentView === 'resign' && (
                            <button 
                                onClick={() => setCurrentView('draftlottery')} 
                                className="action-button"
                                style={{ 
                                    background: 'linear-gradient(135deg, #f59e0b, #d97706)', 
                                    fontWeight: 'bold',
                                    boxShadow: '0 4px 12px rgba(245, 158, 11, 0.3)'
                                }}
                            >
                                üé∞ Continue to Draft Lottery
                            </button>
                        )}
                        
                        {/* DRAFT LOTTERY VIEW - Continue to Draft */}
                        {currentView === 'draftlottery' && (
                            <button 
                                onClick={() => {
                                    if (!draftProspects) {
                                        setDraftProspects(generateDraftProspects());
                                    }
                                    setCurrentView('draft');
                                }}
                                className="action-button"
                                style={{ 
                                    background: 'linear-gradient(135deg, #3b82f6, #2563eb)', 
                                    fontWeight: 'bold',
                                    boxShadow: '0 4px 12px rgba(59, 130, 246, 0.3)'
                                }}
                            >
                                üìã Continue to Draft
                            </button>
                        )}
                        
                        {/* DRAFT VIEW - Continue to Free Agency */}
                        {currentView === 'draft' && (
                            <button 
                                onClick={() => {
                                    setShowDraftReportCard(true);
                                }}
                                className="action-button"
                                style={{ 
                                    background: 'linear-gradient(135deg, #22c55e, #16a34a)', 
                                    fontWeight: 'bold',
                                    boxShadow: '0 4px 12px rgba(34, 197, 94, 0.3)'
                                }}
                            >
                                üíº Continue to Free Agency
                            </button>
                        )}
                        
                        {/* FREE AGENCY VIEW - Finish and Start New Season */}
                        {currentView === 'freeagency' && (
                            <button 
                                onClick={() => {
                                    setShowReportCard(true);
                                }}
                                className="action-button"
                                style={{ 
                                    background: 'linear-gradient(135deg, #22c55e, #16a34a)', 
                                    fontWeight: 'bold',
                                    boxShadow: '0 4px 12px rgba(34, 197, 94, 0.3)'
                                }}
                            >
                                üèÅ Finish Free Agency
                            </button>
                        )}
                    </div>
                </div>
            </div>

            <div className="content">
                {/* NEW: Mid-Season Report Card */}
                {gameState?.midSeasonReport && (
                    <div className="card" style={{ 
                        background: 'linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1))',
                        border: '2px solid #f59e0b',
                        marginBottom: '2rem'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h2 style={{ color: '#fbbf24', margin: 0 }}>üìä Mid-Season Report Card</h2>
                            <button
                                onClick={() => {
                                    setGameState(prevState => ({
                                        ...prevState,
                                        midSeasonReport: null
                                    }));
                                }}
                                style={{
                                    padding: '0.25rem 0.75rem',
                                    background: '#ef4444',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.375rem',
                                    cursor: 'pointer',
                                    fontSize: '0.875rem'
                                }}
                            >
                                Dismiss
                            </button>
                        </div>
                        
                        <p style={{ color: '#93c5fd', fontSize: '1.1rem', marginBottom: '1.5rem' }}>
                            All-Star Break ‚Ä¢ {gameState.midSeasonReport.gamesPlayed} Games Played
                        </p>
                        
                        {/* Performance Summary */}
                        <div style={{ 
                            display: 'grid', 
                            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                            gap: '1rem',
                            marginBottom: '2rem'
                        }}>
                            <div style={{ 
                                padding: '1rem', 
                                background: gameState.midSeasonReport.performance === 'exceeding' ? 'rgba(34, 197, 94, 0.2)' : 
                                           gameState.midSeasonReport.performance === 'underperforming' ? 'rgba(239, 68, 68, 0.2)' : 
                                           'rgba(59, 130, 246, 0.2)',
                                borderRadius: '0.5rem',
                                border: `2px solid ${gameState.midSeasonReport.performance === 'exceeding' ? '#22c55e' : 
                                                    gameState.midSeasonReport.performance === 'underperforming' ? '#ef4444' : 
                                                    '#3b82f6'}`
                            }}>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>RECORD</div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                    {gameState.midSeasonReport.record}
                                </div>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>
                                    Expected: {gameState.midSeasonReport.expected}
                                </div>
                            </div>
                            
                            <div style={{ padding: '1rem', background: 'rgba(139, 92, 246, 0.2)', borderRadius: '0.5rem', border: '2px solid #8b5cf6' }}>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>PERFORMANCE</div>
                                <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: gameState.midSeasonReport.performance === 'exceeding' ? '#22c55e' : 
                                                                                                            gameState.midSeasonReport.performance === 'underperforming' ? '#ef4444' : 
                                                                                                            '#3b82f6' }}>
                                    {gameState.midSeasonReport.performance === 'exceeding' ? 'üî• EXCEEDING' : 
                                     gameState.midSeasonReport.performance === 'underperforming' ? '‚ö†Ô∏è BELOW' : 
                                     '‚úÖ ON PACE'}
                                </div>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                    {gameState.midSeasonReport.performanceText}
                                </div>
                            </div>
                            
                            <div style={{ padding: '1rem', background: 'rgba(34, 211, 238, 0.2)', borderRadius: '0.5rem', border: '2px solid #22d3ee' }}>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>PLAYOFF ODDS</div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                    {gameState.midSeasonReport.playoffOdds}%
                                </div>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>
                                    Current Rank: #{gameState.midSeasonReport.currentRank}
                                </div>
                            </div>
                            
                            <div style={{ padding: '1rem', background: 'rgba(236, 72, 153, 0.2)', borderRadius: '0.5rem', border: '2px solid #ec4899' }}>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>PROJECTED FINISH</div>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                    {gameState.midSeasonReport.projectedPoints} pts
                                </div>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>
                                    Goal Diff: {gameState.midSeasonReport.goalDiff > 0 ? '+' : ''}{gameState.midSeasonReport.goalDiff}
                                </div>
                            </div>
                        </div>
                        
                        {/* Strengths & Concerns */}
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                            <div>
                                <h3 style={{ color: '#22c55e', marginBottom: '1rem' }}>‚úÖ Strengths</h3>
                                {gameState.midSeasonReport.strengths.length > 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                        {gameState.midSeasonReport.strengths.map((strength, idx) => (
                                            <div key={idx} style={{ 
                                                padding: '0.75rem', 
                                                background: 'rgba(34, 197, 94, 0.1)', 
                                                borderRadius: '0.375rem',
                                                borderLeft: '3px solid #22c55e'
                                            }}>
                                                <div style={{ fontWeight: 'bold', marginBottom: '0.25rem' }}>{strength.stat}</div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>{strength.value} ‚Ä¢ {strength.rank}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div style={{ color: '#93c5fd', fontStyle: 'italic' }}>No standout strengths identified</div>
                                )}
                            </div>
                            
                            <div>
                                <h3 style={{ color: '#f59e0b', marginBottom: '1rem' }}>‚ö†Ô∏è Concerns</h3>
                                {gameState.midSeasonReport.concerns.length > 0 ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                        {gameState.midSeasonReport.concerns.map((concern, idx) => (
                                            <div key={idx} style={{ 
                                                padding: '0.75rem', 
                                                background: 'rgba(245, 158, 11, 0.1)', 
                                                borderRadius: '0.375rem',
                                                borderLeft: '3px solid #f59e0b'
                                            }}>
                                                <div style={{ fontWeight: 'bold', marginBottom: '0.25rem' }}>{concern.stat}</div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>{concern.value}</div>
                                                <div style={{ fontSize: '0.75rem', color: '#fde68a', fontStyle: 'italic' }}>üí° {concern.suggestion}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div style={{ color: '#93c5fd', fontStyle: 'italic' }}>No major concerns - keep it up!</div>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                
                {currentView === 'keyDates' && gameState && (
                    <div className="card">
                        <h2 style={{ marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            üìÖ Key Days - Season {gameState.season} ({gameState.year})
                        </h2>
                        <div style={{
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))',
                            gap: '1rem'
                        }}>
                            {/* Season Start */}
                            <div style={{
                                padding: '1rem',
                                background: 'rgba(59, 130, 246, 0.1)',
                                borderRadius: '0.5rem',
                                border: '1px solid rgba(59, 130, 246, 0.3)'
                            }}>
                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                    SEASON START
                                </div>
                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                    Day 1
                                </div>
                            </div>
                            
                            {/* All-Star Break */}
                            <div style={{
                                padding: '1rem',
                                background: 'rgba(251, 191, 36, 0.1)',
                                borderRadius: '0.5rem',
                                border: '1px solid rgba(251, 191, 36, 0.3)'
                            }}>
                                <div style={{ fontSize: '0.875rem', color: '#fde68a', marginBottom: '0.25rem' }}>
                                    ALL-STAR BREAK
                                </div>
                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fbbf24' }}>
                                    Day {allStarBreakDay}
                                </div>
                            </div>
                            
                            {/* Trade Deadline */}
                            <div style={{
                                padding: '1rem',
                                background: isTradeDeadlinePassed ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                                borderRadius: '0.5rem',
                                border: `1px solid ${isTradeDeadlinePassed ? 'rgba(239, 68, 68, 0.3)' : 'rgba(34, 197, 94, 0.3)'}`
                            }}>
                                <div style={{ 
                                    fontSize: '0.875rem', 
                                    color: isTradeDeadlinePassed ? '#fca5a5' : '#86efac', 
                                    marginBottom: '0.25rem' 
                                }}>
                                    TRADE DEADLINE
                                </div>
                                <div style={{ 
                                    fontSize: '1.25rem', 
                                    fontWeight: 'bold',
                                    color: isTradeDeadlinePassed ? '#ef4444' : '#22c55e'
                                }}>
                                    Day {tradeDeadlineDay}
                                    {isTradeDeadlinePassed && (
                                        <span style={{ fontSize: '0.875rem', marginLeft: '0.5rem', color: '#ef4444' }}>
                                            PASSED
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            {/* Regular Season End */}
                            <div style={{
                                padding: '1rem',
                                background: 'rgba(139, 92, 246, 0.1)',
                                borderRadius: '0.5rem',
                                border: '1px solid rgba(139, 92, 246, 0.3)'
                            }}>
                                <div style={{ fontSize: '0.875rem', color: '#c4b5fd', marginBottom: '0.25rem' }}>
                                    REGULAR SEASON END
                                </div>
                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#a78bfa' }}>
                                    Day 82
                                </div>
                            </div>
                            
                            {/* Playoffs */}
                            <div style={{
                                padding: '1rem',
                                background: 'rgba(236, 72, 153, 0.1)',
                                borderRadius: '0.5rem',
                                border: '1px solid rgba(236, 72, 153, 0.3)'
                            }}>
                                <div style={{ fontSize: '0.875rem', color: '#fbcfe8', marginBottom: '0.25rem' }}>
                                    PLAYOFFS
                                </div>
                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#ec4899' }}>
                                    After Day 82
                                </div>
                            </div>
                        </div>
                    </div>
                )}
                
                {currentView === 'standings' && gameState && gameState.standings && (
                    <div>
                        <div className="standings-nav">
                            {['division', 'conference', 'wildcard', 'league'].map(view => (
                                <button
                                    key={view}
                                    onClick={() => setStandingsView(view)}
                                    className={standingsView === view ? 'active' : ''}
                                >
                                    {view === 'wildcard' ? 'Wild Card' : view.charAt(0).toUpperCase() + view.slice(1)}
                                </button>
                            ))}
                        </div>
                        
                        {/* Playoff Race Card - only show in final 22 games */}
                        {gameState.currentDay >= 60 && (() => {
                            const raceInfo = getPlayoffRaceInfo();
                            if (!raceInfo) return null;
                            
                            return (
                                <div className="card" style={{ 
                                    marginBottom: '2rem',
                                    background: 'rgba(139, 92, 246, 0.1)',
                                    border: '2px solid #8b5cf6'
                                }}>
                                    <h2 style={{ color: '#a78bfa', marginBottom: '1.5rem' }}>üèÅ Playoff Race</h2>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem' }}>
                                        {/* Eastern Conference */}
                                        <div>
                                            <h3 style={{ color: '#3b82f6', marginBottom: '1rem' }}>Eastern Conference</h3>
                                            
                                            {raceInfo.east.clinched.length > 0 && (
                                                <div style={{ marginBottom: '1rem' }}>
                                                    <h4 style={{ color: '#22c55e', fontSize: '0.9rem', marginBottom: '0.5rem' }}>‚úÖ Clinched</h4>
                                                    {raceInfo.east.clinched.map((team, idx) => (
                                                        <div key={idx} style={{ 
                                                            color: '#e2e8f0', 
                                                            fontSize: '0.9rem',
                                                            padding: '0.25rem 0'
                                                        }}>
                                                            {team.seed}. {team.name}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {raceInfo.east.inRace.length > 0 && (
                                                <div style={{ marginBottom: '1rem' }}>
                                                    <h4 style={{ color: '#fbbf24', fontSize: '0.9rem', marginBottom: '0.5rem' }}>‚ö†Ô∏è In the Race</h4>
                                                    {raceInfo.east.inRace.map((team, idx) => (
                                                        <div key={idx} style={{ 
                                                            color: '#e2e8f0', 
                                                            fontSize: '0.9rem',
                                                            padding: '0.25rem 0'
                                                        }}>
                                                            {team.name} {team.pointsBack !== undefined && `(${team.pointsBack} pts back)`}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {raceInfo.east.eliminated.length > 0 && (
                                                <div>
                                                    <h4 style={{ color: '#64748b', fontSize: '0.9rem', marginBottom: '0.5rem' }}>‚ùå Eliminated</h4>
                                                    {raceInfo.east.eliminated.slice(0, 3).map((team, idx) => (
                                                        <div key={idx} style={{ 
                                                            color: '#64748b', 
                                                            fontSize: '0.9rem',
                                                            padding: '0.25rem 0'
                                                        }}>
                                                            {team.name}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        
                                        {/* Western Conference */}
                                        <div>
                                            <h3 style={{ color: '#3b82f6', marginBottom: '1rem' }}>Western Conference</h3>
                                            
                                            {raceInfo.west.clinched.length > 0 && (
                                                <div style={{ marginBottom: '1rem' }}>
                                                    <h4 style={{ color: '#22c55e', fontSize: '0.9rem', marginBottom: '0.5rem' }}>‚úÖ Clinched</h4>
                                                    {raceInfo.west.clinched.map((team, idx) => (
                                                        <div key={idx} style={{ 
                                                            color: '#e2e8f0', 
                                                            fontSize: '0.9rem',
                                                            padding: '0.25rem 0'
                                                        }}>
                                                            {team.seed}. {team.name}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {raceInfo.west.inRace.length > 0 && (
                                                <div style={{ marginBottom: '1rem' }}>
                                                    <h4 style={{ color: '#fbbf24', fontSize: '0.9rem', marginBottom: '0.5rem' }}>‚ö†Ô∏è In the Race</h4>
                                                    {raceInfo.west.inRace.map((team, idx) => (
                                                        <div key={idx} style={{ 
                                                            color: '#e2e8f0', 
                                                            fontSize: '0.9rem',
                                                            padding: '0.25rem 0'
                                                        }}>
                                                            {team.name} {team.pointsBack !== undefined && `(${team.pointsBack} pts back)`}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            {raceInfo.west.eliminated.length > 0 && (
                                                <div>
                                                    <h4 style={{ color: '#64748b', fontSize: '0.9rem', marginBottom: '0.5rem' }}>‚ùå Eliminated</h4>
                                                    {raceInfo.west.eliminated.slice(0, 3).map((team, idx) => (
                                                        <div key={idx} style={{ 
                                                            color: '#64748b', 
                                                            fontSize: '0.9rem',
                                                            padding: '0.25rem 0'
                                                        }}>
                                                            {team.name}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {renderStandings()}
                    </div>
                )}

                {/* TEAM LANDING PAGE */}
                {currentView === 'teamLanding' && gameState && (() => {
                    const userTeam = TEAMS.find(t => t.id === userTeamId);
                    const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === userTeamId);
                    const userRoster = gameState.players.filter(p => p.teamId === userTeamId && p.roster === 'nhl');
                    const farmRoster = gameState.players.filter(p => p.farmTeamId === farmTeam?.id);
                    const teamStandings = gameState.standings.find(s => s.teamId === userTeamId);
                    const capStatus = calculateTeamCapHit(userTeamId, gameState.players);
                    const teamOverallData = getTeamOverall(userTeamId);
                    
                    // Get team's division and conference from team data
                    const division = userTeam?.division || 'Unknown';
                    const conference = userTeam?.conference || 'Unknown';
                    
                    // Get injured players
                    const injuredPlayers = userRoster.filter(p => p.injury.injured);
                    
                    // Get top 3 scorers
                    const topScorers = [...userRoster]
                        .sort((a, b) => b.stats.points - a.stats.points)
                        .slice(0, 3);
                    
                    // Get recent games (last 3)
                    const recentGames = [];
                    if (gameState.schedule) {
                        for (let day = gameState.currentDay - 1; day >= 1 && recentGames.length < 3; day--) {
                            const daySchedule = gameState.schedule.find(d => d.day === day);
                            if (daySchedule?.matchups) {
                                const userGame = daySchedule.matchups.find(m => 
                                    (m.homeTeam === userTeamId || m.awayTeam === userTeamId) && m.played
                                );
                                if (userGame) {
                                    recentGames.push({ ...userGame, day });
                                }
                            }
                        }
                    }
                    
                    // Get upcoming games (next 3)
                    const upcomingGames = [];
                    if (gameState.schedule) {
                        for (let day = gameState.currentDay; day <= 82 && upcomingGames.length < 3; day++) {
                            const daySchedule = gameState.schedule.find(d => d.day === day);
                            if (daySchedule?.matchups) {
                                const userGame = daySchedule.matchups.find(m => 
                                    (m.homeTeam === userTeamId || m.awayTeam === userTeamId) && !m.played
                                );
                                if (userGame) {
                                    upcomingGames.push({ ...userGame, day });
                                }
                            }
                        }
                    }
                    
                    // Calculate recent form (last 10 games)
                    let recentForm = { wins: 0, losses: 0, otLosses: 0 };
                    if (gameState.schedule) {
                        let gamesFound = 0;
                        for (let day = gameState.currentDay - 1; day >= 1 && gamesFound < 10; day--) {
                            const daySchedule = gameState.schedule.find(d => d.day === day);
                            if (daySchedule?.matchups) {
                                const userGame = daySchedule.matchups.find(m => 
                                    (m.homeTeam === userTeamId || m.awayTeam === userTeamId) && m.played
                                );
                                if (userGame) {
                                    gamesFound++;
                                    const userIsHome = userGame.homeTeam === userTeamId;
                                    const userScore = userIsHome ? userGame.homeScore : userGame.awayScore;
                                    const oppScore = userIsHome ? userGame.awayScore : userGame.homeScore;
                                    
                                    if (userScore > oppScore) {
                                        recentForm.wins++;
                                    } else if (userGame.isOvertimeGame) {
                                        recentForm.otLosses++;
                                    } else {
                                        recentForm.losses++;
                                    }
                                }
                            }
                        }
                    }
                    
                    // Get division standings
                    const divisionStandings = gameState.standings
                        .filter(s => {
                            const team = TEAMS.find(t => t.id === s.teamId);
                            return team && team.division === division;
                        })
                        .sort((a, b) => b.points - a.points);
                    
                    const userDivisionRank = divisionStandings.findIndex(s => s.teamId === userTeamId) + 1;
                    
                    // ===== FEATURE: PLAYOFF PICTURE TRACKER =====
                    const calculatePlayoffPicture = () => {
                        // Safety check - ensure standings exist
                        if (!gameState?.standings || !teamStandings) {
                            return {
                                status: 'unknown',
                                seed: 0,
                                message: 'Loading standings...'
                            };
                        }
                        
                        // Get conference standings
                        const conferenceTeams = gameState.standings.filter(s => {
                            const team = TEAMS.find(t => t.id === s.teamId);
                            return team && team.conference === conference;
                        }).sort((a, b) => b.points - a.points);
                        
                        // Safety check - need at least 8 teams in conference
                        if (conferenceTeams.length < 8) {
                            return {
                                status: 'unknown',
                                seed: 0,
                                message: 'Calculating standings...'
                            };
                        }
                        
                        const userConferenceRank = conferenceTeams.findIndex(s => s.teamId === userTeamId) + 1;
                        const playoffLine = 8; // Top 8 make playoffs
                        
                        if (userConferenceRank <= playoffLine) {
                            // In playoff position
                            const ninthPlace = conferenceTeams[playoffLine]; // 9th place team (index 8)
                            const pointsAbove9th = ninthPlace ? 
                                teamStandings.points - ninthPlace.points : 999;
                            return {
                                status: 'in',
                                seed: userConferenceRank,
                                cushion: pointsAbove9th,
                                message: `Currently ${userConferenceRank}${userConferenceRank === 1 ? 'st' : userConferenceRank === 2 ? 'nd' : userConferenceRank === 3 ? 'rd' : 'th'} seed`
                            };
                        } else {
                            // Out of playoffs
                            const eighthPlace = conferenceTeams[playoffLine - 1]; // 8th place team (index 7)
                            if (!eighthPlace) {
                                return {
                                    status: 'unknown',
                                    seed: userConferenceRank,
                                    message: 'Calculating playoff picture...'
                                };
                            }
                            
                            const pointsBehind8th = eighthPlace.points - teamStandings.points;
                            const gamesRemaining = 82 - (teamStandings?.teamStats?.gamesPlayed || 0);
                            const maxPossiblePoints = teamStandings.points + (gamesRemaining * 2);
                            const isEliminated = maxPossiblePoints < eighthPlace.points;
                            
                            return {
                                status: isEliminated ? 'eliminated' : 'out',
                                seed: userConferenceRank,
                                deficit: pointsBehind8th,
                                message: isEliminated ? 'Eliminated from playoffs' : `${pointsBehind8th} pts behind 8th seed`
                            };
                        }
                    };
                    
                    const playoffPicture = calculatePlayoffPicture();
                    
                    // ===== FEATURE: GAME CALENDAR =====
                    const getCalendarGames = () => {
                        const calendar = [];
                        const today = gameState.currentDay;
                        
                        // Get today's game if exists
                        if (gameState.schedule) {
                            const todaySchedule = gameState.schedule.find(d => d.day === today);
                            if (todaySchedule?.matchups) {
                                const todayGame = todaySchedule.matchups.find(m =>
                                    (m.homeTeam === userTeamId || m.awayTeam === userTeamId)
                                );
                                if (todayGame) {
                                    calendar.push({ ...todayGame, day: today, isToday: true });
                                }
                            }
                            
                            // Get next 3 games
                            for (let day = today + 1; day <= 82 && calendar.filter(g => !g.isToday).length < 3; day++) {
                                const daySchedule = gameState.schedule.find(d => d.day === day);
                                if (daySchedule?.matchups) {
                                    const game = daySchedule.matchups.find(m =>
                                        (m.homeTeam === userTeamId || m.awayTeam === userTeamId) && !m.played
                                    );
                                    if (game) {
                                        calendar.push({ ...game, day, isToday: false });
                                    }
                                }
                            }
                        }
                        
                        return calendar;
                    };
                    
                    const calendarGames = getCalendarGames();
                    
                    // ===== FEATURE: GAME HIGHLIGHTS =====
                    // These are generated during simulation and shown via notifications
                    // Already implemented via seasonNotifications system
                    
                    // Toggle function for collapsible sections (state is at component level)
                    const toggleSection = (section) => {
                        setExpandedSections(prev => ({
                            ...prev,
                            [section]: !prev[section]
                        }));
                    };
                    
                    return (
                        <div>
                            {/* HEADER */}
                            <div className="card" style={{ marginBottom: '1.5rem', textAlign: 'center' }}>
                                <h1 style={{ fontSize: '2.5rem', marginBottom: '0.5rem', color: '#60a5fa' }}>
                                    üèí {userTeam.city} {userTeam.name}
                                </h1>
                                <div style={{ fontSize: '1.25rem', color: '#93c5fd' }}>
                                    Team Command Center
                                </div>
                            </div>
                            
                            {/* WHAT SHOULD I DO NEXT? - QUICK ACTION CARD */}
                            {(() => {
                                // Calculate important alerts
                                const expiringContracts = userRoster.filter(p => 
                                    p.contract &&
                                    p.contract.yearsRemaining === 1 && 
                                    p.ratings.overall >= 70
                                );
                                const hasInjuries = injuredPlayers.length > 0;
                                const nextGame = upcomingGames[0];
                                const daysToTradeDeadline = 56 - gameState.currentDay;
                                const isNearTradeDeadline = daysToTradeDeadline > 0 && daysToTradeDeadline <= 7;
                                
                                // Build priority actions list
                                const actions = [];
                                
                                // Next game (always show if available)
                                if (nextGame) {
                                    const opponent = TEAMS.find(t => t.id === (nextGame.homeTeam === userTeamId ? nextGame.awayTeam : nextGame.homeTeam));
                                    const isHome = nextGame.homeTeam === userTeamId;
                                    actions.push({
                                        icon: 'üéÆ',
                                        text: `Next game: ${isHome ? 'vs' : '@'} ${opponent?.city} ${opponent?.name} (Day ${nextGame.day})`,
                                        action: () => simulateDay82WithPopup(),
                                        color: '#22c55e',
                                        priority: 1
                                    });
                                }
                                
                                // Injuries (high priority)
                                if (hasInjuries) {
                                    actions.push({
                                        icon: 'üè•',
                                        text: `${injuredPlayers.length} player${injuredPlayers.length > 1 ? 's' : ''} injured - Check roster`,
                                        action: () => setCurrentView('injuries'),
                                        color: '#ef4444',
                                        priority: 2
                                    });
                                }
                                
                                // Expiring contracts (medium-high priority)
                                if (expiringContracts.length > 0) {
                                    actions.push({
                                        icon: '‚úçÔ∏è',
                                        text: `${expiringContracts.length} key player${expiringContracts.length > 1 ? 's' : ''} need new contracts`,
                                        action: () => setCurrentView('resignPlayers'),
                                        color: '#f59e0b',
                                        priority: 3
                                    });
                                }
                                
                                // Trade deadline warning
                                if (isNearTradeDeadline) {
                                    actions.push({
                                        icon: '‚è∞',
                                        text: `Trade deadline in ${daysToTradeDeadline} day${daysToTradeDeadline > 1 ? 's' : ''}!`,
                                        action: () => setCurrentView('trade'),
                                        color: '#f59e0b',
                                        priority: 3
                                    });
                                }
                                
                                // Playoff status (show if relevant)
                                if (playoffPicture.status === 'in' && playoffPicture.cushion <= 5) {
                                    actions.push({
                                        icon: 'üèÜ',
                                        text: `Playoff spot: Only ${playoffPicture.cushion} pts ahead of 9th`,
                                        action: () => setCurrentView('standings'),
                                        color: '#3b82f6',
                                        priority: 4
                                    });
                                } else if (playoffPicture.status === 'out' && !playoffPicture.eliminated) {
                                    actions.push({
                                        icon: 'üìà',
                                        text: `${playoffPicture.deficit} points behind playoff spot`,
                                        action: () => setCurrentView('standings'),
                                        color: '#3b82f6',
                                        priority: 4
                                    });
                                }
                                
                                // Sort by priority and take top 4
                                const topActions = actions.sort((a, b) => a.priority - b.priority).slice(0, 4);
                                
                                if (topActions.length === 0) return null;
                                
                                return (
                                    <div className="card" style={{ 
                                        marginBottom: '1.5rem',
                                        background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1))',
                                        border: '2px solid rgba(59, 130, 246, 0.4)'
                                    }}>
                                        <h3 style={{ 
                                            color: '#60a5fa', 
                                            marginBottom: '1rem',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.5rem'
                                        }}>
                                            üí° What Should I Do Next?
                                        </h3>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                            {topActions.map((action, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={action.action}
                                                    style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '0.75rem',
                                                        padding: '1rem',
                                                        background: 'rgba(30, 58, 138, 0.4)',
                                                        border: `2px solid ${action.color}`,
                                                        borderLeft: `6px solid ${action.color}`,
                                                        borderRadius: '0.5rem',
                                                        color: 'white',
                                                        fontSize: '1rem',
                                                        cursor: 'pointer',
                                                        transition: 'all 0.2s',
                                                        textAlign: 'left',
                                                        width: '100%'
                                                    }}
                                                    onMouseEnter={(e) => {
                                                        e.currentTarget.style.background = 'rgba(30, 58, 138, 0.6)';
                                                        e.currentTarget.style.transform = 'translateX(4px)';
                                                    }}
                                                    onMouseLeave={(e) => {
                                                        e.currentTarget.style.background = 'rgba(30, 58, 138, 0.4)';
                                                        e.currentTarget.style.transform = 'translateX(0)';
                                                    }}
                                                >
                                                    <span style={{ fontSize: '1.5rem' }}>{action.icon}</span>
                                                    <span style={{ flex: 1 }}>{action.text}</span>
                                                    <span style={{ color: action.color, fontSize: '1.25rem' }}>‚Üí</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })()}
                            
                            {/* QUICK PLAYER SEARCH */}
                            <div className="card" style={{ marginBottom: '1.5rem' }}>
                                <div style={{ position: 'relative' }}>
                                    <input
                                        type="text"
                                        placeholder="üîç Quick search players (name, team, position)..."
                                        value={playerSearchQuery || ''}
                                        onChange={(e) => setPlayerSearchQuery(e.target.value)}
                                        style={{
                                            width: '100%',
                                            padding: '1rem 1rem 1rem 3rem',
                                            background: 'rgba(30, 58, 138, 0.3)',
                                            border: '2px solid rgba(59, 130, 246, 0.4)',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontSize: '1rem',
                                            outline: 'none'
                                        }}
                                        onFocus={(e) => e.target.style.borderColor = '#3b82f6'}
                                        onBlur={(e) => e.target.style.borderColor = 'rgba(59, 130, 246, 0.4)'}
                                    />
                                    <div style={{
                                        position: 'absolute',
                                        left: '1rem',
                                        top: '50%',
                                        transform: 'translateY(-50%)',
                                        fontSize: '1.5rem',
                                        pointerEvents: 'none'
                                    }}>
                                        üîç
                                    </div>
                                </div>
                                
                                {/* Search Results Dropdown */}
                                {playerSearchQuery && playerSearchQuery.length >= 2 && (
                                    <div style={{
                                        marginTop: '0.5rem',
                                        background: 'rgba(15, 23, 42, 0.95)',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '0.5rem',
                                        maxHeight: '400px',
                                        overflowY: 'auto'
                                    }}>
                                        {(() => {
                                            const query = playerSearchQuery.toLowerCase();
                                            const results = gameState.players.filter(p => {
                                                const fullName = `${p.firstName} ${p.lastName}`.toLowerCase();
                                                const team = TEAMS.find(t => t.id === p.teamId);
                                                const teamName = team ? `${team.city} ${team.name}`.toLowerCase() : '';
                                                return fullName.includes(query) || 
                                                       teamName.includes(query) ||
                                                       p.position.toLowerCase().includes(query);
                                            }).slice(0, 10);
                                            
                                            if (results.length === 0) {
                                                return (
                                                    <div style={{ padding: '1rem', color: '#93c5fd', textAlign: 'center' }}>
                                                        No players found
                                                    </div>
                                                );
                                            }
                                            
                                            return results.map(player => {
                                                const team = TEAMS.find(t => t.id === player.teamId);
                                                return (
                                                    <div
                                                        key={player.id}
                                                        onClick={() => {
                                                            navigateTo('playerProfile', player);
                                                            setPlayerSearchQuery('');
                                                        }}
                                                        style={{
                                                            padding: '0.75rem 1rem',
                                                            borderBottom: '1px solid rgba(59, 130, 246, 0.2)',
                                                            cursor: 'pointer',
                                                            transition: 'background 0.2s'
                                                        }}
                                                        onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(59, 130, 246, 0.2)'}
                                                        onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                    >
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                            <div>
                                                                <div style={{ fontWeight: 'bold', color: 'white' }}>
                                                                    {player.firstName} {player.lastName}
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>
                                                                    {team ? `${team.city} ${team.name}` : 'Free Agent'} ‚Ä¢ {player.position}
                                                                </div>
                                                            </div>
                                                            <div style={{
                                                                padding: '0.25rem 0.5rem',
                                                                background: player.ratings.overall >= 85 ? 'rgba(34, 197, 94, 0.2)' :
                                                                           player.ratings.overall >= 80 ? 'rgba(59, 130, 246, 0.2)' :
                                                                           'rgba(100, 116, 139, 0.2)',
                                                                borderRadius: '0.25rem',
                                                                fontWeight: 'bold',
                                                                color: player.ratings.overall >= 85 ? '#22c55e' :
                                                                       player.ratings.overall >= 80 ? '#60a5fa' : '#94a3b8'
                                                            }}>
                                                                {player.ratings.overall} OVR
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            });
                                        })()}
                                    </div>
                                )}
                            </div>
                            
                            {/* PLAYOFF PICTURE & GAME CALENDAR ROW */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginBottom: '1.5rem' }}>
                                {/* Playoff Picture Tracker */}
                                <div className="card" style={{
                                    background: playoffPicture.status === 'in' ? 'rgba(34, 197, 94, 0.1)' :
                                               playoffPicture.status === 'eliminated' ? 'rgba(239, 68, 68, 0.1)' :
                                               'rgba(245, 158, 11, 0.1)',
                                    border: `2px solid ${playoffPicture.status === 'in' ? '#22c55e' :
                                                         playoffPicture.status === 'eliminated' ? '#ef4444' : '#f59e0b'}`
                                }}>
                                    <h2 style={{
                                        color: playoffPicture.status === 'in' ? '#22c55e' :
                                               playoffPicture.status === 'eliminated' ? '#ef4444' : '#f59e0b',
                                        marginBottom: '1rem'
                                    }}>
                                        üèÜ Playoff Picture
                                    </h2>
                                    <div style={{ fontSize: '2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                        {playoffPicture.message}
                                    </div>
                                    {playoffPicture.status === 'in' && (
                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>
                                            {playoffPicture.cushion} point cushion above 9th
                                        </div>
                                    )}
                                    {playoffPicture.status === 'out' && (
                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>
                                            Currently {playoffPicture.seed}th in {conference}
                                        </div>
                                    )}
                                    {playoffPicture.status === 'eliminated' && (
                                        <div style={{ color: '#93c5fd', fontSize: '1rem' }}>
                                            Season goal: Build for next year
                                        </div>
                                    )}
                                </div>
                                
                                {/* Game Calendar */}
                                <div className="card">
                                    <h2 style={{ color: '#8b5cf6', marginBottom: '1rem' }}>üìÖ Game Calendar</h2>
                                    {calendarGames.length === 0 ? (
                                        <div style={{ textAlign: 'center', color: '#93c5fd', padding: '2rem 0' }}>
                                            No upcoming games
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                            {calendarGames.map((game, idx) => {
                                                const userIsHome = game.homeTeam === userTeamId;
                                                const opponent = TEAMS.find(t => t.id === (userIsHome ? game.awayTeam : game.homeTeam));
                                                if (!opponent) return null; // Safety check
                                                
                                                const oppStanding = gameState.standings.find(s => s.teamId === opponent.id);
                                                
                                                return (
                                                    <div
                                                        key={idx}
                                                        style={{
                                                            padding: '0.75rem',
                                                            background: game.isToday ? 'rgba(34, 197, 94, 0.2)' : 'rgba(139, 92, 246, 0.1)',
                                                            border: `2px solid ${game.isToday ? '#22c55e' : 'rgba(139, 92, 246, 0.3)'}`,
                                                            borderRadius: '0.375rem'
                                                        }}
                                                    >
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                            <div>
                                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                                    {game.isToday ? 'üî¥ TODAY' : `Day ${game.day}`} ‚Ä¢ {userIsHome ? 'HOME' : 'AWAY'}
                                                                </div>
                                                                <div style={{ fontWeight: 'bold', fontSize: '1rem' }}>
                                                                    {userIsHome ? 'vs' : '@'} {opponent.name}
                                                                </div>
                                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd' }}>
                                                                    {oppStanding?.wins}-{oppStanding?.losses}-{oppStanding?.otLosses}
                                                                </div>
                                                            </div>
                                                            {game.isToday && (
                                                                <button
                                                                    onClick={simulateDay82WithPopup}
                                                                    style={{
                                                                        padding: '0.5rem 1rem',
                                                                        background: '#22c55e',
                                                                        border: 'none',
                                                                        borderRadius: '0.375rem',
                                                                        color: 'white',
                                                                        fontWeight: 'bold',
                                                                        cursor: 'pointer',
                                                                        fontSize: '0.875rem'
                                                                    }}
                                                                >
                                                                    Play Now
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* QUICK ACTIONS BAR */}
                            <div className="card" style={{ marginBottom: '1.5rem' }}>
                                <h2 style={{ color: '#22d3ee', marginBottom: '1rem' }}>‚ö° Quick Actions</h2>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '0.75rem' }}>
                                    <button
                                        onClick={simulateDay82WithPopup}
                                        style={{
                                            padding: '1rem',
                                            background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontWeight: 'bold',
                                            fontSize: '1rem',
                                            cursor: 'pointer',
                                            transition: 'transform 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                        onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                    >
                                        üéÆ Simulate Next Game
                                    </button>
                                    
                                    <button
                                        onClick={() => setCurrentView('schedule')}
                                        style={{
                                            padding: '1rem',
                                            background: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontWeight: 'bold',
                                            fontSize: '1rem',
                                            cursor: 'pointer',
                                            transition: 'transform 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                        onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                    >
                                        üìÖ View Schedule
                                    </button>
                                    
                                    <button
                                        onClick={() => setCurrentView('trade')}
                                        style={{
                                            padding: '1rem',
                                            background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontWeight: 'bold',
                                            fontSize: '1rem',
                                            cursor: 'pointer',
                                            transition: 'transform 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                        onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                    >
                                        üîÑ Make Trade
                                    </button>
                                    
                                    <button
                                        onClick={() => setCurrentView('lines')}
                                        style={{
                                            padding: '1rem',
                                            background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontWeight: 'bold',
                                            fontSize: '1rem',
                                            cursor: 'pointer',
                                            transition: 'transform 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                                        onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                    >
                                        üìã Adjust Lines
                                    </button>
                                </div>
                            </div>
                            
                            {/* TEAM PERFORMANCE */}
                            <div className="card" style={{ marginBottom: '1.5rem' }}>
                                <h2 style={{ color: '#fbbf24', marginBottom: '1rem' }}>üìä Team Performance</h2>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1.5rem' }}>
                                    {/* Current Record */}
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        borderRadius: '0.5rem',
                                        border: '2px solid rgba(59, 130, 246, 0.3)'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                            CURRENT RECORD
                                        </div>
                                        <div style={{ fontSize: '2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                            {teamStandings.wins}-{teamStandings.losses}-{teamStandings.otLosses}
                                        </div>
                                        <div style={{ color: '#93c5fd' }}>
                                            {teamStandings.points} Points ‚Ä¢ {teamStandings?.teamStats?.gamesPlayed || 0} GP
                                        </div>
                                    </div>
                                    
                                    {/* Recent Form */}
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(34, 197, 94, 0.1)',
                                        borderRadius: '0.5rem',
                                        border: '2px solid rgba(34, 197, 94, 0.3)'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                            LAST 10 GAMES
                                        </div>
                                        <div style={{ fontSize: '2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                            {recentForm.wins}-{recentForm.losses}-{recentForm.otLosses}
                                        </div>
                                        <div style={{ color: '#93c5fd' }}>
                                            {((recentForm.wins / Math.max(1, recentForm.wins + recentForm.losses + recentForm.otLosses)) * 100).toFixed(0)}% Win Rate
                                        </div>
                                    </div>
                                    
                                    {/* Division Standing */}
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(251, 191, 36, 0.1)',
                                        borderRadius: '0.5rem',
                                        border: '2px solid rgba(251, 191, 36, 0.3)'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                            {division.toUpperCase()} DIVISION
                                        </div>
                                        <div style={{ fontSize: '2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                            {userDivisionRank}{userDivisionRank === 1 ? 'st' : userDivisionRank === 2 ? 'nd' : userDivisionRank === 3 ? 'rd' : 'th'}
                                        </div>
                                        <div style={{ color: '#93c5fd' }}>
                                            of {divisionStandings.length} teams
                                        </div>
                                    </div>
                                    
                                    {/* Team Overall */}
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(139, 92, 246, 0.1)',
                                        borderRadius: '0.5rem',
                                        border: '2px solid rgba(139, 92, 246, 0.3)'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                            TEAM OVERALL
                                        </div>
                                        <div style={{ 
                                            fontSize: '2rem', 
                                            fontWeight: 'bold', 
                                            marginBottom: '0.5rem',
                                            color: teamOverallData?.rank <= 5 ? '#4ade80' : 
                                                   teamOverallData?.rank <= 10 ? '#60a5fa' : 
                                                   teamOverallData?.rank <= 20 ? '#fbbf24' : '#f87171'
                                        }}>
                                            {teamOverallData?.overall || 0} OVR
                                        </div>
                                        <div style={{ color: '#93c5fd' }}>
                                            Rank: {teamOverallData?.rank || NUM_TEAMS} / {NUM_TEAMS}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* KEY PLAYERS */}
                            <div className="card" style={{ marginBottom: '1.5rem' }}>
                                <h2 style={{ color: '#22c55e', marginBottom: '1rem' }}>‚≠ê Top Performers</h2>
                                <div style={{ overflowX: 'auto' }}>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ borderBottom: '2px solid rgba(59, 130, 246, 0.3)' }}>
                                                <th style={{ padding: '0.75rem', textAlign: 'left', color: '#93c5fd' }}>Player</th>
                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>GP</th>
                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>G</th>
                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>A</th>
                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>PTS</th>
                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>+/-</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {topScorers.map((player, idx) => (
                                                <tr 
                                                    key={player.id}
                                                    style={{ 
                                                        borderBottom: '1px solid rgba(59, 130, 246, 0.2)',
                                                        background: idx === 0 ? 'rgba(251, 191, 36, 0.1)' : 'transparent'
                                                    }}
                                                >
                                                    <td style={{ padding: '0.75rem' }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                            {idx === 0 && <span style={{ fontSize: '1.25rem' }}>ü•á</span>}
                                                            {idx === 1 && <span style={{ fontSize: '1.25rem' }}>ü•à</span>}
                                                            {idx === 2 && <span style={{ fontSize: '1.25rem' }}>ü•â</span>}
                                                            <span 
                                                                style={{ 
                                                                    cursor: 'pointer', 
                                                                    textDecoration: 'underline',
                                                                    fontWeight: 'bold'
                                                                }}
                                                                onClick={() => navigateTo('playerProfile', player)}
                                                            >
                                                                {player.firstName} {player.lastName}
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'center' }}>{player.stats.gamesPlayed}</td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'center', fontWeight: 'bold' }}>{player.stats.goals}</td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'center', fontWeight: 'bold' }}>{player.stats.assists}</td>
                                                    <td style={{ padding: '0.75rem', textAlign: 'center', fontWeight: 'bold', color: '#22c55e' }}>{player.stats.points}</td>
                                                    <td style={{ 
                                                        padding: '0.75rem', 
                                                        textAlign: 'center',
                                                        color: player.stats.plusMinus > 0 ? '#22c55e' : player.stats.plusMinus < 0 ? '#ef4444' : 'white'
                                                    }}>
                                                        {player.stats.plusMinus > 0 ? '+' : ''}{player.stats.plusMinus}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            {/* RECENT & UPCOMING GAMES */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginBottom: '1.5rem' }}>
                                {/* Recent Games */}
                                <div className="card">
                                    <h2 style={{ color: '#60a5fa', marginBottom: '1rem' }}>üìã Recent Games</h2>
                                    {recentGames.length === 0 ? (
                                        <div style={{ color: '#93c5fd', textAlign: 'center', padding: '2rem' }}>
                                            No games played yet
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                            {recentGames.map((game, idx) => {
                                                const userIsHome = game.homeTeam === userTeamId;
                                                const opponent = TEAMS.find(t => t.id === (userIsHome ? game.awayTeam : game.homeTeam));
                                                if (!opponent) return null; // Safety check
                                                
                                                const userScore = userIsHome ? game.homeScore : game.awayScore;
                                                const oppScore = userIsHome ? game.awayScore : game.homeScore;
                                                const won = userScore > oppScore;
                                                
                                                return (
                                                    <div 
                                                        key={idx}
                                                        style={{
                                                            padding: '1rem',
                                                            background: won ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                                                            borderRadius: '0.5rem',
                                                            border: `2px solid ${won ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'}`,
                                                            cursor: 'pointer'
                                                        }}
                                                        onClick={() => {
                                                            setSelectedGame(game);
                                                            setCurrentView('gameDetail');
                                                        }}
                                                    >
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                            <div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                                    Day {game.day} ‚Ä¢ {userIsHome ? 'vs' : '@'} {opponent.city}
                                                                </div>
                                                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>
                                                                    {userScore} - {oppScore}
                                                                </div>
                                                            </div>
                                                            <div style={{ 
                                                                fontSize: '1.5rem',
                                                                fontWeight: 'bold',
                                                                color: won ? '#22c55e' : '#ef4444'
                                                            }}>
                                                                {won ? 'W' : 'L'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Upcoming Games */}
                                <div className="card">
                                    <h2 style={{ color: '#8b5cf6', marginBottom: '1rem' }}>üìÖ Upcoming Games</h2>
                                    {upcomingGames.length === 0 ? (
                                        <div style={{ color: '#93c5fd', textAlign: 'center', padding: '2rem' }}>
                                            No upcoming games
                                        </div>
                                    ) : (
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                            {upcomingGames.map((game, idx) => {
                                                const userIsHome = game.homeTeam === userTeamId;
                                                const opponent = TEAMS.find(t => t.id === (userIsHome ? game.awayTeam : game.homeTeam));
                                                if (!opponent) return null; // Safety check
                                                
                                                const oppStanding = gameState.standings.find(s => s.teamId === opponent.id);
                                                
                                                return (
                                                    <div 
                                                        key={idx}
                                                        style={{
                                                            padding: '1rem',
                                                            background: 'rgba(139, 92, 246, 0.1)',
                                                            borderRadius: '0.5rem',
                                                            border: '2px solid rgba(139, 92, 246, 0.3)'
                                                        }}
                                                    >
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                            <div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                                    Day {game.day} ‚Ä¢ {userIsHome ? 'HOME' : 'AWAY'}
                                                                </div>
                                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                                    {userIsHome ? 'vs' : '@'} {opponent.city} {opponent.name}
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                                                    {oppStanding ? `${oppStanding.wins}-${oppStanding.losses}-${oppStanding.otLosses} (${oppStanding.points} pts)` : 'Loading...'}
                                                                </div>
                                                            </div>
                                                            <div style={{ textAlign: 'right' }}>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>
                                                                    {idx === 0 ? 'NEXT' : `+${idx + 1}`}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* TEAM STATUS */}
                            <div className="card" style={{ marginBottom: '1.5rem' }}>
                                <h2 style={{ color: '#ef4444', marginBottom: '1rem' }}>‚ö†Ô∏è Team Status & Alerts</h2>
                                <div style={{ display: 'grid', gap: '1rem' }}>
                                    {/* Salary Cap */}
                                    <div style={{
                                        padding: '1rem',
                                        background: capStatus.overCap ? 'rgba(239, 68, 68, 0.2)' : 
                                                   capStatus.capSpace < 1000000 ? 'rgba(245, 158, 11, 0.2)' : 
                                                   'rgba(34, 197, 94, 0.2)',
                                        border: `2px solid ${capStatus.overCap ? '#ef4444' : 
                                                             capStatus.capSpace < 1000000 ? '#f59e0b' : '#22c55e'}`,
                                        borderRadius: '0.5rem'
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                    üí∞ Salary Cap Status
                                                </div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                    {formatSalary(capStatus.capSpace)} Available
                                                </div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                                    Using {formatSalary(capStatus.totalCapHit)} of {formatSalary(SALARY_CAP.ceiling)}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                fontSize: '1.5rem',
                                                fontWeight: 'bold',
                                                color: capStatus.overCap ? '#ef4444' : 
                                                       capStatus.capSpace < 1000000 ? '#f59e0b' : '#22c55e'
                                            }}>
                                                {capStatus.overCap ? '‚ùå OVER' : 
                                                 capStatus.capSpace < 1000000 ? '‚ö†Ô∏è TIGHT' : '‚úÖ GOOD'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Injuries */}
                                    <div style={{
                                        padding: '1rem',
                                        background: injuredPlayers.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)',
                                        border: `2px solid ${injuredPlayers.length > 0 ? '#ef4444' : '#22c55e'}`,
                                        borderRadius: '0.5rem'
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                            <div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                    üè• Injury Report
                                                </div>
                                                {injuredPlayers.length === 0 ? (
                                                    <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#22c55e' }}>
                                                        Clean Bill of Health
                                                    </div>
                                                ) : (
                                                    <>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                            {injuredPlayers.length} Player{injuredPlayers.length > 1 ? 's' : ''} Injured
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.5rem' }}>
                                                            {injuredPlayers.map(p => `${p.firstName.charAt(0)}. ${p.lastName}`).join(', ')}
                                                        </div>
                                                    </>
                                                )}
                                            </div>
                                            <button
                                                onClick={() => setCurrentView('injuries')}
                                                style={{
                                                    padding: '0.5rem 1rem',
                                                    background: '#3b82f6',
                                                    border: 'none',
                                                    borderRadius: '0.375rem',
                                                    color: 'white',
                                                    fontWeight: 'bold',
                                                    cursor: 'pointer'
                                                }}
                                            >
                                                View Details
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {/* Expiring Contracts Alert */}
                                    {(() => {
                                        const expiringPlayers = userRoster.filter(p => 
                                            p.contract && p.contract.yearsRemaining <= 1 && p.contract.yearsRemaining > 0
                                        );
                                        const expiredPlayers = userRoster.filter(p => 
                                            p.contract && p.contract.yearsRemaining === 0
                                        );
                                        
                                        if (expiringPlayers.length === 0 && expiredPlayers.length === 0) return null;
                                        
                                        return (
                                            <div style={{
                                                padding: '1rem',
                                                background: expiredPlayers.length > 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)',
                                                border: `2px solid ${expiredPlayers.length > 0 ? '#ef4444' : '#f59e0b'}`,
                                                borderRadius: '0.5rem'
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                    <div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                            üìù Contract Status
                                                        </div>
                                                        {expiredPlayers.length > 0 ? (
                                                            <>
                                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#ef4444' }}>
                                                                    {expiredPlayers.length} UFA{expiredPlayers.length > 1 ? 's' : ''} - Sign Now!
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.5rem' }}>
                                                                    {expiredPlayers.slice(0, 3).map(p => `${p.firstName.charAt(0)}. ${p.lastName} (${p.ratings.overall} OVR)`).join(', ')}
                                                                    {expiredPlayers.length > 3 && ` +${expiredPlayers.length - 3} more`}
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                                    {expiringPlayers.length} Expiring This Season
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.5rem' }}>
                                                                    {expiringPlayers.slice(0, 3).map(p => `${p.firstName.charAt(0)}. ${p.lastName} (${p.ratings.overall} OVR)`).join(', ')}
                                                                    {expiringPlayers.length > 3 && ` +${expiringPlayers.length - 3} more`}
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => setCurrentView('roster')}
                                                        style={{
                                                            padding: '0.5rem 1rem',
                                                            background: expiredPlayers.length > 0 ? '#ef4444' : '#f59e0b',
                                                            border: 'none',
                                                            borderRadius: '0.375rem',
                                                            color: 'white',
                                                            fontWeight: 'bold',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        View Roster
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                    
                                    {/* Trade Deadline Alert */}
                                    {(() => {
                                        const TRADE_DEADLINE = 56;
                                        const daysUntilDeadline = TRADE_DEADLINE - gameState.currentDay;
                                        
                                        // Show alert from Day 45 onwards (11+ days before deadline)
                                        if (gameState.currentDay < 45 || gameState.currentDay > TRADE_DEADLINE) return null;
                                        
                                        const isUrgent = daysUntilDeadline <= 3;
                                        const isVeryUrgent = daysUntilDeadline <= 1;
                                        
                                        return (
                                            <div style={{
                                                padding: '1rem',
                                                background: isVeryUrgent ? 'rgba(239, 68, 68, 0.3)' : 
                                                           isUrgent ? 'rgba(245, 158, 11, 0.3)' : 'rgba(245, 158, 11, 0.2)',
                                                border: `2px solid ${isVeryUrgent ? '#ef4444' : '#f59e0b'}`,
                                                borderRadius: '0.5rem',
                                                animation: isVeryUrgent ? 'pulse 2s infinite' : 'none'
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                    <div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                            {isVeryUrgent ? 'üö® TRADE DEADLINE IMMINENT!' : '‚è∞ Trade Deadline'}
                                                        </div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                            {daysUntilDeadline === 0 ? 'DEADLINE TODAY!' : 
                                                             daysUntilDeadline === 1 ? 'TOMORROW!' :
                                                             `${daysUntilDeadline} Days Remaining`}
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                                            Deadline: Day {TRADE_DEADLINE}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => setCurrentView('trade')}
                                                        style={{
                                                            padding: '0.5rem 1rem',
                                                            background: isVeryUrgent ? '#ef4444' : '#f59e0b',
                                                            border: 'none',
                                                            borderRadius: '0.375rem',
                                                            color: 'white',
                                                            fontWeight: 'bold',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        Make Trades
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                            
                            {/* COLLAPSIBLE FULL ROSTER & STANDINGS */}
                            <div className="card">
                                <h2 style={{ marginBottom: '1rem' }}>üìä Detailed Information</h2>
                                
                                {/* Full Roster */}
                                <div style={{ marginBottom: '1rem' }}>
                                    <button
                                        onClick={() => toggleSection('roster')}
                                        style={{
                                            width: '100%',
                                            padding: '1rem',
                                            background: 'rgba(30, 58, 138, 0.4)',
                                            border: '2px solid rgba(59, 130, 246, 0.4)',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontSize: '1.1rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        <span>üë• Full Team Roster ({userRoster.length} NHL + {farmRoster.length} Farm)</span>
                                        <span>{expandedSections.roster ? '‚ñº' : '‚ñ∂'}</span>
                                    </button>
                                    
                                    {expandedSections.roster && (
                                        <div style={{
                                            marginTop: '1rem',
                                            padding: '1.5rem',
                                            background: 'rgba(0, 0, 0, 0.2)',
                                            borderRadius: '0.5rem',
                                            border: '1px solid rgba(59, 130, 246, 0.3)'
                                        }}>
                                            {/* NHL ROSTER */}
                                            <div style={{ marginBottom: '2rem' }}>
                                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>
                                                    üèí NHL Roster ({userRoster.length} players)
                                                </h3>
                                                
                                                <div style={{ overflowX: 'auto' }}>
                                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                                        <thead>
                                                            <tr style={{ borderBottom: '2px solid rgba(59, 130, 246, 0.3)' }}>
                                                                <th style={{ padding: '0.75rem', textAlign: 'left', color: '#93c5fd' }}>Player</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Pos</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Age</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>OVR</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'right', color: '#93c5fd' }}>Contract</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'right', color: '#93c5fd' }}>Cap Hit</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {userRoster
                                                                .sort((a, b) => {
                                                                    const posOrder = { 'C': 1, 'LW': 2, 'RW': 3, 'D': 4, 'G': 5 };
                                                                    if (posOrder[a.position] !== posOrder[b.position]) {
                                                                        return posOrder[a.position] - posOrder[b.position];
                                                                    }
                                                                    return b.ratings.overall - a.ratings.overall;
                                                                })
                                                                .map(player => (
                                                                    <tr 
                                                                        key={player.id}
                                                                        style={{ 
                                                                            borderBottom: '1px solid rgba(59, 130, 246, 0.2)',
                                                                            transition: 'background 0.2s'
                                                                        }}
                                                                        onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(59, 130, 246, 0.1)'}
                                                                        onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                                    >
                                                                        <td style={{ padding: '0.75rem' }}>
                                                                            <span 
                                                                                style={{ 
                                                                                    cursor: 'pointer', 
                                                                                    textDecoration: 'underline',
                                                                                    fontWeight: 'bold'
                                                                                }}
                                                                                onClick={() => navigateTo('playerProfile', player)}
                                                                            >
                                                                                {player.firstName} {player.lastName}
                                                                            </span>
                                                                        </td>
                                                                        <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                            {player.position}
                                                                        </td>
                                                                        <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                            {player.age}
                                                                        </td>
                                                                        <td style={{ 
                                                                            padding: '0.75rem', 
                                                                            textAlign: 'center',
                                                                            fontWeight: 'bold',
                                                                            color: player.ratings.overall >= 85 ? '#22c55e' :
                                                                                   player.ratings.overall >= 80 ? '#60a5fa' :
                                                                                   player.ratings.overall >= 75 ? '#fbbf24' : 'white'
                                                                        }}>
                                                                            {player.ratings.overall}
                                                                        </td>
                                                                        <td style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem' }}>
                                                                            {player.contract?.yearsRemaining}yr @ {formatSalary(player.contract?.salary)}
                                                                        </td>
                                                                        <td style={{ padding: '0.75rem', textAlign: 'right', fontWeight: 'bold' }}>
                                                                            {formatSalary(player.contract?.capHit)}
                                                                        </td>
                                                                    </tr>
                                                                ))
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            
                                            {/* FARM TEAM ROSTER */}
                                            {farmTeam && farmRoster.length > 0 && (
                                                <div>
                                                    <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>
                                                        üîß {farmTeam.city} {farmTeam.name} ({farmRoster.length} players)
                                                    </h3>
                                                    
                                                    <div style={{ overflowX: 'auto' }}>
                                                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                                            <thead>
                                                                <tr style={{ borderBottom: '2px solid rgba(59, 130, 246, 0.3)' }}>
                                                                    <th style={{ padding: '0.75rem', textAlign: 'left', color: '#93c5fd' }}>Player</th>
                                                                    <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Pos</th>
                                                                    <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Age</th>
                                                                    <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>OVR</th>
                                                                    <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>POT</th>
                                                                    <th style={{ padding: '0.75rem', textAlign: 'right', color: '#93c5fd' }}>Contract</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {farmRoster
                                                                    .sort((a, b) => {
                                                                        const posOrder = { 'C': 1, 'LW': 2, 'RW': 3, 'D': 4, 'G': 5 };
                                                                        if (posOrder[a.position] !== posOrder[b.position]) {
                                                                            return posOrder[a.position] - posOrder[b.position];
                                                                        }
                                                                        return b.ratings.overall - a.ratings.overall;
                                                                    })
                                                                    .map(player => (
                                                                        <tr 
                                                                            key={player.id}
                                                                            style={{ 
                                                                                borderBottom: '1px solid rgba(59, 130, 246, 0.2)',
                                                                                transition: 'background 0.2s'
                                                                            }}
                                                                            onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(59, 130, 246, 0.1)'}
                                                                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                                        >
                                                                            <td style={{ padding: '0.75rem' }}>
                                                                                <span 
                                                                                    style={{ 
                                                                                        cursor: 'pointer', 
                                                                                        textDecoration: 'underline',
                                                                                        fontWeight: 'bold'
                                                                                    }}
                                                                                    onClick={() => navigateTo('playerProfile', player)}
                                                                                >
                                                                                    {player.firstName} {player.lastName}
                                                                                </span>
                                                                            </td>
                                                                            <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                                {player.position}
                                                                            </td>
                                                                            <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                                {player.age}
                                                                            </td>
                                                                            <td style={{ 
                                                                                padding: '0.75rem', 
                                                                                textAlign: 'center',
                                                                                fontWeight: 'bold',
                                                                                color: player.ratings.overall >= 75 ? '#60a5fa' :
                                                                                       player.ratings.overall >= 70 ? '#fbbf24' : 'white'
                                                                            }}>
                                                                                {player.ratings.overall}
                                                                            </td>
                                                                            <td style={{ 
                                                                                padding: '0.75rem', 
                                                                                textAlign: 'center',
                                                                                color: player.ratings.potential >= 80 ? '#22c55e' :
                                                                                       player.ratings.potential >= 75 ? '#60a5fa' : '#93c5fd'
                                                                            }}>
                                                                                {player.ratings.potential}
                                                                            </td>
                                                                            <td style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem' }}>
                                                                                {player.contract?.yearsRemaining}yr @ {formatSalary(player.contract?.salary)}
                                                                            </td>
                                                                        </tr>
                                                                    ))
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Full Standings */}
                                <div style={{ marginBottom: '1rem' }}>
                                    <button
                                        onClick={() => toggleSection('standings')}
                                        style={{
                                            width: '100%',
                                            padding: '1rem',
                                            background: 'rgba(30, 58, 138, 0.4)',
                                            border: '2px solid rgba(59, 130, 246, 0.4)',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontSize: '1.1rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            transition: 'all 0.2s'
                                        }}
                                    >
                                        <span>üìä League Standings</span>
                                        <span>{expandedSections.standings ? '‚ñº' : '‚ñ∂'}</span>
                                    </button>
                                    
                                    {expandedSections.standings && (
                                        <div style={{
                                            marginTop: '1rem',
                                            padding: '1.5rem',
                                            background: 'rgba(0, 0, 0, 0.2)',
                                            borderRadius: '0.5rem',
                                            border: '1px solid rgba(59, 130, 246, 0.3)'
                                        }}>
                                            <p style={{ color: '#93c5fd', textAlign: 'center' }}>
                                                Click "Dashboard" in the main menu to view full league standings
                                            </p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    );
                })()}

                {currentView === 'roster' && gameState && (() => {
                    const userTeam = TEAMS.find(t => t.id === userTeamId);
                    const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === userTeamId);
                    const userRoster = gameState.players.filter(p => p.teamId === userTeamId && p.roster === 'nhl');
                    const farmRoster = gameState.players.filter(p => p.farmTeamId === farmTeam?.id);
                    const teamStandings = gameState.standings.find(s => s.teamId === userTeamId);
                    const capStatus = calculateTeamCapHit(userTeamId, gameState.players);
                    const teamOverallData = getTeamOverall(userTeamId);
                    
                    // Get team's division and conference from team data
                    const division = userTeam?.division || 'Unknown';
                    const conference = userTeam?.conference || 'Unknown';
                    
                    // Toggle function for collapsible sections (state is at component level)
                    const toggleSection = (section) => {
                        setExpandedSections(prev => ({
                            ...prev,
                            [section]: !prev[section]
                        }));
                    };
                    
                    return (
                        <div className="card">
                            <h2 style={{ marginBottom: '2rem', textAlign: 'center', fontSize: '2rem' }}>
                                üèí {userTeam.city} {userTeam.name} - Team Central
                            </h2>
                            
                            {/* TEAM PROFILE SECTION */}
                            <div style={{ marginBottom: '1rem' }}>
                                <button
                                    onClick={() => toggleSection('profile')}
                                    style={{
                                        width: '100%',
                                        padding: '1rem',
                                        background: 'rgba(30, 58, 138, 0.4)',
                                        border: '2px solid rgba(59, 130, 246, 0.4)',
                                        borderRadius: '0.5rem',
                                        color: 'white',
                                        fontSize: '1.25rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <span>üìã Team Profile</span>
                                    <span>{expandedSections.profile ? '‚ñº' : '‚ñ∂'}</span>
                                </button>
                                
                                {expandedSections.profile && (
                                    <div style={{
                                        marginTop: '1rem',
                                        padding: '1.5rem',
                                        background: 'rgba(0, 0, 0, 0.2)',
                                        borderRadius: '0.5rem',
                                        border: '1px solid rgba(59, 130, 246, 0.3)'
                                    }}>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>
                                            {/* Left Column */}
                                            <div>
                                                <div style={{ marginBottom: '1.5rem' }}>
                                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Team Information</h3>
                                                    <div style={{ fontSize: '3rem', marginBottom: '0.5rem' }}>üèí</div>
                                                    <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                        {userTeam.city} {userTeam.name}
                                                    </div>
                                                    <div style={{ color: '#93c5fd' }}>{userTeam.abbreviation}</div>
                                                </div>
                                                
                                                <div style={{ marginBottom: '1.5rem' }}>
                                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Arena & Location</h3>
                                                    <div style={{ color: '#93c5fd' }}>
                                                        üìç {userTeam.city}
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Season Status</h3>
                                                    <div style={{ color: '#93c5fd' }}>
                                                        {gameState.phase === 'regularseason' ? 'üèí Regular Season' :
                                                         gameState.phase === 'playoffs' ? 'üèÜ Playoffs' :
                                                         gameState.phase === 'offseason' ? '‚òÄÔ∏è Offseason' :
                                                         'üèÅ Season Complete'}
                                                    </div>
                                                    <div style={{ color: '#93c5fd', marginTop: '0.25rem' }}>
                                                        Season {gameState.season}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Right Column */}
                                            <div>
                                                <div style={{ marginBottom: '1.5rem' }}>
                                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Team Overall</h3>
                                                    <div style={{ 
                                                        fontSize: '3rem', 
                                                        fontWeight: 'bold',
                                                        color: teamOverallData?.rank <= 5 ? '#4ade80' : 
                                                               teamOverallData?.rank <= 10 ? '#60a5fa' : 
                                                               teamOverallData?.rank <= 20 ? '#fbbf24' : '#f87171'
                                                    }}>
                                                        {teamOverallData?.overall || 0} OVR
                                                    </div>
                                                    <div style={{ color: '#93c5fd' }}>
                                                        League Rank: {teamOverallData?.rank || NUM_TEAMS} / {NUM_TEAMS}
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>üí∞ Salary Cap</h3>
                                                    <div style={{ marginBottom: '0.5rem' }}>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem', marginBottom: '0.25rem' }}>
                                                            Cap Hit
                                                        </div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                            {formatSalary(capStatus.totalCapHit)}
                                                        </div>
                                                    </div>
                                                    <div style={{ marginBottom: '0.5rem' }}>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem', marginBottom: '0.25rem' }}>
                                                            Cap Space
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '1.25rem', 
                                                            fontWeight: 'bold',
                                                            color: capStatus.overCap ? '#ef4444' : '#22c55e'
                                                        }}>
                                                            {formatSalary(capStatus.capSpace)}
                                                        </div>
                                                    </div>
                                                    <div style={{
                                                        padding: '0.5rem',
                                                        background: capStatus.overCap ? 'rgba(239, 68, 68, 0.2)' : 
                                                                   capStatus.underFloor ? 'rgba(245, 158, 11, 0.2)' : 
                                                                   'rgba(34, 197, 94, 0.2)',
                                                        border: `1px solid ${capStatus.overCap ? '#ef4444' : 
                                                                             capStatus.underFloor ? '#f59e0b' : '#22c55e'}`,
                                                        borderRadius: '0.375rem',
                                                        textAlign: 'center',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {capStatus.overCap ? '‚ùå OVER CAP' : 
                                                         capStatus.underFloor ? '‚ö†Ô∏è UNDER FLOOR' :
                                                         '‚úì Cap Compliant'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* TEAM STANDINGS SECTION */}
                            <div style={{ marginBottom: '1rem' }}>
                                <button
                                    onClick={() => toggleSection('standings')}
                                    style={{
                                        width: '100%',
                                        padding: '1rem',
                                        background: 'rgba(30, 58, 138, 0.4)',
                                        border: '2px solid rgba(59, 130, 246, 0.4)',
                                        borderRadius: '0.5rem',
                                        color: 'white',
                                        fontSize: '1.25rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <span>üìä Team Standings</span>
                                    <span>{expandedSections.standings ? '‚ñº' : '‚ñ∂'}</span>
                                </button>
                                
                                {expandedSections.standings && (
                                    <div style={{
                                        marginTop: '1rem',
                                        padding: '1.5rem',
                                        background: 'rgba(0, 0, 0, 0.2)',
                                        borderRadius: '0.5rem',
                                        border: '1px solid rgba(59, 130, 246, 0.3)'
                                    }}>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>
                                            <div>
                                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>Season Summary</h3>
                                                <div style={{ display: 'grid', gap: '0.75rem' }}>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>Conference</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>{conference}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>Division</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>{division}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>Record</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                            {teamStandings.wins}-{teamStandings.losses}-{teamStandings.otl} ({teamStandings.points} pts)
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>Games Played</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                            {teamStandings?.teamStats?.gamesPlayed || 0}/82
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div>
                                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>Record Breakdown</h3>
                                                <div style={{ display: 'grid', gap: '0.75rem' }}>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>Home Record</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                            {teamStandings?.home?.wins || 0}-{teamStandings?.home?.losses || 0}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>Away Record</div>
                                                        <div style={{ fontSize: '1.25rem', fontWeight: 'bold' }}>
                                                            {teamStandings?.away?.wins || 0}-{teamStandings?.away?.losses || 0}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>Goal Differential</div>
                                                        <div style={{ 
                                                            fontSize: '1.25rem', 
                                                            fontWeight: 'bold',
                                                            color: (teamStandings.goalsFor - teamStandings.goalsAgainst) > 0 ? '#22c55e' : 
                                                                   (teamStandings.goalsFor - teamStandings.goalsAgainst) < 0 ? '#ef4444' : 'white'
                                                        }}>
                                                            {teamStandings.goalsFor - teamStandings.goalsAgainst > 0 ? '+' : ''}
                                                            {teamStandings.goalsFor - teamStandings.goalsAgainst} 
                                                            ({teamStandings.goalsFor} GF, {teamStandings.goalsAgainst} GA)
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* PLAYER STATS SECTION */}
                            <div style={{ marginBottom: '1rem' }}>
                                <button
                                    onClick={() => toggleSection('stats')}
                                    style={{
                                        width: '100%',
                                        padding: '1rem',
                                        background: 'rgba(30, 58, 138, 0.4)',
                                        border: '2px solid rgba(59, 130, 246, 0.4)',
                                        borderRadius: '0.5rem',
                                        color: 'white',
                                        fontSize: '1.25rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <span>üìà Player Stats</span>
                                    <span>{expandedSections.stats ? '‚ñº' : '‚ñ∂'}</span>
                                </button>
                                
                                {expandedSections.stats && (
                                    <div style={{
                                        marginTop: '1rem',
                                        padding: '1.5rem',
                                        background: 'rgba(0, 0, 0, 0.2)',
                                        borderRadius: '0.5rem',
                                        border: '1px solid rgba(59, 130, 246, 0.3)'
                                    }}>
                                        {/* Keep existing stats display - will insert the stats view content here */}
                                        <p style={{ color: '#93c5fd', textAlign: 'center' }}>
                                            Click "Stats" in the Stats & Records menu to view detailed player statistics
                                        </p>
                                    </div>
                                )}
                            </div>
                            
                            {/* TEAM ROSTER SECTION */}
                            <div style={{ marginBottom: '1rem' }}>
                                <button
                                    onClick={() => toggleSection('roster')}
                                    style={{
                                        width: '100%',
                                        padding: '1rem',
                                        background: 'rgba(30, 58, 138, 0.4)',
                                        border: '2px solid rgba(59, 130, 246, 0.4)',
                                        borderRadius: '0.5rem',
                                        color: 'white',
                                        fontSize: '1.25rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <span>üë• Team Rosters</span>
                                    <span>{expandedSections.roster ? '‚ñº' : '‚ñ∂'}</span>
                                </button>
                                
                                {expandedSections.roster && (
                                    <div style={{
                                        marginTop: '1rem',
                                        padding: '1.5rem',
                                        background: 'rgba(0, 0, 0, 0.2)',
                                        borderRadius: '0.5rem',
                                        border: '1px solid rgba(59, 130, 246, 0.3)'
                                    }}>
                                        {/* NHL ROSTER */}
                                        <div style={{ marginBottom: '2rem' }}>
                                            <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>
                                                üèí NHL Roster ({userRoster.length} players)
                                            </h3>
                                            
                                            <div style={{ overflowX: 'auto' }}>
                                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                                    <thead>
                                                        <tr style={{ borderBottom: '2px solid rgba(59, 130, 246, 0.3)' }}>
                                                            <th style={{ padding: '0.75rem', textAlign: 'left', color: '#93c5fd' }}>Player</th>
                                                            <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Pos</th>
                                                            <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Age</th>
                                                            <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>OVR</th>
                                                            <th style={{ padding: '0.75rem', textAlign: 'right', color: '#93c5fd' }}>Contract</th>
                                                            <th style={{ padding: '0.75rem', textAlign: 'right', color: '#93c5fd' }}>Cap Hit</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {userRoster
                                                            .sort((a, b) => {
                                                                const posOrder = { 'C': 1, 'LW': 2, 'RW': 3, 'D': 4, 'G': 5 };
                                                                if (posOrder[a.position] !== posOrder[b.position]) {
                                                                    return posOrder[a.position] - posOrder[b.position];
                                                                }
                                                                return b.ratings.overall - a.ratings.overall;
                                                            })
                                                            .map(player => (
                                                                <tr 
                                                                    key={player.id}
                                                                    style={{ 
                                                                        borderBottom: '1px solid rgba(59, 130, 246, 0.2)',
                                                                        transition: 'background 0.2s'
                                                                    }}
                                                                    onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(59, 130, 246, 0.1)'}
                                                                    onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                                >
                                                                    <td style={{ padding: '0.75rem' }}>
                                                                        <span 
                                                                            style={{ 
                                                                                cursor: 'pointer', 
                                                                                textDecoration: 'underline',
                                                                                fontWeight: 'bold'
                                                                            }}
                                                                            onClick={() => navigateTo('playerProfile', player)}
                                                                        >
                                                                            {player.firstName} {player.lastName}
                                                                        </span>
                                                                    </td>
                                                                    <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                        {player.position}
                                                                    </td>
                                                                    <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                        {player.age}
                                                                    </td>
                                                                    <td style={{ 
                                                                        padding: '0.75rem', 
                                                                        textAlign: 'center',
                                                                        fontWeight: 'bold',
                                                                        color: player.ratings.overall >= 85 ? '#22c55e' :
                                                                               player.ratings.overall >= 80 ? '#60a5fa' :
                                                                               player.ratings.overall >= 75 ? '#fbbf24' : 'white'
                                                                    }}>
                                                                        {player.ratings.overall}
                                                                    </td>
                                                                    <td style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem' }}>
                                                                        {player.contract?.yearsRemaining}yr @ {formatSalary(player.contract?.salary)}
                                                                    </td>
                                                                    <td style={{ padding: '0.75rem', textAlign: 'right', fontWeight: 'bold' }}>
                                                                        {formatSalary(player.contract?.capHit)}
                                                                    </td>
                                                                </tr>
                                                            ))
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        
                                        {/* FARM TEAM ROSTER */}
                                        {farmTeam && farmRoster.length > 0 && (
                                            <div>
                                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>
                                                    üîß {farmTeam.city} {farmTeam.name} ({farmRoster.length} players)
                                                </h3>
                                                
                                                <div style={{ overflowX: 'auto' }}>
                                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                                        <thead>
                                                            <tr style={{ borderBottom: '2px solid rgba(59, 130, 246, 0.3)' }}>
                                                                <th style={{ padding: '0.75rem', textAlign: 'left', color: '#93c5fd' }}>Player</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Pos</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>Age</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>OVR</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'center', color: '#93c5fd' }}>POT</th>
                                                                <th style={{ padding: '0.75rem', textAlign: 'right', color: '#93c5fd' }}>Contract</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {farmRoster
                                                                .sort((a, b) => {
                                                                    const posOrder = { 'C': 1, 'LW': 2, 'RW': 3, 'D': 4, 'G': 5 };
                                                                    if (posOrder[a.position] !== posOrder[b.position]) {
                                                                        return posOrder[a.position] - posOrder[b.position];
                                                                    }
                                                                    return b.ratings.overall - a.ratings.overall;
                                                                })
                                                                .map(player => (
                                                                    <tr 
                                                                        key={player.id}
                                                                        style={{ 
                                                                            borderBottom: '1px solid rgba(59, 130, 246, 0.2)',
                                                                            transition: 'background 0.2s'
                                                                        }}
                                                                        onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(59, 130, 246, 0.1)'}
                                                                        onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                                    >
                                                                        <td style={{ padding: '0.75rem' }}>
                                                                            <span 
                                                                                style={{ 
                                                                                    cursor: 'pointer', 
                                                                                    textDecoration: 'underline',
                                                                                    fontWeight: 'bold'
                                                                                }}
                                                                                onClick={() => navigateTo('playerProfile', player)}
                                                                            >
                                                                                {player.firstName} {player.lastName}
                                                                            </span>
                                                                        </td>
                                                                        <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                            {player.position}
                                                                        </td>
                                                                        <td style={{ padding: '0.75rem', textAlign: 'center' }}>
                                                                            {player.age}
                                                                        </td>
                                                                        <td style={{ 
                                                                            padding: '0.75rem', 
                                                                            textAlign: 'center',
                                                                            fontWeight: 'bold',
                                                                            color: player.ratings.overall >= 75 ? '#60a5fa' :
                                                                                   player.ratings.overall >= 70 ? '#fbbf24' : 'white'
                                                                        }}>
                                                                            {player.ratings.overall}
                                                                        </td>
                                                                        <td style={{ 
                                                                            padding: '0.75rem', 
                                                                            textAlign: 'center',
                                                                            color: player.ratings.potential >= 80 ? '#22c55e' :
                                                                                   player.ratings.potential >= 75 ? '#60a5fa' : '#93c5fd'
                                                                        }}>
                                                                            {player.ratings.potential}
                                                                        </td>
                                                                        <td style={{ padding: '0.75rem', textAlign: 'right', fontSize: '0.875rem' }}>
                                                                            {player.contract?.yearsRemaining}yr @ {formatSalary(player.contract?.salary)}
                                                                        </td>
                                                                    </tr>
                                                                ))
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                })()}

                {currentView === 'roster' && gameState && (() => {
                    const teamOverallData = getTeamOverall(userTeamId);
                    const ovr = teamOverallData?.overall || 0;
                    const rank = teamOverallData?.rank || NUM_TEAMS;
                    
                    // Color based on league rank
                    let ovrColor = '#fff';
                    if (rank <= 5) ovrColor = '#4ade80';      // Top 5: Green
                    else if (rank <= 10) ovrColor = '#60a5fa'; // Top 10: Blue
                    else if (rank <= 20) ovrColor = '#fbbf24'; // Middle: Yellow
                    else ovrColor = '#f87171';                 // Bottom: Red
                    
                    return (
                    <>
                    {/* NEW: Player Development Tracker */}
                    {gameState.playerDevelopment && Object.keys(gameState.playerDevelopment).length > 0 && (
                        <div className="card" style={{ marginBottom: '2rem' }}>
                            <h2 style={{ color: '#22c55e', marginBottom: '1rem' }}>üåü Player Development Tracker</h2>
                            <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                Tracking young players (age ‚â§ 25) throughout the season
                            </p>
                            
                            {(() => {
                                // Get developing players with changes
                                const developingPlayers = Object.entries(gameState.playerDevelopment)
                                    .map(([playerId, dev]) => {
                                        const player = gameState.players.find(p => p.id === parseInt(playerId));
                                        return player ? { player, dev } : null;
                                    })
                                    .filter(item => item !== null && item.player.teamId === userTeamId)
                                    .sort((a, b) => Math.abs(b.dev.growth) - Math.abs(a.dev.growth));
                                
                                if (developingPlayers.length === 0) {
                                    return (
                                        <div style={{ color: '#93c5fd', fontStyle: 'italic' }}>
                                            No young players (age ‚â§ 25) on your roster
                                        </div>
                                    );
                                }
                                
                                return (
                                    <div style={{ display: 'grid', gap: '0.75rem' }}>
                                        {developingPlayers.map(({ player, dev }) => {
                                            const growthText = dev.growth > 0 ? `+${dev.growth}` : dev.growth < 0 ? `${dev.growth}` : '¬±0';
                                            const growthColor = dev.growth > 0 ? '#22c55e' : dev.growth < 0 ? '#ef4444' : '#94a3b8';
                                            
                                            let statusText = '';
                                            let statusColor = '#93c5fd';
                                            if (dev.growth >= 3) {
                                                statusText = 'Exceeding Expectations!';
                                                statusColor = '#22c55e';
                                            } else if (dev.growth >= 1) {
                                                statusText = 'Developing Well';
                                                statusColor = '#22c55e';
                                            } else if (dev.growth === 0) {
                                                statusText = 'Maintaining Level';
                                                statusColor = '#93c5fd';
                                            } else if (dev.growth >= -1) {
                                                statusText = 'Slight Regression';
                                                statusColor = '#f59e0b';
                                            } else {
                                                statusText = 'Regressing';
                                                statusColor = '#ef4444';
                                            }
                                            
                                            return (
                                                <div 
                                                    key={player.id}
                                                    style={{
                                                        padding: '1rem',
                                                        background: 'rgba(0, 0, 0, 0.3)',
                                                        borderRadius: '0.5rem',
                                                        borderLeft: `4px solid ${growthColor}`,
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center'
                                                    }}
                                                >
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ 
                                                            fontWeight: 'bold', 
                                                            fontSize: '1.1rem',
                                                            marginBottom: '0.25rem',
                                                            cursor: 'pointer',
                                                            textDecoration: 'underline'
                                                        }}
                                                        onClick={() => navigateTo('playerProfile', player)}
                                                        >
                                                            {player.firstName} {player.lastName}
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd' }}>
                                                            {player.position} ‚Ä¢ Age {player.age} ‚Ä¢ {dev.games} games played
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{ textAlign: 'center', marginRight: '1.5rem' }}>
                                                        <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                            OVR Progress
                                                        </div>
                                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>
                                                            {dev.startOVR} ‚Üí {dev.currentOVR}
                                                        </div>
                                                        <div style={{ 
                                                            fontSize: '1rem', 
                                                            fontWeight: 'bold',
                                                            color: growthColor,
                                                            marginTop: '0.25rem'
                                                        }}>
                                                            {growthText} OVR
                                                        </div>
                                                    </div>
                                                    
                                                    <div style={{ 
                                                        padding: '0.5rem 1rem',
                                                        background: `${statusColor}20`,
                                                        borderRadius: '0.375rem',
                                                        border: `1px solid ${statusColor}`,
                                                        minWidth: '150px',
                                                        textAlign: 'center'
                                                    }}>
                                                        <div style={{ 
                                                            fontSize: '0.875rem',
                                                            fontWeight: 'bold',
                                                            color: statusColor
                                                        }}>
                                                            {statusText}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                );
                            })()}
                        </div>
                    )}
                    
                    <div className="card">
                        {/* Team Overall & Salary Cap Header */}
                        <div style={{ 
                            display: 'flex', 
                            justifyContent: 'space-between', 
                            alignItems: 'center',
                            marginBottom: '1rem',
                            padding: '1.5rem',
                            background: 'rgba(30, 58, 138, 0.3)',
                            borderRadius: '0.5rem',
                            border: '2px solid rgba(59, 130, 246, 0.3)'
                        }}>
                            <h2 style={{ margin: 0 }}>Your Roster ({userRoster.length} players)</h2>
                            <div style={{ textAlign: 'right' }}>
                                <div style={{ 
                                    fontSize: '2.5rem', 
                                    fontWeight: 'bold',
                                    color: ovrColor,
                                    lineHeight: 1
                                }}>
                                    {ovr} OVR
                                </div>
                                <div style={{ 
                                    fontSize: '1rem',
                                    color: '#93c5fd',
                                    marginTop: '0.25rem'
                                }}>
                                    Rank: {rank} / {NUM_TEAMS}
                                </div>
                            </div>
                        </div>
                        
                        {/* Salary Cap Status */}
                        {(() => {
                            const capStatus = calculateTeamCapHit(userTeamId, gameState.players);
                            const capPercent = (capStatus.totalCapHit / SALARY_CAP.ceiling) * 100;
                            
                            let capColor = '#22c55e'; // Green - good
                            if (capStatus.overCap) capColor = '#ef4444'; // Red - over cap
                            else if (capPercent > 95) capColor = '#f59e0b'; // Orange - tight
                            else if (capStatus.underFloor) capColor = '#f59e0b'; // Orange - under floor
                            
                            return (
                                <div style={{
                                    padding: '1.5rem',
                                    background: 'rgba(0, 0, 0, 0.3)',
                                    borderRadius: '0.5rem',
                                    border: `2px solid ${capColor}40`,
                                    marginBottom: '2rem'
                                }}>
                                    <div style={{ 
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        marginBottom: '1rem'
                                    }}>
                                        <h3 style={{ margin: 0, color: '#60a5fa' }}>üí∞ Salary Cap Status</h3>
                                        <div style={{ 
                                            fontSize: '1.5rem',
                                            fontWeight: 'bold',
                                            color: capColor
                                        }}>
                                            {capStatus.overCap ? '‚ùå OVER CAP' : 
                                             capStatus.underFloor ? '‚ö†Ô∏è UNDER FLOOR' :
                                             '‚úì Compliant'}
                                        </div>
                                    </div>
                                    
                                    <div style={{ marginBottom: '1rem' }}>
                                        <div style={{ 
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            marginBottom: '0.5rem',
                                            color: '#e2e8f0'
                                        }}>
                                            <span>Cap Used:</span>
                                            <span style={{ fontWeight: 'bold' }}>
                                                {formatSalary(capStatus.totalCapHit)} / {formatSalary(SALARY_CAP.ceiling)}
                                            </span>
                                        </div>
                                        
                                        {/* Progress bar */}
                                        <div style={{
                                            width: '100%',
                                            height: '24px',
                                            background: 'rgba(0, 0, 0, 0.4)',
                                            borderRadius: '12px',
                                            overflow: 'hidden',
                                            border: '1px solid rgba(148, 163, 184, 0.3)',
                                            position: 'relative'
                                        }}>
                                            <div style={{
                                                width: `${Math.min(capPercent, 100)}%`,
                                                height: '100%',
                                                background: `linear-gradient(90deg, ${capColor} 0%, ${capColor}dd 100%)`,
                                                transition: 'width 0.3s ease'
                                            }}></div>
                                            <div style={{
                                                position: 'absolute',
                                                top: '50%',
                                                left: '50%',
                                                transform: 'translate(-50%, -50%)',
                                                fontSize: '0.85rem',
                                                fontWeight: 'bold',
                                                color: '#fff',
                                                textShadow: '0 1px 3px rgba(0,0,0,0.8)'
                                            }}>
                                                {capPercent.toFixed(1)}%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style={{ 
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(3, 1fr)',
                                        gap: '1rem',
                                        color: '#e2e8f0',
                                        fontSize: '0.9rem'
                                    }}>
                                        <div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.8rem' }}>Cap Space</div>
                                            <div style={{ 
                                                fontWeight: 'bold',
                                                color: capStatus.capSpace >= 0 ? '#22c55e' : '#ef4444'
                                            }}>
                                                {formatSalary(capStatus.capSpace)}
                                            </div>
                                        </div>
                                        <div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.8rem' }}>Avg Salary</div>
                                            <div style={{ fontWeight: 'bold' }}>{formatSalary(capStatus.averageSalary)}</div>
                                        </div>
                                        <div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.8rem' }}>Salary Floor</div>
                                            <div style={{ fontWeight: 'bold' }}>{formatSalary(SALARY_CAP.floor)}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
                        
                        {['F', 'D', 'G'].map(pos => (
                            <div key={pos}>
                                <h3>
                                    {pos === 'F' ? 'Forwards (13)' : pos === 'D' ? 'Defensemen (7)' : 'Goalies (3)'}
                                </h3>
                                {userRoster.filter(p => p.position === pos).map(player => (
                                    <div 
                                        key={player.id} 
                                        className="list-item"
                                        onClick={() => navigateTo('playerProfile', player)}
                                        style={{ cursor: 'pointer' }}
                                    >
                                        <div>
                                            <span className="player-name clickable-player">{player.firstName} {player.lastName}</span>
                                            <span className="player-pos">{player.position}</span>
                                            {player.preferredPosition && player.position !== 'G' && (
                                                <span style={{ 
                                                    padding: '0.25rem 0.5rem',
                                                    marginLeft: '0.5rem',
                                                    borderRadius: '0.25rem',
                                                    fontSize: '0.7rem',
                                                    fontWeight: 'bold',
                                                    background: 'rgba(59, 130, 246, 0.2)',
                                                    color: '#3b82f6',
                                                    border: '1px solid rgba(59, 130, 246, 0.3)'
                                                }}>
                                                    Pref: {player.preferredPosition}
                                                </span>
                                            )}
                                            {player.ratings.overall >= 85 && <span className="badge badge-green">Elite</span>}
                                            {player.ratings.overall >= 75 && player.ratings.overall < 85 && <span className="badge badge-yellow">Good</span>}
                                            {player.injury.injured && (
                                                <span style={{ 
                                                    padding: '0.25rem 0.5rem', 
                                                    borderRadius: '0.25rem', 
                                                    fontSize: '0.75rem', 
                                                    fontWeight: 'bold',
                                                    marginLeft: '0.5rem',
                                                    background: player.injury.isCareerEnding ? '#ef4444' : 
                                                               player.injury.severity === 'Season-Ending' ? '#f59e0b' : 
                                                               player.injury.severity === 'Month-to-Month' ? '#f97316' : '#fbbf24',
                                                    color: '#fff'
                                                }}>
                                                    {getPlayerStatus(player)}
                                                </span>
                                            )}
                                        </div>
                                        <span style={{ color: '#22d3ee', fontSize: '0.875rem' }}>
                                            Age: {player.age} | OVR: {player.ratings.overall} | POT: {player.ratings.potential}
                                            {player.contract && (
                                                <span style={{ color: '#4ade80', marginLeft: '0.5rem', fontWeight: 'bold' }}>
                                                    | {formatSalary(player.contract.salary)}
                                                    {player.contract.type === 'elc' && ' (ELC)'}
                                                </span>
                                            )}
                                            {player.injury.injured && !player.injury.isCareerEnding && (
                                                <span style={{ color: '#f59e0b', marginLeft: '0.5rem' }}>
                                                    | {player.injury.type} ({player.injury.daysUntilReturn}d)
                                                </span>
                                            )}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                    </>
                    );
                })()}

                {/* LINES & SCRATCHES VIEW */}
                {currentView === 'lines' && gameState && (
                    <div>
                        {/* Header Card */}
                        <div className="card" style={{ background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e' }}>
                            <h2 style={{ color: '#22c55e' }}>üìã Advanced Line Management</h2>
                            <p style={{ color: '#93c5fd', marginBottom: '0.5rem' }}>
                                Set forward lines (C, LW, RW), defense pairs (LD, RD), and special teams (PP/PK)
                            </p>
                            
                            {/* LIVE OVERALL DISPLAY */}
                            {(() => {
                                const teamOverallData = getTeamOverall(userTeamId);
                                const currentOverall = teamOverallData?.overall || 0;
                                const currentRank = teamOverallData?.rank || NUM_TEAMS;
                                
                                // Calculate individual line overalls
                                const calculateLineOverall = (players) => {
                                    if (players.length === 0) return 0;
                                    const sum = players.reduce((acc, p) => acc + p.ratings.overall, 0);
                                    return Math.round(sum / players.length);
                                };
                                
                                const forwards = userRoster.filter(p => p.position === 'F' && p.lineNumber > 0);
                                const defense = userRoster.filter(p => p.position === 'D' && p.lineNumber > 0);
                                const goalies = userRoster.filter(p => p.position === 'G' && p.dressed);
                                
                                const line1 = forwards.filter(p => p.lineNumber === 1);
                                const line2 = forwards.filter(p => p.lineNumber === 2);
                                const line3 = forwards.filter(p => p.lineNumber === 3);
                                const line4 = forwards.filter(p => p.lineNumber === FORWARD_LINES);
                                
                                const pair1 = defense.filter(p => p.lineNumber === 1);
                                const pair2 = defense.filter(p => p.lineNumber === 2);
                                const pair3 = defense.filter(p => p.lineNumber === 3);
                                
                                const pp1 = userRoster.filter(p => p.ppUnit === 1 && p.lineNumber > 0);
                                const pp2 = userRoster.filter(p => p.ppUnit === 2 && p.lineNumber > 0);
                                const pk1 = userRoster.filter(p => p.pkUnit === 1 && p.lineNumber > 0);
                                const pk2 = userRoster.filter(p => p.pkUnit === 2 && p.lineNumber > 0);
                                
                                return (
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(59, 130, 246, 0.15)',
                                        borderRadius: '0.5rem',
                                        border: '2px solid rgba(59, 130, 246, 0.4)',
                                        marginBottom: '1rem'
                                    }}>
                                        {/* Team Overall */}
                                        <div style={{ 
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center',
                                            marginBottom: '1.5rem',
                                            paddingBottom: '1rem',
                                            borderBottom: '2px solid rgba(59, 130, 246, 0.3)'
                                        }}>
                                            <div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                    TEAM OVERALL
                                                </div>
                                                <div style={{ 
                                                    fontSize: '3rem', 
                                                    fontWeight: 'bold', 
                                                    color: currentRank <= 5 ? '#4ade80' : currentRank <= 10 ? '#60a5fa' : currentRank <= 20 ? '#fbbf24' : '#f87171',
                                                    lineHeight: 1
                                                }}>
                                                    {currentOverall}
                                                </div>
                                            </div>
                                            <div style={{ textAlign: 'right' }}>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.25rem' }}>
                                                    LEAGUE RANK
                                                </div>
                                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {currentRank} / {NUM_TEAMS}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Line Overalls Grid */}
                                        <div style={{ 
                                            display: 'grid',
                                            gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                                            gap: '0.75rem'
                                        }}>
                                            {/* Forward Lines */}
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 1</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(line1) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 2</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(line2) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 3</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(line3) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Line 4</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(line4) || '--'}
                                                </div>
                                            </div>
                                            
                                            {/* Defense Pairs */}
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>D Pair 1</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(pair1) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>D Pair 2</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(pair2) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>D Pair 3</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(pair3) || '--'}
                                                </div>
                                            </div>
                                            
                                            {/* Goalies */}
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(0, 0, 0, 0.2)',
                                                borderRadius: '0.375rem'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginBottom: '0.25rem' }}>Goalies</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(goalies) || '--'}
                                                </div>
                                            </div>
                                            
                                            {/* Special Teams */}
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(251, 191, 36, 0.15)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(251, 191, 36, 0.3)'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#fbbf24', marginBottom: '0.25rem' }}>PP1</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(pp1) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(251, 191, 36, 0.15)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(251, 191, 36, 0.3)'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#fbbf24', marginBottom: '0.25rem' }}>PP2</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(pp2) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(239, 68, 68, 0.15)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(239, 68, 68, 0.3)'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#ef4444', marginBottom: '0.25rem' }}>PK1</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(pk1) || '--'}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.75rem',
                                                background: 'rgba(239, 68, 68, 0.15)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(239, 68, 68, 0.3)'
                                            }}>
                                                <div style={{ fontSize: '0.75rem', color: '#ef4444', marginBottom: '0.25rem' }}>PK2</div>
                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: '#fff' }}>
                                                    {calculateLineOverall(pk2) || '--'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style={{ 
                                            marginTop: '1rem',
                                            padding: '0.75rem',
                                            background: 'rgba(147, 197, 253, 0.1)',
                                            borderRadius: '0.375rem',
                                            fontSize: '0.875rem',
                                            color: '#93c5fd'
                                        }}>
                                            üí° <strong>Formula:</strong> Team OVR uses weighted average (Top lines/pairs count more). Line OVR is simple average of players.
                                        </div>
                                    </div>
                                );
                            })()}
                            
                            {/* Roster Summary */}
                            <div style={{ 
                                display: 'flex', 
                                gap: '2rem',
                                padding: '0.75rem',
                                background: 'rgba(0, 0, 0, 0.2)',
                                borderRadius: '0.5rem',
                                marginBottom: '0.5rem'
                            }}>
                                <div>
                                    <div style={{ color: '#22c55e', fontSize: '0.75rem', marginBottom: '0.25rem' }}>ACTIVE (20)</div>
                                    <div style={{ color: '#fff', fontSize: '0.9rem' }}>
                                        {userRoster.filter(p => p.position === 'F' && p.lineNumber > 0).length} F + 
                                        {' '}{userRoster.filter(p => p.position === 'D' && p.lineNumber > 0).length} D + 
                                        {' '}{userRoster.filter(p => p.position === 'G' && p.dressed).length} G
                                    </div>
                                </div>
                                <div>
                                    <div style={{ color: '#ef4444', fontSize: '0.75rem', marginBottom: '0.25rem' }}>SCRATCHED (3)</div>
                                    <div style={{ color: '#fff', fontSize: '0.9rem' }}>
                                        {userRoster.filter(p => p.position === 'F' && p.lineNumber === 0).length} F + 
                                        {' '}{userRoster.filter(p => p.position === 'D' && p.lineNumber === 0).length} D + 
                                        {' '}{userRoster.filter(p => p.position === 'G' && !p.dressed).length} G
                                    </div>
                                </div>
                                <div style={{ marginLeft: 'auto' }}>
                                    <div style={{ color: '#93c5fd', fontSize: '0.75rem', marginBottom: '0.25rem' }}>TOTAL ROSTER</div>
                                    <div style={{ color: '#fff', fontSize: '0.9rem', fontWeight: 'bold' }}>
                                        23 Players
                                    </div>
                                </div>
                            </div>
                            
                            <p style={{ color: '#fbbf24', fontSize: '0.85rem' }}>
                                ‚ö†Ô∏è Out-of-position penalty: Forwards -3 OVR | Defense -5 OVR
                            </p>
                            
                            {/* Save/Load Controls */}
                            <div style={{ 
                                display: 'flex', 
                                gap: '1rem', 
                                marginTop: '1rem',
                                flexWrap: 'wrap',
                                alignItems: 'center'
                            }}>
                                <button
                                    onClick={() => {
                                        if (confirm('Auto-set best lineup? This will replace your current lineup (lines, PP, PK, goalies) based on player OVR and position preference.')) {
                                            const newPlayers = [...gameState.players];
                                            // Only auto-set for user's team players
                                            const userTeamPlayers = newPlayers.filter(p => p.teamId === userTeamId);
                                            autoSetLineup(userTeamPlayers);
                                            setGameState({ ...gameState, players: newPlayers });
                                            saveGameToLocalStorage({ ...gameState, players: newPlayers }, userTeamId, playoffState, seasonMode);
                                        }
                                    }}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: '#8b5cf6',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    ‚ö° Auto-Set Best Lineup
                                </button>
                                
                                <button
                                    onClick={saveCurrentLineup}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: '#22c55e',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.375rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    üíæ Save Default Lineup
                                </button>
                                
                                {savedLineups.length > 0 && savedLineups[0].id === 'default' && (
                                    <div style={{ 
                                        padding: '0.5rem 1rem',
                                        background: 'rgba(34, 197, 94, 0.2)',
                                        border: '1px solid rgba(34, 197, 94, 0.3)',
                                        borderRadius: '0.375rem',
                                        color: '#22c55e',
                                        fontSize: '0.875rem'
                                    }}>
                                        ‚úì Lineup Saved & Valid
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* FORWARD LINES */}
                        <div className="card">
                            <h2 style={{ color: '#22d3ee' }}>‚öîÔ∏è Forward Lines (12 Active / 13 Total)</h2>
                            {[1, 2, 3, 4].map(line => {
                                const positions = ['C', 'LW', 'RW'];
                                return (
                                    <div key={line} style={{ marginBottom: '1.5rem' }}>
                                        <h3 style={{ color: '#93c5fd', fontSize: '1rem', marginBottom: '0.75rem' }}>
                                            Line {line}
                                        </h3>
                                        <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                                            {positions.map(pos => {
                                                const player = userRoster.find(p => p.position === 'F' && p.lineNumber === line && p.linePosition === pos && !p.injury.injured);
                                                const availablePlayers = userRoster.filter(p => p.position === 'F' && !p.injury.injured);
                                                
                                                return (
                                                    <div key={pos} style={{ flex: '1', minWidth: '200px' }}>
                                                        <div style={{ 
                                                            padding: '0.75rem',
                                                            background: player ? 'rgba(59, 130, 246, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                                            borderRadius: '0.375rem',
                                                            border: player ? '1px solid rgba(59, 130, 246, 0.3)' : '1px dashed rgba(100, 116, 139, 0.3)'
                                                        }}>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.75rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                                {pos}
                                                            </div>
                                                            {player ? (
                                                                <div>
                                                                    <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.95rem', marginBottom: '0.25rem' }}>
                                                                        {player.firstName.charAt(0)}. {player.lastName}
                                                                        {player.preferredPosition === pos && <span style={{color: '#22c55e', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="In preferred position">‚úì</span>}
                                                                        {player.preferredPosition !== pos && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Out of position (-3 OVR)">‚ö†Ô∏è</span>}
                                                                    </div>
                                                                    <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem' }}>
                                                                        OVR: {getEffectiveOverall(player)} 
                                                                        {player.preferredPosition !== pos && ` (was ${player.ratings.overall})`}
                                                                        {' '}| Pref: {player.preferredPosition}
                                                                    </div>
                                                                    <select
                                                                        value={player.id}
                                                                        onChange={(e) => {
                                                                            if (e.target.value === 'empty') {
                                                                                assignPlayerToLine(player.id, 0, null);
                                                                            } else if (e.target.value !== player.id) {
                                                                                const newPlayer = availablePlayers.find(p => p.id === e.target.value);
                                                                                if (newPlayer) {
                                                                                    assignPlayerToLine(player.id, newPlayer.lineNumber, newPlayer.linePosition);
                                                                                    assignPlayerToLine(newPlayer.id, line, pos);
                                                                                }
                                                                            }
                                                                        }}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #3b82f6',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value={player.id}>{player.lastName}</option>
                                                                        <option value="empty">-- Empty Slot --</option>
                                                                        <optgroup label="Swap With:">
                                                                            {availablePlayers
                                                                                .filter(p => p.id !== player.id)
                                                                                .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                .map(p => (
                                                                                    <option key={p.id} value={p.id}>
                                                                                        {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                    </option>
                                                                                ))}
                                                                        </optgroup>
                                                                    </select>
                                                                </div>
                                                            ) : (
                                                                <div>
                                                                    <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                        Empty
                                                                    </div>
                                                                    <select
                                                                        onChange={(e) => {
                                                                            if (e.target.value) {
                                                                                assignPlayerToLine(e.target.value, line, pos);
                                                                            }
                                                                        }}
                                                                        value=""
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #3b82f6',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value="">-- Select Player --</option>
                                                                        {availablePlayers
                                                                            .filter(p => p.lineNumber === 0 || !p.linePosition)
                                                                            .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                            .map(p => (
                                                                                <option key={p.id} value={p.id}>
                                                                                    {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                </option>
                                                                            ))}
                                                                    </select>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* DEFENSE PAIRS */}
                        <div className="card">
                            <h2 style={{ color: '#8b5cf6' }}>üõ°Ô∏è Defense Pairs (6 Active / 7 Total)</h2>
                            {[1, 2, 3].map(pair => {
                                const positions = ['LD', 'RD'];
                                return (
                                    <div key={pair} style={{ marginBottom: '1.5rem' }}>
                                        <h3 style={{ color: '#a78bfa', fontSize: '1rem', marginBottom: '0.75rem' }}>
                                            Pair {pair}
                                        </h3>
                                        <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                                            {positions.map(pos => {
                                                const player = userRoster.find(p => p.position === 'D' && p.lineNumber === pair && p.linePosition === pos && !p.injury.injured);
                                                const availablePlayers = userRoster.filter(p => p.position === 'D' && !p.injury.injured);
                                                
                                                return (
                                                    <div key={pos} style={{ flex: '1', minWidth: '200px' }}>
                                                        <div style={{ 
                                                            padding: '0.75rem',
                                                            background: player ? 'rgba(139, 92, 246, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                                            borderRadius: '0.375rem',
                                                            border: player ? '1px solid rgba(139, 92, 246, 0.3)' : '1px dashed rgba(100, 116, 139, 0.3)'
                                                        }}>
                                                            <div style={{ color: '#a78bfa', fontSize: '0.75rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                                {pos}
                                                            </div>
                                                            {player ? (
                                                                <div>
                                                                    <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.95rem', marginBottom: '0.25rem' }}>
                                                                        {player.firstName.charAt(0)}. {player.lastName}
                                                                        {player.preferredPosition === pos && <span style={{color: '#22c55e', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="In preferred position">‚úì</span>}
                                                                        {player.preferredPosition !== pos && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Out of position (-5 OVR)">‚ö†Ô∏è</span>}
                                                                    </div>
                                                                    <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem' }}>
                                                                        OVR: {getEffectiveOverall(player)}
                                                                        {player.preferredPosition !== pos && ` (was ${player.ratings.overall})`}
                                                                        {' '}| Pref: {player.preferredPosition}
                                                                    </div>
                                                                    <select
                                                                        value={player.id}
                                                                        onChange={(e) => {
                                                                            if (e.target.value === 'empty') {
                                                                                assignPlayerToLine(player.id, 0, null);
                                                                            } else if (e.target.value !== player.id) {
                                                                                const newPlayer = availablePlayers.find(p => p.id === e.target.value);
                                                                                if (newPlayer) {
                                                                                    assignPlayerToLine(player.id, newPlayer.lineNumber, newPlayer.linePosition);
                                                                                    assignPlayerToLine(newPlayer.id, pair, pos);
                                                                                }
                                                                            }
                                                                        }}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #3b82f6',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value={player.id}>{player.lastName}</option>
                                                                        <option value="empty">-- Empty Slot --</option>
                                                                        <optgroup label="Swap With:">
                                                                            {availablePlayers
                                                                                .filter(p => p.id !== player.id)
                                                                                .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                .map(p => (
                                                                                    <option key={p.id} value={p.id}>
                                                                                        {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                    </option>
                                                                                ))}
                                                                        </optgroup>
                                                                    </select>
                                                                </div>
                                                            ) : (
                                                                <div>
                                                                    <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                        Empty
                                                                    </div>
                                                                    <select
                                                                        onChange={(e) => {
                                                                            if (e.target.value) {
                                                                                assignPlayerToLine(e.target.value, pair, pos);
                                                                            }
                                                                        }}
                                                                        value=""
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #3b82f6',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value="">-- Select Player --</option>
                                                                        {availablePlayers
                                                                            .filter(p => p.lineNumber === 0 || !p.linePosition)
                                                                            .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                            .map(p => (
                                                                                <option key={p.id} value={p.id}>
                                                                                    {p.lastName} (OVR {p.ratings.overall}, {p.preferredPosition})
                                                                                </option>
                                                                            ))}
                                                                    </select>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* GOALIES */}
                        <div className="card">
                            <h2 style={{ color: '#22c55e' }}>ü•Ö Goalies (2 Dress Per Game)</h2>
                            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                {userRoster.filter(p => p.position === 'G').sort((a, b) => a.lineNumber - b.lineNumber).map(player => (
                                    <div key={player.id} style={{
                                        flex: '1',
                                        minWidth: '250px',
                                        padding: '1rem',
                                        background: player.dressed ? 'rgba(34, 197, 94, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                        borderRadius: '0.5rem',
                                        border: player.dressed ? '2px solid #22c55e' : '1px dashed rgba(100, 116, 139, 0.3)',
                                        opacity: player.injury.injured ? 0.5 : 1
                                    }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem' }}>
                                            <div>
                                                <div style={{ color: player.dressed ? '#22c55e' : '#64748b', fontSize: '0.75rem', marginBottom: '0.25rem' }}>
                                                    {player.lineNumber === 1 ? 'STARTER' : player.lineNumber === 2 ? 'BACKUP' : 'THIRD'}
                                                </div>
                                                <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                    {player.firstName} {player.lastName}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>
                                                    OVR: {player.ratings.overall} | Age: {player.age}
                                                </div>
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                            <button
                                                onClick={() => toggleGoalieDressed(player.id)}
                                                disabled={player.injury.injured}
                                                style={{
                                                    flex: 1,
                                                    padding: '0.375rem',
                                                    background: player.dressed ? '#ef4444' : '#22c55e',
                                                    color: '#fff',
                                                    border: 'none',
                                                    borderRadius: '0.25rem',
                                                    cursor: player.injury.injured ? 'not-allowed' : 'pointer',
                                                    fontSize: '0.75rem',
                                                    fontWeight: 'bold'
                                                }}
                                            >
                                                {player.dressed ? 'üö´ Scratch' : '‚úì Dress'}
                                            </button>
                                        </div>
                                        <div style={{ fontSize: '0.85rem', color: '#e2e8f0' }}>
                                            {player.stats?.wins}-{player.stats?.losses} | {player.stats.savePercentage.toFixed(3)} SV% | {player.stats.gaa.toFixed(2)} GAA
                                        </div>
                                        {player.injury.injured && (
                                            <div style={{ color: '#f59e0b', fontSize: '0.75rem', marginTop: '0.5rem' }}>
                                                INJURED: {player.injury.type} ({player.injury.daysUntilReturn}d)
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* POWER PLAY UNITS */}
                        <div className="card" style={{ background: 'rgba(245, 158, 11, 0.05)', border: '1px solid rgba(245, 158, 11, 0.3)' }}>
                            <h2 style={{ color: '#f59e0b' }}>‚ö° Power Play Units (5 Players Each)</h2>
                            {[1, 2].map(unit => {
                                const positions = ['PP' + unit + '-F1', 'PP' + unit + '-F2', 'PP' + unit + '-F3', 'PP' + unit + '-F4', 'PP' + unit + '-D1'];
                                return (
                                    <div key={unit} style={{ marginBottom: '1.5rem' }}>
                                        <h3 style={{ color: '#fbbf24', fontSize: '1rem', marginBottom: '0.75rem' }}>
                                            PP Unit {unit}
                                        </h3>
                                        <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                                            {positions.map(pos => {
                                                const player = userRoster.find(p => p.ppUnit === unit && p.ppPosition === pos && !p.injury.injured);
                                                const availablePlayers = userRoster.filter(p => 
                                                    p.position !== 'G' && 
                                                    !p.injury.injured && 
                                                    p.lineNumber > 0 && 
                                                    p.linePosition
                                                );
                                                
                                                return (
                                                    <div key={pos} style={{ flex: '1', minWidth: '180px' }}>
                                                        <div style={{ 
                                                            padding: '0.75rem',
                                                            background: player ? 'rgba(245, 158, 11, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                                            borderRadius: '0.375rem',
                                                            border: player ? '1px solid rgba(245, 158, 11, 0.3)' : '1px dashed rgba(100, 116, 139, 0.3)'
                                                        }}>
                                                            <div style={{ color: '#fbbf24', fontSize: '0.75rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                                {pos}
                                                            </div>
                                                            {player ? (
                                                                <div>
                                                                    <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.95rem', marginBottom: '0.25rem' }}>
                                                                        {player.firstName.charAt(0)}. {player.lastName}
                                                                        {pos.includes('-D') && player.position === 'F' && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Forward playing defense position">‚ö†Ô∏è</span>}
                                                                        {pos.includes('-F') && player.position === 'D' && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Defenseman playing forward position">‚ö†Ô∏è</span>}
                                                                    </div>
                                                                    <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem' }}>
                                                                        OVR: {player.ratings.overall} | {player.position} - {player.preferredPosition}
                                                                    </div>
                                                                    <select
                                                                        value={player.id}
                                                                        onChange={(e) => {
                                                                            if (e.target.value === 'empty') {
                                                                                assignToSpecialTeams(player.id, 'pp', null, null);
                                                                            } else if (e.target.value !== player.id) {
                                                                                const newPlayer = availablePlayers.find(p => p.id === e.target.value);
                                                                                if (newPlayer) {
                                                                                    // Swap players
                                                                                    const oldUnit = newPlayer.ppUnit;
                                                                                    const oldPos = newPlayer.ppPosition;
                                                                                    assignToSpecialTeams(newPlayer.id, 'pp', unit, pos);
                                                                                    if (oldUnit && oldPos) {
                                                                                        assignToSpecialTeams(player.id, 'pp', oldUnit, oldPos);
                                                                                    } else {
                                                                                        assignToSpecialTeams(player.id, 'pp', null, null);
                                                                                    }
                                                                                }
                                                                            }
                                                                        }}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #f59e0b',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value={player.id}>{player.lastName}</option>
                                                                        <option value="empty">-- Empty Slot --</option>
                                                                        <optgroup label="Swap With:">
                                                                            {availablePlayers
                                                                                .filter(p => p.id !== player.id)
                                                                                .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                .map(p => (
                                                                                    <option key={p.id} value={p.id}>
                                                                                        {p.lastName} (OVR {p.ratings.overall}, {p.position})
                                                                                        {p.ppUnit ? ` [PP${p.ppUnit}]` : ''}
                                                                                    </option>
                                                                                ))}
                                                                        </optgroup>
                                                                    </select>
                                                                </div>
                                                            ) : (
                                                                <div>
                                                                    <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                        Empty
                                                                    </div>
                                                                    <select
                                                                        value=""
                                                                        onChange={(e) => {
                                                                            if (e.target.value) {
                                                                                assignToSpecialTeams(e.target.value, 'pp', unit, pos);
                                                                            }
                                                                        }}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #f59e0b',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value="">-- Select Player --</option>
                                                                        {availablePlayers
                                                                            .filter(p => !p.ppUnit)
                                                                            .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                            .map(p => (
                                                                                <option key={p.id} value={p.id}>
                                                                                    {p.lastName} (OVR {p.ratings.overall}, {p.position})
                                                                                </option>
                                                                            ))}
                                                                    </select>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                            <div style={{ 
                                marginTop: '1rem',
                                padding: '0.75rem',
                                background: 'rgba(245, 158, 11, 0.1)',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem',
                                color: '#fbbf24'
                            }}>
                                üí° <strong>Tip:</strong> Typical PP setup is 4F + 1D, but any combination works. Players on both PP1 & PP2 will get more ice time. Out-of-position warnings shown with ‚ö†Ô∏è
                            </div>
                        </div>

                        {/* PENALTY KILL UNITS */}
                        <div className="card" style={{ background: 'rgba(239, 68, 68, 0.05)', border: '1px solid rgba(239, 68, 68, 0.3)' }}>
                            <h2 style={{ color: '#ef4444' }}>üõ°Ô∏è Penalty Kill Units (4 Players Each)</h2>
                            {[1, 2].map(unit => {
                                const positions = ['PK' + unit + '-F1', 'PK' + unit + '-F2', 'PK' + unit + '-D1', 'PK' + unit + '-D2'];
                                return (
                                    <div key={unit} style={{ marginBottom: '1.5rem' }}>
                                        <h3 style={{ color: '#f87171', fontSize: '1rem', marginBottom: '0.75rem' }}>
                                            PK Unit {unit}
                                        </h3>
                                        <div style={{ display: 'flex', gap: '0.75rem', flexWrap: 'wrap' }}>
                                            {positions.map(pos => {
                                                const player = userRoster.find(p => p.pkUnit === unit && p.pkPosition === pos && !p.injury.injured);
                                                const availablePlayers = userRoster.filter(p => 
                                                    p.position !== 'G' && 
                                                    !p.injury.injured && 
                                                    p.lineNumber > 0 && 
                                                    p.linePosition
                                                );
                                                
                                                return (
                                                    <div key={pos} style={{ flex: '1', minWidth: '180px' }}>
                                                        <div style={{ 
                                                            padding: '0.75rem',
                                                            background: player ? 'rgba(239, 68, 68, 0.1)' : 'rgba(100, 116, 139, 0.1)',
                                                            borderRadius: '0.375rem',
                                                            border: player ? '1px solid rgba(239, 68, 68, 0.3)' : '1px dashed rgba(100, 116, 139, 0.3)'
                                                        }}>
                                                            <div style={{ color: '#f87171', fontSize: '0.75rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                                {pos}
                                                            </div>
                                                            {player ? (
                                                                <div>
                                                                    <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.95rem', marginBottom: '0.25rem' }}>
                                                                        {player.firstName.charAt(0)}. {player.lastName}
                                                                        {pos.includes('-D') && player.position === 'F' && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Forward playing defense position">‚ö†Ô∏è</span>}
                                                                        {pos.includes('-F') && player.position === 'D' && <span style={{color: '#f59e0b', marginLeft: '0.25rem', fontSize: '0.75rem'}} title="Defenseman playing forward position">‚ö†Ô∏è</span>}
                                                                    </div>
                                                                    <div style={{ fontSize: '0.75rem', color: '#64748b', marginBottom: '0.5rem' }}>
                                                                        OVR: {player.ratings.overall} | {player.position} - {player.preferredPosition}
                                                                    </div>
                                                                    <select
                                                                        value={player.id}
                                                                        onChange={(e) => {
                                                                            if (e.target.value === 'empty') {
                                                                                assignToSpecialTeams(player.id, 'pk', null, null);
                                                                            } else if (e.target.value !== player.id) {
                                                                                const newPlayer = availablePlayers.find(p => p.id === e.target.value);
                                                                                if (newPlayer) {
                                                                                    // Swap players
                                                                                    const oldUnit = newPlayer.pkUnit;
                                                                                    const oldPos = newPlayer.pkPosition;
                                                                                    assignToSpecialTeams(newPlayer.id, 'pk', unit, pos);
                                                                                    if (oldUnit && oldPos) {
                                                                                        assignToSpecialTeams(player.id, 'pk', oldUnit, oldPos);
                                                                                    } else {
                                                                                        assignToSpecialTeams(player.id, 'pk', null, null);
                                                                                    }
                                                                                }
                                                                            }
                                                                        }}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #ef4444',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value={player.id}>{player.lastName}</option>
                                                                        <option value="empty">-- Empty Slot --</option>
                                                                        <optgroup label="Swap With:">
                                                                            {availablePlayers
                                                                                .filter(p => p.id !== player.id)
                                                                                .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                                .map(p => (
                                                                                    <option key={p.id} value={p.id}>
                                                                                        {p.lastName} (OVR {p.ratings.overall}, {p.position})
                                                                                        {p.pkUnit ? ` [PK${p.pkUnit}]` : ''}
                                                                                    </option>
                                                                                ))}
                                                                        </optgroup>
                                                                    </select>
                                                                </div>
                                                            ) : (
                                                                <div>
                                                                    <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                        Empty
                                                                    </div>
                                                                    <select
                                                                        value=""
                                                                        onChange={(e) => {
                                                                            if (e.target.value) {
                                                                                assignToSpecialTeams(e.target.value, 'pk', unit, pos);
                                                                            }
                                                                        }}
                                                                        style={{
                                                                            width: '100%',
                                                                            padding: '0.25rem',
                                                                            background: '#1e3a8a',
                                                                            border: '1px solid #ef4444',
                                                                            borderRadius: '0.25rem',
                                                                            color: '#fff',
                                                                            fontSize: '0.75rem'
                                                                        }}
                                                                    >
                                                                        <option value="">-- Select Player --</option>
                                                                        {availablePlayers
                                                                            .filter(p => !p.pkUnit)
                                                                            .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                                            .map(p => (
                                                                                <option key={p.id} value={p.id}>
                                                                                    {p.lastName} (OVR {p.ratings.overall}, {p.position})
                                                                                </option>
                                                                            ))}
                                                                    </select>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                            <div style={{ 
                                marginTop: '1rem',
                                padding: '0.75rem',
                                background: 'rgba(239, 68, 68, 0.1)',
                                borderRadius: '0.375rem',
                                fontSize: '0.875rem',
                                color: '#f87171'
                            }}>
                                üí° <strong>Tip:</strong> Typical PK setup is 2F + 2D for defensive balance. Players on both PK1 & PK2 will get more ice time. Out-of-position warnings shown with ‚ö†Ô∏è
                            </div>
                        </div>

                        {/* HEALTHY SCRATCHES */}
                        <div className="card" style={{ background: 'rgba(100, 116, 139, 0.05)', border: '1px solid rgba(100, 116, 139, 0.3)' }}>
                            <h2 style={{ color: '#64748b' }}>üö´ Healthy Scratches</h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: '0.75rem' }}>
                                {userRoster.filter(p => p.position !== 'G' && (p.lineNumber === 0 || !p.linePosition) && !p.injury.injured).map(player => (
                                    <div key={player.id} style={{
                                        padding: '0.75rem',
                                        background: 'rgba(100, 116, 139, 0.1)',
                                        borderRadius: '0.375rem',
                                        border: '1px solid rgba(100, 116, 139, 0.3)'
                                    }}>
                                        <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '0.9rem', marginBottom: '0.25rem' }}>
                                            {player.firstName.charAt(0)}. {player.lastName}
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.75rem', marginBottom: '0.5rem' }}>
                                            {player.position} | {player.preferredPosition} | OVR {player.ratings.overall}
                                        </div>
                                        <button
                                            onClick={() => {
                                                // Find first empty slot for this player
                                                if (player.position === 'F') {
                                                    for (let line = 4; line >= 1; line--) {
                                                        const positions = ['C', 'LW', 'RW'];
                                                        for (let pos of positions) {
                                                            const occupied = userRoster.find(p => p.lineNumber === line && p.linePosition === pos && p.position === 'F');
                                                            if (!occupied) {
                                                                assignPlayerToLine(player.id, line, pos);
                                                                return;
                                                            }
                                                        }
                                                    }
                                                } else if (player.position === 'D') {
                                                    for (let pair = 3; pair >= 1; pair--) {
                                                        const positions = ['LD', 'RD'];
                                                        for (let pos of positions) {
                                                            const occupied = userRoster.find(p => p.lineNumber === pair && p.linePosition === pos && p.position === 'D');
                                                            if (!occupied) {
                                                                assignPlayerToLine(player.id, pair, pos);
                                                                return;
                                                            }
                                                        }
                                                    }
                                                }
                                            }}
                                            style={{
                                                width: '100%',
                                                padding: '0.375rem',
                                                background: '#22c55e',
                                                color: '#fff',
                                                border: 'none',
                                                borderRadius: '0.25rem',
                                                cursor: 'pointer',
                                                fontSize: '0.75rem',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            Activate
                                        </button>
                                    </div>
                                ))}
                                {userRoster.filter(p => p.position !== 'G' && (p.lineNumber === 0 || !p.linePosition) && !p.injury.injured).length === 0 && (
                                    <div style={{ gridColumn: '1 / -1', padding: '2rem', textAlign: 'center', color: '#64748b' }}>
                                        All players are active
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                {currentView === 'stats' && gameState && (
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                            <h2>
                                Player Statistics 
                                <span style={{ 
                                    marginLeft: '1rem', 
                                    fontSize: '1rem', 
                                    color: seasonMode === 'playoffs' ? '#f59e0b' : '#3b82f6',
                                    padding: '0.25rem 0.75rem',
                                    background: seasonMode === 'playoffs' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                    borderRadius: '0.25rem'
                                }}>
                                    {seasonMode === 'playoffs' ? 'üèÜ Playoffs' : 'üìä Regular Season'}
                                </span>
                            </h2>
                            <button
                                onClick={() => setPlayerAdvancedStats(!playerAdvancedStats)}
                                style={{
                                    padding: '0.5rem 1rem',
                                    background: playerAdvancedStats ? '#059669' : '#1e3a8a',
                                    border: `1px solid ${playerAdvancedStats ? '#10b981' : '#3b82f6'}`,
                                    borderRadius: '0.375rem',
                                    color: '#fff',
                                    fontSize: '1rem',
                                    cursor: 'pointer',
                                    fontWeight: 'bold'
                                }}
                            >
                                {playerAdvancedStats ? 'üìä Advanced Stats' : 'üìà Basic Stats'}
                            </button>
                        </div>
                        {seasonMode === 'playoffs' && !playoffState && (
                            <p style={{ color: '#f59e0b', marginBottom: '1rem' }}>
                                Complete the regular season to view playoff stats
                            </p>
                        )}
                        
                        {!playerAdvancedStats ? (
                            // BASIC STATS TABLE
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th style={{ cursor: 'pointer' }} onClick={() => handleSort('lastName')}>
                                            Player {sortConfig.key === 'lastName' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.gamesPlayed')} title="Games Played">
                                            GP {sortConfig.key === 'stats.gamesPlayed' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.goals')} title="Goals">
                                            G {sortConfig.key === 'stats.goals' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.assists')} title="Assists">
                                            A {sortConfig.key === 'stats.assists' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.points')} title="Points - Goals + Assists">
                                            PTS {sortConfig.key === 'stats.points' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.plusMinus')} title="Plus/Minus - On ice goal differential (goals for minus goals against at even strength)">
                                            +/- {sortConfig.key === 'stats.plusMinus' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.pim')} title="Penalty Minutes">
                                            PIM {sortConfig.key === 'stats.pim' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.shots')} title="Shots On Goal">
                                            SOG {sortConfig.key === 'stats.shots' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.timeOnIce')} title="Time On Ice Per Game - Average ice time per game">
                                            TOI/G {sortConfig.key === 'stats.timeOnIce' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortData(userRoster.filter(p => p.position !== 'G'), sortConfig.key, sortConfig.direction)
                                        .map((player, idx) => {
                                            // Use playoff stats if in playoff mode, otherwise regular season stats
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            const avgTOI = statsToShow.gamesPlayed > 0 ? statsToShow.timeOnIce / statsToShow.gamesPlayed : 0;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.goals}</td>
                                                    <td className="text-center">{statsToShow.assists}</td>
                                                    <td className="text-center">{statsToShow.points}</td>
                                                    <td className="text-center">{statsToShow.plusMinus > 0 ? '+' : ''}{statsToShow.plusMinus}</td>
                                                    <td className="text-center">{statsToShow.pim}</td>
                                                    <td className="text-center">{statsToShow.shots}</td>
                                                    <td className="text-center">{formatTOI(avgTOI)}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                        ) : (
                            // ADVANCED STATS TABLE
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th style={{ cursor: 'pointer' }} onClick={() => handleSort('lastName')}>
                                            Player {sortConfig.key === 'lastName' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.gamesPlayed')} title="Games Played">
                                            GP {sortConfig.key === 'stats.gamesPlayed' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.corsiPercent')} title="Corsi Percentage - Puck possession metric. CF / (CF + CA) √ó 100. Above 50% is good.">
                                            CF% {sortConfig.key === 'stats.corsiPercent' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.fenwickPercent')} title="Fenwick Percentage - Quality possession metric (excludes blocked shots). FF / (FF + FA) √ó 100. Above 50% is good.">
                                            FF% {sortConfig.key === 'stats.fenwickPercent' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.hits')} title="Hits - Physical body checks delivered">
                                            Hits {sortConfig.key === 'stats.hits' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.blockedShots')} title="Blocked Shots - Shots blocked while defending">
                                            Blk {sortConfig.key === 'stats.blockedShots' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.takeaways')} title="Takeaways - Pucks stolen from opponent">
                                            TK {sortConfig.key === 'stats.takeaways' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.giveaways')} title="Giveaways - Turnovers / pucks lost to opponent">
                                            GV {sortConfig.key === 'stats.giveaways' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                        <th className="text-center" style={{ cursor: 'pointer' }} onClick={() => handleSort('stats.faceoffPercent')} title="Faceoff Percentage - FO Won √∑ FO Total √ó 100. Above 50% is good. Centers only.">
                                            FO% {sortConfig.key === 'stats.faceoffPercent' && (sortConfig.direction === 'desc' ? '‚ñº' : '‚ñ≤')}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortData(userRoster.filter(p => p.position !== 'G'), sortConfig.key, sortConfig.direction)
                                        .map((player, idx) => {
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td className="text-center">{statsToShow.gamesPlayed || 0}</td>
                                                    <td className="text-center" style={{
                                                        fontWeight: 'bold',
                                                        color: (statsToShow.corsiPercent || 50) >= 50 ? '#22c55e' : '#ef4444'
                                                    }}>
                                                        {(statsToShow.corsiPercent || 0).toFixed(1)}%
                                                    </td>
                                                    <td className="text-center" style={{
                                                        fontWeight: 'bold',
                                                        color: (statsToShow.fenwickPercent || 50) >= 50 ? '#22c55e' : '#ef4444'
                                                    }}>
                                                        {(statsToShow.fenwickPercent || 0).toFixed(1)}%
                                                    </td>
                                                    <td className="text-center">{statsToShow.hits || 0}</td>
                                                    <td className="text-center">{statsToShow.blockedShots || 0}</td>
                                                    <td className="text-center">{statsToShow.takeaways || 0}</td>
                                                    <td className="text-center">{statsToShow.giveaways || 0}</td>
                                                    <td className="text-center" style={{
                                                        fontWeight: player.preferredPosition === 'C' ? 'bold' : 'normal',
                                                        color: player.preferredPosition === 'C' 
                                                            ? ((statsToShow.faceoffPercent || 0) >= 50 ? '#22c55e' : '#ef4444')
                                                            : '#64748b'
                                                    }}>
                                                        {player.preferredPosition === 'C' 
                                                            ? `${(statsToShow.faceoffPercent || 0).toFixed(1)}%`
                                                            : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                        )}
                        
                        <h2 style={{ marginTop: '2rem' }}>Goalie Statistics</h2>
                        <table className="stats-table">
                            <thead>
                                <tr>
                                    <th className="rank">#</th>
                                    <th>Player</th>
                                    <th className="text-center" title="Games Played">GP</th>
                                    <th className="text-center" title="Wins">W</th>
                                    <th className="text-center" title="Losses">L</th>
                                    <th className="text-center" title="Save Percentage - Saves √∑ Shots Against. .920 or higher is excellent.">SV%</th>
                                    <th className="text-center" title="Goals Against Average - Goals allowed per game. Lower is better.">GAA</th>
                                    <th className="text-center" title="Shutouts - Games with zero goals allowed">SO</th>
                                </tr>
                            </thead>
                            <tbody>
                                {userRoster
                                    .filter(p => p.position === 'G')
                                    .sort((a, b) => (b.stats.savePercentage || 0) - (a.stats.savePercentage || 0))
                                    .map((player, idx) => (
                                        <tr key={player.id}>
                                            <td className="rank">{idx + 1}</td>
                                            <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                {player.firstName} {player.lastName}
                                            </td>
                                            <td className="text-center">{player.stats.gamesPlayed}</td>
                                            <td className="text-center">{player.stats?.wins || 0}</td>
                                            <td className="text-center">{player.stats?.losses || 0}</td>
                                            <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.savePercentage || 0).toFixed(3) : '.000'}</td>
                                            <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.gaa || 0).toFixed(2) : '0.00'}</td>
                                            <td className="text-center">{player.stats.shutouts || 0}</td>
                                        </tr>
                                    ))}
                            </tbody>
                        </table>
                    </div>
                )}

                {currentView === 'leaders' && gameState && (
                    <div>
                        <div className="card">
                            <h2>
                                League Leaders 
                                <span style={{ 
                                    marginLeft: '1rem', 
                                    fontSize: '1rem', 
                                    color: seasonMode === 'playoffs' ? '#f59e0b' : '#3b82f6',
                                    padding: '0.25rem 0.75rem',
                                    background: seasonMode === 'playoffs' ? 'rgba(245, 158, 11, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                    borderRadius: '0.25rem'
                                }}>
                                    {seasonMode === 'playoffs' ? 'üèÜ Playoffs' : 'üìä Regular Season'}
                                </span>
                            </h2>
                            {seasonMode === 'playoffs' && !playoffState && (
                                <p style={{ color: '#f59e0b', marginBottom: '1rem' }}>
                                    Complete the regular season to view playoff leaders
                                </p>
                            )}
                            {seasonMode === 'playoffs' && playoffState && gameState.players.filter(p => p.playoffStats && p.playoffStats.gamesPlayed > 0).length === 0 && (
                                <p style={{ color: '#f59e0b', marginBottom: '1rem' }}>
                                    No playoff stats yet - simulate some playoff games to see leaders
                                </p>
                            )}
                            
                            <h3>Points</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">G</th>
                                        <th className="text-center">A</th>
                                        <th className="text-center">PTS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => {
                                            if (p.position === 'G' || p.roster !== 'nhl') return false;
                                            const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                            return statsToCheck && statsToCheck.gamesPlayed > 0;
                                        })
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return (bStats.points || 0) - (aStats.points || 0);
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed || 0}</td>
                                                    <td className="text-center">{statsToShow.goals || 0}</td>
                                                    <td className="text-center">{statsToShow.assists || 0}</td>
                                                    <td className="text-center">{statsToShow.points || 0}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>

                            <h3>Goals</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">G</th>
                                        <th className="text-center">PTS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return bStats.goals - aStats.goals;
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.goals}</td>
                                                    <td className="text-center">{statsToShow.points}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>

                            <h3>Assists</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">A</th>
                                        <th className="text-center">PTS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return bStats.assists - aStats.assists;
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.assists}</td>
                                                    <td className="text-center">{statsToShow.points}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>

                            <h3>Plus/Minus</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">+/-</th>
                                        <th className="text-center">PTS</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return bStats.plusMinus - aStats.plusMinus;
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.plusMinus > 0 ? '+' : ''}{statsToShow.plusMinus}</td>
                                                    <td className="text-center">{statsToShow.points}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>

                            <h3>Penalty Minutes</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">PIM</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => {
                                            const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                            return p.position !== 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed > 0;
                                        })
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return bStats.pim - aStats.pim;
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.pim}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>

                            <h3>Shots on Goal</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">SOG</th>
                                        <th className="text-center">G</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => p.position !== 'G' && p.roster === 'nhl')
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return bStats.shots - aStats.shots;
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.shots}</td>
                                                    <td className="text-center">{statsToShow.goals}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>

                            <h3>Time on Ice Per Game</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">TOI/G</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => {
                                            const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                            return p.position !== 'G' && statsToCheck.gamesPlayed > 0;
                                        })
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return (bStats.timeOnIce / bStats.gamesPlayed) - (aStats.timeOnIce / aStats.gamesPlayed);
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            const avgTOI = statsToShow.timeOnIce / statsToShow.gamesPlayed;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{formatTOI(avgTOI)}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                            
                            {/* Goalie Stats */}
                            <h3 style={{ marginTop: '3rem', paddingTop: '2rem', borderTop: '2px solid rgba(100, 116, 139, 0.3)' }}>ü•Ö Goalie Leaders</h3>
                            
                            <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Wins</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">W</th>
                                        <th className="text-center">L</th>
                                        <th className="text-center">SV%</th>
                                        <th className="text-center">GAA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => {
                                            const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                            return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed > 0;
                                        })
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return (bStats?.wins || 0) - (aStats?.wins || 0);
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow?.wins || 0}</td>
                                                    <td className="text-center">{statsToShow?.losses || 0}</td>
                                                    <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                    <td className="text-center">{statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                            
                            <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Save Percentage</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">SV%</th>
                                        <th className="text-center">GAA</th>
                                        <th className="text-center">W</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => {
                                            const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                            return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed >= 27; // NAHL minimum: 27 GP
                                        })
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return (bStats.savePercentage || 0) - (aStats.savePercentage || 0);
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                    <td className="text-center">{statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}</td>
                                                    <td className="text-center">{statsToShow?.wins || 0}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                            
                            <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Goals Against Average</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">GAA</th>
                                        <th className="text-center">SV%</th>
                                        <th className="text-center">W</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => {
                                            const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                            return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed >= 27; // NAHL minimum: 27 GP
                                        })
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return (aStats.gaa || 999) - (bStats.gaa || 999); // Lower is better
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}</td>
                                                    <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                    <td className="text-center">{statsToShow?.wins || 0}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                            
                            <h3 style={{ fontSize: '1.1rem', color: '#93c5fd', marginTop: '2rem' }}>Shutouts</h3>
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="rank">#</th>
                                        <th>Player</th>
                                        <th>Team</th>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">SO</th>
                                        <th className="text-center">W</th>
                                        <th className="text-center">SV%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {gameState.players
                                        .filter(p => {
                                            const statsToCheck = seasonMode === 'playoffs' ? p.playoffStats : p.stats;
                                            return p.position === 'G' && p.roster === 'nhl' && statsToCheck.gamesPlayed > 0;
                                        })
                                        .sort((a, b) => {
                                            const aStats = seasonMode === 'playoffs' ? (a.playoffStats || a.stats) : a.stats;
                                            const bStats = seasonMode === 'playoffs' ? (b.playoffStats || b.stats) : b.stats;
                                            return (bStats.shutouts || 0) - (aStats.shutouts || 0);
                                        })
                                        .slice(0, 10)
                                        .map((player, idx) => {
                                            const team = TEAMS.find(t => t.id === player.teamId);
                                            const statsToShow = seasonMode === 'playoffs' ? (player.playoffStats || player.stats) : player.stats;
                                            return (
                                                <tr key={player.id}>
                                                    <td className="rank">{idx + 1}</td>
                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                        {player.firstName} {player.lastName}
                                                        <span className="player-pos">{player.position}</span>
                                                    </td>
                                                    <td>{team?.city || 'N/A'}</td>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.shutouts || 0}</td>
                                                    <td className="text-center">{statsToShow?.wins || 0}</td>
                                                    <td className="text-center">{statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}</td>
                                                </tr>
                                            );
                                        })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}

                {currentView === 'teamStats' && gameState && gameState.standings && (
                    <div className="card">
                        <h2>Team Statistics</h2>
                        
                        <table className="stats-table">
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th className="text-center">GP</th>
                                    <th className="text-center">GF/G</th>
                                    <th className="text-center">GA/G</th>
                                    <th className="text-center">Diff</th>
                                    <th className="text-center">SF/G</th>
                                    <th className="text-center">SA/G</th>
                                    <th className="text-center">S%</th>
                                    <th className="text-center">PP%</th>
                                    <th className="text-center">PK%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {gameState.standings
                                    .sort((a, b) => {
                                        // Sort by points first
                                        return b.points - a.points;
                                    })
                                    .map(standing => {
                                        const team = getTeam(standing.teamId);
                                        const stats = standing.teamStats;
                                        const gp = stats.gamesPlayed || 1; // Avoid division by zero
                                        
                                        // Calculate per-game averages
                                        const gfPerGame = (standing.goalsFor / gp).toFixed(2);
                                        const gaPerGame = (standing.goalsAgainst / gp).toFixed(2);
                                        const goalDiff = (standing.goalsFor - standing.goalsAgainst) / gp;
                                        const shotsPerGame = (stats.shots / gp).toFixed(1);
                                        const shotsAgainstPerGame = (stats.shotsAgainst / gp).toFixed(1);
                                        const shootingPct = stats.shots > 0 ? ((standing.goalsFor / stats.shots) * 100).toFixed(1) : '0.0';
                                        const ppPct = stats.ppOpportunities > 0 ? ((stats.ppGoals / stats.ppOpportunities) * 100).toFixed(1) : '0.0';
                                        const pkPct = stats.pkOpportunities > 0 ? (((stats.pkOpportunities - stats.pkGoalsAgainst) / stats.pkOpportunities) * 100).toFixed(1) : '0.0';
                                        
                                        return (
                                            <tr key={standing.teamId}>
                                                <td>
                                                    <span 
                                                        style={{ cursor: 'pointer', textDecoration: 'underline' }}
                                                        onClick={() => {
                                                            navigateTo('teamProfile', standing.teamId);
                                                        }}
                                                    >
                                                        {team?.city || 'Unknown'}
                                                    </span>
                                                </td>
                                                <td className="text-center">{gp}</td>
                                                <td className="text-center">{gfPerGame}</td>
                                                <td className="text-center">{gaPerGame}</td>
                                                <td className="text-center" style={{ color: goalDiff > 0 ? '#4ade80' : goalDiff < 0 ? '#f87171' : '#fff' }}>
                                                    {goalDiff > 0 ? '+' : ''}{goalDiff.toFixed(2)}
                                                </td>
                                                <td className="text-center">{shotsPerGame}</td>
                                                <td className="text-center">{shotsAgainstPerGame}</td>
                                                <td className="text-center">{shootingPct}%</td>
                                                <td className="text-center" style={{ color: parseFloat(ppPct) >= 20 ? '#4ade80' : parseFloat(ppPct) < 15 ? '#f87171' : '#fff' }}>
                                                    {ppPct}%
                                                </td>
                                                <td className="text-center" style={{ color: parseFloat(pkPct) >= 82 ? '#4ade80' : parseFloat(pkPct) < 78 ? '#f87171' : '#fff' }}>
                                                    {pkPct}%
                                                </td>
                                            </tr>
                                        );
                                    })}
                            </tbody>
                        </table>
                        
                        <div style={{ marginTop: '2rem', padding: '1rem', background: 'rgba(30, 58, 138, 0.2)', borderRadius: '0.5rem' }}>
                            <h3 style={{ marginBottom: '1rem', color: '#93c5fd' }}>Legend</h3>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.5rem', fontSize: '0.9rem' }}>
                                <div><strong>GF/G:</strong> Goals For per Game</div>
                                <div><strong>GA/G:</strong> Goals Against per Game</div>
                                <div><strong>Diff:</strong> Goal Differential per Game</div>
                                <div><strong>SF/G:</strong> Shots For per Game</div>
                                <div><strong>SA/G:</strong> Shots Against per Game</div>
                                <div><strong>S%:</strong> Shooting Percentage</div>
                                <div><strong>PP%:</strong> Power Play Success Rate</div>
                                <div><strong>PK%:</strong> Penalty Kill Success Rate</div>
                            </div>
                        </div>
                    </div>
                )}

                {currentView === 'playerProfile' && selectedPlayerProfile && (() => {
                    const team = getTeam(selectedPlayerProfile.teamId);
                    return (
                    <div>
                        <button 
                            onClick={goBack}
                            style={{
                                padding: '0.5rem 1rem',
                                background: '#2563eb',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                marginBottom: '1rem',
                                fontWeight: 'bold'
                            }}
                        >
                            ‚Üê Back
                        </button>
                        
                    <div className="card">
                        <h2>{selectedPlayerProfile.firstName} {selectedPlayerProfile.lastName}</h2>
                        <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'rgba(30, 58, 138, 0.3)', borderRadius: '0.5rem' }}>
                            <p style={{ marginBottom: '0.5rem' }}><strong>Position:</strong> {selectedPlayerProfile.position}</p>
                            <p style={{ marginBottom: '0.5rem' }}><strong>Age:</strong> {selectedPlayerProfile.age}</p>
                            <p style={{ marginBottom: '0.5rem' }}>
                                <strong>Team:</strong> {team?.city} {team?.name}
                                {selectedPlayerProfile.roster === 'farm' && (
                                    <span style={{ 
                                        marginLeft: '0.5rem', 
                                        color: '#93c5fd', 
                                        fontSize: '0.9rem',
                                        fontStyle: 'italic'
                                    }}>
                                        (Minors)
                                    </span>
                                )}
                            </p>
                            <p style={{ marginBottom: '0.5rem' }}><strong>Overall Rating:</strong> {selectedPlayerProfile.ratings.overall}</p>
                            <p><strong>Potential:</strong> {selectedPlayerProfile.ratings.potential}</p>
                        </div>
                        
                        {/* Contract Information */}
                        {selectedPlayerProfile.contract && (
                            <div style={{ 
                                marginBottom: '2rem', 
                                padding: '1.5rem', 
                                background: 'rgba(34, 197, 94, 0.1)', 
                                border: '2px solid rgba(34, 197, 94, 0.3)', 
                                borderRadius: '0.5rem' 
                            }}>
                                <h3 style={{ marginBottom: '1rem', color: '#4ade80', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    üí∞ Contract Details
                                </h3>
                                <div style={{ 
                                    display: 'grid', 
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
                                    gap: '1rem',
                                    color: '#e2e8f0'
                                }}>
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                            Annual Salary
                                        </div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#4ade80' }}>
                                            {formatSalary(selectedPlayerProfile.contract.salary)}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                            Cap Hit
                                        </div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#4ade80' }}>
                                            {formatSalary(selectedPlayerProfile.contract.capHit)}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                            Years Remaining
                                        </div>
                                        <div style={{ fontSize: '1.5rem', fontWeight: 'bold' }}>
                                            {selectedPlayerProfile.contract.yearsRemaining} 
                                            {selectedPlayerProfile.contract.yearsRemaining === 1 ? ' Year' : ' Years'}
                                        </div>
                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                            Expires {gameState.year + selectedPlayerProfile.contract.yearsRemaining}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                            Contract Type
                                        </div>
                                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>
                                            {selectedPlayerProfile.contract.type === 'elc' ? (
                                                <span style={{ color: '#60a5fa' }}>Entry-Level</span>
                                            ) : (
                                                <span style={{ color: '#e2e8f0' }}>Standard</span>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                            Free Agent Status
                                        </div>
                                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold' }}>
                                            {selectedPlayerProfile.contract.ufa ? (
                                                <span style={{ color: '#fbbf24' }}>UFA Eligible</span>
                                            ) : selectedPlayerProfile.contract.rfa ? (
                                                <span style={{ color: '#93c5fd' }}>RFA Eligible</span>
                                            ) : (
                                                <span style={{ color: '#94a3b8' }}>Under Contract</span>
                                            )}
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                            Total Contract Value
                                        </div>
                                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#22c55e' }}>
                                            {formatSalary(selectedPlayerProfile.contract.salary * selectedPlayerProfile.contract.totalYears)}
                                            <span style={{ 
                                                fontSize: '0.75rem', 
                                                color: '#94a3b8', 
                                                marginLeft: '0.5rem',
                                                fontWeight: 'normal'
                                            }}>
                                                ({selectedPlayerProfile.contract.totalYears} years)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Contract expiration warning */}
                                {selectedPlayerProfile.contract.yearsRemaining <= 1 && (
                                    <div style={{
                                        marginTop: '1rem',
                                        padding: '0.75rem',
                                        background: 'rgba(245, 158, 11, 0.2)',
                                        border: '1px solid #f59e0b',
                                        borderRadius: '0.375rem',
                                        color: '#fbbf24',
                                        fontSize: '0.9rem'
                                    }}>
                                        ‚ö†Ô∏è <strong>Contract expiring soon!</strong> Player will become {selectedPlayerProfile.contract.ufa ? 'an unrestricted' : 'a restricted'} free agent after this season.
                                    </div>
                                )}
                                
                                {/* Offer Extension Button - Only show if player is on your team and entering final year */}
                                {selectedPlayerProfile.teamId === userTeamId && selectedPlayerProfile.contract.yearsRemaining === 1 && (
                                    <button
                                        onClick={() => {
                                            const marketValue = calculateMarketValue(selectedPlayerProfile);
                                            const preferredLength = calculatePreferredLength(selectedPlayerProfile);
                                            setContractOffer({ 
                                                salary: marketValue,
                                                years: preferredLength
                                            });
                                            setShowContractNegotiation(true);
                                        }}
                                        style={{
                                            marginTop: '1rem',
                                            padding: '1rem',
                                            background: 'linear-gradient(135deg, #3b82f6, #1e40af)',
                                            border: 'none',
                                            borderRadius: '0.5rem',
                                            color: 'white',
                                            fontSize: '1.1rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            width: '100%',
                                            transition: 'transform 0.2s'
                                        }}
                                        onMouseEnter={(e) => e.target.style.transform = 'scale(1.02)'}
                                        onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
                                    >
                                        üìù Offer Contract Extension
                                    </button>
                                )}
                            </div>
                        )}

                        {/* Achievements Section */}
                        {selectedPlayerProfile.achievements && selectedPlayerProfile.achievements.length > 0 && (
                            <div style={{ marginBottom: '2rem', padding: '1.5rem', background: 'rgba(251, 191, 36, 0.1)', border: '2px solid rgba(251, 191, 36, 0.3)', borderRadius: '0.5rem' }}>
                                <h3 style={{ marginBottom: '1rem', color: '#fbbf24', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    üèÜ Achievements
                                </h3>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                    {selectedPlayerProfile.achievements
                                        .sort((a, b) => {
                                            // First, sort by year (most recent first)
                                            if (b.year !== a.year) return b.year - a.year;
                                            
                                            // Second, sort by importance level
                                            const getImportance = (achievement) => {
                                                // League-level (most important)
                                                if (achievement.type === 'award') return 1; // League trophies
                                                if (achievement.type === 'allstar_team') return 2; // All-Star teams (1st/2nd/3rd)
                                                if (achievement.type === 'leagueLeader' || achievement.type === 'league_leader') return 3; // League leaders
                                                
                                                // Conference-level
                                                if (achievement.type === 'allstar') return 4; // Conference All-Stars
                                                
                                                // Division-level (least important)
                                                if (achievement.type === 'division_award') return 5; // Division awards
                                                if (achievement.type === 'division_allstar') return 6; // Division All-Star teams
                                                
                                                return 7; // Unknown types last
                                            };
                                            
                                            const importanceA = getImportance(a);
                                            const importanceB = getImportance(b);
                                            
                                            if (importanceA !== importanceB) return importanceA - importanceB;
                                            
                                            // Third, within same importance level, sort by specific criteria
                                            
                                            // For All-Star teams, sort by rank (1st, 2nd, 3rd)
                                            if (a.type === 'allstar_team' && b.type === 'allstar_team') {
                                                const rankA = a.team.includes('1st') ? 1 : a.team.includes('2nd') ? 2 : 3;
                                                const rankB = b.team.includes('1st') ? 1 : b.team.includes('2nd') ? 2 : 3;
                                                return rankA - rankB;
                                            }
                                            
                                            // For awards, sort alphabetically
                                            if (a.type === 'award' && b.type === 'award') {
                                                return (a.award || '').localeCompare(b.award || '');
                                            }
                                            
                                            // For league leaders, sort by stat name
                                            if ((a.type === 'leagueLeader' || a.type === 'league_leader') && 
                                                (b.type === 'leagueLeader' || b.type === 'league_leader')) {
                                                return (a.stat || a.category || '').localeCompare(b.stat || b.category || '');
                                            }
                                            
                                            // For division awards, sort alphabetically
                                            if (a.type === 'division_award' && b.type === 'division_award') {
                                                return (a.award || '').localeCompare(b.award || '');
                                            }
                                            
                                            return 0;
                                        })
                                        .map((achievement, idx) => (
                                            <div key={idx} style={{ 
                                                padding: '0.75rem', 
                                                background: 'rgba(30, 58, 138, 0.3)', 
                                                borderRadius: '0.375rem',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '0.75rem'
                                            }}>
                                                <span style={{ fontSize: '1.5rem' }}>{achievement.icon}</span>
                                                <div>
                                                    <strong style={{ color: '#fbbf24' }}>{achievement.year}</strong>
                                                    {achievement.type === 'award' && (
                                                        <span style={{ marginLeft: '0.5rem' }}>{achievement.award}</span>
                                                    )}
                                                    {achievement.type === 'allstar' && (
                                                        <span style={{ marginLeft: '0.5rem' }}>{achievement.conference} Conference All-Star</span>
                                                    )}
                                                    {achievement.type === 'allstar_team' && (
                                                        <span style={{ marginLeft: '0.5rem' }}>{achievement.team}</span>
                                                    )}
                                                    {achievement.type === 'division_award' && (
                                                        <span style={{ marginLeft: '0.5rem' }}>{achievement.award}</span>
                                                    )}
                                                    {achievement.type === 'division_allstar' && (
                                                        <span style={{ marginLeft: '0.5rem' }}>{achievement.team}</span>
                                                    )}
                                                    {(achievement.type === 'leagueLeader' || achievement.type === 'league_leader') && (
                                                        <span style={{ marginLeft: '0.5rem' }}>
                                                            League Leader - {achievement.stat || achievement.category} ({achievement.value})
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                </div>
                            </div>
                        )}

                        {/* Stats Type Dropdown (Regular Season / Playoffs) */}
                        <div style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '1rem' }}>
                            <label style={{ fontWeight: 'bold', color: '#93c5fd' }}>Stats Type:</label>
                            <select 
                                value={playerStatMode}
                                onChange={(e) => setPlayerStatMode(e.target.value)}
                                style={{
                                    padding: '0.5rem 1rem',
                                    background: '#1e3a8a',
                                    border: '1px solid #3b82f6',
                                    borderRadius: '0.375rem',
                                    color: '#fff',
                                    fontSize: '1rem',
                                    cursor: 'pointer',
                                    marginRight: '1rem'
                                }}
                            >
                                <option value="regular">Regular Season</option>
                                <option value="playoffs" disabled={!playoffState}>Playoffs {!playoffState && '(Not Started)'}</option>
                            </select>
                            
                            {/* Advanced Stats Toggle */}
                            {selectedPlayerProfile.position !== 'G' && (
                                <button
                                    onClick={() => setPlayerAdvancedStats(!playerAdvancedStats)}
                                    style={{
                                        padding: '0.5rem 1rem',
                                        background: playerAdvancedStats ? '#059669' : '#1e3a8a',
                                        border: `1px solid ${playerAdvancedStats ? '#10b981' : '#3b82f6'}`,
                                        borderRadius: '0.375rem',
                                        color: '#fff',
                                        fontSize: '1rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    {playerAdvancedStats ? 'üìä Advanced Stats' : 'üìà Basic Stats'}
                                </button>
                            )}
                        </div>

                        <h3>
                            {playerStatMode === 'playoffs' ? 'Playoff' : 'Regular Season'} Stats 
                            <span style={{ color: '#93c5fd', marginLeft: '0.5rem', fontSize: '0.9rem' }}>
                                ({gameState.year}-{(gameState.year + 1).toString().slice(-2)})
                            </span>
                        </h3>
                        
                        {playerStatMode === 'playoffs' && !playoffState && (
                            <p style={{ color: '#f59e0b', marginBottom: '1rem' }}>
                                Playoffs have not started yet. Complete the regular season first.
                            </p>
                        )}
                        
                        {/* Different stats table for goalies vs skaters */}
                        {selectedPlayerProfile.position === 'G' ? (
                            // GOALIE STATS
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="text-center" title="Games Played">GP</th>
                                        <th className="text-center" title="Wins">W</th>
                                        <th className="text-center" title="Losses">L</th>
                                        <th className="text-center" title="Save Percentage - Saves √∑ Shots Against. .920 or higher is excellent.">SV%</th>
                                        <th className="text-center" title="Goals Against Average - Goals allowed per game. Lower is better.">GAA</th>
                                        <th className="text-center" title="Shutouts - Games with zero goals allowed">SO</th>
                                        <th className="text-center" title="Shots Against - Total shots faced">SA</th>
                                        <th className="text-center" title="Saves - Total saves made">SV</th>
                                        <th className="text-center" title="Goals Against - Total goals allowed">GA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        const statsToShow = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                        return (
                                            <tr>
                                                <td className="text-center">{statsToShow.gamesPlayed || 0}</td>
                                                <td className="text-center">{statsToShow?.wins || 0}</td>
                                                <td className="text-center">{statsToShow?.losses || 0}</td>
                                                <td className="text-center">
                                                    {statsToShow.savePercentage ? statsToShow.savePercentage.toFixed(3) : '.000'}
                                                </td>
                                                <td className="text-center">
                                                    {statsToShow.gaa ? statsToShow.gaa.toFixed(2) : '0.00'}
                                                </td>
                                                <td className="text-center">{statsToShow.shutouts || 0}</td>
                                                <td className="text-center">{statsToShow.shotsAgainst || 0}</td>
                                                <td className="text-center">{statsToShow.saves || 0}</td>
                                                <td className="text-center">{statsToShow.goalsAgainst || 0}</td>
                                            </tr>
                                        );
                                    })()}
                                </tbody>
                            </table>
                        ) : (
                            // SKATER STATS - Toggle between Basic and Advanced
                            !playerAdvancedStats ? (
                                // BASIC STATS
                                <table className="stats-table">
                                    <thead>
                                        <tr>
                                            <th className="text-center" title="Games Played">GP</th>
                                            <th className="text-center" title="Goals">G</th>
                                            <th className="text-center" title="Assists">A</th>
                                            <th className="text-center" title="Points - Goals + Assists">PTS</th>
                                            <th className="text-center" title="Plus/Minus - On ice goal differential (goals for minus goals against)">+/-</th>
                                            <th className="text-center" title="Penalty Minutes">PIM</th>
                                            <th className="text-center" title="Shots On Goal">SOG</th>
                                            <th className="text-center" title="Time On Ice Per Game - Average ice time per game">TOI/G</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {(() => {
                                            const statsToShow = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                            return (
                                                <tr>
                                                    <td className="text-center">{statsToShow.gamesPlayed}</td>
                                                    <td className="text-center">{statsToShow.goals}</td>
                                                    <td className="text-center">{statsToShow.assists}</td>
                                                    <td className="text-center">{statsToShow.points}</td>
                                                    <td className="text-center">{statsToShow.plusMinus > 0 ? '+' : ''}{statsToShow.plusMinus}</td>
                                                    <td className="text-center">{statsToShow.pim}</td>
                                                    <td className="text-center">{statsToShow.shots}</td>
                                                    <td className="text-center">
                                                        {statsToShow.gamesPlayed > 0 
                                                            ? formatTOI(statsToShow.timeOnIce / statsToShow.gamesPlayed)
                                                            : '0:00'}
                                                    </td>
                                                </tr>
                                            );
                                        })()}
                                    </tbody>
                                </table>
                            ) : (
                                // ADVANCED STATS
                                <div>
                                    <h4 style={{ color: '#22d3ee', marginTop: '1rem', marginBottom: '0.75rem' }}>
                                        üéØ Possession & Shot Metrics
                                    </h4>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="text-center" title="Games Played">GP</th>
                                                <th className="text-center" title="Corsi For - Shot attempts for while player is on ice (includes shots, missed shots, and blocked shots)">CF</th>
                                                <th className="text-center" title="Corsi Against - Shot attempts against while player is on ice">CA</th>
                                                <th className="text-center" title="Corsi Percentage - CF / (CF + CA) √ó 100. Measures puck possession. Above 50% is good.">CF%</th>
                                                <th className="text-center" title="Fenwick For - Unblocked shot attempts for while player is on ice (shots + missed shots, excludes blocked)">FF</th>
                                                <th className="text-center" title="Fenwick Against - Unblocked shot attempts against while player is on ice">FA</th>
                                                <th className="text-center" title="Fenwick Percentage - FF / (FF + FA) √ó 100. Quality possession metric. Above 50% is good.">FF%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const statsToShow = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                                return (
                                                    <tr>
                                                        <td className="text-center">{statsToShow.gamesPlayed || 0}</td>
                                                        <td className="text-center">{statsToShow.corsiFor || 0}</td>
                                                        <td className="text-center">{statsToShow.corsiAgainst || 0}</td>
                                                        <td className="text-center" style={{ 
                                                            fontWeight: 'bold',
                                                            color: (statsToShow.corsiPercent || 50) >= 50 ? '#22c55e' : '#ef4444'
                                                        }}>
                                                            {(statsToShow.corsiPercent || 0).toFixed(1)}%
                                                        </td>
                                                        <td className="text-center">{statsToShow.fenwickFor || 0}</td>
                                                        <td className="text-center">{statsToShow.fenwickAgainst || 0}</td>
                                                        <td className="text-center" style={{ 
                                                            fontWeight: 'bold',
                                                            color: (statsToShow.fenwickPercent || 50) >= 50 ? '#22c55e' : '#ef4444'
                                                        }}>
                                                            {(statsToShow.fenwickPercent || 0).toFixed(1)}%
                                                        </td>
                                                    </tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                    
                                    <h4 style={{ color: '#22d3ee', marginTop: '1.5rem', marginBottom: '0.75rem' }}>
                                        üí• Physical Play & Puck Skills
                                    </h4>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th className="text-center" title="Games Played">GP</th>
                                                <th className="text-center" title="Hits - Physical body checks delivered">Hits</th>
                                                <th className="text-center" title="Hits Per Game - Average hits per game">Hits/G</th>
                                                <th className="text-center" title="Blocked Shots - Shots blocked while defending">Blk</th>
                                                <th className="text-center" title="Blocks Per Game - Average blocked shots per game">Blk/G</th>
                                                <th className="text-center" title="Takeaways - Pucks stolen from opponent">TK</th>
                                                <th className="text-center" title="Giveaways - Turnovers / pucks lost to opponent">GV</th>
                                                <th className="text-center" title="Takeaway/Giveaway Ratio - TK √∑ GV. Above 1.0 is good (more takeaways than giveaways)">TK/GV</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const statsToShow = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                                const gp = statsToShow.gamesPlayed || 1;
                                                const tkgv = (statsToShow.giveaways || 0) > 0 
                                                    ? ((statsToShow.takeaways || 0) / (statsToShow.giveaways || 1)).toFixed(2)
                                                    : (statsToShow.takeaways || 0).toFixed(2);
                                                return (
                                                    <tr>
                                                        <td className="text-center">{statsToShow.gamesPlayed || 0}</td>
                                                        <td className="text-center">{statsToShow.hits || 0}</td>
                                                        <td className="text-center">{((statsToShow.hits || 0) / gp).toFixed(1)}</td>
                                                        <td className="text-center">{statsToShow.blockedShots || 0}</td>
                                                        <td className="text-center">{((statsToShow.blockedShots || 0) / gp).toFixed(1)}</td>
                                                        <td className="text-center">{statsToShow.takeaways || 0}</td>
                                                        <td className="text-center">{statsToShow.giveaways || 0}</td>
                                                        <td className="text-center" style={{
                                                            fontWeight: 'bold',
                                                            color: parseFloat(tkgv) >= 1.0 ? '#22c55e' : '#ef4444'
                                                        }}>
                                                            {tkgv}
                                                        </td>
                                                    </tr>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                    
                                    {selectedPlayerProfile.preferredPosition === 'C' && (
                                        <>
                                            <h4 style={{ color: '#22d3ee', marginTop: '1.5rem', marginBottom: '0.75rem' }}>
                                                üèí Faceoffs
                                            </h4>
                                            <table className="stats-table">
                                                <thead>
                                                    <tr>
                                                        <th className="text-center" title="Games Played">GP</th>
                                                        <th className="text-center" title="Faceoffs Won - Faceoffs won by this center">FO Won</th>
                                                        <th className="text-center" title="Faceoffs Lost - Faceoffs lost by this center">FO Lost</th>
                                                        <th className="text-center" title="Total Faceoffs - All faceoffs taken">FO Total</th>
                                                        <th className="text-center" title="Faceoff Percentage - FO Won √∑ FO Total √ó 100. Above 50% is good.">FO%</th>
                                                        <th className="text-center" title="Faceoffs Per Game - Average faceoffs taken per game">FO/G</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {(() => {
                                                        const statsToShow = playerStatMode === 'playoffs' ? selectedPlayerProfile.playoffStats : selectedPlayerProfile.stats;
                                                        const foTotal = (statsToShow.faceoffWins || 0) + (statsToShow.faceoffLosses || 0);
                                                        const gp = statsToShow.gamesPlayed || 1;
                                                        return (
                                                            <tr>
                                                                <td className="text-center">{statsToShow.gamesPlayed || 0}</td>
                                                                <td className="text-center">{statsToShow.faceoffWins || 0}</td>
                                                                <td className="text-center">{statsToShow.faceoffLosses || 0}</td>
                                                                <td className="text-center">{foTotal}</td>
                                                                <td className="text-center" style={{
                                                                    fontWeight: 'bold',
                                                                    color: (statsToShow.faceoffPercent || 0) >= 50 ? '#22c55e' : '#ef4444'
                                                                }}>
                                                                    {(statsToShow.faceoffPercent || 0).toFixed(1)}%
                                                                </td>
                                                                <td className="text-center">{(foTotal / gp).toFixed(1)}</td>
                                                            </tr>
                                                        );
                                                    })()}
                                                </tbody>
                                            </table>
                                        </>
                                    )}
                                </div>
                            )
                        )}

                        {selectedPlayerProfile.careerStats && selectedPlayerProfile.careerStats.length > 0 && (
                            <>
                                <h3 style={{ marginTop: '2rem' }}>
                                    Career {playerStatMode === 'playoffs' ? 'Playoff' : 'Regular Season'} Stats by Season
                                </h3>
                                
                                {(() => {
                                    // Filter career stats based on current mode
                                    const filteredStats = selectedPlayerProfile.careerStats.filter(s => 
                                        playerStatMode === 'playoffs' ? s.type === 'Playoffs' : s.type === 'Regular'
                                    );
                                    
                                    if (filteredStats.length === 0) {
                                        return (
                                            <div style={{ 
                                                padding: '2rem', 
                                                textAlign: 'center', 
                                                color: '#64748b',
                                                fontStyle: 'italic'
                                            }}>
                                                No {playerStatMode === 'playoffs' ? 'playoff' : 'regular season'} history
                                            </div>
                                        );
                                    }
                                    
                                    return selectedPlayerProfile.position === 'G' ? (
                                    // GOALIE CAREER STATS BY SEASON
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th>Year</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">W</th>
                                                <th className="text-center">L</th>
                                                <th className="text-center">SV%</th>
                                                <th className="text-center">GAA</th>
                                                <th className="text-center">SO</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredStats.map((seasonStats, idx) => {
                                                return (
                                                    <tr key={idx}>
                                                        <td>{seasonStats.year || seasonStats.season}</td>
                                                        <td>{seasonStats.teamName}</td>
                                                        <td className="text-center">{seasonStats.gamesPlayed || 0}</td>
                                                        <td className="text-center">{seasonStats?.wins || 0}</td>
                                                        <td className="text-center">{seasonStats?.losses || 0}</td>
                                                        <td className="text-center">
                                                            {seasonStats.savePercentage ? seasonStats.savePercentage.toFixed(3) : '.000'}
                                                        </td>
                                                        <td className="text-center">
                                                            {seasonStats.gaa ? seasonStats.gaa.toFixed(2) : '0.00'}
                                                        </td>
                                                        <td className="text-center">{seasonStats.shutouts || 0}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                ) : (
                                    // SKATER CAREER STATS BY SEASON
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th>Year</th>
                                                <th>Team</th>
                                                <th className="text-center">GP</th>
                                                <th className="text-center">G</th>
                                                <th className="text-center">A</th>
                                                <th className="text-center">PTS</th>
                                                <th className="text-center">+/-</th>
                                                <th className="text-center">PIM</th>
                                                <th className="text-center">SOG</th>
                                                <th className="text-center">TOI/G</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredStats.map((seasonStats, idx) => {
                                                const avgTOI = seasonStats.gamesPlayed > 0 ? seasonStats.timeOnIce / seasonStats.gamesPlayed : 0;
                                                return (
                                                    <tr key={idx}>
                                                        <td>{seasonStats.year || seasonStats.season}</td>
                                                        <td>{seasonStats.teamName}</td>
                                                        <td className="text-center">{seasonStats.gamesPlayed}</td>
                                                        <td className="text-center">{seasonStats.goals}</td>
                                                        <td className="text-center">{seasonStats.assists}</td>
                                                        <td className="text-center">{seasonStats.points}</td>
                                                        <td className="text-center">{seasonStats.plusMinus > 0 ? '+' : ''}{seasonStats.plusMinus}</td>
                                                        <td className="text-center">{seasonStats.pim}</td>
                                                        <td className="text-center">{seasonStats.shots}</td>
                                                        <td className="text-center">{formatTOI(avgTOI)}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                );
                                })()}
                            </>
                        )}

                        <h3 style={{ marginTop: '2rem' }}>
                            Career {playerStatMode === 'playoffs' ? 'Playoff' : 'Regular Season'} Totals
                        </h3>
                        
                        {selectedPlayerProfile.position === 'G' ? (
                            // GOALIE CAREER TOTALS
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">W</th>
                                        <th className="text-center">L</th>
                                        <th className="text-center">SV%</th>
                                        <th className="text-center">GAA</th>
                                        <th className="text-center">SO</th>
                                        <th className="text-center">SA</th>
                                        <th className="text-center">SV</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        // Get archived career totals
                                        const archivedTotals = playerStatMode === 'playoffs' 
                                            ? selectedPlayerProfile.careerTotals?.playoffs 
                                            : selectedPlayerProfile.careerTotals?.regularSeason;
                                        const archivedGoalieStats = selectedPlayerProfile.careerTotals?.goalieStats;
                                        
                                        // Get current season stats
                                        const currentStats = playerStatMode === 'playoffs' 
                                            ? selectedPlayerProfile.playoffStats 
                                            : selectedPlayerProfile.stats;
                                        
                                        // If no archived AND no current stats
                                        if ((!archivedTotals || archivedTotals.gamesPlayed === 0) && 
                                            (!currentStats || currentStats.gamesPlayed === 0)) {
                                            return (
                                                <tr>
                                                    <td className="text-center" colSpan="8" style={{ color: '#64748b', fontStyle: 'italic' }}>
                                                        No {playerStatMode === 'playoffs' ? 'playoff' : 'career'} stats yet
                                                    </td>
                                                </tr>
                                            );
                                        }
                                        
                                        // Combine archived + current season
                                        const totalGP = (archivedGoalieStats?.gamesPlayed || 0) + (currentStats?.gamesPlayed || 0);
                                        const totalW = (archivedGoalieStats?.wins || 0) + (currentStats?.wins || 0);
                                        const totalL = (archivedGoalieStats?.losses || 0) + (currentStats?.losses || 0);
                                        const totalSO = (archivedGoalieStats?.shutouts || 0) + (currentStats?.shutouts || 0);
                                        const totalSA = (archivedGoalieStats?.shotsAgainst || 0) + (currentStats?.shotsAgainst || 0);
                                        const totalSV = (archivedGoalieStats?.saves || 0) + (currentStats?.saves || 0);
                                        const totalGA = (archivedGoalieStats?.goalsAgainst || 0) + (currentStats?.goalsAgainst || 0);
                                        
                                        const savePercentage = totalSA > 0 ? totalSV / totalSA : 0;
                                        const gaa = totalGP > 0 ? totalGA / totalGP : 0;
                                        
                                        return (
                                            <tr>
                                                <td className="text-center">{totalGP}</td>
                                                <td className="text-center">{totalW}</td>
                                                <td className="text-center">{totalL}</td>
                                                <td className="text-center">{savePercentage.toFixed(3)}</td>
                                                <td className="text-center">{gaa.toFixed(2)}</td>
                                                <td className="text-center">{totalSO}</td>
                                                <td className="text-center">{totalSA}</td>
                                                <td className="text-center">{totalSV}</td>
                                            </tr>
                                        );
                                    })()}
                                </tbody>
                            </table>
                        ) : (
                            // SKATER CAREER TOTALS
                            <table className="stats-table">
                                <thead>
                                    <tr>
                                        <th className="text-center">GP</th>
                                        <th className="text-center">G</th>
                                        <th className="text-center">A</th>
                                        <th className="text-center">PTS</th>
                                        <th className="text-center">+/-</th>
                                        <th className="text-center">PIM</th>
                                        <th className="text-center">SOG</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {(() => {
                                        // Use pre-calculated career totals based on mode
                                        const archivedTotals = playerStatMode === 'playoffs' 
                                            ? selectedPlayerProfile.careerTotals?.playoffs 
                                            : selectedPlayerProfile.careerTotals?.regularSeason;
                                        
                                        const currentStats = playerStatMode === 'playoffs' 
                                            ? selectedPlayerProfile.playoffStats 
                                            : selectedPlayerProfile.stats;
                                        
                                        // If no archived totals AND no current stats
                                        if ((!archivedTotals || archivedTotals.gamesPlayed === 0) && 
                                            (!currentStats || currentStats.gamesPlayed === 0)) {
                                            return (
                                                <tr>
                                                    <td className="text-center" colSpan="7" style={{ color: '#64748b', fontStyle: 'italic' }}>
                                                        No {playerStatMode === 'playoffs' ? 'playoff' : 'career'} stats yet
                                                    </td>
                                                </tr>
                                            );
                                        }
                                        
                                        // Combine archived career totals + current season
                                        const totalGP = (archivedTotals?.gamesPlayed || 0) + (currentStats?.gamesPlayed || 0);
                                        const totalG = (archivedTotals?.goals || 0) + (currentStats?.goals || 0);
                                        const totalA = (archivedTotals?.assists || 0) + (currentStats?.assists || 0);
                                        const totalPTS = (archivedTotals?.points || 0) + (currentStats?.points || 0);
                                        const totalPM = (archivedTotals?.plusMinus || 0) + (currentStats?.plusMinus || 0);
                                        const totalPIM = (archivedTotals?.pim || 0) + (currentStats?.pim || 0);
                                        const totalSOG = (archivedTotals?.shots || 0) + (currentStats?.shots || 0);
                                        
                                        return (
                                            <tr>
                                                <td className="text-center">{totalGP}</td>
                                                <td className="text-center">{totalG}</td>
                                                <td className="text-center">{totalA}</td>
                                                <td className="text-center">{totalPTS}</td>
                                                <td className="text-center">{totalPM > 0 ? '+' : ''}{totalPM}</td>
                                                <td className="text-center">{totalPIM}</td>
                                                <td className="text-center">{totalSOG}</td>
                                            </tr>
                                        );
                                    })()}
                                </tbody>
                            </table>
                        )}
                        
                        {/* Milestones Section - DEBUG */}
                        <div>
                            <h3 style={{ marginTop: '2rem', color: '#f59e0b' }}>üèÜ Career Milestones</h3>
                            {!selectedPlayerProfile.milestones && (
                                <div style={{ padding: '1rem', background: 'rgba(239, 68, 68, 0.1)', borderRadius: '0.5rem', marginTop: '1rem' }}>
                                    <p style={{ color: '#f87171' }}>DEBUG: No milestones array found on player object</p>
                                </div>
                            )}
                            {selectedPlayerProfile.milestones && selectedPlayerProfile.milestones.length === 0 && (
                                <div style={{ padding: '1rem', background: 'rgba(250, 204, 21, 0.1)', borderRadius: '0.5rem', marginTop: '1rem' }}>
                                    <p style={{ color: '#fbbf24' }}>No milestones achieved yet. Player has {selectedPlayerProfile.stats?.gamesPlayed || 0} games played, {selectedPlayerProfile.stats?.goals || 0} goals, {selectedPlayerProfile.stats?.points || 0} points.</p>
                                </div>
                            )}
                            {selectedPlayerProfile.milestones && selectedPlayerProfile.milestones.length > 0 && (
                                <div style={{ 
                                    display: 'grid', 
                                    gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', 
                                    gap: '1rem',
                                    marginTop: '1rem'
                                }}>
                                    {selectedPlayerProfile.milestones
                                        .sort((a, b) => {
                                            const aGame = a.careerGame || 0;
                                            const bGame = b.careerGame || 0;
                                            return bGame - aGame;
                                        })
                                        .map((milestone, idx) => (
                                            <div key={idx} style={{
                                                padding: '1rem',
                                                background: 'rgba(245, 158, 11, 0.1)',
                                                borderRadius: '0.5rem',
                                                border: '1px solid rgba(245, 158, 11, 0.3)'
                                            }}>
                                                <div style={{ 
                                                    fontWeight: 'bold', 
                                                    color: '#fbbf24',
                                                    marginBottom: '0.5rem',
                                                    fontSize: '1rem'
                                                }}>
                                                    {milestone.description}
                                                </div>
                                                <div style={{ 
                                                    fontSize: '0.875rem', 
                                                    color: '#94a3b8' 
                                                }}>
                                                    {milestone.seasonGame && milestone.careerGame ? (
                                                        <div>
                                                            Season {milestone.season || 1}, Game {milestone.seasonGame}
                                                            <br />
                                                            <span style={{ fontSize: '0.75rem', color: '#64748b' }}>
                                                                ({milestone.careerGame} career games)
                                                            </span>
                                                        </div>
                                                    ) : (
                                                        <div>Season {milestone.season || 1}, Day {milestone.day}</div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                </div>
                            )}
                        </div>
                        
                        {/* Transactions Section */}
                        {selectedPlayerProfile.tradeHistory && selectedPlayerProfile.tradeHistory.length > 0 && (
                            <>
                                <h3 style={{ marginTop: '2rem', color: '#3b82f6' }}>üîÑ Transaction History</h3>
                                <div style={{ 
                                    display: 'flex', 
                                    flexDirection: 'column', 
                                    gap: '1rem',
                                    marginTop: '1rem'
                                }}>
                                    {selectedPlayerProfile.tradeHistory
                                        .sort((a, b) => {
                                            // Sort by season, then by day
                                            if (b.season !== a.season) return b.season - a.season;
                                            return b.day - a.day;
                                        })
                                        .map((trade, idx) => {
                                            const fromTeam = getTeam(trade.from);
                                            const toTeam = getTeam(trade.to);
                                            
                                            return (
                                                <div key={idx} style={{
                                                    padding: '1.25rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    border: '1px solid rgba(59, 130, 246, 0.3)'
                                                }}>
                                                    <div style={{ 
                                                        fontWeight: 'bold', 
                                                        color: '#60a5fa',
                                                        marginBottom: '0.75rem',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center'
                                                    }}>
                                                        <span>
                                                            {fromTeam?.city} {fromTeam?.name} ‚Üí {toTeam?.city} {toTeam?.name}
                                                        </span>
                                                        <span style={{ 
                                                            fontSize: '0.875rem',
                                                            color: '#93c5fd',
                                                            fontWeight: 'normal'
                                                        }}>
                                                            Day {trade.day}, Season {trade.season} ({trade.year})
                                                        </span>
                                                    </div>
                                                    
                                                    <div style={{ 
                                                        color: '#e2e8f0',
                                                        lineHeight: '1.6'
                                                    }}>
                                                        {/* Show who was traded together */}
                                                        {trade.tradedWith && trade.tradedWith.length > 0 && (
                                                            <div style={{ marginBottom: '0.5rem' }}>
                                                                <span style={{ color: '#93c5fd' }}>Traded with: </span>
                                                                {trade.tradedWith.map((player, i) => {
                                                                    const fullPlayer = gameState.players.find(p => p.id === player.id);
                                                                    return (
                                                                        <span key={i}>
                                                                            {fullPlayer ? (
                                                                                <span 
                                                                                    className="clickable-player"
                                                                                    onClick={() => navigateTo('playerProfile', fullPlayer)}
                                                                                >
                                                                                    {player.name}
                                                                                </span>
                                                                            ) : (
                                                                                <span>{player.name}</span>
                                                                            )}
                                                                            <span style={{ color: '#93c5fd' }}> ({player.position})</span>
                                                                            {i < trade.tradedWith.length - 1 ? ', ' : ''}
                                                                        </span>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Show who they were traded for */}
                                                        {trade.tradedFor && trade.tradedFor.length > 0 && (
                                                            <div>
                                                                <span style={{ color: '#93c5fd' }}>In exchange for: </span>
                                                                {trade.tradedFor.map((player, i) => {
                                                                    const fullPlayer = gameState.players.find(p => p.id === player.id);
                                                                    return (
                                                                        <span key={i}>
                                                                            {fullPlayer ? (
                                                                                <span 
                                                                                    className="clickable-player"
                                                                                    onClick={() => navigateTo('playerProfile', fullPlayer)}
                                                                                >
                                                                                    {player.name}
                                                                                </span>
                                                                            ) : (
                                                                                <span>{player.name}</span>
                                                                            )}
                                                                            <span style={{ color: '#93c5fd' }}> ({player.position})</span>
                                                                            {i < trade.tradedFor.length - 1 ? ', ' : ''}
                                                                        </span>
                                                                    );
                                                                })}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                </div>
                            </>
                        )}
                    </div>
                    </div>
                    );
                })()}

                {currentView === 'teamProfile' && selectedTeamProfile && gameState && gameState.standings && (
                    <div>
                        <button 
                            onClick={goBack}
                            style={{
                                padding: '0.5rem 1rem',
                                background: '#2563eb',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                marginBottom: '1rem',
                                fontWeight: 'bold'
                            }}
                        >
                            ‚Üê Back
                        </button>
                        {(() => {
                            const team = TEAMS.find(t => t.id === selectedTeamProfile);
                            const teamStanding = gameState.standings.find(s => s.teamId === selectedTeamProfile);
                            const teamRoster = gameState.players.filter(p => p.teamId === selectedTeamProfile);
                            
                            // Check if team or standing exists
                            if (!team || !teamStanding) {
                                return <div style={{padding: '2rem', textAlign: 'center', color: '#ef4444'}}>
                                    <p>Team data not found</p>
                                </div>;
                            }
                            
                            // Extract all games for this team from the schedule (which is organized by day)
                            const teamSchedule = [];
                            gameState.schedule.forEach(daySchedule => {
                                daySchedule.matchups.forEach(matchup => {
                                    if (matchup.homeTeam === selectedTeamProfile || matchup.awayTeam === selectedTeamProfile) {
                                        teamSchedule.push({
                                            ...matchup,
                                            day: daySchedule.day
                                        });
                                    }
                                });
                            });
                            
                            const gp = teamStanding?.wins + teamStanding?.losses + teamStanding?.otLosses;
                            const diff = teamStanding.goalsFor - teamStanding.goalsAgainst;

                            return (
                                <>
                                    <div className="card">
                                        <h2>{team.city} {team.name}</h2>
                                        <div style={{ marginBottom: '1.5rem', padding: '1rem', background: 'rgba(30, 58, 138, 0.3)', borderRadius: '0.5rem' }}>
                                            <p style={{ marginBottom: '0.5rem' }}><strong>Conference:</strong> {team.conference}</p>
                                            <p style={{ marginBottom: '0.5rem' }}><strong>Division:</strong> {team.division}</p>
                                            <p style={{ marginBottom: '0.5rem' }}><strong>Record:</strong> {teamStanding?.wins}-{teamStanding?.losses}-{teamStanding?.otLosses} ({teamStanding.points} pts)</p>
                                            <p style={{ marginBottom: '0.5rem' }}><strong>Games Played:</strong> {gp}/82</p>
                                            <p style={{ marginBottom: '0.5rem' }}><strong>Home:</strong> {teamStanding.home?.wins}-{teamStanding.home?.losses} | <strong>Away:</strong> {teamStanding.away?.wins}-{teamStanding.away?.losses}</p>
                                            <p><strong>Goal Differential:</strong> {diff > 0 ? '+' : ''}{diff} ({teamStanding.goalsFor} GF, {teamStanding.goalsAgainst} GA)</p>
                                        </div>
                                        
                                        {/* Team Profile Card */}
                                        {(() => {
                                            const profile = gameState.teamProfiles?.find(p => p.teamId === selectedTeamProfile);
                                            if (!profile) return null;
                                            
                                            const capStatus = calculateTeamCapHit(selectedTeamProfile, gameState.players);
                                            const topPlayers = teamRoster
                                                .filter(p => p.roster === 'nhl')
                                                .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                .slice(0, 3);
                                            
                                            // Status color
                                            const statusColor = profile.status === 'Contend' ? '#22c55e' :
                                                               profile.status === 'Compete' ? '#60a5fa' : '#f59e0b';
                                            
                                            return (
                                                <div style={{
                                                    marginTop: '1.5rem',
                                                    padding: '1.5rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    border: '2px solid rgba(59, 130, 246, 0.3)',
                                                    borderRadius: '0.5rem'
                                                }}>
                                                    <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>üìä Team Profile</h3>
                                                    
                                                    <div style={{
                                                        display: 'grid',
                                                        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                                        gap: '1rem',
                                                        marginBottom: '1.5rem'
                                                    }}>
                                                        <div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                                Team Status
                                                            </div>
                                                            <div style={{
                                                                fontSize: '1.3rem',
                                                                fontWeight: 'bold',
                                                                color: statusColor
                                                            }}>
                                                                {profile.status}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                                Playoff Probability
                                                            </div>
                                                            <div style={{
                                                                fontSize: '1.3rem',
                                                                fontWeight: 'bold',
                                                                color: profile.playoffProbability >= 70 ? '#22c55e' :
                                                                       profile.playoffProbability >= 40 ? '#fbbf24' : '#ef4444'
                                                            }}>
                                                                {profile.playoffProbability.toFixed(0)}%
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                                Trade Deadline
                                                            </div>
                                                            <div style={{
                                                                fontSize: '1.1rem',
                                                                fontWeight: 'bold',
                                                                color: profile.tradeDeadlineApproach.includes('Buyer') ? '#22c55e' :
                                                                       profile.tradeDeadlineApproach.includes('Seller') ? '#ef4444' : '#94a3b8'
                                                            }}>
                                                                {profile.tradeDeadlineApproach}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                                Budget Sensitivity
                                                            </div>
                                                            <div style={{
                                                                fontSize: '1.1rem',
                                                                fontWeight: 'bold',
                                                                color: '#e2e8f0'
                                                            }}>
                                                                {profile.budgetSensitivity}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                                Prospect Bias
                                                            </div>
                                                            <div style={{
                                                                fontSize: '1.1rem',
                                                                fontWeight: 'bold',
                                                                color: '#e2e8f0'
                                                            }}>
                                                                {profile.prospectBias}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                                Cap Space
                                                            </div>
                                                            <div style={{
                                                                fontSize: '1.1rem',
                                                                fontWeight: 'bold',
                                                                color: capStatus.capSpace >= 0 ? '#22c55e' : '#ef4444'
                                                            }}>
                                                                {formatSalary(capStatus.capSpace)}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                            Top 3 Players
                                                        </div>
                                                        <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                                            {topPlayers.map((p, idx) => (
                                                                <div
                                                                    key={p.id}
                                                                    style={{
                                                                        padding: '0.5rem 1rem',
                                                                        background: 'rgba(34, 197, 94, 0.1)',
                                                                        border: '1px solid rgba(34, 197, 94, 0.3)',
                                                                        borderRadius: '0.375rem',
                                                                        cursor: 'pointer'
                                                                    }}
                                                                    onClick={() => navigateTo('playerProfile', p)}
                                                                >
                                                                    <div style={{ fontWeight: 'bold', color: '#22c55e' }}>
                                                                        #{idx + 1} {p.firstName} {p.lastName}
                                                                    </div>
                                                                    <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                                                        {p.position} ‚Ä¢ {p.ratings.overall} OVR
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Top 3 Prospects */}
                                                    {(() => {
                                                        // Get farm team for this NHL team
                                                        const farmTeam = FARM_TEAMS.find(ft => ft.nhlAffiliation === selectedTeamProfile);
                                                        if (!farmTeam) return null;
                                                        
                                                        // Get farm players and calculate prospect value
                                                        const farmPlayers = gameState.players.filter(p => p.teamId === farmTeam.id);
                                                        
                                                        // Calculate prospect value: age, potential, current skill, salary
                                                        const prospectsWithValue = farmPlayers.map(p => {
                                                            let value = 0;
                                                            
                                                            // Potential is most important (40%)
                                                            value += p.ratings.potential * 0.4;
                                                            
                                                            // Current skill (30%)
                                                            value += p.ratings.overall * 0.3;
                                                            
                                                            // Age factor - younger is better (20%)
                                                            const ageFactor = p.age <= 20 ? 20 :
                                                                             p.age <= 22 ? 15 :
                                                                             p.age <= 24 ? 10 :
                                                                             p.age <= 26 ? 5 : 0;
                                                            value += ageFactor;
                                                            
                                                            // Upside (POT - OVR gap) (10%)
                                                            const upside = p.ratings.potential - p.ratings.overall;
                                                            value += upside * 0.5;
                                                            
                                                            return { player: p, value };
                                                        });
                                                        
                                                        const topProspects = prospectsWithValue
                                                            .sort((a, b) => b.value - a.value)
                                                            .slice(0, 3);
                                                        
                                                        if (topProspects.length === 0) return null;
                                                        
                                                        return (
                                                            <div style={{ marginTop: '1.5rem' }}>
                                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                                    Top 3 Prospects (NAMHL)
                                                                </div>
                                                                <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                                                    {topProspects.map(({ player: p }, idx) => {
                                                                        const upside = p.ratings.potential - p.ratings.overall;
                                                                        return (
                                                                            <div
                                                                                key={p.id}
                                                                                style={{
                                                                                    padding: '0.5rem 1rem',
                                                                                    background: 'rgba(96, 165, 250, 0.1)',
                                                                                    border: '1px solid rgba(96, 165, 250, 0.3)',
                                                                                    borderRadius: '0.375rem',
                                                                                    cursor: 'pointer',
                                                                                    minWidth: '150px'
                                                                                }}
                                                                                onClick={() => navigateTo('playerProfile', p)}
                                                                            >
                                                                                <div style={{ fontWeight: 'bold', color: '#60a5fa' }}>
                                                                                    #{idx + 1} {p.firstName} {p.lastName}
                                                                                </div>
                                                                                <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                                                                    {p.position} ‚Ä¢ Age {p.age}
                                                                                </div>
                                                                                <div style={{ fontSize: '0.8rem', color: '#e2e8f0' }}>
                                                                                    {p.ratings.overall} OVR ‚Üí {p.ratings.potential} POT
                                                                                </div>
                                                                                {upside >= 10 && (
                                                                                    <div style={{ 
                                                                                        fontSize: '0.75rem', 
                                                                                        color: '#22c55e',
                                                                                        fontWeight: 'bold'
                                                                                    }}>
                                                                                        +{upside} Upside
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        );
                                                    })()}
                                                </div>
                                            );
                                        })()}
                                    </div>

                                    <div className="card">
                                        <h2>Roster</h2>
                                        <h3>Forwards ({teamRoster.filter(p => p.position === 'F').length})</h3>
                                        <table className="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Player</th>
                                                    <th className="text-center">Age</th>
                                                    <th className="text-center">OVR</th>
                                                    <th className="text-center">GP</th>
                                                    <th className="text-center">G</th>
                                                    <th className="text-center">A</th>
                                                    <th className="text-center">PTS</th>
                                                    <th className="text-center">+/-</th>
                                                    <th className="text-center">PIM</th>
                                                    <th className="text-center">TOI/G</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {teamRoster
                                                    .filter(p => p.position === 'F')
                                                    .sort((a, b) => b.stats.points - a.stats.points)
                                                    .map(player => {
                                                        const avgTOI = player.stats.gamesPlayed > 0 ? player.stats.timeOnIce / player.stats.gamesPlayed : 0;
                                                        return (
                                                            <tr key={player.id}>
                                                                <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                    {player.firstName} {player.lastName}
                                                                </td>
                                                                <td className="text-center">{player.age}</td>
                                                                <td className="text-center">{player.ratings.overall}</td>
                                                                <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                <td className="text-center">{player.stats.goals}</td>
                                                                <td className="text-center">{player.stats.assists}</td>
                                                                <td className="text-center">{player.stats.points}</td>
                                                                <td className="text-center">{player.stats.plusMinus > 0 ? '+' : ''}{player.stats.plusMinus}</td>
                                                                <td className="text-center">{player.stats.pim}</td>
                                                                <td className="text-center">{formatTOI(avgTOI)}</td>
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>

                                        <h3>Defensemen ({teamRoster.filter(p => p.position === 'D').length})</h3>
                                        <table className="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Player</th>
                                                    <th className="text-center">Age</th>
                                                    <th className="text-center">OVR</th>
                                                    <th className="text-center">GP</th>
                                                    <th className="text-center">G</th>
                                                    <th className="text-center">A</th>
                                                    <th className="text-center">PTS</th>
                                                    <th className="text-center">+/-</th>
                                                    <th className="text-center">PIM</th>
                                                    <th className="text-center">TOI/G</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {teamRoster
                                                    .filter(p => p.position === 'D')
                                                    .sort((a, b) => b.stats.points - a.stats.points)
                                                    .map(player => {
                                                        const avgTOI = player.stats.gamesPlayed > 0 ? player.stats.timeOnIce / player.stats.gamesPlayed : 0;
                                                        return (
                                                            <tr key={player.id}>
                                                                <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                    {player.firstName} {player.lastName}
                                                                </td>
                                                                <td className="text-center">{player.age}</td>
                                                                <td className="text-center">{player.ratings.overall}</td>
                                                                <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                <td className="text-center">{player.stats.goals}</td>
                                                                <td className="text-center">{player.stats.assists}</td>
                                                                <td className="text-center">{player.stats.points}</td>
                                                                <td className="text-center">{player.stats.plusMinus > 0 ? '+' : ''}{player.stats.plusMinus}</td>
                                                                <td className="text-center">{player.stats.pim}</td>
                                                                <td className="text-center">{formatTOI(avgTOI)}</td>
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>

                                        <h3>Goalies ({teamRoster.filter(p => p.position === 'G').length})</h3>
                                        <table className="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Player</th>
                                                    <th className="text-center">Age</th>
                                                    <th className="text-center">OVR</th>
                                                    <th className="text-center">GP</th>
                                                    <th className="text-center">W</th>
                                                    <th className="text-center">L</th>
                                                    <th className="text-center">SV%</th>
                                                    <th className="text-center">GAA</th>
                                                    <th className="text-center">SO</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {teamRoster
                                                    .filter(p => p.position === 'G')
                                                    .sort((a, b) => b.ratings.overall - a.ratings.overall)
                                                    .map(player => {
                                                        return (
                                                            <tr key={player.id}>
                                                                <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                    {player.firstName} {player.lastName}
                                                                </td>
                                                                <td className="text-center">{player.age}</td>
                                                                <td className="text-center">{player.ratings.overall}</td>
                                                                <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                <td className="text-center">{player.stats?.wins || 0}</td>
                                                                <td className="text-center">{player.stats?.losses || 0}</td>
                                                                <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.savePercentage || 0).toFixed(3) : '.000'}</td>
                                                                <td className="text-center">{player.stats.gamesPlayed > 0 ? (player.stats.gaa || 0).toFixed(2) : '0.00'}</td>
                                                                <td className="text-center">{player.stats.shutouts || 0}</td>
                                                            </tr>
                                                        );
                                                    })}
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="card">
                                        <h2>Head-to-Head Records</h2>
                                        <p style={{ color: '#93c5fd', marginBottom: '1rem' }}>
                                            Season series records against all opponents
                                        </p>
                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1rem' }}>
                                            {TEAMS
                                                .filter(t => t.id !== selectedTeamProfile)
                                                .sort((a, b) => a.city.localeCompare(b.city))
                                                .map(opponent => {
                                                    const h2hKey = selectedTeamProfile < opponent.id ? 
                                                        `${selectedTeamProfile}vs${opponent.id}` : 
                                                        `${opponent.id}vs${selectedTeamProfile}`;
                                                    
                                                    const h2h = gameState.headToHead?.[h2hKey];
                                                    
                                                    if (!h2h) {
                                                        return (
                                                            <div key={opponent.id} style={{ 
                                                                padding: '0.75rem',
                                                                background: 'rgba(30, 58, 138, 0.2)',
                                                                borderRadius: '0.375rem',
                                                                border: '1px solid rgba(59, 130, 246, 0.3)'
                                                            }}>
                                                                <div style={{ fontWeight: 'bold', marginBottom: '0.25rem', color: '#93c5fd' }}>
                                                                    vs {opponent.city} {opponent.name}
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#94a3b8' }}>
                                                                    No games played yet
                                                                </div>
                                                            </div>
                                                        );
                                                    }
                                                    
                                                    const myWins = h2h.team1 === selectedTeamProfile ? h2h.team1Wins : h2h.team2Wins;
                                                    const theirWins = h2h.team1 === selectedTeamProfile ? h2h.team2Wins : h2h.team1Wins;
                                                    const totalGames = myWins + theirWins;
                                                    
                                                    return (
                                                        <div key={opponent.id} style={{ 
                                                            padding: '0.75rem',
                                                            background: myWins > theirWins ? 'rgba(34, 197, 94, 0.1)' : 
                                                                       myWins < theirWins ? 'rgba(239, 68, 68, 0.1)' : 
                                                                       'rgba(100, 116, 139, 0.1)',
                                                            borderRadius: '0.375rem',
                                                            border: `1px solid ${myWins > theirWins ? 'rgba(34, 197, 94, 0.3)' : 
                                                                               myWins < theirWins ? 'rgba(239, 68, 68, 0.3)' : 
                                                                               'rgba(100, 116, 139, 0.3)'}`
                                                        }}>
                                                            <div style={{ fontWeight: 'bold', marginBottom: '0.25rem', color: '#e2e8f0' }}>
                                                                vs {opponent.city} {opponent.name}
                                                            </div>
                                                            <div style={{ fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                                <span style={{ color: myWins > theirWins ? '#22c55e' : '#fff' }}>{myWins}</span>
                                                                <span style={{ color: '#64748b', margin: '0 0.5rem' }}>-</span>
                                                                <span style={{ color: theirWins > myWins ? '#ef4444' : '#fff' }}>{theirWins}</span>
                                                            </div>
                                                            <div style={{ fontSize: '0.75rem', color: '#94a3b8' }}>
                                                                {totalGames} {totalGames === 1 ? 'game' : 'games'} played
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                    </div>

                                    <div className="card">
                                        <h2>Schedule & Results</h2>
                                        <p style={{ color: '#93c5fd', marginBottom: '1rem' }}>
                                            Games Played: {teamSchedule.filter(g => g.played).length} | 
                                            Remaining: {teamSchedule.filter(g => !g.played).length} | 
                                            Total: {teamSchedule.length}
                                        </p>
                                        <table className="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Day</th>
                                                    <th>Opponent</th>
                                                    <th className="text-center">Home/Away</th>
                                                    <th className="text-center">Result</th>
                                                    <th className="text-center">Score</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {teamSchedule
                                                    .sort((a, b) => a.day - b.day)
                                                    .map((game, idx) => {
                                                    const isHome = game.homeTeam === selectedTeamProfile;
                                                    const opponent = TEAMS.find(t => t.id === (isHome ? game.awayTeam : game.homeTeam));
                                                    const teamScore = isHome ? game.homeScore : game.awayScore;
                                                    const oppScore = isHome ? game.awayScore : game.homeScore;
                                                    let result = '';
                                                    if (game.played) {
                                                        if (teamScore > oppScore) result = 'W';
                                                        else if (teamScore < oppScore) result = 'L';
                                                        else result = 'T';
                                                    }

                                                    return (
                                                        <tr key={idx} style={game.played ? { cursor: 'pointer' } : {}} 
                                                            onClick={() => game.played && navigateTo('gameDetail', game)}>
                                                            <td>Day {game.day}</td>
                                                            <td>{opponent.city} {opponent.name}</td>
                                                            <td className="text-center">{isHome ? 'HOME' : 'AWAY'}</td>
                                                            <td className="text-center" style={{ 
                                                                fontWeight: 'bold',
                                                                color: result === 'W' ? '#22c55e' : result === 'L' ? '#ef4444' : '#93c5fd'
                                                            }}>
                                                                {game.played ? result : '-'}
                                                            </td>
                                                            <td className="text-center" style={{ fontWeight: game.played ? 'bold' : 'normal' }}>
                                                                {game.played ? `${teamScore} - ${oppScore}` : '-'}
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </>
                            );
                        })()}
                    </div>
                )}

                {currentView === 'injuries' && gameState && (
                    <div>
                        <div className="card">
                            <h2>üè• Injury Report</h2>
                            <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                Current injuries across the league. Injured players cannot play and are replaced by backups in the lineup.
                            </p>
                            
                            {gameState.players.filter(p => p.injury.injured).length === 0 ? (
                                <p style={{ color: '#22c55e', textAlign: 'center', padding: '2rem' }}>
                                    ‚úì No players currently injured! Everyone is healthy.
                                </p>
                            ) : (
                                TEAMS.map(team => {
                                    const teamInjuries = gameState.players.filter(p => p.teamId === team.id && p.injury.injured);
                                    if (teamInjuries.length === 0) return null;
                                    
                                    return (
                                        <div key={team.id} style={{ marginBottom: '2rem' }}>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>
                                                {team.city} {team.name} ({teamInjuries.length} injured)
                                            </h3>
                                            <table className="stats-table">
                                                <thead>
                                                    <tr>
                                                        <th>Player</th>
                                                        <th className="text-center">Pos</th>
                                                        <th className="text-center">Status</th>
                                                        <th>Injury Type</th>
                                                        <th className="text-center">Days Out</th>
                                                        <th className="text-center">GP</th>
                                                        <th className="text-center">PTS</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {teamInjuries
                                                        .sort((a, b) => {
                                                            const order = { 'Retired': 0, 'Out': 1, 'IR': 2, 'DTD': 3 };
                                                            return (order[getPlayerStatus(a)] || 4) - (order[getPlayerStatus(b)] || 4);
                                                        })
                                                        .map(player => {
                                                            const status = getPlayerStatus(player);
                                                            const statusColor = status === 'Retired' ? '#ef4444' : 
                                                                              status === 'Out' ? '#f59e0b' : 
                                                                              status === 'IR' ? '#f97316' : '#fbbf24';
                                                            return (
                                                                <tr key={player.id}>
                                                                    <td className="player-name" style={{ cursor: 'pointer', textDecoration: 'underline' }} onClick={() => navigateTo('playerProfile', player)}>
                                                                        {player.firstName} {player.lastName}
                                                                    </td>
                                                                    <td className="text-center">{player.position}</td>
                                                                    <td className="text-center">
                                                                        <span style={{ color: statusColor, fontWeight: 'bold' }}>
                                                                            {status}
                                                                        </span>
                                                                    </td>
                                                                    <td>
                                                                        {player.injury.type}
                                                                        {player.injury.severity !== 'Day-to-Day' && (
                                                                            <span style={{ color: '#64748b', fontSize: '0.875rem', marginLeft: '0.5rem' }}>
                                                                                ({player.injury.severity})
                                                                            </span>
                                                                        )}
                                                                    </td>
                                                                    <td className="text-center">
                                                                        {player.injury.isCareerEnding ? '‚àû' : 
                                                                         player.injury.severity === 'Season-Ending' ? 'Season' :
                                                                         player.injury.daysUntilReturn}
                                                                    </td>
                                                                    <td className="text-center">{player.stats.gamesPlayed}</td>
                                                                    <td className="text-center">{player.stats.points || 0}</td>
                                                                </tr>
                                                            );
                                                        })}
                                                </tbody>
                                            </table>
                                        </div>
                                    );
                                }).filter(Boolean)
                            )}
                        </div>
                        
                        <div className="card" style={{ background: 'rgba(30, 58, 138, 0.3)' }}>
                            <h3 style={{ color: '#22d3ee' }}>Injury Information</h3>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem', marginTop: '1rem' }}>
                                <div>
                                    <h4 style={{ color: '#fbbf24' }}>Day-to-Day (DTD)</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>1-7 days. Player will return soon.</p>
                                </div>
                                <div>
                                    <h4 style={{ color: '#f97316' }}>Week-to-Week / Out</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>7-14 days. Short-term absence.</p>
                                </div>
                                <div>
                                    <h4 style={{ color: '#f59e0b' }}>Month-to-Month (IR)</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>15-60 days. Medium-term injury.</p>
                                </div>
                                <div>
                                    <h4 style={{ color: '#f59e0b' }}>Season-Ending</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>Out for remainder of season.</p>
                                </div>
                                <div>
                                    <h4 style={{ color: '#ef4444' }}>Career-Ending (Retired)</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.875rem' }}>Player has retired due to injury. Very rare.</p>
                                </div>
                            </div>
                            <p style={{ color: '#93c5fd', marginTop: '1rem', fontSize: '0.875rem' }}>
                                <strong>Injury System:</strong> ~0.15% chance per game (1 in ~7 games). Higher for forwards, older players, and high TOI.<br/>
                                <strong>Load Management:</strong> Healthy players may be rested (~1% chance) to prevent fatigue. Stars rest less.<br/>
                                <strong>Injured players cannot play</strong> - backups fill in until they return.<br/>
                                <strong>Result:</strong> Most starters play 70-80 games, not all 82. Elite stars may reach 82.
                            </p>
                        </div>
                    </div>
                )}

                {/* FARM ROSTER MANAGEMENT VIEW */}
                {currentView === 'farmRoster' && gameState && (() => {
                    const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === userTeamId);
                    
                    if (farmTeam) {
                        ensureFarmTeamExists(farmTeam.id);
                    }
                    
                    const userFarmRoster = farmTeam ? gameState.players.filter(p => 
                        p.teamId === farmTeam.id && 
                        p.roster === 'farm'
                    ).sort((a, b) => b.ratings.overall - a.ratings.overall) : [];
                    
                    const overLimit = userFarmRoster.length > ROSTER_LIMITS.FARM;
                    const playersToRelease = Math.max(0, userFarmRoster.length - ROSTER_LIMITS.FARM);
                    
                    const releasePlayer = (playerId) => {
                        if (confirm('Are you sure you want to release this player? This cannot be undone.')) {
                            setGameState(prev => ({
                                ...prev,
                                players: prev.players.filter(p => p.id !== playerId)
                            }));
                            saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                            alert('‚úÖ Player released from farm team.');
                        }
                    };
                    
                    return (
                        <div>
                            <div className="card">
                                <h2 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üè´ Farm Team Roster Management</h2>
                                <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                    Manage your farm team roster. Maximum: {ROSTER_LIMITS.FARM} players.
                                </p>
                                
                                {/* Roster Count Warning */}
                                <div style={{
                                    padding: '1.5rem',
                                    background: overLimit ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)',
                                    border: `2px solid ${overLimit ? '#ef4444' : '#22c55e'}`,
                                    borderRadius: '0.75rem',
                                    marginBottom: '2rem'
                                }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '1rem' }}>
                                        <div>
                                            <div style={{ 
                                                fontSize: '2rem',
                                                fontWeight: 'bold',
                                                color: overLimit ? '#ef4444' : '#22c55e',
                                                marginBottom: '0.5rem'
                                            }}>
                                                {userFarmRoster.length} / {ROSTER_LIMITS.FARM}
                                            </div>
                                            <div style={{ color: '#e2e8f0', fontSize: '1.1rem' }}>
                                                Farm Team Players
                                            </div>
                                        </div>
                                        {overLimit && (
                                            <div style={{ textAlign: 'right' }}>
                                                <div style={{ color: '#ef4444', fontWeight: 'bold', fontSize: '1.2rem' }}>
                                                    ‚ö†Ô∏è OVER LIMIT
                                                </div>
                                                <div style={{ color: '#fca5a5', fontSize: '0.9rem' }}>
                                                    Must release {playersToRelease} player{playersToRelease > 1 ? 's' : ''} before season starts
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Player List by Position */}
                                {['F', 'D', 'G'].map(pos => {
                                    const players = userFarmRoster.filter(p => p.position === pos);
                                    const posName = pos === 'F' ? 'Forwards' : pos === 'D' ? 'Defensemen' : 'Goalies';
                                    
                                    if (players.length === 0) return null;
                                    
                                    return (
                                        <div key={pos} style={{ marginBottom: '2rem' }}>
                                            <h3 style={{ color: '#93c5fd', marginBottom: '1rem' }}>
                                                {posName} ({players.length})
                                            </h3>
                                            <div style={{ display: 'grid', gap: '0.75rem' }}>
                                                {players.map(player => (
                                                    <div key={player.id} style={{
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        padding: '1rem',
                                                        background: 'rgba(30, 58, 138, 0.3)',
                                                        borderRadius: '0.5rem',
                                                        border: '1px solid rgba(59, 130, 246, 0.3)'
                                                    }}>
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                                {player.firstName} {player.lastName}
                                                                <span style={{ 
                                                                    marginLeft: '0.5rem',
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: player.ratings.overall >= 75 ? 'rgba(34, 197, 94, 0.3)' : 'rgba(59, 130, 246, 0.2)',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.85rem',
                                                                    color: player.ratings.overall >= 75 ? '#22c55e' : '#60a5fa'
                                                                }}>
                                                                    {player.ratings.overall} OVR
                                                                </span>
                                                                {player.ratings.potential > player.ratings.overall + 5 && (
                                                                    <span style={{ 
                                                                        marginLeft: '0.5rem',
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(251, 191, 36, 0.2)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem',
                                                                        color: '#fbbf24'
                                                                    }}>
                                                                        ‚≠ê {player.ratings.potential} POT
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>
                                                                Age {player.age} ‚Ä¢ {player.position}
                                                                {player.contract && (
                                                                    <span style={{ marginLeft: '0.5rem' }}>
                                                                        ‚Ä¢ ${(player.contract.salary / 1000).toFixed(0)}K/yr √ó {player.contract.yearsRemaining}yr
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <button
                                                            onClick={() => releasePlayer(player.id)}
                                                            style={{
                                                                padding: '0.5rem 1rem',
                                                                background: '#ef4444',
                                                                color: 'white',
                                                                border: 'none',
                                                                borderRadius: '0.375rem',
                                                                cursor: 'pointer',
                                                                fontSize: '0.9rem',
                                                                fontWeight: 'bold'
                                                            }}
                                                            onMouseOver={(e) => e.currentTarget.style.background = '#dc2626'}
                                                            onMouseOut={(e) => e.currentTarget.style.background = '#ef4444'}
                                                        >
                                                            üóëÔ∏è Release
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                                
                                {userFarmRoster.length === 0 && (
                                    <div style={{
                                        padding: '3rem',
                                        textAlign: 'center',
                                        color: '#93c5fd'
                                    }}>
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üèí</div>
                                        <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>No Farm Team Players</h3>
                                        <p>Your farm team is empty. Draft picks will be assigned here.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                })()}

                {/* DRAFT PICKS VIEW */}
                {currentView === 'draftpicks' && gameState && (() => {
                    // Get user team's draft picks
                    const userTeamPicks = gameState.draftPicks?.filter(p => p.currentOwner === userTeamId) || [];
                    
                    // Group by year
                    const picksByYear = {};
                    userTeamPicks.forEach(pick => {
                        if (!picksByYear[pick.year]) picksByYear[pick.year] = [];
                        picksByYear[pick.year].push(pick);
                    });
                    
                    return (
                        <div>
                            <div className="card">
                                <h2>üé≤ Draft Picks</h2>
                                <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                    Your team's draft picks for the next 2 years. Projected positions based on current standings.
                                </p>
                                
                                {Object.keys(picksByYear).sort().map(year => {
                                    const yearPicks = picksByYear[year].sort((a, b) => a.overallPick - b.overallPick);
                                    
                                    return (
                                        <div key={year} style={{ marginBottom: '2.5rem' }}>
                                            <h3 style={{ 
                                                color: '#60a5fa', 
                                                marginBottom: '1rem',
                                                fontSize: '1.5rem',
                                                borderBottom: '2px solid rgba(96, 165, 250, 0.3)',
                                                paddingBottom: '0.5rem'
                                            }}>
                                                {year} Draft ({yearPicks.length} picks)
                                            </h3>
                                            
                                            <table className="stats-table">
                                                <thead>
                                                    <tr>
                                                        <th>Round</th>
                                                        <th>Original Team</th>
                                                        <th>Projected Position</th>
                                                        <th>Pick Value</th>
                                                        <th>Notes</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {yearPicks.map(pick => {
                                                        const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                                                        const isOwnPick = pick.originalTeam === userTeamId;
                                                        const projectedPos = getProjectedDraftPosition(
                                                            pick.originalTeam, 
                                                            pick.round, 
                                                            gameState.standings
                                                        );
                                                        const pickValue = calculateDraftPickValue(
                                                            pick, 
                                                            gameState.standings, 
                                                            gameState.teamProfiles,
                                                            draftProspects,
                                                            gameState.year
                                                        );
                                                        
                                                        // Color code by round
                                                        const roundColor = pick.round === 1 ? '#fbbf24' :
                                                                          pick.round === 2 ? '#60a5fa' :
                                                                          pick.round === 3 ? '#22c55e' : '#94a3b8';
                                                        
                                                        return (
                                                            <tr key={pick.id}>
                                                                <td style={{ 
                                                                    fontWeight: 'bold', 
                                                                    color: roundColor,
                                                                    fontSize: '1.1rem'
                                                                }}>
                                                                    Round {pick.round}
                                                                </td>
                                                                <td>
                                                                    {isOwnPick ? (
                                                                        <span style={{ color: '#22c55e', fontWeight: 'bold' }}>
                                                                            Own Pick
                                                                        </span>
                                                                    ) : (
                                                                        <span style={{ color: '#93c5fd' }}>
                                                                            from {originalTeam?.city} {originalTeam?.name}
                                                                        </span>
                                                                    )}
                                                                </td>
                                                                <td style={{ 
                                                                    fontWeight: 'bold',
                                                                    color: pick.isLotteryPick ? '#fbbf24' : '#e2e8f0'
                                                                }}>
                                                                    {projectedPos}
                                                                </td>
                                                                <td style={{ textAlign: 'center' }}>
                                                                    <span style={{
                                                                        padding: '0.25rem 0.75rem',
                                                                        borderRadius: '0.25rem',
                                                                        background: pickValue >= 400 ? 'rgba(251, 191, 36, 0.2)' :
                                                                                   pickValue >= 200 ? 'rgba(96, 165, 250, 0.2)' :
                                                                                   pickValue >= 100 ? 'rgba(34, 197, 94, 0.2)' :
                                                                                   'rgba(148, 163, 184, 0.2)',
                                                                        color: pickValue >= 400 ? '#fbbf24' :
                                                                              pickValue >= 200 ? '#60a5fa' :
                                                                              pickValue >= 100 ? '#22c55e' : '#94a3b8',
                                                                        fontWeight: 'bold'
                                                                    }}>
                                                                        {pickValue}
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    {pick.isLotteryPick && (
                                                                        <span style={{ 
                                                                            color: '#fbbf24',
                                                                            fontSize: '0.9rem',
                                                                            fontStyle: 'italic'
                                                                        }}>
                                                                            ‚≠ê Lottery Pick
                                                                        </span>
                                                                    )}
                                                                    {!isOwnPick && (
                                                                        <span style={{ 
                                                                            color: '#60a5fa',
                                                                            fontSize: '0.85rem',
                                                                            marginLeft: '0.5rem'
                                                                        }}>
                                                                            (Acquired via trade)
                                                                        </span>
                                                                    )}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    );
                                })}
                                
                                {/* Draft Pick Info */}
                                <div style={{
                                    marginTop: '2rem',
                                    padding: '1.5rem',
                                    background: 'rgba(59, 130, 246, 0.1)',
                                    borderRadius: '0.5rem',
                                    border: '1px solid rgba(59, 130, 246, 0.3)'
                                }}>
                                    <h4 style={{ color: '#60a5fa', marginBottom: '1rem' }}>
                                        üìò Draft Pick Information
                                    </h4>
                                    <ul style={{ 
                                        color: '#e2e8f0', 
                                        lineHeight: '1.8',
                                        listStyle: 'none',
                                        paddingLeft: 0
                                    }}>
                                        <li>‚Ä¢ <strong>Lottery Picks:</strong> Bottom 5 teams compete for picks 1-5 after playoffs</li>
                                        <li>‚Ä¢ <strong>Projected Position:</strong> Where pick will be based on current standings (changes as season progresses)</li>
                                        <li>‚Ä¢ <strong>Pick Value:</strong> Trading value of the pick (higher = more valuable)</li>
                                        <li>‚Ä¢ <strong>Rounds:</strong> 7 rounds, 32 picks per round (224 total picks per draft)</li>
                                        <li>‚Ä¢ <strong>Trading:</strong> Picks can be traded up to 2 years in advance</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    );
                })()}

                {currentView === 'callups' && gameState && (() => {
                    const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === userTeamId);
                    
                    // Lazy-load farm team if not yet generated
                    if (farmTeam) {
                        ensureFarmTeamExists(farmTeam.id);
                    }
                    
                    const userNHLRoster = gameState.players.filter(p => 
                        p.teamId === userTeamId && 
                        p.roster === 'nhl'
                    ).sort((a, b) => b.ratings.overall - a.ratings.overall);
                    
                    const userFarmRoster = farmTeam ? gameState.players.filter(p => 
                        p.teamId === farmTeam.id && 
                        p.roster === 'farm'
                    ).sort((a, b) => b.ratings.overall - a.ratings.overall) : [];
                    
                    return (
                    <div className="card">
                        <h2>üîÑ Call-Ups & Send-Downs</h2>
                        <p style={{ color: '#93c5fd', marginBottom: '2rem' }}>
                            Manage your roster between NAHL and NAMHL farm team. Call up prospects or send down players.
                        </p>
                        
                        {/* NHL Roster */}
                        <div style={{ marginBottom: '3rem' }}>
                            <h3 style={{ color: '#22c55e', marginBottom: '1rem' }}>
                                NHL Roster ({userNHLRoster.length} / 23)
                            </h3>
                            
                            {['F', 'D', 'G'].map(pos => {
                                const players = userNHLRoster.filter(p => p.position === pos);
                                const posName = pos === 'F' ? 'Forwards' : pos === 'D' ? 'Defensemen' : 'Goalies';
                                const maxCount = pos === 'F' ? 13 : pos === 'D' ? 7 : 3;
                                
                                return (
                                    <div key={pos} style={{ marginBottom: '2rem' }}>
                                        <h4 style={{ color: '#93c5fd' }}>
                                            {posName} ({players.length} / {maxCount})
                                        </h4>
                                        <div style={{ display: 'grid', gap: '0.75rem' }}>
                                            {players.map(player => (
                                                <div key={player.id} style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    padding: '1rem',
                                                    background: 'rgba(30, 58, 138, 0.3)',
                                                    borderRadius: '0.375rem',
                                                    border: '1px solid rgba(59, 130, 246, 0.3)'
                                                }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: 'bold' }}>
                                                            {player.firstName} {player.lastName}
                                                            <span style={{ 
                                                                marginLeft: '0.5rem',
                                                                padding: '0.25rem 0.5rem',
                                                                background: 'rgba(59, 130, 246, 0.2)',
                                                                borderRadius: '0.25rem',
                                                                fontSize: '0.75rem'
                                                            }}>
                                                                {player.position}
                                                            </span>
                                                            {player.linePosition && (
                                                                <span style={{ 
                                                                    marginLeft: '0.5rem',
                                                                    fontSize: '0.75rem',
                                                                    color: '#93c5fd'
                                                                }}>
                                                                    {player.position === 'G' ? (player.dressed ? 'Dressed' : 'Scratch') : 
                                                                     player.lineNumber > 0 ? `Line ${player.lineNumber}` : 'Scratch'}
                                                                </span>
                                                            )}
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                                            OVR: {player.ratings.overall} | Age: {player.age}
                                                            {player.injury.injured && (
                                                                <span style={{ 
                                                                    marginLeft: '0.5rem',
                                                                    color: '#f87171',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    (Injured - {player.injury.type})
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => sendDownPlayer(player.id)}
                                                        disabled={player.injury.injured}
                                                        style={{
                                                            padding: '0.5rem 1rem',
                                                            background: player.injury.injured ? '#374151' : '#ef4444',
                                                            color: 'white',
                                                            border: 'none',
                                                            borderRadius: '0.375rem',
                                                            cursor: player.injury.injured ? 'not-allowed' : 'pointer',
                                                            fontSize: '0.875rem',
                                                            fontWeight: 'bold',
                                                            opacity: player.injury.injured ? 0.5 : 1
                                                        }}
                                                    >
                                                        ‚¨áÔ∏è Send Down
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Farm Team Roster */}
                        <div style={{ 
                            borderTop: '2px solid rgba(59, 130, 246, 0.3)',
                            paddingTop: '2rem'
                        }}>
                            <h3 style={{ color: '#fbbf24', marginBottom: '1rem' }}>
                                Farm Team ({farmTeam?.city} {farmTeam?.name}) - {userFarmRoster.length} / 23
                            </h3>
                            
                            {['F', 'D', 'G'].map(pos => {
                                const players = userFarmRoster.filter(p => p.position === pos);
                                const posName = pos === 'F' ? 'Forwards' : pos === 'D' ? 'Defensemen' : 'Goalies';
                                
                                return (
                                    <div key={pos} style={{ marginBottom: '2rem' }}>
                                        <h4 style={{ color: '#93c5fd' }}>
                                            {posName} ({players.length})
                                        </h4>
                                        <div style={{ display: 'grid', gap: '0.75rem' }}>
                                            {players.map(player => (
                                                <div key={player.id} style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    padding: '1rem',
                                                    background: 'rgba(251, 191, 36, 0.1)',
                                                    borderRadius: '0.375rem',
                                                    border: '1px solid rgba(251, 191, 36, 0.3)'
                                                }}>
                                                    <div style={{ flex: 1 }}>
                                                        <div style={{ fontWeight: 'bold' }}>
                                                            {player.firstName} {player.lastName}
                                                            <span style={{ 
                                                                marginLeft: '0.5rem',
                                                                padding: '0.25rem 0.5rem',
                                                                background: 'rgba(251, 191, 36, 0.2)',
                                                                borderRadius: '0.25rem',
                                                                fontSize: '0.75rem'
                                                            }}>
                                                                {player.position}
                                                            </span>
                                                        </div>
                                                        <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                                            OVR: {player.ratings.overall} | Age: {player.age} | POT: {player.ratings.potential}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => callUpPlayer(player.id)}
                                                        style={{
                                                            padding: '0.5rem 1rem',
                                                            background: '#22c55e',
                                                            color: 'white',
                                                            border: 'none',
                                                            borderRadius: '0.375rem',
                                                            cursor: 'pointer',
                                                            fontSize: '0.875rem',
                                                            fontWeight: 'bold'
                                                        }}
                                                    >
                                                        ‚¨ÜÔ∏è Call Up
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Info Box */}
                        <div style={{ 
                            marginTop: '2rem',
                            padding: '1rem',
                            background: 'rgba(59, 130, 246, 0.1)',
                            borderRadius: '0.5rem',
                            border: '1px solid rgba(59, 130, 246, 0.3)'
                        }}>
                            <h4 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>‚ÑπÔ∏è Roster Rules</h4>
                            <ul style={{ marginLeft: '1.5rem', color: '#93c5fd', fontSize: '0.875rem' }}>
                                <li>NHL roster: 13 forwards + 7 defensemen + 3 goalies = 23 players</li>
                                <li>Farm roster: Same structure (23 players)</li>
                                <li>Cannot send down injured players (must wait until healthy)</li>
                                <li>Called-up players start as scratches - assign them to lines</li>
                                <li>Injured players auto-call-up replacements from farm</li>
                                <li>When injured players heal, farm call-ups auto-return</li>
                            </ul>
                        </div>
                    </div>
                    );
                })()}

                {currentView === 'teamHistory' && gameState && (() => {
                    const userTeam = TEAMS.find(t => t.id === userTeamId);
            if (!userTeam) return;
                    const history = gameState.teamHistory || { seasons: [], achievements: {} };
                    
                    return (
                    <div>
                        <div className="card">
                            <h2 style={{ color: '#f59e0b' }}>üìú {userTeam.city} {userTeam.name} - Team History</h2>
                            
                            {history.seasons.length === 0 ? (
                                <div style={{ padding: '3rem', textAlign: 'center', color: '#64748b' }}>
                                    <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üèí</div>
                                    <p style={{ fontSize: '1.25rem', marginBottom: '0.5rem' }}>No History Yet</p>
                                    <p>Complete a season to start building your team's legacy!</p>
                                </div>
                            ) : (
                                <>
                                    {/* Season Records Table */}
                                    <h3 style={{ color: '#93c5fd', marginTop: '1.5rem', marginBottom: '1rem' }}>Season Records</h3>
                                    <div style={{ overflowX: 'auto' }}>
                                        <table className="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Season</th>
                                                    <th>Year</th>
                                                    <th>W-L-OTL</th>
                                                    <th>Pts</th>
                                                    <th>GF</th>
                                                    <th>GA</th>
                                                    <th>Diff</th>
                                                    <th>Div</th>
                                                    <th>Conf</th>
                                                    <th>Playoff Result</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {history.seasons.map((season, idx) => (
                                                    <tr key={idx}>
                                                        <td className="text-center">{season.season}</td>
                                                        <td className="text-center">{season.year}</td>
                                                        <td className="text-center">{season?.wins}-{season?.losses}-{season?.otLosses}</td>
                                                        <td className="text-center" style={{ fontWeight: 'bold' }}>{season.points}</td>
                                                        <td className="text-center">{season.goalsFor}</td>
                                                        <td className="text-center">{season.goalsAgainst}</td>
                                                        <td className="text-center" style={{ 
                                                            color: season.goalDifferential > 0 ? '#22c55e' : season.goalDifferential < 0 ? '#ef4444' : '#fff' 
                                                        }}>
                                                            {season.goalDifferential > 0 ? '+' : ''}{season.goalDifferential}
                                                        </td>
                                                        <td className="text-center">
                                                            {season.wonDivision ? <span style={{ color: '#fbbf24' }}>üèÜ {season.divisionFinish}</span> : season.divisionFinish}
                                                        </td>
                                                        <td className="text-center">{season.conferenceFinish}</td>
                                                        <td style={{ 
                                                            color: season.wonChampionship ? '#fbbf24' : '#e2e8f0',
                                                            fontWeight: season.wonChampionship ? 'bold' : 'normal'
                                                        }}>
                                                            {season.wonChampionship && 'üèÜ '}
                                                            {season.playoffResult}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Achievements Section */}
                                    <h3 style={{ color: '#93c5fd', marginTop: '2rem', marginBottom: '1rem' }}>Team Achievements</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem' }}>
                                        {/* Championships */}
                                        <div style={{ 
                                            padding: '1.5rem',
                                            background: 'rgba(251, 191, 36, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '2px solid rgba(251, 191, 36, 0.3)'
                                        }}>
                                            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üèÜ</div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fbbf24', marginBottom: '0.5rem' }}>
                                                {history.achievements.championships?.length || 0}
                                            </div>
                                            <div style={{ color: '#93c5fd', marginBottom: '0.75rem' }}>Stanley Cups</div>
                                            {history.achievements.championships?.length > 0 && (
                                                <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                    {history.achievements.championships.join(', ')}
                                                </div>
                                            )}
                                        </div>

                                        {/* Conference Titles */}
                                        <div style={{ 
                                            padding: '1.5rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '2px solid rgba(59, 130, 246, 0.3)'
                                        }}>
                                            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>ü•à</div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#3b82f6', marginBottom: '0.5rem' }}>
                                                {history.achievements.conferenceTitles?.length || 0}
                                            </div>
                                            <div style={{ color: '#93c5fd', marginBottom: '0.75rem' }}>Conference Championships</div>
                                            {history.achievements.conferenceTitles?.length > 0 && (
                                                <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                    {history.achievements.conferenceTitles.join(', ')}
                                                </div>
                                            )}
                                        </div>

                                        {/* Division Titles */}
                                        <div style={{ 
                                            padding: '1.5rem',
                                            background: 'rgba(34, 197, 94, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '2px solid rgba(34, 197, 94, 0.3)'
                                        }}>
                                            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>ü•â</div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#22c55e', marginBottom: '0.5rem' }}>
                                                {history.achievements.divisionTitles?.length || 0}
                                            </div>
                                            <div style={{ color: '#93c5fd', marginBottom: '0.75rem' }}>Division Titles</div>
                                            {history.achievements.divisionTitles?.length > 0 && (
                                                <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                    {history.achievements.divisionTitles.join(', ')}
                                                </div>
                                            )}
                                        </div>

                                        {/* Playoff Appearances */}
                                        <div style={{ 
                                            padding: '1.5rem',
                                            background: 'rgba(139, 92, 246, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '2px solid rgba(139, 92, 246, 0.3)'
                                        }}>
                                            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üéØ</div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#8b5cf6', marginBottom: '0.5rem' }}>
                                                {history.achievements.playoffAppearances?.length || 0}
                                            </div>
                                            <div style={{ color: '#93c5fd' }}>Playoff Appearances</div>
                                        </div>
                                    </div>

                                    {/* Best Records Section */}
                                    <h3 style={{ color: '#93c5fd', marginTop: '2rem', marginBottom: '1rem' }}>All-Time Bests</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem' }}>
                                        {history.achievements.bestRecord && (
                                            <div style={{ 
                                                padding: '1rem',
                                                background: 'rgba(147, 197, 253, 0.1)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(147, 197, 253, 0.3)'
                                            }}>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                    Best Record
                                                </div>
                                                <div style={{ color: '#fff', fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                    {history.achievements.bestRecord.points} pts
                                                </div>
                                                <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                    {history.achievements.bestRecord?.wins}-{history.achievements.bestRecord?.losses}-{history.achievements.bestRecord?.otLosses} ({history.achievements.bestRecord.year})
                                                </div>
                                            </div>
                                        )}

                                        {history.achievements.bestGoalsFor && (
                                            <div style={{ 
                                                padding: '1rem',
                                                background: 'rgba(34, 197, 94, 0.1)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(34, 197, 94, 0.3)'
                                            }}>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                    Most Goals
                                                </div>
                                                <div style={{ color: '#22c55e', fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                    {history.achievements.bestGoalsFor.goalsFor} goals
                                                </div>
                                                <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                    {history.achievements.bestGoalsFor.year}
                                                </div>
                                            </div>
                                        )}

                                        {history.achievements.bestGoalDiff && (
                                            <div style={{ 
                                                padding: '1rem',
                                                background: 'rgba(251, 191, 36, 0.1)',
                                                borderRadius: '0.375rem',
                                                border: '1px solid rgba(251, 191, 36, 0.3)'
                                            }}>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                    Best Goal Differential
                                                </div>
                                                <div style={{ color: '#fbbf24', fontSize: '1.25rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                    +{history.achievements.bestGoalDiff.diff}
                                                </div>
                                                <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                    {history.achievements.bestGoalDiff.year}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                    );
                })()}

                {currentView === 'schedule' && gameState && (() => {
                    // Determine which team to show (default to user team)
                    const filterTeamId = scheduleFilterTeam === 'all' ? null : (scheduleFilterTeam || userTeamId);
                    const filterTeam = filterTeamId ? TEAMS.find(t => t.id === filterTeamId) : null;
                    
                    return (
                        <div>
                            <div className="card">
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                                    <div>
                                        <h2 style={{ color: '#22d3ee', marginBottom: '0.5rem' }}>üìÖ Schedule</h2>
                                        <p style={{ color: '#93c5fd' }}>
                                            {scheduleFilterTeam === 'all' 
                                                ? `All ${gameState.schedule.length} game days ‚Ä¢ Current Day: ${gameState.currentDay}`
                                                : `${filterTeam.city} ${filterTeam.name} Schedule ‚Ä¢ Current Day: ${gameState.currentDay}`
                                            }
                                        </p>
                                    </div>
                                    
                                    {/* Filter Controls - Side by Side */}
                                    <div style={{ display: 'flex', gap: '1rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                        {/* Team Filter */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <label style={{ color: '#93c5fd', fontWeight: 'bold', whiteSpace: 'nowrap' }}>Team:</label>
                                            <select
                                                value={scheduleFilterTeam === 'all' ? 'all' : (scheduleFilterTeam || userTeamId)}
                                                onChange={(e) => {
                                                    const value = e.target.value;
                                                    if (value === 'all') {
                                                        setScheduleFilterTeam('all');
                                                    } else if (value == userTeamId) {
                                                        setScheduleFilterTeam(null); // null means user team (default)
                                                    } else {
                                                        setScheduleFilterTeam(parseInt(value));
                                                    }
                                                }}
                                                style={{
                                                    padding: '0.5rem 1rem',
                                                    background: 'rgba(30, 58, 138, 0.4)',
                                                    border: '2px solid #3b82f6',
                                                    borderRadius: '0.5rem',
                                                    color: 'white',
                                                    fontSize: '1rem',
                                                    cursor: 'pointer',
                                                    minWidth: '180px'
                                                }}
                                            >
                                                <option value={userTeamId}>My Team</option>
                                                <option value="all">All Teams</option>
                                                <optgroup label="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"></optgroup>
                                                {TEAMS
                                                    .filter(t => t.id !== userTeamId)
                                                    .sort((a, b) => `${a.city} ${a.name}`.localeCompare(`${b.city} ${b.name}`))
                                                    .map(team => (
                                                        <option key={team.id} value={team.id}>
                                                            {team.city} {team.name}
                                                        </option>
                                                    ))
                                                }
                                            </select>
                                        </div>
                                        
                                        {/* Day Filter */}
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <label style={{ color: '#93c5fd', fontWeight: 'bold', whiteSpace: 'nowrap' }}>Day:</label>
                                            <select
                                                value={scheduleFilterDay}
                                                onChange={(e) => setScheduleFilterDay(e.target.value)}
                                                style={{
                                                    padding: '0.5rem 1rem',
                                                    background: 'rgba(30, 58, 138, 0.4)',
                                                    border: '2px solid #8b5cf6',
                                                    borderRadius: '0.5rem',
                                                    color: 'white',
                                                    fontSize: '1rem',
                                                    cursor: 'pointer',
                                                    minWidth: '140px'
                                                }}
                                            >
                                                <option value="all">All Days</option>
                                                <optgroup label="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"></optgroup>
                                                {Array.from({ length: 82 }, (_, i) => i + 1).map(day => (
                                                    <option key={day} value={day}>
                                                        Day {day}{day === gameState.currentDay ? ' üî¥' : ''}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                                    {gameState.schedule.map(daySchedule => {
                                        const hasGames = daySchedule.matchups && daySchedule.matchups.length > 0;
                                        if (!hasGames) return null;
                                        
                                        // Filter by day first
                                        if (scheduleFilterDay !== 'all' && daySchedule.day !== parseInt(scheduleFilterDay)) {
                                            return null;
                                        }
                                        
                                        // Filter matchups based on selected team
                                        const filteredMatchups = scheduleFilterTeam === 'all' 
                                            ? daySchedule.matchups
                                            : daySchedule.matchups.filter(m => 
                                                m.homeTeam === filterTeamId || m.awayTeam === filterTeamId
                                            );
                                        
                                        // Skip this day if no matching games
                                        if (filteredMatchups.length === 0) return null;
                                        
                                        const completedGames = filteredMatchups.filter(m => m.played).length;
                                        const totalGames = filteredMatchups.length;
                                        const allPlayed = completedGames === totalGames;
                                        
                                        return (
                                            <div key={daySchedule.day} style={{
                                                padding: '1.5rem',
                                                background: daySchedule.day === gameState.currentDay ? 'rgba(34, 197, 94, 0.1)' : 'rgba(30, 58, 138, 0.2)',
                                                border: daySchedule.day === gameState.currentDay ? '2px solid #22c55e' : '1px solid rgba(100, 116, 139, 0.3)',
                                                borderRadius: '0.75rem'
                                            }}>
                                                <div style={{ 
                                                    display: 'flex', 
                                                    justifyContent: 'space-between', 
                                                    alignItems: 'center',
                                                    marginBottom: '1rem',
                                                    paddingBottom: '0.75rem',
                                                    borderBottom: '2px solid rgba(34, 211, 238, 0.3)'
                                                }}>
                                                    <h3 style={{ color: '#22d3ee', margin: 0 }}>
                                                        Day {daySchedule.day}
                                                        {daySchedule.day === gameState.currentDay && (
                                                            <span style={{ 
                                                                marginLeft: '0.5rem', 
                                                                color: '#22c55e',
                                                                fontSize: '0.9rem',
                                                                fontWeight: 'normal'
                                                            }}>
                                                                (Current Day)
                                                            </span>
                                                        )}
                                                        {daySchedule.day === gameState.lastGameDay && daySchedule.day !== gameState.currentDay && (
                                                            <span style={{ 
                                                                marginLeft: '0.5rem', 
                                                                color: '#60a5fa',
                                                                fontSize: '0.9rem',
                                                                fontWeight: 'normal'
                                                            }}>
                                                                (Last Simulated)
                                                            </span>
                                                        )}
                                                    </h3>
                                                    <div style={{ 
                                                        padding: '0.25rem 0.75rem',
                                                        background: allPlayed ? 'rgba(34, 197, 94, 0.2)' : 'rgba(100, 116, 139, 0.2)',
                                                        borderRadius: '0.25rem',
                                                        fontSize: '0.9rem',
                                                        color: allPlayed ? '#22c55e' : '#94a3b8'
                                                    }}>
                                                        {scheduleFilterTeam === 'all' 
                                                            ? (allPlayed ? '‚úì Complete' : `${completedGames}/${totalGames} Played`)
                                                            : (allPlayed ? '‚úì Played' : 'Upcoming')
                                                        }
                                                    </div>
                                                </div>
                                                
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                                    {filteredMatchups.map((matchup, idx) => {
                                                        const homeTeam = TEAMS.find(t => t.id === matchup.homeTeam);
                                                        const awayTeam = TEAMS.find(t => t.id === matchup.awayTeam);
                                                        const isUserGame = matchup.homeTeam === userTeamId || matchup.awayTeam === userTeamId;
                                                        
                                                        return (
                                                            <div 
                                                                key={idx}
                                                                onClick={() => {
                                                                    if (matchup.played) {
                                                                        navigateTo('gameDetail', {
                                                                            ...matchup,
                                                                            homeTeamName: `${homeTeam.city} ${homeTeam.name}`,
                                                                            awayTeamName: `${awayTeam.city} ${awayTeam.name}`,
                                                                            day: daySchedule.day
                                                                        });
                                                                    }
                                                                }}
                                                                style={{
                                                                    padding: '1rem',
                                                                    background: isUserGame 
                                                                        ? 'rgba(34, 197, 94, 0.1)' 
                                                                        : matchup.played 
                                                                        ? 'rgba(59, 130, 246, 0.05)' 
                                                                        : 'rgba(100, 116, 139, 0.1)',
                                                                    border: `2px solid ${isUserGame ? '#22c55e' : matchup.played ? '#3b82f6' : '#475569'}`,
                                                                    borderRadius: '0.5rem',
                                                                    display: 'flex',
                                                                    justifyContent: 'space-between',
                                                                    alignItems: 'center',
                                                                    cursor: matchup.played ? 'pointer' : 'default',
                                                                    transition: 'all 0.2s'
                                                                }}
                                                                onMouseEnter={(e) => {
                                                                    if (matchup.played) {
                                                                        e.currentTarget.style.transform = 'translateX(4px)';
                                                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
                                                                    }
                                                                }}
                                                                onMouseLeave={(e) => {
                                                                    e.currentTarget.style.transform = 'translateX(0)';
                                                                    e.currentTarget.style.boxShadow = 'none';
                                                                }}
                                                            >
                                                                <div style={{ 
                                                                    flex: 1, 
                                                                    textAlign: 'right', 
                                                                    paddingRight: '1rem',
                                                                    fontWeight: matchup.awayTeam === userTeamId ? 'bold' : 'normal',
                                                                    color: matchup.awayTeam === userTeamId ? '#22c55e' : '#e2e8f0'
                                                                }}>
                                                                    {awayTeam.city} {awayTeam.name}
                                                                </div>
                                                                
                                                                <div style={{ 
                                                                    padding: '0.5rem 1rem',
                                                                    background: matchup.played ? 'rgba(59, 130, 246, 0.2)' : 'rgba(100, 116, 139, 0.2)',
                                                                    borderRadius: '0.5rem',
                                                                    minWidth: '100px',
                                                                    textAlign: 'center',
                                                                    fontWeight: 'bold',
                                                                    fontSize: '1.1rem',
                                                                    color: matchup.played ? '#60a5fa' : '#94a3b8'
                                                                }}>
                                                                    {matchup.played 
                                                                        ? `${matchup.awayScore} - ${matchup.homeScore}`
                                                                        : 'vs'
                                                                    }
                                                                </div>
                                                                
                                                                <div style={{ 
                                                                    flex: 1, 
                                                                    textAlign: 'left', 
                                                                    paddingLeft: '1rem',
                                                                    fontWeight: matchup.homeTeam === userTeamId ? 'bold' : 'normal',
                                                                    color: matchup.homeTeam === userTeamId ? '#22c55e' : '#e2e8f0'
                                                                }}>
                                                                    {homeTeam.city} {homeTeam.name}
                                                                </div>
                                                                
                                                                {matchup.played && (
                                                                    <div style={{ 
                                                                        marginLeft: '0.5rem',
                                                                        fontSize: '0.85rem',
                                                                        color: '#93c5fd'
                                                                    }}>
                                                                        üìä
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    );
                })()}

                {currentView === 'gameDetail' && selectedGame && (
                    <div>
                        <button 
                            onClick={goBack}
                            style={{
                                padding: '0.5rem 1rem',
                                background: '#2563eb',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                marginBottom: '1rem',
                                fontWeight: 'bold'
                            }}
                        >
                            ‚Üê Back
                        </button>
                        
                        <div className="card">
                            <h2>Game Summary</h2>
                            <p style={{ color: '#93c5fd', marginBottom: '1rem' }}>
                                {selectedGame.date ? selectedGame.date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) : 'Regular Season Game'}
                            </p>
                            
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                padding: '2rem',
                                background: 'rgba(30, 58, 138, 0.3)',
                                borderRadius: '0.5rem',
                                marginBottom: '2rem'
                            }}>
                                {(() => {
                                    const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                    const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
            if (!awayTeam) return;
                                    const homeWon = selectedGame.homeScore > selectedGame.awayScore;
                                    
                                    return (
                                        <>
                                            <div style={{ textAlign: 'center', flex: 1 }}>
                                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                    {awayTeam.city} {awayTeam.name}
                                                </div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                                    AWAY
                                                </div>
                                                <div style={{ 
                                                    fontSize: '4rem', 
                                                    fontWeight: 'bold',
                                                    color: !homeWon ? '#22c55e' : '#fff'
                                                }}>
                                                    {selectedGame.awayScore}
                                                </div>
                                            </div>
                                            <div style={{ fontSize: '3rem', color: '#93c5fd', padding: '0 2rem' }}>
                                                @
                                            </div>
                                            <div style={{ textAlign: 'center', flex: 1 }}>
                                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                    {homeTeam.city} {homeTeam.name}
                                                </div>
                                                <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                                    HOME
                                                </div>
                                                <div style={{ 
                                                    fontSize: '4rem', 
                                                    fontWeight: 'bold',
                                                    color: homeWon ? '#22c55e' : '#fff'
                                                }}>
                                                    {selectedGame.homeScore}
                                                </div>
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                            
                            {/* Winner Badge */}
                            {(() => {
                                const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                const homeWon = selectedGame.homeScore > selectedGame.awayScore;
                                const winner = homeWon ? homeTeam : awayTeam;
                                
                                return (
                                    <div style={{ 
                                        padding: '1rem',
                                        background: 'rgba(34, 197, 94, 0.15)',
                                        borderRadius: '0.5rem',
                                        marginBottom: '2rem',
                                        textAlign: 'center',
                                        border: '2px solid #22c55e'
                                    }}>
                                        <div style={{ color: '#22c55e', fontSize: '1.2rem', fontWeight: 'bold' }}>
                                            üèÜ WINNER: {winner.city} {winner.name}
                                        </div>
                                    </div>
                                );
                            })()}
                            
                            {/* Period-by-Period Scoring Summary */}
                            {selectedGame.details && selectedGame.details.scoringSummary && selectedGame.details.scoringSummary.some(p => p.goals.length > 0) && (
                                (() => {
                                    const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                    const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                    
                                    // Calculate pre-game stats for running totals
                                    const getPreGameStats = (playerId) => {
                                        // Find all games this player played BEFORE the current game
                                        let goals = 0;
                                        let assists = 0;
                                        
                                        // Iterate through schedule days before this game's day
                                        gameState.schedule.forEach(daySchedule => {
                                            if (daySchedule.day >= selectedGame.day) return; // Skip this game and future games
                                            
                                            daySchedule.matchups.forEach(game => {
                                                if (!game.played || !game.details) return;
                                                
                                                // Check if this player played in this game
                                                const homeStats = game.details.homePlayerStats?.find(ps => ps.player.id === playerId);
                                                const awayStats = game.details.awayPlayerStats?.find(ps => ps.player.id === playerId);
                                                
                                                if (homeStats) {
                                                    goals += homeStats.goals || 0;
                                                    assists += homeStats.assists || 0;
                                                }
                                                if (awayStats) {
                                                    goals += awayStats.goals || 0;
                                                    assists += awayStats.assists || 0;
                                                }
                                            });
                                        });
                                        
                                        return { goals, assists };
                                    };
                                    
                                    return (
                                        <div style={{ marginBottom: '2rem' }}>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1.5rem' }}>‚ö° Scoring Summary</h3>
                                            {selectedGame.details.scoringSummary.map((period, idx) => {
                                                if (period.goals.length === 0) return null;
                                                
                                                // Track running totals within this game
                                                const gameRunningTotals = {};
                                                
                                                return (
                                                    <div key={period.period} style={{ 
                                                        marginBottom: '1.5rem',
                                                        padding: '1rem',
                                                        background: 'rgba(30, 58, 138, 0.2)',
                                                        borderRadius: '0.5rem',
                                                        border: '1px solid rgba(59, 130, 246, 0.3)'
                                                    }}>
                                                        <h4 style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1rem' }}>
                                                            {period.period === 1 ? '1st' : period.period === 2 ? '2nd' : '3rd'} Period
                                                        </h4>
                                                        {period.goals.map((goal, goalIdx) => {
                                                            const team = goal.team === 'home' ? homeTeam : awayTeam;
                                                            const preGameStats = getPreGameStats(goal.scorer.id);
                                                            
                                                            // Initialize running total for this player if not exists
                                                            if (!gameRunningTotals[goal.scorer.id]) {
                                                                gameRunningTotals[goal.scorer.id] = { goals: 0, assists: 0 };
                                                            }
                                                            gameRunningTotals[goal.scorer.id].goals++;
                                                            
                                                            const seasonGoalTotal = preGameStats.goals + gameRunningTotals[goal.scorer.id].goals;
                                                            
                                                            return (
                                                                <div key={goalIdx} style={{ 
                                                                    marginBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                    paddingBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                    borderBottom: goalIdx < period.goals.length - 1 ? '1px solid rgba(100, 116, 139, 0.3)' : 'none'
                                                                }}>
                                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.25rem' }}>
                                                                        <span style={{ 
                                                                            padding: '0.25rem 0.5rem',
                                                                            background: goal.team === 'home' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                                                            borderRadius: '0.25rem',
                                                                            fontSize: '0.75rem',
                                                                            fontWeight: 'bold',
                                                                            color: goal.team === 'home' ? '#22c55e' : '#3b82f6'
                                                                        }}>
                                                                            {team.abbreviation}
                                                                        </span>
                                                                        <span style={{ fontWeight: 'bold', color: '#fff' }}>
                                                                            {goal.scorer.name}
                                                                        </span>
                                                                        <span style={{ 
                                                                            fontSize: '0.85rem',
                                                                            color: '#22c55e',
                                                                            fontWeight: 'bold'
                                                                        }}>
                                                                            ({seasonGoalTotal})
                                                                        </span>
                                                                    </div>
                                                                    {goal.assists.length > 0 && (
                                                                        <div style={{ 
                                                                            fontSize: '0.875rem', 
                                                                            color: '#94a3b8',
                                                                            marginLeft: '2.5rem'
                                                                        }}>
                                                                            Assists: {goal.assists.map((assist, aIdx) => {
                                                                                const assistPreGameStats = getPreGameStats(assist.id);
                                                                                
                                                                                if (!gameRunningTotals[assist.id]) {
                                                                                    gameRunningTotals[assist.id] = { goals: 0, assists: 0 };
                                                                                }
                                                                                gameRunningTotals[assist.id].assists++;
                                                                                
                                                                                const seasonAssistTotal = assistPreGameStats.assists + gameRunningTotals[assist.id].assists;
                                                                                
                                                                                return (
                                                                                    <span key={assist.id}>
                                                                                        {assist.name} <span style={{ color: '#22c55e', fontWeight: 'bold' }}>({seasonAssistTotal})</span>
                                                                                        {aIdx < goal.assists.length - 1 ? ', ' : ''}
                                                                                    </span>
                                                                                );
                                                                            })}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })()
                            )}
                            
                            {/* Period-by-Period Scoring */}
                            {selectedGame.details && selectedGame.periodScoring && (
                                <div style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üìä Period Breakdown</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th>Team</th>
                                                <th className="text-center">1st</th>
                                                <th className="text-center">2nd</th>
                                                <th className="text-center">3rd</th>
                                                <th className="text-center">Final</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                                const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                                if (!awayTeam) return;
                                                
                                                return (
                                                    <>
                                                        <tr>
                                                            <td>{awayTeam.city} {awayTeam.name}</td>
                                                            <td className="text-center">{selectedGame.periodScoring[0]?.away || 0}</td>
                                                            <td className="text-center">{selectedGame.periodScoring[1]?.away || 0}</td>
                                                            <td className="text-center">{selectedGame.periodScoring[2]?.away || 0}</td>
                                                            <td className="text-center" style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                                {selectedGame.awayScore}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>{homeTeam.city} {homeTeam.name}</td>
                                                            <td className="text-center">{selectedGame.periodScoring[0]?.home || 0}</td>
                                                            <td className="text-center">{selectedGame.periodScoring[1]?.home || 0}</td>
                                                            <td className="text-center">{selectedGame.periodScoring[2]?.home || 0}</td>
                                                            <td className="text-center" style={{ fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                                {selectedGame.homeScore}
                                                            </td>
                                                        </tr>
                                                    </>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                            
                            {/* Team Statistics */}
                            {selectedGame.details && selectedGame.details.teamStats && (
                                <div style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üìà Team Statistics</h3>
                                    <table className="stats-table">
                                        <thead>
                                            <tr>
                                                <th>Team</th>
                                                <th className="text-center">Shots</th>
                                                <th className="text-center">PP</th>
                                                <th className="text-center">PP Goals</th>
                                                <th className="text-center">SH Goals</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {(() => {
                                                const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                                const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
            if (!awayTeam) return;
                                                const stats = selectedGame.details.teamStats;
                                                
                                                return (
                                                    <>
                                                        <tr>
                                                            <td>{awayTeam.city} {awayTeam.name}</td>
                                                            <td className="text-center">{stats.awayShots}</td>
                                                            <td className="text-center">
                                                                {stats.awayPPGoals}/{stats.awayPPOpportunities}
                                                            </td>
                                                            <td className="text-center">{stats.awayPPGoals}</td>
                                                            <td className="text-center">{stats.awaySHGoals}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>{homeTeam.city} {homeTeam.name}</td>
                                                            <td className="text-center">{stats.homeShots}</td>
                                                            <td className="text-center">
                                                                {stats.homePPGoals}/{stats.homePPOpportunities}
                                                            </td>
                                                            <td className="text-center">{stats.homePPGoals}</td>
                                                            <td className="text-center">{stats.homeSHGoals}</td>
                                                        </tr>
                                                    </>
                                                );
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                            
                            {/* Penalties */}
                            {selectedGame.details && selectedGame.details.penaltyLog && selectedGame.details.penaltyLog.length > 0 && (
                                <div style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>‚ö†Ô∏è Penalties</h3>
                                    <div style={{ 
                                        display: 'flex', 
                                        flexDirection: 'column', 
                                        gap: '0.5rem'
                                    }}>
                                        {selectedGame.details.penaltyLog.map((penalty, idx) => {
                                            const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                            const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                            const team = penalty.team === 'home' ? homeTeam : awayTeam;
                                            
                                            return (
                                                <div key={idx} style={{
                                                    padding: '0.75rem',
                                                    background: 'rgba(245, 158, 11, 0.1)',
                                                    borderRadius: '0.375rem',
                                                    border: '1px solid rgba(245, 158, 11, 0.3)',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '1rem'
                                                }}>
                                                    <span style={{
                                                        padding: '0.25rem 0.5rem',
                                                        background: penalty.team === 'home' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                                        borderRadius: '0.25rem',
                                                        fontSize: '0.75rem',
                                                        fontWeight: 'bold',
                                                        color: penalty.team === 'home' ? '#22c55e' : '#3b82f6',
                                                        minWidth: '50px',
                                                        textAlign: 'center'
                                                    }}>
                                                        {team.abbreviation}
                                                    </span>
                                                    <span style={{ 
                                                        fontSize: '0.875rem',
                                                        color: '#94a3b8',
                                                        minWidth: '60px'
                                                    }}>
                                                        Period {penalty.period}
                                                    </span>
                                                    <span style={{ fontWeight: 'bold', color: '#fff', flex: 1 }}>
                                                        {penalty.player}
                                                    </span>
                                                    <span style={{ 
                                                        color: '#fbbf24',
                                                        fontSize: '0.875rem',
                                                        fontWeight: 'bold',
                                                        minWidth: '120px',
                                                        textAlign: 'right'
                                                    }}>
                                                        {penalty.type}
                                                    </span>
                                                    <span style={{ 
                                                        color: '#94a3b8',
                                                        fontSize: '0.875rem',
                                                        minWidth: '60px',
                                                        textAlign: 'right'
                                                    }}>
                                                        {penalty.duration} min
                                                    </span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                            
                            {/* Game Stats - Check if we have per-game stats */}
                            {selectedGame.details && selectedGame.details.homePlayerStats ? (
                                // Show per-game stats with tabs
                                (() => {
                                    const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                    const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                    
                                    return (
                                        <>
                                            {/* Team Tabs */}
                                            <div style={{ 
                                                display: 'flex', 
                                                gap: '0.5rem',
                                                marginBottom: '1.5rem',
                                                borderBottom: '2px solid rgba(100, 116, 139, 0.3)'
                                            }}>
                                                <button
                                                    onClick={() => setGameDetailTeamTab('away')}
                                                    style={{
                                                        padding: '0.75rem 1.5rem',
                                                        background: gameDetailTeamTab === 'away' ? 'rgba(34, 211, 238, 0.2)' : 'transparent',
                                                        border: 'none',
                                                        borderBottom: gameDetailTeamTab === 'away' ? '3px solid #22d3ee' : '3px solid transparent',
                                                        color: gameDetailTeamTab === 'away' ? '#22d3ee' : '#94a3b8',
                                                        cursor: 'pointer',
                                                        fontWeight: gameDetailTeamTab === 'away' ? 'bold' : 'normal',
                                                        fontSize: '1rem',
                                                        transition: 'all 0.2s'
                                                    }}
                                                >
                                                    {awayTeam.city} {awayTeam.name} (Away)
                                                </button>
                                                <button
                                                    onClick={() => setGameDetailTeamTab('home')}
                                                    style={{
                                                        padding: '0.75rem 1.5rem',
                                                        background: gameDetailTeamTab === 'home' ? 'rgba(34, 211, 238, 0.2)' : 'transparent',
                                                        border: 'none',
                                                        borderBottom: gameDetailTeamTab === 'home' ? '3px solid #22d3ee' : '3px solid transparent',
                                                        color: gameDetailTeamTab === 'home' ? '#22d3ee' : '#94a3b8',
                                                        cursor: 'pointer',
                                                        fontWeight: gameDetailTeamTab === 'home' ? 'bold' : 'normal',
                                                        fontSize: '1rem',
                                                        transition: 'all 0.2s'
                                                    }}
                                                >
                                                    {homeTeam.city} {homeTeam.name} (Home)
                                                </button>
                                            </div>
                                            
                                            {/* Away Team Stats */}
                                            {gameDetailTeamTab === 'away' && (
                                                <div>
                                                    {/* Skaters */}
                                                    <h4 style={{ color: '#93c5fd', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">G</th>
                                                                <th className="text-center">A</th>
                                                                <th className="text-center">PTS</th>
                                                                <th className="text-center">+/-</th>
                                                                <th className="text-center">SOG</th>
                                                                <th className="text-center">TOI</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedGame.details.awayPlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(34, 197, 94, 0.1)' : 'transparent' }}>
                                                                    <td>
                                                                        <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                            {ps.player.firstName} {ps.player.lastName}
                                                                        </span>
                                                                        <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                            {ps.player.position}
                                                                        </span>
                                                                    </td>
                                                                    <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#22c55e' : 'inherit' }}>{ps.goals}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#22c55e' : 'inherit' }}>{ps.assists}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#22c55e' : 'inherit' }}>{ps.points}</td>
                                                                    <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                    <td className="text-center">{ps.shots}</td>
                                                                    <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                    
                                                    {/* Goalies */}
                                                    <h4 style={{ color: '#93c5fd', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">SA</th>
                                                                <th className="text-center">SV</th>
                                                                <th className="text-center">GA</th>
                                                                <th className="text-center">SV%</th>
                                                                <th className="text-center">Result</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedGame.details.awayPlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                const isWinner = selectedGame.awayScore > selectedGame.homeScore;
                                                                return (
                                                                    <tr key={ps.player.id}>
                                                                        <td>
                                                                            <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                {ps.player.firstName} {ps.player.lastName}
                                                                            </span>
                                                                        </td>
                                                                        <td className="text-center">{ps.shotsAgainst}</td>
                                                                        <td className="text-center">{ps.saves}</td>
                                                                        <td className="text-center">{ps.goalsAgainst}</td>
                                                                        <td className="text-center">{svPct}</td>
                                                                        <td className="text-center">
                                                                            <span style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                fontWeight: 'bold',
                                                                                background: isWinner ? '#22c55e' : '#ef4444'
                                                                            }}>
                                                                                {isWinner ? 'W' : 'L'}
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    
                                                    {/* DNP Players */}
                                                    {selectedGame.details.awayScratched?.length > 0 && (
                                                        <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                            <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                {selectedGame.details.awayScratched.map(p => (
                                                                    <span key={p.id} style={{ 
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(100, 116, 139, 0.2)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem',
                                                                        color: '#94a3b8'
                                                                    }}>
                                                                        {p.name}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {/* Home Team Stats */}
                                            {gameDetailTeamTab === 'home' && (
                                                <div>
                                                    {/* Skaters */}
                                                    <h4 style={{ color: '#93c5fd', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">G</th>
                                                                <th className="text-center">A</th>
                                                                <th className="text-center">PTS</th>
                                                                <th className="text-center">+/-</th>
                                                                <th className="text-center">SOG</th>
                                                                <th className="text-center">TOI</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedGame.details.homePlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(34, 197, 94, 0.1)' : 'transparent' }}>
                                                                    <td>
                                                                        <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                            {ps.player.firstName} {ps.player.lastName}
                                                                        </span>
                                                                        <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                            {ps.player.position}
                                                                        </span>
                                                                    </td>
                                                                    <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#22c55e' : 'inherit' }}>{ps.goals}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#22c55e' : 'inherit' }}>{ps.assists}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#22c55e' : 'inherit' }}>{ps.points}</td>
                                                                    <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                    <td className="text-center">{ps.shots}</td>
                                                                    <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                    
                                                    {/* Goalies */}
                                                    <h4 style={{ color: '#93c5fd', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">SA</th>
                                                                <th className="text-center">SV</th>
                                                                <th className="text-center">GA</th>
                                                                <th className="text-center">SV%</th>
                                                                <th className="text-center">Result</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedGame.details.homePlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                const isWinner = selectedGame.homeScore > selectedGame.awayScore;
                                                                return (
                                                                    <tr key={ps.player.id}>
                                                                        <td>
                                                                            <span style={{ cursor: 'pointer', color: '#22d3ee' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                {ps.player.firstName} {ps.player.lastName}
                                                                            </span>
                                                                        </td>
                                                                        <td className="text-center">{ps.shotsAgainst}</td>
                                                                        <td className="text-center">{ps.saves}</td>
                                                                        <td className="text-center">{ps.goalsAgainst}</td>
                                                                        <td className="text-center">{svPct}</td>
                                                                        <td className="text-center">
                                                                            <span style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                fontWeight: 'bold',
                                                                                background: isWinner ? '#22c55e' : '#ef4444'
                                                                            }}>
                                                                                {isWinner ? 'W' : 'L'}
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    
                                                    {/* DNP Players */}
                                                    {selectedGame.details.homeScratched?.length > 0 && (
                                                        <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                            <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                {selectedGame.details.homeScratched.map(p => (
                                                                    <span key={p.id} style={{ 
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(100, 116, 139, 0.2)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem',
                                                                        color: '#94a3b8'
                                                                    }}>
                                                                        {p.name}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </>
                                    );
                                })()
                            ) : (
                                // Old game without per-game stats
                                <div style={{ 
                                    padding: '2rem',
                                    background: 'rgba(251, 191, 36, 0.1)',
                                    borderRadius: '0.5rem',
                                    border: '1px solid rgba(251, 191, 36, 0.3)',
                                    textAlign: 'center'
                                }}>
                                    <h3 style={{ color: '#fbbf24', marginBottom: '1rem' }}>
                                        ‚ö†Ô∏è Per-Game Stats Not Available
                                    </h3>
                                    <p style={{ color: '#e2e8f0', marginBottom: '1rem', lineHeight: '1.6' }}>
                                        This game was simulated before the per-game stat tracking system was implemented.
                                    </p>
                                    <p style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                        üí° <strong>To see per-game stats:</strong> Simulate new games going forward. All future games will track detailed per-player statistics for each game!
                                    </p>
                                </div>
                            )}
                            
                            {/* Injury Report - Bottom of Page */}
                            {(() => {
                                const homeTeam = TEAMS.find(t => t.id === selectedGame.homeTeam);
                                const awayTeam = TEAMS.find(t => t.id === selectedGame.awayTeam);
                                const homeInjured = gameState.players.filter(p => p.teamId === selectedGame.homeTeam && p.injury.injured);
                                const awayInjured = gameState.players.filter(p => p.teamId === selectedGame.awayTeam && p.injury.injured);
                                
                                if (homeInjured.length === 0 && awayInjured.length === 0) return null;
                                
                                return (
                                    <div style={{ 
                                        marginTop: '3rem',
                                        padding: '1.5rem',
                                        background: 'rgba(239, 68, 68, 0.1)',
                                        borderRadius: '0.5rem',
                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                    }}>
                                        <h3 style={{ color: '#ef4444', marginBottom: '1.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            üè• Injury Report
                                        </h3>
                                        
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                                            {/* Away Team Injuries */}
                                            <div>
                                                <h4 style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1rem' }}>
                                                    {awayTeam.city} {awayTeam.name}
                                                </h4>
                                                {awayInjured.length > 0 ? (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                        {awayInjured.map(player => (
                                                            <div key={player.id} style={{
                                                                padding: '0.75rem',
                                                                background: 'rgba(239, 68, 68, 0.15)',
                                                                borderRadius: '0.375rem',
                                                                border: '1px solid rgba(239, 68, 68, 0.3)'
                                                            }}>
                                                                <div style={{ fontWeight: 'bold', color: '#fff', marginBottom: '0.25rem' }}>
                                                                    {player.firstName} {player.lastName}
                                                                    <span style={{ marginLeft: '0.5rem', fontSize: '0.85em', color: '#94a3b8' }}>
                                                                        {player.position}
                                                                    </span>
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#fca5a5' }}>
                                                                    {player.injury.type} - {player.injury.severity}
                                                                </div>
                                                                {player.injury.daysUntilReturn < 999 && (
                                                                    <div style={{ fontSize: '0.75rem', color: '#94a3b8', marginTop: '0.25rem' }}>
                                                                        ~{player.injury.daysUntilReturn} days until return
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p style={{ color: '#64748b', fontSize: '0.875rem', fontStyle: 'italic' }}>
                                                        No injuries
                                                    </p>
                                                )}
                                            </div>
                                            
                                            {/* Home Team Injuries */}
                                            <div>
                                                <h4 style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1rem' }}>
                                                    {homeTeam.city} {homeTeam.name}
                                                </h4>
                                                {homeInjured.length > 0 ? (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                        {homeInjured.map(player => (
                                                            <div key={player.id} style={{
                                                                padding: '0.75rem',
                                                                background: 'rgba(239, 68, 68, 0.15)',
                                                                borderRadius: '0.375rem',
                                                                border: '1px solid rgba(239, 68, 68, 0.3)'
                                                            }}>
                                                                <div style={{ fontWeight: 'bold', color: '#fff', marginBottom: '0.25rem' }}>
                                                                    {player.firstName} {player.lastName}
                                                                    <span style={{ marginLeft: '0.5rem', fontSize: '0.85em', color: '#94a3b8' }}>
                                                                        {player.position}
                                                                    </span>
                                                                </div>
                                                                <div style={{ fontSize: '0.875rem', color: '#fca5a5' }}>
                                                                    {player.injury.type} - {player.injury.severity}
                                                                </div>
                                                                {player.injury.daysUntilReturn < 999 && (
                                                                    <div style={{ fontSize: '0.75rem', color: '#94a3b8', marginTop: '0.25rem' }}>
                                                                        ~{player.injury.daysUntilReturn} days until return
                                                                    </div>
                                                                )}
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p style={{ color: '#64748b', fontSize: '0.875rem', fontStyle: 'italic' }}>
                                                        No injuries
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })()}
                        </div>
                    </div>
                )}

                {currentView === 'bracket' && (
                    <div className="card">
                        <h2>üèÜ Stanley Cup Playoffs Bracket</h2>
                        
                        {!playoffState && (
                            <div style={{ padding: '2rem', textAlign: 'center' }}>
                                <p style={{ fontSize: '1.2rem', color: '#93c5fd', marginBottom: '1rem' }}>
                                    Complete the regular season to start the playoffs!
                                </p>
                                <p style={{ color: '#64748b' }}>
                                    Top 8 teams from each conference will compete in best-of-7 series
                                </p>
                            </div>
                        )}
                        
                        {playoffState && (
                            <>
                                <BracketView playoffState={playoffState} TEAMS={TEAMS} />
                                
                                {playoffState.lastDaySummary && (
                                    <div style={{ marginTop: '2rem', padding: '1.5rem', background: 'rgba(34, 211, 238, 0.1)', borderRadius: '0.5rem', border: '2px solid rgba(34, 211, 238, 0.3)' }}>
                                        <h3 style={{ color: '#22d3ee', marginBottom: '1rem', textAlign: 'center' }}>
                                            {playoffState.lastDaySummary.title}
                                        </h3>
                                        
                                        {playoffState.lastDaySummary.subtitle && (
                                            <p style={{ textAlign: 'center', color: '#93c5fd', marginBottom: '1rem', fontSize: '0.9rem' }}>
                                                {playoffState.lastDaySummary.subtitle}
                                            </p>
                                        )}
                                        
                                        {playoffState.lastDaySummary.message && (
                                            <p style={{ textAlign: 'center', color: '#fff', fontSize: '1.1rem', padding: '1rem' }}>
                                                {playoffState.lastDaySummary.message}
                                            </p>
                                        )}
                                        
                                        {playoffState.lastDaySummary.restDays && (
                                            <p style={{ textAlign: 'center', color: '#fbbf24', fontWeight: 'bold', marginTop: '0.5rem' }}>
                                                ‚è∏Ô∏è {playoffState.lastDaySummary.restDays} days rest before next games
                                            </p>
                                        )}
                                        
                                        {playoffState.lastDaySummary.results && playoffState.lastDaySummary.results.length > 0 && (
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '0.75rem', marginTop: '1rem' }}>
                                                {playoffState.lastDaySummary.results.map((result, idx) => (
                                                    <div key={idx} style={{ 
                                                        padding: '0.75rem', 
                                                        background: result.seriesComplete ? 'rgba(34, 197, 94, 0.15)' : 'rgba(30, 58, 138, 0.3)',
                                                        borderRadius: '0.375rem',
                                                        border: result.seriesComplete ? '2px solid #22c55e' : '1px solid rgba(59, 130, 246, 0.3)',
                                                        cursor: 'pointer',
                                                        transition: 'all 0.2s'
                                                    }}
                                                    onMouseOver={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                                                    onMouseOut={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                                    onClick={() => {
                                                        setSelectedPlayoffGame(result);
                                                        navigateTo('playoffGameStats', result);
                                                    }}
                                                    >
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                                            <div style={{ flex: 1 }}>
                                                                <div style={{ 
                                                                    fontWeight: result.winner.id === result.homeTeam.id ? 'bold' : 'normal',
                                                                    color: result.winner.id === result.homeTeam.id ? '#22c55e' : '#fff',
                                                                    fontSize: '0.95rem'
                                                                }}>
                                                                    {result.homeTeam.city}
                                                                </div>
                                                                <div style={{ 
                                                                    fontWeight: result.winner.id === result.awayTeam.id ? 'bold' : 'normal',
                                                                    color: result.winner.id === result.awayTeam.id ? '#22c55e' : '#fff',
                                                                    fontSize: '0.95rem',
                                                                    marginTop: '0.25rem'
                                                                }}>
                                                                    {result.awayTeam.city}
                                                                </div>
                                                            </div>
                                                            
                                                            <div style={{ textAlign: 'center', padding: '0 0.75rem' }}>
                                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: result.winner.id === result.homeTeam.id ? '#22c55e' : '#fff' }}>
                                                                    {result.homeScore}
                                                                </div>
                                                                <div style={{ fontSize: '1.25rem', fontWeight: 'bold', color: result.winner.id === result.awayTeam.id ? '#22c55e' : '#fff', marginTop: '0.25rem' }}>
                                                                    {result.awayScore}
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.75rem', textAlign: 'center' }}>
                                                            Series: {result.homeWins}-{result.awayWins}
                                                        </div>
                                                        {result.seriesComplete && !result.champion && (
                                                            <div style={{ color: '#22c55e', fontWeight: 'bold', marginTop: '0.5rem', fontSize: '0.8rem', textAlign: 'center' }}>
                                                                üèÜ {result.winner.city} wins!
                                                            </div>
                                                        )}
                                                        {result.champion && (
                                                            <div style={{ color: '#fbbf24', fontWeight: 'bold', fontSize: '0.85rem', marginTop: '0.5rem', textAlign: 'center' }}>
                                                                üèÜ CHAMPIONS! üèÜ
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                )}

                {currentView === 'playoffGames' && playoffState && (
                    <div className="card">
                        <h2>Playoff Games</h2>
                        <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                            Click on any game to view detailed stats
                        </p>
                        
                        {(() => {
                            const allGames = [];
                            
                            // Build complete history including current round
                            const completeHistory = {
                                eastRound1: playoffState.history?.eastRound1 || (playoffState.round === 1 ? playoffState.eastMatchups : []),
                                westRound1: playoffState.history?.westRound1 || (playoffState.round === 1 ? playoffState.westMatchups : []),
                                eastRound2: playoffState.history?.eastRound2 || (playoffState.round === 2 ? playoffState.eastMatchups : []),
                                westRound2: playoffState.history?.westRound2 || (playoffState.round === 2 ? playoffState.westMatchups : []),
                                eastRound3: playoffState.history?.eastRound3 || (playoffState.round === 3 ? playoffState.eastMatchups : []),
                                westRound3: playoffState.history?.westRound3 || (playoffState.round === 3 ? playoffState.westMatchups : []),
                                final: playoffState.history?.final || (playoffState.round === 4 ? playoffState.finalMatchup : null)
                            };
                            
                            // Override with CURRENT round if in progress
                            if (playoffState.round === 1) {
                                completeHistory.eastRound1 = playoffState.eastMatchups;
                                completeHistory.westRound1 = playoffState.westMatchups;
                            } else if (playoffState.round === 2) {
                                completeHistory.eastRound2 = playoffState.eastMatchups;
                                completeHistory.westRound2 = playoffState.westMatchups;
                            } else if (playoffState.round === 3) {
                                completeHistory.eastRound3 = playoffState.eastMatchups;
                                completeHistory.westRound3 = playoffState.westMatchups;
                            } else if (playoffState.round === 4) {
                                completeHistory.final = playoffState.finalMatchup;
                            }
                            
                            // Collect all games from complete history
                            const rounds = [
                                { key: 'eastRound1', name: 'Eastern Conference - Round 1', matchups: completeHistory.eastRound1 },
                                { key: 'westRound1', name: 'Western Conference - Round 1', matchups: completeHistory.westRound1 },
                                { key: 'eastRound2', name: 'Eastern Conference - Round 2', matchups: completeHistory.eastRound2 },
                                { key: 'westRound2', name: 'Western Conference - Round 2', matchups: completeHistory.westRound2 },
                                { key: 'eastRound3', name: 'Eastern Conference Finals', matchups: completeHistory.eastRound3 },
                                { key: 'westRound3', name: 'Western Conference Finals', matchups: completeHistory.westRound3 },
                                { key: 'final', name: 'Stanley Cup Finals', matchups: completeHistory.final ? [completeHistory.final] : [] }
                            ];
                            
                            rounds.forEach(round => {
                                if (round.matchups && round.matchups.length > 0) {
                                    round.matchups.forEach((matchup, matchupIdx) => {
                                        if (matchup && matchup.games && matchup.games.length > 0) {
                                            matchup.games.forEach((game, gameIdx) => {
                                                const homeTeam = TEAMS.find(t => t.id === game.homeTeam);
                                                const awayTeam = TEAMS.find(t => t.id === game.awayTeam);
                                                allGames.push({
                                                    ...game,
                                                    round: round.name,
                                                    gameNumber: gameIdx + 1,
                                                    homeTeam,
                                                    awayTeam,
                                                    matchup
                                                });
                                            });
                                        }
                                    });
                                }
                            });
                            
                            if (allGames.length === 0) {
                                return <p style={{ color: '#93c5fd' }}>No playoff games have been played yet.</p>;
                            }
                            
                            // Group games by round
                            const gamesByRound = {};
                            allGames.forEach(game => {
                                if (!gamesByRound[game.round]) gamesByRound[game.round] = [];
                                gamesByRound[game.round].push(game);
                            });
                            
                            return Object.keys(gamesByRound).map(roundName => (
                                <div key={roundName} style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>{roundName}</h3>
                                    <div style={{ display: 'grid', gap: '0.75rem' }}>
                                        {gamesByRound[roundName].map((game, idx) => (
                                            <div 
                                                key={idx}
                                                onClick={() => {
                                                    navigateTo('playoffGameStats', game);
                                                }}
                                                style={{
                                                    padding: '1rem',
                                                    background: 'rgba(30, 58, 138, 0.3)',
                                                    borderRadius: '0.5rem',
                                                    border: '1px solid rgba(59, 130, 246, 0.3)',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s',
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center'
                                                }}
                                                onMouseOver={(e) => e.currentTarget.style.background = 'rgba(30, 64, 175, 0.4)'}
                                                onMouseOut={(e) => e.currentTarget.style.background = 'rgba(30, 58, 138, 0.3)'}
                                            >
                                                <div style={{ flex: 1 }}>
                                                    <div style={{ color: '#93c5fd', fontSize: '0.875rem', marginBottom: '0.5rem' }}>
                                                        Game {game.gameNumber}
                                                    </div>
                                                    <div style={{ fontSize: '1.1rem' }}>
                                                        <span style={{ 
                                                            fontWeight: game.winner === game.homeTeam.id ? 'bold' : 'normal',
                                                            color: game.winner === game.homeTeam.id ? '#22c55e' : '#fff'
                                                        }}>
                                                            {game.homeTeam.city} {game.homeTeam.name}
                                                        </span>
                                                        <span style={{ margin: '0 0.5rem', color: '#93c5fd' }}>vs</span>
                                                        <span style={{ 
                                                            fontWeight: game.winner === game.awayTeam.id ? 'bold' : 'normal',
                                                            color: game.winner === game.awayTeam.id ? '#22c55e' : '#fff'
                                                        }}>
                                                            {game.awayTeam.city} {game.awayTeam.name}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style={{ 
                                                    fontSize: '1.5rem', 
                                                    fontWeight: 'bold',
                                                    color: '#22d3ee',
                                                    minWidth: '80px',
                                                    textAlign: 'center'
                                                }}>
                                                    {game.homeScore} - {game.awayScore}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                    View Stats ‚Üí
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ));
                        })()}
                    </div>
                )}

                {currentView === 'playoffGameStats' && selectedPlayoffGame && (
                    <div>
                        <button 
                            onClick={goBack}
                            style={{
                                padding: '0.5rem 1rem',
                                background: '#2563eb',
                                color: '#fff',
                                border: 'none',
                                borderRadius: '0.375rem',
                                cursor: 'pointer',
                                marginBottom: '1rem',
                                fontWeight: 'bold'
                            }}
                        >
                            ‚Üê Back
                        </button>
                        
                        <div className="card">
                            <h2>{selectedPlayoffGame.round} - Game {selectedPlayoffGame.gameNumber}</h2>
                            <p style={{ color: '#f59e0b', marginBottom: '1rem', fontSize: '1.1rem', fontWeight: 'bold' }}>
                                üèÜ Stanley Cup Playoffs
                            </p>
                            
                            <div style={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                padding: '2rem',
                                background: 'rgba(30, 58, 138, 0.3)',
                                borderRadius: '0.5rem',
                                marginBottom: '2rem'
                            }}>
                                <div style={{ textAlign: 'center', flex: 1 }}>
                                    <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                        {selectedPlayoffGame.awayTeam.city} {selectedPlayoffGame.awayTeam.name}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                        AWAY
                                    </div>
                                    <div style={{ 
                                        fontSize: '4rem', 
                                        fontWeight: 'bold',
                                        color: selectedPlayoffGame.winner === selectedPlayoffGame.awayTeam.id ? '#22c55e' : '#fff'
                                    }}>
                                        {selectedPlayoffGame.awayScore}
                                    </div>
                                </div>
                                <div style={{ fontSize: '3rem', color: '#93c5fd', padding: '0 2rem' }}>
                                    @
                                </div>
                                <div style={{ textAlign: 'center', flex: 1 }}>
                                    <div style={{ fontSize: '1.5rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                        {selectedPlayoffGame.homeTeam.city} {selectedPlayoffGame.homeTeam.name}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                        HOME
                                    </div>
                                    <div style={{ 
                                        fontSize: '4rem', 
                                        fontWeight: 'bold',
                                        color: selectedPlayoffGame.winner === selectedPlayoffGame.homeTeam.id ? '#22c55e' : '#fff'
                                    }}>
                                        {selectedPlayoffGame.homeScore}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Winner Badge */}
                            {(() => {
                                const winner = selectedPlayoffGame.winner === selectedPlayoffGame.homeTeam.id ? 
                                    selectedPlayoffGame.homeTeam : selectedPlayoffGame.awayTeam;
                                
                                return (
                                    <div style={{ 
                                        padding: '1rem',
                                        background: 'rgba(34, 197, 94, 0.15)',
                                        borderRadius: '0.5rem',
                                        marginBottom: '2rem',
                                        textAlign: 'center',
                                        border: '2px solid #22c55e'
                                    }}>
                                        <div style={{ color: '#22c55e', fontSize: '1.2rem', fontWeight: 'bold' }}>
                                            üèÜ WINNER: {winner.city} {winner.name}
                                        </div>
                                    </div>
                                );
                            })()}
                            
                            {/* Series Status */}
                            <div style={{ 
                                padding: '1rem',
                                background: 'rgba(245, 158, 11, 0.1)',
                                borderRadius: '0.5rem',
                                marginBottom: '2rem',
                                textAlign: 'center',
                                border: '1px solid rgba(245, 158, 11, 0.3)'
                            }}>
                                <div style={{ color: '#f59e0b', fontSize: '1.1rem', fontWeight: 'bold' }}>
                                    Series: {selectedPlayoffGame.homeTeam.city} leads {selectedPlayoffGame.matchup.homeWins}-{selectedPlayoffGame.matchup.awayWins}
                                </div>
                            </div>
                            
                            {/* Detailed Stats - Same as regular season */}
                            {selectedPlayoffGame.details && selectedPlayoffGame.details.homePlayerStats ? (
                                (() => {
                                    // Use same rendering as regular season games but with playoff stats
                                    return (
                                        <>
                                            {/* Period-by-Period Scoring Summary */}
                                            {selectedPlayoffGame.details.scoringSummary && selectedPlayoffGame.details.scoringSummary.some(p => p.goals.length > 0) && (
                                                <div style={{ marginBottom: '2rem' }}>
                                                    <h3 style={{ color: '#f59e0b', marginBottom: '1.5rem' }}>‚ö° Scoring Summary</h3>
                                                    {selectedPlayoffGame.details.scoringSummary.map((period, idx) => {
                                                        if (period.goals.length === 0) return null;
                                                        
                                                        // Track running totals for THIS PLAYOFF RUN
                                                        const gameRunningTotals = {};
                                                        
                                                        // Get pre-game PLAYOFF stats (not regular season)
                                                        const getPreGamePlayoffStats = (playerId) => {
                                                            // Find all playoff games before this one
                                                            const allPlayoffGames = [];
                                                            
                                                            // Collect games from playoff state
                                                            if (playoffState) {
                                                                // Would need to iterate through all matchups/games before this one
                                                                // For now, just use player's current playoff stats minus this game
                                                                const player = gameState.players.find(p => p.id === playerId);
                                                                if (player) {
                                                                    const thisGameStats = selectedPlayoffGame.details.homePlayerStats?.find(ps => ps.player.id === playerId) ||
                                                                                        selectedPlayoffGame.details.awayPlayerStats?.find(ps => ps.player.id === playerId);
                                                                    return {
                                                                        goals: (player.playoffStats.goals || 0) - (thisGameStats?.goals || 0),
                                                                        assists: (player.playoffStats.assists || 0) - (thisGameStats?.assists || 0)
                                                                    };
                                                                }
                                                            }
                                                            return { goals: 0, assists: 0 };
                                                        };
                                                        
                                                        return (
                                                            <div key={period.period} style={{ 
                                                                marginBottom: '1.5rem',
                                                                padding: '1rem',
                                                                background: 'rgba(245, 158, 11, 0.1)',
                                                                borderRadius: '0.5rem',
                                                                border: '1px solid rgba(245, 158, 11, 0.3)'
                                                            }}>
                                                                <h4 style={{ color: '#fbbf24', marginBottom: '1rem', fontSize: '1rem' }}>
                                                                    {period.period === 1 ? '1st' : period.period === 2 ? '2nd' : '3rd'} Period
                                                                </h4>
                                                                {period.goals.map((goal, goalIdx) => {
                                                                    const team = goal.team === 'home' ? selectedPlayoffGame.homeTeam : selectedPlayoffGame.awayTeam;
                                                                    const preGameStats = getPreGamePlayoffStats(goal.scorer.id);
                                                                    
                                                                    if (!gameRunningTotals[goal.scorer.id]) {
                                                                        gameRunningTotals[goal.scorer.id] = { goals: 0, assists: 0 };
                                                                    }
                                                                    gameRunningTotals[goal.scorer.id].goals++;
                                                                    
                                                                    const playoffGoalTotal = preGameStats.goals + gameRunningTotals[goal.scorer.id].goals;
                                                                    
                                                                    return (
                                                                        <div key={goalIdx} style={{ 
                                                                            marginBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                            paddingBottom: goalIdx < period.goals.length - 1 ? '0.75rem' : '0',
                                                                            borderBottom: goalIdx < period.goals.length - 1 ? '1px solid rgba(100, 116, 139, 0.3)' : 'none'
                                                                        }}>
                                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.25rem' }}>
                                                                                <span style={{ 
                                                                                    padding: '0.25rem 0.5rem',
                                                                                    background: goal.team === 'home' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                                                                                    borderRadius: '0.25rem',
                                                                                    fontSize: '0.75rem',
                                                                                    fontWeight: 'bold',
                                                                                    color: goal.team === 'home' ? '#22c55e' : '#3b82f6'
                                                                                }}>
                                                                                    {team.abbreviation}
                                                                                </span>
                                                                                <span style={{ fontWeight: 'bold', color: '#fff' }}>
                                                                                    {goal.scorer.name}
                                                                                </span>
                                                                                <span style={{ 
                                                                                    fontSize: '0.85rem',
                                                                                    color: '#f59e0b',
                                                                                    fontWeight: 'bold'
                                                                                }}>
                                                                                    ({playoffGoalTotal})
                                                                                </span>
                                                                            </div>
                                                                            {goal.assists.length > 0 && (
                                                                                <div style={{ 
                                                                                    fontSize: '0.875rem', 
                                                                                    color: '#94a3b8',
                                                                                    marginLeft: '2.5rem'
                                                                                }}>
                                                                                    Assists: {goal.assists.map((assist, aIdx) => {
                                                                                        const assistPreGameStats = getPreGamePlayoffStats(assist.id);
                                                                                        
                                                                                        if (!gameRunningTotals[assist.id]) {
                                                                                            gameRunningTotals[assist.id] = { goals: 0, assists: 0 };
                                                                                        }
                                                                                        gameRunningTotals[assist.id].assists++;
                                                                                        
                                                                                        const playoffAssistTotal = assistPreGameStats.assists + gameRunningTotals[assist.id].assists;
                                                                                        
                                                                                        return (
                                                                                            <span key={assist.id}>
                                                                                                {assist.name} <span style={{ color: '#f59e0b', fontWeight: 'bold' }}>({playoffAssistTotal})</span>
                                                                                                {aIdx < goal.assists.length - 1 ? ', ' : ''}
                                                                                            </span>
                                                                                        );
                                                                                    })}
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                            
                                            {/* Team Tabs */}
                                            <div style={{ 
                                                display: 'flex', 
                                                gap: '0.5rem',
                                                marginBottom: '1.5rem',
                                                borderBottom: '2px solid rgba(245, 158, 11, 0.3)'
                                            }}>
                                                <button
                                                    onClick={() => setGameDetailTeamTab('away')}
                                                    style={{
                                                        padding: '0.75rem 1.5rem',
                                                        background: gameDetailTeamTab === 'away' ? 'rgba(245, 158, 11, 0.2)' : 'transparent',
                                                        border: 'none',
                                                        borderBottom: gameDetailTeamTab === 'away' ? '3px solid #f59e0b' : '3px solid transparent',
                                                        color: gameDetailTeamTab === 'away' ? '#f59e0b' : '#94a3b8',
                                                        cursor: 'pointer',
                                                        fontWeight: gameDetailTeamTab === 'away' ? 'bold' : 'normal',
                                                        fontSize: '1rem',
                                                        transition: 'all 0.2s'
                                                    }}
                                                >
                                                    {selectedPlayoffGame.awayTeam.city} {selectedPlayoffGame.awayTeam.name} (Away)
                                                </button>
                                                <button
                                                    onClick={() => setGameDetailTeamTab('home')}
                                                    style={{
                                                        padding: '0.75rem 1.5rem',
                                                        background: gameDetailTeamTab === 'home' ? 'rgba(245, 158, 11, 0.2)' : 'transparent',
                                                        border: 'none',
                                                        borderBottom: gameDetailTeamTab === 'home' ? '3px solid #f59e0b' : '3px solid transparent',
                                                        color: gameDetailTeamTab === 'home' ? '#f59e0b' : '#94a3b8',
                                                        cursor: 'pointer',
                                                        fontWeight: gameDetailTeamTab === 'home' ? 'bold' : 'normal',
                                                        fontSize: '1rem',
                                                        transition: 'all 0.2s'
                                                    }}
                                                >
                                                    {selectedPlayoffGame.homeTeam.city} {selectedPlayoffGame.homeTeam.name} (Home)
                                                </button>
                                            </div>
                                            
                                            {/* Show stats for selected team */}
                                            {gameDetailTeamTab === 'away' && (
                                                <div>
                                                    <h4 style={{ color: '#fbbf24', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">G</th>
                                                                <th className="text-center">A</th>
                                                                <th className="text-center">PTS</th>
                                                                <th className="text-center">+/-</th>
                                                                <th className="text-center">SOG</th>
                                                                <th className="text-center">TOI</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedPlayoffGame.details.awayPlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(245, 158, 11, 0.1)' : 'transparent' }}>
                                                                    <td>
                                                                        <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                            {ps.player.firstName} {ps.player.lastName}
                                                                        </span>
                                                                        <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                            {ps.player.position}
                                                                        </span>
                                                                    </td>
                                                                    <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#f59e0b' : 'inherit' }}>{ps.goals}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#f59e0b' : 'inherit' }}>{ps.assists}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#f59e0b' : 'inherit' }}>{ps.points}</td>
                                                                    <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                    <td className="text-center">{ps.shots}</td>
                                                                    <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                    
                                                    <h4 style={{ color: '#fbbf24', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">SA</th>
                                                                <th className="text-center">SV</th>
                                                                <th className="text-center">GA</th>
                                                                <th className="text-center">SV%</th>
                                                                <th className="text-center">Result</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedPlayoffGame.details.awayPlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                const isWinner = selectedPlayoffGame.winner === selectedPlayoffGame.awayTeam.id;
                                                                return (
                                                                    <tr key={ps.player.id}>
                                                                        <td>
                                                                            <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                {ps.player.firstName} {ps.player.lastName}
                                                                            </span>
                                                                        </td>
                                                                        <td className="text-center">{ps.shotsAgainst}</td>
                                                                        <td className="text-center">{ps.saves}</td>
                                                                        <td className="text-center">{ps.goalsAgainst}</td>
                                                                        <td className="text-center">{svPct}</td>
                                                                        <td className="text-center">
                                                                            <span style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                fontWeight: 'bold',
                                                                                background: isWinner ? '#22c55e' : '#ef4444'
                                                                            }}>
                                                                                {isWinner ? 'W' : 'L'}
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    
                                                    {selectedPlayoffGame.details.awayScratched?.length > 0 && (
                                                        <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                            <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                {selectedPlayoffGame.details.awayScratched.map(p => (
                                                                    <span key={p.id} style={{ 
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(100, 116, 139, 0.2)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem',
                                                                        color: '#94a3b8'
                                                                    }}>
                                                                        {p.name}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            
                                            {gameDetailTeamTab === 'home' && (
                                                <div>
                                                    <h4 style={{ color: '#fbbf24', marginTop: '1rem', marginBottom: '0.75rem' }}>Skaters</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">G</th>
                                                                <th className="text-center">A</th>
                                                                <th className="text-center">PTS</th>
                                                                <th className="text-center">+/-</th>
                                                                <th className="text-center">SOG</th>
                                                                <th className="text-center">TOI</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedPlayoffGame.details.homePlayerStats.filter(ps => ps.player.position !== 'G').sort((a, b) => b.points - a.points).map(ps => (
                                                                <tr key={ps.player.id} style={{ background: ps.points > 0 ? 'rgba(245, 158, 11, 0.1)' : 'transparent' }}>
                                                                    <td>
                                                                        <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                            {ps.player.firstName} {ps.player.lastName}
                                                                        </span>
                                                                        <span style={{ color: '#64748b', marginLeft: '0.5rem', fontSize: '0.85em' }}>
                                                                            {ps.player.position}
                                                                        </span>
                                                                    </td>
                                                                    <td className="text-center" style={{ fontWeight: ps.goals > 0 ? 'bold' : 'normal', color: ps.goals > 0 ? '#f59e0b' : 'inherit' }}>{ps.goals}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.assists > 0 ? 'bold' : 'normal', color: ps.assists > 0 ? '#f59e0b' : 'inherit' }}>{ps.assists}</td>
                                                                    <td className="text-center" style={{ fontWeight: ps.points > 0 ? 'bold' : 'normal', color: ps.points > 0 ? '#f59e0b' : 'inherit' }}>{ps.points}</td>
                                                                    <td className="text-center">{ps.plusMinus > 0 ? '+' : ''}{ps.plusMinus}</td>
                                                                    <td className="text-center">{ps.shots}</td>
                                                                    <td className="text-center">{formatTOI(ps.toi)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                    
                                                    <h4 style={{ color: '#fbbf24', marginTop: '1.5rem', marginBottom: '0.75rem' }}>Goalies</h4>
                                                    <table className="stats-table">
                                                        <thead>
                                                            <tr>
                                                                <th>Player</th>
                                                                <th className="text-center">SA</th>
                                                                <th className="text-center">SV</th>
                                                                <th className="text-center">GA</th>
                                                                <th className="text-center">SV%</th>
                                                                <th className="text-center">Result</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {selectedPlayoffGame.details.homePlayerStats.filter(ps => ps.player.position === 'G' && ps.shotsAgainst > 0).map(ps => {
                                                                const svPct = ps.shotsAgainst > 0 ? (ps.saves / ps.shotsAgainst).toFixed(3) : '.000';
                                                                const isWinner = selectedPlayoffGame.winner === selectedPlayoffGame.homeTeam.id;
                                                                return (
                                                                    <tr key={ps.player.id}>
                                                                        <td>
                                                                            <span style={{ cursor: 'pointer', color: '#f59e0b' }} onClick={() => navigateTo('playerProfile', ps.player)}>
                                                                                {ps.player.firstName} {ps.player.lastName}
                                                                            </span>
                                                                        </td>
                                                                        <td className="text-center">{ps.shotsAgainst}</td>
                                                                        <td className="text-center">{ps.saves}</td>
                                                                        <td className="text-center">{ps.goalsAgainst}</td>
                                                                        <td className="text-center">{svPct}</td>
                                                                        <td className="text-center">
                                                                            <span style={{ 
                                                                                padding: '0.25rem 0.5rem',
                                                                                borderRadius: '0.25rem',
                                                                                fontSize: '0.75rem',
                                                                                fontWeight: 'bold',
                                                                                background: isWinner ? '#22c55e' : '#ef4444'
                                                                            }}>
                                                                                {isWinner ? 'W' : 'L'}
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                    
                                                    {selectedPlayoffGame.details.homeScratched?.length > 0 && (
                                                        <div style={{ marginTop: '1.5rem', padding: '0.75rem', background: 'rgba(100, 116, 139, 0.1)', borderRadius: '0.375rem' }}>
                                                            <h5 style={{ color: '#64748b', fontSize: '0.875rem', marginBottom: '0.5rem' }}>Healthy Scratches:</h5>
                                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                                                {selectedPlayoffGame.details.homeScratched.map(p => (
                                                                    <span key={p.id} style={{ 
                                                                        padding: '0.25rem 0.5rem',
                                                                        background: 'rgba(100, 116, 139, 0.2)',
                                                                        borderRadius: '0.25rem',
                                                                        fontSize: '0.75rem',
                                                                        color: '#94a3b8'
                                                                    }}>
                                                                        {p.name}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                        </>
                                    );
                                })()
                            ) : (
                                <div style={{ 
                                    padding: '2rem',
                                    background: 'rgba(251, 191, 36, 0.1)',
                                    borderRadius: '0.5rem',
                                    border: '1px solid rgba(251, 191, 36, 0.3)',
                                    textAlign: 'center'
                                }}>
                                    <p style={{ color: '#fbbf24', fontSize: '1.1rem' }}>
                                        Per-game stats not available for this playoff game.
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* RE-SIGN PLAYERS PAGE */}
                {currentView === 'resignPlayers' && gameState && (
                    <div>
                        <div className="card">
                            <h1 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üìù Re-Sign Players</h1>
                            <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                Negotiate contract extensions with players in their final contract year
                            </p>
                            
                            {(() => {
                                const userPlayers = gameState.players.filter(p => 
                                    p.teamId === userTeamId && 
                                    p.contract && 
                                    p.contract.yearsRemaining === 1
                                );
                                
                                if (userPlayers.length === 0) {
                                    return (
                                        <div style={{
                                            padding: '3rem',
                                            textAlign: 'center',
                                            color: '#93c5fd'
                                        }}>
                                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>‚úÖ</div>
                                            <h3 style={{ color: '#22c55e', marginBottom: '0.5rem' }}>All Set!</h3>
                                            <p>No players in their final contract year</p>
                                        </div>
                                    );
                                }
                                
                                // Pre-calculate market values for all players
                                const playerData = userPlayers.map(player => ({
                                    player,
                                    marketValue: calculateMarketValue(player),
                                    preferredLength: calculatePreferredLength(player)
                                })).sort((a, b) => b.player.ratings.overall - a.player.ratings.overall);
                                
                                return (
                                    <div style={{ display: 'grid', gap: '1rem' }}>
                                        {playerData.map(({ player, marketValue, preferredLength }) => {
                                                return (
                                                    <div
                                                        key={player.id}
                                                        style={{
                                                            padding: '1.5rem',
                                                            background: 'rgba(30, 58, 138, 0.3)',
                                                            border: '2px solid #3b82f6',
                                                            borderRadius: '0.75rem',
                                                            display: 'flex',
                                                            justifyContent: 'space-between',
                                                            alignItems: 'center',
                                                            gap: '2rem'
                                                        }}
                                                    >
                                                        <div style={{ flex: 1 }}>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '0.5rem' }}>
                                                                <h3 style={{ color: '#e2e8f0', margin: 0, fontSize: '1.3rem' }}>
                                                                    {player.firstName} {player.lastName}
                                                                </h3>
                                                                <span style={{
                                                                    padding: '0.25rem 0.75rem',
                                                                    background: player.ratings.overall >= 85 ? '#22c55e' : 
                                                                               player.ratings.overall >= 80 ? '#3b82f6' : '#94a3b8',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.9rem',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {player.ratings.overall} OVR
                                                                </span>
                                                            </div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.95rem' }}>
                                                                {player.position} ‚Ä¢ Age {player.age} ‚Ä¢ Current: {formatSalary(player.contract.salary)}/year
                                                            </div>
                                                            <div style={{ 
                                                                marginTop: '0.75rem',
                                                                padding: '0.75rem',
                                                                background: 'rgba(245, 158, 11, 0.2)',
                                                                borderRadius: '0.375rem',
                                                                fontSize: '0.9rem'
                                                            }}>
                                                                <div style={{ color: '#fbbf24', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                                    Player's Asking Price
                                                                </div>
                                                                <div style={{ color: '#e2e8f0' }}>
                                                                    {formatSalary(marketValue)}/year √ó {preferredLength} years
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <button
                                                            onClick={() => {
                                                                setSelectedPlayerProfile(player);
                                                                setContractOffer({ 
                                                                    salary: marketValue,
                                                                    years: preferredLength
                                                                });
                                                                setShowContractNegotiation(true);
                                                            }}
                                                            style={{
                                                                padding: '1rem 1.5rem',
                                                                background: 'linear-gradient(135deg, #3b82f6, #1e40af)',
                                                                border: 'none',
                                                                borderRadius: '0.5rem',
                                                                color: 'white',
                                                                fontSize: '1rem',
                                                                fontWeight: 'bold',
                                                                cursor: 'pointer',
                                                                whiteSpace: 'nowrap'
                                                            }}
                                                        >
                                                            Negotiate ‚Üí
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                    </div>
                                );
                            })()}
                        </div>
                    </div>
                )}
                
                {currentView === 'trade' && gameState && (() => {
// NEW TRADE UI - Clean Design with Modals

// Trade evaluation functions
const calculateTradeValue = (playerIds, pickIds = []) => {
    const players = playerIds.map(id => gameState.players.find(p => p.id === id));
    const picks = pickIds.map(id => gameState.draftPicks?.find(p => p.id === id)).filter(Boolean);
    
    const starCount = players.filter(p => p.ratings.overall >= GAME_CONFIG.STAR_THRESHOLD).length;
    const eliteCount = players.filter(p => p.ratings.overall >= GAME_CONFIG.ELITE_THRESHOLD).length;
    
    // Calculate draft pick value using proper valuation
    let totalPickValue = 0;
    let totalPickTradeValue = 0;
    picks.forEach(pick => {
const pickValue = calculateDraftPickValue(
    pick, 
    gameState.standings, 
    gameState.teamProfiles,
    draftProspects,
    gameState.year
);
totalPickValue += pickValue;
// Trade value uses squared formula to emphasize quality
totalPickTradeValue += Math.pow(pickValue / 10, 2);
    });
    
    // Calculate TRADE VALUE (quality > quantity)
    // Use OVR^2 formula to heavily favor star players over depth
    const playerTradeValues = players.map(p => {
const ovr = p.ratings.overall;
// Scale: Square the OVR but divide by 10 to keep numbers reasonable
// 90 OVR = 810 trade value
// 80 OVR = 640 trade value  
// 70 OVR = 490 trade value
// 60 OVR = 360 trade value
// 50 OVR = 250 trade value
return Math.pow(ovr / 10, 2) * 10;
    });
    
    const totalTradeValue = playerTradeValues.reduce((sum, val) => sum + val, 0) + totalPickTradeValue;
    
    return {
players: players,
picks: picks,
totalOVR: players.reduce((sum, p) => sum + p.ratings.overall, 0) + totalPickValue,
avgOVR: (players.reduce((sum, p) => sum + p.ratings.overall, 0) + totalPickValue) / (players.length + picks.length || 1),
tradeValue: Math.round(totalTradeValue), // NEW: Trade value score
totalPOT: players.reduce((sum, p) => sum + p.ratings.potential, 0),
avgAge: players.length > 0 ? players.reduce((sum, p) => sum + p.age, 0) / players.length : 0,
totalPts: players.reduce((sum, p) => sum + (p.stats?.points || 0), 0),
starCount: starCount,
eliteCount: eliteCount,
hasGoalie: players.some(p => p.position === 'G'),
pickValue: totalPickValue,
positions: {
    F: players.filter(p => p.position === 'F').length,
    D: players.filter(p => p.position === 'D').length,
    G: players.filter(p => p.position === 'G').length
}
    };
};

const evaluateTrade = () => {
    const myValue = calculateTradeValue(mySelectedPlayers, mySelectedPicks);
    const theirValue = calculateTradeValue(theirSelectedPlayers, theirSelectedPicks);
    
    // Use TRADE VALUE (quality-weighted) for fairness assessment
    const tradeValueDiff = Math.abs(myValue.tradeValue - theirValue.tradeValue);
    const tradeValueDiffPercent = (tradeValueDiff / Math.max(myValue.tradeValue, theirValue.tradeValue)) * 100;
    
    // Keep OVR for display purposes
    const ovrDiff = Math.abs(myValue.totalOVR - theirValue.totalOVR);
    const ovrDiffPercent = (ovrDiff / Math.max(myValue.totalOVR, theirValue.totalOVR)) * 100;
    
    return {
myValue,
theirValue,
ovrDiff,
ovrDiffPercent,
tradeValueDiff,
tradeValueDiffPercent,
isLopsided: tradeValueDiffPercent > 15 // Use trade value for lopsided check
    };
};

                    const proposeTrade = () => {
                        const evaluation = evaluateTrade();
                        const myPlayers = mySelectedPlayers.map(id => gameState.players.find(p => p.id === id)).filter(Boolean);
                        const theirPlayers = theirSelectedPlayers.map(id => gameState.players.find(p => p.id === id)).filter(Boolean);
                        
                        // Safety check: make sure all players were found
                        if (myPlayers.length !== mySelectedPlayers.length || theirPlayers.length !== theirSelectedPlayers.length) {
                            setTradeMessage({
                                type: 'error',
                                text: '‚ùå Error: Some selected players could not be found. Please refresh and try again.'
                            });
                            return;
                        }
                        
                        // Check for injured players
                        const myInjured = myPlayers.filter(p => p.injury.injured);
                        const theirInjured = theirPlayers.filter(p => p.injury.injured);
                        
                        if (myInjured.length > 0 || theirInjured.length > 0) {
                            setTradeMessage({
                                type: 'error',
                                text: '‚ùå Cannot trade injured players!'
                            });
                            return;
                        }
                        
                        // AI Trade Logic (Enhanced)
                        const theirTeam = getTeam(tradePartnerTeamId);
                        const theirStanding = gameState.standings.find(s => s.teamId === tradePartnerTeamId);
                        
                        // Check if standing exists
                        if (!theirStanding) {
                            setTradeMessage('Unable to load trade partner data. Please try again.');
                            return;
                        }
                        
                        // Determine if they're rebuilding or competing
                        const gamesPlayed = theirStanding?.wins + theirStanding?.losses + theirStanding?.otLosses;
                        const winPct = gamesPlayed > 0 ? theirStanding?.wins / gamesPlayed : 0;
                        const isCompeting = winPct > 0.55; // Over .550 = playoff team
                        const isRebuilding = winPct < 0.40; // Under .400 = rebuild
                        
                        // Check roster needs for AI team
                        const theirRoster = gameState.players.filter(p => p.teamId === tradePartnerTeamId && p.roster === 'nhl');
                        const theirGoalies = theirRoster.filter(p => p.position === 'G');
                        const theirForwards = theirRoster.filter(p => p.position === 'F');
                        const theirDefense = theirRoster.filter(p => p.position === 'D');
                        
                        // Check if they're trading away critical positions
                        const tradingAwayGoalie = myPlayers.some(p => p.position === 'G' && p.teamId === tradePartnerTeamId);
                        const wouldHaveNoGoalies = tradingAwayGoalie && (theirGoalies.length - myPlayers.filter(p => p.position === 'G').length) < 1;
                        
                        // Critical: Can't trade away your only/last goalie
                        if (wouldHaveNoGoalies && !evaluation.theirValue.hasGoalie) {
                            setTradeMessage({
                                type: 'error',
                                text: `‚ùå ${theirTeam.city} rejects - they cannot trade away their last goalie!`
                            });
                            return;
                        }
                        
                        let acceptanceScore = 0;
                        let debugLog = []; // For showing user why trade was accepted/rejected
                        
                        // ========== 1. BASE TRADE VALUE COMPARISON ==========
                        // Use trade value (quality-weighted) instead of raw OVR sum
                        if (evaluation.tradeValueDiffPercent > 25) {
                            acceptanceScore -= 100; // Instant rejection for extreme imbalance
                            debugLog.push(`Trade Value Difference ${evaluation.tradeValueDiffPercent.toFixed(1)}% - Extremely Lopsided: -100`);
                        } else if (evaluation.tradeValueDiffPercent > 20) {
                            acceptanceScore -= 60; // Very unfair
                            debugLog.push(`Trade Value Difference ${evaluation.tradeValueDiffPercent.toFixed(1)}% - Very Lopsided: -60`);
                        } else if (evaluation.tradeValueDiffPercent > 15) {
                            acceptanceScore -= 40; // Heavily lopsided
                            debugLog.push(`Trade Value Difference ${evaluation.tradeValueDiffPercent.toFixed(1)}% - Lopsided: -40`);
                        } else if (evaluation.tradeValueDiffPercent <= 5) {
                            acceptanceScore += 50; // Fair
                            debugLog.push(`Trade Value Difference ${evaluation.tradeValueDiffPercent.toFixed(1)}% - Fair Trade: +50`);
                        } else if (evaluation.tradeValueDiffPercent <= 10) {
                            acceptanceScore += 30; // Acceptable
                            debugLog.push(`Trade Value Difference ${evaluation.tradeValueDiffPercent.toFixed(1)}% - Acceptable: +30`);
                        } else if (evaluation.tradeValueDiffPercent <= 15) {
                            acceptanceScore += 10; // Questionable
                            debugLog.push(`Trade Value Difference ${evaluation.tradeValueDiffPercent.toFixed(1)}% - Questionable: +10`);
                        }
                        
                        // ========== 2. STAR PLAYER PREMIUM ==========
                        // Stars (90+) are worth more than the sum of their parts
                        const starDiff = evaluation.theirValue.starCount - evaluation.myValue.starCount;
                        if (starDiff > 0) {
                            const starBonus = starDiff * 20; // Each star they receive = +20
                            acceptanceScore += starBonus;
                            debugLog.push(`Receiving ${starDiff} Star Player(s) (90+ OVR): +${starBonus}`);
                        } else if (starDiff < 0) {
                            const starPenalty = Math.abs(starDiff) * 25; // Giving up stars = -25 each
                            acceptanceScore -= starPenalty;
                            debugLog.push(`Giving Up ${Math.abs(starDiff)} Star Player(s): -${starPenalty}`);
                        }
                        
                        // Elite players (85-89) also get a small bonus
                        const eliteDiff = evaluation.theirValue.eliteCount - evaluation.myValue.eliteCount;
                        if (eliteDiff > 0) {
                            const eliteBonus = eliteDiff * 10;
                            acceptanceScore += eliteBonus;
                            debugLog.push(`Receiving ${eliteDiff} Elite Player(s) (85-89 OVR): +${eliteBonus}`);
                        }
                        
                        // ========== 3. PLAYER COUNT IMBALANCE PENALTY ==========
                        const playerCountDiff = Math.abs(myPlayers.length - theirPlayers.length);
                        if (playerCountDiff >= 3) {
                            acceptanceScore -= 35; // 4-for-1 or worse
                            debugLog.push(`Large Player Count Imbalance (${myPlayers.length} for ${theirPlayers.length}): -35`);
                        } else if (playerCountDiff === 2) {
                            acceptanceScore -= 20; // 3-for-1
                            debugLog.push(`Player Count Imbalance (${myPlayers.length} for ${theirPlayers.length}): -20`);
                        } else if (playerCountDiff === 1) {
                            acceptanceScore -= 5; // 2-for-1 slight penalty
                            debugLog.push(`Minor Player Count Imbalance: -5`);
                        }
                        
                        // ========== 4. AGE FACTOR (IMPROVED) ==========
                        if (isCompeting) {
                            // Competing teams want win-now players, but not too old
                            const avgAgeReceiving = evaluation.theirValue.avgAge;
                            const avgAgeGivingUp = evaluation.myValue.avgAge;
                            
                            if (avgAgeReceiving > avgAgeGivingUp && avgAgeReceiving <= 32) {
                                // Getting experienced vets in their prime
                                acceptanceScore += 25;
                                debugLog.push(`Getting Win-Now Veterans (Avg Age ${avgAgeReceiving.toFixed(1)}): +25`);
                            } else if (avgAgeReceiving > 33) {
                                // Too old even for contenders
                                acceptanceScore -= 15;
                                debugLog.push(`Receiving Aging Players (Avg Age ${avgAgeReceiving.toFixed(1)}): -15`);
                            } else if (avgAgeReceiving < avgAgeGivingUp) {
                                // Getting younger = planning for future
                                acceptanceScore += 15;
                                debugLog.push(`Getting Younger Players: +15`);
                            }
                        } else if (isRebuilding) {
                            // Rebuilding teams heavily prioritize youth
                            // Calculate: (Age they're giving up) - (Age they're receiving)
                            // Positive = getting younger, Negative = getting older
                            const ageDiff = evaluation.theirValue.avgAge - evaluation.myValue.avgAge;
                            
                            if (ageDiff > 5) {
                                // Getting much younger
                                acceptanceScore += 45;
                                debugLog.push(`Getting Much Younger Players (${ageDiff.toFixed(1)} years younger): +45`);
                            } else if (ageDiff > 2) {
                                // Getting younger
                                acceptanceScore += 30;
                                debugLog.push(`Getting Younger Players (${ageDiff.toFixed(1)} years younger): +30`);
                            } else if (ageDiff < -2) {
                                // Getting older - bad for rebuild
                                acceptanceScore -= 30;
                                debugLog.push(`Getting Older Players (rebuild mode): -30`);
                            }
                        } else {
                            // Middle teams - slight preference for youth
                            if (evaluation.theirValue.avgAge < evaluation.myValue.avgAge - 2) {
                                acceptanceScore += 10;
                                debugLog.push(`Getting Younger: +10`);
                            }
                        }
                        
                        // ========== 5. POTENTIAL FACTOR ==========
                        const potDiff = evaluation.theirValue.totalPOT - evaluation.myValue.totalPOT;
                        if (isRebuilding && potDiff > 10) {
                            acceptanceScore += 35; // High POT = very valuable for rebuild
                            debugLog.push(`High Potential for Rebuild (+${potDiff} POT): +35`);
                        } else if (isRebuilding && potDiff > 5) {
                            acceptanceScore += 20;
                            debugLog.push(`Good Potential for Rebuild: +20`);
                        } else if (isCompeting && evaluation.theirValue.avgOVR > evaluation.myValue.avgOVR + 2) {
                            acceptanceScore += 20; // High OVR now = valuable for contender
                            debugLog.push(`Higher Current Ability (Competing): +20`);
                        }
                        
                        // ========== 6. STATS/PERFORMANCE (INCREASED WEIGHT) ==========
                        const ptsDiff = evaluation.theirValue.totalPts - evaluation.myValue.totalPts;
                        if (ptsDiff > 30) {
                            acceptanceScore += 30;
                            debugLog.push(`Much Better Production (+${ptsDiff} pts): +30`);
                        } else if (ptsDiff > 20) {
                            acceptanceScore += 25;
                            debugLog.push(`Better Production (+${ptsDiff} pts): +25`);
                        } else if (ptsDiff > 10) {
                            acceptanceScore += 15;
                            debugLog.push(`Improved Production (+${ptsDiff} pts): +15`);
                        } else if (ptsDiff < -20) {
                            acceptanceScore -= 15;
                            debugLog.push(`Lower Production (${ptsDiff} pts): -15`);
                        }
                        
                        // ========== 7. POSITION NEEDS ==========
                        // Check if they're getting positions they need
                        const receivingPositions = evaluation.theirValue.positions;
                        const givingPositions = evaluation.myValue.positions;
                        
                        // Goalie needs
                        if (receivingPositions.G > 0 && theirGoalies.length <= 2) {
                            acceptanceScore += 15;
                            debugLog.push(`Receiving Needed Goalie: +15`);
                        }
                        
                        // Depth concerns
                        if (givingPositions.F > 0 && theirForwards.length - givingPositions.F < 9) {
                            acceptanceScore -= 20;
                            debugLog.push(`Would Lack Forward Depth: -20`);
                        }
                        if (givingPositions.D > 0 && theirDefense.length - givingPositions.D < 6) {
                            acceptanceScore -= 20;
                            debugLog.push(`Would Lack Defense Depth: -20`);
                        }
                        
                        // ========== 8. RANDOM VARIANCE ==========
                        const randomFactor = (Math.random() - 0.5) * 20; // +/- 10 points
                        acceptanceScore += randomFactor;
                        debugLog.push(`Random GM Preference: ${randomFactor > 0 ? '+' : ''}${randomFactor.toFixed(1)}`);
                        
                        // ========== SALARY CAP VALIDATION ==========
                        // Calculate salary impact for both teams (ONLY count NHL roster players)
                        const myPlayersNHL = myPlayers.filter(p => p.roster === 'nhl');
                        const theirPlayersNHL = theirPlayers.filter(p => p.roster === 'nhl');
                        
                        const myPlayersSalary = myPlayersNHL.reduce((sum, p) => sum + (p.contract?.capHit || 0), 0);
                        const theirPlayersSalary = theirPlayersNHL.reduce((sum, p) => sum + (p.contract?.capHit || 0), 0);
                        
                        // Calculate new cap hits after trade
                        const userCapStatus = calculateTeamCapHit(userTeamId, gameState.players);
                        const partnerCapStatus = calculateTeamCapHit(tradePartnerTeamId, gameState.players);
                        
                        const userNewCap = userCapStatus.totalCapHit - myPlayersSalary + theirPlayersSalary;
                        const partnerNewCap = partnerCapStatus.totalCapHit - theirPlayersSalary + myPlayersSalary;
                        
                        // Check if trade would break salary cap for user team
                        if (userNewCap > SALARY_CAP.ceiling) {
                            const overage = userNewCap - SALARY_CAP.ceiling;
                            setTradeMessage({
                                type: 'error',
                                text: `‚ùå Trade rejected - You would be ${formatSalary(overage)} over the salary cap! (Cap: ${formatSalary(SALARY_CAP.ceiling)})`
                            });
                            return;
                        }
                        
                        // Check if trade would break salary cap for partner team
                        if (partnerNewCap > SALARY_CAP.ceiling) {
                            const overage = partnerNewCap - SALARY_CAP.ceiling;
                            setTradeMessage({
                                type: 'error',
                                text: `‚ùå ${theirTeam.city} rejects - They would be ${formatSalary(overage)} over the salary cap!`
                            });
                            return;
                        }
                        
                        // ========== 9. TEAM PROFILE ADJUSTMENTS ==========
                        const theirProfile = gameState.teamProfiles?.find(p => p.teamId === tradePartnerTeamId);
                        
                        if (theirProfile) {
                            // A. STATUS-BASED ADJUSTMENTS (Rebuild/Compete/Contend)
                            if (theirProfile.status === 'Rebuild') {
                                // Rebuilding teams prefer prospects and picks, avoid veterans
                                // NOTE: Age is already handled in Section 4 above
                                
                                // Prefer potential over current ability
                                const potDiff = evaluation.theirValue.totalPOT - evaluation.myValue.totalPOT;
                                if (potDiff > 10) {
                                    acceptanceScore += 20;
                                    debugLog.push(`Rebuild: Higher Potential (+${potDiff}): +20`);
                                }
                                
                                // Salary evaluation from AI's perspective
                                // AI is GIVING UP theirPlayersSalary and RECEIVING myPlayersSalary
                                const salaryChange = myPlayersSalary - theirPlayersSalary; // Positive = AI taking on more salary
                                
                                if (salaryChange < -2000000) {
                                    // Shedding $2M+ in salary = GOOD for rebuild
                                    acceptanceScore += 20;
                                    debugLog.push(`Rebuild: Shedding Salary (-${formatSalary(Math.abs(salaryChange))}): +20`);
                                } else if (salaryChange > 2000000) {
                                    // Taking on $2M+ in salary = BAD for rebuild
                                    acceptanceScore -= 20;
                                    debugLog.push(`Rebuild: Taking On Expensive Salary (+${formatSalary(salaryChange)}): -20`);
                                }
                            } else if (theirProfile.status === 'Contend') {
                                // Contending teams want win-now players
                                const avgAgeReceiving = evaluation.theirValue.avgAge;
                                
                                // Prefer prime-age players (25-30)
                                const primePlayersReceiving = evaluation.theirValue.players.filter(p => p.age >= 25 && p.age <= 30).length;
                                const primePlayersGiving = evaluation.myValue.players.filter(p => p.age >= 25 && p.age <= 30).length;
                                
                                if (primePlayersReceiving > primePlayersGiving) {
                                    acceptanceScore += 15;
                                    debugLog.push(`Contend: Getting Prime-Age Players: +15`);
                                }
                                
                                // Heavily weight current OVR over potential
                                if (evaluation.theirValue.avgOVR > evaluation.myValue.avgOVR + 2) {
                                    acceptanceScore += 20;
                                    debugLog.push(`Contend: Upgrading Current Talent: +20`);
                                }
                                
                                // Don't mind paying for talent
                                // (No penalty for taking on salary if getting better players)
                            }
                            
                            // B. TRADE DEADLINE APPROACH
                            if (theirProfile.tradeDeadlineApproach.includes('Seller')) {
                                // Sellers want to dump veterans for prospects/picks
                                if (evaluation.theirValue.avgAge < evaluation.myValue.avgAge) {
                                    acceptanceScore += 15;
                                    debugLog.push(`Seller: Acquiring Youth: +15`);
                                }
                                
                                // Willing to take cap relief
                                if (theirPlayersSalary > myPlayersSalary) {
                                    acceptanceScore += 10;
                                    debugLog.push(`Seller: Clearing Cap Space: +10`);
                                }
                            } else if (theirProfile.tradeDeadlineApproach.includes('Buyer')) {
                                // Buyers want upgrades now
                                if (evaluation.theirValue.avgOVR > evaluation.myValue.avgOVR) {
                                    const bonus = theirProfile.tradeDeadlineApproach.includes('Aggressive') ? 25 : 15;
                                    acceptanceScore += bonus;
                                    debugLog.push(`Buyer: Upgrading Roster: +${bonus}`);
                                }
                                
                                // More willing to overpay near deadline
                                if (theirProfile.tradeDeadlineApproach.includes('Aggressive') && evaluation.tradeValueDiffPercent <= 12) {
                                    acceptanceScore += 15;
                                    debugLog.push(`Aggressive Buyer: Deadline Urgency: +15`);
                                }
                            }
                            
                            // C. BUDGET SENSITIVITY
                            // From AI perspective: positive = taking on more salary, negative = shedding salary
                            const salaryChange = myPlayersSalary - theirPlayersSalary; // What AI receives - what AI gives up
                            if (theirProfile.budgetSensitivity === 'High') {
                                // Very sensitive to adding salary
                                if (salaryChange > 3000000) {
                                    acceptanceScore -= 30;
                                    debugLog.push(`High Budget Sensitivity: Taking On ${formatSalary(salaryChange)}: -30`);
                                } else if (salaryChange < -1000000) {
                                    acceptanceScore += 15;
                                    debugLog.push(`High Budget Sensitivity: Saving ${formatSalary(Math.abs(salaryChange))}: +15`);
                                }
                            } else if (theirProfile.budgetSensitivity === 'Low') {
                                // Don't care much about salary
                                // (No adjustment - willing to spend)
                            } else { // Medium
                                // Moderate sensitivity
                                if (salaryChange > 5000000) {
                                    acceptanceScore -= 15;
                                    debugLog.push(`Medium Budget Sensitivity: Taking On ${formatSalary(salaryChange)}: -15`);
                                }
                            }
                            
                            // D. PROSPECT BIAS
                            if (theirProfile.prospectBias === 'High') {
                                // Prefer young players with potential
                                const youngHighPotReceiving = evaluation.theirValue.players.filter(p => 
                                    p.age < 25 && p.ratings.potential >= p.ratings.overall + 5
                                ).length;
                                const youngHighPotGiving = evaluation.myValue.players.filter(p => 
                                    p.age < 25 && p.ratings.potential >= p.ratings.overall + 5
                                ).length;
                                
                                if (youngHighPotReceiving > youngHighPotGiving) {
                                    acceptanceScore += 20;
                                    debugLog.push(`High Prospect Bias: Acquiring Prospects: +20`);
                                } else if (youngHighPotReceiving < youngHighPotGiving) {
                                    acceptanceScore -= 15;
                                    debugLog.push(`High Prospect Bias: Losing Prospects: -15`);
                                }
                            }
                            
                            // E. PLAYOFF PROBABILITY FACTOR
                            if (theirProfile.playoffProbability < 20) {
                                // Unlikely to make playoffs - may be more willing to take risks
                                if (evaluation.theirValue.totalPOT > evaluation.myValue.totalPOT) {
                                    acceptanceScore += 10;
                                    debugLog.push(`Low Playoff Odds: Future-Focused: +10`);
                                }
                            } else if (theirProfile.playoffProbability > 75) {
                                // Playoff lock - focus on winning now
                                if (evaluation.theirValue.avgOVR > evaluation.myValue.avgOVR) {
                                    acceptanceScore += 15;
                                    debugLog.push(`High Playoff Odds: Win-Now Mode: +15`);
                                }
                            }
                        }
                        
                        // ========== FINAL DECISION ==========
                        const tradeAccepted = acceptanceScore >= 55; // Raised threshold slightly
                        
                        if (tradeAccepted) {
                            // Execute trade
                            const newPlayers = [...gameState.players];
                            
                            // Swap teams
                            myPlayers.forEach(p => {
                                const player = newPlayers.find(np => np.id === p.id);
                                player.teamId = tradePartnerTeamId;
                                // Reset lineup assignments
                                player.lineNumber = 0;
                                player.linePosition = null;
                                player.ppUnit = null;
                                player.pkUnit = null;
                                if (player.position === 'G') player.dressed = false;
                                
                                // Add to player's trade history with full transaction details
                                if (!player.tradeHistory) player.tradeHistory = [];
                                player.tradeHistory.push({
                                    day: gameState.currentDay, season: gameState.season, year: gameState.year,
                                    from: userTeamId,
                                    to: tradePartnerTeamId,
                                    year: gameState.year,
                                    // Include who they were traded with and for
                                    tradedWith: myPlayers.filter(mp => mp.id !== p.id).map(mp => ({ 
                                        id: mp.id, 
                                        name: `${mp.firstName} ${mp.lastName}`, 
                                        position: mp.position 
                                    })),
                                    tradedFor: theirPlayers.map(tp => ({ 
                                        id: tp.id, 
                                        name: `${tp.firstName} ${tp.lastName}`, 
                                        position: tp.position 
                                    }))
                                });
                            });
                            
                            theirPlayers.forEach(p => {
                                const player = newPlayers.find(np => np.id === p.id);
                                player.teamId = userTeamId;
                                // Reset lineup assignments
                                player.lineNumber = 0;
                                player.linePosition = null;
                                player.ppUnit = null;
                                player.pkUnit = null;
                                if (player.position === 'G') player.dressed = false;
                                
                                // Add to player's trade history with full transaction details
                                if (!player.tradeHistory) player.tradeHistory = [];
                                player.tradeHistory.push({
                                    day: gameState.currentDay, season: gameState.season, year: gameState.year,
                                    from: tradePartnerTeamId,
                                    to: userTeamId,
                                    year: gameState.year,
                                    // Include who they were traded with and for
                                    tradedWith: theirPlayers.filter(tp => tp.id !== p.id).map(tp => ({ 
                                        id: tp.id, 
                                        name: `${tp.firstName} ${tp.lastName}`, 
                                        position: tp.position 
                                    })),
                                    tradedFor: myPlayers.map(mp => ({ 
                                        id: mp.id, 
                                        name: `${mp.firstName} ${mp.lastName}`, 
                                        position: mp.position 
                                    }))
                                });
                            });
                            
                            // Transfer draft picks
                            mySelectedPicks.forEach(pickId => {
                                const pick = gameState.draftPicks?.find(p => p.id === pickId);
                                if (pick) {
                                    pick.currentOwner = tradePartnerTeamId; // User's pick goes to other team
                                }
                            });
                            
                            theirSelectedPicks.forEach(pickId => {
                                const pick = gameState.draftPicks?.find(p => p.id === pickId);
                                if (pick) {
                                    pick.currentOwner = userTeamId; // Other team's pick comes to user
                                }
                            });
                            
                            // Add to team trade history
                            if (!gameState.tradeHistory) gameState.tradeHistory = [];
                            
                            // Get pick details for trade history
                            const myPicksData = mySelectedPicks.map(pickId => {
                                const pick = gameState.draftPicks?.find(p => p.id === pickId);
                                const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                                return {
                                    id: pick.id,
                                    year: pick.year,
                                    round: pick.round,
                                    pickInRound: pick.pickInRound,
                                    originalTeam: originalTeam?.abbreviation || 'UNK'
                                };
                            });
                            
                            const theirPicksData = theirSelectedPicks.map(pickId => {
                                const pick = gameState.draftPicks?.find(p => p.id === pickId);
                                const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                                return {
                                    id: pick.id,
                                    year: pick.year,
                                    round: pick.round,
                                    pickInRound: pick.pickInRound,
                                    originalTeam: originalTeam?.abbreviation || 'UNK'
                                };
                            });
                            
                            gameState.tradeHistory.push({
                                day: gameState.currentDay, season: gameState.season, year: gameState.year,
                                year: gameState.year,
                                team1: userTeamId,
                                team2: tradePartnerTeamId,
                                team1Gives: myPlayers.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, position: p.position, ovr: p.ratings.overall })),
                                team2Gives: theirPlayers.map(p => ({ id: p.id, name: `${p.firstName} ${p.lastName}`, position: p.position, ovr: p.ratings.overall })),
                                team1Picks: myPicksData,
                                team2Picks: theirPicksData
                            });
                            
                            // Auto-assign lines
                            autoSetAllLines(newPlayers, userTeamId);
                            autoSetAllLines(newPlayers, tradePartnerTeamId);
                            
                            // Create the updated game state
                            const updatedGameState = { ...gameState, players: newPlayers };
                            setGameState(updatedGameState);
                            
                            const teamStatus = isCompeting ? 'üèÜ Contending' : isRebuilding ? 'üîß Rebuilding' : 'üìä Middle Team';
                            
                            // Build detailed trade summary
                            let successMessage = `‚úÖ TRADE COMPLETED!\n\n`;
                            successMessage += `${theirTeam.city} ${theirTeam.name} (${teamStatus}) has accepted the trade.\n\n`;
                            
                            // What you traded away
                            successMessage += `üì§ YOU TRADED:\n`;
                            myPlayers.forEach(p => {
                                successMessage += `  ‚Ä¢ ${p.firstName} ${p.lastName} (${p.position}, ${p.ratings.overall} OVR)\n`;
                            });
                            const myPicks = mySelectedPicks.map(pickId => gameState.draftPicks?.find(p => p.id === pickId)).filter(Boolean);
                            myPicks.forEach(pick => {
                                const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                                successMessage += `  ‚Ä¢ ${pick.year} ${pick.round === 1 ? '1st' : pick.round === 2 ? '2nd' : pick.round === 3 ? '3rd' : `${pick.round}th`} Round (${originalTeam?.abbreviation} #${pick.pickInRound})\n`;
                            });
                            
                            successMessage += `\nüì• YOU RECEIVED:\n`;
                            theirPlayers.forEach(p => {
                                successMessage += `  ‚Ä¢ ${p.firstName} ${p.lastName} (${p.position}, ${p.ratings.overall} OVR)\n`;
                            });
                            const theirPicks = theirSelectedPicks.map(pickId => gameState.draftPicks?.find(p => p.id === pickId)).filter(Boolean);
                            theirPicks.forEach(pick => {
                                const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                                successMessage += `  ‚Ä¢ ${pick.year} ${pick.round === 1 ? '1st' : pick.round === 2 ? '2nd' : pick.round === 3 ? '3rd' : `${pick.round}th`} Round (${originalTeam?.abbreviation} #${pick.pickInRound})\n`;
                            });
                            
                            successMessage += `\nüìä Trade Evaluation:\n`;
                            successMessage += debugLog.slice(0, 5).map(log => `  ‚Ä¢ ${log}`).join('\n'); // Show top 5 factors
                            successMessage += `\n\nüéØ Final Score: ${Math.round(acceptanceScore)}/55`;
                            
                            setTradeMessage({
                                type: 'success',
                                text: successMessage
                            });
                            
                            // Clear selections (players and picks)
                            setMySelectedPlayers([]);
                            setTheirSelectedPlayers([]);
                            setMySelectedPicks([]);
                            setTheirSelectedPicks([]);
                            
                            // Save game with the UPDATED state
                            saveGameToLocalStorage(updatedGameState, userTeamId, playoffState, seasonMode);
                        } else {
                            // Build detailed rejection message
                            const teamStatus = isCompeting ? 'üèÜ Contending' : isRebuilding ? 'üîß Rebuilding' : 'üìä Middle Team';
                            let detailedMessage = `‚ùå Trade Rejected!\n\n`;
                            detailedMessage += `${theirTeam.city} ${theirTeam.name} (${teamStatus}) declined the offer.\n\n`;
                            detailedMessage += `üìä Trade Evaluation Breakdown:\n`;
                            detailedMessage += debugLog.map(log => `  ‚Ä¢ ${log}`).join('\n');
                            detailedMessage += `\n\nüéØ Final Score: ${Math.round(acceptanceScore)}/55 (Need 55 to accept)`;
                            
                            setTradeMessage({
                                type: 'error',
                                text: detailedMessage
                            });
                        }
                    };

// Check if trade is ready to propose
const canProposeTrade = (mySelectedPlayers.length > 0 || mySelectedPicks.length > 0) && 
                (theirSelectedPlayers.length > 0 || theirSelectedPicks.length > 0);

const evaluation = canProposeTrade ? evaluateTrade() : null;
const userTeam = TEAMS.find(t => t.id === userTeamId);
const partnerTeam = tradePartnerTeamId ? TEAMS.find(t => t.id === tradePartnerTeamId) : null;

// Calculate cap space
const myCapSpace = getTeamCapSpace(gameState.players, userTeamId);
const theirCapSpace = tradePartnerTeamId ? getTeamCapSpace(gameState.players, tradePartnerTeamId) : 0;

// Get my tradeable picks
const myTradeablePicks = gameState.draftPicks?.filter(p => p.currentOwner === userTeamId) || [];
const theirTradeablePicks = tradePartnerTeamId ? 
    (gameState.draftPicks?.filter(p => p.currentOwner === tradePartnerTeamId) || []) : [];

return (
    <div className="card">
<h2>üîÑ Trade Center</h2>
<p style={{ color: '#93c5fd', marginBottom: '2rem' }}>
    Build your trade by adding players and draft picks to each side.
</p>

{/* Team Selection */}
<div style={{ marginBottom: '2rem' }}>
    <label style={{ display: 'block', color: '#93c5fd', marginBottom: '0.5rem', fontWeight: 'bold' }}>
        Trade Partner:
    </label>
    <select 
        className="select"
        value={tradePartnerTeamId || ''}
        onChange={(e) => {
            setTradePartnerTeamId(e.target.value ? parseInt(e.target.value) : null);
            setMySelectedPlayers([]);
            setTheirSelectedPlayers([]);
            setMySelectedPicks([]);
            setTheirSelectedPicks([]);
            setTradeMessage(null);
        }}
        style={{ width: '100%', maxWidth: '400px', fontSize: '1.1rem' }}
    >
        <option value="">-- Select a team --</option>
        {TEAMS.filter(t => t.id !== userTeamId).map(team => (
            <option key={team.id} value={team.id}>
                {team.city} {team.name}
            </option>
        ))}
    </select>
</div>

{tradePartnerTeamId && (
    <>
        {/* TRADE SUMMARY + AI TEAM INFO (2 columns) */}
        <div style={{
            display: 'grid',
            gridTemplateColumns: canProposeTrade && evaluation ? '1fr 400px' : '1fr',
            gap: '1.5rem',
            marginBottom: '2rem'
        }}>
            {/* TRADE SUMMARY (LEFT) */}
            {canProposeTrade && evaluation && (
                <div style={{
                    padding: '1.5rem',
                    background: 'rgba(59, 130, 246, 0.1)',
                    borderRadius: '0.75rem',
                    border: '2px solid rgba(59, 130, 246, 0.3)'
                }}>
                    <h3 style={{ color: '#60a5fa', marginBottom: '1rem', textAlign: 'center' }}>
                        üìä Trade Summary
                    </h3>
                    
                    <div style={{
                        display: 'grid',
                        gridTemplateColumns: '1fr auto 1fr',
                        gap: '1.5rem',
                        alignItems: 'center',
                        marginBottom: '1rem'
                    }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '0.85rem', color: '#93c5fd', marginBottom: '0.25rem' }}>You Give</div>
                            <div style={{ fontSize: '1.8rem', fontWeight: 'bold', color: '#22c55e' }}>
                                {evaluation.myValue.totalOVR.toFixed(0)}
                            </div>
                            <div style={{ fontSize: '0.8rem', color: '#93c5fd' }}>
                                {evaluation.myValue.players.length} player{evaluation.myValue.players.length !== 1 ? 's' : ''}
                                {evaluation.myValue.picks.length > 0 && `, ${evaluation.myValue.picks.length} pick${evaluation.myValue.picks.length !== 1 ? 's' : ''}`}
                            </div>
                        </div>

                        <div style={{
                            padding: '1rem',
                            background: evaluation.tradeValueDiffPercent <= 5 ? 'rgba(34, 197, 94, 0.2)' :
                                       evaluation.tradeValueDiffPercent <= 15 ? 'rgba(251, 191, 36, 0.2)' :
                                       'rgba(239, 68, 68, 0.2)',
                            borderRadius: '0.75rem',
                            border: `2px solid ${
                                evaluation.tradeValueDiffPercent <= 5 ? '#22c55e' :
                                evaluation.tradeValueDiffPercent <= 15 ? '#fbbf24' :
                                '#ef4444'
                            }`,
                            textAlign: 'center',
                            minWidth: '180px'
                        }}>
                            <div style={{ fontSize: '2rem', marginBottom: '0.25rem' }}>
                                {evaluation.tradeValueDiffPercent <= 5 ? 'üü¢' :
                                 evaluation.tradeValueDiffPercent <= 15 ? 'üü°' : 'üî¥'}
                            </div>
                            <div style={{
                                fontWeight: 'bold',
                                fontSize: '0.9rem',
                                color: evaluation.tradeValueDiffPercent <= 5 ? '#22c55e' :
                                       evaluation.tradeValueDiffPercent <= 15 ? '#fbbf24' :
                                       '#ef4444'
                            }}>
                                {evaluation.tradeValueDiffPercent <= 5 ? 'FAIR TRADE' :
                                 evaluation.tradeValueDiffPercent <= 15 ? 'QUESTIONABLE' :
                                 'LIKELY REJECTED'}
                            </div>
                            <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                                {evaluation.tradeValueDiff.toFixed(0)} value diff ({evaluation.tradeValueDiffPercent.toFixed(1)}%)
                            </div>
                        </div>

                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '0.85rem', color: '#93c5fd', marginBottom: '0.25rem' }}>You Get</div>
                            <div style={{ fontSize: '1.8rem', fontWeight: 'bold', color: '#fbbf24' }}>
                                {evaluation.theirValue.totalOVR.toFixed(0)}
                            </div>
                            <div style={{ fontSize: '0.8rem', color: '#93c5fd' }}>
                                {evaluation.theirValue.players.length} player{evaluation.theirValue.players.length !== 1 ? 's' : ''}
                                {evaluation.theirValue.picks.length > 0 && `, ${evaluation.theirValue.picks.length} pick${evaluation.theirValue.picks.length !== 1 ? 's' : ''}`}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* AI TEAM INFO (RIGHT) */}
            {(() => {
                const profile = gameState.teamProfiles?.find(p => p.teamId === tradePartnerTeamId);
                const standing = gameState.standings?.find(s => s.teamId === tradePartnerTeamId);
                const roster = gameState.players.filter(p => p.teamId === tradePartnerTeamId && p.roster === 'nhl');
                
                if (!profile) return null;

                // Calculate team needs
                const needs = [];
                const available = [];
                
                if (profile.status === 'Rebuild') {
                    needs.push('Young talent', 'Draft picks');
                    available.push('Veterans', 'Expensive contracts');
                } else if (profile.status === 'Contend') {
                    needs.push('Win-now upgrades');
                    available.push('Prospects', 'Future assets');
                } else {
                    needs.push('Roster upgrades');
                    available.push('Depth pieces');
                }

                const forwards = roster.filter(p => p.position === 'F');
                const defense = roster.filter(p => p.position === 'D');
                const avgFwdOVR = forwards.length > 0 ? forwards.reduce((sum, p) => sum + p.ratings.overall, 0) / forwards.length : 0;
                const avgDefOVR = defense.length > 0 ? defense.reduce((sum, p) => sum + p.ratings.overall, 0) / defense.length : 0;

                if (forwards.length < 12 || avgFwdOVR < 77) needs.unshift('Forward depth');
                if (defense.length < 6 || avgDefOVR < 77) needs.unshift('Defense depth');
                if (!forwards.some(p => p.ratings.overall >= 88)) needs.unshift('Elite scoring');

                return (
                    <div style={{
                        padding: '1.5rem',
                        background: 'rgba(251, 191, 36, 0.1)',
                        borderRadius: '0.75rem',
                        border: '2px solid rgba(251, 191, 36, 0.3)'
                    }}>
                        <h3 style={{ color: '#fbbf24', marginBottom: '1rem', textAlign: 'center' }}>
                            {partnerTeam.city} {partnerTeam.name}
                        </h3>

                        {/* Team Status */}
                        <div style={{
                            marginBottom: '1rem',
                            padding: '0.75rem',
                            background: 'rgba(255,255,255,0.05)',
                            borderRadius: '0.5rem'
                        }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                <span style={{ color: '#93c5fd' }}>Status:</span>
                                <span style={{ 
                                    fontWeight: 'bold',
                                    color: profile.status === 'Rebuild' ? '#ef4444' :
                                           profile.status === 'Contend' ? '#22c55e' : '#fbbf24'
                                }}>
                                    {profile.status === 'Rebuild' ? 'üîß Rebuilding' :
                                     profile.status === 'Contend' ? 'üèÜ Contending' : 'üìä Competing'}
                                </span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                <span style={{ color: '#93c5fd' }}>Record:</span>
                                <span style={{ fontWeight: 'bold', color: '#e2e8f0' }}>
                                    {standing?.wins || 0}-{standing?.losses || 0}
                                </span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                <span style={{ color: '#93c5fd' }}>Playoff Odds:</span>
                                <span style={{ 
                                    fontWeight: 'bold',
                                    color: profile.playoffProbability >= 60 ? '#22c55e' :
                                           profile.playoffProbability >= 30 ? '#fbbf24' : '#ef4444'
                                }}>
                                    {profile.playoffProbability.toFixed(0)}%
                                </span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span style={{ color: '#93c5fd' }}>Cap Space:</span>
                                <span style={{ 
                                    fontWeight: 'bold',
                                    color: theirCapSpace > 10000000 ? '#22c55e' :
                                           theirCapSpace > 5000000 ? '#fbbf24' : '#ef4444'
                                }}>
                                    {formatSalary(theirCapSpace)}
                                </span>
                            </div>
                        </div>

                        {/* Trading Approach */}
                        <div style={{
                            marginBottom: '1rem',
                            padding: '0.75rem',
                            background: 'rgba(255,255,255,0.05)',
                            borderRadius: '0.5rem'
                        }}>
                            <div style={{ marginBottom: '0.5rem' }}>
                                <span style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Trade Approach:</span>
                            </div>
                            <div style={{ 
                                fontWeight: 'bold',
                                color: profile.tradeDeadlineApproach.includes('Buyer') ? '#22c55e' :
                                       profile.tradeDeadlineApproach.includes('Seller') ? '#ef4444' : '#94a3b8'
                            }}>
                                {profile.tradeDeadlineApproach}
                            </div>
                        </div>

                        {/* Needs & Available */}
                        <div style={{
                            padding: '0.75rem',
                            background: 'rgba(255,255,255,0.05)',
                            borderRadius: '0.5rem'
                        }}>
                            <div style={{ marginBottom: '0.75rem' }}>
                                <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                    üí° Looking For:
                                </div>
                                <div style={{ color: '#22c55e', fontWeight: 'bold', fontSize: '0.9rem' }}>
                                    {needs.slice(0, 2).join(', ')}
                                </div>
                            </div>
                            <div>
                                <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                    üì¶ Can Offer:
                                </div>
                                <div style={{ color: '#f59e0b', fontWeight: 'bold', fontSize: '0.9rem' }}>
                                    {available.slice(0, 2).join(', ')}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            })()}
        </div>

        {/* YOUR TRADE OFFER */}
        <div style={{
            marginBottom: '2rem',
            padding: '1.5rem',
            background: 'rgba(34, 197, 94, 0.05)',
            borderRadius: '0.75rem',
            border: '2px solid rgba(34, 197, 94, 0.3)'
        }}>
            <div style={{ marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                    <h3 style={{ color: '#22c55e', marginBottom: '0.25rem' }}>YOUR TRADE OFFER</h3>
                    <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                        {userTeam.city} {userTeam.name} ‚Ä¢ Cap Space: {formatSalary(myCapSpace)}
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '0.75rem' }}>
                    <button
                        onClick={() => {
                            setShowAddPlayerModal('my');
                            setModalPositionFilter('all');
                            setModalTempSelections([]);
                        }}
                        style={{
                            padding: '0.75rem 1.25rem',
                            background: '#22c55e',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '0.5rem',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            fontSize: '0.9rem'
                        }}
                    >
                        + Add Player
                    </button>
                    <button
                        onClick={() => {
                            setShowAddPickModal('my');
                            setModalTempSelections([]);
                        }}
                        style={{
                            padding: '0.75rem 1.25rem',
                            background: '#10b981',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '0.5rem',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            fontSize: '0.9rem'
                        }}
                    >
                        + Add Draft Pick
                    </button>
                </div>
            </div>

            {/* Selected Assets */}
            <div style={{ minHeight: '100px' }}>
                {mySelectedPlayers.length === 0 && mySelectedPicks.length === 0 ? (
                    <div style={{
                        padding: '2rem',
                        textAlign: 'center',
                        color: '#64748b',
                        fontSize: '0.95rem'
                    }}>
                        No assets selected. Click "+ Add Player" or "+ Add Draft Pick" to begin.
                    </div>
                ) : (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                        {mySelectedPlayers.map(playerId => {
                            const player = gameState.players.find(p => p.id === playerId);
                            const isInjured = player.injury.injured;
                            return (
                                <div key={playerId} style={{
                                    padding: '1rem',
                                    background: isInjured ? 'rgba(239,68,68,0.1)' : 'rgba(255,255,255,0.05)',
                                    borderRadius: '0.5rem',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    border: isInjured ? '1px solid rgba(239,68,68,0.3)' : 'none'
                                }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', color: '#e2e8f0', marginBottom: '0.25rem' }}>
                                            {player.firstName} {player.lastName}
                                            {isInjured && (
                                                <span style={{ 
                                                    marginLeft: '0.5rem',
                                                    padding: '0.125rem 0.5rem',
                                                    background: '#ef4444',
                                                    color: '#fff',
                                                    fontSize: '0.7rem',
                                                    borderRadius: '0.25rem',
                                                    fontWeight: 'bold'
                                                }}>
                                                    INJ
                                                </span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                            {player.position} ‚Ä¢ {player.ratings.overall} OVR ‚Ä¢ {player.age}y ‚Ä¢ {formatSalary(player.contract?.salary || 0)}
                                        </div>
                                        {isInjured && (
                                            <div style={{ fontSize: '0.75rem', color: '#ef4444', marginTop: '0.25rem' }}>
                                                ‚ö†Ô∏è {player.injury.type} - {player.injury.gamesRemaining} games remaining
                                            </div>
                                        )}
                                    </div>
                                    <button
                                        onClick={() => setMySelectedPlayers(prev => prev.filter(id => id !== playerId))}
                                        style={{
                                            padding: '0.5rem',
                                            background: '#ef4444',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.25rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        √ó
                                    </button>
                                </div>
                            );
                        })}
                        {mySelectedPicks.map(pickId => {
                            const pick = gameState.draftPicks?.find(p => p.id === pickId);
                            if (!pick) return null;
                            const pickValue = calculateDraftPickValue(pick, gameState.standings, gameState.teamProfiles, draftProspects, gameState.year);
                            const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                            return (
                                <div key={pickId} style={{
                                    padding: '1rem',
                                    background: 'rgba(255,255,255,0.05)',
                                    borderRadius: '0.5rem',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', color: '#e2e8f0', marginBottom: '0.25rem' }}>
                                            {pick.year} {pick.round === 1 ? '1st' : pick.round === 2 ? '2nd' : pick.round === 3 ? '3rd' : `${pick.round}th`} Round ({originalTeam?.abbreviation} #{pick.pickInRound})
                                        </div>
                                        <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                            ~{pickValue} OVR equivalent
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setMySelectedPicks(prev => prev.filter(id => id !== pickId))}
                                        style={{
                                            padding: '0.5rem',
                                            background: '#ef4444',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.25rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        √ó
                                    </button>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>

            {evaluation && (
                <div style={{
                    marginTop: '1rem',
                    paddingTop: '1rem',
                    borderTop: '1px solid rgba(34, 197, 94, 0.3)',
                    color: '#22c55e',
                    fontWeight: 'bold'
                }}>
                    <strong>Trade Value:</strong> {evaluation.myValue.tradeValue.toFixed(0)} pts
                    <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                        (Total OVR: {evaluation.myValue.totalOVR.toFixed(0)} ‚Ä¢ Avg: {evaluation.myValue.avgOVR.toFixed(1)})
                    </div>
                </div>
            )}
        </div>

        {/* REQUESTING FROM THEIR TEAM */}
        <div style={{
            marginBottom: '2rem',
            padding: '1.5rem',
            background: 'rgba(251, 191, 36, 0.05)',
            borderRadius: '0.75rem',
            border: '2px solid rgba(251, 191, 36, 0.3)'
        }}>
            <div style={{ marginBottom: '1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                    <h3 style={{ color: '#fbbf24', marginBottom: '0.25rem' }}>REQUESTING FROM {partnerTeam.city.toUpperCase()}</h3>
                    <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                        {partnerTeam.city} {partnerTeam.name} ‚Ä¢ Cap Space: {formatSalary(theirCapSpace)}
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '0.75rem' }}>
                    <button
                        onClick={() => {
                            setShowAddPlayerModal('their');
                            setModalPositionFilter('all');
                            setModalTempSelections([]);
                        }}
                        style={{
                            padding: '0.75rem 1.25rem',
                            background: '#fbbf24',
                            color: '#000',
                            border: 'none',
                            borderRadius: '0.5rem',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            fontSize: '0.9rem'
                        }}
                    >
                        + Add Player
                    </button>
                    <button
                        onClick={() => {
                            setShowAddPickModal('their');
                            setModalTempSelections([]);
                        }}
                        style={{
                            padding: '0.75rem 1.25rem',
                            background: '#f59e0b',
                            color: '#000',
                            border: 'none',
                            borderRadius: '0.5rem',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            fontSize: '0.9rem'
                        }}
                    >
                        + Add Draft Pick
                    </button>
                </div>
            </div>

            {/* Selected Assets */}
            <div style={{ minHeight: '100px' }}>
                {theirSelectedPlayers.length === 0 && theirSelectedPicks.length === 0 ? (
                    <div style={{
                        padding: '2rem',
                        textAlign: 'center',
                        color: '#64748b',
                        fontSize: '0.95rem'
                    }}>
                        No assets selected. Click "+ Add Player" or "+ Add Draft Pick" to add from their roster.
                    </div>
                ) : (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                        {theirSelectedPlayers.map(playerId => {
                            const player = gameState.players.find(p => p.id === playerId);
                            const isInjured = player.injury.injured;
                            return (
                                <div key={playerId} style={{
                                    padding: '1rem',
                                    background: isInjured ? 'rgba(239,68,68,0.1)' : 'rgba(255,255,255,0.05)',
                                    borderRadius: '0.5rem',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    border: isInjured ? '1px solid rgba(239,68,68,0.3)' : 'none'
                                }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', color: '#e2e8f0', marginBottom: '0.25rem' }}>
                                            {player.firstName} {player.lastName}
                                            {isInjured && (
                                                <span style={{ 
                                                    marginLeft: '0.5rem',
                                                    padding: '0.125rem 0.5rem',
                                                    background: '#ef4444',
                                                    color: '#fff',
                                                    fontSize: '0.7rem',
                                                    borderRadius: '0.25rem',
                                                    fontWeight: 'bold'
                                                }}>
                                                    INJ
                                                </span>
                                            )}
                                        </div>
                                        <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                            {player.position} ‚Ä¢ {player.ratings.overall} OVR ‚Ä¢ {player.age}y ‚Ä¢ {formatSalary(player.contract?.salary || 0)}
                                        </div>
                                        {isInjured && (
                                            <div style={{ fontSize: '0.75rem', color: '#ef4444', marginTop: '0.25rem' }}>
                                                ‚ö†Ô∏è {player.injury.type} - {player.injury.gamesRemaining} games remaining
                                            </div>
                                        )}
                                    </div>
                                    <button
                                        onClick={() => setTheirSelectedPlayers(prev => prev.filter(id => id !== playerId))}
                                        style={{
                                            padding: '0.5rem',
                                            background: '#ef4444',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.25rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        √ó
                                    </button>
                                </div>
                            );
                        })}
                        {theirSelectedPicks.map(pickId => {
                            const pick = gameState.draftPicks?.find(p => p.id === pickId);
                            if (!pick) return null;
                            const pickValue = calculateDraftPickValue(pick, gameState.standings, gameState.teamProfiles, draftProspects, gameState.year);
                            const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                            return (
                                <div key={pickId} style={{
                                    padding: '1rem',
                                    background: 'rgba(255,255,255,0.05)',
                                    borderRadius: '0.5rem',
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center'
                                }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', color: '#e2e8f0', marginBottom: '0.25rem' }}>
                                            {pick.year} {pick.round === 1 ? '1st' : pick.round === 2 ? '2nd' : pick.round === 3 ? '3rd' : `${pick.round}th`} Round ({originalTeam?.abbreviation} #{pick.pickInRound})
                                        </div>
                                        <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                            ~{pickValue} OVR equivalent
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => setTheirSelectedPicks(prev => prev.filter(id => id !== pickId))}
                                        style={{
                                            padding: '0.5rem',
                                            background: '#ef4444',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.25rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        √ó
                                    </button>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>

            {evaluation && (
                <div style={{
                    marginTop: '1rem',
                    paddingTop: '1rem',
                    borderTop: '1px solid rgba(251, 191, 36, 0.3)',
                    color: '#fbbf24',
                    fontWeight: 'bold'
                }}>
                    <strong>Trade Value:</strong> {evaluation.theirValue.tradeValue.toFixed(0)} pts
                    <div style={{ fontSize: '0.75rem', color: '#93c5fd', marginTop: '0.25rem' }}>
                        (Total OVR: {evaluation.theirValue.totalOVR.toFixed(0)} ‚Ä¢ Avg: {evaluation.theirValue.avgOVR.toFixed(1)})
                    </div>
                </div>
            )}
        </div>

        {/* Propose Trade Button */}
        {canProposeTrade && (
            <div style={{ textAlign: 'center' }}>
                <button
                    onClick={proposeTrade}
                    style={{
                        padding: '1.25rem 3rem',
                        background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '0.75rem',
                        fontSize: '1.2rem',
                        fontWeight: 'bold',
                        cursor: 'pointer',
                        boxShadow: '0 8px 20px rgba(59, 130, 246, 0.4)'
                    }}
                >
                    üì§ Propose Trade
                </button>
                
                {/* Trade Result Message - Shows right below button */}
                {tradeMessage && (
                    <div style={{
                        marginTop: '2rem',
                        padding: '1.5rem',
                        borderRadius: '0.75rem',
                        background: tradeMessage.type === 'success' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)',
                        border: `2px solid ${tradeMessage.type === 'success' ? '#22c55e' : '#ef4444'}`,
                        color: tradeMessage.type === 'success' ? '#22c55e' : '#f87171',
                        fontWeight: 'bold',
                        whiteSpace: 'pre-line',
                        fontFamily: 'monospace',
                        fontSize: '0.95rem',
                        lineHeight: '1.6',
                        textAlign: 'left',
                        position: 'relative'
                    }}>
                        <button
                            onClick={() => setTradeMessage(null)}
                            style={{
                                position: 'absolute',
                                top: '0.5rem',
                                right: '0.5rem',
                                background: 'rgba(0,0,0,0.3)',
                                border: 'none',
                                color: '#fff',
                                padding: '0.25rem 0.75rem',
                                borderRadius: '0.25rem',
                                cursor: 'pointer',
                                fontSize: '1rem',
                                fontWeight: 'bold'
                            }}
                            onMouseOver={(e) => e.target.style.background = 'rgba(0,0,0,0.5)'}
                            onMouseOut={(e) => e.target.style.background = 'rgba(0,0,0,0.3)'}
                        >
                            ‚úï
                        </button>
                        {tradeMessage.text}
                    </div>
                )}
            </div>
        )}
    </>
)}

{/* ADD PLAYER MODAL */}
{showAddPlayerModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.8)',
        zIndex: 10000,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '2rem'
    }}
    onClick={() => setShowAddPlayerModal(null)}
    >
        <div style={{
            background: '#1e293b',
            borderRadius: '1rem',
            padding: '2rem',
            maxWidth: '800px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto',
            border: '2px solid #3b82f6'
        }}
        onClick={(e) => e.stopPropagation()}
        >
            <h3 style={{ color: '#60a5fa', marginBottom: '1.5rem' }}>
                Select Player to Add {showAddPlayerModal === 'my' ? '(Your Team)' : '(Their Team)'}
            </h3>

            {/* Position Filter */}
            <div style={{ marginBottom: '1.5rem', display: 'flex', gap: '0.5rem' }}>
                {['all', 'F', 'D', 'G'].map(pos => (
                    <button
                        key={pos}
                        onClick={() => setModalPositionFilter(pos)}
                        style={{
                            padding: '0.5rem 1rem',
                            background: modalPositionFilter === pos ? '#3b82f6' : 'rgba(59,130,246,0.2)',
                            color: '#fff',
                            border: 'none',
                            borderRadius: '0.375rem',
                            cursor: 'pointer',
                            fontWeight: modalPositionFilter === pos ? 'bold' : 'normal'
                        }}
                    >
                        {pos === 'all' ? 'All' : pos === 'F' ? 'Forwards' : pos === 'D' ? 'Defense' : 'Goalies'}
                    </button>
                ))}
            </div>

            {/* Player List */}
            <div style={{ marginBottom: '1.5rem', maxHeight: '400px', overflow: 'auto' }}>
                {(() => {
                    const teamId = showAddPlayerModal === 'my' ? userTeamId : tradePartnerTeamId;
                    let players = gameState.players.filter(p => p.teamId === teamId && p.roster === 'nhl');
                    
                    if (modalPositionFilter !== 'all') {
                        players = players.filter(p => p.position === modalPositionFilter);
                    }

                    // Remove already selected
                    const selectedIds = showAddPlayerModal === 'my' ? mySelectedPlayers : theirSelectedPlayers;
                    players = players.filter(p => !selectedIds.includes(p.id));

                    return players.map(player => {
                        const isInjured = player.injury.injured;
                        return (
                        <div key={player.id} style={{
                            padding: '1rem',
                            background: modalTempSelections.includes(player.id) ? 'rgba(59,130,246,0.2)' : 
                                       isInjured ? 'rgba(100,100,100,0.1)' : 'rgba(255,255,255,0.05)',
                            borderRadius: '0.5rem',
                            marginBottom: '0.5rem',
                            cursor: isInjured ? 'not-allowed' : 'pointer',
                            border: modalTempSelections.includes(player.id) ? '2px solid #3b82f6' : 
                                   isInjured ? '2px solid rgba(239,68,68,0.3)' : '2px solid transparent',
                            opacity: isInjured ? 0.5 : 1,
                            filter: isInjured ? 'grayscale(70%)' : 'none'
                        }}
                        onClick={() => {
                            if (isInjured) return; // Can't select injured players
                            setModalTempSelections(prev =>
                                prev.includes(player.id) 
                                    ? prev.filter(id => id !== player.id)
                                    : [...prev, player.id]
                            );
                        }}
                        >
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div>
                                    <div style={{ fontWeight: 'bold', color: isInjured ? '#94a3b8' : '#e2e8f0' }}>
                                        {player.firstName} {player.lastName}
                                        {isInjured && (
                                            <span style={{ 
                                                marginLeft: '0.5rem',
                                                padding: '0.125rem 0.5rem',
                                                background: '#ef4444',
                                                color: '#fff',
                                                fontSize: '0.7rem',
                                                borderRadius: '0.25rem',
                                                fontWeight: 'bold'
                                            }}>
                                                INJ
                                            </span>
                                        )}
                                    </div>
                                    <div style={{ fontSize: '0.85rem', color: isInjured ? '#64748b' : '#93c5fd' }}>
                                        {player.position} ‚Ä¢ {player.ratings.overall} OVR ‚Ä¢ {player.ratings.potential} POT ‚Ä¢ {player.age}y ‚Ä¢ {formatSalary(player.contract?.salary || 0)}
                                        {isInjured && (
                                            <span style={{ marginLeft: '0.5rem', color: '#ef4444' }}>
                                                ({player.injury.type}, {player.injury.gamesRemaining} games)
                                            </span>
                                        )}
                                    </div>
                                </div>
                                <div>
                                    {modalTempSelections.includes(player.id) && !isInjured && (
                                        <span style={{ color: '#3b82f6', fontSize: '1.5rem' }}>‚úì</span>
                                    )}
                                    {isInjured && (
                                        <span style={{ color: '#ef4444', fontSize: '1.5rem' }}>üö´</span>
                                    )}
                                </div>
                            </div>
                        </div>
                    )});
                })()}
            </div>

            {/* Modal Actions */}
            <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
                <button
                    onClick={() => {
                        setShowAddPlayerModal(null);
                        setModalTempSelections([]);
                    }}
                    style={{
                        padding: '0.75rem 1.5rem',
                        background: '#64748b',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '0.5rem',
                        fontWeight: 'bold',
                        cursor: 'pointer'
                    }}
                >
                    Cancel
                </button>
                <button
                    onClick={() => {
                        if (showAddPlayerModal === 'my') {
                            setMySelectedPlayers(prev => [...prev, ...modalTempSelections]);
                        } else {
                            setTheirSelectedPlayers(prev => [...prev, ...modalTempSelections]);
                        }
                        setShowAddPlayerModal(null);
                        setModalTempSelections([]);
                    }}
                    disabled={modalTempSelections.length === 0}
                    style={{
                        padding: '0.75rem 1.5rem',
                        background: modalTempSelections.length > 0 ? '#22c55e' : '#334155',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '0.5rem',
                        fontWeight: 'bold',
                        cursor: modalTempSelections.length > 0 ? 'pointer' : 'not-allowed'
                    }}
                >
                    Add Selected ({modalTempSelections.length})
                </button>
            </div>
        </div>
    </div>
)}

{/* ADD DRAFT PICK MODAL */}
{showAddPickModal && (
    <div style={{
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        background: 'rgba(0,0,0,0.8)',
        zIndex: 10000,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '2rem'
    }}
    onClick={() => setShowAddPickModal(null)}
    >
        <div style={{
            background: '#1e293b',
            borderRadius: '1rem',
            padding: '2rem',
            maxWidth: '700px',
            width: '100%',
            maxHeight: '80vh',
            overflow: 'auto',
            border: '2px solid #3b82f6'
        }}
        onClick={(e) => e.stopPropagation()}
        >
            <h3 style={{ color: '#60a5fa', marginBottom: '1.5rem' }}>
                Select Draft Pick to Add {showAddPickModal === 'my' ? '(Your Picks)' : '(Their Picks)'}
            </h3>

            {/* Pick List */}
            <div style={{ marginBottom: '1.5rem', maxHeight: '400px', overflow: 'auto' }}>
                {(() => {
                    const picks = showAddPickModal === 'my' ? myTradeablePicks : theirTradeablePicks;
                    const selectedIds = showAddPickModal === 'my' ? mySelectedPicks : theirSelectedPicks;
                    const availablePicks = picks.filter(p => !selectedIds.includes(p.id));

                    if (availablePicks.length === 0) {
                        return (
                            <div style={{
                                padding: '2rem',
                                textAlign: 'center',
                                color: '#64748b'
                            }}>
                                No draft picks available to trade
                            </div>
                        );
                    }

                    return availablePicks.map(pick => {
                        const pickValue = calculateDraftPickValue(pick, gameState.standings, gameState.teamProfiles, draftProspects, gameState.year);
                        const originalTeam = TEAMS.find(t => t.id === pick.originalTeam);
                        
                        return (
                            <div key={pick.id} style={{
                                padding: '1rem',
                                background: modalTempSelections.includes(pick.id) ? 'rgba(59,130,246,0.2)' : 'rgba(255,255,255,0.05)',
                                borderRadius: '0.5rem',
                                marginBottom: '0.5rem',
                                cursor: 'pointer',
                                border: modalTempSelections.includes(pick.id) ? '2px solid #3b82f6' : '2px solid transparent'
                            }}
                            onClick={() => {
                                setModalTempSelections(prev =>
                                    prev.includes(pick.id) 
                                        ? prev.filter(id => id !== pick.id)
                                        : [...prev, pick.id]
                                );
                            }}
                            >
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', color: '#e2e8f0' }}>
                                            {pick.year} {pick.round === 1 ? '1st' : pick.round === 2 ? '2nd' : pick.round === 3 ? '3rd' : `${pick.round}th`} Round ({originalTeam?.abbreviation} #{pick.pickInRound})
                                        </div>
                                        <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                            Projected Value: ~{pickValue} OVR equivalent
                                        </div>
                                    </div>
                                    <div>
                                        {modalTempSelections.includes(pick.id) && (
                                            <span style={{ color: '#3b82f6', fontSize: '1.5rem' }}>‚úì</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        );
                    });
                })()}
            </div>

            {/* Modal Actions */}
            <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
                <button
                    onClick={() => {
                        setShowAddPickModal(null);
                        setModalTempSelections([]);
                    }}
                    style={{
                        padding: '0.75rem 1.5rem',
                        background: '#64748b',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '0.5rem',
                        fontWeight: 'bold',
                        cursor: 'pointer'
                    }}
                >
                    Cancel
                </button>
                <button
                    onClick={() => {
                        if (showAddPickModal === 'my') {
                            setMySelectedPicks(prev => [...prev, ...modalTempSelections]);
                        } else {
                            setTheirSelectedPicks(prev => [...prev, ...modalTempSelections]);
                        }
                        setShowAddPickModal(null);
                        setModalTempSelections([]);
                    }}
                    disabled={modalTempSelections.length === 0}
                    style={{
                        padding: '0.75rem 1.5rem',
                        background: modalTempSelections.length > 0 ? '#22c55e' : '#334155',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '0.5rem',
                        fontWeight: 'bold',
                        cursor: modalTempSelections.length > 0 ? 'pointer' : 'not-allowed'
                    }}
                >
                    Add Selected ({modalTempSelections.length})
                </button>
            </div>
        </div>
    </div>
)}
    </div>
);
                })()}

                {/* TRANSACTIONS VIEW */}
                {currentView === 'transactions' && gameState && (
                    <div className="card">
                        <h2>üìã League Transactions</h2>
                        <p style={{ color: '#93c5fd', marginBottom: '2rem' }}>
                            All trades completed during the {gameState.year}-{(gameState.year + 1).toString().slice(-2)} season
                        </p>
                        
                        {(() => {
                            // Combine both trade logs
                            const allTrades = [];
                            
                            // Add AI trades
                            if (gameState.aiTradeLog) {
                                gameState.aiTradeLog.forEach(trade => {
                                    allTrades.push({
                                        ...trade,
                                        isAITrade: true,
                                        sortKey: trade.day
                                    });
                                });
                            }
                            
                            // Add player trades (your trades)
                            if (gameState.tradeHistory) {
                                gameState.tradeHistory.forEach(trade => {
                                    allTrades.push({
                                        ...trade,
                                        isAITrade: false,
                                        sortKey: trade.day || 999
                                    });
                                });
                            }
                            
                            // Sort by day (most recent first)
                            allTrades.sort((a, b) => b.sortKey - a.sortKey);
                            
                            if (allTrades.length === 0) {
                                return (
                                    <div style={{
                                        padding: '3rem',
                                        textAlign: 'center',
                                        color: '#93c5fd',
                                        background: 'rgba(30, 58, 138, 0.2)',
                                        borderRadius: '0.5rem'
                                    }}>
                                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìã</div>
                                        <p style={{ fontSize: '1.2rem' }}>No trades have been completed this season yet.</p>
                                        <p style={{ marginTop: '0.5rem', fontSize: '0.9rem', color: '#64748b' }}>
                                            Check back after the trade deadline!
                                        </p>
                                    </div>
                                );
                            }
                            
                            return (
                                <div>
                                    {/* Trade Statistics */}
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(3, 1fr)',
                                        gap: '1rem',
                                        marginBottom: '2rem'
                                    }}>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '1px solid rgba(59, 130, 246, 0.3)',
                                            textAlign: 'center'
                                        }}>
                                            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#60a5fa' }}>
                                                {allTrades.length}
                                            </div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                Total Trades
                                            </div>
                                        </div>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '1px solid rgba(59, 130, 246, 0.3)',
                                            textAlign: 'center'
                                        }}>
                                            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#60a5fa' }}>
                                                {allTrades.filter(t => t.isAITrade).length}
                                            </div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                AI Trades
                                            </div>
                                        </div>
                                        <div style={{
                                            padding: '1rem',
                                            background: 'rgba(34, 197, 94, 0.1)',
                                            borderRadius: '0.5rem',
                                            border: '1px solid rgba(34, 197, 94, 0.3)',
                                            textAlign: 'center'
                                        }}>
                                            <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#22c55e' }}>
                                                {allTrades.filter(t => !t.isAITrade).length}
                                            </div>
                                            <div style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                Your Trades
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Trade List */}
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        {allTrades.map((trade, idx) => {
                                            const team1 = getTeam(trade.team1?.id || trade.team1);
                                            const team2 = getTeam(trade.team2?.id || trade.team2);
                                            
                                            return (
                                                <div key={idx} style={{
                                                    padding: '1.5rem',
                                                    background: trade.isAITrade ? 'rgba(59, 130, 246, 0.1)' : 'rgba(34, 197, 94, 0.1)',
                                                    borderRadius: '0.75rem',
                                                    border: `2px solid ${trade.isAITrade ? 'rgba(59, 130, 246, 0.3)' : 'rgba(34, 197, 94, 0.3)'}`
                                                }}>
                                                    {/* Trade Header */}
                                                    <div style={{ 
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        marginBottom: '1rem',
                                                        paddingBottom: '1rem',
                                                        borderBottom: `2px solid ${trade.isAITrade ? 'rgba(59, 130, 246, 0.2)' : 'rgba(34, 197, 94, 0.2)'}`
                                                    }}>
                                                        <div style={{ 
                                                            fontSize: '1.3rem',
                                                            fontWeight: 'bold',
                                                            color: '#fff'
                                                        }}>
                                                            {team1?.city} {team1?.name} ‚ÜîÔ∏è {team2?.city} {team2?.name}
                                                        </div>
                                                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '0.25rem' }}>
                                                            <div style={{ 
                                                                fontSize: '0.875rem',
                                                                color: '#93c5fd'
                                                            }}>
                                                                Day {trade.day} {trade.gameNumber ? `(Game ${trade.gameNumber})` : ''}
                                                            </div>
                                                            {trade.isDeadline && (
                                                                <div style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: 'rgba(239, 68, 68, 0.3)',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.75rem',
                                                                    color: '#ef4444',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    üî• DEADLINE
                                                                </div>
                                                            )}
                                                            {trade.isAITrade ? (
                                                                <div style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: 'rgba(59, 130, 246, 0.3)',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.75rem',
                                                                    color: '#60a5fa',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    AI TRADE
                                                                </div>
                                                            ) : (
                                                                <div style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: 'rgba(34, 197, 94, 0.3)',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.75rem',
                                                                    color: '#22c55e',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    YOUR TRADE
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Trade Details */}
                                                    <div style={{ 
                                                        display: 'grid',
                                                        gridTemplateColumns: '1fr auto 1fr',
                                                        gap: '2rem',
                                                        alignItems: 'start'
                                                    }}>
                                                        {/* Team 1 Gives */}
                                                        <div>
                                                            <h4 style={{ 
                                                                color: '#fbbf24',
                                                                marginBottom: '0.75rem',
                                                                fontSize: '1rem'
                                                            }}>
                                                                {team1?.city} Trades:
                                                            </h4>
                                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                {trade.team1Gives.map((player, pIdx) => {
                                                                    const fullPlayer = gameState.players.find(p => p.id === (player.id || player));
                                                                    const displayName = player.name || `${fullPlayer?.firstName} ${fullPlayer?.lastName}`;
                                                                    const displayPos = player.position || fullPlayer?.position;
                                                                    const displayOvr = player.ovr || fullPlayer?.ratings.overall;
                                                                    const displayAge = player.age || fullPlayer?.age;
                                                                    const displayPot = player.pot || fullPlayer?.ratings.potential;
                                                                    
                                                                    return (
                                                                        <div key={pIdx} style={{
                                                                            padding: '0.75rem',
                                                                            background: 'rgba(0, 0, 0, 0.2)',
                                                                            borderRadius: '0.375rem',
                                                                            cursor: fullPlayer ? 'pointer' : 'default'
                                                                        }}
                                                                        onClick={() => fullPlayer && navigateTo('playerProfile', fullPlayer)}
                                                                        >
                                                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                                                <span 
                                                                                    style={{ color: '#fff', fontWeight: 'bold' }}
                                                                                    className={fullPlayer ? 'clickable-player' : ''}
                                                                                >
                                                                                    {displayName}
                                                                                </span>
                                                                                <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                                                                                    <span style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                                                        {displayPos}
                                                                                    </span>
                                                                                    <span style={{ color: '#64748b', fontSize: '0.875rem' }}>
                                                                                        Age {displayAge}
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                            <div style={{ display: 'flex', gap: '0.75rem', marginTop: '0.5rem', fontSize: '0.875rem' }}>
                                                                                <span style={{ color: '#fbbf24', fontWeight: 'bold' }}>
                                                                                    {displayOvr} OVR
                                                                                </span>
                                                                                <span style={{ color: '#a78bfa' }}>
                                                                                    {displayPot} POT
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                                
                                                                {/* Draft Picks for Team 1 */}
                                                                {trade.team1Picks && trade.team1Picks.map((pick, pIdx) => (
                                                                    <div key={`pick-${pIdx}`} style={{
                                                                        padding: '0.75rem',
                                                                        background: 'rgba(168, 85, 247, 0.15)',
                                                                        borderRadius: '0.375rem',
                                                                        border: '1px solid rgba(168, 85, 247, 0.3)'
                                                                    }}>
                                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                                            <span style={{ color: '#a78bfa', fontWeight: 'bold' }}>
                                                                                üìã {pick.year} {pick.round === 1 ? '1st' : pick.round === 2 ? '2nd' : pick.round === 3 ? '3rd' : `${pick.round}th`} Round
                                                                            </span>
                                                                            <span style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                                                {pick.originalTeam} #{pick.pickInRound}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Arrow */}
                                                        <div style={{ 
                                                            fontSize: '2rem',
                                                            color: '#93c5fd',
                                                            display: 'flex',
                                                            alignItems: 'center',
                                                            justifyContent: 'center'
                                                        }}>
                                                            ‚áÑ
                                                        </div>
                                                        
                                                        {/* Team 2 Gives */}
                                                        <div>
                                                            <h4 style={{ 
                                                                color: '#fbbf24',
                                                                marginBottom: '0.75rem',
                                                                fontSize: '1rem'
                                                            }}>
                                                                {team2?.city} Trades:
                                                            </h4>
                                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                                {trade.team2Gives.map((player, pIdx) => {
                                                                    const fullPlayer = gameState.players.find(p => p.id === (player.id || player));
                                                                    const displayName = player.name || `${fullPlayer?.firstName} ${fullPlayer?.lastName}`;
                                                                    const displayPos = player.position || fullPlayer?.position;
                                                                    const displayOvr = player.ovr || fullPlayer?.ratings.overall;
                                                                    const displayAge = player.age || fullPlayer?.age;
                                                                    const displayPot = player.pot || fullPlayer?.ratings.potential;
                                                                    
                                                                    return (
                                                                        <div key={pIdx} style={{
                                                                            padding: '0.75rem',
                                                                            background: 'rgba(0, 0, 0, 0.2)',
                                                                            borderRadius: '0.375rem',
                                                                            cursor: fullPlayer ? 'pointer' : 'default'
                                                                        }}
                                                                        onClick={() => fullPlayer && navigateTo('playerProfile', fullPlayer)}
                                                                        >
                                                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                                                <span 
                                                                                    style={{ color: '#fff', fontWeight: 'bold' }}
                                                                                    className={fullPlayer ? 'clickable-player' : ''}
                                                                                >
                                                                                    {displayName}
                                                                                </span>
                                                                                <div style={{ display: 'flex', gap: '0.75rem', alignItems: 'center' }}>
                                                                                    <span style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                                                        {displayPos}
                                                                                    </span>
                                                                                    <span style={{ color: '#64748b', fontSize: '0.875rem' }}>
                                                                                        Age {displayAge}
                                                                                    </span>
                                                                                </div>
                                                                            </div>
                                                                            <div style={{ display: 'flex', gap: '0.75rem', marginTop: '0.5rem', fontSize: '0.875rem' }}>
                                                                                <span style={{ color: '#fbbf24', fontWeight: 'bold' }}>
                                                                                    {displayOvr} OVR
                                                                                </span>
                                                                                <span style={{ color: '#a78bfa' }}>
                                                                                    {displayPot} POT
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                })}
                                                                
                                                                {/* Draft Picks for Team 2 */}
                                                                {trade.team2Picks && trade.team2Picks.map((pick, pIdx) => (
                                                                    <div key={`pick-${pIdx}`} style={{
                                                                        padding: '0.75rem',
                                                                        background: 'rgba(168, 85, 247, 0.15)',
                                                                        borderRadius: '0.375rem',
                                                                        border: '1px solid rgba(168, 85, 247, 0.3)'
                                                                    }}>
                                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                                            <span style={{ color: '#a78bfa', fontWeight: 'bold' }}>
                                                                                üìã {pick.year} {pick.round === 1 ? '1st' : pick.round === 2 ? '2nd' : pick.round === 3 ? '3rd' : `${pick.round}th`} Round
                                                                            </span>
                                                                            <span style={{ color: '#93c5fd', fontSize: '0.875rem' }}>
                                                                                {pick.originalTeam} #{pick.pickInRound}
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })()}
                    </div>
                )}

                {/* HELP & USER MANUAL */}
                {currentView === 'help' && (
                    <div>
                        <div className="card">
                            <h1 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üìñ Hockey GM - User Manual</h1>
                            <p style={{ color: '#93c5fd', marginBottom: '2rem', fontSize: '1.1rem' }}>
                                Everything you need to know to become a championship GM
                            </p>
                            
                            <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', 
                                gap: '1rem',
                                marginBottom: '2rem'
                            }}>
                                <a 
                                    href="docs/USER_MANUAL.md" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        padding: '1.5rem',
                                        background: 'linear-gradient(135deg, #3b82f6, #1e40af)',
                                        borderRadius: '0.75rem',
                                        border: '2px solid #60a5fa',
                                        textDecoration: 'none',
                                        color: 'white',
                                        textAlign: 'center',
                                        transition: 'transform 0.2s',
                                        cursor: 'pointer'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                >
                                    <div style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>üìö</div>
                                    <div style={{ fontSize: '1.2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>Full User Manual</div>
                                    <div style={{ fontSize: '0.9rem', color: '#93c5fd' }}>Complete guide with screenshots</div>
                                </a>
                                
                                <a 
                                    href="docs/ROADMAP.md" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        padding: '1.5rem',
                                        background: 'linear-gradient(135deg, #8b5cf6, #6d28d9)',
                                        borderRadius: '0.75rem',
                                        border: '2px solid #a78bfa',
                                        textDecoration: 'none',
                                        color: 'white',
                                        textAlign: 'center',
                                        transition: 'transform 0.2s',
                                        cursor: 'pointer'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                                    onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                                >
                                    <div style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>üó∫Ô∏è</div>
                                    <div style={{ fontSize: '1.2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>Development Roadmap</div>
                                    <div style={{ fontSize: '0.9rem', color: '#c4b5fd' }}>See what's coming next</div>
                                </a>
                            </div>
                        </div>

                        <div className="card">
                            <h2 style={{ color: '#22c55e', marginBottom: '1.5rem' }}>üöÄ Quick Start Guide</h2>
                            
                            <div style={{ marginBottom: '2rem' }}>
                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>1. Getting Started</h3>
                                <ul style={{ color: '#e2e8f0', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li>Select your team from the 32 available franchises</li>
                                    <li>Your season is automatically generated with an 82-game schedule</li>
                                    <li>Navigate to <strong>Team Hub</strong> to see your team overview</li>
                                </ul>
                            </div>

                            <div style={{ marginBottom: '2rem' }}>
                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>2. Playing Games</h3>
                                <ul style={{ color: '#e2e8f0', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li>Click the green <strong>üéÆ Play Game</strong> button to simulate the next game</li>
                                    <li>Watch the animated results popup show your game outcome</li>
                                    <li>View detailed stats for any completed game</li>
                                </ul>
                            </div>

                            <div style={{ marginBottom: '2rem' }}>
                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>3. Managing Your Team</h3>
                                <ul style={{ color: '#e2e8f0', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li><strong>My Team ‚Üí Lines & Scratches</strong> - Set your lineup (4 forward lines, 3 D pairs, goalies, special teams)</li>
                                    <li><strong>My Team ‚Üí Roster</strong> - View all players, stats, and contracts</li>
                                    <li><strong>My Team ‚Üí Injuries</strong> - Track injured players and recovery times</li>
                                    <li><strong>My Team ‚Üí Call-Ups</strong> - Move players between NHL and farm team</li>
                                </ul>
                            </div>

                            <div style={{ marginBottom: '2rem' }}>
                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>4. Making Transactions</h3>
                                <ul style={{ color: '#e2e8f0', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li><strong>Transactions ‚Üí Trades</strong> - Propose trades with AI teams (must complete before Day 56 deadline)</li>
                                    <li><strong>Transactions ‚Üí Re-Sign Players</strong> - Negotiate contract extensions with expiring players</li>
                                    <li><strong>Transactions ‚Üí Draft Picks</strong> - View your picks for upcoming drafts</li>
                                </ul>
                            </div>

                            <div style={{ marginBottom: '2rem' }}>
                                <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>5. Tracking Performance</h3>
                                <ul style={{ color: '#e2e8f0', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li><strong>Stats & Standings ‚Üí Standings</strong> - Check your division/conference ranking</li>
                                    <li><strong>Stats & Standings ‚Üí Player Stats</strong> - League-wide statistics (sortable by category)</li>
                                    <li><strong>Stats & Standings ‚Üí League Leaders</strong> - Top performers in each category</li>
                                </ul>
                            </div>
                        </div>

                        <div className="card">
                            <h2 style={{ color: '#fbbf24', marginBottom: '1.5rem' }}>üí° Pro Tips</h2>
                            
                            <div style={{ display: 'grid', gap: '1rem' }}>
                                <div style={{ padding: '1rem', background: 'rgba(34, 197, 94, 0.2)', borderRadius: '0.5rem', border: '1px solid #22c55e' }}>
                                    <h4 style={{ color: '#22c55e', marginBottom: '0.5rem' }}>‚úÖ Use Auto-Set Lineup</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.95rem' }}>
                                        Click <strong>"Auto-Set Best Lineup"</strong> in Lines & Scratches to automatically organize your roster by overall rating
                                    </p>
                                </div>

                                <div style={{ padding: '1rem', background: 'rgba(59, 130, 246, 0.2)', borderRadius: '0.5rem', border: '1px solid #3b82f6' }}>
                                    <h4 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>üìä Check Team Hub Alerts</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.95rem' }}>
                                        The Team Hub shows important alerts like injuries, expiring contracts, and the trade deadline
                                    </p>
                                </div>

                                <div style={{ padding: '1rem', background: 'rgba(245, 158, 11, 0.2)', borderRadius: '0.5rem', border: '1px solid #f59e0b' }}>
                                    <h4 style={{ color: '#fbbf24', marginBottom: '0.5rem' }}>üí∞ Manage Your Cap Space</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.95rem' }}>
                                        Keep $5-10M in cap space as a buffer. Check future cap projections when re-signing players
                                    </p>
                                </div>

                                <div style={{ padding: '1rem', background: 'rgba(139, 92, 246, 0.2)', borderRadius: '0.5rem', border: '1px solid #8b5cf6' }}>
                                    <h4 style={{ color: '#a78bfa', marginBottom: '0.5rem' }}>üéØ Balance Your Lines</h4>
                                    <p style={{ color: '#e2e8f0', fontSize: '0.95rem' }}>
                                        Spread talent across all 4 lines rather than loading up one line. Your depth matters in simulations
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div className="card">
                            <h2 style={{ color: '#ef4444', marginBottom: '1.5rem' }}>üîß Common Issues</h2>
                            
                            <div style={{ marginBottom: '1.5rem' }}>
                                <h4 style={{ color: '#f87171', marginBottom: '0.5rem' }}>‚ùå "Cannot simulate - invalid lineup"</h4>
                                <p style={{ color: '#e2e8f0', marginBottom: '0.5rem' }}><strong>Solution:</strong></p>
                                <ul style={{ color: '#93c5fd', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li>Check that all line positions are filled</li>
                                    <li>Verify PK units have exactly 4 players</li>
                                    <li>Verify PP units have exactly 5 players</li>
                                    <li>Click "Auto-Set Best Lineup" to fix automatically</li>
                                </ul>
                            </div>

                            <div style={{ marginBottom: '1.5rem' }}>
                                <h4 style={{ color: '#f87171', marginBottom: '0.5rem' }}>‚ùå Trade keeps getting rejected</h4>
                                <p style={{ color: '#e2e8f0', marginBottom: '0.5rem' }}><strong>Solution:</strong></p>
                                <ul style={{ color: '#93c5fd', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li>Add more value to your side (better players or draft picks)</li>
                                    <li>Check if the player is injured (can't trade injured players)</li>
                                    <li>Make sure the AI team has enough cap space</li>
                                </ul>
                            </div>

                            <div style={{ marginBottom: '1.5rem' }}>
                                <h4 style={{ color: '#f87171', marginBottom: '0.5rem' }}>‚ùå Player won't accept contract</h4>
                                <p style={{ color: '#e2e8f0', marginBottom: '0.5rem' }}><strong>Solution:</strong></p>
                                <ul style={{ color: '#93c5fd', lineHeight: '1.8', marginLeft: '1.5rem' }}>
                                    <li>Increase salary to within 15% of their asking price</li>
                                    <li>Adjust contract length to within 2 years of their preference</li>
                                    <li>Check the "Acceptance Likelihood" indicator</li>
                                </ul>
                            </div>
                        </div>

                        <div className="card" style={{ background: 'linear-gradient(135deg, #1e293b, #1e40af)', border: '2px solid #3b82f6' }}>
                            <h2 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üìû Need More Help?</h2>
                            <div style={{ display: 'grid', gap: '1rem' }}>
                                <a 
                                    href="https://discord.gg/zxhezDxfFm" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        padding: '1rem',
                                        background: 'rgba(88, 101, 242, 0.3)',
                                        borderRadius: '0.5rem',
                                        border: '1px solid #5865f2',
                                        color: '#93c5fd',
                                        textDecoration: 'none',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '1rem'
                                    }}
                                >
                                    <span style={{ fontSize: '2rem' }}>üí¨</span>
                                    <div>
                                        <div style={{ fontWeight: 'bold', color: 'white', marginBottom: '0.25rem' }}>Join Discord</div>
                                        <div style={{ fontSize: '0.9rem' }}>Ask questions, report bugs, suggest features</div>
                                    </div>
                                </a>

                                <a 
                                    href="docs/USER_MANUAL.md" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        padding: '1rem',
                                        background: 'rgba(34, 197, 94, 0.3)',
                                        borderRadius: '0.5rem',
                                        border: '1px solid #22c55e',
                                        color: '#93c5fd',
                                        textDecoration: 'none',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '1rem'
                                    }}
                                >
                                    <span style={{ fontSize: '2rem' }}>üìñ</span>
                                    <div>
                                        <div style={{ fontWeight: 'bold', color: 'white', marginBottom: '0.25rem' }}>Full Documentation</div>
                                        <div style={{ fontSize: '0.9rem' }}>Complete manual with advanced strategies</div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                )}

                {currentView === 'roadmap' && (
                    <div>
                        <div className="card">
                            <h1 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üöÄ Hockey GM - Development Roadmap</h1>
                            <p style={{ color: '#93c5fd', marginBottom: '1rem', fontSize: '1.1rem' }}>
                                Last Updated: January 10, 2026
                            </p>
                            <p style={{ color: '#e2e8f0', marginBottom: '2rem' }}>
                                Building Hockey GM one phase at a time. Focus on completing each phase fully before moving to the next. Current priority: Multi-season franchise mode and offseason features.
                            </p>
                        </div>

                        <div className="card" style={{ border: '2px solid #22c55e' }}>
                            <h2 style={{ color: '#22c55e' }}>‚úÖ Phase 1: Core Simulation - COMPLETE</h2>
                            <p style={{ color: '#93c5fd', fontSize: '0.95rem', marginBottom: '1rem' }}>
                                <strong>Completed:</strong> November 2025
                            </p>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>‚úÖ 32-team professional league structure (Atlantic, Metropolitan, Central, Pacific divisions)</li>
                                <li>‚úÖ 82-game regular season simulation</li>
                                <li>‚úÖ Day-by-day and full season simulation</li>
                                <li>‚úÖ Realistic game engine (team ratings, home advantage, scoring distribution)</li>
                                <li>‚úÖ Full player stats tracking (G, A, PTS, +/-, PIM, TOI, SOG)</li>
                                <li>‚úÖ Goalie stats (W, L, SV%, GAA, SO)</li>
                                <li>‚úÖ Team standings (division, conference, wildcard, league views)</li>
                                <li>‚úÖ League leaders board (7 categories: Goals, Assists, Points, +/-, PIM, TOI, SOG)</li>
                                <li>‚úÖ Dynamic player profiles with career stats</li>
                                <li>‚úÖ Injury system with realistic recovery times</li>
                                <li>‚úÖ Load management and healthy scratches</li>
                                <li>‚úÖ Team profiles with roster breakdowns</li>
                                <li>‚úÖ League schedule view (all 82 game days)</li>
                                <li>‚úÖ Basic trade system</li>
                                <li>‚úÖ Save/load game functionality</li>
                                <li>‚úÖ Animated simulation popup (displays scores game-by-game with 0.7s pause)</li>
                                <li>‚úÖ Stop simulation button (halt simulation at any time)</li>
                            </ul>
                        </div>

                        <div className="card" style={{ border: '2px solid #22c55e' }}>
                            <h2 style={{ color: '#22c55e' }}>‚úÖ Phase 2: Playoffs - COMPLETE</h2>
                            <p style={{ color: '#93c5fd', fontSize: '0.95rem', marginBottom: '1rem' }}>
                                <strong>Completed:</strong> December 2025
                            </p>
                            <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Full professional postseason with detailed stats!</p>
                            
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>‚úÖ 16-team playoff bracket (8 per conference, 1v8, 2v7, 3v6, 4v5)</li>
                                <li>‚úÖ Best-of-7 series for all 4 rounds</li>
                                <li>‚úÖ Full tournament bracket visualization (7-column tree view)</li>
                                <li>‚úÖ Game-by-game playoff simulation with animated popup</li>
                                <li>‚úÖ Live bracket updates showing series scores</li>
                                <li>‚úÖ Individual game results displayed under bracket</li>
                                <li>‚úÖ Game summary display (scores, series status, winner highlights)</li>
                                <li>‚úÖ <strong>Separate playoff stats tracking (starts from 0 each playoffs)</strong></li>
                                <li>‚úÖ <strong>Detailed playoff game views with per-game stats</strong></li>
                                <li>‚úÖ <strong>Period-by-period scoring summaries for playoff games</strong></li>
                                <li>‚úÖ <strong>Running playoff totals in scoring summary (e.g., McDavid (8) shows 8th playoff goal)</strong></li>
                                <li>‚úÖ <strong>Home/Away team tabs for playoff game stats</strong></li>
                                <li>‚úÖ <strong>Full skater stats: G, A, PTS, +/-, SOG, TOI</strong></li>
                                <li>‚úÖ <strong>Full goalie stats: SA, SV, GA, SV%, W/L</strong></li>
                                <li>‚úÖ <strong>Healthy scratch tracking for playoff games</strong></li>
                                <li>‚úÖ 2-2-1-1-1 home game format (realistic playoff schedule)</li>
                                <li>‚úÖ Championship Finals with champion crowning</li>
                                <li>‚úÖ Series history preservation</li>
                                <li>‚úÖ Playoff leaders board toggle</li>
                                <li>‚úÖ Goalie leaderboards (Wins, SV%, GAA, Shutouts)</li>
                            </ul>
                        </div>

                        <div className="card" style={{ border: '2px solid #fbbf24' }}>
                            <h2 style={{ color: '#22c55e' }}>‚úÖ Phase 2.5: Technical Infrastructure - COMPLETE</h2>
                            <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Performance optimization and long-term stability for multi-season play</p>
                            
                            <h3 style={{ color: '#22c55e', marginTop: '1rem' }}>‚úÖ Completed:</h3>
                            <p style={{ color: '#93c5fd', fontSize: '0.9rem', marginBottom: '0.5rem' }}>
                                <strong>December 2025</strong>
                            </p>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>‚úÖ Per-game stat tracking for all games (regular season + playoffs)</li>
                                <li>‚úÖ Season totals = sum of all game stats (perfect accuracy)</li>
                                <li>‚úÖ Game detail views with full player stats</li>
                                <li>‚úÖ Period-by-period scoring summaries</li>
                                <li>‚úÖ Running season totals in scoring summaries</li>
                            </ul>
                        </div>

                        <div className="card">
                            <h2 style={{ color: '#8b5cf6' }}>üìã Phase 3: Franchise Management - IN PROGRESS</h2>
                            <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Foundation for long-term gameplay and multiple seasons</p>
                            
                            <h3 style={{ color: '#22c55e', marginTop: '1rem' }}>‚úÖ Recently Completed:</h3>
                            <p style={{ color: '#93c5fd', fontSize: '0.9rem', marginBottom: '0.5rem' }}>
                                <strong>January 4, 2026</strong>
                            </p>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>‚úÖ <strong>Trade Value System</strong> (quality-weighted scoring replaces raw OVR sum)</li>
                                <li>‚úÖ <strong>Realistic draft pick valuation</strong> (late picks now properly valued as minimal assets)</li>
                                <li>‚úÖ <strong>Injury indicators in trades</strong> (injured players greyed out with visual warnings)</li>
                                <li>‚úÖ <strong>AI trade bug fix</strong> (trade data now properly persists across simulations)</li>
                                <li>‚úÖ <strong>Trade UI improvements</strong> (clear value display with trade score vs total OVR)</li>
                            </ul>
                            
                            <p style={{ color: '#93c5fd', fontSize: '0.9rem', marginBottom: '0.5rem', marginTop: '1rem' }}>
                                <strong>January 3, 2026</strong>
                            </p>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>‚úÖ <strong>Season-Ending Summary screen</strong> (comprehensive season wrap-up)</li>
                                <li>‚úÖ <strong>Draft Lottery system</strong> (weighted odds for non-playoff teams)</li>
                                <li>‚úÖ <strong>Animated lottery reveal</strong> (step-by-step pick announcements)</li>
                                <li>‚úÖ <strong>Draft order determination</strong> (top 16 lottery + playoff order)</li>
                                <li>‚úÖ <strong>Entry Draft system</strong> (7 rounds, 224 picks with 10,000 historical NHL names)</li>
                                <li>‚úÖ <strong>Prospect generation</strong> (scouting grades, traits, potential ratings)</li>
                                <li>‚úÖ <strong>Interactive draft interface</strong> (pick-by-pick with auto-draft mode)</li>
                                <li>‚úÖ <strong>Draft needs analysis & report card</strong> (prospect pool evaluation, strategy recommendations, graded performance)</li>
                                <li>‚úÖ <strong>Free Agency system</strong> (50-80 UFAs, contract negotiations, AI acceptance logic)</li>
                                <li>‚úÖ <strong>Salary cap management</strong> ($83.5M cap with real-time tracking)</li>
                                <li>‚úÖ <strong>Contract system</strong> (multi-year deals, market value evaluation)</li>
                                <li>‚úÖ <strong>Free agency needs analysis & report card</strong> (roster evaluation, GM recommendations, graded signings)</li>
                                <li>‚úÖ <strong>Multi-season progression</strong> (advance year, age players, reset stats, new schedule)</li>
                                <li>‚úÖ <strong>Season progression flow</strong> (Playoffs ‚Üí Summary ‚Üí Lottery ‚Üí Draft ‚Üí Free Agency ‚Üí New Season)</li>
                                <li>‚úÖ <strong>AI Trade system improvements</strong> (fixed cap validation, trade frequency, logging)</li>
                                <li>‚úÖ <strong>Unified simulation system</strong> (all sim options show game-by-game popup)</li>
                                <li>‚úÖ <strong>Public Beta disclaimer</strong> (transparent development status)</li>
                                <li>‚úÖ <strong>Career stats archiving</strong> (complete season-by-season history, career totals for all players)</li>
                                <li>‚úÖ <strong>Player retirement system</strong> (age-based retirement with full career preservation)</li>
                                <li>‚úÖ <strong>Retired player archive</strong> (permanent career histories for all retired players)</li>
                                <li>‚úÖ <strong>Automatic rookie generation</strong> (new players replace retirees each offseason)</li>
                            </ul>
                            
                            <p style={{ color: '#93c5fd', fontSize: '0.9rem', marginBottom: '0.5rem', marginTop: '1rem' }}>
                                <strong>January 10, 2026</strong>
                            </p>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>‚úÖ <strong>Team Hub</strong> (comprehensive command center as default landing page)</li>
                                <li>‚úÖ <strong>Quick Actions bar</strong> (one-click access to common tasks)</li>
                                <li>‚úÖ <strong>Team Performance dashboard</strong> (record, recent form, division rank, team overall)</li>
                                <li>‚úÖ <strong>Top Performers display</strong> (top 3 scorers with full stats)</li>
                                <li>‚úÖ <strong>Recent & Upcoming Games</strong> (last 3 + next 3 with opponent info)</li>
                                <li>‚úÖ <strong>Team Status & Alerts</strong> (cap space, injuries, trade deadline warnings)</li>
                                <li>‚úÖ <strong>Improved navigation flow</strong> (stays on current page after simulation)</li>
                                <li>‚úÖ <strong>Lineup validation system</strong> (must have valid lineup to play games)</li>
                            </ul>
                            
                            <h3 style={{ color: '#fbbf24', marginTop: '1rem' }}>‚è≥ Currently Working On:</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>üîß <strong>Player development system</strong> (age-based progression/regression)</li>
                                <li>üîß <strong>Contract expiry & RFA system</strong> (re-signing own players)</li>
                                <li>üîß <strong>Career stats viewer</strong> (browse historical seasons and retired players)</li>
                                <li>üîß <strong>Trade deadline pressure</strong> (enhanced AI urgency near deadline)</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>1. Multi-Season Framework (HIGH PRIORITY)</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>‚úÖ Season summary screens (year-end wrap-up)</li>
                                <li>‚úÖ Draft lottery system</li>
                                <li>‚úÖ Entry draft (7 rounds, 224 picks)</li>
                                <li>‚úÖ Free agency phase</li>
                                <li>‚úÖ Multi-season progression (advance to next year)</li>
                                <li>Training camp & preseason (optional - may skip)</li>
                                <li>Historical records tracking (past champions, award winners)</li>
                                <li>Career stats accumulation across seasons</li>
                                <li>Season history viewer (browse past seasons)</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>2. Player Development & Aging</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>Age-based progression/regression curves</li>
                                <li>Young players (18-24): +1-5 OVR per season (rapid development)</li>
                                <li>Prime players (25-30): maintain or slight improvement (+0-1 OVR)</li>
                                <li>Aging players (31+): -1-3 OVR per season (gradual decline)</li>
                                <li>Potential rating system (determines growth ceiling)</li>
                                <li>Playing time affects development (ice time matters)</li>
                                <li>Retirement logic (age 38-42, or declining performance)</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>3. Contracts & Salary Cap</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>Player contracts (1-8 years, $700K-$15M per year)</li>
                                <li>Salary cap ($83.5M) and floor ($61.7M)</li>
                                <li>Cap hit calculation (AAV - average annual value)</li>
                                <li>Contract expiry tracking and RFA/UFA eligibility</li>
                                <li>Team payroll view with cap space display</li>
                                <li>Entry-level contracts (ELC) for rookies</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>4. Free Agency</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>UFA (Unrestricted Free Agents) - open market</li>
                                <li>RFA (Restricted Free Agents) - qualifying offers required</li>
                                <li>Contract negotiation AI (players demand market value)</li>
                                <li>July 1st free agency frenzy period</li>
                                <li>Signing bonuses and term preferences</li>
                                <li>Team needs vs. player asking price</li>
                            </ul>
                        </div>

                        <div className="card">
                            <h2 style={{ color: '#3b82f6' }}>üìä Phase 4: Advanced Features</h2>
                            <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>Polish and depth for dedicated players</p>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>Awards & Honors</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>Hart Trophy (MVP)</li>
                                <li>Vezina Trophy (Best Goalie)</li>
                                <li>Norris Trophy (Best Defenseman)</li>
                                <li>Calder Trophy (Rookie of the Year)</li>
                                <li>Conn Smythe Trophy (Playoff MVP)</li>
                                <li>All-Star Teams (1st, 2nd, 3rd)</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>Financial Management</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>Attendance tracking (15,000-21,000 capacity)</li>
                                <li>Ticket revenue based on performance</li>
                                <li>Playoff revenue bonuses</li>
                                <li>Operating expenses and profit/loss</li>
                                <li>Arena upgrades</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>Advanced Stats</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>Corsi & Fenwick (shot attempt metrics)</li>
                                <li>PDO (shooting % + save %)</li>
                                <li>Zone starts (offensive/defensive)</li>
                                <li>Quality of competition metrics</li>
                                <li>Heat maps and advanced visualizations</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1rem' }}>üéÆ Live Game Viewer</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li><strong>Watch games play out in real-time!</strong></li>
                                <li>Text-based play-by-play commentary</li>
                                <li>Period-by-period progression</li>
                                <li>Live score updates and shot counters</li>
                                <li>Highlight reel of key moments</li>
                                <li>Option to sim fast or watch live</li>
                            </ul>
                            <p style={{ color: '#22d3ee', marginTop: '0.5rem', fontStyle: 'italic', fontSize: '0.9rem' }}>
                                Example: "14:23 1st - McDavid carries into the zone... shoots... GOAL! McDavid (15) from Draisaitl (22). Oilers lead 2-1!"
                            </p>
                        </div>

                        <div className="card">
                            <h2 style={{ color: '#a78bfa' }}>üåç Phase 5: International Expansion (Future Vision)</h2>
                            <p style={{ color: '#22d3ee', marginBottom: '1rem' }}>A global hockey universe - this is the long-term dream!</p>
                            
                            <h3 style={{ color: '#22d3ee' }}>Continental Leagues</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>üèí <strong>North America:</strong> 32 teams, 82-game season (existing)</li>
                                <li>üá™üá∫ <strong>Europe:</strong> 30 teams (Russia, Sweden, Finland, Czech), 60-game season</li>
                                <li>üåè <strong>Asia:</strong> 30 teams (Japan, Korea, China, Kazakhstan), 60-game season</li>
                                <li>üåé <strong>South America:</strong> 30 teams (Argentina, Brazil, Chile), 60-game season</li>
                                <li>üåç <strong>Africa:</strong> 30 teams (South Africa, Algeria, Morocco), 60-game season</li>
                            </ul>
                            
                            <h3 style={{ color: '#22d3ee', marginTop: '1.5rem' }}>Inter-Continental Competition</h3>
                            <ul style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                <li>üèÜ <strong>Champions League:</strong> Top 4 from each league (20 teams) - Group stage ‚Üí Knockout ‚Üí Final</li>
                                <li>üåê <strong>World Cup of Hockey:</strong> National teams, every 4 years, 32 nations</li>
                                <li>ü•á <strong>Olympics:</strong> Winter Olympics integration</li>
                            </ul>
                            
                            <p style={{ color: '#93c5fd', marginTop: '1.5rem', fontStyle: 'italic' }}>
                                Note: This phase requires Phases 1-4 to be fully complete and stable. It's a massive undertaking that will come after the core game is polished.
                            </p>
                        </div>

                        <div className="card" style={{ background: 'rgba(59, 130, 246, 0.1)', border: '2px solid #3b82f6' }}>
                            <h2 style={{ color: '#3b82f6' }}>üí° Development Philosophy</h2>
                            <ul style={{ color: '#e2e8f0', lineHeight: '2', fontSize: '1.05rem' }}>
                                <li><strong>Quality over Speed:</strong> Each feature must work perfectly before moving on</li>
                                <li><strong>User Feedback:</strong> Your input shapes priorities and features</li>
                                <li><strong>Incremental Progress:</strong> Small, tested updates prevent breaking changes</li>
                                <li><strong>Save Compatibility:</strong> Your saves will work with future updates</li>
                                <li><strong>Open Development:</strong> Track progress in this roadmap</li>
                            </ul>
                            
                            <p style={{ color: '#22d3ee', marginTop: '1.5rem', fontSize: '1.1rem' }}>
                                üéØ <strong>Current Focus:</strong> Phase 2.5 - Data compression system to enable efficient multi-season play (30+ seasons without performance issues)
                            </p>
                            
                            <p style={{ color: '#93c5fd', marginTop: '1rem' }}>
                                Have feedback or feature requests? Use the feedback button below any response to share your thoughts!
                            </p>
                        </div>
                    </div>
                )}

                {/* AWARDS VIEW */}
                {currentView === 'awards' && seasonAwards && (
                    <div>
                        <div className="card" style={{ background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.1))', border: '2px solid #f59e0b' }}>
                            <h1 style={{ color: '#fbbf24', marginBottom: '0.5rem', fontSize: '2.5rem' }}>üèÜ End of Season Awards</h1>
                            <p style={{ color: '#93c5fd', fontSize: '1.2rem' }}>
                                {gameState.year}-{(gameState.year + 1).toString().slice(-2)} Season
                            </p>
                            <button 
                                onClick={() => {
                                    startPlayoffs(); // This sets seasonMode='playoffs' and currentView='bracket'
                                }}
                                style={{
                                    marginTop: '1rem',
                                    padding: '0.75rem 1.5rem',
                                    background: '#22c55e',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.5rem',
                                    fontSize: '1.1rem',
                                    cursor: 'pointer',
                                    fontWeight: 'bold'
                                }}
                            >
                                Continue to Playoffs ‚Üí
                            </button>
                        </div>

                        {/* LEAGUE AWARDS */}
                        <div className="card">
                            <h2 style={{ color: '#f59e0b', marginBottom: '1.5rem' }}>‚≠ê League Awards</h2>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1.5rem' }}>
                                {[
                                    { title: 'League MVP', player: seasonAwards.league.mvp, icon: 'üèÜ' },
                                    { title: 'Best Goaltender', player: seasonAwards.league.bestGoalie, icon: 'ü•Ö' },
                                    { title: 'Best Defenseman', player: seasonAwards.league.bestDefenseman, icon: 'üõ°Ô∏è' },
                                    { title: 'Rookie of the Year', player: seasonAwards.league.rookieOfYear, icon: '‚≠ê' },
                                    { title: 'Top Goal Scorer', player: seasonAwards.league.topGoalScorer, icon: 'üéØ' },
                                    { title: 'Top Point Scorer', player: seasonAwards.league.topPointScorer, icon: 'üìä' },
                                    { title: 'Best Defensive Forward', player: seasonAwards.league.bestDefensiveForward, icon: 'üèÖ' },
                                    { title: 'Sportsmanship Award', player: seasonAwards.league.sportsmanship, icon: 'ü§ù' }
                                ].map((award, idx) => {
                                    if (!award.player) return null;
                                    const team = TEAMS.find(t => t.id === award.player.teamId);
                                    return (
                                        <div key={idx} style={{
                                            padding: '1.5rem',
                                            background: 'rgba(245, 158, 11, 0.1)',
                                            borderRadius: '0.75rem',
                                            border: '2px solid rgba(245, 158, 11, 0.3)',
                                            cursor: 'pointer'
                                        }}
                                        onClick={() => {
                                            navigateTo('playerProfile', award.player);
                                        }}>
                                            <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>{award.icon}</div>
                                            <h3 style={{ color: '#fbbf24', marginBottom: '0.75rem', fontSize: '1.1rem' }}>
                                                {award.title}
                                            </h3>
                                            <div style={{ color: '#fff', fontWeight: 'bold', fontSize: '1.2rem', marginBottom: '0.5rem' }}>
                                                {award.player.firstName} {award.player.lastName}
                                            </div>
                                            <div style={{ color: '#93c5fd', marginBottom: '0.75rem' }}>
                                                {team?.city} {team?.name}
                                            </div>
                                            <div style={{ color: '#e2e8f0', fontSize: '0.9rem' }}>
                                                {award.player.position === 'G' ? (
                                                    <>
                                                        {award.player.stats?.wins}-{award.player.stats?.losses} | 
                                                        {' '}{award.player.stats.savePercentage.toFixed(3)} SV% | 
                                                        {' '}{award.player.stats.gaa.toFixed(2)} GAA
                                                    </>
                                                ) : (
                                                    <>
                                                        {award.player.stats.goals}G {award.player.stats.assists}A {award.player.stats.points}PTS | 
                                                        {' '}{award.player.stats.plusMinus > 0 ? '+' : ''}{award.player.stats.plusMinus}
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* ALL-STAR TEAMS */}
                        <div className="card">
                            <h2 style={{ color: '#22d3ee', marginBottom: '1.5rem' }}>‚≠ê League All-Star Teams</h2>
                            
                            {['firstTeam', 'secondTeam', 'thirdTeam'].map((teamType, teamIdx) => {
                                const teamName = teamType === 'firstTeam' ? '1st Team' : teamType === 'secondTeam' ? '2nd Team' : '3rd Team';
                                const team = seasonAwards.allStars[teamType];
                                
                                return (
                                    <div key={teamIdx} style={{ marginBottom: '2rem' }}>
                                        <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>{teamName}</h3>
                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem' }}>
                                            {[
                                                { label: 'Goalie', player: team.goalie },
                                                { label: 'Left Defense', player: team.leftDefense },
                                                { label: 'Right Defense', player: team.rightDefense },
                                                { label: 'Center', player: team.center },
                                                { label: 'Left Wing', player: team.leftWing },
                                                { label: 'Right Wing', player: team.rightWing }
                                            ].map((pos, posIdx) => {
                                                if (!pos.player) return null;
                                                const playerTeam = TEAMS.find(t => t.id === pos.player.teamId);
                                                return (
                                                    <div key={posIdx} style={{
                                                        padding: '1rem',
                                                        background: 'rgba(59, 130, 246, 0.1)',
                                                        borderRadius: '0.5rem',
                                                        border: '1px solid rgba(59, 130, 246, 0.3)',
                                                        cursor: 'pointer'
                                                    }}
                                                    onClick={() => {
                                                        setSelectedPlayerProfile(enrichPlayerWithCareerStats(pos.player));
                                                        setCurrentView('playerProfile');
                                                    }}>
                                                        <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                            {pos.label}
                                                        </div>
                                                        <div style={{ color: '#fff', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                            {pos.player.firstName} {pos.player.lastName}
                                                        </div>
                                                        <div style={{ color: '#64748b', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                            {playerTeam?.abbreviation || playerTeam?.city}
                                                        </div>
                                                        <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                            {pos.player.position === 'G' ? (
                                                                <>{pos.player.stats?.wins}W | {pos.player.stats.savePercentage.toFixed(3)} SV%</>
                                                            ) : (
                                                                <>{pos.player.stats.points}PTS ({pos.player.stats.goals}G-{pos.player.stats.assists}A)</>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* DIVISION AWARDS */}
                        {['Atlantic', 'Metropolitan', 'Central', 'Pacific'].map((division, divIdx) => {
                            const divAwards = seasonAwards.divisions[division];
                            const divAllStars = seasonAwards.allStars.divisions[division];
                            
                            return (
                                <div key={divIdx} className="card">
                                    <h2 style={{ color: '#8b5cf6', marginBottom: '1.5rem' }}>
                                        üèí {division} Division Awards
                                    </h2>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '1.5rem', marginBottom: '2rem' }}>
                                        {[
                                            { title: 'Division MVP', player: divAwards.mvp, icon: 'üëë' },
                                            { title: 'Best Goaltender', player: divAwards.bestGoalie, icon: 'ü•Ö' },
                                            { title: 'Best Defenseman', player: divAwards.bestDefenseman, icon: 'üõ°Ô∏è' },
                                            { title: 'Rookie of the Year', player: divAwards.rookieOfYear, icon: '‚≠ê' },
                                            { title: 'Top Scorer', player: divAwards.topScorer, icon: 'üéØ' }
                                        ].map((award, awardIdx) => {
                                            if (!award.player) return null;
                                            const team = TEAMS.find(t => t.id === award.player.teamId);
                                            return (
                                                <div key={awardIdx} style={{
                                                    padding: '1rem',
                                                    background: 'rgba(139, 92, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    border: '1px solid rgba(139, 92, 246, 0.3)',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => {
                                                    setSelectedPlayerProfile(enrichPlayerWithCareerStats(award.player));
                                                    setCurrentView('playerProfile');
                                                }}>
                                                    <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>{award.icon}</div>
                                                    <h4 style={{ color: '#a78bfa', marginBottom: '0.5rem', fontSize: '0.95rem' }}>
                                                        {award.title}
                                                    </h4>
                                                    <div style={{ color: '#fff', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                        {award.player.firstName} {award.player.lastName}
                                                    </div>
                                                    <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.5rem' }}>
                                                        {team?.city} {team?.name}
                                                    </div>
                                                    <div style={{ color: '#e2e8f0', fontSize: '0.85rem' }}>
                                                        {award.player.position === 'G' ? (
                                                            <>{award.player.stats.savePercentage.toFixed(3)} SV% | {award.player.stats.gaa.toFixed(2)} GAA</>
                                                        ) : (
                                                            <>{award.player.stats.points}PTS ({award.player.stats.goals}G-{award.player.stats.assists}A)</>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    <h3 style={{ color: '#a78bfa', marginBottom: '1rem', marginTop: '1rem' }}>
                                        Division All-Stars
                                    </h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                        {[
                                            { label: 'G', player: divAllStars.goalie },
                                            { label: 'LD', player: divAllStars.leftDefense },
                                            { label: 'RD', player: divAllStars.rightDefense },
                                            { label: 'C', player: divAllStars.center },
                                            { label: 'LW', player: divAllStars.leftWing },
                                            { label: 'RW', player: divAllStars.rightWing }
                                        ].map((pos, posIdx) => {
                                            if (!pos.player) return null;
                                            const playerTeam = TEAMS.find(t => t.id === pos.player.teamId);
                                            return (
                                                <div key={posIdx} style={{
                                                    padding: '0.75rem',
                                                    background: 'rgba(139, 92, 246, 0.05)',
                                                    borderRadius: '0.375rem',
                                                    border: '1px solid rgba(139, 92, 246, 0.2)',
                                                    cursor: 'pointer'
                                                }}
                                                onClick={() => {
                                                    setSelectedPlayerProfile(enrichPlayerWithCareerStats(pos.player));
                                                    setCurrentView('playerProfile');
                                                }}>
                                                    <div style={{ color: '#a78bfa', fontSize: '0.75rem', marginBottom: '0.25rem', fontWeight: 'bold' }}>
                                                        {pos.label}
                                                    </div>
                                                    <div style={{ color: '#fff', fontSize: '0.9rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                                        {pos.player.firstName.charAt(0)}. {pos.player.lastName}
                                                    </div>
                                                    <div style={{ color: '#64748b', fontSize: '0.75rem' }}>
                                                        {playerTeam?.abbreviation}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )}

                {/* HELP & USER MANUAL VIEW */}
                {currentView === 'support' && (
                    <div className="card">
                        <h1 style={{ color: '#FF5E5B', marginBottom: '1rem', fontSize: '2.5rem' }}>
                            ‚òï Support Hockey GM Development
                        </h1>
                        <p style={{ color: '#93c5fd', fontSize: '1.1rem', marginBottom: '2rem' }}>
                            Help keep this project free and actively developed
                        </p>

                        {/* Why Support */}
                        <div className="card" style={{ background: 'rgba(255, 94, 91, 0.1)', border: '2px solid #FF5E5B', marginBottom: '2rem' }}>
                            <h2 style={{ color: '#FF5E5B' }}>üéÆ About This Project</h2>
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8', marginTop: '1rem' }}>
                                Hockey GM Simulator is a <strong>completely free</strong>, browser-based hockey management game. 
                                No ads, no paywalls, no account required. Built by a solo developer who loves hockey and simulation games.
                            </p>
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8', marginTop: '1rem' }}>
                                This project takes hundreds of hours to develop and maintain. Features like realistic AI trading, 
                                advanced statistics, playoff simulations, and detailed player tracking all require significant time 
                                and effort to implement.
                            </p>
                        </div>

                        {/* What Your Support Does */}
                        <div className="card" style={{ background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e', marginBottom: '2rem' }}>
                            <h2 style={{ color: '#22c55e' }}>üíö Where Your Support Goes</h2>
                            <ul style={{ color: '#e2e8f0', lineHeight: '2', marginTop: '1rem' }}>
                                <li><strong>Development Time:</strong> More features, better AI, improved gameplay</li>
                                <li><strong>Server Costs:</strong> Hosting and infrastructure (if multiplayer added)</li>
                                <li><strong>Bug Fixes:</strong> Faster response to issues and improvements</li>
                                <li><strong>New Features:</strong> Player draft system, contract negotiations, more leagues</li>
                                <li><strong>Motivation:</strong> Knowing people value the work keeps development going!</li>
                            </ul>
                        </div>

                        {/* Upcoming Features */}
                        <div className="card" style={{ background: 'rgba(59, 130, 246, 0.1)', border: '2px solid #3b82f6', marginBottom: '2rem' }}>
                            <h2 style={{ color: '#60a5fa' }}>üöÄ Planned Features</h2>
                            <p style={{ color: '#93c5fd', marginTop: '1rem' }}>
                                Your support helps prioritize these features:
                            </p>
                            <ul style={{ color: '#e2e8f0', lineHeight: '2', marginTop: '1rem' }}>
                                <li>üéØ <strong>Entry Draft System:</strong> Scout and draft prospects</li>
                                <li>üí∞ <strong>Salary Cap Management:</strong> Contract negotiations and cap strategy</li>
                                <li>üìä <strong>Historical Stats:</strong> Track records across multiple seasons</li>
                                <li>üèÜ <strong>Franchise Mode:</strong> Build a dynasty over decades</li>
                                <li>üåê <strong>More Leagues:</strong> European leagues, international play</li>
                                <li>üë• <strong>Multiplayer:</strong> Compete against other GMs online</li>
                            </ul>
                        </div>

                        {/* Support Options */}
                        <div className="card" style={{ background: 'rgba(251, 191, 36, 0.1)', border: '2px solid #fbbf24', marginBottom: '2rem' }}>
                            <h2 style={{ color: '#fbbf24' }}>‚òï Support Options</h2>
                            
                            <div style={{ marginTop: '2rem' }}>
                                <h3 style={{ color: '#93c5fd', marginBottom: '1rem' }}>One-Time Support</h3>
                                <p style={{ color: '#e2e8f0', marginBottom: '1.5rem' }}>
                                    Buy me a coffee to say thanks! Even $3-5 helps cover server costs and motivates development.
                                </p>
                                <a
                                    href="https://ko-fi.com/masacuna"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    style={{
                                        display: 'inline-block',
                                        padding: '1rem 2rem',
                                        background: '#FF5E5B',
                                        color: '#fff',
                                        borderRadius: '0.5rem',
                                        fontWeight: 'bold',
                                        textDecoration: 'none',
                                        fontSize: '1.1rem',
                                        boxShadow: '0 4px 12px rgba(255, 94, 91, 0.4)',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseOver={(e) => {
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(255, 94, 91, 0.5)';
                                    }}
                                    onMouseOut={(e) => {
                                        e.currentTarget.style.transform = 'translateY(0)';
                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(255, 94, 91, 0.4)';
                                    }}
                                >
                                    ‚òï Support on Ko-fi
                                </a>
                            </div>

                            <div style={{ marginTop: '2rem', paddingTop: '2rem', borderTop: '1px solid rgba(148, 163, 184, 0.2)' }}>
                                <h3 style={{ color: '#93c5fd', marginBottom: '1rem' }}>Share the Game</h3>
                                <p style={{ color: '#e2e8f0' }}>
                                    Can't donate? No problem! Sharing the game with other hockey fans helps just as much. 
                                    Tell your friends, post on Reddit, or share on social media.
                                </p>
                            </div>
                        </div>

                        {/* Thank You */}
                        <div style={{ 
                            textAlign: 'center', 
                            padding: '2rem', 
                            background: 'rgba(34, 197, 94, 0.1)', 
                            borderRadius: '0.5rem',
                            border: '1px solid rgba(34, 197, 94, 0.3)'
                        }}>
                            <h3 style={{ color: '#22c55e', fontSize: '1.5rem', marginBottom: '1rem' }}>
                                üôè Thank You!
                            </h3>
                            <p style={{ color: '#e2e8f0', fontSize: '1.1rem' }}>
                                Whether you support financially or just by playing the game, 
                                I truly appreciate you being part of this project.
                            </p>
                            <p style={{ color: '#93c5fd', marginTop: '1rem', fontStyle: 'italic' }}>
                                - The Developer
                            </p>
                        </div>
                    </div>
                )}

                {currentView === 'help' && (
                    <div>
                        {/* HEADER */}
                        <div className="card" style={{ 
                            background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2))',
                            border: '3px solid #3b82f6',
                            textAlign: 'center'
                        }}>
                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìñ</div>
                            <h1 style={{ color: '#60a5fa', marginBottom: '0.5rem', fontSize: '2.5rem' }}>
                                Hockey GM - User Manual
                            </h1>
                            <p style={{ color: '#93c5fd', fontSize: '1.1rem', marginBottom: '1rem' }}>
                                Your complete guide to managing a professional hockey franchise
                            </p>
                            <p style={{ color: '#e2e8f0', fontSize: '0.95rem' }}>
                                Last Updated: January 3, 2026 | Version 1.0 Beta
                            </p>
                        </div>

                        {/* QUICK START - NEW! */}
                        <div className="card" style={{ background: 'rgba(245, 158, 11, 0.1)', border: '3px solid #f59e0b', marginTop: '2rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1.5rem' }}>
                                <div style={{ fontSize: '2.5rem' }}>‚ö°</div>
                                <h2 style={{ color: '#fbbf24', margin: 0 }}>Quick Start (5 Minutes)</h2>
                            </div>
                            
                            <div style={{ 
                                background: 'rgba(0, 0, 0, 0.3)', 
                                padding: '1.5rem', 
                                borderRadius: '0.75rem',
                                marginBottom: '1.5rem'
                            }}>
                                <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>Your First 5 Steps:</h3>
                                <ol style={{ lineHeight: '2.5', color: '#e2e8f0', fontSize: '1.05rem' }}>
                                    <li><strong style={{ color: '#fbbf24' }}>Pick a Team</strong> - Choose your favorite from 32 teams</li>
                                    <li><strong style={{ color: '#fbbf24' }}>Visit Team Hub</strong> - Your main command center (Roster Management ‚Üí Team Hub)</li>
                                    <li><strong style={{ color: '#fbbf24' }}>Set Your Lines</strong> - Use "Adjust Lines" button or go to Lines & Scratches</li>
                                    <li><strong style={{ color: '#fbbf24' }}>Start Simulating</strong> - Click "Simulate Next Game" ‚Üí Watch game results</li>
                                    <li><strong style={{ color: '#fbbf24' }}>Review Results</strong> - Recent games shown on Team Hub, or check Schedule for all games</li>
                                </ol>
                            </div>
                            
                            <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                gap: '1rem'
                            }}>
                                <div style={{ padding: '1rem', background: 'rgba(59, 130, 246, 0.2)', borderRadius: '0.5rem' }}>
                                    <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>üéØ</div>
                                    <div style={{ color: '#60a5fa', fontWeight: 'bold', marginBottom: '0.25rem' }}>Pro Tip</div>
                                    <div style={{ color: '#e2e8f0', fontSize: '0.9rem' }}>Use Auto-Set Lines to start. Customize later once you know your players.</div>
                                </div>
                                <div style={{ padding: '1rem', background: 'rgba(34, 197, 94, 0.2)', borderRadius: '0.5rem' }}>
                                    <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>üíæ</div>
                                    <div style={{ color: '#22c55e', fontWeight: 'bold', marginBottom: '0.25rem' }}>Auto-Save</div>
                                    <div style={{ color: '#e2e8f0', fontSize: '0.9rem' }}>Game saves automatically after each day. No need to worry!</div>
                                </div>
                                <div style={{ padding: '1rem', background: 'rgba(139, 92, 246, 0.2)', borderRadius: '0.5rem' }}>
                                    <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>üè•</div>
                                    <div style={{ color: '#a78bfa', fontWeight: 'bold', marginBottom: '0.25rem' }}>Injuries Happen</div>
                                    <div style={{ color: '#e2e8f0', fontSize: '0.9rem' }}>Farm players auto-called up. Check "Roster Management" ‚Üí "Injuries"</div>
                                </div>
                            </div>
                        </div>

                        {/* NAVIGATION GUIDE - NEW! */}
                        <div className="card" style={{ marginTop: '2rem' }}>
                            <h2 style={{ color: '#60a5fa', marginBottom: '1.5rem' }}>üó∫Ô∏è Navigation Guide</h2>
                            <p style={{ color: '#93c5fd', marginBottom: '1.5rem' }}>
                                Find what you need quickly with this menu breakdown:
                            </p>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '1rem' }}>
                                <div style={{ padding: '1.5rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '0.75rem', border: '2px solid #3b82f6' }}>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.75rem' }}>üìä Stats</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8', fontSize: '0.95rem', margin: 0 }}>
                                        <li>Player Stats - Individual performance</li>
                                        <li>Team Stats - Your team's numbers</li>
                                        <li>League Leaders - Top performers</li>
                                    </ul>
                                </div>
                                
                                <div style={{ padding: '1.5rem', background: 'rgba(34, 197, 94, 0.1)', borderRadius: '0.75rem', border: '2px solid #22c55e' }}>
                                    <h3 style={{ color: '#22c55e', marginBottom: '0.75rem' }}>üë• Roster Management</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8', fontSize: '0.95rem', margin: 0 }}>
                                        <li>Team Hub - Your command center üè†</li>
                                        <li>Roster - View all players</li>
                                        <li>Lines & Scratches - Configure lineup</li>
                                        <li>Call-Ups/Send-Downs - Farm moves</li>
                                        <li>Injuries - Manage hurt players</li>
                                        <li>Trades - Make deals</li>
                                    </ul>
                                </div>
                                
                                <div style={{ padding: '1.5rem', background: 'rgba(251, 191, 36, 0.1)', borderRadius: '0.75rem', border: '2px solid #fbbf24' }}>
                                    <h3 style={{ color: '#fbbf24', marginBottom: '0.75rem' }}>üìÖ Season</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8', fontSize: '0.95rem', margin: 0 }}>
                                        <li>Standings - Division/Conference ranks</li>
                                        <li>Awards - Season honors</li>
                                    </ul>
                                </div>
                                
                                <div style={{ padding: '1.5rem', background: 'rgba(139, 92, 246, 0.1)', borderRadius: '0.75rem', border: '2px solid #8b5cf6' }}>
                                    <h3 style={{ color: '#a78bfa', marginBottom: '0.75rem' }}>üåê League</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8', fontSize: '0.95rem', margin: 0 }}>
                                        <li>Schedule - All 82 game days</li>
                                        <li>Key Dates - Important events</li>
                                        <li>Transactions - All trades</li>
                                        <li>Draft Lottery - Offseason event</li>
                                        <li>Entry Draft - 7 rounds, 224 picks</li>
                                    </ul>
                                </div>
                                
                                <div style={{ padding: '1.5rem', background: 'rgba(239, 68, 68, 0.1)', borderRadius: '0.75rem', border: '2px solid #ef4444' }}>
                                    <h3 style={{ color: '#ef4444', marginBottom: '0.75rem' }}>üèÜ Playoffs</h3>
                                    <ul style={{ color: '#e2e8f0', lineHeight: '1.8', fontSize: '0.95rem', margin: 0 }}>
                                        <li>Bracket - Tournament view</li>
                                        <li>Series - Round-by-round</li>
                                        <li>Stats - Playoff leaders</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        {/* FAQ - NEW! */}
                        <div className="card" style={{ marginTop: '2rem', background: 'rgba(34, 197, 94, 0.05)', border: '2px solid #22c55e' }}>
                            <h2 style={{ color: '#22c55e', marginBottom: '1.5rem' }}>‚ùì Frequently Asked Questions</h2>
                            
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                                <div>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Q: How do I make trades?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', marginLeft: '1rem' }}>
                                        Go to <strong>Roster Management ‚Üí Trades</strong>. Select a team, pick players to trade, and propose. 
                                        The AI evaluates based on player value, age, team needs, and salary cap. Trades must be balanced and beneficial to both teams.
                                    </p>
                                </div>
                                
                                <div>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Q: Why can't I trade certain players?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', marginLeft: '1rem' }}>
                                        Injured players cannot be traded. Also, trades after Day 56 (trade deadline) are not allowed.
                                    </p>
                                </div>
                                
                                <div>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Q: What happens when a player gets injured?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', marginLeft: '1rem' }}>
                                        If you have healthy scratches, they replace the injured player automatically. If not, the best farm team player is called up. 
                                        When the injured player heals, the call-up returns to the farm team automatically.
                                    </p>
                                </div>
                                
                                <div>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Q: How do I know if I'm good enough for playoffs?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', marginLeft: '1rem' }}>
                                        Top 8 teams per conference make playoffs. Check <strong>Season ‚Üí Standings</strong> and look for the green "Playoff Spot" indicator. 
                                        The wildcard cutoff line shows you exactly where you need to be.
                                    </p>
                                </div>
                                
                                <div>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Q: Can I undo a simulation?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', marginLeft: '1rem' }}>
                                        No, simulations are permanent. However, you can reload your last manual save from <strong>Settings ‚Üí Load Game</strong> if you saved before simulating.
                                    </p>
                                </div>
                                
                                <div>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Q: What's the difference between NAHL and NAMHL?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', marginLeft: '1rem' }}>
                                        <strong>NAHL</strong> is your main roster (23 players who play in games). <strong>NAMHL</strong> is your farm team (23 minor league players). 
                                        You can call up farm players to replace injured/underperforming NAHL players.
                                    </p>
                                </div>
                                
                                <div>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '0.5rem' }}>Q: How does the Draft Lottery work?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', marginLeft: '1rem' }}>
                                        After playoffs, the 16 non-playoff teams enter a lottery. Worse teams have better odds. The lottery determines picks 1-5, 
                                        while picks 6-16 go in reverse order of standings. Click <strong>League ‚Üí Draft Lottery</strong> after the season ends.
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* GETTING STARTED */}
                        <div className="card" style={{ background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e', marginTop: '2rem' }}>
                            <h2 style={{ color: '#22c55e' }}>üöÄ Getting Started (Detailed)</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Creating Your Game</h3>
                            <ol style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Select Your Team:</strong> Choose from 32 professional hockey teams on the main menu</li>
                                <li><strong>Your Roster:</strong> Each team starts with 23 NAHL players (13F + 7D + 3G)</li>
                                <li><strong>Farm Team:</strong> You also control 23 NAMHL farm team players for development</li>
                                <li><strong>Season Length:</strong> 82-game regular season + playoffs</li>
                            </ol>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Navigation</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Stats:</strong> Player stats, team stats, league leaders</li>
                                <li><strong>Roster Management:</strong> Control your lineup, lines, trades, injuries</li>
                                <li><strong>Season:</strong> Standings, calendar, awards, playoffs</li>
                                <li><strong>Settings:</strong> Save game, roadmap, help, support development</li>
                            </ul>
                        </div>

                        {/* SIMULATION */}
                        <div className="card" style={{ background: 'rgba(59, 130, 246, 0.1)', border: '2px solid #3b82f6', marginTop: '2rem' }}>
                            <h2 style={{ color: '#60a5fa' }}>‚ö° Simulation Controls</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Sim Day</h3>
                            <p style={{ color: '#e2e8f0' }}>
                                Simulates one day of the schedule. Multiple games happen per day, up to 16 games maximum.
                                This gives you fine control to check results frequently.
                            </p>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>‚ö° Sim Season</h3>
                            <p style={{ color: '#e2e8f0' }}>
                                Simulates the entire 82-game regular season at once. Fast way to complete a season.
                                All stats, injuries, and awards are calculated automatically.
                            </p>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Auto-Save</h3>
                            <p style={{ color: '#e2e8f0' }}>
                                Your game auto-saves after each day. You can also manually save via Settings ‚Üí üíæ Save Game.
                                Saves are stored in your browser's local storage.
                            </p>
                        </div>

                        {/* ROSTER MANAGEMENT */}
                        <div className="card" style={{ background: 'rgba(251, 191, 36, 0.1)', border: '2px solid #fbbf24', marginTop: '2rem' }}>
                            <h2 style={{ color: '#fbbf24' }}>üë• Roster Management</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Roster (23 Players)</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>13 Forwards:</strong> Make up 4 lines</li>
                                <li><strong>7 Defensemen:</strong> Make up 3 pairs</li>
                                <li><strong>3 Goalies:</strong> Starter, backup, emergency</li>
                                <li><strong>Team Overall:</strong> Shows your team's strength and league rank</li>
                                <li><strong>Color Coding:</strong> Green (Top 5), Blue (Top 10), Yellow (Middle), Red (Bottom)</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Lines & Scratches</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Forward Lines:</strong> Assign 12 forwards to Lines 1-4 (3 per line: C, LW, RW)</li>
                                <li><strong>Defense Pairs:</strong> Assign 6 defensemen to Pairs 1-3 (2 per pair: LD, RD)</li>
                                <li><strong>Goalies:</strong> Dress 2 goalies (starter & backup)</li>
                                <li><strong>Scratches:</strong> 3 players (1F, 1D, 1G) are healthy scratches each game</li>
                                <li><strong>Auto-Set:</strong> Click "Auto-Set All Lines" to optimize by OVR</li>
                                <li><strong>Out of Position:</strong> Players lose 3 OVR when playing wrong position</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Special Teams</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Power Play:</strong> 2 units with 5 players each (4F+1D typical)</li>
                                <li><strong>Penalty Kill:</strong> 2 units with 4 players each (2F+2D typical)</li>
                                <li><strong>Impact:</strong> PP/PK specialists get bonus weight in Team Overall rating</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>üîÑ Call-Ups & Send-Downs</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Call Up:</strong> Bring prospects from NAMHL farm team to NAHL</li>
                                <li><strong>Send Down:</strong> Demote NAHL players to farm (can't send injured players)</li>
                                <li><strong>Auto Call-Up:</strong> When NAHL player is injured and no scratches available, best farm player is called up automatically</li>
                                <li><strong>Auto Return:</strong> When injured player heals, farm call-up returns automatically</li>
                            </ul>
                        </div>

                        {/* INJURIES */}
                        <div className="card" style={{ background: 'rgba(239, 68, 68, 0.1)', border: '2px solid #ef4444', marginTop: '2rem' }}>
                            <h2 style={{ color: '#f87171' }}>üè• Injury System</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>How Injuries Work</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Injury Rate:</strong> ~0.8% per game (realistic rates - expect 18-22 injuries/season)</li>
                                <li><strong>Position Impact:</strong> Forwards get injured most, goalies least</li>
                                <li><strong>Age Impact:</strong> Older players (32+) more injury-prone</li>
                                <li><strong>Ice Time:</strong> More TOI = higher injury risk</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Injury Types</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Day-to-Day (DTD):</strong> 1-14 days - back quickly (42% of injuries)</li>
                                <li><strong>Week-to-Week:</strong> 1-14 days - short absence (28% of injuries)</li>
                                <li><strong>Month-to-Month (IR):</strong> 15-60 days - medium term (25% of injuries)</li>
                                <li><strong>Season-Ending:</strong> Rest of season (4.5% of injuries - rare)</li>
                                <li><strong>Career-Ending:</strong> Player retires (0.5% of injuries - very rare)</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Managing Injuries</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li>Check Roster Management ‚Üí Injuries to see all injured players</li>
                                <li>Injured players keep their lineup spot but don't play</li>
                                <li>Replacements (scratches or farm call-ups) fill in temporarily</li>
                                <li>When healed, injured player returns to their original spot</li>
                            </ul>
                        </div>

                        {/* STATS & TRACKING */}
                        <div className="card" style={{ background: 'rgba(168, 85, 247, 0.1)', border: '2px solid #a855f7', marginTop: '2rem' }}>
                            <h2 style={{ color: '#c084fc' }}>üìä Stats & Tracking</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Player Stats</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Basic Stats:</strong> Goals, Assists, Points, +/-, PIM, SOG, TOI</li>
                                <li><strong>Advanced Stats:</strong> Toggle to view Corsi, Fenwick, Hits, Blocks, Faceoffs</li>
                                <li><strong>Regular Season:</strong> Full stats for 82-game season</li>
                                <li><strong>Playoffs:</strong> Separate playoff stats tracked</li>
                                <li><strong>Per-Game Details:</strong> View individual game performances with period-by-period breakdowns</li>
                                <li><strong>Tooltips:</strong> Hover over any stat column header to see what it means</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Advanced Stats Explained</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>CF% (Corsi For %):</strong> Possession metric - above 50% is good</li>
                                <li><strong>FF% (Fenwick For %):</strong> Quality possession - above 50% is good</li>
                                <li><strong>Hits:</strong> Physical body checks delivered</li>
                                <li><strong>Blk (Blocked Shots):</strong> Shots blocked while defending</li>
                                <li><strong>TK (Takeaways):</strong> Pucks stolen from opponent</li>
                                <li><strong>GV (Giveaways):</strong> Turnovers to opponent</li>
                                <li><strong>FO% (Faceoff %):</strong> Centers only - above 50% is good</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Team Stats</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Goals For/Against:</strong> Per game averages</li>
                                <li><strong>Shots:</strong> Shots for and shots against per game</li>
                                <li><strong>Power Play %:</strong> Success rate (20%+ is excellent)</li>
                                <li><strong>Penalty Kill %:</strong> Success rate (82%+ is excellent)</li>
                                <li><strong>Shooting %:</strong> Goals per 100 shots</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>League Leaders</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Skater Stats:</strong> Points, goals, assists, +/-, PIM, shots</li>
                                <li><strong>Goalie Stats:</strong> Wins, save %, GAA, shutouts</li>
                                <li><strong>Minimum Games:</strong> 27 GP for goalies (save % & GAA)</li>
                                <li><strong>Click Names:</strong> Click any player to view their full profile</li>
                            </ul>
                        </div>

                        {/* AWARDS & ACHIEVEMENTS */}
                        <div className="card" style={{ background: 'rgba(245, 158, 11, 0.1)', border: '2px solid #f59e0b', marginTop: '2rem' }}>
                            <h2 style={{ color: '#fbbf24' }}>üèÜ Awards & Achievements</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Season Awards (71 Total)</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Hart Trophy:</strong> League MVP</li>
                                <li><strong>Vezina Trophy:</strong> Best Goaltender</li>
                                <li><strong>Norris Trophy:</strong> Best Defenseman</li>
                                <li><strong>Calder Trophy:</strong> Rookie of the Year</li>
                                <li><strong>Art Ross Trophy:</strong> Points Leader</li>
                                <li><strong>Maurice Richard Trophy:</strong> Goals Leader</li>
                                <li><strong>Division Awards:</strong> MVP, rookie, goalie for each division</li>
                                <li><strong>All-Star Teams:</strong> First, Second, Third teams + divisional all-stars</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Playoff Awards</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Stanley Cup:</strong> Playoff champion</li>
                                <li><strong>Conn Smythe (Playoff MVP):</strong> Best player in playoffs</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Player Achievements</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Awards:</strong> Trophy wins appear in player profile</li>
                                <li><strong>All-Star Selections:</strong> 40 players per season (20 per conference)</li>
                                <li><strong>League Leaders:</strong> Leading any stat category</li>
                                <li><strong>Milestones:</strong> 500 goals, 1000 points, etc.</li>
                                <li><strong>View in Profile:</strong> Click player name ‚Üí see achievements section</li>
                            </ul>
                        </div>

                        {/* PLAYOFFS */}
                        <div className="card" style={{ background: 'rgba(234, 179, 8, 0.1)', border: '2px solid #eab308', marginTop: '2rem' }}>
                            <h2 style={{ color: '#facc15' }}>üèÜ Playoffs</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Playoff Format</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>16 Teams:</strong> Top 8 from each conference qualify</li>
                                <li><strong>Best-of-7 Series:</strong> First to 4 wins advances</li>
                                <li><strong>4 Rounds:</strong> First Round ‚Üí Second Round ‚Üí Conference Finals ‚Üí Stanley Cup Finals</li>
                                <li><strong>Bracket View:</strong> See full tournament tree with all matchups</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Simulation</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Sim Day:</strong> Play one playoff day at a time</li>
                                <li><strong>Conference Alternation:</strong> East and West games alternate days</li>
                                <li><strong>Series Progress:</strong> Track wins needed in bracket</li>
                                <li><strong>Separate Stats:</strong> Playoff stats tracked separately from regular season</li>
                            </ul>
                        </div>

                        {/* TIPS & STRATEGIES */}
                        <div className="card" style={{ background: 'rgba(34, 211, 238, 0.1)', border: '2px solid #22d3ee', marginTop: '2rem' }}>
                            <h2 style={{ color: '#22d3ee' }}>üí° Tips & Strategies</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Building a Winner</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Balance Depth:</strong> Deep teams handle injuries better than top-heavy teams</li>
                                <li><strong>Line Chemistry:</strong> Put your best players on Line 1, they get most ice time</li>
                                <li><strong>Special Teams:</strong> Good PP/PK units can swing games</li>
                                <li><strong>Goaltending:</strong> Elite goalie (88+ OVR) can carry a team</li>
                                <li><strong>Youth & Development:</strong> Young players with high potential grow over time</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Smart Roster Moves</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Call Up Prospects:</strong> Give young players NHL experience to develop faster</li>
                                <li><strong>Manage Ice Time:</strong> Rest veterans on Line 4 to reduce injury risk</li>
                                <li><strong>Platoon Goalies:</strong> Use backup 20-25 games to keep starter fresh</li>
                                <li><strong>In-Position Play:</strong> Avoid -3 OVR penalty by playing natural positions</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Reading the Stats</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>+/- Matters:</strong> High +/- means player is on ice for goals for > against</li>
                                <li><strong>TOI = Value:</strong> Players with high TOI are trusted by "coach"</li>
                                <li><strong>Shots = Chances:</strong> High shots usually means offensive zone time</li>
                                <li><strong>PIM:</strong> Some penalty minutes are fine, too many hurt team</li>
                            </ul>
                        </div>

                        {/* SUPPORT THE PROJECT */}
                        <div className="card" style={{ background: 'rgba(255, 94, 91, 0.1)', border: '2px solid #FF5E5B', marginTop: '2rem' }}>
                            <h2 style={{ color: '#FF5E5B' }}>‚òï Support This Project</h2>
                            
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8', marginTop: '1rem' }}>
                                Hockey GM Simulator is completely <strong>free</strong> with no ads, no paywalls, and no account required. 
                                It takes hundreds of hours to develop and maintain features like realistic AI trading, advanced statistics, 
                                and playoff simulations.
                            </p>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>How to Support</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>‚òï Donate:</strong> Settings ‚Üí Support Development or click the floating Support button</li>
                                <li><strong>üì¢ Share:</strong> Tell your friends, post on Reddit, share on social media</li>
                                <li><strong>üí¨ Feedback:</strong> Report bugs and suggest features to help improve the game</li>
                                <li><strong>‚≠ê Star:</strong> If this is on GitHub, star the repository</li>
                            </ul>

                            <p style={{ color: '#93c5fd', fontStyle: 'italic', marginTop: '1.5rem' }}>
                                Thank you for playing! Your support helps keep this project free and actively developed. üèí
                            </p>
                        </div>

                        {/* TECHNICAL INFO */}
                        <div className="card" style={{ background: 'rgba(100, 116, 139, 0.2)', border: '2px solid #64748b', marginTop: '2rem' }}>
                            <h2 style={{ color: '#cbd5e1' }}>‚öôÔ∏è Technical Information</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Save System</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Auto-Save:</strong> Game saves after every day simulated</li>
                                <li><strong>Local Storage:</strong> Saves stored in browser (not server)</li>
                                <li><strong>One Save Slot:</strong> Only one game can be saved at a time</li>
                                <li><strong>Delete Save:</strong> Settings ‚Üí üóëÔ∏è Delete Save to start fresh</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Performance</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Optimized Simulation:</strong> Fast season sim with memoization</li>
                                <li><strong>O(1) Lookups:</strong> Team and player data uses hash maps</li>
                                <li><strong>No Console Spam:</strong> Debug logging removed for production</li>
                            </ul>

                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Browser Compatibility</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Modern Browsers:</strong> Chrome, Firefox, Safari, Edge (latest versions)</li>
                                <li><strong>Local Storage Required:</strong> Must allow browser storage for saves</li>
                                <li><strong>JavaScript Required:</strong> Game runs entirely client-side</li>
                            </ul>
                        </div>

                        {/* COMMON TASKS - NEW! */}
                        <div className="card" style={{ background: 'rgba(139, 92, 246, 0.1)', border: '2px solid #8b5cf6', marginTop: '2rem' }}>
                            <h2 style={{ color: '#a78bfa', marginBottom: '1.5rem' }}>‚ö° Common Tasks - Quick Reference</h2>
                            
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '1rem' }}>
                                <div style={{ padding: '1.25rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.1rem', marginBottom: '0.75rem' }}>üìã Change Your Lines</h3>
                                    <ol style={{ color: '#e2e8f0', lineHeight: '1.8', margin: 0, paddingLeft: '1.25rem' }}>
                                        <li>Click <strong>Roster Management</strong></li>
                                        <li>Select <strong>Set Lines</strong></li>
                                        <li>Click <strong>Auto-Set All Lines</strong> OR drag players manually</li>
                                        <li>Changes apply immediately</li>
                                    </ol>
                                </div>
                                
                                <div style={{ padding: '1.25rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.1rem', marginBottom: '0.75rem' }}>üîÑ Call Up a Farm Player</h3>
                                    <ol style={{ color: '#e2e8f0', lineHeight: '1.8', margin: 0, paddingLeft: '1.25rem' }}>
                                        <li>Click <strong>Roster Management ‚Üí Farm Team</strong></li>
                                        <li>Click <strong>‚¨ÜÔ∏è Call Up</strong> next to desired player</li>
                                        <li>They join your NAHL roster</li>
                                        <li>Update lines to use them in games</li>
                                    </ol>
                                </div>
                                
                                <div style={{ padding: '1.25rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.1rem', marginBottom: '0.75rem' }}>ü§ù Make a Trade</h3>
                                    <ol style={{ color: '#e2e8f0', lineHeight: '1.8', margin: 0, paddingLeft: '1.25rem' }}>
                                        <li>Click <strong>Roster Management ‚Üí Trades</strong></li>
                                        <li>Select a team from the dropdown</li>
                                        <li>Pick players to trade (both sides)</li>
                                        <li>Click <strong>Propose Trade</strong></li>
                                        <li>See evaluation breakdown</li>
                                    </ol>
                                </div>
                                
                                <div style={{ padding: '1.25rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.1rem', marginBottom: '0.75rem' }}>üìä Check Game Results</h3>
                                    <ol style={{ color: '#e2e8f0', lineHeight: '1.8', margin: 0, paddingLeft: '1.25rem' }}>
                                        <li>Click <strong>Season ‚Üí Calendar</strong></li>
                                        <li>Click any completed game</li>
                                        <li>See full box score with stats</li>
                                        <li>View period-by-period scoring</li>
                                    </ol>
                                </div>
                                
                                <div style={{ padding: '1.25rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.1rem', marginBottom: '0.75rem' }}>üíæ Save Your Game</h3>
                                    <ol style={{ color: '#e2e8f0', lineHeight: '1.8', margin: 0, paddingLeft: '1.25rem' }}>
                                        <li>Game auto-saves after each day</li>
                                        <li>OR click <strong>Settings ‚Üí üíæ Save Game</strong></li>
                                        <li>To load: <strong>Settings ‚Üí üìÇ Load Game</strong></li>
                                        <li>One save slot (overwrites previous)</li>
                                    </ol>
                                </div>
                                
                                <div style={{ padding: '1.25rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.1rem', marginBottom: '0.75rem' }}>üèÜ View Playoff Bracket</h3>
                                    <ol style={{ color: '#e2e8f0', lineHeight: '1.8', margin: 0, paddingLeft: '1.25rem' }}>
                                        <li>Click <strong>üèÜ Playoffs ‚Üí Bracket</strong></li>
                                        <li>See full tournament tree</li>
                                        <li>Click any series for game details</li>
                                        <li>Track your team's playoff run</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        {/* TROUBLESHOOTING - NEW! */}
                        <div className="card" style={{ background: 'rgba(239, 68, 68, 0.1)', border: '2px solid #ef4444', marginTop: '2rem' }}>
                            <h2 style={{ color: '#ef4444', marginBottom: '1.5rem' }}>üîß Troubleshooting</h2>
                            
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.25rem' }}>
                                <div style={{ padding: '1rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem', borderLeft: '4px solid #f59e0b' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.05rem', marginBottom: '0.5rem' }}>‚ö†Ô∏è "Trade would put team over salary cap"</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', margin: 0 }}>
                                        <strong>Solution:</strong> The team you're trading with doesn't have enough cap space for the players you're sending. 
                                        Try trading for a more expensive player from them, or include fewer/cheaper players in your offer.
                                    </p>
                                </div>
                                
                                <div style={{ padding: '1rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem', borderLeft: '4px solid #f59e0b' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.05rem', marginBottom: '0.5rem' }}>‚ö†Ô∏è "Cannot trade injured players"</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', margin: 0 }}>
                                        <strong>Solution:</strong> Wait for the player to heal, or trade a different player. Check <strong>Roster Management ‚Üí Injuries</strong> 
                                        to see when they'll return (shown as "X days").
                                    </p>
                                </div>
                                
                                <div style={{ padding: '1rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem', borderLeft: '4px solid #f59e0b' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.05rem', marginBottom: '0.5rem' }}>‚ö†Ô∏è "Trade deadline has passed"</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', margin: 0 }}>
                                        <strong>Solution:</strong> Trades are locked after Day 56. You'll need to wait until next season (after the draft) to make trades again.
                                    </p>
                                </div>
                                
                                <div style={{ padding: '1rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem', borderLeft: '4px solid #f59e0b' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.05rem', marginBottom: '0.5rem' }}>‚ö†Ô∏è Game won't load / blank screen</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', margin: 0 }}>
                                        <strong>Solution:</strong> Clear your browser cache and reload the page. Make sure JavaScript is enabled. 
                                        If using Safari, try Chrome or Firefox. Check that local storage is allowed in browser settings.
                                    </p>
                                </div>
                                
                                <div style={{ padding: '1rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem', borderLeft: '4px solid #f59e0b' }}>
                                    <h3 style={{ color: '#fbbf24', fontSize: '1.05rem', marginBottom: '0.5rem' }}>‚ö†Ô∏è My lines keep resetting</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', margin: 0 }}>
                                        <strong>Solution:</strong> This happens when players get injured and replacements are auto-assigned. 
                                        Check <strong>Injuries</strong> and adjust your lines after calling up farm players or when injured players return.
                                    </p>
                                </div>
                                
                                <div style={{ padding: '1rem', background: 'rgba(0, 0, 0, 0.3)', borderRadius: '0.5rem', borderLeft: '4px solid #22c55e' }}>
                                    <h3 style={{ color: '#22c55e', fontSize: '1.05rem', marginBottom: '0.5rem' }}>üí¨ Still need help?</h3>
                                    <p style={{ color: '#e2e8f0', lineHeight: '1.6', margin: 0 }}>
                                        This is a beta! Report bugs and request features by clicking the <strong>üí¨ Feedback</strong> button in Settings. 
                                        Your input helps improve the game for everyone.
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* FUTURE FEATURES */}
                        {/* DRAFT LOTTERY & OFFSEASON */}
                        <div className="card" style={{ background: 'rgba(245, 158, 11, 0.1)', border: '2px solid #f59e0b', marginTop: '2rem' }}>
                            <h2 style={{ color: '#fbbf24' }}>üé≤ Draft Lottery & Offseason</h2>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Season Summary</h3>
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                After the Stanley Cup Finals, you'll see a comprehensive season summary showing:
                            </p>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Season Overview:</strong> Your final record, division/conference rank, playoff result</li>
                                <li><strong>Team Story:</strong> Auto-generated narrative about your season</li>
                                <li><strong>Top Performers:</strong> Team MVP, breakout player, declining player</li>
                                <li><strong>Team Performance:</strong> League rankings for offense, defense, goaltending</li>
                                <li><strong>League Snapshot:</strong> Stanley Cup champion, league MVP, top scorer</li>
                                <li><strong>Season Headlines:</strong> Key storylines from your season</li>
                            </ul>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>Draft Lottery System</h3>
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                The 16 teams that missed the playoffs enter the draft lottery to determine draft order:
                            </p>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>Weighted Odds:</strong> Teams with fewer points have better lottery odds</li>
                                <li><strong>Top 5 Picks:</strong> Determined by lottery draw (teams can move up or down)</li>
                                <li><strong>Picks 6-16:</strong> Assigned in reverse order of regular season finish</li>
                                <li><strong>Animated Reveal:</strong> Watch picks revealed one at a time for suspense</li>
                                <li><strong>Your Team:</strong> Highlighted in green if you're in the lottery</li>
                            </ul>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>How to Access</h3>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li><strong>After Playoffs:</strong> Automatically shown after Stanley Cup Finals and season summary</li>
                                <li><strong>Manual Access:</strong> League ‚Üí üé≤ Draft Lottery (available when season is complete)</li>
                                <li><strong>Top Nav:</strong> "Continue to Next Season" button appears when playoffs are done</li>
                            </ul>
                            
                            <h3 style={{ color: '#93c5fd', marginTop: '1.5rem' }}>What's Next</h3>
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                After the lottery, you'll proceed to the Entry Draft (coming soon), where you'll use your pick to 
                                select prospects. Future updates will add free agency, training camp, and the start of a new season!
                            </p>
                        </div>
                        
                        <div className="card" style={{ background: 'rgba(139, 92, 246, 0.1)', border: '2px solid #8b5cf6', marginTop: '2rem' }}>
                            <h2 style={{ color: '#a78bfa' }}>üîÆ Coming Soon</h2>
                            <p style={{ color: '#e2e8f0', marginBottom: '1rem' }}>
                                Features in development (see Settings ‚Üí Roadmap for full list):
                            </p>
                            <ul style={{ lineHeight: '2', color: '#e2e8f0' }}>
                                <li>Entry draft with prospect scouting</li>
                                <li>Player career highs tracking</li>
                                <li>Advanced search & filters</li>
                                <li>Multi-season franchise mode</li>
                                <li>Free agency</li>
                                <li>Contract & salary cap management</li>
                                <li>Player development & aging curves</li>
                            </ul>
                        </div>

                        {/* FEEDBACK */}
                        <div className="card" style={{ background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e', marginTop: '2rem' }}>
                            <h2 style={{ color: '#22c55e' }}>üí¨ Questions or Issues?</h2>
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8' }}>
                                This user manual is continuously updated as new features are added. 
                                If you encounter bugs or have suggestions, the development team is actively improving the game.
                            </p>
                            <p style={{ color: '#93c5fd', marginTop: '1rem', fontStyle: 'italic' }}>
                                Last Updated: December 2025 | Version 1.0
                            </p>
                        </div>
                    </div>
                )}

                {/* PLAYOFF MVP VIEW */}
                {currentView === 'playoffMVP' && playoffMVP && playoffState && (
                    <div>
                        <div className="card" style={{ 
                            background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.2))', 
                            border: '3px solid #f59e0b',
                            textAlign: 'center'
                        }}>
                            <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üèÜ</div>
                            <h1 style={{ color: '#fbbf24', marginBottom: '1rem', fontSize: '2.5rem' }}>
                                Stanley Cup Champions
                            </h1>
                            <h2 style={{ color: '#fff', fontSize: '2rem', marginBottom: '2rem' }}>
                                {TEAMS.find(t => t.id === playoffState.champion)?.city} {TEAMS.find(t => t.id === playoffState.champion)?.name}
                            </h2>
                            
                            <div style={{ 
                                marginTop: '2rem', 
                                padding: '2rem',
                                background: 'rgba(0, 0, 0, 0.3)',
                                borderRadius: '1rem'
                            }}>
                                <h2 style={{ color: '#fbbf24', marginBottom: '1rem', fontSize: '1.8rem' }}>
                                    üíé Playoff MVP
                                </h2>
                                <h3 style={{ color: '#fff', fontSize: '2rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                    {playoffMVP.firstName} {playoffMVP.lastName}
                                </h3>
                                <div style={{ color: '#93c5fd', fontSize: '1.2rem', marginBottom: '1.5rem' }}>
                                    {TEAMS.find(t => t.id === playoffMVP.teamId)?.city} {TEAMS.find(t => t.id === playoffMVP.teamId)?.name}
                                </div>
                                
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'center', 
                                    gap: '3rem',
                                    fontSize: '1.5rem',
                                    color: '#e2e8f0',
                                    marginTop: '1.5rem'
                                }}>
                                    {playoffMVP.position === 'G' ? (
                                        <>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Record</div>
                                                <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats?.wins}-{playoffMVP.playoffStats?.losses}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Save %</div>
                                                <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.savePercentage.toFixed(3)}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>GAA</div>
                                                <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.gaa.toFixed(2)}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>SO</div>
                                                <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.shutouts}</div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Goals</div>
                                                <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.goals}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Assists</div>
                                                <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.assists}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>Points</div>
                                                <div style={{ fontWeight: 'bold' }}>{playoffMVP.playoffStats.points}</div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '1rem' }}>+/-</div>
                                                <div style={{ fontWeight: 'bold' }}>
                                                    {playoffMVP.playoffStats.plusMinus > 0 ? '+' : ''}{playoffMVP.playoffStats.plusMinus}
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            <button 
                                onClick={() => {
                                    setCurrentView('seasonSummary');
                                }}
                                style={{
                                    marginTop: '2rem',
                                    padding: '0.75rem 1.5rem',
                                    background: '#3b82f6',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.5rem',
                                    fontSize: '1.1rem',
                                    cursor: 'pointer',
                                    fontWeight: 'bold'
                                }}
                            >
                                View Season Summary ‚Üí
                            </button>
                        </div>
                    </div>
                )}
                
                {/* CONTRACT RE-SIGNING VIEW */}
                {currentView === 'resign' && expiringContracts && (
                    <div>
                        <div className="card" style={{
                            background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.2))',
                            border: '3px solid #8b5cf6',
                            textAlign: 'center',
                            marginBottom: '2rem'
                        }}>
                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìù</div>
                            <h1 style={{ fontSize: '2.5rem', marginBottom: '0.5rem', color: '#a78bfa' }}>
                                Re-sign Your Players
                            </h1>
                            <p style={{ color: '#e2e8f0', fontSize: '1.2rem', marginBottom: '1rem' }}>
                                {expiringContracts.userTeam.length} contract{expiringContracts.userTeam.length !== 1 ? 's' : ''} expiring this offseason
                            </p>
                            <p style={{ color: '#93c5fd', fontSize: '0.95rem' }}>
                                Sign them now before they hit free agency on July 1st
                            </p>
                        </div>
                        
                        {expiringContracts.userTeam.length === 0 ? (
                            <div className="card" style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>‚úÖ</div>
                                <h2 style={{ color: '#22c55e', marginBottom: '1rem' }}>No Expiring Contracts</h2>
                                <p style={{ color: '#93c5fd', marginBottom: '2rem' }}>
                                    All your players are under contract for next season
                                </p>
                                <button
                                    onClick={() => setCurrentView('draftlottery')}
                                    style={{
                                        padding: '1rem 2rem',
                                        background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.5rem',
                                        fontSize: '1.1rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Continue to Draft Lottery ‚Üí
                                </button>
                            </div>
                        ) : (
                            <>
                                {/* Quick Actions */}
                                <div className="card" style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>Quick Actions</h3>
                                    <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
                                        <button
                                            onClick={() => {
                                                // Re-sign all depth players (< 75 OVR) at their asking price
                                                const depthPlayers = expiringContracts.userTeam.filter(p => 
                                                    p.ratings.overall < 75 && 
                                                    !resignedPlayers.find(r => r.player.id === p.id) &&
                                                    !skippedPlayers.includes(p.id)
                                                );
                                                
                                                const newResigned = [];
                                                depthPlayers.forEach(player => {
                                                    const offer = calculateResignOffer(player);
                                                    newResigned.push({
                                                        player,
                                                        salary: offer.salary,
                                                        years: offer.years,
                                                        accepted: true
                                                    });
                                                });
                                                
                                                setResignedPlayers([...resignedPlayers, ...newResigned]);
                                            }}
                                            style={{
                                                padding: '0.75rem 1.5rem',
                                                background: '#3b82f6',
                                                color: '#fff',
                                                border: 'none',
                                                borderRadius: '0.5rem',
                                                fontWeight: 'bold',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            ‚ö° Re-sign All Depth (&lt;75 OVR)
                                        </button>
                                        <button
                                            onClick={() => {
                                                // Skip all remaining players
                                                const remaining = expiringContracts.userTeam.filter(p => 
                                                    !resignedPlayers.find(r => r.player.id === p.id) &&
                                                    !skippedPlayers.includes(p.id)
                                                );
                                                setSkippedPlayers([...skippedPlayers, ...remaining.map(p => p.id)]);
                                            }}
                                            style={{
                                                padding: '0.75rem 1.5rem',
                                                background: '#64748b',
                                                color: '#fff',
                                                border: 'none',
                                                borderRadius: '0.5rem',
                                                fontWeight: 'bold',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            ‚è≠Ô∏è Skip All Remaining
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Expiring Contracts List */}
                                <div className="card">
                                    <h3 style={{ color: '#22d3ee', marginBottom: '1.5rem' }}>Expiring Contracts</h3>
                                    <div style={{ display: 'grid', gap: '1rem' }}>
                                        {expiringContracts.userTeam.map(player => {
                                            const alreadyResigned = resignedPlayers.find(r => r.player.id === player.id);
                                            const isSkipped = skippedPlayers.includes(player.id);
                                            const offer = calculateResignOffer(player);
                                            
                                            return (
                                                <div
                                                    key={player.id}
                                                    style={{
                                                        padding: '1.5rem',
                                                        background: alreadyResigned 
                                                            ? 'rgba(34, 197, 94, 0.1)' 
                                                            : isSkipped 
                                                            ? 'rgba(100, 116, 139, 0.1)'
                                                            : 'rgba(139, 92, 246, 0.1)',
                                                        border: `2px solid ${alreadyResigned ? '#22c55e' : isSkipped ? '#64748b' : '#8b5cf6'}`,
                                                        borderRadius: '0.5rem'
                                                    }}
                                                >
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '1rem' }}>
                                                        <div>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                                                <span style={{ fontSize: '1.3rem', fontWeight: 'bold', color: '#fff' }}>
                                                                    {player.firstName} {player.lastName}
                                                                </span>
                                                                <span style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: player.playerType === 'RFA' ? '#3b82f6' : '#f59e0b',
                                                                    color: '#fff',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.75rem',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {player.playerType}
                                                                </span>
                                                            </div>
                                                            <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                                                {player.position} ‚Ä¢ {player.age} years old ‚Ä¢ {player.ratings.overall} OVR
                                                            </div>
                                                            <div style={{ color: '#64748b', fontSize: '0.85rem', marginTop: '0.25rem' }}>
                                                                Current: ${(player.currentSalary / 1000000).toFixed(2)}M √ó 1 year
                                                            </div>
                                                        </div>
                                                        {alreadyResigned && (
                                                            <div style={{
                                                                padding: '0.5rem 1rem',
                                                                background: '#22c55e',
                                                                color: '#fff',
                                                                borderRadius: '0.5rem',
                                                                fontWeight: 'bold',
                                                                fontSize: '0.9rem'
                                                            }}>
                                                                ‚úÖ RE-SIGNED
                                                            </div>
                                                        )}
                                                        {isSkipped && (
                                                            <div style={{
                                                                padding: '0.5rem 1rem',
                                                                background: '#64748b',
                                                                color: '#fff',
                                                                borderRadius: '0.5rem',
                                                                fontWeight: 'bold',
                                                                fontSize: '0.9rem'
                                                            }}>
                                                                ‚è≠Ô∏è SKIPPED
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {!alreadyResigned && !isSkipped && (
                                                        <>
                                                            <div style={{
                                                                padding: '1rem',
                                                                background: 'rgba(59, 130, 246, 0.1)',
                                                                borderRadius: '0.5rem',
                                                                marginBottom: '1rem'
                                                            }}>
                                                                <div style={{ color: '#22d3ee', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                                                    Player's Ask:
                                                                </div>
                                                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fff' }}>
                                                                    ${(offer.salary / 1000000).toFixed(2)}M √ó {offer.years} year{offer.years > 1 ? 's' : ''}
                                                                </div>
                                                                {player.playerType === 'RFA' && (
                                                                    <div style={{ color: '#3b82f6', fontSize: '0.85rem', marginTop: '0.5rem' }}>
                                                                        üí° RFA: Capped at 125% of current salary
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            <div style={{ display: 'flex', gap: '0.75rem' }}>
                                                                <button
                                                                    onClick={() => {
                                                                        setResignedPlayers([...resignedPlayers, {
                                                                            player,
                                                                            salary: offer.salary,
                                                                            years: offer.years,
                                                                            accepted: true
                                                                        }]);
                                                                    }}
                                                                    style={{
                                                                        flex: 1,
                                                                        padding: '0.75rem',
                                                                        background: '#22c55e',
                                                                        color: '#fff',
                                                                        border: 'none',
                                                                        borderRadius: '0.5rem',
                                                                        fontWeight: 'bold',
                                                                        cursor: 'pointer',
                                                                        fontSize: '1rem'
                                                                    }}
                                                                >
                                                                    ‚úÖ Accept Offer
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        setSkippedPlayers([...skippedPlayers, player.id]);
                                                                    }}
                                                                    style={{
                                                                        flex: 1,
                                                                        padding: '0.75rem',
                                                                        background: '#64748b',
                                                                        color: '#fff',
                                                                        border: 'none',
                                                                        borderRadius: '0.5rem',
                                                                        fontWeight: 'bold',
                                                                        cursor: 'pointer',
                                                                        fontSize: '1rem'
                                                                    }}
                                                                >
                                                                    ‚è≠Ô∏è Let Walk
                                                                </button>
                                                            </div>
                                                        </>
                                                    )}
                                                    
                                                    {alreadyResigned && (
                                                        <div style={{
                                                            padding: '1rem',
                                                            background: 'rgba(34, 197, 94, 0.1)',
                                                            borderRadius: '0.5rem',
                                                            border: '2px solid #22c55e'
                                                        }}>
                                                            <div style={{ color: '#22c55e', fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                                New Contract: ${(alreadyResigned.salary / 1000000).toFixed(2)}M √ó {alreadyResigned.years} year{alreadyResigned.years > 1 ? 's' : ''}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                
                                {/* Continue Button */}
                                <div style={{ textAlign: 'center', marginTop: '2rem' }}>
                                    <button
                                        onClick={() => {
                                            // Create a single updated players array
                                            let updatedPlayers = [...gameState.players];
                                            
                                            // Apply user's re-signed contracts
                                            if (resignedPlayers.length > 0) {
                                                updatedPlayers = updatedPlayers.map(p => {
                                                    const resigned = resignedPlayers.find(r => r.player.id === p.id);
                                                    if (resigned) {
                                                        return {
                                                            ...p,
                                                            contract: {
                                                                salary: resigned.salary,
                                                                yearsRemaining: resigned.years
                                                            }
                                                        };
                                                    }
                                                    return p;
                                                });
                                            }
                                            
                                            // AI teams re-sign their players
                                            const aiResigned = aiResignPlayers(expiringContracts);
                                            if (aiResigned.length > 0) {
                                                updatedPlayers = updatedPlayers.map(p => {
                                                    const resigned = aiResigned.find(r => r.player.id === p.id);
                                                    if (resigned) {
                                                        return {
                                                            ...p,
                                                            contract: {
                                                                salary: resigned.salary,
                                                                yearsRemaining: resigned.years
                                                            }
                                                        };
                                                    }
                                                    return p;
                                                });
                                            }
                                            
                                            // Remove unsigned players from rosters (they become free agents)
                                            // Players with yearsRemaining === 1 who weren't re-signed
                                            const unsignedPlayerIds = [
                                                ...expiringContracts.userTeam.filter(p => 
                                                    !resignedPlayers.find(r => r.player.id === p.id) &&
                                                    skippedPlayers.includes(p.id)
                                                ).map(p => p.id),
                                                ...Object.values(expiringContracts.aiTeams).flat().filter(p =>
                                                    !aiResigned.find(r => r.player.id === p.id)
                                                ).map(p => p.id)
                                            ];
                                            
                                            updatedPlayers = updatedPlayers.map(p => {
                                                if (unsignedPlayerIds.includes(p.id)) {
                                                    // Remove from team, they'll be in FA pool
                                                    return {
                                                        ...p,
                                                        teamId: null,
                                                        roster: 'fa',
                                                        contract: {
                                                            salary: 0,
                                                            yearsRemaining: 0
                                                        },
                                                        // Heal all injuries for free agency
                                                        injury: {
                                                            injured: false,
                                                            type: null,
                                                            daysRemaining: 0
                                                        }
                                                    };
                                                }
                                                return p;
                                            });
                                            
                                            // Apply all updates at once
                                            setGameState({
                                                ...gameState,
                                                players: updatedPlayers
                                            });
                                            
                                            setCurrentView('draftlottery');
                                        }}
                                        style={{
                                            padding: '1.25rem 3rem',
                                            background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.75rem',
                                            fontSize: '1.3rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            boxShadow: '0 8px 16px rgba(245, 158, 11, 0.3)'
                                        }}
                                    >
                                        Continue to Draft Lottery ‚Üí
                                    </button>
                                    <p style={{ color: '#64748b', marginTop: '1rem', fontSize: '0.9rem' }}>
                                        {resignedPlayers.length} re-signed ‚Ä¢ {skippedPlayers.length} will become free agents
                                    </p>
                                </div>
                            </>
                        )}
                    </div>
                )}
                
                {/* DRAFT LOTTERY VIEW */}
                {currentView === 'draftlottery' && gameState && (
                    <div>
                        <div className="card" style={{
                            background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.2))',
                            border: '3px solid #f59e0b',
                            textAlign: 'center',
                            marginBottom: '2rem'
                        }}>
                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üé≤</div>
                            <h1 style={{ fontSize: '2.5rem', marginBottom: '0.5rem', color: '#fbbf24' }}>
                                {gameState.year + 1} Draft Lottery
                            </h1>
                            <p style={{ color: '#e2e8f0', fontSize: '1.2rem' }}>
                                Determining the draft order for next season
                            </p>
                        </div>
                        
                        {/* Lottery Explanation */}
                        <div className="card" style={{ marginBottom: '2rem' }}>
                            <h2 style={{ marginBottom: '1rem' }}>üìã How the Lottery Works</h2>
                            <p style={{ color: '#e2e8f0', lineHeight: '1.8', marginBottom: '1rem' }}>
                                The 16 teams that missed the playoffs are entered into the draft lottery. The lottery determines 
                                the order for the top 5 picks, with the remaining picks (6-16) assigned in reverse order of standings.
                            </p>
                            <p style={{ color: '#93c5fd', lineHeight: '1.8' }}>
                                Teams with fewer points have better odds of winning a top pick. This creates opportunities for 
                                rebuilding teams to acquire elite talent and return to competitiveness.
                            </p>
                        </div>
                        
                        {/* Generate/Reveal Lottery Button */}
                        {!draftLotteryResults && (
                            <div className="card" style={{ textAlign: 'center' }}>
                                <button
                                    onClick={() => {
                                        const results = generateDraftLottery(gameState.standings);
                                        setDraftLotteryResults(results);
                                        setLotteryRevealStep(0);
                                        
                                        // Update draftPicks array to reflect lottery results
                                        if (gameState.draftPicks) {
                                            const updatedPicks = [...gameState.draftPicks];
                                            const nextYear = gameState.year + 1;
                                            
                                            // Update Round 1 picks based on lottery results (all 32 teams)
                                            results.forEach((lotteryResult, idx) => {
                                                const pickInRound = idx + 1;
                                                const pickId = `${nextYear}-R1-${pickInRound}`;
                                                const pick = updatedPicks.find(p => p.id === pickId);
                                                
                                                if (pick) {
                                                    // The pick's position is now determined by lottery
                                                    // Update originalTeam to reflect the lottery-determined position
                                                    pick.originalTeam = lotteryResult.teamId;
                                                    // If currentOwner was still the old originalTeam, update it too
                                                    if (pick.currentOwner === pick.originalTeam) {
                                                        pick.currentOwner = lotteryResult.teamId;
                                                    }
                                                }
                                            });
                                            
                                            setGameState({
                                                ...gameState,
                                                draftPicks: updatedPicks
                                            });
                                        }
                                    }}
                                    style={{
                                        padding: '1.25rem 3rem',
                                        background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.75rem',
                                        fontSize: '1.3rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        boxShadow: '0 8px 16px rgba(245, 158, 11, 0.3)'
                                    }}
                                >
                                    üé≤ Run Draft Lottery
                                </button>
                            </div>
                        )}
                        
                        {/* Lottery Results - Animated Reveal */}
                        {draftLotteryResults && (
                            <div>
                                {/* Top 5 Picks - Lottery Winners */}
                                <div className="card" style={{ marginBottom: '2rem' }}>
                                    <h2 style={{ marginBottom: '1.5rem', color: '#fbbf24' }}>
                                        üèÜ Lottery Results (Top 5 Picks)
                                    </h2>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                        {draftLotteryResults.slice(0, 5).reverse().map((result, reverseIndex) => {
                                            // reverseIndex goes 0,1,2,3,4 for picks 5,4,3,2,1
                                            // Reveal pick 5 first (reverseIndex 0), then 4 (reverseIndex 1), etc.
                                            const isRevealed = lotteryRevealStep > reverseIndex;
                                            return (
                                                <div 
                                                    key={result.pick}
                                                    style={{
                                                        padding: '1.5rem',
                                                        background: isRevealed 
                                                            ? (result.teamId === userTeamId 
                                                                ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2))'
                                                                : 'rgba(59, 130, 246, 0.2)')
                                                            : 'rgba(100, 116, 139, 0.2)',
                                                        border: isRevealed
                                                            ? (result.teamId === userTeamId
                                                                ? '3px solid #22c55e'
                                                                : '2px solid #3b82f6')
                                                            : '2px solid #64748b',
                                                        borderRadius: '0.75rem',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        transition: 'all 0.5s ease',
                                                        opacity: isRevealed ? 1 : 0.5
                                                    }}
                                                >
                                                    <div style={{ display: 'flex', alignItems: 'center', gap: '1.5rem' }}>
                                                        <div style={{
                                                            fontSize: '2rem',
                                                            fontWeight: 'bold',
                                                            color: '#fbbf24',
                                                            minWidth: '60px'
                                                        }}>
                                                            {isRevealed ? `${result.pick}${getOrdinalSuffix(result.pick)}` : '???'}
                                                        </div>
                                                        <div>
                                                            <div style={{ 
                                                                fontSize: '1.3rem', 
                                                                fontWeight: 'bold',
                                                                color: result.teamId === userTeamId ? '#22c55e' : '#fff'
                                                            }}>
                                                                {isRevealed ? result.teamName : '??? ??? ???'}
                                                                {result.teamId === userTeamId && isRevealed && ' (YOUR TEAM)'}
                                                            </div>
                                                            {isRevealed && (
                                                                <div style={{ color: '#93c5fd', fontSize: '0.9rem', marginTop: '0.25rem' }}>
                                                                    {result.record} ({result.points} pts) ‚Ä¢ Finished {result.finishPosition}{getOrdinalSuffix(result.finishPosition)}
                                                                    {result.moved && (
                                                                        <span style={{ color: result.finishPosition > (16 - result.pick + 1) ? '#22c55e' : '#ef4444', marginLeft: '0.5rem', fontWeight: 'bold' }}>
                                                                            {result.finishPosition > (16 - result.pick + 1) ? 'üìà Moved Up!' : 'üìâ Dropped'}
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    {/* Reveal Controls */}
                                    {lotteryRevealStep < 5 && (
                                        <div style={{ marginTop: '2rem', textAlign: 'center' }}>
                                            <button
                                                onClick={() => {
                                                    setLotteryRevealStep(prev => prev + 1);
                                                    setTimeout(() => {
                                                        saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                                    }, 100);
                                                }}
                                                style={{
                                                    padding: '0.875rem 2rem',
                                                    background: '#f59e0b',
                                                    color: '#fff',
                                                    border: 'none',
                                                    borderRadius: '0.5rem',
                                                    fontSize: '1.1rem',
                                                    cursor: 'pointer',
                                                    fontWeight: 'bold',
                                                    marginRight: '1rem'
                                                }}
                                            >
                                                Reveal {lotteryRevealStep === 0 ? '5th' : lotteryRevealStep === 1 ? '4th' : lotteryRevealStep === 2 ? '3rd' : lotteryRevealStep === 3 ? '2nd' : '1st'} Pick
                                            </button>
                                            <button
                                                onClick={() => {
                                                    setLotteryRevealStep(5);
                                                    setTimeout(() => {
                                                        saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                                    }, 100);
                                                }}
                                                style={{
                                                    padding: '0.875rem 2rem',
                                                    background: '#64748b',
                                                    color: '#fff',
                                                    border: 'none',
                                                    borderRadius: '0.5rem',
                                                    fontSize: '1.1rem',
                                                    cursor: 'pointer',
                                                    fontWeight: 'bold'
                                                }}
                                            >
                                                Reveal All
                                            </button>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Remaining Picks 6-16 */}
                                {lotteryRevealStep >= 5 && (
                                    <div className="card">
                                        <h2 style={{ marginBottom: '1.5rem' }}>üìä Remaining Draft Order (Picks 6-16)</h2>
                                        <table className="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Pick</th>
                                                    <th>Team</th>
                                                    <th className="text-center">Record</th>
                                                    <th className="text-center">Points</th>
                                                    <th className="text-center">Finish</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {draftLotteryResults.slice(5).map(result => (
                                                    <tr key={result.pick} style={{
                                                        background: result.teamId === userTeamId ? 'rgba(34, 197, 94, 0.1)' : undefined
                                                    }}>
                                                        <td style={{ fontWeight: 'bold', color: '#fbbf24' }}>
                                                            {result.pick}
                                                        </td>
                                                        <td style={{ fontWeight: result.teamId === userTeamId ? 'bold' : undefined }}>
                                                            {result.teamName}
                                                            {result.teamId === userTeamId && <span style={{ color: '#22c55e', marginLeft: '0.5rem' }}>(YOUR TEAM)</span>}
                                                        </td>
                                                        <td className="text-center">{result.record}</td>
                                                        <td className="text-center">{result.points}</td>
                                                        <td className="text-center">
                                                            {result.finishPosition}{getOrdinalSuffix(result.finishPosition)}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                
                                {/* Continue to Offseason */}
                                {lotteryRevealStep >= 5 && (
                                    <div className="card" style={{
                                        background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2))',
                                        border: '3px solid #22c55e',
                                        textAlign: 'center',
                                        marginTop: '2rem'
                                    }}>
                                        <h2 style={{ fontSize: '1.8rem', marginBottom: '1rem', color: '#22c55e' }}>
                                            Draft Lottery Complete
                                        </h2>
                                        <p style={{ color: '#e2e8f0', marginBottom: '2rem', fontSize: '1.1rem' }}>
                                            The draft order has been determined. Ready to begin the offseason?
                                        </p>
                                        <button
                                            onClick={() => {
                                                if (!draftProspects) {
                                                    setDraftProspects(generateDraftProspects());
                                                }
                                                setCurrentView('draft');
                                                setTimeout(() => {
                                                    saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                                }, 100);
                                            }}
                                            style={{
                                                padding: '1.25rem 3rem',
                                                background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                                color: '#fff',
                                                border: 'none',
                                                borderRadius: '0.75rem',
                                                fontSize: '1.3rem',
                                                cursor: 'pointer',
                                                fontWeight: 'bold',
                                                boxShadow: '0 8px 16px rgba(34, 197, 94, 0.3)'
                                            }}
                                        >
                                            Proceed to Entry Draft ‚Üí
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                )}
                
                {/* ENTRY DRAFT VIEW */}
                {currentView === 'draft' && (() => {
                    // Sign all draft picks and add to rosters
                    const signDraftPicks = () => {
                        const newPlayers = [];
                        const signingSummary = [];
                        
                        // Process each team's draft picks
                        TEAMS.forEach(team => {
                            const teamPicks = draftResults.filter(r => r.teamId === team.id);
                            
                            teamPicks.forEach(pick => {
                                const prospect = pick.prospect;
                                
                                // Determine ELC salary based on round
                                const salary = ELC_SALARIES[pick.round] || SALARY_CAP.minimum;
                                
                                // Determine if player goes to NHL or farm
                                // Check if they're better than worst NHL player
                                const teamPlayers = gameState.players.filter(p => p.teamId === team.id && p.roster === 'nhl');
                                const worstNHLPlayer = teamPlayers
                                    .filter(p => p.position === prospect.position)
                                    .sort((a, b) => a.ratings.overall - b.ratings.overall)[0];
                                
                                const assignToNHL = worstNHLPlayer && prospect.overall > worstNHLPlayer.ratings.overall;
                                
                                // Create player object
                                const newPlayer = {
                                    id: `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    firstName: prospect.firstName,
                                    lastName: prospect.lastName,
                                    position: prospect.position,
                                    age: prospect.age,
                                    teamId: team.id,
                                    roster: assignToNHL ? 'nhl' : 'farm',
                                    ratings: {
                                        overall: prospect.overall,
                                        potential: prospect.potential
                                    },
                                    contract: {
                                        salary: salary,
                                        yearsRemaining: 3  // Standard 3-year ELC
                                    },
                                    injury: {
                                        injured: false,
                                        daysRemaining: 0
                                    },
                                    stats: {
                                        gamesPlayed: 0,
                                        goals: 0,
                                        assists: 0,
                                        points: 0,
                                        plusMinus: 0,
                                        pim: 0,
                                        shotsOnGoal: 0,
                                        timeOnIce: 0,
                                        wins: 0,
                                        losses: 0,
                                        goalsAgainst: 0,
                                        shotsAgainst: 0,
                                        saves: 0,
                                        savePercentage: 0,
                                        gaa: 0,
                                        shutouts: 0
                                    },
                                    careerStats: {
                                        gamesPlayed: 0,
                                        goals: 0,
                                        assists: 0,
                                        points: 0,
                                        wins: 0,
                                        losses: 0
                                    },
                                    // Line assignments (will be set when user sets lines)
                                    lineNumber: 0,
                                    linePosition: null,
                                    ppUnit: null,
                                    ppPosition: null,
                                    pkUnit: null,
                                    pkPosition: null,
                                    dressed: false
                                };
                                
                                newPlayers.push(newPlayer);
                                
                                // Track for user team summary
                                if (team.id === userTeamId) {
                                    signingSummary.push({
                                        name: `${prospect.firstName} ${prospect.lastName}`,
                                        position: prospect.position,
                                        overall: prospect.overall,
                                        potential: prospect.potential,
                                        round: pick.round,
                                        salary: salary,
                                        assignment: assignToNHL ? 'NHL' : 'Farm'
                                    });
                                }
                            });
                        });
                        
                        // Add all new players to game state
                        setGameState(prev => ({
                            ...prev,
                            players: [...prev.players, ...newPlayers]
                        }));
                        
                        setDraftPicksSigned(true);
                        
                        // Show summary for user
                        const summary = signingSummary.map(s => 
                            `‚úçÔ∏è ${s.name} (${s.position}) - ${s.overall} OVR ‚Üí ${s.potential} POT\n   Round ${s.round} ‚Ä¢ $${(s.salary/1000).toFixed(0)}K √ó 3yr ‚Ä¢ Assigned to: ${s.assignment}`
                        ).join('\n\n');
                        
                        alert(`üéâ Draft Picks Signed!\n\n${signingSummary.length} players signed to 3-year entry-level contracts:\n\n${summary}\n\nüí° Players assigned to NHL if better than current roster.\n‚ö†Ô∏è Check farm team - you may need to release players if over ${ROSTER_LIMITS.FARM} limit before season starts.`);
                        
                        saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                    };
                    
                    return (
                    <div>
                        {/* Header */}
                        <div className="card" style={{
                            background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2))',
                            border: '3px solid #22c55e',
                            textAlign: 'center',
                            marginBottom: '2rem'
                        }}>
                            <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üéØ</div>
                            <h1 style={{ fontSize: '2.5rem', marginBottom: '0.5rem', color: '#22c55e' }}>
                                {gameState.year + 1} Entry Draft
                            </h1>
                            <p style={{ color: '#e2e8f0', fontSize: '1.2rem' }}>
                                7 Rounds ‚Ä¢ 224 Total Picks
                            </p>
                        </div>
                        
                        {/* Draft Team Needs */}
                        {(() => {
                            const draftNeeds = analyzeDraftNeeds();
                            if (!draftNeeds) return null;
                            
                            return (
                                <div className="card" style={{ marginBottom: '2rem' }}>
                                    <h2 style={{ color: '#f59e0b', marginBottom: '1.5rem' }}>
                                        üìã Prospect Pool Analysis & Draft Strategy
                                    </h2>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>
                                        {/* Current Prospects */}
                                        <div>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>Current Prospect Pool</h3>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                <div style={{ 
                                                    padding: '0.75rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    display: 'flex',
                                                    justifyContent: 'space-between'
                                                }}>
                                                    <span style={{ color: '#93c5fd' }}>Forward Prospects (U23):</span>
                                                    <span style={{ 
                                                        color: draftNeeds.prospectCounts.forwards >= 5 ? '#22c55e' : '#ef4444',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {draftNeeds.prospectCounts.forwards}
                                                    </span>
                                                </div>
                                                <div style={{ 
                                                    padding: '0.75rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    display: 'flex',
                                                    justifyContent: 'space-between'
                                                }}>
                                                    <span style={{ color: '#93c5fd' }}>Defense Prospects (U23):</span>
                                                    <span style={{ 
                                                        color: draftNeeds.prospectCounts.defense >= 3 ? '#22c55e' : '#ef4444',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {draftNeeds.prospectCounts.defense}
                                                    </span>
                                                </div>
                                                <div style={{ 
                                                    padding: '0.75rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    display: 'flex',
                                                    justifyContent: 'space-between'
                                                }}>
                                                    <span style={{ color: '#93c5fd' }}>Goalie Prospects (U23):</span>
                                                    <span style={{ 
                                                        color: draftNeeds.prospectCounts.goalies >= 1 ? '#22c55e' : '#ef4444',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {draftNeeds.prospectCounts.goalies}
                                                    </span>
                                                </div>
                                                <div style={{ 
                                                    padding: '0.75rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    display: 'flex',
                                                    justifyContent: 'space-between'
                                                }}>
                                                    <span style={{ color: '#93c5fd' }}>Elite Prospects (85+ pot):</span>
                                                    <span style={{ 
                                                        color: draftNeeds.prospectCounts.elite >= 3 ? '#22c55e' : '#fbbf24',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {draftNeeds.prospectCounts.elite}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Draft Needs */}
                                        <div>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>Priority Needs</h3>
                                            {draftNeeds.needs.length === 0 ? (
                                                <div style={{ 
                                                    padding: '1rem',
                                                    background: 'rgba(34, 197, 94, 0.1)',
                                                    border: '2px solid #22c55e',
                                                    borderRadius: '0.5rem',
                                                    color: '#22c55e',
                                                    textAlign: 'center'
                                                }}>
                                                    ‚úÖ Strong prospect pool! Draft BPA.
                                                </div>
                                            ) : (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                    {draftNeeds.needs.map((need, idx) => (
                                                        <div key={idx} style={{
                                                            padding: '0.75rem',
                                                            background: need.priority === 'CRITICAL' ? 'rgba(239, 68, 68, 0.1)' :
                                                                        need.priority === 'HIGH' ? 'rgba(251, 191, 36, 0.1)' : 
                                                                        'rgba(59, 130, 246, 0.1)',
                                                            border: `2px solid ${need.priority === 'CRITICAL' ? '#ef4444' :
                                                                                 need.priority === 'HIGH' ? '#fbbf24' : '#3b82f6'}`,
                                                            borderRadius: '0.5rem'
                                                        }}>
                                                            <div style={{ 
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center'
                                                            }}>
                                                                <span style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: need.priority === 'CRITICAL' ? '#ef4444' :
                                                                               need.priority === 'HIGH' ? '#fbbf24' : '#3b82f6',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.75rem',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {need.priority}
                                                                </span>
                                                                <span style={{ 
                                                                    color: '#e2e8f0',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {need.position}
                                                                </span>
                                                            </div>
                                                            <div style={{ 
                                                                color: '#93c5fd',
                                                                fontSize: '0.85rem',
                                                                marginTop: '0.5rem'
                                                            }}>
                                                                {need.reason}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Recommendations */}
                                    {draftNeeds.recommendations.length > 0 && (
                                        <div style={{ marginTop: '1.5rem' }}>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üí° Scouting Recommendations</h3>
                                            <div style={{ 
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '0.5rem'
                                            }}>
                                                {draftNeeds.recommendations.map((rec, idx) => (
                                                    <div key={idx} style={{
                                                        padding: '0.75rem 1rem',
                                                        background: 'rgba(34, 211, 238, 0.1)',
                                                        border: '2px solid #22d3ee',
                                                        borderRadius: '0.5rem',
                                                        color: '#e2e8f0',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '0.5rem'
                                                    }}>
                                                        <span style={{ color: '#22d3ee' }}>‚Üí</span>
                                                        {rec}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })()}
                        
                        {!draftProspects && (
                            <div className="card" style={{ textAlign: 'center' }}>
                                <button
                                    onClick={() => {
                                        const prospects = generateDraftProspects();
                                        setDraftProspects(prospects);
                                        setCurrentDraftPick(1);
                                        setDraftRound(1);
                                        setDraftResults([]);
                                        setTimeout(() => {
                                            saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                        }, 100);
                                    }}
                                    style={{
                                        padding: '1.25rem 3rem',
                                        background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.75rem',
                                        fontSize: '1.3rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        boxShadow: '0 8px 16px rgba(34, 197, 94, 0.3)'
                                    }}
                                >
                                    üéØ Generate Draft Class
                                </button>
                            </div>
                        )}
                        
                        {draftProspects && currentDraftPick <= 224 && (() => {
                            // Determine who's picking based on draft lottery results
                            const getDraftOrder = () => {
                                // Use draftPicks array if available (tracks trades)
                                if (gameState.draftPicks && gameState.draftPicks.length > 0) {
                                    const currentYearPicks = gameState.draftPicks.filter(p => p.year === gameState.year + 1);
                                    
                                    if (currentYearPicks.length >= 224) {
                                        // Sort by overall pick number
                                        const sorted = [...currentYearPicks].sort((a, b) => a.overallPick - b.overallPick);
                                        
                                        // Map to draft order format using currentOwner (which reflects trades)
                                        return sorted.map((pick, idx) => {
                                            const ownerTeam = TEAMS.find(t => t.id === pick.currentOwner);
                                            return {
                                                round: pick.round,
                                                teamId: pick.currentOwner, // Use currentOwner, not originalTeam!
                                                teamName: ownerTeam ? `${ownerTeam.city} ${ownerTeam.name}` : 'Unknown',
                                                overallPick: idx + 1,
                                                pickId: pick.id,
                                                originalTeam: pick.originalTeam // Track original for display
                                            };
                                        });
                                    }
                                }
                                
                                // Fallback if no draftPicks array
                                if (!draftLotteryResults) {
                                    // Fallback: use standings order if no lottery
                                    const sortedStandings = [...gameState.standings].sort((a, b) => a.points - b.points);
                                    const order = [];
                                    
                                    for (let round = 1; round <= 7; round++) {
                                        sortedStandings.forEach(standing => {
                                            const team = TEAMS.find(t => t.id === standing.teamId);
                                            if (!team) return null;
                                            order.push({
                                                round: round,
                                                teamId: standing.teamId,
                                                teamName: `${team.city} ${team.name}`,
                                                overallPick: order.length + 1
                                            });
                                        });
                                    }
                                    
                                    return order;
                                }
                                
                                const order = [];
                                
                                // Each round uses the same order (all 32 teams)
                                // Draft lottery results are already the full 32-team order (1-16 from lottery, 17-32 from playoff teams in reverse)
                                for (let round = 1; round <= 7; round++) {
                                    draftLotteryResults.forEach(team => {
                                        order.push({
                                            round: round,
                                            teamId: team.teamId,
                                            teamName: team.teamName,
                                            overallPick: order.length + 1
                                        });
                                    });
                                }
                                
                                return order;
                            };
                            
                            const draftOrder = getDraftOrder();
                            if (!draftOrder || draftOrder.length < 224) {
                                return <div className="card"><p style={{ color: '#ef4444' }}>Error: Draft order incomplete. Need all 32 teams!</p></div>;
                            }
                            
                            const currentPick = draftOrder[currentDraftPick - 1];
                            if (!currentPick) return <div className="card"><p style={{ color: '#ef4444' }}>Error: Invalid draft pick number!</p></div>;
                            
                            const isUserPick = currentPick.teamId === userTeamId;
                            
                            // Get available prospects (not yet drafted)
                            const draftedProspectIds = draftResults.map(r => r.prospectId);
                            const availableProspects = draftProspects.filter(p => !draftedProspectIds.includes(p.id));
                            
                            // AI picks the best available player for their needs
                            const makeAIPick = () => {
                                if (availableProspects.length === 0) return;
                                
                                // Simple AI: pick best available based on overall + potential
                                const sorted = [...availableProspects].sort((a, b) => {
                                    const aValue = a.overall + a.potential;
                                    const bValue = b.overall + b.potential;
                                    return bValue - aValue;
                                });
                                
                                const picked = sorted[0];
                                makePick(picked);
                            };
                            
                            const makePick = (prospect) => {
                                const newDraftResult = {
                                    round: currentPick.round,
                                    pick: currentDraftPick,
                                    teamId: currentPick.teamId,
                                    teamName: currentPick.teamName,
                                    prospectId: prospect.id,
                                    prospect: prospect
                                };
                                
                                setDraftResults([...draftResults, newDraftResult]);
                                setCurrentDraftPick(currentDraftPick + 1);
                                
                                // Update round
                                const nextPick = currentDraftPick + 1;
                                const nextRound = Math.ceil(nextPick / 32);
                                setDraftRound(nextRound);
                                
                                // Auto-save after each pick
                                setTimeout(() => {
                                    saveGameToLocalStorage(gameState, userTeamId, playoffState, seasonMode);
                                }, 100);
                            };
                            
                            // Auto-advance AI picks
                            if (!isUserPick && autoPickMode && availableProspects.length > 0) {
                                setTimeout(() => makeAIPick(), 100);
                            }
                            
                            return (
                                <div>
                                    {/* Draft Status */}
                                    <div className="card" style={{ marginBottom: '2rem', background: isUserPick ? 'rgba(34, 197, 94, 0.1)' : 'rgba(59, 130, 246, 0.1)', border: `2px solid ${isUserPick ? '#22c55e' : '#3b82f6'}` }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '1rem' }}>
                                            <div>
                                                <h2 style={{ color: isUserPick ? '#22c55e' : '#60a5fa', marginBottom: '0.5rem' }}>
                                                    Round {currentPick.round} ‚Ä¢ Pick #{currentDraftPick} (#{(currentDraftPick - 1) % 32 + 1} in Round)
                                                </h2>
                                                <p style={{ color: '#e2e8f0', fontSize: '1.2rem', fontWeight: 'bold' }}>
                                                    {isUserPick ? 'üéØ YOUR PICK!' : `Now Drafting: ${currentPick.teamName}`}
                                                </p>
                                            </div>
                                            <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>
                                                <button
                                                    onClick={() => setAutoPickMode(!autoPickMode)}
                                                    style={{
                                                        padding: '0.75rem 1.5rem',
                                                        background: autoPickMode ? '#ef4444' : '#8b5cf6',
                                                        color: '#fff',
                                                        border: 'none',
                                                        borderRadius: '0.5rem',
                                                        fontSize: '1rem',
                                                        cursor: 'pointer',
                                                        fontWeight: 'bold'
                                                    }}
                                                >
                                                    {autoPickMode ? '‚è∏Ô∏è Pause Auto-Draft' : '‚ñ∂Ô∏è Auto-Draft'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Available Prospects */}
                                    {isUserPick ? (
                                        <div className="card">
                                            <h2 style={{ marginBottom: '1.5rem' }}>üéØ Select Your Pick</h2>
                                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '1rem' }}>
                                                {availableProspects.slice(0, 20).map(prospect => (
                                                    <div
                                                        key={prospect.id}
                                                        onClick={() => makePick(prospect)}
                                                        style={{
                                                            padding: '1.5rem',
                                                            background: 'rgba(34, 197, 94, 0.1)',
                                                            border: '2px solid #22c55e',
                                                            borderRadius: '0.75rem',
                                                            cursor: 'pointer',
                                                            transition: 'all 0.2s'
                                                        }}
                                                        onMouseOver={(e) => {
                                                            e.currentTarget.style.transform = 'translateY(-4px)';
                                                            e.currentTarget.style.boxShadow = '0 8px 16px rgba(34, 197, 94, 0.3)';
                                                        }}
                                                        onMouseOut={(e) => {
                                                            e.currentTarget.style.transform = 'translateY(0)';
                                                            e.currentTarget.style.boxShadow = 'none';
                                                        }}
                                                    >
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.75rem' }}>
                                                            <div>
                                                                <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#fff' }}>
                                                                    {prospect.firstName} {prospect.lastName}
                                                                </div>
                                                                <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                                                    {prospect.position} ‚Ä¢ {prospect.age} yrs ‚Ä¢ {prospect.country}
                                                                </div>
                                                            </div>
                                                            <div style={{ 
                                                                fontSize: '1.5rem', 
                                                                fontWeight: 'bold',
                                                                color: prospect.scoutingGrade.startsWith('A') ? '#22c55e' : prospect.scoutingGrade.startsWith('B') ? '#60a5fa' : '#fbbf24',
                                                                background: 'rgba(0, 0, 0, 0.3)',
                                                                padding: '0.25rem 0.5rem',
                                                                borderRadius: '0.25rem'
                                                            }}>
                                                                {prospect.scoutingGrade}
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                                            <div>
                                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Current</div>
                                                                <div style={{ fontSize: '1.3rem', fontWeight: 'bold', color: '#60a5fa' }}>{prospect.overall}</div>
                                                            </div>
                                                            <div>
                                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Potential</div>
                                                                <div style={{ fontSize: '1.3rem', fontWeight: 'bold', color: '#22c55e' }}>{prospect.potential}</div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{ color: '#e2e8f0', fontSize: '0.85rem', lineHeight: '1.4' }}>
                                                            <strong>Rank:</strong> #{prospect.draftRank}
                                                        </div>
                                                        <div style={{ marginTop: '0.5rem' }}>
                                                            {prospect.traits.slice(0, 2).map((trait, idx) => (
                                                                <span key={idx} style={{
                                                                    display: 'inline-block',
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: 'rgba(59, 130, 246, 0.2)',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.75rem',
                                                                    marginRight: '0.25rem',
                                                                    marginTop: '0.25rem',
                                                                    color: '#93c5fd'
                                                                }}>
                                                                    {trait}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            
                                            {availableProspects.length > 20 && (
                                                <p style={{ color: '#93c5fd', marginTop: '1rem', textAlign: 'center', fontStyle: 'italic' }}>
                                                    Showing top 20 prospects. Scroll for more options.
                                                </p>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="card" style={{ textAlign: 'center' }}>
                                            <p style={{ color: '#e2e8f0', fontSize: '1.2rem', marginBottom: '1.5rem' }}>
                                                {autoPickMode ? '‚è≥ Auto-drafting...' : `Waiting for ${currentPick.teamName} to make their selection...`}
                                            </p>
                                            {!autoPickMode && (
                                                <button
                                                    onClick={makeAIPick}
                                                    style={{
                                                        padding: '0.875rem 2rem',
                                                        background: '#3b82f6',
                                                        color: '#fff',
                                                        border: 'none',
                                                        borderRadius: '0.5rem',
                                                        fontSize: '1.1rem',
                                                        cursor: 'pointer',
                                                        fontWeight: 'bold'
                                                    }}
                                                >
                                                    Simulate Pick ‚Üí
                                                </button>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* Recent Picks */}
                                    {draftResults.length > 0 && (
                                        <div className="card" style={{ marginTop: '2rem' }}>
                                            <h2 style={{ marginBottom: '1.5rem' }}>üìã Recent Picks</h2>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                                {draftResults.slice(-5).reverse().map((result, idx) => (
                                                    <div key={idx} style={{
                                                        padding: '1rem',
                                                        background: result.teamId === userTeamId ? 'rgba(34, 197, 94, 0.1)' : 'rgba(59, 130, 246, 0.05)',
                                                        border: `1px solid ${result.teamId === userTeamId ? '#22c55e' : '#334155'}`,
                                                        borderRadius: '0.5rem',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center'
                                                    }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                                            <div style={{ 
                                                                fontSize: '1.2rem', 
                                                                fontWeight: 'bold', 
                                                                color: '#fbbf24',
                                                                minWidth: '60px'
                                                            }}>
                                                                #{result.pick}
                                                            </div>
                                                            <div>
                                                                <div style={{ fontWeight: 'bold', color: '#fff' }}>
                                                                    {result.prospect.firstName} {result.prospect.lastName}
                                                                </div>
                                                                <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                                                    {result.prospect.position} ‚Ä¢ {result.prospect.overall} OVR ‚Ä¢ {result.prospect.potential} POT
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div style={{ textAlign: 'right' }}>
                                                            <div style={{ color: result.teamId === userTeamId ? '#22c55e' : '#e2e8f0', fontSize: '0.9rem' }}>
                                                                {result.teamName}
                                                            </div>
                                                            {result.teamId === userTeamId && (
                                                                <div style={{ color: '#22c55e', fontSize: '0.85rem', fontWeight: 'bold' }}>
                                                                    YOUR PICK
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })()}
                        
                        {/* Draft Complete */}
                        {draftProspects && currentDraftPick > 224 && (
                            <div className="card" style={{
                                background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2))',
                                border: '3px solid #22c55e',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üéâ</div>
                                <h1 style={{ fontSize: '2.5rem', marginBottom: '1rem', color: '#22c55e' }}>
                                    Draft Complete!
                                </h1>
                                <p style={{ color: '#e2e8f0', fontSize: '1.2rem', marginBottom: '2rem' }}>
                                    All 224 picks have been made. Your drafted players will be added to your farm team.
                                </p>
                                
                                <div style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ color: '#60a5fa', marginBottom: '1rem' }}>Your Draft Picks:</h3>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem', maxWidth: '600px', margin: '0 auto' }}>
                                        {draftResults.filter(r => r.teamId === userTeamId).map((result, idx) => (
                                            <div key={idx} style={{
                                                padding: '1rem',
                                                background: 'rgba(34, 197, 94, 0.1)',
                                                border: '2px solid #22c55e',
                                                borderRadius: '0.5rem',
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center'
                                            }}>
                                                <div style={{ textAlign: 'left' }}>
                                                    <div style={{ fontWeight: 'bold', color: '#fff', fontSize: '1.1rem' }}>
                                                        {result.prospect.firstName} {result.prospect.lastName}
                                                    </div>
                                                    <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                                        {result.prospect.position} ‚Ä¢ {result.prospect.overall} OVR ‚Üí {result.prospect.potential} POT
                                                    </div>
                                                </div>
                                                <div style={{ textAlign: 'right' }}>
                                                    <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#fbbf24' }}>
                                                        Round {result.round}
                                                    </div>
                                                    <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                                        Pick #{result.pick}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                {!draftPicksSigned ? (
                                    <button
                                        onClick={signDraftPicks}
                                        style={{
                                            padding: '1.25rem 3rem',
                                            background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.75rem',
                                            fontSize: '1.3rem',
                                            cursor: 'pointer',
                                            fontWeight: 'bold',
                                            boxShadow: '0 8px 16px rgba(34, 197, 94, 0.3)',
                                            marginBottom: '1rem'
                                        }}
                                    >
                                        ‚úçÔ∏è Sign All Draft Picks
                                    </button>
                                ) : (
                                    <div style={{ 
                                        marginBottom: '1rem',
                                        padding: '1rem',
                                        background: 'rgba(34, 197, 94, 0.2)',
                                        borderRadius: '0.5rem',
                                        border: '2px solid #22c55e'
                                    }}>
                                        <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>‚úÖ</div>
                                        <div style={{ color: '#22c55e', fontWeight: 'bold', fontSize: '1.2rem' }}>
                                            Draft Picks Signed!
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.9rem', marginTop: '0.5rem' }}>
                                            All players added to rosters with 3-year entry-level contracts
                                        </div>
                                    </div>
                                )}
                                
                                <button
                                    onClick={() => {
                                        setShowDraftReportCard(true);
                                    }}
                                    style={{
                                        padding: '1.25rem 3rem',
                                        background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.75rem',
                                        fontSize: '1.3rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        boxShadow: '0 8px 16px rgba(59, 130, 246, 0.3)'
                                    }}
                                >
                                    Continue to Free Agency ‚Üí
                                </button>
                            </div>
                        )}
                    </div>
                    );
                })()}
                
                {/* Draft Report Card Modal */}
                {showDraftReportCard && (() => {
                    const reportCard = generateDraftReportCard();
                    
                    return (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.9)',
                            zIndex: 10003,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                            <div style={{
                                background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                                border: `4px solid ${reportCard.color}`,
                                borderRadius: '1.5rem',
                                padding: '3rem',
                                maxWidth: '800px',
                                width: '90%',
                                maxHeight: '90vh',
                                overflow: 'auto',
                                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                            }}>
                                {/* Grade Display */}
                                <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                                    <div style={{ fontSize: '1.2rem', color: '#93c5fd', marginBottom: '1rem' }}>
                                        {gameState.year + 1} Entry Draft Report Card
                                    </div>
                                    <div style={{
                                        display: 'inline-block',
                                        padding: '2rem 3rem',
                                        background: `linear-gradient(135deg, ${reportCard.color}40, ${reportCard.color}20)`,
                                        border: `4px solid ${reportCard.color}`,
                                        borderRadius: '1rem',
                                        marginBottom: '1rem'
                                    }}>
                                        <div style={{
                                            fontSize: '5rem',
                                            fontWeight: 'bold',
                                            color: reportCard.color,
                                            lineHeight: '1'
                                        }}>
                                            {reportCard.grade}
                                        </div>
                                    </div>
                                    <div style={{
                                        fontSize: '1.8rem',
                                        color: reportCard.color,
                                        fontWeight: 'bold',
                                        marginBottom: '0.5rem'
                                    }}>
                                        {reportCard.summary}
                                    </div>
                                    <div style={{ color: '#93c5fd', fontSize: '1rem' }}>
                                        Draft Score: {reportCard.score}/100
                                    </div>
                                </div>

                                {/* Statistics */}
                                {reportCard.stats && (
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(2, 1fr)',
                                        gap: '1rem',
                                        marginBottom: '2rem',
                                        padding: '1.5rem',
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        borderRadius: '1rem'
                                    }}>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Total Picks</div>
                                            <div style={{ color: '#22d3ee', fontSize: '2rem', fontWeight: 'bold' }}>
                                                {reportCard.stats.totalPicks}
                                            </div>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Avg Potential</div>
                                            <div style={{ color: '#22c55e', fontSize: '2rem', fontWeight: 'bold' }}>
                                                {reportCard.stats.avgPotential.toFixed(0)}
                                            </div>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ color: '#64748b', fontSize: '0.9rem' }}>A-Grade Picks</div>
                                            <div style={{ color: '#60a5fa', fontSize: '2rem', fontWeight: 'bold' }}>
                                                {reportCard.stats.aGradePicks}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Position Breakdown */}
                                {reportCard.stats && (
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(34, 197, 94, 0.1)',
                                        borderRadius: '1rem',
                                        marginBottom: '2rem'
                                    }}>
                                        <div style={{ color: '#22c55e', fontWeight: 'bold', marginBottom: '1rem' }}>
                                            Picks by Position
                                        </div>
                                        <div style={{ display: 'flex', gap: '1.5rem', justifyContent: 'space-around' }}>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '2rem' }}>‚ö°</div>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                    {reportCard.stats.forwardsPicked}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Forwards</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '2rem' }}>üõ°Ô∏è</div>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                    {reportCard.stats.defensePicked}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Defense</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '2rem' }}>ü•Ö</div>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                    {reportCard.stats.goaliesPicked}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Goalies</div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Details */}
                                <div style={{
                                    padding: '1.5rem',
                                    background: 'rgba(100, 116, 139, 0.1)',
                                    borderRadius: '1rem',
                                    marginBottom: '2rem'
                                }}>
                                    <div style={{ color: '#22d3ee', fontWeight: 'bold', marginBottom: '1rem' }}>
                                        Scouting Analysis
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                        {reportCard.details.map((detail, idx) => (
                                            <div key={idx} style={{
                                                padding: '0.75rem',
                                                background: 'rgba(59, 130, 246, 0.1)',
                                                borderRadius: '0.5rem',
                                                color: '#e2e8f0',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '0.5rem'
                                            }}>
                                                <span style={{ color: '#60a5fa' }}>‚Ä¢</span>
                                                {detail}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Continue Button */}
                                <div style={{ textAlign: 'center' }}>
                                    <button
                                        onClick={() => {
                                            setShowDraftReportCard(false);
                                            // Initialize contracts for existing players
                                            initializePlayerContracts();
                                            // Generate free agents if not already generated
                                            if (!freeAgents) {
                                                // Get real players who became free agents (teamId === null, roster === 'fa')
                                                const realFreeAgents = gameState.players
                                                    .filter(p => p.roster === 'fa' && p.teamId === null)
                                                    .map(p => ({
                                                        ...p,
                                                        marketValue: p.contract?.salary || (p.ratings?.overall || 65) * 100000,
                                                        preferredYears: p.age > 30 ? 1 + Math.floor(Math.random() * 2) : 2 + Math.floor(Math.random() * 4),
                                                        status: 'available'
                                                    }));
                                                
                                                // Generate additional FA pool (filler players)
                                                const generatedAgents = generateFreeAgents();
                                                
                                                // Merge real players with generated pool, sort by OVR
                                                const allAgents = [...realFreeAgents, ...generatedAgents]
                                                    .sort((a, b) => b.ratings.overall - a.ratings.overall);
                                                
                                                setFreeAgents(allAgents);
                                            }
                                            setCurrentView('freeagency');
                                        }}
                                        style={{
                                            padding: '1.25rem 3rem',
                                            background: reportCard.color,
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.75rem',
                                            fontSize: '1.3rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            boxShadow: `0 8px 16px ${reportCard.color}40`
                                        }}
                                    >
                                        Continue to Free Agency ‚Üí
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                })()}
                
                {/* FREE AGENCY VIEW */}
                {currentView === 'freeagency' && (
                    <div>
                        <div className="card" style={{
                            background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.1))',
                            border: '3px solid #22c55e',
                            marginBottom: '2rem'
                        }}>
                            <div style={{ textAlign: 'center' }}>
                                <h1 style={{
                                    color: '#22c55e',
                                    fontSize: '2.5rem',
                                    marginBottom: '0.5rem'
                                }}>
                                    üíº Free Agency
                                </h1>
                                <p style={{ color: '#e2e8f0', fontSize: '1.2rem', marginBottom: '1rem' }}>
                                    Sign players to strengthen your roster
                                </p>
                                <div style={{ 
                                    display: 'flex', 
                                    justifyContent: 'center', 
                                    gap: '2rem',
                                    marginTop: '1.5rem'
                                }}>
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Salary Cap</div>
                                        <div style={{ color: '#22c55e', fontSize: '1.5rem', fontWeight: 'bold' }}>
                                            ${(83500000 / 1000000).toFixed(1)}M
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Current Payroll</div>
                                        <div style={{ color: '#60a5fa', fontSize: '1.5rem', fontWeight: 'bold' }}>
                                            ${(calculateTeamSalaryCap(gameState.players.filter(p => p.teamId === userTeamId)) / 1000000).toFixed(1)}M
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Available Space</div>
                                        <div style={{ color: '#fbbf24', fontSize: '1.5rem', fontWeight: 'bold' }}>
                                            ${((83500000 - calculateTeamSalaryCap(gameState.players.filter(p => p.teamId === userTeamId))) / 1000000).toFixed(1)}M
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>Players Signed</div>
                                        <div style={{ color: '#22c55e', fontSize: '1.5rem', fontWeight: 'bold' }}>
                                            {signedPlayers.length}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Team Needs Analysis */}
                        {(() => {
                            const teamNeeds = analyzeRosterNeeds();
                            if (!teamNeeds) return null;
                            
                            return (
                                <div className="card" style={{ marginBottom: '2rem' }}>
                                    <h2 style={{ color: '#f59e0b', marginBottom: '1.5rem' }}>
                                        üìã Team Needs & Recommendations
                                    </h2>
                                    
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>
                                        {/* Current Roster */}
                                        <div>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>Current Roster</h3>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                <div style={{ 
                                                    padding: '0.75rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    display: 'flex',
                                                    justifyContent: 'space-between'
                                                }}>
                                                    <span style={{ color: '#93c5fd' }}>Forwards:</span>
                                                    <span style={{ 
                                                        color: teamNeeds.rosterCounts.forwards >= 13 ? '#22c55e' : '#ef4444',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {teamNeeds.rosterCounts.forwards} (avg {teamNeeds.averages.forward.toFixed(0)} OVR)
                                                    </span>
                                                </div>
                                                <div style={{ 
                                                    padding: '0.75rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    display: 'flex',
                                                    justifyContent: 'space-between'
                                                }}>
                                                    <span style={{ color: '#93c5fd' }}>Defense:</span>
                                                    <span style={{ 
                                                        color: teamNeeds.rosterCounts.defense >= 6 ? '#22c55e' : '#ef4444',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {teamNeeds.rosterCounts.defense} (avg {teamNeeds.averages.defense.toFixed(0)} OVR)
                                                    </span>
                                                </div>
                                                <div style={{ 
                                                    padding: '0.75rem',
                                                    background: 'rgba(59, 130, 246, 0.1)',
                                                    borderRadius: '0.5rem',
                                                    display: 'flex',
                                                    justifyContent: 'space-between'
                                                }}>
                                                    <span style={{ color: '#93c5fd' }}>Goalies:</span>
                                                    <span style={{ 
                                                        color: teamNeeds.rosterCounts.goalies >= 2 ? '#22c55e' : '#ef4444',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        {teamNeeds.rosterCounts.goalies} (avg {teamNeeds.averages.goalie.toFixed(0)} OVR)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Priority Needs */}
                                        <div>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>Priority Needs</h3>
                                            {teamNeeds.needs.length === 0 ? (
                                                <div style={{ 
                                                    padding: '1rem',
                                                    background: 'rgba(34, 197, 94, 0.1)',
                                                    border: '2px solid #22c55e',
                                                    borderRadius: '0.5rem',
                                                    color: '#22c55e',
                                                    textAlign: 'center'
                                                }}>
                                                    ‚úÖ No critical needs! Roster is well-balanced.
                                                </div>
                                            ) : (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                                    {teamNeeds.needs.map((need, idx) => (
                                                        <div key={idx} style={{
                                                            padding: '0.75rem',
                                                            background: need.priority === 'CRITICAL' ? 'rgba(239, 68, 68, 0.1)' :
                                                                        need.priority === 'HIGH' ? 'rgba(251, 191, 36, 0.1)' : 
                                                                        'rgba(59, 130, 246, 0.1)',
                                                            border: `2px solid ${need.priority === 'CRITICAL' ? '#ef4444' :
                                                                                 need.priority === 'HIGH' ? '#fbbf24' : '#3b82f6'}`,
                                                            borderRadius: '0.5rem'
                                                        }}>
                                                            <div style={{ 
                                                                display: 'flex',
                                                                justifyContent: 'space-between',
                                                                alignItems: 'center'
                                                            }}>
                                                                <span style={{
                                                                    padding: '0.25rem 0.5rem',
                                                                    background: need.priority === 'CRITICAL' ? '#ef4444' :
                                                                               need.priority === 'HIGH' ? '#fbbf24' : '#3b82f6',
                                                                    borderRadius: '0.25rem',
                                                                    fontSize: '0.75rem',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {need.priority}
                                                                </span>
                                                                <span style={{ 
                                                                    color: '#e2e8f0',
                                                                    fontWeight: 'bold'
                                                                }}>
                                                                    {need.position}
                                                                </span>
                                                            </div>
                                                            <div style={{ 
                                                                color: '#93c5fd',
                                                                fontSize: '0.85rem',
                                                                marginTop: '0.5rem'
                                                            }}>
                                                                {need.reason}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Recommendations */}
                                    {teamNeeds.recommendations.length > 0 && (
                                        <div style={{ marginTop: '1.5rem' }}>
                                            <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>üí° GM Recommendations</h3>
                                            <div style={{ 
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '0.5rem'
                                            }}>
                                                {teamNeeds.recommendations.map((rec, idx) => (
                                                    <div key={idx} style={{
                                                        padding: '0.75rem 1rem',
                                                        background: 'rgba(34, 211, 238, 0.1)',
                                                        border: '2px solid #22d3ee',
                                                        borderRadius: '0.5rem',
                                                        color: '#e2e8f0',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '0.5rem'
                                                    }}>
                                                        <span style={{ color: '#22d3ee' }}>‚Üí</span>
                                                        {rec}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })()}

                        {/* Available Free Agents */}
                        <div className="card">
                            <h2 style={{ color: '#22d3ee', marginBottom: '1.5rem' }}>
                                Available Free Agents ({freeAgents?.filter(fa => fa.status === 'available').length || 0})
                            </h2>
                            
                            <div style={{ 
                                display: 'grid', 
                                gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', 
                                gap: '1rem' 
                            }}>
                                {freeAgents?.filter(fa => fa.status === 'available').map(fa => (
                                    <div
                                        key={fa.id}
                                        onClick={() => setSelectedFreeAgent(fa)}
                                        style={{
                                            padding: '1rem',
                                            background: 'linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(30, 64, 175, 0.2))',
                                            border: '2px solid #3b82f6',
                                            borderRadius: '0.75rem',
                                            cursor: 'pointer',
                                            transition: 'all 0.2s'
                                        }}
                                        onMouseEnter={(e) => {
                                            e.currentTarget.style.transform = 'translateY(-4px)';
                                            e.currentTarget.style.boxShadow = '0 8px 16px rgba(59, 130, 246, 0.3)';
                                            e.currentTarget.style.borderColor = '#60a5fa';
                                        }}
                                        onMouseLeave={(e) => {
                                            e.currentTarget.style.transform = 'translateY(0)';
                                            e.currentTarget.style.boxShadow = 'none';
                                            e.currentTarget.style.borderColor = '#3b82f6';
                                        }}
                                    >
                                        <div style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between',
                                            alignItems: 'flex-start',
                                            marginBottom: '0.75rem'
                                        }}>
                                            <div>
                                                <div style={{ 
                                                    color: '#22d3ee', 
                                                    fontWeight: 'bold',
                                                    fontSize: '1.1rem'
                                                }}>
                                                    {fa.firstName} {fa.lastName}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>
                                                    {fa.position} ‚Ä¢ Age {fa.age}
                                                </div>
                                            </div>
                                            <div style={{
                                                padding: '0.25rem 0.75rem',
                                                background: (fa.ratings?.overall || 65) >= 80 ? '#22c55e' : (fa.ratings?.overall || 65) >= 75 ? '#3b82f6' : '#64748b',
                                                borderRadius: '0.5rem',
                                                fontWeight: 'bold',
                                                fontSize: '1.1rem'
                                            }}>
                                                {fa.ratings?.overall || 65}
                                            </div>
                                        </div>
                                        
                                        <div style={{ 
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            paddingTop: '0.75rem',
                                            borderTop: '1px solid rgba(100, 116, 139, 0.3)'
                                        }}>
                                            <div>
                                                <div style={{ color: '#64748b', fontSize: '0.75rem' }}>Market Value</div>
                                                <div style={{ color: '#22c55e', fontWeight: 'bold' }}>
                                                    ${fa.marketValue ? (fa.marketValue / 1000000).toFixed(1) : '0.0'}M/yr
                                                </div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#64748b', fontSize: '0.75rem' }}>Prefers</div>
                                                <div style={{ color: '#93c5fd', fontWeight: 'bold' }}>
                                                    {fa.preferredYears || 3} year{(fa.preferredYears || 3) > 1 ? 's' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Signed Players Summary */}
                        {signedPlayers.length > 0 && (
                            <div className="card" style={{ marginTop: '2rem' }}>
                                <h2 style={{ color: '#22c55e', marginBottom: '1.5rem' }}>
                                    ‚úÖ Players Signed This Offseason ({signedPlayers.length})
                                </h2>
                                <table className="stats-table">
                                    <thead>
                                        <tr>
                                            <th>Player</th>
                                            <th>Pos</th>
                                            <th>Age</th>
                                            <th>OVR</th>
                                            <th>Years</th>
                                            <th>Salary/Year</th>
                                            <th>Total Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {signedPlayers.map((signing, idx) => (
                                            <tr key={idx}>
                                                <td style={{ fontWeight: 'bold' }}>
                                                    {signing.player.firstName} {signing.player.lastName}
                                                </td>
                                                <td>{signing.player.position}</td>
                                                <td>{signing.player.age}</td>
                                                <td>{signing.player.ratings.overall}</td>
                                                <td>{signing.years}</td>
                                                <td>${(signing.salary / 1000000).toFixed(1)}M</td>
                                                <td>${(signing.years * signing.salary / 1000000).toFixed(1)}M</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {/* Continue Button */}
                        <div style={{ textAlign: 'center', marginTop: '3rem' }}>
                            <button
                                onClick={() => {
                                    setShowReportCard(true);
                                }}
                                style={{
                                    padding: '1.25rem 3rem',
                                    background: 'linear-gradient(135deg, #22c55e, #16a34a)',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.75rem',
                                    fontSize: '1.3rem',
                                    cursor: 'pointer',
                                    fontWeight: 'bold',
                                    boxShadow: '0 8px 16px rgba(34, 197, 94, 0.3)'
                                }}
                            >
                                Finish Free Agency ‚Üí
                            </button>
                        </div>
                    </div>
                )}

                {/* Free Agency Report Card Modal */}
                {showReportCard && (() => {
                    const reportCard = generateFreeAgencyReportCard();
                    
                    return (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.9)',
                            zIndex: 10003,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                            <div style={{
                                background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                                border: `4px solid ${reportCard.color}`,
                                borderRadius: '1.5rem',
                                padding: '3rem',
                                maxWidth: '800px',
                                width: '90%',
                                maxHeight: '90vh',
                                overflow: 'auto',
                                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                            }}>
                                {/* Grade Display */}
                                <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                                    <div style={{ fontSize: '1.2rem', color: '#93c5fd', marginBottom: '1rem' }}>
                                        Free Agency Report Card
                                    </div>
                                    <div style={{
                                        display: 'inline-block',
                                        padding: '2rem 3rem',
                                        background: `linear-gradient(135deg, ${reportCard.color}40, ${reportCard.color}20)`,
                                        border: `4px solid ${reportCard.color}`,
                                        borderRadius: '1rem',
                                        marginBottom: '1rem'
                                    }}>
                                        <div style={{
                                            fontSize: '5rem',
                                            fontWeight: 'bold',
                                            color: reportCard.color,
                                            lineHeight: '1'
                                        }}>
                                            {reportCard.grade}
                                        </div>
                                    </div>
                                    <div style={{
                                        fontSize: '1.8rem',
                                        color: reportCard.color,
                                        fontWeight: 'bold',
                                        marginBottom: '0.5rem'
                                    }}>
                                        {reportCard.summary}
                                    </div>
                                    <div style={{ color: '#93c5fd', fontSize: '1rem' }}>
                                        Score: {reportCard.score}/100
                                    </div>
                                </div>

                                {/* Statistics */}
                                {reportCard.stats && (
                                    <div style={{
                                        display: 'grid',
                                        gridTemplateColumns: 'repeat(2, 1fr)',
                                        gap: '1rem',
                                        marginBottom: '2rem',
                                        padding: '1.5rem',
                                        background: 'rgba(59, 130, 246, 0.1)',
                                        borderRadius: '1rem'
                                    }}>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Total Signings</div>
                                            <div style={{ color: '#22d3ee', fontSize: '2rem', fontWeight: 'bold' }}>
                                                {reportCard.stats.totalSignings}
                                            </div>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Total Spent</div>
                                            <div style={{ color: '#22c55e', fontSize: '2rem', fontWeight: 'bold' }}>
                                                ${(reportCard.stats.totalSpent / 1000000).toFixed(1)}M
                                            </div>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Avg OVR</div>
                                            <div style={{ color: '#60a5fa', fontSize: '2rem', fontWeight: 'bold' }}>
                                                {reportCard.stats.avgOVR.toFixed(0)}
                                            </div>
                                        </div>
                                        <div style={{ textAlign: 'center' }}>
                                            <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Avg Age</div>
                                            <div style={{ color: '#fbbf24', fontSize: '2rem', fontWeight: 'bold' }}>
                                                {reportCard.stats.avgAge.toFixed(1)}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Position Breakdown */}
                                {reportCard.stats && (
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(34, 197, 94, 0.1)',
                                        borderRadius: '1rem',
                                        marginBottom: '2rem'
                                    }}>
                                        <div style={{ color: '#22c55e', fontWeight: 'bold', marginBottom: '1rem' }}>
                                            Signings by Position
                                        </div>
                                        <div style={{ display: 'flex', gap: '1.5rem', justifyContent: 'space-around' }}>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '2rem' }}>‚ö°</div>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                    {reportCard.stats.forwardsSigned}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Forwards</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '2rem' }}>üõ°Ô∏è</div>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                    {reportCard.stats.defenseSigned}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Defense</div>
                                            </div>
                                            <div style={{ textAlign: 'center' }}>
                                                <div style={{ fontSize: '2rem' }}>ü•Ö</div>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                    {reportCard.stats.goaliesSigned}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>Goalies</div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Details */}
                                <div style={{
                                    padding: '1.5rem',
                                    background: 'rgba(100, 116, 139, 0.1)',
                                    borderRadius: '1rem',
                                    marginBottom: '2rem'
                                }}>
                                    <div style={{ color: '#22d3ee', fontWeight: 'bold', marginBottom: '1rem' }}>
                                        Analysis
                                    </div>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                        {reportCard.details.map((detail, idx) => (
                                            <div key={idx} style={{
                                                padding: '0.75rem',
                                                background: 'rgba(59, 130, 246, 0.1)',
                                                borderRadius: '0.5rem',
                                                color: '#e2e8f0',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '0.5rem'
                                            }}>
                                                <span style={{ color: '#60a5fa' }}>‚Ä¢</span>
                                                {detail}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Close Button */}
                                <div style={{ textAlign: 'center' }}>
                                    <button
                                        onClick={() => {
                                            setShowReportCard(false);
                                            const previewData = generateSeasonPreview();
                                            setSeasonPreviewData(previewData);
                                            setShowSeasonPreview(true);
                                        }}
                                        style={{
                                            padding: '1.25rem 3rem',
                                            background: reportCard.color,
                                            color: '#fff',
                                            border: 'none',
                                            borderRadius: '0.75rem',
                                            fontSize: '1.3rem',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            boxShadow: `0 8px 16px ${reportCard.color}40`
                                        }}
                                    >
                                        Continue to Season Preview ‚Üí
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                })()}

                {/* Season Preview Modal */}
                {showSeasonPreview && seasonPreviewData && (
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0, 0, 0, 0.95)',
                        zIndex: 10004,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        overflow: 'auto',
                        padding: '2rem 0'
                    }}>
                        <div style={{
                            background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                            border: `4px solid ${seasonPreviewData.expectationColor}`,
                            borderRadius: '1.5rem',
                            padding: '3rem',
                            maxWidth: '1000px',
                            width: '90%',
                            maxHeight: '90vh',
                            overflow: 'auto',
                            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                        }}>
                            {/* Header */}
                            <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                                <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üèí</div>
                                <h1 style={{ 
                                    color: seasonPreviewData.expectationColor, 
                                    fontSize: '2.5rem',
                                    marginBottom: '0.5rem'
                                }}>
                                    {seasonPreviewData.year} Season Preview
                                </h1>
                                <div style={{
                                    display: 'inline-block',
                                    padding: '0.75rem 2rem',
                                    background: `${seasonPreviewData.expectationColor}20`,
                                    border: `2px solid ${seasonPreviewData.expectationColor}`,
                                    borderRadius: '0.75rem',
                                    fontSize: '1.5rem',
                                    fontWeight: 'bold',
                                    color: seasonPreviewData.expectationColor,
                                    marginTop: '1rem'
                                }}>
                                    {seasonPreviewData.expectation}
                                </div>
                            </div>

                            {/* Team Overview */}
                            <div style={{
                                padding: '1.5rem',
                                background: 'rgba(59, 130, 246, 0.1)',
                                borderRadius: '1rem',
                                marginBottom: '2rem'
                            }}>
                                <h2 style={{ color: '#22d3ee', marginBottom: '1.5rem' }}>Team Overview</h2>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem' }}>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Team Avg OVR</div>
                                        <div style={{ 
                                            color: seasonPreviewData.newAvgOVR > seasonPreviewData.oldAvgOVR ? '#22c55e' : '#ef4444',
                                            fontSize: '2rem',
                                            fontWeight: 'bold'
                                        }}>
                                            {seasonPreviewData.newAvgOVR.toFixed(1)}
                                            <span style={{ fontSize: '1rem', marginLeft: '0.5rem' }}>
                                                ({seasonPreviewData.newAvgOVR > seasonPreviewData.oldAvgOVR ? '+' : ''}{(seasonPreviewData.newAvgOVR - seasonPreviewData.oldAvgOVR).toFixed(1)})
                                            </span>
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Forwards</div>
                                        <div style={{ color: '#22d3ee', fontSize: '2rem', fontWeight: 'bold' }}>
                                            {seasonPreviewData.positionAverages.forward.toFixed(1)}
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Defense</div>
                                        <div style={{ color: '#3b82f6', fontSize: '2rem', fontWeight: 'bold' }}>
                                            {seasonPreviewData.positionAverages.defense.toFixed(1)}
                                        </div>
                                    </div>
                                    <div style={{ textAlign: 'center' }}>
                                        <div style={{ color: '#64748b', fontSize: '0.9rem' }}>Goalies</div>
                                        <div style={{ color: '#fbbf24', fontSize: '2rem', fontWeight: 'bold' }}>
                                            {seasonPreviewData.positionAverages.goalie.toFixed(1)}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Top 5 Players */}
                            <div style={{
                                padding: '1.5rem',
                                background: 'rgba(34, 197, 94, 0.1)',
                                borderRadius: '1rem',
                                marginBottom: '2rem'
                            }}>
                                <h2 style={{ color: '#22c55e', marginBottom: '1.5rem' }}>‚≠ê Top 5 Players</h2>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                                    {seasonPreviewData.topPlayers.map((pd, idx) => (
                                        <div key={idx} style={{
                                            padding: '1rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            borderRadius: '0.5rem',
                                            display: 'flex',
                                            justifyContent: 'space-between',
                                            alignItems: 'center'
                                        }}>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                    {idx + 1}. {pd.player.firstName} {pd.player.lastName}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                                    {pd.player.position} ‚Ä¢ Age {pd.development.age}
                                                </div>
                                            </div>
                                            <div style={{ textAlign: 'right' }}>
                                                <div style={{ 
                                                    fontSize: '1.5rem',
                                                    fontWeight: 'bold',
                                                    color: pd.development.newOVR >= 85 ? '#22c55e' : '#3b82f6'
                                                }}>
                                                    {pd.development.newOVR}
                                                </div>
                                                {pd.development.change !== 0 && (
                                                    <div style={{ 
                                                        fontSize: '0.9rem',
                                                        color: pd.development.change > 0 ? '#22c55e' : '#ef4444'
                                                    }}>
                                                        {pd.development.change > 0 ? '+' : ''}{pd.development.change}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Player Development Changes */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginBottom: '2rem' }}>
                                {/* Improvements */}
                                {seasonPreviewData.improvements.length > 0 && (
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(34, 197, 94, 0.1)',
                                        border: '2px solid #22c55e',
                                        borderRadius: '1rem'
                                    }}>
                                        <h3 style={{ color: '#22c55e', marginBottom: '1rem' }}>
                                            üìà Breakout Players ({seasonPreviewData.improvements.length})
                                        </h3>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', maxHeight: '200px', overflow: 'auto' }}>
                                            {seasonPreviewData.improvements.map((pd, idx) => (
                                                <div key={idx} style={{
                                                    padding: '0.75rem',
                                                    background: 'rgba(34, 197, 94, 0.1)',
                                                    borderRadius: '0.5rem'
                                                }}>
                                                    <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                        {pd.player.firstName} {pd.player.lastName}
                                                    </div>
                                                    <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>
                                                        {pd.development.oldOVR} ‚Üí {pd.development.newOVR} (+{pd.development.change})
                                                    </div>
                                                    <div style={{ color: '#64748b', fontSize: '0.8rem' }}>
                                                        {pd.development.reason}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Declines */}
                                {seasonPreviewData.declines.length > 0 && (
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(239, 68, 68, 0.1)',
                                        border: '2px solid #ef4444',
                                        borderRadius: '1rem'
                                    }}>
                                        <h3 style={{ color: '#ef4444', marginBottom: '1rem' }}>
                                            üìâ Declining Players ({seasonPreviewData.declines.length})
                                        </h3>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', maxHeight: '200px', overflow: 'auto' }}>
                                            {seasonPreviewData.declines.map((pd, idx) => (
                                                <div key={idx} style={{
                                                    padding: '0.75rem',
                                                    background: 'rgba(239, 68, 68, 0.1)',
                                                    borderRadius: '0.5rem'
                                                }}>
                                                    <div style={{ color: '#e2e8f0', fontWeight: 'bold' }}>
                                                        {pd.player.firstName} {pd.player.lastName}
                                                    </div>
                                                    <div style={{ color: '#93c5fd', fontSize: '0.85rem' }}>
                                                        {pd.development.oldOVR} ‚Üí {pd.development.newOVR} ({pd.development.change})
                                                    </div>
                                                    <div style={{ color: '#64748b', fontSize: '0.8rem' }}>
                                                        {pd.development.reason}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Young Stars */}
                            {seasonPreviewData.youngStars.length > 0 && (
                                <div style={{
                                    padding: '1.5rem',
                                    background: 'rgba(34, 211, 238, 0.1)',
                                    border: '2px solid #22d3ee',
                                    borderRadius: '1rem',
                                    marginBottom: '2rem'
                                }}>
                                    <h3 style={{ color: '#22d3ee', marginBottom: '1rem' }}>
                                        üåü Rising Stars ({seasonPreviewData.youngStars.length})
                                    </h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '0.75rem' }}>
                                        {seasonPreviewData.youngStars.slice(0, 6).map((pd, idx) => (
                                            <div key={idx} style={{
                                                padding: '0.75rem',
                                                background: 'rgba(34, 211, 238, 0.1)',
                                                borderRadius: '0.5rem',
                                                textAlign: 'center'
                                            }}>
                                                <div style={{ color: '#e2e8f0', fontWeight: 'bold', fontSize: '0.95rem' }}>
                                                    {pd.player.firstName} {pd.player.lastName}
                                                </div>
                                                <div style={{ color: '#22d3ee', fontSize: '1.3rem', fontWeight: 'bold' }}>
                                                    {pd.development.newOVR}
                                                </div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.8rem' }}>
                                                    Age {pd.development.age} ‚Ä¢ +{pd.development.change}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Start Season Button */}
                            <div style={{ textAlign: 'center' }}>
                                <button
                                    onClick={() => {
                                        // Validate farm roster size before starting season
                                        const farmTeam = FARM_TEAMS.find(t => t.nhlAffiliation === userTeamId);
                                        const userFarmRoster = farmTeam ? gameState.players.filter(p => 
                                            p.teamId === farmTeam.id && 
                                            p.roster === 'farm'
                                        ) : [];
                                        
                                        if (userFarmRoster.length > ROSTER_LIMITS.FARM) {
                                            const overBy = userFarmRoster.length - ROSTER_LIMITS.FARM;
                                            alert(`‚ùå Cannot Start Season!\n\nYour farm team has ${userFarmRoster.length} players (limit: ${ROSTER_LIMITS.FARM}).\n\nYou must release ${overBy} player${overBy > 1 ? 's' : ''} before starting the season.\n\nüìç Go to: My Team ‚Üí Farm Team Roster to release players.`);
                                            setCurrentView('farmRoster');
                                            setShowSeasonPreview(false);
                                            return;
                                        }
                                        
                                        setShowSeasonPreview(false);
                                        startNewSeason();
                                    }}
                                    style={{
                                        padding: '1.25rem 3rem',
                                        background: `linear-gradient(135deg, ${seasonPreviewData.expectationColor}, ${seasonPreviewData.expectationColor}dd)`,
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.75rem',
                                        fontSize: '1.3rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        boxShadow: `0 8px 16px ${seasonPreviewData.expectationColor}60`
                                    }}
                                >
                                    üèÅ Start {seasonPreviewData.year} Season
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Contract Offer Modal */}
                {selectedFreeAgent && (
                    <div style={{
                        position: 'fixed',
                        top: 0,
                        left: 0,
                        right: 0,
                        bottom: 0,
                        background: 'rgba(0, 0, 0, 0.85)',
                        zIndex: 10002,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                    }}>
                        <div style={{
                            background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                            border: '3px solid #3b82f6',
                            borderRadius: '1rem',
                            padding: '2rem',
                            maxWidth: '600px',
                            width: '90%',
                            maxHeight: '90vh',
                            overflowY: 'auto',
                            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                        }}>
                            <h2 style={{ 
                                color: '#22d3ee', 
                                marginBottom: '1.5rem',
                                fontSize: '1.8rem',
                                textAlign: 'center'
                            }}>
                                Make Contract Offer
                            </h2>
                            
                            {/* Player Info */}
                            <div style={{
                                padding: '1.5rem',
                                background: 'rgba(59, 130, 246, 0.1)',
                                borderRadius: '0.75rem',
                                marginBottom: '2rem',
                                border: '2px solid #3b82f6'
                            }}>
                                <div style={{ 
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    marginBottom: '1rem'
                                }}>
                                    <div>
                                        <div style={{ 
                                            color: '#22d3ee',
                                            fontSize: '1.5rem',
                                            fontWeight: 'bold'
                                        }}>
                                            {selectedFreeAgent.firstName} {selectedFreeAgent.lastName}
                                        </div>
                                        <div style={{ color: '#93c5fd' }}>
                                            {selectedFreeAgent.position} ‚Ä¢ Age {selectedFreeAgent.age}
                                        </div>
                                    </div>
                                    <div style={{
                                        padding: '0.5rem 1rem',
                                        background: selectedFreeAgent.ratings.overall >= 80 ? '#22c55e' : '#3b82f6',
                                        borderRadius: '0.5rem',
                                        fontSize: '2rem',
                                        fontWeight: 'bold'
                                    }}>
                                        {selectedFreeAgent.ratings.overall}
                                    </div>
                                </div>
                                <div style={{ 
                                    display: 'grid',
                                    gridTemplateColumns: '1fr 1fr',
                                    gap: '1rem',
                                    paddingTop: '1rem',
                                    borderTop: '1px solid rgba(100, 116, 139, 0.3)'
                                }}>
                                    <div>
                                        <div style={{ color: '#64748b', fontSize: '0.85rem' }}>Market Value</div>
                                        <div style={{ color: '#22c55e', fontSize: '1.3rem', fontWeight: 'bold' }}>
                                            ${selectedFreeAgent.marketValue ? (selectedFreeAgent.marketValue / 1000000).toFixed(1) : '0.0'}M/year
                                        </div>
                                    </div>
                                    <div>
                                        <div style={{ color: '#64748b', fontSize: '0.85rem' }}>Prefers</div>
                                        <div style={{ color: '#93c5fd', fontSize: '1.3rem', fontWeight: 'bold' }}>
                                            {selectedFreeAgent.preferredYears || 3} year{(selectedFreeAgent.preferredYears || 3) > 1 ? 's' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Contract Inputs */}
                            <div style={{ marginBottom: '2rem' }}>
                                <div style={{ marginBottom: '1.5rem' }}>
                                    <label style={{ 
                                        display: 'block',
                                        color: '#93c5fd',
                                        marginBottom: '0.5rem',
                                        fontSize: '1.1rem'
                                    }}>
                                        Contract Length: {offerYears} year{offerYears > 1 ? 's' : ''}
                                    </label>
                                    <input
                                        type="range"
                                        min="1"
                                        max="7"
                                        value={offerYears}
                                        onChange={(e) => setOfferYears(parseInt(e.target.value))}
                                        style={{
                                            width: '100%',
                                            height: '8px',
                                            borderRadius: '4px',
                                            background: '#334155',
                                            cursor: 'pointer'
                                        }}
                                    />
                                    <div style={{ 
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        color: '#64748b',
                                        fontSize: '0.85rem',
                                        marginTop: '0.25rem'
                                    }}>
                                        <span>1 year</span>
                                        <span>7 years</span>
                                    </div>
                                </div>

                                <div style={{ marginBottom: '1.5rem' }}>
                                    <label style={{ 
                                        display: 'block',
                                        color: '#93c5fd',
                                        marginBottom: '0.5rem',
                                        fontSize: '1.1rem'
                                    }}>
                                        Annual Salary: ${(offerSalary / 1000000).toFixed(1)}M
                                    </label>
                                    <input
                                        type="range"
                                        min="700000"
                                        max="15000000"
                                        step="100000"
                                        value={offerSalary}
                                        onChange={(e) => setOfferSalary(parseInt(e.target.value))}
                                        style={{
                                            width: '100%',
                                            height: '8px',
                                            borderRadius: '4px',
                                            background: '#334155',
                                            cursor: 'pointer'
                                        }}
                                    />
                                    <div style={{ 
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        color: '#64748b',
                                        fontSize: '0.85rem',
                                        marginTop: '0.25rem'
                                    }}>
                                        <span>$0.7M</span>
                                        <span>$15.0M</span>
                                    </div>
                                </div>

                                {/* Offer Summary */}
                                <div style={{
                                    padding: '1rem',
                                    background: 'rgba(34, 211, 238, 0.1)',
                                    border: '2px solid #22d3ee',
                                    borderRadius: '0.5rem'
                                }}>
                                    <div style={{ 
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        marginBottom: '0.5rem'
                                    }}>
                                        <span style={{ color: '#93c5fd' }}>Total Contract Value:</span>
                                        <span style={{ color: '#22c55e', fontWeight: 'bold', fontSize: '1.2rem' }}>
                                            ${(offerYears * offerSalary / 1000000).toFixed(1)}M
                                        </span>
                                    </div>
                                    <div style={{ 
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        fontSize: '0.9rem'
                                    }}>
                                        <span style={{ color: '#64748b' }}>vs. Market Value:</span>
                                        <span style={{ 
                                            color: offerSalary > selectedFreeAgent.marketValue ? '#22c55e' : '#ef4444',
                                            fontWeight: 'bold'
                                        }}>
                                            {selectedFreeAgent.marketValue > 0 ? (
                                                <>
                                                    {offerSalary > selectedFreeAgent.marketValue ? '+' : ''}
                                                    {((offerSalary / selectedFreeAgent.marketValue - 1) * 100).toFixed(0)}%
                                                </>
                                            ) : (
                                                'N/A'
                                            )}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div style={{ display: 'flex', gap: '1rem' }}>
                                <button
                                    onClick={() => {
                                        signFreeAgent(selectedFreeAgent, offerYears, offerSalary);
                                    }}
                                    style={{
                                        flex: 1,
                                        padding: '1rem',
                                        background: '#22c55e',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.5rem',
                                        fontSize: '1.2rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Make Offer
                                </button>
                                <button
                                    onClick={() => {
                                        setSelectedFreeAgent(null);
                                        setOfferYears(1);
                                        setOfferSalary(1000000);
                                    }}
                                    style={{
                                        flex: 1,
                                        padding: '1rem',
                                        background: '#64748b',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.5rem',
                                        fontSize: '1.2rem',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }}
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* SEASON SUMMARY VIEW */}
                {currentView === 'seasonSummary' && seasonSummary && (
                    <div>
                        {/* 1. Season Overview */}
                        <div className="card" style={{
                            background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.2))',
                            border: '3px solid #3b82f6',
                            marginBottom: '2rem'
                        }}>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>üìä</div>
                                <h1 style={{ fontSize: '2.5rem', marginBottom: '0.5rem', color: '#60a5fa' }}>
                                    {seasonSummary.overview.year}-{(seasonSummary.overview.year + 1).toString().slice(-2)} Season Complete
                                </h1>
                                <div style={{ fontSize: '1.8rem', color: '#fff', marginBottom: '1rem' }}>
                                    Record: {seasonSummary.overview.record} ({seasonSummary.overview.points} pts)
                                </div>
                                <div style={{ fontSize: '1.2rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                    Division: {seasonSummary.overview.divisionRank}{getOrdinalSuffix(seasonSummary.overview.divisionRank)} ‚Ä¢ Conference: {seasonSummary.overview.conferenceRank}{getOrdinalSuffix(seasonSummary.overview.conferenceRank)}
                                </div>
                                <div style={{ 
                                    fontSize: '1.3rem', 
                                    color: seasonSummary.overview.playoffResult.includes('Champions') ? '#fbbf24' : 
                                           seasonSummary.overview.playoffResult.includes('Missed') ? '#ef4444' : '#22d3ee',
                                    fontWeight: 'bold',
                                    marginTop: '1rem'
                                }}>
                                    {seasonSummary.overview.playoffResult}
                                </div>
                            </div>
                        </div>
                        
                        {/* 2. Team Story */}
                        <div className="card" style={{ marginBottom: '2rem', textAlign: 'center' }}>
                            <p style={{ fontSize: '1.5rem', fontStyle: 'italic', color: '#e2e8f0', lineHeight: '1.8' }}>
                                "{seasonSummary.teamStory}"
                            </p>
                        </div>
                        
                        {/* 3. Top Players */}
                        <div className="card" style={{ marginBottom: '2rem' }}>
                            <h2 style={{ marginBottom: '1.5rem', fontSize: '1.8rem' }}>‚≠ê Top Performers</h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '1rem' }}>
                                {seasonSummary.topPlayers.mvp && (
                                    <div style={{
                                        background: 'rgba(34, 197, 94, 0.2)',
                                        border: '2px solid #22c55e',
                                        borderRadius: '0.75rem',
                                        padding: '1.5rem'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#22c55e', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                            üëë TEAM MVP
                                        </div>
                                        <div style={{ fontSize: '1.3rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                            {seasonSummary.topPlayers.mvp.firstName} {seasonSummary.topPlayers.mvp.lastName}
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.95rem' }}>
                                            {seasonSummary.topPlayers.mvp.position} ‚Ä¢ {seasonSummary.topPlayers.mvp.ratings.overall} OVR
                                        </div>
                                        <div style={{ color: '#e2e8f0', marginTop: '0.5rem' }}>
                                            {seasonSummary.topPlayers.mvp.position === 'G' 
                                                ? `${seasonSummary.topPlayers.mvp.stats?.wins} Wins, ${seasonSummary.topPlayers.mvp.stats.savePercentage.toFixed(3)} SV%`
                                                : `${seasonSummary.topPlayers.mvp.stats.points} Points (${seasonSummary.topPlayers.mvp.stats.goals}G, ${seasonSummary.topPlayers.mvp.stats.assists}A)`
                                            }
                                        </div>
                                    </div>
                                )}
                                
                                {seasonSummary.topPlayers.breakout && (
                                    <div style={{
                                        background: 'rgba(59, 130, 246, 0.2)',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '0.75rem',
                                        padding: '1.5rem'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#60a5fa', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                            üìà BREAKOUT PLAYER
                                        </div>
                                        <div style={{ fontSize: '1.3rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                            {seasonSummary.topPlayers.breakout.firstName} {seasonSummary.topPlayers.breakout.lastName}
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.95rem' }}>
                                            {seasonSummary.topPlayers.breakout.lastYearOVR} ‚Üí {seasonSummary.topPlayers.breakout.ratings.overall} OVR
                                        </div>
                                        <div style={{ color: '#22c55e', marginTop: '0.5rem', fontWeight: 'bold' }}>
                                            +{seasonSummary.topPlayers.breakout.ovrGain} improvement
                                        </div>
                                    </div>
                                )}
                                
                                {seasonSummary.topPlayers.declining && (
                                    <div style={{
                                        background: 'rgba(239, 68, 68, 0.2)',
                                        border: '2px solid #ef4444',
                                        borderRadius: '0.75rem',
                                        padding: '1.5rem'
                                    }}>
                                        <div style={{ fontSize: '0.875rem', color: '#ef4444', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                            üìâ DECLINING PLAYER
                                        </div>
                                        <div style={{ fontSize: '1.3rem', fontWeight: 'bold', marginBottom: '0.5rem' }}>
                                            {seasonSummary.topPlayers.declining.firstName} {seasonSummary.topPlayers.declining.lastName}
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.95rem' }}>
                                            {seasonSummary.topPlayers.declining.lastYearOVR} ‚Üí {seasonSummary.topPlayers.declining.ratings.overall} OVR
                                        </div>
                                        <div style={{ color: '#ef4444', marginTop: '0.5rem', fontWeight: 'bold' }}>
                                            -{seasonSummary.topPlayers.declining.ovrLoss} decline
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* 4. Team Strengths */}
                        <div className="card" style={{ marginBottom: '2rem' }}>
                            <h2 style={{ marginBottom: '1.5rem', fontSize: '1.8rem' }}>üí™ Team Performance</h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '1rem' }}>
                                <div style={{ textAlign: 'center', padding: '1rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '0.5rem' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                        OFFENSE
                                    </div>
                                    <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: '#60a5fa' }}>
                                        {seasonSummary.teamStrengths.offense}{getOrdinalSuffix(seasonSummary.teamStrengths.offense)}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: '#e2e8f0' }}>
                                        League Rank
                                    </div>
                                </div>
                                <div style={{ textAlign: 'center', padding: '1rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '0.5rem' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                        DEFENSE
                                    </div>
                                    <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: '#60a5fa' }}>
                                        {seasonSummary.teamStrengths.defense}{getOrdinalSuffix(seasonSummary.teamStrengths.defense)}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: '#e2e8f0' }}>
                                        League Rank
                                    </div>
                                </div>
                                <div style={{ textAlign: 'center', padding: '1rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '0.5rem' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                        GOALTENDING
                                    </div>
                                    <div style={{ fontSize: '2.5rem', fontWeight: 'bold', color: '#60a5fa' }}>
                                        {seasonSummary.teamStrengths.goaltending}
                                    </div>
                                    <div style={{ fontSize: '0.875rem', color: '#e2e8f0' }}>
                                        Avg OVR
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* 5. League Snapshot */}
                        <div className="card" style={{ marginBottom: '2rem' }}>
                            <h2 style={{ marginBottom: '1.5rem', fontSize: '1.8rem' }}>üèÜ Around the League</h2>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem' }}>
                                <div style={{ padding: '1rem', background: 'rgba(251, 191, 36, 0.1)', border: '2px solid #fbbf24', borderRadius: '0.75rem' }}>
                                    <div style={{ fontSize: '0.875rem', color: '#fbbf24', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                        üèÜ STANLEY CUP CHAMPION
                                    </div>
                                    <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#fff' }}>
                                        {seasonSummary.leagueSnapshot.champion}
                                    </div>
                                </div>
                                {seasonSummary.leagueSnapshot.mvp && (
                                    <div style={{ padding: '1rem', background: 'rgba(139, 92, 246, 0.1)', border: '2px solid #8b5cf6', borderRadius: '0.75rem' }}>
                                        <div style={{ fontSize: '0.875rem', color: '#a78bfa', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                            ‚≠ê LEAGUE MVP
                                        </div>
                                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#fff' }}>
                                            {seasonSummary.leagueSnapshot.mvp.firstName} {seasonSummary.leagueSnapshot.mvp.lastName}
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                            {seasonSummary.leagueSnapshot.mvp.stats.points} points
                                        </div>
                                    </div>
                                )}
                                {seasonSummary.leagueSnapshot.topScorer && (
                                    <div style={{ padding: '1rem', background: 'rgba(34, 197, 94, 0.1)', border: '2px solid #22c55e', borderRadius: '0.75rem' }}>
                                        <div style={{ fontSize: '0.875rem', color: '#22c55e', marginBottom: '0.5rem', fontWeight: 'bold' }}>
                                            üéØ TOP SCORER
                                        </div>
                                        <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#fff' }}>
                                            {seasonSummary.leagueSnapshot.topScorer.firstName} {seasonSummary.leagueSnapshot.topScorer.lastName}
                                        </div>
                                        <div style={{ color: '#93c5fd', fontSize: '0.9rem' }}>
                                            {seasonSummary.leagueSnapshot.topScorer.stats.points} points
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        {/* 6. Season Headlines */}
                        {seasonSummary.headlines.length > 0 && (
                            <div className="card" style={{ marginBottom: '2rem' }}>
                                <h2 style={{ marginBottom: '1.5rem', fontSize: '1.8rem' }}>üì∞ Season Headlines</h2>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                    {seasonSummary.headlines.map((headline, idx) => (
                                        <div key={idx} style={{
                                            padding: '1rem 1.5rem',
                                            background: 'rgba(59, 130, 246, 0.1)',
                                            border: '1px solid rgba(59, 130, 246, 0.3)',
                                            borderRadius: '0.5rem',
                                            fontSize: '1.1rem',
                                            color: '#e2e8f0'
                                        }}>
                                            {headline}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* 7. Call to Action */}
                        <div className="card" style={{ 
                            background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.2))',
                            border: '3px solid #22c55e',
                            textAlign: 'center'
                        }}>
                            <h2 style={{ fontSize: '1.8rem', marginBottom: '1rem', color: '#22c55e' }}>
                                Season Complete
                            </h2>
                            <p style={{ color: '#e2e8f0', marginBottom: '2rem', fontSize: '1.1rem' }}>
                                Review your season stats and prepare for the offseason.
                            </p>
                            <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap', marginBottom: '2rem' }}>
                                <button 
                                    onClick={() => setCurrentView('standings')}
                                    style={{
                                        padding: '0.875rem 1.75rem',
                                        background: '#3b82f6',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.5rem',
                                        fontSize: '1.1rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    View Final Standings
                                </button>
                                <button 
                                    onClick={() => setCurrentView('playoffs')}
                                    style={{
                                        padding: '0.875rem 1.75rem',
                                        background: '#8b5cf6',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.5rem',
                                        fontSize: '1.1rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    Review Playoff Bracket
                                </button>
                                <button 
                                    onClick={() => setCurrentView('transactions')}
                                    style={{
                                        padding: '0.875rem 1.75rem',
                                        background: '#22c55e',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.5rem',
                                        fontSize: '1.1rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold'
                                    }}
                                >
                                    View All Trades
                                </button>
                            </div>
                            
                            {/* Primary CTA - Continue to Next Season */}
                            <div style={{
                                borderTop: '2px solid rgba(34, 197, 94, 0.3)',
                                paddingTop: '2rem',
                                marginTop: '1rem'
                            }}>
                                <button 
                                    onClick={() => setCurrentView('draftlottery')}
                                    style={{
                                        padding: '1.25rem 3rem',
                                        background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                                        color: '#fff',
                                        border: 'none',
                                        borderRadius: '0.75rem',
                                        fontSize: '1.3rem',
                                        cursor: 'pointer',
                                        fontWeight: 'bold',
                                        boxShadow: '0 8px 16px rgba(245, 158, 11, 0.3)',
                                        transition: 'all 0.2s'
                                    }}
                                    onMouseOver={(e) => {
                                        e.target.style.transform = 'translateY(-2px)';
                                        e.target.style.boxShadow = '0 12px 24px rgba(245, 158, 11, 0.4)';
                                    }}
                                    onMouseOut={(e) => {
                                        e.target.style.transform = 'translateY(0)';
                                        e.target.style.boxShadow = '0 8px 16px rgba(245, 158, 11, 0.3)';
                                    }}
                                >
                                    Continue to Next Season ‚Üí
                                </button>
                                <p style={{ color: '#93c5fd', marginTop: '1rem', fontSize: '0.9rem' }}>
                                    Proceed to Draft Lottery & Offseason
                                </p>
                            </div>
                        </div>
                    </div>
                )}
            </div>
            
            {/* Cascading Notifications Panel - Right Side */}
            {seasonNotifications.length > 0 && (
                <div style={{
                    position: 'fixed',
                    top: '80px',
                    right: '20px',
                    zIndex: 9999,
                    width: '380px',
                    maxHeight: 'calc(100vh - 100px)',
                    overflowY: 'auto',
                    overflowX: 'hidden',
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '0.75rem',
                    padding: '0.5rem'
                }}>
                    {/* Header with clear all */}
                    <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        padding: '0.5rem 1rem',
                        background: 'rgba(15, 23, 42, 0.95)',
                        borderRadius: '0.5rem',
                        marginBottom: '0.25rem'
                    }}>
                        <span style={{ color: '#60a5fa', fontWeight: 'bold', fontSize: '0.9rem' }}>
                            Season Highlights ({seasonNotifications.length})
                        </span>
                        <button
                            onClick={() => setSeasonNotifications([])}
                            style={{
                                background: 'transparent',
                                border: 'none',
                                color: '#94a3b8',
                                fontSize: '0.85rem',
                                cursor: 'pointer',
                                padding: '0.25rem 0.5rem'
                            }}
                        >
                            Clear All
                        </button>
                    </div>
                    
                    {/* Notifications */}
                    {seasonNotifications.map((notification, index) => (
                        <div key={notification.timestamp} style={{
                            padding: '1rem',
                            background: 'linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.95))',
                            border: `2px solid ${notification.color}`,
                            borderRadius: '0.75rem',
                            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.3)',
                            animation: index === 0 ? 'slideIn 0.3s ease-out' : 'none',
                            opacity: index === 0 ? 1 : 0.85,
                            transition: 'opacity 0.3s'
                        }}>
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.75rem' }}>
                                <div style={{ fontSize: '1.75rem', flexShrink: 0 }}>{notification.icon}</div>
                                <div style={{ flex: 1, minWidth: 0 }}>
                                    <div style={{ 
                                        color: notification.color, 
                                        fontWeight: 'bold',
                                        fontSize: '1rem',
                                        marginBottom: '0.25rem'
                                    }}>
                                        {notification.title}
                                    </div>
                                    <div style={{ 
                                        color: '#e2e8f0', 
                                        fontSize: '0.875rem',
                                        lineHeight: '1.4',
                                        marginBottom: '0.35rem'
                                    }}>
                                        {notification.message}
                                    </div>
                                    <div style={{ 
                                        color: '#64748b', 
                                        fontSize: '0.75rem'
                                    }}>
                                        Day {notification.day}
                                    </div>
                                </div>
                                <button
                                    onClick={() => {
                                        setSeasonNotifications(prev => 
                                            prev.filter((_, i) => i !== index)
                                        );
                                    }}
                                    style={{
                                        background: 'transparent',
                                        border: 'none',
                                        color: '#64748b',
                                        fontSize: '1.25rem',
                                        cursor: 'pointer',
                                        padding: '0',
                                        lineHeight: '1',
                                        flexShrink: 0
                                    }}
                                >
                                    √ó
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
            
            {/* Trade Deadline Prompt Modal */}
            {showTradeDeadlinePrompt && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.9)',
                    zIndex: 10001,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }}>
                    <div style={{
                        background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                        border: '3px solid #f59e0b',
                        borderRadius: '1rem',
                        padding: '2rem',
                        maxWidth: '500px',
                        width: '90%',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                    }}>
                        <div style={{ fontSize: '3rem', textAlign: 'center', marginBottom: '1rem' }}>
                            ‚è∞
                        </div>
                        <h2 style={{ 
                            color: '#f59e0b', 
                            textAlign: 'center',
                            marginBottom: '1rem',
                            fontSize: '1.8rem'
                        }}>
                            Trade Deadline Today!
                        </h2>
                        <p style={{ 
                            color: '#e2e8f0', 
                            textAlign: 'center',
                            marginBottom: '2rem',
                            lineHeight: '1.6',
                            fontSize: '1.1rem'
                        }}>
                            You're simulating past the trade deadline (Day 56). Would you like to stop and make trades, or continue simulating?
                        </p>
                        <div style={{ 
                            display: 'flex', 
                            gap: '1rem',
                            justifyContent: 'center'
                        }}>
                            <button
                                onClick={() => {
                                    if (window.tradeDeadlineDecision) {
                                        window.tradeDeadlineDecision(false); // Stop and trade
                                    }
                                }}
                                autoFocus
                                style={{
                                    padding: '1rem 2rem',
                                    background: '#3b82f6',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.5rem',
                                    fontSize: '1.1rem',
                                    fontWeight: 'bold',
                                    cursor: 'pointer',
                                    flex: 1
                                }}
                            >
                                Make Trades
                            </button>
                            <button
                                onClick={() => {
                                    if (window.tradeDeadlineDecision) {
                                        window.tradeDeadlineDecision(true); // Continue simulating
                                    }
                                }}
                                style={{
                                    padding: '1rem 2rem',
                                    background: '#22c55e',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.5rem',
                                    fontSize: '1.1rem',
                                    fontWeight: 'bold',
                                    cursor: 'pointer',
                                    flex: 1
                                }}
                            >
                                Continue Simulating
                            </button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* Simulation Popup */}
            {simPopupVisible && !showTradeDeadlinePrompt && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.8)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 10000
                }}>
                    <div style={{
                        background: 'linear-gradient(135deg, #1e293b, #0f172a)',
                        border: '3px solid #3b82f6',
                        borderRadius: '1rem',
                        padding: '2rem',
                        minWidth: '700px',
                        maxWidth: '90vw',
                        maxHeight: '80vh',
                        overflow: 'auto',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                    }}>
                        <div style={{ textAlign: 'center', marginBottom: '1.5rem' }}>
                            <h2 style={{ color: '#60a5fa', marginBottom: '0', fontSize: '2rem' }}>
                                {simPopupDay <= simPopupTotalDays ? (
                                    simPopupGames[0]?.series ? 
                                        `‚ö° ${simPopupGames[0].series}` : 
                                        `‚ö° Simulating Game Day ${simPopupGameDay}`
                                ) : '‚úÖ Simulation Complete!'}
                            </h2>
                            
                            {/* Show team record for regular season */}
                            {!simPopupGames[0]?.series && simPopupDay <= simPopupTotalDays && (() => {
                                const userStanding = gameState?.standings?.find(s => s.teamId === userTeamId);
                                if (!userStanding) return null;
                                
                                const userTeam = TEAMS.find(t => t.id === userTeamId);
                                return (
                                    <div style={{ 
                                        marginTop: '0.75rem',
                                        padding: '0.75rem 1.5rem',
                                        background: 'rgba(34, 197, 94, 0.1)',
                                        border: '2px solid #22c55e',
                                        borderRadius: '0.5rem',
                                        display: 'inline-block'
                                    }}>
                                        <div style={{ color: '#22c55e', fontSize: '1rem', fontWeight: 'bold', marginBottom: '0.25rem' }}>
                                            {userTeam.city} {userTeam.name}
                                        </div>
                                        <div style={{ color: '#e2e8f0', fontSize: '1.3rem', fontWeight: 'bold' }}>
                                            {userStanding?.wins}-{userStanding?.losses}-{userStanding?.otLosses}
                                            <span style={{ color: '#93c5fd', fontSize: '0.9rem', marginLeft: '0.5rem' }}>
                                                ({userStanding.points} pts)
                                            </span>
                                        </div>
                                    </div>
                                );
                            })()}
                            
                            {/* Show series score for playoffs */}
                            {simPopupGames[0]?.seriesScore && simPopupDay <= simPopupTotalDays && (
                                <p style={{ color: '#93c5fd', fontSize: '1rem', marginTop: '0.5rem' }}>
                                    Series: {simPopupGames[0].seriesScore}
                                </p>
                            )}
                        </div>
                        
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                            {simPopupGames.map((game, idx) => (
                                <div key={idx} style={{
                                    padding: '1rem',
                                    background: game.noGame ? 'rgba(100, 116, 139, 0.1)' : (game.isUserTeam ? 'rgba(34, 197, 94, 0.1)' : 'rgba(59, 130, 246, 0.05)'),
                                    border: `2px solid ${game.noGame ? '#64748b' : (game.isUserTeam ? '#22c55e' : '#334155')}`,
                                    borderRadius: '0.5rem',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    gap: '0.5rem'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: game.noGame ? 'center' : 'space-between',
                                        alignItems: 'center'
                                    }}>
                                    {game.noGame ? (
                                        <div style={{ 
                                            color: '#94a3b8',
                                            fontSize: '1.1rem',
                                            fontStyle: 'italic'
                                        }}>
                                            üèí No game scheduled today
                                        </div>
                                    ) : (
                                        <>
                                            <div style={{ flex: 1, textAlign: 'right', paddingRight: '1rem' }}>
                                                <div style={{ 
                                                    fontWeight: game.awayTeamId === userTeamId ? 'bold' : 'normal',
                                                    color: game.awayTeamId === userTeamId ? '#22c55e' : '#e2e8f0',
                                                    fontSize: '1.1rem'
                                                }}>
                                                    {game.awayTeam}
                                                </div>
                                            </div>
                                            <div style={{ 
                                                padding: '0.5rem 1rem',
                                                background: 'rgba(59, 130, 246, 0.2)',
                                                borderRadius: '0.5rem',
                                                fontWeight: 'bold',
                                                fontSize: '1.3rem',
                                                color: '#60a5fa',
                                                minWidth: '80px',
                                                textAlign: 'center'
                                            }}>
                                                {game.awayScore} - {game.homeScore}
                                            </div>
                                            <div style={{ flex: 1, textAlign: 'left', paddingLeft: '1rem' }}>
                                                <div style={{ 
                                                    fontWeight: game.homeTeamId === userTeamId ? 'bold' : 'normal',
                                                    color: game.homeTeamId === userTeamId ? '#22c55e' : '#e2e8f0',
                                                    fontSize: '1.1rem'
                                                }}>
                                                    {game.homeTeam}
                                                </div>
                                            </div>
                                        </>
                                    )}
                                    </div>
                                    {/* Show series score below game if available */}
                                    {!game.noGame && game.seriesScore && (
                                        <div style={{
                                            paddingTop: '0.5rem',
                                            borderTop: '1px solid rgba(100, 116, 139, 0.3)',
                                            textAlign: 'center',
                                            color: '#93c5fd',
                                            fontSize: '0.9rem',
                                            fontWeight: '500'
                                        }}>
                                            Series: {game.seriesScore}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        
                        {/* Stop Button - show while simulating */}
                        {simPopupDay <= simPopupTotalDays && (
                            <button
                                onClick={() => {
                                    stopSimulationRef.current = true;
                                }}
                                style={{
                                    marginTop: '1.5rem',
                                    width: '100%',
                                    padding: '0.875rem',
                                    background: '#ef4444',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.5rem',
                                    fontSize: '1.1rem',
                                    cursor: 'pointer',
                                    fontWeight: 'bold'
                                }}
                            >
                                ‚èπÔ∏è Stop Simulation
                            </button>
                        )}
                        
                        {/* View Schedule Button - show when complete */}
                        {simPopupDay > simPopupTotalDays && (
                            <button
                                onClick={() => {
                                    setSimPopupVisible(false);
                                    // Stay on current page - no navigation
                                }}
                                style={{
                                    marginTop: '1.5rem',
                                    width: '100%',
                                    padding: '0.875rem',
                                    background: '#22c55e',
                                    color: '#fff',
                                    border: 'none',
                                    borderRadius: '0.5rem',
                                    fontSize: '1.1rem',
                                    cursor: 'pointer',
                                    fontWeight: 'bold'
                                }}
                            >
                                Continue ‚Üí
                            </button>
                        )}
                    </div>
                </div>
            )}
            
            {/* Floating Discord Button */}
            {gameState && (
                <a
                    href="https://discord.gg/zxhezDxfFm"
                    target="_blank"
                    rel="noopener noreferrer"
                    style={{
                        position: 'fixed',
                        bottom: '20px',
                        left: '20px',
                        padding: '0.75rem 1.25rem',
                        background: '#5865f2',
                        color: '#fff',
                        borderRadius: '0.5rem',
                        fontWeight: 'bold',
                        textDecoration: 'none',
                        boxShadow: '0 4px 12px rgba(88, 101, 242, 0.4)',
                        zIndex: 1000,
                        fontSize: '0.9rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        transition: 'all 0.2s ease',
                        cursor: 'pointer'
                    }}
                    onMouseOver={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(88, 101, 242, 0.5)';
                    }}
                    onMouseOut={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(88, 101, 242, 0.4)';
                    }}
                >
                    <svg width="18" height="18" viewBox="0 0 71 55" fill="currentColor">
                        <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
                    </svg>
                    Discord
                </a>
            )}
            
            {/* Floating Ko-fi Support Button */}
            {gameState && (
                <a
                    href="https://ko-fi.com/masacuna"
                    target="_blank"
                    rel="noopener noreferrer"
                    onClick={(e) => {
                        e.stopPropagation();
                        window.open('https://ko-fi.com/masacuna', '_blank', 'noopener,noreferrer');
                        e.preventDefault();
                    }}
                    style={{
                        position: 'fixed',
                        bottom: '20px',
                        right: '20px',
                        padding: '0.75rem 1.25rem',
                        background: 'linear-gradient(135deg, #FF5E5B 0%, #FF3838 100%)',
                        color: '#fff',
                        borderRadius: '0.5rem',
                        fontWeight: 'bold',
                        textDecoration: 'none',
                        boxShadow: '0 4px 12px rgba(255, 94, 91, 0.4)',
                        zIndex: 1000,
                        fontSize: '0.9rem',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.5rem',
                        transition: 'all 0.2s ease',
                        cursor: 'pointer'
                    }}
                    onMouseOver={(e) => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(255, 94, 91, 0.5)';
                    }}
                    onMouseOut={(e) => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(255, 94, 91, 0.4)';
                    }}
                >
                    ‚òï Support
                </a>
            )}
            
            {/* CONTRACT NEGOTIATION MODAL */}
            {showContractNegotiation && selectedPlayerProfile && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.85)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 10000,
                    padding: '2rem'
                }}>
                    <div style={{
                        background: 'linear-gradient(135deg, #1e293b 0%, #1e40af 100%)',
                        borderRadius: '1rem',
                        padding: '2rem',
                        maxWidth: '900px',
                        width: '100%',
                        maxHeight: '90vh',
                        overflow: 'auto',
                        border: '2px solid #3b82f6',
                        boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                    }}>
                        {(() => {
                            const marketValue = calculateMarketValue(selectedPlayerProfile);
                            const preferredLength = calculatePreferredLength(selectedPlayerProfile);
                            const evaluation = evaluateContractOffer(selectedPlayerProfile, contractOffer.salary, contractOffer.years);
                            const projections = calculateFutureCapProjections(
                                gameState.players, 
                                gameState.year,
                                {
                                    playerName: `${selectedPlayerProfile.firstName} ${selectedPlayerProfile.lastName}`,
                                    salary: contractOffer.salary,
                                    years: contractOffer.years
                                }
                            );
                            
                            return (
                                <>
                                    {/* Header */}
                                    <div style={{ marginBottom: '2rem', textAlign: 'center' }}>
                                        <h2 style={{ color: '#22d3ee', fontSize: '2rem', marginBottom: '0.5rem' }}>
                                            üìù Contract Negotiation
                                        </h2>
                                        <h3 style={{ color: '#e2e8f0', fontSize: '1.5rem' }}>
                                            {selectedPlayerProfile.firstName} {selectedPlayerProfile.lastName}
                                        </h3>
                                        <p style={{ color: '#93c5fd' }}>
                                            {selectedPlayerProfile.position} ‚Ä¢ {selectedPlayerProfile.ratings.overall} OVR ‚Ä¢ Age {selectedPlayerProfile.age}
                                        </p>
                                    </div>
                                    
                                    {/* Player Demands */}
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(245, 158, 11, 0.2)',
                                        border: '2px solid #f59e0b',
                                        borderRadius: '0.75rem',
                                        marginBottom: '2rem'
                                    }}>
                                        <h4 style={{ color: '#fbbf24', marginBottom: '1rem', fontSize: '1.2rem' }}>
                                            Player's Asking Price
                                        </h4>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.9rem', marginBottom: '0.25rem' }}>
                                                    Annual Salary
                                                </div>
                                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fbbf24' }}>
                                                    {formatSalary(marketValue)}
                                                </div>
                                            </div>
                                            <div>
                                                <div style={{ color: '#93c5fd', fontSize: '0.9rem', marginBottom: '0.25rem' }}>
                                                    Preferred Length
                                                </div>
                                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#fbbf24' }}>
                                                    {preferredLength} Years
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Your Offer */}
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(59, 130, 246, 0.2)',
                                        border: '2px solid #3b82f6',
                                        borderRadius: '0.75rem',
                                        marginBottom: '2rem'
                                    }}>
                                        <h4 style={{ color: '#60a5fa', marginBottom: '1.5rem', fontSize: '1.2rem' }}>
                                            Your Offer
                                        </h4>
                                        
                                        {/* Salary Slider */}
                                        <div style={{ marginBottom: '1.5rem' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                <label style={{ color: '#93c5fd', fontWeight: 'bold' }}>Annual Salary</label>
                                                <span style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#22c55e' }}>
                                                    {formatSalary(contractOffer.salary)}
                                                </span>
                                            </div>
                                            <input
                                                type="range"
                                                min={SALARY_CAP.minimum}
                                                max={Math.min(SALARY_CAP.ceiling * 0.15, marketValue * 1.3)}
                                                step={50000}
                                                value={contractOffer.salary}
                                                onChange={(e) => setContractOffer({ ...contractOffer, salary: parseInt(e.target.value) })}
                                                style={{ width: '100%', cursor: 'pointer' }}
                                            />
                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: '#64748b', marginTop: '0.25rem' }}>
                                                <span>{formatSalary(SALARY_CAP.minimum)}</span>
                                                <span>{formatSalary(Math.min(SALARY_CAP.ceiling * 0.15, marketValue * 1.3))}</span>
                                            </div>
                                        </div>
                                        
                                        {/* Years Slider */}
                                        <div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                                                <label style={{ color: '#93c5fd', fontWeight: 'bold' }}>Contract Length</label>
                                                <span style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#22c55e' }}>
                                                    {contractOffer.years} {contractOffer.years === 1 ? 'Year' : 'Years'}
                                                </span>
                                            </div>
                                            <input
                                                type="range"
                                                min={1}
                                                max={8}
                                                step={1}
                                                value={contractOffer.years}
                                                onChange={(e) => setContractOffer({ ...contractOffer, years: parseInt(e.target.value) })}
                                                style={{ width: '100%', cursor: 'pointer' }}
                                            />
                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: '#64748b', marginTop: '0.25rem' }}>
                                                <span>1 Year</span>
                                                <span>8 Years</span>
                                            </div>
                                        </div>
                                        
                                        {/* Total Contract Value */}
                                        <div style={{ 
                                            marginTop: '1rem',
                                            padding: '0.75rem',
                                            background: 'rgba(34, 197, 94, 0.2)',
                                            borderRadius: '0.5rem',
                                            textAlign: 'center'
                                        }}>
                                            <div style={{ color: '#93c5fd', fontSize: '0.85rem', marginBottom: '0.25rem' }}>
                                                Total Contract Value
                                            </div>
                                            <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#22c55e' }}>
                                                {formatSalary(contractOffer.salary * contractOffer.years)}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Acceptance Likelihood */}
                                    <div style={{
                                        padding: '1rem',
                                        background: evaluation.likelihood === 'Very High' ? 'rgba(34, 197, 94, 0.2)' :
                                                   evaluation.likelihood === 'High' ? 'rgba(34, 197, 94, 0.15)' :
                                                   evaluation.likelihood === 'Medium' ? 'rgba(245, 158, 11, 0.2)' :
                                                   'rgba(239, 68, 68, 0.2)',
                                        border: `2px solid ${evaluation.likelihood === 'Very High' ? '#22c55e' :
                                                               evaluation.likelihood === 'High' ? '#22c55e' :
                                                               evaluation.likelihood === 'Medium' ? '#f59e0b' : '#ef4444'}`,
                                        borderRadius: '0.5rem',
                                        marginBottom: '2rem',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{ fontSize: '0.9rem', color: '#93c5fd', marginBottom: '0.5rem' }}>
                                            Likelihood of Acceptance
                                        </div>
                                        <div style={{ 
                                            fontSize: '1.8rem', 
                                            fontWeight: 'bold',
                                            color: evaluation.likelihood === 'Very High' || evaluation.likelihood === 'High' ? '#22c55e' :
                                                   evaluation.likelihood === 'Medium' ? '#f59e0b' : '#ef4444'
                                        }}>
                                            {evaluation.likelihood}
                                        </div>
                                    </div>
                                    
                                    {/* Future Cap Projections */}
                                    <div style={{
                                        padding: '1.5rem',
                                        background: 'rgba(139, 92, 246, 0.2)',
                                        border: '2px solid #8b5cf6',
                                        borderRadius: '0.75rem',
                                        marginBottom: '2rem'
                                    }}>
                                        <h4 style={{ color: '#a78bfa', marginBottom: '1rem', fontSize: '1.2rem' }}>
                                            üìä Future Cap Projections (With This Contract)
                                        </h4>
                                        
                                        {projections.map((proj, idx) => (
                                            <div key={idx} style={{
                                                marginBottom: idx < projections.length - 1 ? '1.5rem' : 0
                                            }}>
                                                <div style={{ 
                                                    display: 'flex', 
                                                    justifyContent: 'space-between',
                                                    marginBottom: '0.75rem',
                                                    paddingBottom: '0.5rem',
                                                    borderBottom: '1px solid rgba(139, 92, 246, 0.3)'
                                                }}>
                                                    <span style={{ fontSize: '1.1rem', fontWeight: 'bold', color: '#a78bfa' }}>
                                                        Season {proj.year}
                                                    </span>
                                                    <div style={{ textAlign: 'right' }}>
                                                        <div style={{ fontSize: '1.1rem', fontWeight: 'bold', color: proj.capSpace < 0 ? '#ef4444' : '#22c55e' }}>
                                                            {formatSalary(Math.abs(proj.capSpace))} {proj.capSpace < 0 ? 'OVER' : 'Available'}
                                                        </div>
                                                        <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                                            {formatSalary(proj.totalCommitted)} committed
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div style={{ fontSize: '0.85rem', color: '#93c5fd' }}>
                                                    {proj.contracts.slice(0, 5).map((c, i) => (
                                                        <div key={i} style={{ 
                                                            display: 'flex', 
                                                            justifyContent: 'space-between',
                                                            padding: '0.25rem 0',
                                                            background: c.isNew ? 'rgba(34, 197, 94, 0.1)' : 'transparent'
                                                        }}>
                                                            <span>{c.playerName} {c.isNew && '‚ú®'}</span>
                                                            <span>{formatSalary(c.salary)}</span>
                                                        </div>
                                                    ))}
                                                    {proj.contracts.length > 5 && (
                                                        <div style={{ padding: '0.25rem 0', fontStyle: 'italic', color: '#64748b' }}>
                                                            ... and {proj.contracts.length - 5} more contracts
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    
                                    {/* Action Buttons */}
                                    <div style={{ display: 'flex', gap: '1rem' }}>
                                        <button
                                            onClick={() => {
                                                if (evaluation.willAccept) {
                                                    // Apply the contract
                                                    const updatedPlayers = gameState.players.map(p => {
                                                        if (p.id === selectedPlayerProfile.id) {
                                                            return {
                                                                ...p,
                                                                contract: {
                                                                    ...p.contract,
                                                                    salary: contractOffer.salary,
                                                                    capHit: contractOffer.salary,
                                                                    yearsRemaining: contractOffer.years + p.contract.yearsRemaining, // Add to current
                                                                    totalYears: contractOffer.years,
                                                                    status: 'signed'
                                                                }
                                                            };
                                                        }
                                                        return p;
                                                    });
                                                    
                                                    setGameState({ ...gameState, players: updatedPlayers });
                                                    
                                                    // Update the profile
                                                    const updatedProfile = updatedPlayers.find(p => p.id === selectedPlayerProfile.id);
                                                    setSelectedPlayerProfile(updatedProfile);
                                                    
                                                    // Track contract signing
                                                    trackEvent('contract_signed', {
                                                        player_name: `${selectedPlayerProfile.firstName} ${selectedPlayerProfile.lastName}`,
                                                        player_ovr: selectedPlayerProfile.ratings.overall,
                                                        salary: contractOffer.salary,
                                                        years: contractOffer.years,
                                                        total_value: contractOffer.salary * contractOffer.years
                                                    });
                                                    
                                                    alert(`‚úÖ Contract signed! ${selectedPlayerProfile.firstName} ${selectedPlayerProfile.lastName} has agreed to ${contractOffer.years} years at ${formatSalary(contractOffer.salary)}/year.`);
                                                    setShowContractNegotiation(false);
                                                } else {
                                                    trackEvent('contract_rejected', {
                                                        player_name: `${selectedPlayerProfile.firstName} ${selectedPlayerProfile.lastName}`,
                                                        player_ovr: selectedPlayerProfile.ratings.overall,
                                                        offered_salary: contractOffer.salary,
                                                        offered_years: contractOffer.years
                                                    });
                                                    alert(`‚ùå ${selectedPlayerProfile.firstName} ${selectedPlayerProfile.lastName} has rejected your offer. Try increasing the salary or adjusting the term length.`);
                                                }
                                            }}
                                            style={{
                                                flex: 1,
                                                padding: '1rem',
                                                background: evaluation.willAccept 
                                                    ? 'linear-gradient(135deg, #22c55e, #15803d)'
                                                    : 'linear-gradient(135deg, #6b7280, #4b5563)',
                                                border: 'none',
                                                borderRadius: '0.5rem',
                                                color: 'white',
                                                fontSize: '1.1rem',
                                                fontWeight: 'bold',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            {evaluation.willAccept ? '‚úÖ Submit Offer (Will Accept)' : '‚ö†Ô∏è Submit Offer (Likely to Reject)'}
                                        </button>
                                        
                                        <button
                                            onClick={() => setShowContractNegotiation(false)}
                                            style={{
                                                padding: '1rem 2rem',
                                                background: '#ef4444',
                                                border: 'none',
                                                borderRadius: '0.5rem',
                                                color: 'white',
                                                fontSize: '1.1rem',
                                                fontWeight: 'bold',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </>
                            );
                        })()}
                    </div>
                </div>
            )}
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));

// Helper to update loading text
const updateLoadingText = (main, sub) => {
    const mainEl = document.getElementById('loading-text');
    const subEl = document.getElementById('loading-subtext');
    if (mainEl) mainEl.textContent = main;
    if (subEl) subEl.textContent = sub;
};

// Helper to hide loading screen
const hideLoadingScreen = () => {
    const loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
        loadingScreen.style.opacity = '0';
        setTimeout(() => {
            if (loadingScreen.parentNode) {
                loadingScreen.parentNode.removeChild(loadingScreen);
            }
        }, 500);
    }
};

// Show temporary loading message while React initializes
root.render(
    React.createElement('div', {
        style: {
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #1e293b 0%, #1e3a8a 50%, #1e293b 100%)',
            color: '#93c5fd',
            fontSize: '1.2rem'
        }
    }, 'Initializing game engine...')
);

// Defer heavy initialization to not block UI
const initializeGame = () => {
    updateLoadingText('Starting game...', 'Setting up your franchise');
    
    // Small delay to ensure loading screen is visible
    setTimeout(() => {
        try {
            // Render the actual game
            root.render(React.createElement(HockeyGM));
            
            // Hide loading screen after React has rendered
            setTimeout(() => {
                hideLoadingScreen();
            }, 100);
        } catch (error) {
            console.error('Error initializing game:', error);
            updateLoadingText('Error loading game', 'Please refresh the page');
        }
    }, 50);
};

// Use requestIdleCallback for best performance, fallback to setTimeout
if (typeof requestIdleCallback !== 'undefined') {
    requestIdleCallback(initializeGame);
} else {
    setTimeout(initializeGame, 100);
}
    </script>
    
    <!-- Footer -->
    <footer style="
        background: linear-gradient(135deg, #0f172a, #1e293b);
        border-top: 2px solid #3b82f6;
        padding: 2rem 1rem 1rem;
        margin-top: 2rem;
        color: #e2e8f0;
    ">
        <div style="
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        ">
            <!-- About Section -->
            <div>
                <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                    üèí HockeyGmSim
                </h3>
                <p style="color: #94a3b8; line-height: 1.6; font-size: 0.95rem;">
                    A free browser-based hockey general manager simulator. Build your dynasty, manage your roster, and compete for the Stanley Cup!
                </p>
                <p style="color: #64748b; margin-top: 0.5rem; font-size: 0.85rem;">
                    Made with ‚ù§Ô∏è by mas
                </p>
            </div>
            
            <!-- Community Section -->
            <div>
                <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                    Community
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <a href="https://discord.gg/zxhezDxfFm" target="_blank" rel="noopener noreferrer" style="
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        color: #e2e8f0;
                        text-decoration: none;
                        transition: color 0.2s;
                        font-size: 0.95rem;
                    " onmouseover="this.style.color='#5865f2'" onmouseout="this.style.color='#e2e8f0'">
                        <svg width="20" height="20" viewBox="0 0 71 55" fill="currentColor">
                            <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.28 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z"/>
                        </svg>
                        Join Discord Server
                    </a>
                    <a href="https://www.reddit.com/r/NAHLHockeySim/" target="_blank" rel="noopener noreferrer" style="
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        color: #e2e8f0;
                        text-decoration: none;
                        transition: color 0.2s;
                        font-size: 0.95rem;
                    " onmouseover="this.style.color='#ff4500'" onmouseout="this.style.color='#e2e8f0'">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M16.5,2.924c0.959,0,1.737,0.778,1.737,1.737c0,0.693-0.405,1.291-0.994,1.572c0.037,0.215,0.056,0.435,0.056,0.66 c0,3.347-3.897,6.061-8.701,6.061c-4.803,0-8.7-2.715-8.7-6.061c0-0.223,0.019-0.444,0.055-0.66C0.363,5.951,0,5.351,0,4.661 c0-0.959,0.778-1.737,1.737-1.737c0.427,0,0.831,0.155,1.146,0.432C3.793,2.641,5.097,2.184,6.525,2.092l1.098-5.142 c0.036-0.16,0.12-0.295,0.231-0.387C7.965,0.471,8.111,0.425,8.26,0.425c0.027,0,0.053,0.001,0.08,0.004l3.598,0.774 c0.211-0.459,0.677-0.783,1.219-0.783c0.739,0,1.34,0.602,1.34,1.341c0,0.74-0.601,1.34-1.34,1.34c-0.65,0-1.193-0.465-1.311-1.081 L8.552,1.25L7.646,5.696C9.062,5.796,10.353,6.253,11.244,7 c0.314-0.277,0.719-0.432,1.146-0.432C13.349,6.568,14.127,6.346,14.785,6.824z M2.595,8.637c0,0.62,0.504,1.125,1.124,1.125 c0.62,0,1.125-0.505,1.125-1.125c0-0.621-0.505-1.125-1.125-1.125C3.099,7.512,2.595,8.016,2.595,8.637z M10.663,11.346 c-0.885,0.883-2.308,0.883-3.192,0c-0.173-0.174-0.173-0.455,0-0.629c0.174-0.173,0.455-0.173,0.628,0 c0.539,0.54,1.398,0.54,1.937,0c0.173-0.173,0.454-0.173,0.628,0C10.836,10.891,10.836,11.172,10.663,11.346z M13.098,9.762 c-0.62,0-1.125-0.504-1.125-1.125c0-0.62,0.505-1.125,1.125-1.125c0.621,0,1.125,0.505,1.125,1.125 C14.223,9.258,13.719,9.762,13.098,9.762z"/>
                        </svg>
                        r/NAHLHockeySim
                    </a>
                    <a href="https://ko-fi.com/masacuna" target="_blank" rel="noopener noreferrer" style="
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        color: #e2e8f0;
                        text-decoration: none;
                        transition: color 0.2s;
                        font-size: 0.95rem;
                    " onmouseover="this.style.color='#ff5e5b'" onmouseout="this.style.color='#e2e8f0'">
                        ‚òï Support Development
                    </a>
                </div>
            </div>
            
            <!-- Support Section -->
            <div>
                <h3 style="color: #60a5fa; margin-bottom: 1rem; font-size: 1.2rem;">
                    Support & Feedback
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <a href="https://discord.gg/zxhezDxfFm" target="_blank" rel="noopener noreferrer" style="
                        color: #e2e8f0;
                        text-decoration: none;
                        transition: color 0.2s;
                        font-size: 0.95rem;
                    " onmouseover="this.style.color='#60a5fa'" onmouseout="this.style.color='#e2e8f0'">
                        üêõ Report Bugs (Discord)
                    </a>
                    <a href="https://discord.gg/zxhezDxfFm" target="_blank" rel="noopener noreferrer" style="
                        color: #e2e8f0;
                        text-decoration: none;
                        transition: color 0.2s;
                        font-size: 0.95rem;
                    " onmouseover="this.style.color='#60a5fa'" onmouseout="this.style.color='#e2e8f0'">
                        üí° Suggest Features (Discord)
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Bottom Bar -->
        <div style="
            max-width: 1200px;
            margin: 2rem auto 0;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(59, 130, 246, 0.3);
            text-align: center;
            color: #64748b;
            font-size: 0.85rem;
        ">
            <p>¬© 2026 HockeyGmSim | Free to play, forever | <span style="color: #3b82f6;">v1.0.1</span></p>
            <p style="margin-top: 0.5rem;">
                <a href="docs/USER_MANUAL.md" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: none; margin: 0 0.5rem;">
                    üìñ User Manual
                </a> | 
                <a href="docs/ROADMAP.md" target="_blank" rel="noopener noreferrer" style="color: #8b5cf6; text-decoration: none; margin: 0 0.5rem;">
                    üó∫Ô∏è Roadmap
                </a> | 
                <a href="https://discord.gg/zxhezDxfFm" target="_blank" rel="noopener noreferrer" style="color: #22c55e; text-decoration: none; margin: 0 0.5rem;">
                    üí¨ Discord
                </a>
            </p>
            <p style="margin-top: 0.5rem;">Not affiliated with the NHL. All team names and logos are property of their respective owners.</p>
            <p style="margin-top: 0.5rem; font-size: 0.8rem; color: #475569;">
                This site uses Google Analytics to understand how players use the game and improve the experience. No personal data is collected.
            </p>
        </div>
    </footer>
</body>
